<!--#set var="section" value="development" -->
<!--#include virtual="/page-top.html" -->
<!-- CONTENT START -->
  <!-- Generated by Doxygen 1.3.9.1 -->

  <div class="qindex">
    <a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="modules.html">Modules</a> | <a class=
    "qindex" href="annotated.html">Data&nbsp;Structures</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class=
    "qindex" href="functions.html">Data&nbsp;Fields</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a> | <a class=
    "qindex" href="examples.html">Examples</a>
  </div>

  <div class="nav">
    <a class="el" href="dir_000005.html">snmplib</a>
  </div>

  <h1>fd_event_manager.c</h1>

  <div class="fragment">
    <pre class="fragment">
00001 <span class="comment">/* UNIT: File Descriptor (FD) Event Manager                              */</span>
00002 <span class="preprocessor">#include &lt;net-snmp/net-snmp-config.h&gt;</span>
00003 <span class="preprocessor">#ifdef HAVE_SYS_SELECT</span>
00004 <span class="preprocessor">#include &lt;sys/select.h&gt;</span>
00005 <span class="preprocessor">#endif</span>
00006 <span class="preprocessor">#include &lt;net-snmp/net-snmp-includes.h&gt;</span>
00007 <span class="preprocessor">#include &lt;net-snmp/library/snmp_api.h&gt;</span>
00008 <span class="preprocessor">#include &lt;net-snmp/library/fd_event_manager.h&gt;</span>
00009 <span class="preprocessor">#include &lt;net-snmp/library/snmp_logging.h&gt;</span>
00010 <span class="keywordtype">int</span>     external_readfd[NUM_EXTERNAL_FDS],   external_readfdlen   = 0;
00011 <span class="keywordtype">int</span>     external_writefd[NUM_EXTERNAL_FDS],  external_writefdlen  = 0;
00012 <span class="keywordtype">int</span>     external_exceptfd[NUM_EXTERNAL_FDS], external_exceptfdlen = 0;
00013 void  (*external_readfdfunc[NUM_EXTERNAL_FDS]) (int, <span class="keywordtype">void</span> *);
00014 void  (*external_writefdfunc[NUM_EXTERNAL_FDS]) (int, <span class="keywordtype">void</span> *);
00015 void  (*external_exceptfdfunc[NUM_EXTERNAL_FDS]) (int, <span class="keywordtype">void</span> *);
00016 <span class="keywordtype">void</span>   *external_readfd_data[NUM_EXTERNAL_FDS];
00017 <span class="keywordtype">void</span>   *external_writefd_data[NUM_EXTERNAL_FDS];
00018 <span class="keywordtype">void</span>   *external_exceptfd_data[NUM_EXTERNAL_FDS];
00019 
00020 <span class="comment">/*</span>
00021 <span class="comment"> * Register a given fd for read events.  Call callback when events</span>
00022 <span class="comment"> * are received.</span>
00023 <span class="comment"> */</span>
00024 <span class="keywordtype">int</span>
00025 register_readfd(<span class="keywordtype">int</span> fd, <span class="keywordtype">void</span> (*func) (<span class=
"keywordtype">int</span>, <span class="keywordtype">void</span> *), <span class="keywordtype">void</span> *data)
00026 {
00027     <span class="keywordflow">if</span> (external_readfdlen &lt; NUM_EXTERNAL_FDS) {
00028         external_readfd[external_readfdlen] = fd;
00029         external_readfdfunc[external_readfdlen] = func;
00030         external_readfd_data[external_readfdlen] = data;
00031         external_readfdlen++;
00032         DEBUGMSGTL((<span class="stringliteral">"fd_event_manager:register_readfd"</span>, <span class=
"stringliteral">"registered fd %d\n"</span>, fd));
00033         <span class="keywordflow">return</span> FD_REGISTERED_OK;
00034     } <span class="keywordflow">else</span> {
00035         <a class="code" href="group__snmp__logging.html#ga41">snmp_log</a>(LOG_CRIT, <span class=
"stringliteral">"register_readfd: too many file descriptors\n"</span>);
00036         <span class="keywordflow">return</span> FD_REGISTRATION_FAILED;
00037     }
00038 }
00039 
00040 <span class="comment">/*</span>
00041 <span class="comment"> * Register a given fd for write events.  Call callback when events</span>
00042 <span class="comment"> * are received.</span>
00043 <span class="comment"> */</span>
00044 <span class="keywordtype">int</span>
00045 register_writefd(<span class="keywordtype">int</span> fd, <span class="keywordtype">void</span> (*func) (<span class=
"keywordtype">int</span>, <span class="keywordtype">void</span> *), <span class="keywordtype">void</span> *data)
00046 {
00047     <span class="keywordflow">if</span> (external_writefdlen &lt; NUM_EXTERNAL_FDS) {
00048         external_writefd[external_writefdlen] = fd;
00049         external_writefdfunc[external_writefdlen] = func;
00050         external_writefd_data[external_writefdlen] = data;
00051         external_writefdlen++;
00052         DEBUGMSGTL((<span class="stringliteral">"fd_event_manager:register_writefd"</span>, <span class=
"stringliteral">"registered fd %d\n"</span>, fd));
00053         <span class="keywordflow">return</span> FD_REGISTERED_OK;
00054     } <span class="keywordflow">else</span> {
00055         <a class="code" href="group__snmp__logging.html#ga41">snmp_log</a>(LOG_CRIT,
00056                  <span class="stringliteral">"register_writefd: too many file descriptors\n"</span>);
00057         <span class="keywordflow">return</span> FD_REGISTRATION_FAILED;
00058     }
00059 }
00060 
00061 <span class="comment">/*</span>
00062 <span class="comment"> * Register a given fd for exception events.  Call callback when events</span>
00063 <span class="comment"> * are received.</span>
00064 <span class="comment"> */</span>
00065 <span class="keywordtype">int</span>
00066 register_exceptfd(<span class="keywordtype">int</span> fd, <span class="keywordtype">void</span> (*func) (<span class=
"keywordtype">int</span>, <span class="keywordtype">void</span> *), <span class="keywordtype">void</span> *data)
00067 {
00068     <span class="keywordflow">if</span> (external_exceptfdlen &lt; NUM_EXTERNAL_FDS) {
00069         external_exceptfd[external_exceptfdlen] = fd;
00070         external_exceptfdfunc[external_exceptfdlen] = func;
00071         external_exceptfd_data[external_exceptfdlen] = data;
00072         external_exceptfdlen++;
00073         DEBUGMSGTL((<span class="stringliteral">"fd_event_manager:register_exceptfd"</span>, <span class=
"stringliteral">"registered fd %d\n"</span>, fd));
00074         <span class="keywordflow">return</span> FD_REGISTERED_OK;
00075     } <span class="keywordflow">else</span> {
00076         <a class="code" href="group__snmp__logging.html#ga41">snmp_log</a>(LOG_CRIT,
00077                  <span class="stringliteral">"register_exceptfd: too many file descriptors\n"</span>);
00078         <span class="keywordflow">return</span> FD_REGISTRATION_FAILED;
00079     }
00080 }
00081 
00082 <span class="comment">/*</span>
00083 <span class="comment"> * Unregister a given fd for read events.</span>
00084 <span class="comment"> */</span> 
00085 <span class="keywordtype">int</span>
00086 unregister_readfd(<span class="keywordtype">int</span> fd)
00087 {
00088     <span class="keywordtype">int</span>             i, j;
00089 
00090     <span class="keywordflow">for</span> (i = 0; i &lt; external_readfdlen; i++) {
00091         <span class="keywordflow">if</span> (external_readfd[i] == fd) {
00092             external_readfdlen--;
00093             <span class="keywordflow">for</span> (j = i; j &lt; external_readfdlen; j++) {
00094                 external_readfd[j] = external_readfd[j + 1];
00095                 external_readfdfunc[j] = external_readfdfunc[j + 1];
00096                 external_readfd_data[j] = external_readfd_data[j + 1];
00097             }
00098             DEBUGMSGTL((<span class="stringliteral">"fd_event_manager:unregister_readfd"</span>, <span class=
"stringliteral">"unregistered fd %d\n"</span>, fd));
00099             <span class="keywordflow">return</span> FD_UNREGISTERED_OK;
00100         }
00101     }
00102     <span class="keywordflow">return</span> FD_NO_SUCH_REGISTRATION;
00103 }
00104 
00105 <span class="comment">/*</span>
00106 <span class="comment"> * Unregister a given fd for read events.</span>
00107 <span class="comment"> */</span> 
00108 <span class="keywordtype">int</span>
00109 unregister_writefd(<span class="keywordtype">int</span> fd)
00110 {
00111     <span class="keywordtype">int</span>             i, j;
00112 
00113     <span class="keywordflow">for</span> (i = 0; i &lt; external_writefdlen; i++) {
00114         <span class="keywordflow">if</span> (external_writefd[i] == fd) {
00115             external_writefdlen--;
00116             <span class="keywordflow">for</span> (j = i; j &lt; external_writefdlen; j++) {
00117                 external_writefd[j] = external_writefd[j + 1];
00118                 external_writefdfunc[j] = external_writefdfunc[j + 1];
00119                 external_writefd_data[j] = external_writefd_data[j + 1];
00120             }
00121             DEBUGMSGTL((<span class="stringliteral">"fd_event_manager:unregister_writefd"</span>, <span class=
"stringliteral">"unregistered fd %d\n"</span>, fd));
00122             <span class="keywordflow">return</span> FD_UNREGISTERED_OK;
00123         }
00124     }
00125     <span class="keywordflow">return</span> FD_NO_SUCH_REGISTRATION;
00126 }
00127 
00128 <span class="comment">/*</span>
00129 <span class="comment"> * Unregister a given fd for exception events.</span>
00130 <span class="comment"> */</span>
00131 <span class="keywordtype">int</span>
00132 unregister_exceptfd(<span class="keywordtype">int</span> fd)
00133 {
00134     <span class="keywordtype">int</span>             i, j;
00135 
00136     <span class="keywordflow">for</span> (i = 0; i &lt; external_exceptfdlen; i++) {
00137         <span class="keywordflow">if</span> (external_exceptfd[i] == fd) {
00138             external_exceptfdlen--;
00139             <span class="keywordflow">for</span> (j = i; j &lt; external_exceptfdlen; j++) {
00140                 external_exceptfd[j] = external_exceptfd[j + 1];
00141                 external_exceptfdfunc[j] = external_exceptfdfunc[j + 1];
00142                 external_exceptfd_data[j] = external_exceptfd_data[j + 1];
00143             }
00144             DEBUGMSGTL((<span class="stringliteral">"fd_event_manager:unregister_exceptfd"</span>, <span class=
"stringliteral">"unregistered fd %d\n"</span>,
00145                         fd));
00146             <span class="keywordflow">return</span> FD_UNREGISTERED_OK;
00147         }
00148     }
00149     <span class="keywordflow">return</span> FD_NO_SUCH_REGISTRATION;
00150 }
00151 
00152 <span class="comment">/* </span>
00153 <span class="comment"> * NET-SNMP External Event Info </span>
00154 <span class="comment"> */</span>
00155 <span class="keywordtype">void</span> netsnmp_external_event_info(<span class=
"keywordtype">int</span> *numfds, fd_set *readfds, fd_set *writefds, fd_set *exceptfds)
00156 {
00157   <span class="keywordtype">int</span> i;
00158   <span class="keywordflow">for</span> (i = 0; i &lt; external_readfdlen; i++) {
00159     FD_SET(external_readfd[i], readfds);
00160     <span class="keywordflow">if</span> (external_readfd[i] &gt;= *numfds)
00161       *numfds = external_readfd[i] + 1;
00162   }
00163   <span class="keywordflow">for</span> (i = 0; i &lt; external_writefdlen; i++) {
00164     FD_SET(external_writefd[i], writefds);
00165     <span class="keywordflow">if</span> (external_writefd[i] &gt;= *numfds)
00166       *numfds = external_writefd[i] + 1;
00167   }
00168   <span class="keywordflow">for</span> (i = 0; i &lt; external_exceptfdlen; i++) {
00169     FD_SET(external_exceptfd[i], exceptfds);
00170     <span class="keywordflow">if</span> (external_exceptfd[i] &gt;= *numfds)
00171       *numfds = external_exceptfd[i] + 1;
00172   }
00173 }
00174 
00175 <span class="comment">/* </span>
00176 <span class="comment"> * NET-SNMP Dispatch External Events </span>
00177 <span class="comment"> */</span>
00178 <span class="keywordtype">void</span> netsnmp_dispatch_external_events(<span class=
"keywordtype">int</span> *count, fd_set *readfds, fd_set *writefds, fd_set *exceptfds)
00179 {
00180   <span class="keywordtype">int</span> i;
00181   <span class="keywordflow">for</span> (i = 0; *count &amp;&amp; (i &lt; external_readfdlen); i++) {
00182       <span class="keywordflow">if</span> (FD_ISSET(external_readfd[i], readfds)) {
00183           DEBUGMSGTL((<span class="stringliteral">"fd_event_manager:netsnmp_dispatch_external_events"</span>, 
00184                      <span class="stringliteral">"readfd[%d] = %d\n"</span>, i, external_readfd[i]));
00185           external_readfdfunc[i] (external_readfd[i],
00186                                   external_readfd_data[i]);
00187           FD_CLR(external_readfd[i], readfds);
00188           *count--;
00189       }
00190   }
00191   <span class="keywordflow">for</span> (i = 0; *count &amp;&amp; (i &lt; external_writefdlen); i++) {
00192       <span class="keywordflow">if</span> (FD_ISSET(external_writefd[i], writefds)) {
00193           DEBUGMSGTL((<span class="stringliteral">"fd_event_manager:netsnmp_dispatch_external_events"</span>, 
00194                      <span class="stringliteral">"writefd[%d] = %d\n"</span>, i, external_writefd[i]));
00195           external_writefdfunc[i] (external_writefd[i],
00196                                    external_writefd_data[i]);
00197           FD_CLR(external_writefd[i], writefds);
00198           *count--;
00199       }
00200   }
00201   <span class="keywordflow">for</span> (i = 0; *count &amp;&amp; (i &lt; external_exceptfdlen); i++) {
00202       <span class="keywordflow">if</span> (FD_ISSET(external_exceptfd[i], exceptfds)) {
00203           DEBUGMSGTL((<span class="stringliteral">"fd_event_manager:netsnmp_dispatch_external_events"</span>, 
00204                      <span class="stringliteral">"exceptfd[%d] = %d\n"</span>, i, external_exceptfd[i]));
00205           external_exceptfdfunc[i] (external_exceptfd[i],
00206                                     external_exceptfd_data[i]);
00207           FD_CLR(external_exceptfd[i], exceptfds);
00208           *count--;
00209       }
00210   }
00211 }
</pre>
  </div>
  <hr size="1" />

  <address style="align: right;">
    <small>Generated on Fri Dec 30 13:47:44 2005 for net-snmp by&nbsp; <a href="http://www.doxygen.org/index.html"><img src=
    "doxygen.png" alt="doxygen" align="middle" border="0" /></a> 1.3.9.1</small>
  </address>
<!-- CONTENT END -->
<!--#include virtual="/page-bottom.html" -->

