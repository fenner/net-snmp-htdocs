<!--#set var="section" value="development" -->
<!--#include virtual="/page-top.html" -->
<!-- CONTENT START -->
  <div class="qindex">
    <a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="modules.html">Modules</a> | <a class=
    "qindex" href="annotated.html">Data&nbsp;Structures</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class=
    "qindex" href="functions.html">Data&nbsp;Fields</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a> | <a class=
    "qindex" href="examples.html">Examples</a>
  </div>

  <div class="nav">
    <a class="el" href="dir_000003.html">agent</a>&nbsp;/&nbsp;<a class="el" href="dir_000004.html">helpers</a>
  </div>

  <h1>old_api.c</h1>

  <div class="fragment">
    <pre class="fragment">
00001 <span class="preprocessor">#include &lt;net-snmp/net-snmp-config.h&gt;</span>
00002 
00003 <span class="preprocessor">#if HAVE_STRING_H</span>
00004 <span class="preprocessor">#include &lt;string.h&gt;</span>
00005 <span class="preprocessor">#else</span>
00006 <span class="preprocessor">#include &lt;strings.h&gt;</span>
00007 <span class="preprocessor">#endif</span>
00008 
00009 <span class="preprocessor">#include &lt;net-snmp/net-snmp-includes.h&gt;</span>
00010 <span class="preprocessor">#include &lt;net-snmp/agent/net-snmp-agent-includes.h&gt;</span>
00011 
00012 <span class="preprocessor">#include &lt;net-snmp/agent/old_api.h&gt;</span>
00013 <span class="preprocessor">#include &lt;net-snmp/agent/agent_callbacks.h&gt;</span>
00014 
00015 <span class="preprocessor">#if HAVE_DMALLOC_H</span>
00016 <span class="preprocessor">#include &lt;dmalloc.h&gt;</span>
00017 <span class="preprocessor">#endif</span>
00018 
00019 <span class="preprocessor">#define MIB_CLIENTS_ARE_EVIL 1</span>
00020 
00021 <span class="comment">/*</span>
00022 <span class="comment"> * don't use these! </span>
00023 <span class="comment"> */</span>
00024 <span class="keywordtype">void</span>            set_current_agent_session(netsnmp_agent_session *asp);
00025 netsnmp_agent_session *netsnmp_get_current_agent_session(<span class="keywordtype">void</span>);
00026 
00039 <a class="code" href="structnetsnmp__mib__handler__s.html">netsnmp_mib_handler</a> *
<a name="l00040" id="l00040"></a><a class="code" href="group__old__api.html#ga0">00040</a> <a class="code" href=
"group__old__api.html#ga0">get_old_api_handler</a>(<span class="keywordtype">void</span>)
00041 {
00042     <span class="keywordflow">return</span> <a class="code" href=
"group__handler.html#ga7">netsnmp_create_handler</a>(<span class="stringliteral">"old_api"</span>, netsnmp_old_api_helper);
00043 }
00044 
00045 
00050 <span class="keywordtype">int</span>
<a name="l00051" id="l00051"></a><a class="code" href="group__old__api.html#ga1">00051</a> <a class="code" href=
"group__old__api.html#ga1">netsnmp_register_old_api</a>(<span class="keyword">const</span> <span class=
"keywordtype">char</span> *moduleName,
00052                          <span class="keyword">struct</span> variable *var,
00053                          size_t varsize,
00054                          size_t numvars,
00055                          oid * mibloc,
00056                          size_t mibloclen,
00057                          <span class="keywordtype">int</span> priority,
00058                          <span class="keywordtype">int</span> range_subid,
00059                          oid range_ubound,
00060                          <a class="code" href="structsnmp__session.html">netsnmp_session</a> * ss,
00061                          <span class="keyword">const</span> <span class="keywordtype">char</span> *context, <span class=
"keywordtype">int</span> timeout, <span class="keywordtype">int</span> flags)
00062 {
00063 
00064     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>    i;
00065 
00066     <span class="comment">/*</span>
00067 <span class="comment">     * register all subtree nodes </span>
00068 <span class="comment">     */</span>
00069     <span class="keywordflow">for</span> (i = 0; i &lt; numvars; i++) {
00070         <span class="keyword">struct </span>variable *vp;
00071         <a class="code" href="structnetsnmp__handler__registration__s.html">netsnmp_handler_registration</a> *reginfo =
00072             <a class="code" href="group__util.html#ga39">SNMP_MALLOC_TYPEDEF</a>(<a class="code" href=
"structnetsnmp__handler__registration__s.html">netsnmp_handler_registration</a>);
00073 
00074         <a class="code" href="group__util.html#ga5">memdup</a>((<span class="keywordtype">void</span> *) &amp;vp,
00075                (<span class="keywordtype">void</span> *) (<span class="keyword">struct</span> variable *) ((<span class=
"keywordtype">char</span> *) var + varsize * i),
00076                varsize);
00077 
00078         reginfo-&gt;<a class="code" href="structnetsnmp__handler__registration__s.html#o4">handler</a> = <a class="code"
href="group__old__api.html#ga0">get_old_api_handler</a>();
00079         reginfo-&gt;<a class="code" href=
"structnetsnmp__handler__registration__s.html#o0">handlerName</a> = strdup(moduleName);
00080         reginfo-&gt;<a class="code" href=
"structnetsnmp__handler__registration__s.html#o3">rootoid_len</a> = (mibloclen + vp-&gt;namelen);
00081         reginfo-&gt;<a class="code" href="structnetsnmp__handler__registration__s.html#o2">rootoid</a> =
00082             (oid *) malloc(reginfo-&gt;<a class="code" href=
"structnetsnmp__handler__registration__s.html#o3">rootoid_len</a> * <span class="keyword">sizeof</span>(oid));
00083 
00084         memcpy(reginfo-&gt;<a class="code" href=
"structnetsnmp__handler__registration__s.html#o2">rootoid</a>, mibloc, mibloclen * <span class="keyword">sizeof</span>(oid));
00085         memcpy(reginfo-&gt;<a class="code" href=
"structnetsnmp__handler__registration__s.html#o2">rootoid</a> + mibloclen, vp-&gt;name, vp-&gt;namelen
00086                * <span class="keyword">sizeof</span>(oid));
00087         reginfo-&gt;<a class="code" href="structnetsnmp__handler__registration__s.html#o4">handler</a>-&gt;<a class="code"
href="structnetsnmp__mib__handler__s.html#o1">myvoid</a> = (<span class="keywordtype">void</span> *) vp;
00088 
00089         reginfo-&gt;<a class="code" href="structnetsnmp__handler__registration__s.html#o6">priority</a> = priority;
00090         reginfo-&gt;<a class="code" href="structnetsnmp__handler__registration__s.html#o7">range_subid</a> = range_subid;
00091 
00092         reginfo-&gt;<a class="code" href="structnetsnmp__handler__registration__s.html#o8">range_ubound</a> = range_ubound;
00093         reginfo-&gt;<a class="code" href="structnetsnmp__handler__registration__s.html#o9">timeout</a> = timeout;
00094         reginfo-&gt;<a class="code" href=
"structnetsnmp__handler__registration__s.html#o1">contextName</a> = (context) ? strdup(context) : NULL;
00095         reginfo-&gt;<a class="code" href="structnetsnmp__handler__registration__s.html#o5">modes</a> = HANDLER_CAN_RWRITE;
00096 
00097         <span class="comment">/*</span>
00098 <span class="comment">         * register ourselves in the mib tree </span>
00099 <span class="comment">         */</span>
00100         <span class="keywordflow">if</span> (<a class="code" href=
"group__handler.html#ga10">netsnmp_register_handler</a>(reginfo) != MIB_REGISTERED_OK) {
00102             <a class="code" href="group__util.html#ga36">SNMP_FREE</a>(vp);
00103         }
00104     }
00105     <span class="keywordflow">return</span> SNMPERR_SUCCESS;
00106 }
00107 
00109 <span class="keywordtype">int</span>
<a name="l00110" id="l00110"></a><a class="code" href="group__old__api.html#ga2">00110</a> <a class="code" href=
"group__old__api.html#ga2">netsnmp_register_mib_table_row</a>(<span class="keyword">const</span> <span class=
"keywordtype">char</span> *moduleName,
00111                                <span class="keyword">struct</span> variable *var,
00112                                size_t varsize,
00113                                size_t numvars,
00114                                oid * mibloc,
00115                                size_t mibloclen,
00116                                <span class="keywordtype">int</span> priority,
00117                                <span class="keywordtype">int</span> var_subid,
00118                                <a class="code" href="structsnmp__session.html">netsnmp_session</a> * ss,
00119                                <span class="keyword">const</span> <span class=
"keywordtype">char</span> *context, <span class="keywordtype">int</span> timeout, <span class="keywordtype">int</span> flags)
00120 {
00121     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>    i = 0, rc = 0;
00122     oid             ubound = 0;
00123 
00124     <span class="keywordflow">for</span> (i = 0; i &lt; numvars; i++) {
00125         <span class="keyword">struct </span>variable *vr =
00126             (<span class="keyword">struct </span>variable *) ((<span class=
"keywordtype">char</span> *) var + (i * varsize));
00127         <a class="code" href="structnetsnmp__handler__registration__s.html">netsnmp_handler_registration</a> *r;
00128         <span class="keywordflow">if</span> ( var_subid &gt; (int)mibloclen ) {
00129             <span class="keywordflow">break</span>;    <span class="comment">/* doesn't make sense */</span>
00130         }
00131         r = <a class="code" href="group__util.html#ga39">SNMP_MALLOC_TYPEDEF</a>(<a class="code" href=
"structnetsnmp__handler__registration__s.html">netsnmp_handler_registration</a>);
00132 
00133         <span class="keywordflow">if</span> (r == NULL) {
00134             <span class="comment">/*</span>
00135 <span class="comment">             * Unregister whatever we have registered so far, and</span>
00136 <span class="comment">             * return an error.  </span>
00137 <span class="comment">             */</span>
00138             rc = MIB_REGISTRATION_FAILED;
00139             <span class="keywordflow">break</span>;
00140         }
00141         memset(r, 0, <span class="keyword">sizeof</span>(<a class="code" href=
"structnetsnmp__handler__registration__s.html">netsnmp_handler_registration</a>));
00142 
00143         r-&gt;<a class="code" href="structnetsnmp__handler__registration__s.html#o4">handler</a> = <a class="code" href=
"group__old__api.html#ga0">get_old_api_handler</a>();
00144         r-&gt;<a class="code" href="structnetsnmp__handler__registration__s.html#o0">handlerName</a> = strdup(moduleName);
00145 
00146         <span class="keywordflow">if</span> (r-&gt;<a class="code" href=
"structnetsnmp__handler__registration__s.html#o0">handlerName</a> == NULL) {
00147             <a class="code" href="group__handler.html#ga21">netsnmp_handler_registration_free</a>(r);
00148             <span class="keywordflow">break</span>;
00149         }
00150 
00151         r-&gt;<a class="code" href="structnetsnmp__handler__registration__s.html#o3">rootoid_len</a> = mibloclen;
00152         r-&gt;<a class="code" href=
"structnetsnmp__handler__registration__s.html#o2">rootoid</a> = (oid *) malloc(r-&gt;<a class="code" href=
"structnetsnmp__handler__registration__s.html#o3">rootoid_len</a> * <span class="keyword">sizeof</span>(oid));
00153 
00154         <span class="keywordflow">if</span> (r-&gt;<a class="code" href=
"structnetsnmp__handler__registration__s.html#o2">rootoid</a> == NULL) {
00155             <a class="code" href="group__handler.html#ga21">netsnmp_handler_registration_free</a>(r);
00156             rc = MIB_REGISTRATION_FAILED;
00157             <span class="keywordflow">break</span>;
00158         }
00159         memcpy(r-&gt;<a class="code" href=
"structnetsnmp__handler__registration__s.html#o2">rootoid</a>, mibloc, mibloclen * <span class="keyword">sizeof</span>(oid));
00160         memcpy((u_char *) (r-&gt;<a class="code" href=
"structnetsnmp__handler__registration__s.html#o2">rootoid</a> + (var_subid - vr-&gt;namelen)), vr-&gt;name,
00161                vr-&gt;namelen * <span class="keyword">sizeof</span>(oid));
00162         DEBUGMSGTL((<span class="stringliteral">"netsnmp_register_mib_table_row"</span>, <span class=
"stringliteral">"rootoid "</span>));
00163         DEBUGMSGOID((<span class="stringliteral">"netsnmp_register_mib_table_row"</span>, r-&gt;<a class="code" href=
"structnetsnmp__handler__registration__s.html#o2">rootoid</a>,
00164                      r-&gt;<a class="code" href="structnetsnmp__handler__registration__s.html#o3">rootoid_len</a>));
00165         DEBUGMSG((<span class="stringliteral">"netsnmp_register_mib_table_row"</span>, <span class=
"stringliteral">"(%d)\n"</span>,
00166                      (var_subid - vr-&gt;namelen)));
00167         r-&gt;<a class="code" href="structnetsnmp__handler__registration__s.html#o4">handler</a>-&gt;<a class="code" href=
"structnetsnmp__mib__handler__s.html#o1">myvoid</a> = (<span class="keywordtype">void</span> *) malloc(varsize);
00168 
00169         <span class="keywordflow">if</span> (r-&gt;<a class="code" href=
"structnetsnmp__handler__registration__s.html#o4">handler</a>-&gt;<a class="code" href=
"structnetsnmp__mib__handler__s.html#o1">myvoid</a> == NULL) {
00170             <a class="code" href="group__handler.html#ga21">netsnmp_handler_registration_free</a>(r);
00171             rc = MIB_REGISTRATION_FAILED;
00172             <span class="keywordflow">break</span>;
00173         }
00174         memcpy((<span class="keywordtype">char</span> *) r-&gt;<a class="code" href=
"structnetsnmp__handler__registration__s.html#o4">handler</a>-&gt;<a class="code" href=
"structnetsnmp__mib__handler__s.html#o1">myvoid</a>, vr, varsize);
00175 
00176         r-&gt;<a class="code" href=
"structnetsnmp__handler__registration__s.html#o1">contextName</a> = (context) ? strdup(context) : NULL;
00177 
00178         <span class="keywordflow">if</span> (context != NULL &amp;&amp; r-&gt;<a class="code" href=
"structnetsnmp__handler__registration__s.html#o1">contextName</a> == NULL) {
00179             <a class="code" href="group__handler.html#ga21">netsnmp_handler_registration_free</a>(r);
00180             rc = MIB_REGISTRATION_FAILED;
00181             <span class="keywordflow">break</span>;
00182         }
00183 
00184         r-&gt;<a class="code" href="structnetsnmp__handler__registration__s.html#o6">priority</a> = priority;
00185         r-&gt;<a class="code" href="structnetsnmp__handler__registration__s.html#o7">range_subid</a> = 0;     <span class=
"comment">/* var_subid; */</span>
00186         r-&gt;<a class="code" href="structnetsnmp__handler__registration__s.html#o8">range_ubound</a> = 0;    <span class=
"comment">/* range_ubound; */</span>
00187         r-&gt;<a class="code" href="structnetsnmp__handler__registration__s.html#o9">timeout</a> = timeout;
00188         r-&gt;<a class="code" href="structnetsnmp__handler__registration__s.html#o5">modes</a> = HANDLER_CAN_RWRITE;
00189 
00190         <span class="comment">/*</span>
00191 <span class="comment">         * Register this column and row  </span>
00192 <span class="comment">         */</span>
00193         <span class="keywordflow">if</span> ((rc =
00194              <a class="code" href="group__handler.html#ga12">netsnmp_register_handler_nocallback</a>(r)) !=
00195             MIB_REGISTERED_OK) {
00196             DEBUGMSGTL((<span class="stringliteral">"netsnmp_register_mib_table_row"</span>,
00197                         <span class="stringliteral">"register failed %d\n"</span>, rc));
00198             <a class="code" href="group__handler.html#ga21">netsnmp_handler_registration_free</a>(r);
00199             <span class="keywordflow">break</span>;
00200         }
00201 
00202         <span class="keywordflow">if</span> (vr-&gt;namelen &gt; 0) {
00203             <span class="keywordflow">if</span> (vr-&gt;name[vr-&gt;namelen - 1] &gt; ubound) {
00204                 ubound = vr-&gt;name[vr-&gt;namelen - 1];
00205             }
00206         }
00207     }
00208 
00209     <span class="keywordflow">if</span> (rc == MIB_REGISTERED_OK) {
00210         <span class="keyword">struct </span>register_parameters reg_parms;
00211 
00212         reg_parms.name = mibloc;
00213         reg_parms.namelen = mibloclen;
00214         reg_parms.<a class="code" href="structnetsnmp__handler__registration__s.html#o6">priority</a> = priority;
00215         reg_parms.flags = (u_char) flags;
00216         reg_parms.<a class="code" href="structnetsnmp__handler__registration__s.html#o7">range_subid</a> = var_subid;
00217         reg_parms.<a class="code" href="structnetsnmp__handler__registration__s.html#o8">range_ubound</a> = ubound;
00218         reg_parms.<a class="code" href="structnetsnmp__handler__registration__s.html#o9">timeout</a> = timeout;
00219         rc = <a class="code" href="group__callback.html#ga5">snmp_call_callbacks</a>(SNMP_CALLBACK_APPLICATION,
00220                                  SNMPD_CALLBACK_REGISTER_OID, &amp;reg_parms);
00221     }
00222 
00223     <span class="keywordflow">return</span> rc;
00224 }
00225 
00227 <span class="keywordtype">int</span>
<a name="l00228" id="l00228"></a><a class="code" href="group__old__api.html#ga3">00228</a> <a class="code" href=
"group__old__api.html#ga3">netsnmp_old_api_helper</a>(<a class="code" href=
"structnetsnmp__mib__handler__s.html">netsnmp_mib_handler</a> *handler,
00229                        <a class="code" href=
"structnetsnmp__handler__registration__s.html">netsnmp_handler_registration</a> *reginfo,
00230                        <a class="code" href=
"structnetsnmp__agent__request__info__s.html">netsnmp_agent_request_info</a> *reqinfo,
00231                        <a class="code" href="structnetsnmp__request__info__s.html">netsnmp_request_info</a> *requests)
00232 {
00233 
00234 <span class="preprocessor">#if MIB_CLIENTS_ARE_EVIL</span>
00235     oid             save[MAX_OID_LEN];
00236     size_t          savelen = 0;
00237 <span class="preprocessor">#endif</span>
00238     <span class="keyword">struct </span>variable compat_var, *cvp = &amp;compat_var;
00239     <span class="keywordtype">int</span>             exact = 1;
00240     <span class="keywordtype">int</span>             status;
00241 
00242     <span class="keyword">struct </span>variable *vp;
00243     WriteMethod    *write_method = NULL;
00244     size_t          len;
00245     u_char         *access = NULL;
00246     netsnmp_old_api_cache *cacheptr;
00247     netsnmp_agent_session *oldasp = NULL;
00248 
00249     vp = (<span class="keyword">struct </span>variable *) handler-&gt;<a class="code" href=
"structnetsnmp__mib__handler__s.html#o1">myvoid</a>;
00250 
00251     <span class="comment">/*</span>
00252 <span class="comment">     * create old variable structure with right information </span>
00253 <span class="comment">     */</span>
00254     memcpy(cvp-&gt;name, reginfo-&gt;<a class="code" href="structnetsnmp__handler__registration__s.html#o2">rootoid</a>,
00255            reginfo-&gt;<a class="code" href=
"structnetsnmp__handler__registration__s.html#o3">rootoid_len</a> * <span class="keyword">sizeof</span>(oid));
00256     cvp-&gt;namelen = reginfo-&gt;<a class="code" href="structnetsnmp__handler__registration__s.html#o3">rootoid_len</a>;
00257     cvp-&gt;type = vp-&gt;type;
00258     cvp-&gt;magic = vp-&gt;magic;
00259     cvp-&gt;acl = vp-&gt;acl;
00260     cvp-&gt;findVar = vp-&gt;findVar;
00261 
00262     <span class="keywordflow">switch</span> (reqinfo-&gt;<a class="code" href=
"structnetsnmp__agent__request__info__s.html#o0">mode</a>) {
00263     <span class="keywordflow">case</span> MODE_GETNEXT:
00264     <span class="keywordflow">case</span> MODE_GETBULK:
00265         exact = 0;
00266     }
00267 
00268     <span class="keywordflow">for</span> (; requests; requests = requests-&gt;<a class="code" href=
"structnetsnmp__request__info__s.html#o13">next</a>) {
00269 
00270 <span class="preprocessor">#if MIB_CLIENTS_ARE_EVIL</span>
00271         savelen = requests-&gt;<a class="code" href="structnetsnmp__request__info__s.html#o0">requestvb</a>-&gt;<a class=
"code" href="structvariable__list.html#o2">name_length</a>;
00272         memcpy(save, requests-&gt;<a class="code" href=
"structnetsnmp__request__info__s.html#o0">requestvb</a>-&gt;<a class="code" href=
"structvariable__list.html#o1">name</a>, savelen * <span class="keyword">sizeof</span>(oid));
00273 <span class="preprocessor">#endif</span>
00274 
00275         <span class="keywordflow">switch</span> (reqinfo-&gt;<a class="code" href=
"structnetsnmp__agent__request__info__s.html#o0">mode</a>) {
00276         <span class="keywordflow">case</span> MODE_GET:
00277         <span class="keywordflow">case</span> MODE_GETNEXT:
00278         <span class="keywordflow">case</span> MODE_SET_RESERVE1:
00279             <span class="comment">/*</span>
00280 <span class="comment">             * Actually call the old mib-module function </span>
00281 <span class="comment">             */</span>
00282             <span class="keywordflow">if</span> (vp &amp;&amp; vp-&gt;findVar)
00283                 access = (*(vp-&gt;findVar)) (cvp, requests-&gt;<a class="code" href=
"structnetsnmp__request__info__s.html#o0">requestvb</a>-&gt;<a class="code" href="structvariable__list.html#o1">name</a>,
00284                                            &amp;(requests-&gt;<a class="code" href=
"structnetsnmp__request__info__s.html#o0">requestvb</a>-&gt;
00285                                              name_length), exact, &amp;len,
00286                                            &amp;write_method);
00287             <span class="keywordflow">else</span>
00288                 access = NULL;
00289 
00290 <span class="preprocessor">#ifdef WWW_FIX</span>
00291             <span class="keywordflow">if</span> (IS_DELEGATED(cvp-&gt;type)) {
00292                 add_method = (AddVarMethod *) statP;
00293                 requests-&gt;delayed = 1;
00294                 have_delegated = 1;
00295                 <span class="keywordflow">continue</span>;       <span class=
"comment">/* WWW: This may not get to the right place */</span>
00296             }
00297 <span class="preprocessor">#endif</span>
00298 
00299             <span class="comment">/*</span>
00300 <span class="comment">             * WWW: end range checking </span>
00301 <span class="comment">             */</span>
00302             <span class="keywordflow">if</span> (access) {
00303                 <span class="comment">/*</span>
00304 <span class="comment">                 * result returned </span>
00305 <span class="comment">                 */</span>
00306                 <span class="keywordflow">if</span> (reqinfo-&gt;<a class="code" href=
"structnetsnmp__agent__request__info__s.html#o0">mode</a> != MODE_SET_RESERVE1)
00307                     <a class="code" href=
"group__snmp__client.html#ga18">snmp_set_var_typed_value</a>(requests-&gt;<a class="code" href=
"structnetsnmp__request__info__s.html#o0">requestvb</a>,
00308                                              cvp-&gt;<a class="code" href=
"structvariable__list.html#o3">type</a>, access, len);
00309             } <span class="keywordflow">else</span> {
00310                 <span class="comment">/*</span>
00311 <span class="comment">                 * no result returned </span>
00312 <span class="comment">                 */</span>
00313 <span class="preprocessor">#if MIB_CLIENTS_ARE_EVIL</span>
00314                 <span class="keywordflow">if</span> (access == NULL) {
00315                     <span class="keywordflow">if</span> (<a class="code" href=
"group__library.html#ga100">netsnmp_oid_equals</a>(requests-&gt;<a class="code" href=
"structnetsnmp__request__info__s.html#o0">requestvb</a>-&gt;<a class="code" href="structvariable__list.html#o1">name</a>,
00316                                          requests-&gt;<a class="code" href=
"structnetsnmp__request__info__s.html#o0">requestvb</a>-&gt;<a class="code" href="structvariable__list.html#o2">name_length</a>,
00317                                          save, savelen) != 0) {
00318                         DEBUGMSGTL((<span class="stringliteral">"old_api"</span>, <span class=
"stringliteral">"evil_client: %s\n"</span>,
00319                                     reginfo-&gt;<a class="code" href=
"structnetsnmp__handler__registration__s.html#o0">handlerName</a>));
00320                         memcpy(requests-&gt;<a class="code" href=
"structnetsnmp__request__info__s.html#o0">requestvb</a>-&gt;<a class="code" href="structvariable__list.html#o1">name</a>, save,
00321                                savelen * <span class="keyword">sizeof</span>(oid));
00322                         requests-&gt;<a class="code" href=
"structnetsnmp__request__info__s.html#o0">requestvb</a>-&gt;<a class="code" href=
"structvariable__list.html#o2">name_length</a> = savelen;
00323                     }
00324                 }
00325 <span class="preprocessor">#endif</span>
00326             }
00327 
00328             <span class="comment">/*</span>
00329 <span class="comment">             * AAA: fall through for everything that is a set (see BBB) </span>
00330 <span class="comment">             */</span>
00331             <span class="keywordflow">if</span> (reqinfo-&gt;<a class="code" href=
"structnetsnmp__agent__request__info__s.html#o0">mode</a> != MODE_SET_RESERVE1)
00332                 <span class="keywordflow">break</span>;
00333 
00334             cacheptr = <a class="code" href="group__util.html#ga39">SNMP_MALLOC_TYPEDEF</a>(netsnmp_old_api_cache);
00335             <span class="keywordflow">if</span> (!cacheptr)
00336                 <span class="keywordflow">return</span> <a class="code" href=
"group__snmp__agent.html#ga79">netsnmp_set_request_error</a>(reqinfo, requests,
00337                                                  SNMP_ERR_RESOURCEUNAVAILABLE);
00338             cacheptr-&gt;<a class="code" href="structvariable__list.html#o8">data</a> = access;
00339             cacheptr-&gt;write_method = write_method;
00340             write_method = NULL;
00341             <a class="code" href="group__handler.html#ga27">netsnmp_request_add_list_data</a>(requests,
00342                                           <a class="code" href="group__data__list.html#ga3">netsnmp_create_data_list</a>
00343                                           (OLD_API_NAME, cacheptr, free));
00344             <span class="comment">/*</span>
00345 <span class="comment">             * BBB: fall through for everything that is a set (see AAA) </span>
00346 <span class="comment">             */</span>
00347 
00348         <span class="keywordflow">default</span>:
00349             <span class="comment">/*</span>
00350 <span class="comment">             * WWW: explicitly list the SET conditions </span>
00351 <span class="comment">             */</span>
00352             <span class="comment">/*</span>
00353 <span class="comment">             * (the rest of the) SET contions </span>
00354 <span class="comment">             */</span>
00355             cacheptr =
00356                 (netsnmp_old_api_cache *)
00357                 <a class="code" href="group__handler.html#ga29">netsnmp_request_get_list_data</a>(requests, OLD_API_NAME);
00358 
00359             <span class="keywordflow">if</span> (cacheptr == NULL || cacheptr-&gt;write_method == NULL) {
00360                 <span class="comment">/*</span>
00361 <span class="comment">                 * WWW: try to set ourselves if possible? </span>
00362 <span class="comment">                 */</span>
00363                 <span class="keywordflow">return</span> <a class="code" href=
"group__snmp__agent.html#ga79">netsnmp_set_request_error</a>(reqinfo, requests,
00364                                                  SNMP_ERR_NOTWRITABLE);
00365             }
00366 
00367             oldasp = netsnmp_get_current_agent_session();
00368             set_current_agent_session(reqinfo-&gt;<a class="code" href=
"structnetsnmp__agent__request__info__s.html#o1">asp</a>);
00369             status =
00370                 (*(cacheptr-&gt;write_method)) (reqinfo-&gt;<a class="code" href=
"structnetsnmp__agent__request__info__s.html#o0">mode</a>,
00371                                              requests-&gt;<a class="code" href=
"structnetsnmp__request__info__s.html#o0">requestvb</a>-&gt;<a class="code" href="structvariable__list.html#o4">val</a>.
00372                                              string,
00373                                              requests-&gt;<a class="code" href=
"structnetsnmp__request__info__s.html#o0">requestvb</a>-&gt;<a class="code" href="structvariable__list.html#o3">type</a>,
00374                                              requests-&gt;<a class="code" href=
"structnetsnmp__request__info__s.html#o0">requestvb</a>-&gt;<a class="code" href="structvariable__list.html#o5">val_len</a>,
00375                                              cacheptr-&gt;<a class="code" href="structvariable__list.html#o8">data</a>,
00376                                              requests-&gt;<a class="code" href=
"structnetsnmp__request__info__s.html#o0">requestvb</a>-&gt;<a class="code" href="structvariable__list.html#o1">name</a>,
00377                                              requests-&gt;<a class="code" href=
"structnetsnmp__request__info__s.html#o0">requestvb</a>-&gt;
00378                                              name_length);
00379             set_current_agent_session(oldasp);
00380 
00381             <span class="keywordflow">if</span> (status != SNMP_ERR_NOERROR) {
00382                 <a class="code" href=
"group__snmp__agent.html#ga79">netsnmp_set_request_error</a>(reqinfo, requests, status);
00383             }
00384 
00385             <span class="comment">/*</span>
00386 <span class="comment">             * clean up is done by the automatic freeing of the</span>
00387 <span class="comment">             * cache stored in the request. </span>
00388 <span class="comment">             */</span>
00389 
00390             <span class="keywordflow">break</span>;
00391         }
00392     }
00393     <span class="keywordflow">return</span> SNMP_ERR_NOERROR;
00394 }
00395 
00398 <span class="comment">/*</span>
00399 <span class="comment"> * don't use this! </span>
00400 <span class="comment"> */</span>
00401 <span class="keyword">static</span> netsnmp_agent_session *current_agent_session = NULL;
00402 netsnmp_agent_session *
00403 netsnmp_get_current_agent_session()
00404 {
00405     <span class="keywordflow">return</span> current_agent_session;
00406 }
00407 
00408 <span class="comment">/*</span>
00409 <span class="comment"> * don't use this! </span>
00410 <span class="comment"> */</span>
00411 <span class="keywordtype">void</span>
00412 set_current_agent_session(netsnmp_agent_session *asp)
00413 {
00414     current_agent_session = asp;
00415 }
</pre>
  </div>
  <hr size="1" />

  <address style="align: right;">
    <small><!--#include virtual="/sfbutton.html" --><br />
    Generated on Thu Oct 28 21:46:58 2004 for net-snmp by&nbsp; <a href="http://www.doxygen.org/index.html"><img src=
    "doxygen.png" alt="doxygen" align="middle" border="0" /></a> 1.3.9.1</small>
<!-- CONTENT END -->
<!--#include virtual="/page-bottom.html" -->

