<!--#set var="section" value="development" -->
<!--#include virtual="/page-top.html" -->
<!-- CONTENT START -->
  <!-- Generated by Doxygen 1.3.9.1 -->

  <div class="qindex">
    <a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="modules.html">Modules</a> | <a class=
    "qindex" href="annotated.html">Data&nbsp;Structures</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class=
    "qindex" href="functions.html">Data&nbsp;Fields</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a> | <a class=
    "qindex" href="examples.html">Examples</a>
  </div>

  <div class="nav">
    <a class="el" href="dir_000003.html">agent</a>&nbsp;/&nbsp;<a class="el" href="dir_000004.html">helpers</a>
  </div>

  <h1>old_api.c</h1>

  <div class="fragment">
    <pre class="fragment">
00001 <span class="preprocessor">#include &lt;net-snmp/net-snmp-config.h&gt;</span>
00002 
00003 <span class="preprocessor">#if HAVE_STRING_H</span>
00004 <span class="preprocessor">#include &lt;string.h&gt;</span>
00005 <span class="preprocessor">#else</span>
00006 <span class="preprocessor">#include &lt;strings.h&gt;</span>
00007 <span class="preprocessor">#endif</span>
00008 
00009 <span class="preprocessor">#include &lt;net-snmp/net-snmp-includes.h&gt;</span>
00010 <span class="preprocessor">#include &lt;net-snmp/agent/net-snmp-agent-includes.h&gt;</span>
00011 
00012 <span class="preprocessor">#include &lt;net-snmp/agent/old_api.h&gt;</span>
00013 <span class="preprocessor">#include &lt;net-snmp/agent/agent_callbacks.h&gt;</span>
00014 
00015 <span class="preprocessor">#define MIB_CLIENTS_ARE_EVIL 1</span>
00016 
00017 <span class="comment">/*</span>
00018 <span class="comment"> * don't use these! </span>
00019 <span class="comment"> */</span>
00020 <span class="keywordtype">void</span>            set_current_agent_session(netsnmp_agent_session *asp);
00021 netsnmp_agent_session *netsnmp_get_current_agent_session(<span class="keywordtype">void</span>);
00022 
00035 <a class="code" href="structnetsnmp__mib__handler__s.html">netsnmp_mib_handler</a> *
<a name="l00036" id="l00036"></a><a class="code" href="group__old__api.html#ga0">00036</a> <a class="code" href=
"group__old__api.html#ga0">get_old_api_handler</a>(<span class="keywordtype">void</span>)
00037 {
00038     <span class="keywordflow">return</span> <a class="code" href=
"group__handler.html#ga7">netsnmp_create_handler</a>(<span class="stringliteral">"old_api"</span>, netsnmp_old_api_helper);
00039 }
00040 
00041 
00046 <span class="keywordtype">int</span>
<a name="l00047" id="l00047"></a><a class="code" href="group__old__api.html#ga1">00047</a> <a class="code" href=
"group__old__api.html#ga1">netsnmp_register_old_api</a>(<span class="keyword">const</span> <span class=
"keywordtype">char</span> *moduleName,
00048                          <span class="keyword">struct</span> variable *var,
00049                          size_t varsize,
00050                          size_t numvars,
00051                          oid * mibloc,
00052                          size_t mibloclen,
00053                          <span class="keywordtype">int</span> priority,
00054                          <span class="keywordtype">int</span> range_subid,
00055                          oid range_ubound,
00056                          <a class="code" href="structsnmp__session.html">netsnmp_session</a> * ss,
00057                          <span class="keyword">const</span> <span class="keywordtype">char</span> *context, <span class=
"keywordtype">int</span> timeout, <span class="keywordtype">int</span> flags)
00058 {
00059 
00060     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>    i;
00061 
00062     <span class="comment">/*</span>
00063 <span class="comment">     * register all subtree nodes </span>
00064 <span class="comment">     */</span>
00065     <span class="keywordflow">for</span> (i = 0; i &lt; numvars; i++) {
00066         <span class="keyword">struct </span>variable *vp;
00067         <a class="code" href="structnetsnmp__handler__registration__s.html">netsnmp_handler_registration</a> *reginfo =
00068             <a class="code" href="group__util.html#ga39">SNMP_MALLOC_TYPEDEF</a>(<a class="code" href=
"structnetsnmp__handler__registration__s.html">netsnmp_handler_registration</a>);
00069 
00070         <a class="code" href="group__util.html#ga5">memdup</a>((<span class="keywordtype">void</span> *) &amp;vp,
00071                (<span class="keywordtype">void</span> *) (<span class="keyword">struct</span> variable *) ((<span class=
"keywordtype">char</span> *) var + varsize * i),
00072                varsize);
00073 
00074         reginfo-&gt;<a class="code" href="structnetsnmp__handler__registration__s.html#o4">handler</a> = <a class="code"
href="group__old__api.html#ga0">get_old_api_handler</a>();
00075         reginfo-&gt;<a class="code" href=
"structnetsnmp__handler__registration__s.html#o0">handlerName</a> = strdup(moduleName);
00076         reginfo-&gt;<a class="code" href=
"structnetsnmp__handler__registration__s.html#o3">rootoid_len</a> = (mibloclen + vp-&gt;namelen);
00077         reginfo-&gt;<a class="code" href="structnetsnmp__handler__registration__s.html#o2">rootoid</a> =
00078             (oid *) malloc(reginfo-&gt;<a class="code" href=
"structnetsnmp__handler__registration__s.html#o3">rootoid_len</a> * <span class="keyword">sizeof</span>(oid));
00079 
00080         memcpy(reginfo-&gt;<a class="code" href=
"structnetsnmp__handler__registration__s.html#o2">rootoid</a>, mibloc, mibloclen * <span class="keyword">sizeof</span>(oid));
00081         memcpy(reginfo-&gt;<a class="code" href=
"structnetsnmp__handler__registration__s.html#o2">rootoid</a> + mibloclen, vp-&gt;name, vp-&gt;namelen
00082                * <span class="keyword">sizeof</span>(oid));
00083         reginfo-&gt;<a class="code" href="structnetsnmp__handler__registration__s.html#o4">handler</a>-&gt;<a class="code"
href="structnetsnmp__mib__handler__s.html#o1">myvoid</a> = (<span class="keywordtype">void</span> *) vp;
00084 
00085         reginfo-&gt;<a class="code" href="structnetsnmp__handler__registration__s.html#o6">priority</a> = priority;
00086         reginfo-&gt;<a class="code" href="structnetsnmp__handler__registration__s.html#o7">range_subid</a> = range_subid;
00087 
00088         reginfo-&gt;<a class="code" href="structnetsnmp__handler__registration__s.html#o8">range_ubound</a> = range_ubound;
00089         reginfo-&gt;<a class="code" href="structnetsnmp__handler__registration__s.html#o9">timeout</a> = timeout;
00090         reginfo-&gt;<a class="code" href=
"structnetsnmp__handler__registration__s.html#o1">contextName</a> = (context) ? strdup(context) : NULL;
00091         reginfo-&gt;<a class="code" href="structnetsnmp__handler__registration__s.html#o5">modes</a> = HANDLER_CAN_RWRITE;
00092 
00093         <span class="comment">/*</span>
00094 <span class="comment">         * register ourselves in the mib tree </span>
00095 <span class="comment">         */</span>
00096         <span class="keywordflow">if</span> (<a class="code" href=
"group__handler.html#ga10">netsnmp_register_handler</a>(reginfo) != MIB_REGISTERED_OK) {
00098             <a class="code" href="group__util.html#ga36">SNMP_FREE</a>(vp);
00099         }
00100     }
00101     <span class="keywordflow">return</span> SNMPERR_SUCCESS;
00102 }
00103 
00105 <span class="keywordtype">int</span>
<a name="l00106" id="l00106"></a><a class="code" href="group__old__api.html#ga2">00106</a> <a class="code" href=
"group__old__api.html#ga2">netsnmp_register_mib_table_row</a>(<span class="keyword">const</span> <span class=
"keywordtype">char</span> *moduleName,
00107                                <span class="keyword">struct</span> variable *var,
00108                                size_t varsize,
00109                                size_t numvars,
00110                                oid * mibloc,
00111                                size_t mibloclen,
00112                                <span class="keywordtype">int</span> priority,
00113                                <span class="keywordtype">int</span> var_subid,
00114                                <a class="code" href="structsnmp__session.html">netsnmp_session</a> * ss,
00115                                <span class="keyword">const</span> <span class=
"keywordtype">char</span> *context, <span class="keywordtype">int</span> timeout, <span class="keywordtype">int</span> flags)
00116 {
00117     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>    i = 0, rc = 0;
00118     oid             ubound = 0;
00119 
00120     <span class="keywordflow">for</span> (i = 0; i &lt; numvars; i++) {
00121         <span class="keyword">struct </span>variable *vr =
00122             (<span class="keyword">struct </span>variable *) ((<span class=
"keywordtype">char</span> *) var + (i * varsize));
00123         <a class="code" href="structnetsnmp__handler__registration__s.html">netsnmp_handler_registration</a> *r;
00124         <span class="keywordflow">if</span> ( var_subid &gt; (int)mibloclen ) {
00125             <span class="keywordflow">break</span>;    <span class="comment">/* doesn't make sense */</span>
00126         }
00127         r = <a class="code" href="group__util.html#ga39">SNMP_MALLOC_TYPEDEF</a>(<a class="code" href=
"structnetsnmp__handler__registration__s.html">netsnmp_handler_registration</a>);
00128 
00129         <span class="keywordflow">if</span> (r == NULL) {
00130             <span class="comment">/*</span>
00131 <span class="comment">             * Unregister whatever we have registered so far, and</span>
00132 <span class="comment">             * return an error.  </span>
00133 <span class="comment">             */</span>
00134             rc = MIB_REGISTRATION_FAILED;
00135             <span class="keywordflow">break</span>;
00136         }
00137         memset(r, 0, <span class="keyword">sizeof</span>(<a class="code" href=
"structnetsnmp__handler__registration__s.html">netsnmp_handler_registration</a>));
00138 
00139         r-&gt;<a class="code" href="structnetsnmp__handler__registration__s.html#o4">handler</a> = <a class="code" href=
"group__old__api.html#ga0">get_old_api_handler</a>();
00140         r-&gt;<a class="code" href="structnetsnmp__handler__registration__s.html#o0">handlerName</a> = strdup(moduleName);
00141 
00142         <span class="keywordflow">if</span> (r-&gt;<a class="code" href=
"structnetsnmp__handler__registration__s.html#o0">handlerName</a> == NULL) {
00143             <a class="code" href="group__handler.html#ga21">netsnmp_handler_registration_free</a>(r);
00144             <span class="keywordflow">break</span>;
00145         }
00146 
00147         r-&gt;<a class="code" href="structnetsnmp__handler__registration__s.html#o3">rootoid_len</a> = mibloclen;
00148         r-&gt;<a class="code" href=
"structnetsnmp__handler__registration__s.html#o2">rootoid</a> = (oid *) malloc(r-&gt;<a class="code" href=
"structnetsnmp__handler__registration__s.html#o3">rootoid_len</a> * <span class="keyword">sizeof</span>(oid));
00149 
00150         <span class="keywordflow">if</span> (r-&gt;<a class="code" href=
"structnetsnmp__handler__registration__s.html#o2">rootoid</a> == NULL) {
00151             <a class="code" href="group__handler.html#ga21">netsnmp_handler_registration_free</a>(r);
00152             rc = MIB_REGISTRATION_FAILED;
00153             <span class="keywordflow">break</span>;
00154         }
00155         memcpy(r-&gt;<a class="code" href=
"structnetsnmp__handler__registration__s.html#o2">rootoid</a>, mibloc, mibloclen * <span class="keyword">sizeof</span>(oid));
00156         memcpy((u_char *) (r-&gt;<a class="code" href=
"structnetsnmp__handler__registration__s.html#o2">rootoid</a> + (var_subid - vr-&gt;namelen)), vr-&gt;name,
00157                vr-&gt;namelen * <span class="keyword">sizeof</span>(oid));
00158         DEBUGMSGTL((<span class="stringliteral">"netsnmp_register_mib_table_row"</span>, <span class=
"stringliteral">"rootoid "</span>));
00159         DEBUGMSGOID((<span class="stringliteral">"netsnmp_register_mib_table_row"</span>, r-&gt;<a class="code" href=
"structnetsnmp__handler__registration__s.html#o2">rootoid</a>,
00160                      r-&gt;<a class="code" href="structnetsnmp__handler__registration__s.html#o3">rootoid_len</a>));
00161         DEBUGMSG((<span class="stringliteral">"netsnmp_register_mib_table_row"</span>, <span class=
"stringliteral">"(%d)\n"</span>,
00162                      (var_subid - vr-&gt;namelen)));
00163         r-&gt;<a class="code" href="structnetsnmp__handler__registration__s.html#o4">handler</a>-&gt;<a class="code" href=
"structnetsnmp__mib__handler__s.html#o1">myvoid</a> = (<span class="keywordtype">void</span> *) malloc(varsize);
00164 
00165         <span class="keywordflow">if</span> (r-&gt;<a class="code" href=
"structnetsnmp__handler__registration__s.html#o4">handler</a>-&gt;<a class="code" href=
"structnetsnmp__mib__handler__s.html#o1">myvoid</a> == NULL) {
00166             <a class="code" href="group__handler.html#ga21">netsnmp_handler_registration_free</a>(r);
00167             rc = MIB_REGISTRATION_FAILED;
00168             <span class="keywordflow">break</span>;
00169         }
00170         memcpy((<span class="keywordtype">char</span> *) r-&gt;<a class="code" href=
"structnetsnmp__handler__registration__s.html#o4">handler</a>-&gt;<a class="code" href=
"structnetsnmp__mib__handler__s.html#o1">myvoid</a>, vr, varsize);
00171 
00172         r-&gt;<a class="code" href=
"structnetsnmp__handler__registration__s.html#o1">contextName</a> = (context) ? strdup(context) : NULL;
00173 
00174         <span class="keywordflow">if</span> (context != NULL &amp;&amp; r-&gt;<a class="code" href=
"structnetsnmp__handler__registration__s.html#o1">contextName</a> == NULL) {
00175             <a class="code" href="group__handler.html#ga21">netsnmp_handler_registration_free</a>(r);
00176             rc = MIB_REGISTRATION_FAILED;
00177             <span class="keywordflow">break</span>;
00178         }
00179 
00180         r-&gt;<a class="code" href="structnetsnmp__handler__registration__s.html#o6">priority</a> = priority;
00181         r-&gt;<a class="code" href="structnetsnmp__handler__registration__s.html#o7">range_subid</a> = 0;     <span class=
"comment">/* var_subid; */</span>
00182         r-&gt;<a class="code" href="structnetsnmp__handler__registration__s.html#o8">range_ubound</a> = 0;    <span class=
"comment">/* range_ubound; */</span>
00183         r-&gt;<a class="code" href="structnetsnmp__handler__registration__s.html#o9">timeout</a> = timeout;
00184         r-&gt;<a class="code" href="structnetsnmp__handler__registration__s.html#o5">modes</a> = HANDLER_CAN_RWRITE;
00185 
00186         <span class="comment">/*</span>
00187 <span class="comment">         * Register this column and row  </span>
00188 <span class="comment">         */</span>
00189         <span class="keywordflow">if</span> ((rc =
00190              <a class="code" href="group__handler.html#ga12">netsnmp_register_handler_nocallback</a>(r)) !=
00191             MIB_REGISTERED_OK) {
00192             DEBUGMSGTL((<span class="stringliteral">"netsnmp_register_mib_table_row"</span>,
00193                         <span class="stringliteral">"register failed %d\n"</span>, rc));
00194             <a class="code" href="group__handler.html#ga21">netsnmp_handler_registration_free</a>(r);
00195             <span class="keywordflow">break</span>;
00196         }
00197 
00198         <span class="keywordflow">if</span> (vr-&gt;namelen &gt; 0) {
00199             <span class="keywordflow">if</span> (vr-&gt;name[vr-&gt;namelen - 1] &gt; ubound) {
00200                 ubound = vr-&gt;name[vr-&gt;namelen - 1];
00201             }
00202         }
00203     }
00204 
00205     <span class="keywordflow">if</span> (rc == MIB_REGISTERED_OK) {
00206         <span class="keyword">struct </span>register_parameters reg_parms;
00207 
00208         reg_parms.name = mibloc;
00209         reg_parms.namelen = mibloclen;
00210         reg_parms.<a class="code" href="structnetsnmp__handler__registration__s.html#o6">priority</a> = priority;
00211         reg_parms.flags = (u_char) flags;
00212         reg_parms.<a class="code" href="structnetsnmp__handler__registration__s.html#o7">range_subid</a> = var_subid;
00213         reg_parms.<a class="code" href="structnetsnmp__handler__registration__s.html#o8">range_ubound</a> = ubound;
00214         reg_parms.<a class="code" href="structnetsnmp__handler__registration__s.html#o9">timeout</a> = timeout;
00215         reg_parms.<a class="code" href="structnetsnmp__handler__registration__s.html#o1">contextName</a> = context;
00216         rc = <a class="code" href="group__callback.html#ga10">snmp_call_callbacks</a>(SNMP_CALLBACK_APPLICATION,
00217                                  SNMPD_CALLBACK_REGISTER_OID, &amp;reg_parms);
00218     }
00219 
00220     <span class="keywordflow">return</span> rc;
00221 }
00222 
00224 <span class="keywordtype">int</span>
<a name="l00225" id="l00225"></a><a class="code" href="group__old__api.html#ga3">00225</a> <a class="code" href=
"group__old__api.html#ga3">netsnmp_old_api_helper</a>(<a class="code" href=
"structnetsnmp__mib__handler__s.html">netsnmp_mib_handler</a> *handler,
00226                        <a class="code" href=
"structnetsnmp__handler__registration__s.html">netsnmp_handler_registration</a> *reginfo,
00227                        <a class="code" href=
"structnetsnmp__agent__request__info__s.html">netsnmp_agent_request_info</a> *reqinfo,
00228                        <a class="code" href="structnetsnmp__request__info__s.html">netsnmp_request_info</a> *requests)
00229 {
00230 
00231 <span class="preprocessor">#if MIB_CLIENTS_ARE_EVIL</span>
00232     oid             save[MAX_OID_LEN];
00233     size_t          savelen = 0;
00234 <span class="preprocessor">#endif</span>
00235     <span class="keyword">struct </span>variable compat_var, *cvp = &amp;compat_var;
00236     <span class="keywordtype">int</span>             exact = 1;
00237     <span class="keywordtype">int</span>             status;
00238 
00239     <span class="keyword">struct </span>variable *vp;
00240     WriteMethod    *write_method = NULL;
00241     size_t          len;
00242     u_char         *access = NULL;
00243     netsnmp_old_api_cache *cacheptr;
00244     netsnmp_agent_session *oldasp = NULL;
00245 
00246     vp = (<span class="keyword">struct </span>variable *) handler-&gt;<a class="code" href=
"structnetsnmp__mib__handler__s.html#o1">myvoid</a>;
00247 
00248     <span class="comment">/*</span>
00249 <span class="comment">     * create old variable structure with right information </span>
00250 <span class="comment">     */</span>
00251     memcpy(cvp-&gt;name, reginfo-&gt;<a class="code" href="structnetsnmp__handler__registration__s.html#o2">rootoid</a>,
00252            reginfo-&gt;<a class="code" href=
"structnetsnmp__handler__registration__s.html#o3">rootoid_len</a> * <span class="keyword">sizeof</span>(oid));
00253     cvp-&gt;namelen = reginfo-&gt;<a class="code" href="structnetsnmp__handler__registration__s.html#o3">rootoid_len</a>;
00254     cvp-&gt;type = vp-&gt;type;
00255     cvp-&gt;magic = vp-&gt;magic;
00256     cvp-&gt;acl = vp-&gt;acl;
00257     cvp-&gt;findVar = vp-&gt;findVar;
00258 
00259     <span class="keywordflow">switch</span> (reqinfo-&gt;<a class="code" href=
"structnetsnmp__agent__request__info__s.html#o0">mode</a>) {
00260     <span class="keywordflow">case</span> MODE_GETNEXT:
00261     <span class="keywordflow">case</span> MODE_GETBULK:
00262         exact = 0;
00263     }
00264 
00265     <span class="keywordflow">for</span> (; requests; requests = requests-&gt;<a class="code" href=
"structnetsnmp__request__info__s.html#o13">next</a>) {
00266 
00267 <span class="preprocessor">#if MIB_CLIENTS_ARE_EVIL</span>
00268         savelen = requests-&gt;<a class="code" href="structnetsnmp__request__info__s.html#o0">requestvb</a>-&gt;<a class=
"code" href="structvariable__list.html#o2">name_length</a>;
00269         memcpy(save, requests-&gt;<a class="code" href=
"structnetsnmp__request__info__s.html#o0">requestvb</a>-&gt;<a class="code" href=
"structvariable__list.html#o1">name</a>, savelen * <span class="keyword">sizeof</span>(oid));
00270 <span class="preprocessor">#endif</span>
00271 
00272         <span class="keywordflow">switch</span> (reqinfo-&gt;<a class="code" href=
"structnetsnmp__agent__request__info__s.html#o0">mode</a>) {
00273         <span class="keywordflow">case</span> MODE_GET:
00274         <span class="keywordflow">case</span> MODE_GETNEXT:
00275         <span class="keywordflow">case</span> MODE_SET_RESERVE1:
00276             <span class="comment">/*</span>
00277 <span class="comment">             * Actually call the old mib-module function </span>
00278 <span class="comment">             */</span>
00279             <span class="keywordflow">if</span> (vp &amp;&amp; vp-&gt;findVar)
00280                 access = (*(vp-&gt;findVar)) (cvp, requests-&gt;<a class="code" href=
"structnetsnmp__request__info__s.html#o0">requestvb</a>-&gt;<a class="code" href="structvariable__list.html#o1">name</a>,
00281                                            &amp;(requests-&gt;<a class="code" href=
"structnetsnmp__request__info__s.html#o0">requestvb</a>-&gt;
00282                                              name_length), exact, &amp;len,
00283                                            &amp;write_method);
00284             <span class="keywordflow">else</span>
00285                 access = NULL;
00286 
00287 <span class="preprocessor">#ifdef WWW_FIX</span>
00288             <span class="keywordflow">if</span> (IS_DELEGATED(cvp-&gt;type)) {
00289                 add_method = (AddVarMethod *) statP;
00290                 requests-&gt;delayed = 1;
00291                 have_delegated = 1;
00292                 <span class="keywordflow">continue</span>;       <span class=
"comment">/* WWW: This may not get to the right place */</span>
00293             }
00294 <span class="preprocessor">#endif</span>
00295 
00296             <span class="comment">/*</span>
00297 <span class="comment">             * WWW: end range checking </span>
00298 <span class="comment">             */</span>
00299             <span class="keywordflow">if</span> (access) {
00300                 <span class="comment">/*</span>
00301 <span class="comment">                 * result returned </span>
00302 <span class="comment">                 */</span>
00303                 <span class="keywordflow">if</span> (reqinfo-&gt;<a class="code" href=
"structnetsnmp__agent__request__info__s.html#o0">mode</a> != MODE_SET_RESERVE1)
00304                     <a class="code" href=
"group__snmp__client.html#ga19">snmp_set_var_typed_value</a>(requests-&gt;<a class="code" href=
"structnetsnmp__request__info__s.html#o0">requestvb</a>,
00305                                              cvp-&gt;<a class="code" href=
"structvariable__list.html#o3">type</a>, access, len);
00306             } <span class="keywordflow">else</span> {
00307                 <span class="comment">/*</span>
00308 <span class="comment">                 * no result returned </span>
00309 <span class="comment">                 */</span>
00310 <span class="preprocessor">#if MIB_CLIENTS_ARE_EVIL</span>
00311                 <span class="keywordflow">if</span> (access == NULL) {
00312                     <span class="keywordflow">if</span> (<a class="code" href=
"group__library.html#ga106">netsnmp_oid_equals</a>(requests-&gt;<a class="code" href=
"structnetsnmp__request__info__s.html#o0">requestvb</a>-&gt;<a class="code" href="structvariable__list.html#o1">name</a>,
00313                                          requests-&gt;<a class="code" href=
"structnetsnmp__request__info__s.html#o0">requestvb</a>-&gt;<a class="code" href="structvariable__list.html#o2">name_length</a>,
00314                                          save, savelen) != 0) {
00315                         DEBUGMSGTL((<span class="stringliteral">"old_api"</span>, <span class=
"stringliteral">"evil_client: %s\n"</span>,
00316                                     reginfo-&gt;<a class="code" href=
"structnetsnmp__handler__registration__s.html#o0">handlerName</a>));
00317                         memcpy(requests-&gt;<a class="code" href=
"structnetsnmp__request__info__s.html#o0">requestvb</a>-&gt;<a class="code" href="structvariable__list.html#o1">name</a>, save,
00318                                savelen * <span class="keyword">sizeof</span>(oid));
00319                         requests-&gt;<a class="code" href=
"structnetsnmp__request__info__s.html#o0">requestvb</a>-&gt;<a class="code" href=
"structvariable__list.html#o2">name_length</a> = savelen;
00320                     }
00321                 }
00322 <span class="preprocessor">#endif</span>
00323             }
00324 
00325             <span class="comment">/*</span>
00326 <span class="comment">             * AAA: fall through for everything that is a set (see BBB) </span>
00327 <span class="comment">             */</span>
00328             <span class="keywordflow">if</span> (reqinfo-&gt;<a class="code" href=
"structnetsnmp__agent__request__info__s.html#o0">mode</a> != MODE_SET_RESERVE1)
00329                 <span class="keywordflow">break</span>;
00330 
00331             cacheptr = <a class="code" href="group__util.html#ga39">SNMP_MALLOC_TYPEDEF</a>(netsnmp_old_api_cache);
00332             <span class="keywordflow">if</span> (!cacheptr)
00333                 <span class="keywordflow">return</span> <a class="code" href=
"group__snmp__agent.html#ga83">netsnmp_set_request_error</a>(reqinfo, requests,
00334                                                  SNMP_ERR_RESOURCEUNAVAILABLE);
00335             cacheptr-&gt;<a class="code" href="structvariable__list.html#o8">data</a> = access;
00336             cacheptr-&gt;write_method = write_method;
00337             write_method = NULL;
00338             <a class="code" href="group__handler.html#ga27">netsnmp_request_add_list_data</a>(requests,
00339                                           <a class="code" href="group__data__list.html#ga3">netsnmp_create_data_list</a>
00340                                           (OLD_API_NAME, cacheptr, free));
00341             <span class="comment">/*</span>
00342 <span class="comment">             * BBB: fall through for everything that is a set (see AAA) </span>
00343 <span class="comment">             */</span>
00344 
00345         <span class="keywordflow">default</span>:
00346             <span class="comment">/*</span>
00347 <span class="comment">             * WWW: explicitly list the SET conditions </span>
00348 <span class="comment">             */</span>
00349             <span class="comment">/*</span>
00350 <span class="comment">             * (the rest of the) SET contions </span>
00351 <span class="comment">             */</span>
00352             cacheptr =
00353                 (netsnmp_old_api_cache *)
00354                 <a class="code" href="group__handler.html#ga29">netsnmp_request_get_list_data</a>(requests, OLD_API_NAME);
00355 
00356             <span class="keywordflow">if</span> (cacheptr == NULL || cacheptr-&gt;write_method == NULL) {
00357                 <span class="comment">/*</span>
00358 <span class="comment">                 * WWW: try to set ourselves if possible? </span>
00359 <span class="comment">                 */</span>
00360                 <span class="keywordflow">return</span> <a class="code" href=
"group__snmp__agent.html#ga83">netsnmp_set_request_error</a>(reqinfo, requests,
00361                                                  SNMP_ERR_NOTWRITABLE);
00362             }
00363 
00364             oldasp = netsnmp_get_current_agent_session();
00365             set_current_agent_session(reqinfo-&gt;<a class="code" href=
"structnetsnmp__agent__request__info__s.html#o1">asp</a>);
00366             status =
00367                 (*(cacheptr-&gt;write_method)) (reqinfo-&gt;<a class="code" href=
"structnetsnmp__agent__request__info__s.html#o0">mode</a>,
00368                                              requests-&gt;<a class="code" href=
"structnetsnmp__request__info__s.html#o0">requestvb</a>-&gt;<a class="code" href="structvariable__list.html#o4">val</a>.
00369                                              string,
00370                                              requests-&gt;<a class="code" href=
"structnetsnmp__request__info__s.html#o0">requestvb</a>-&gt;<a class="code" href="structvariable__list.html#o3">type</a>,
00371                                              requests-&gt;<a class="code" href=
"structnetsnmp__request__info__s.html#o0">requestvb</a>-&gt;<a class="code" href="structvariable__list.html#o5">val_len</a>,
00372                                              cacheptr-&gt;<a class="code" href="structvariable__list.html#o8">data</a>,
00373                                              requests-&gt;<a class="code" href=
"structnetsnmp__request__info__s.html#o0">requestvb</a>-&gt;<a class="code" href="structvariable__list.html#o1">name</a>,
00374                                              requests-&gt;<a class="code" href=
"structnetsnmp__request__info__s.html#o0">requestvb</a>-&gt;
00375                                              name_length);
00376             set_current_agent_session(oldasp);
00377 
00378             <span class="keywordflow">if</span> (status != SNMP_ERR_NOERROR) {
00379                 <a class="code" href=
"group__snmp__agent.html#ga83">netsnmp_set_request_error</a>(reqinfo, requests, status);
00380             }
00381 
00382             <span class="comment">/*</span>
00383 <span class="comment">             * clean up is done by the automatic freeing of the</span>
00384 <span class="comment">             * cache stored in the request. </span>
00385 <span class="comment">             */</span>
00386 
00387             <span class="keywordflow">break</span>;
00388         }
00389     }
00390     <span class="keywordflow">return</span> SNMP_ERR_NOERROR;
00391 }
00392 
00395 <span class="comment">/*</span>
00396 <span class="comment"> * don't use this! </span>
00397 <span class="comment"> */</span>
00398 <span class="keyword">static</span> netsnmp_agent_session *current_agent_session = NULL;
00399 netsnmp_agent_session *
00400 netsnmp_get_current_agent_session()
00401 {
00402     <span class="keywordflow">return</span> current_agent_session;
00403 }
00404 
00405 <span class="comment">/*</span>
00406 <span class="comment"> * don't use this! </span>
00407 <span class="comment"> */</span>
00408 <span class="keywordtype">void</span>
00409 set_current_agent_session(netsnmp_agent_session *asp)
00410 {
00411     current_agent_session = asp;
00412 }
</pre>
  </div>
  <hr size="1" />

  <address style="align: right;">
    <small>Generated on Fri Dec 30 13:47:46 2005 for net-snmp by&nbsp; <a href="http://www.doxygen.org/index.html"><img src=
    "doxygen.png" alt="doxygen" align="middle" border="0" /></a> 1.3.9.1</small>
  </address>
<!-- CONTENT END -->
<!--#include virtual="/page-bottom.html" -->

