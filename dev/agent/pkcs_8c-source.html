<!--#set var="section" value="development" -->
<!--#include virtual="/page-top.html" -->
<!-- CONTENT START -->
  <div class="qindex">
    <a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="modules.html">Modules</a> | <a class=
    "qindex" href="annotated.html">Data&nbsp;Structures</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class=
    "qindex" href="functions.html">Data&nbsp;Fields</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a> | <a class=
    "qindex" href="examples.html">Examples</a>
  </div>

  <div class="nav">
    <a class="el" href="dir_000005.html">snmplib</a>
  </div>

  <h1>pkcs.c</h1>

  <div class="fragment">
    <pre class="fragment">
00001 <span class="comment">/*</span>
00002 <span class="comment"> * Copyright Copyright 2003 Sun Microsystems, Inc. All rights reserved.</span>
00003 <span class="comment"> * Use is subject to license terms specified in the COPYING file</span>
00004 <span class="comment"> * distributed with the Net-SNMP package.</span>
00005 <span class="comment"> */</span>
00006 
00007 <span class="comment">/*</span>
00008 <span class="comment"> * pkcs.c</span>
00009 <span class="comment"> */</span>
00010 
00011 <span class="preprocessor">#include &lt;net-snmp/net-snmp-config.h&gt;</span>
00012 <span class="preprocessor">#ifdef USE_PKCS</span>
00013 <span class="preprocessor">#include &lt;net-snmp/types.h&gt;</span>
00014 <span class="preprocessor">#include &lt;net-snmp/output_api.h&gt;</span>
00015 <span class="preprocessor">#include &lt;net-snmp/config_api.h&gt;</span>
00016 <span class="preprocessor">#include &lt;net-snmp/library/snmp_api.h&gt;</span>
00017 <span class="preprocessor">#include &lt;net-snmp/library/tools.h&gt;</span>
00018 <span class="preprocessor">#include &lt;net-snmp/library/keytools.h&gt;</span>
00019 <span class="preprocessor">#include &lt;net-snmp/library/scapi.h&gt;</span>
00020 <span class="preprocessor">#include &lt;net-snmp/library/callback.h&gt;</span>
00021 <span class="preprocessor">#include &lt;security/cryptoki.h&gt;</span>
00022 
00023 <span class="keyword">typedef</span> <span class="keyword">struct </span>netsnmp_pkcs_slot_session_s {
00024     CK_SLOT_ID        sid;
00025     CK_SESSION_HANDLE hdl;
00026 } netsnmp_pkcs_slot_session; 
00027 
00028 <span class="keyword">typedef</span> <span class="keyword">struct </span>netsnmp_pkcs_slot_info_s {
00029     <span class="keywordtype">int</span> count;
00030     netsnmp_pkcs_slot_session *pSession; 
00031 } netsnmp_pkcs_slot_info;
00032 
00033 <span class="keyword">static</span> CK_RV get_session_handle(CK_MECHANISM_TYPE, CK_FLAGS,\
00034                                 CK_SESSION_HANDLE_PTR);
00035 <span class="keyword">static</span> CK_RV get_slot_session_handle(netsnmp_pkcs_slot_session *,\
00036                                      CK_SESSION_HANDLE_PTR);
00037 <span class="keyword">static</span> <span class="keywordtype">char</span> *pkcserr_string(CK_RV);
00038 <span class="keyword">static</span> <span class="keywordtype">int</span> free_slots(<span class=
"keywordtype">int</span>, <span class="keywordtype">int</span>, <span class="keywordtype">void</span> *, <span class=
"keywordtype">void</span> *);
00039 
00040 <span class="keyword">static</span> netsnmp_pkcs_slot_info *pSlot = NULL;
00041 
00042 <span class="comment">/*</span>
00043 <span class="comment"> * initialize the Cryptoki library.</span>
00044 <span class="comment"> */</span>
00045 <span class="keywordtype">int</span>
00046 pkcs_init(<span class="keywordtype">void</span>)
00047 {
00048     CK_RV          rv;
00049     CK_ULONG       slotcount;
00050     CK_SLOT_ID_PTR pSlotList = NULL;
00051     netsnmp_pkcs_slot_session    *tmp;
00052     <span class="keywordtype">int</span>            i, rval = SNMPERR_SUCCESS;
00053     <span class="comment">/* Initialize pkcs */</span>
00054     <span class="keywordflow">if</span> ((rv = C_Initialize(NULL)) != CKR_OK) {
00055         DEBUGMSGTL((<span class="stringliteral">"pkcs_init"</span>, <span class=
"stringliteral">"C_Initialize failed: %s"</span>,
00056                 pkcserr_string(rv)));
00057         <span class="keywordflow">return</span> SNMPERR_SC_NOT_CONFIGURED;
00058     }
00059 
00060     <span class="comment">/* Get slot count */</span>
00061     rv = C_GetSlotList(1, NULL_PTR, &amp;slotcount);
00062     <span class="keywordflow">if</span> (rv != CKR_OK || slotcount == 0) {
00063         DEBUGMSGTL((<span class="stringliteral">"pkcs_init"</span>, <span class=
"stringliteral">"C_GetSlotList failed: %s"</span>, 
00064                 pkcserr_string(rv)));
00065         QUITFUN(SNMPERR_GENERR, pkcs_init_quit);
00066     }
00067 
00068     <span class="comment">/* Found at least one slot, allocate memory for slot list */</span>
00069     pSlotList = malloc(slotcount * <span class="keyword">sizeof</span> (CK_SLOT_ID));
00070     pSlot = malloc(<span class="keyword">sizeof</span> (netsnmp_pkcs_slot_info));
00071     pSlot-&gt;pSession = malloc(slotcount * <span class="keyword">sizeof</span> (netsnmp_pkcs_slot_session));
00072 
00073     <span class="keywordflow">if</span> (pSlotList == NULL_PTR ||
00074         pSlot == NULL_PTR ||
00075         pSlot-&gt;pSession == NULL_PTR) {
00076         DEBUGMSGTL((<span class="stringliteral">"pkcs_init"</span>,<span class="stringliteral">"malloc failed."</span>)); 
00077         QUITFUN(SNMPERR_GENERR, pkcs_init_quit);
00078     }
00079 
00080     <span class="comment">/* Get the list of slots */</span>
00081     <span class="keywordflow">if</span> ((rv = C_GetSlotList(1, pSlotList, &amp;slotcount)) != CKR_OK) {
00082         DEBUGMSGTL((<span class="stringliteral">"pkcs_init"</span>, <span class=
"stringliteral">"C_GetSlotList failed: %s"</span>, 
00083                 pkcserr_string(rv)));
00084         QUITFUN(SNMPERR_GENERR, pkcs_init_quit);
00085     }
00086 
00087     <span class="comment">/* initialize Slots structure */</span>
00088     pSlot-&gt;count = slotcount;
00089     <span class="keywordflow">for</span> (i = 0, tmp = pSlot-&gt;pSession; i &lt; slotcount; i++, tmp++) {
00090         tmp-&gt;sid = pSlotList[i]; 
00091         tmp-&gt;hdl = NULL;
00092     }
00093 
00094     <a class="code" href=
"group__callback.html#ga3">snmp_register_callback</a>(SNMP_CALLBACK_LIBRARY, SNMP_CALLBACK_SHUTDOWN,
00095                         free_slots, NULL);
00096 
00097   pkcs_init_quit:
00098     <a class="code" href="group__util.html#ga36">SNMP_FREE</a>(pSlotList);
00099     <span class="keywordflow">return</span> rval;
00100 }
00101 
00102 <span class="comment">/*</span>
00103 <span class="comment"> * close all the opened sessions when finished with Cryptoki library.</span>
00104 <span class="comment"> */</span>
00105 <span class="keyword">static</span> <span class="keywordtype">int</span>
00106 free_slots(<span class="keywordtype">int</span> majorID, <span class="keywordtype">int</span> minorID, <span class=
"keywordtype">void</span> *serverarg, <span class="keywordtype">void</span> *clientarg)
00107 {
00108     <span class="keywordtype">int</span>            slotcount, i;
00109 
00110     <span class="keywordflow">if</span> (pSlot != NULL) {
00111         slotcount = pSlot-&gt;count;
00112         <span class="keywordflow">for</span> (i = 0; i &lt; slotcount; i++) {
00113             <span class="keywordflow">if</span> (pSlot-&gt;pSession-&gt;hdl != NULL) {
00114                 free(pSlot-&gt;pSession-&gt;hdl);
00115             }
00116         }
00117         free(pSlot);
00118     }
00119 
00120     (void) C_Finalize(NULL);
00121     <span class="keywordflow">return</span> 0;
00122 }
00123 
00124 <span class="comment">/*</span>
00125 <span class="comment"> * generate random data</span>
00126 <span class="comment"> */</span>
00127 <span class="keywordtype">int</span>
00128 pkcs_random(u_char * buf, size_t buflen)
00129 {
00130     CK_SESSION_HANDLE hSession;
00131 
00132     <span class="keywordflow">if</span> (pSlot != NULL &amp;&amp;
00133         get_slot_session_handle(pSlot-&gt;pSession, &amp;hSession) == CKR_OK &amp;&amp;
00134         C_GenerateRandom(hSession, buf, buflen) == CKR_OK) {
00135         <span class="keywordflow">return</span> SNMPERR_SUCCESS;
00136     }
00137 
00138     <span class="keywordflow">return</span> SNMPERR_GENERR;
00139 }
00140 
00141 <span class="comment">/*</span>
00142 <span class="comment"> * retrieve the session handle from the first slot that supports the specified</span>
00143 <span class="comment"> * mechanism.</span>
00144 <span class="comment"> */</span>
00145 <span class="keyword">static</span> CK_RV
00146 get_session_handle(CK_MECHANISM_TYPE mech_type, CK_FLAGS flag,
00147                 CK_SESSION_HANDLE_PTR sess)
00148 {
00149     CK_RV             rv = CKR_OK;
00150     CK_MECHANISM_INFO info;
00151     netsnmp_pkcs_slot_session       *p = NULL;
00152     <span class="keywordtype">int</span>               i, slotcount = 0;
00153             
00154     <span class="keywordflow">if</span> (pSlot) {
00155         slotcount = pSlot-&gt;count;
00156         p = pSlot-&gt;pSession;
00157     }
00158 
00159     <span class="comment">/* Find a slot with matching mechanism */</span>
00160     <span class="keywordflow">for</span> (i = 0; i &lt; slotcount; i++, p++) {
00161         rv = C_GetMechanismInfo(p-&gt;sid, mech_type, &amp;info);
00162 
00163         <span class="keywordflow">if</span> (rv != CKR_OK) {
00164             <span class="keywordflow">continue</span>; <span class="comment">/* to the next slot */</span>
00165         } <span class="keywordflow">else</span> {
00166             <span class="keywordflow">if</span> (info.flags &amp; flag) {
00167                 rv = get_slot_session_handle(p, sess);
00168                 <span class="keywordflow">break</span>; <span class="comment">/* found */</span>
00169             }
00170         }
00171     }
00172 
00173     <span class="comment">/* Show error if no matching mechanism found */</span>
00174     <span class="keywordflow">if</span> (i == slotcount) {
00175         DEBUGMSGTL((<span class="stringliteral">"pkcs_init"</span>,<span class=
"stringliteral">"No cryptographic provider for %s"</span>,
00176                 mech_type)); 
00177         <span class="keywordflow">return</span> CKR_SESSION_HANDLE_INVALID;
00178     }
00179 
00180     <span class="keywordflow">return</span> rv;
00181 }
00182 
00183 <span class="comment">/*</span>
00184 <span class="comment"> * retrieve the session handle from the specified slot.</span>
00185 <span class="comment"> */</span>
00186 <span class="keyword">static</span> CK_RV
00187 get_slot_session_handle(netsnmp_pkcs_slot_session *p,
00188                         CK_SESSION_HANDLE_PTR sess)
00189 {
00190     CK_RV rv = CKR_OK;
00191     <span class="keywordflow">if</span> (p == NULL) {
00192         *sess = NULL;
00193         <span class="keywordflow">return</span> CKR_SESSION_HANDLE_INVALID;
00194     }
00195 
00196     <span class="keywordflow">if</span> (p-&gt;hdl == NULL) {
00197         <span class="comment">/* Open a session */</span>
00198         rv = C_OpenSession(p-&gt;sid, CKF_SERIAL_SESSION,
00199                 NULL_PTR, NULL, &amp;p-&gt;hdl);
00200 
00201         <span class="keywordflow">if</span> (rv != CKR_OK) {
00202             DEBUGMSGTL((<span class="stringliteral">"get_slot_session_handle"</span>,<span class=
"stringliteral">"can not open PKCS #11 session: %s"</span>,
00203                         pkcserr_string(rv)));
00204         }
00205     }
00206     *sess = p-&gt;hdl;
00207 
00208     <span class="keywordflow">return</span> rv;
00209 }
00210 
00211 <span class="comment">/*</span>
00212 <span class="comment"> * perform a signature operation to generate MAC.</span>
00213 <span class="comment"> */</span>
00214 <span class="keywordtype">int</span>
00215 pkcs_sign(CK_MECHANISM_TYPE mech_type, u_char * key, u_int keylen,
00216           u_char * msg, u_int msglen, u_char * mac, size_t * maclen)
00217 {
00218     <span class="comment">/*</span>
00219 <span class="comment">     * Key template </span>
00220 <span class="comment">     */</span>
00221     CK_OBJECT_CLASS <span class="keyword">class </span>= CKO_SECRET_KEY;
00222     CK_KEY_TYPE keytype = CKK_GENERIC_SECRET;
00223     CK_BBOOL truevalue = TRUE;
00224     CK_BBOOL falsevalue= FALSE;
00225     CK_ATTRIBUTE <span class="keyword">template</span>[] = {
00226         {CKA_CLASS, &amp;<span class="keyword">class</span>, <span class="keyword">sizeof</span> (<span class=
"keyword">class</span>)},
00227         {CKA_KEY_TYPE, &amp;keytype, <span class="keyword">sizeof</span> (keytype)},
00228         {CKA_SIGN, &amp;truevalue, <span class="keyword">sizeof</span> (truevalue)},
00229         {CKA_TOKEN, &amp;falsevalue, <span class="keyword">sizeof</span> (falsevalue)},
00230         {CKA_VALUE, key, keylen}
00231     };
00232     CK_SESSION_HANDLE hSession;
00233     CK_MECHANISM mech;
00234     CK_OBJECT_HANDLE hkey = (CK_OBJECT_HANDLE) 0;
00235     <span class="keywordtype">int</span>                rval = SNMPERR_SUCCESS;
00236     <span class="keywordflow">if</span> (get_session_handle(mech_type, CKF_SIGN, &amp;hSession) != CKR_OK ||
00237         hSession == NULL) {
00238         QUITFUN(SNMPERR_GENERR, pkcs_sign_quit);
00239     }
00240 
00241     <span class="comment">/* create a key object */</span>
00242     <span class="keywordflow">if</span> (C_CreateObject(hSession, <span class="keyword">template</span>,
00243         (<span class="keyword">sizeof</span> (<span class="keyword">template</span>) / <span class=
"keyword">sizeof</span> (CK_ATTRIBUTE)), &amp;hkey) != CKR_OK) {
00244         QUITFUN(SNMPERR_GENERR, pkcs_sign_quit);
00245     }
00246 
00247     mech.mechanism = mech_type;
00248     mech.pParameter = NULL_PTR;
00249     mech.ulParameterLen = 0;
00250 
00251     <span class="comment">/* initialize a signature operation */</span>
00252     <span class="keywordflow">if</span> (C_SignInit(hSession, &amp;mech, hkey) != CKR_OK ) {
00253         QUITFUN(SNMPERR_GENERR, pkcs_sign_quit);
00254     }
00255     <span class="comment">/* continue a multiple-part signature operation */</span>
00256     <span class="keywordflow">if</span> (C_SignUpdate(hSession, msg, msglen) != CKR_OK) {
00257         QUITFUN(SNMPERR_GENERR, pkcs_sign_quit);
00258     }
00259     <span class="comment">/* finish a multiple-part signature operation */</span>
00260     <span class="keywordflow">if</span> (C_SignFinal(hSession, mac, maclen) != CKR_OK) {
00261         QUITFUN(SNMPERR_GENERR, pkcs_sign_quit);
00262     }
00263 
00264   pkcs_sign_quit:
00265 
00266     <span class="keywordflow">if</span> (key != (CK_OBJECT_HANDLE) 0) {
00267         (void) C_DestroyObject(hSession, hkey);
00268     }
00269     <span class="keywordflow">return</span> rval;
00270 }
00271 
00272 <span class="comment">/*</span>
00273 <span class="comment"> * perform a message-digesting operation.</span>
00274 <span class="comment"> */</span>
00275 <span class="keywordtype">int</span>
00276 pkcs_digest(CK_MECHANISM_TYPE mech_type, u_char * msg, u_int msglen,
00277             u_char * digest, size_t * digestlen)
00278 {
00279     <span class="keywordtype">int</span>               rval = SNMPERR_SUCCESS;
00280     CK_SESSION_HANDLE hSession;
00281     CK_MECHANISM      mech;
00282     <span class="keywordflow">if</span> (get_session_handle(mech_type, CKF_DIGEST, &amp;hSession) != CKR_OK ||
00283         hSession == NULL) {
00284         QUITFUN(SNMPERR_GENERR, pkcs_digest_quit);
00285     }
00286 
00287     mech.mechanism = mech_type;
00288     mech.pParameter = NULL_PTR;
00289     mech.ulParameterLen = 0;
00290 
00291     <span class="comment">/* initialize a message-digesting operation */</span>
00292     <span class="keywordflow">if</span> (C_DigestInit(hSession, &amp;mech)!= CKR_OK ) {
00293         QUITFUN(SNMPERR_GENERR, pkcs_digest_quit);
00294     }
00295     <span class="comment">/* continue a multiple-part message-digesting operation */</span>
00296     <span class="keywordflow">if</span> (C_DigestUpdate(hSession, msg, msglen) != CKR_OK ) {
00297         QUITFUN(SNMPERR_GENERR, pkcs_digest_quit);
00298     }
00299     <span class="comment">/* finish a multiple-part message-digesting operation */</span>
00300     <span class="keywordflow">if</span> (C_DigestFinal(hSession, digest, digestlen) != CKR_OK) {
00301         QUITFUN(SNMPERR_GENERR, pkcs_digest_quit);
00302     }
00303 
00304   pkcs_digest_quit:
00305     <span class="keywordflow">return</span> rval;
00306 }
00307 
00308 <span class="comment">/*</span>
00309 <span class="comment"> * encrypt plaintext into ciphertext using key and iv.   </span>
00310 <span class="comment"> */</span>
00311 <span class="keywordtype">int</span>
00312 pkcs_encrpyt(CK_MECHANISM_TYPE mech_type, u_char * key, u_int keylen,
00313              u_char * iv, u_int ivlen,
00314              u_char * plaintext, u_int ptlen,
00315              u_char * ciphertext, size_t * ctlen)
00316 {
00317     <span class="keywordtype">int</span>                rval = SNMPERR_SUCCESS;
00318     <span class="keywordtype">int</span>                pad_size, offset;
00319     <span class="comment">/*</span>
00320 <span class="comment">     * Key template </span>
00321 <span class="comment">     */</span>
00322     CK_OBJECT_CLASS <span class="keyword">class </span>= CKO_SECRET_KEY;
00323     CK_KEY_TYPE keytype = CKK_DES;
00324     <span class="comment">/* CK_KEY_TYPE AESkeytype = CKK_AES; */</span>
00325     CK_BBOOL truevalue = TRUE;
00326     CK_BBOOL falsevalue = FALSE;
00327 
00328     CK_ATTRIBUTE <span class="keyword">template</span>[] = {
00329         {CKA_CLASS, &amp;<span class="keyword">class</span>, <span class="keyword">sizeof</span> (<span class=
"keyword">class</span>)},
00330         {CKA_KEY_TYPE, &amp;keytype, <span class="keyword">sizeof</span> (keytype)},
00331         {CKA_ENCRYPT, &amp;truevalue, <span class="keyword">sizeof</span> (truevalue)},
00332         {CKA_TOKEN, &amp;falsevalue, <span class="keyword">sizeof</span> (falsevalue)},
00333         {CKA_VALUE, key, keylen} 
00334     };
00335 
00336     CK_SESSION_HANDLE hSession;
00337     CK_MECHANISM mech;
00338     CK_OBJECT_HANDLE hkey = (CK_OBJECT_HANDLE) 0;
00339 
00340     <span class="keywordflow">if</span> (get_session_handle(mech_type, CKF_ENCRYPT,
00341                            &amp;hSession) != CKR_OK ||
00342         hSession == NULL) {
00343         QUITFUN(SNMPERR_GENERR, pkcs_encrypt_quit);
00344     }
00345 
00346     <span class="keywordflow">if</span> (C_CreateObject(hSession, <span class="keyword">template</span>,
00347         (<span class="keyword">sizeof</span> (<span class="keyword">template</span>) / <span class=
"keyword">sizeof</span> (CK_ATTRIBUTE)),
00348                                 &amp;hkey) != CKR_OK) {
00349         QUITFUN(SNMPERR_GENERR, pkcs_encrypt_quit);
00350     }
00351 
00352     mech.mechanism = mech_type;
00353     mech.pParameter = iv;
00354     mech.ulParameterLen = ivlen;
00355 
00356     <span class="comment">/* initialize an encryption operation */</span>
00357     <span class="keywordflow">if</span> (C_EncryptInit(hSession, &amp;mech, hkey) != CKR_OK ) {
00358         QUITFUN(SNMPERR_GENERR, pkcs_encrypt_quit);
00359     }
00360 
00361     <span class="comment">/* for DES */</span>
00362     pad_size = BYTESIZE(SNMP_TRANS_PRIVLEN_1DES);
00363 
00364     <span class="keywordflow">if</span> (ptlen + pad_size - ptlen % pad_size &gt; *ctlen) {
00365         QUITFUN(SNMPERR_GENERR, pkcs_encrypt_quit);    
00366     }
00367 
00368     <span class="keywordflow">for</span> (offset = 0; offset &lt; ptlen; offset += pad_size) {
00369         <span class="comment">/* continue a multiple-part encryption operation */</span>
00370         <span class="keywordflow">if</span> (C_EncryptUpdate(hSession, plaintext + offset, pad_size,
00371                             ciphertext + offset, ctlen) != CKR_OK) {
00372             QUITFUN(SNMPERR_GENERR, pkcs_encrypt_quit);
00373         }
00374     }
00375 
00376     <span class="comment">/* finish a multiple-part encryption operation */</span>
00377     <span class="keywordflow">if</span> (C_EncryptFinal(hSession, ciphertext + offset, ctlen) != CKR_OK) {
00378         QUITFUN(SNMPERR_GENERR, pkcs_encrypt_quit);
00379     }
00380     *ctlen = offset;
00381 
00382   pkcs_encrypt_quit:
00383     <span class="keywordflow">if</span> (key != (CK_OBJECT_HANDLE) 0) {
00384         (void) C_DestroyObject(hSession, hkey);
00385     }
00386     <span class="keywordflow">return</span> rval;
00387 }
00388 
00389 <span class="comment">/* </span>
00390 <span class="comment"> * decrypt ciphertext into plaintext using key and iv.</span>
00391 <span class="comment"> */</span>
00392 <span class="keywordtype">int</span>
00393 pkcs_decrpyt(CK_MECHANISM_TYPE mech_type, u_char * key, u_int keylen,
00394              u_char * iv, u_int ivlen,
00395              u_char * ciphertext, u_int ctlen,
00396              u_char * plaintext, size_t * ptlen)
00397 {
00398     <span class="keywordtype">int</span>            rval = SNMPERR_SUCCESS;
00399     <span class="comment">/*</span>
00400 <span class="comment">     * Key template </span>
00401 <span class="comment">     */</span>
00402     CK_OBJECT_CLASS <span class="keyword">class </span>= CKO_SECRET_KEY;
00403     CK_KEY_TYPE keytype = CKK_DES;
00404     <span class="comment">/* CK_KEY_TYPE AESkeytype = CKK_AES; */</span>
00405     CK_BBOOL truevalue = TRUE;
00406     CK_BBOOL falsevalue= FALSE;
00407     CK_ATTRIBUTE <span class="keyword">template</span>[] = {
00408         {CKA_CLASS, &amp;<span class="keyword">class</span>, <span class="keyword">sizeof</span> (<span class=
"keyword">class</span>)},
00409         {CKA_KEY_TYPE, &amp;keytype, <span class="keyword">sizeof</span> (keytype)},
00410         {CKA_DECRYPT, &amp;truevalue, <span class="keyword">sizeof</span> (truevalue)},
00411         {CKA_TOKEN, &amp;falsevalue, <span class="keyword">sizeof</span> (falsevalue)},
00412         {CKA_VALUE, key, keylen}
00413     };
00414     CK_SESSION_HANDLE hSession;
00415     CK_MECHANISM mech;
00416     CK_OBJECT_HANDLE hkey = (CK_OBJECT_HANDLE) 0;
00417 
00418     <span class="keywordflow">if</span> (get_session_handle(mech_type, CKF_DECRYPT, &amp;hSession) != CKR_OK ||
00419         hSession == NULL) {
00420         QUITFUN(SNMPERR_GENERR, pkcs_decrypt_quit);
00421     }
00422 
00423     <span class="keywordflow">if</span> (C_CreateObject(hSession, <span class="keyword">template</span>,
00424         (<span class="keyword">sizeof</span> (<span class="keyword">template</span>) / <span class=
"keyword">sizeof</span> (CK_ATTRIBUTE)), &amp;hkey) != CKR_OK) {
00425         QUITFUN(SNMPERR_GENERR, pkcs_decrypt_quit);
00426     }
00427 
00428     mech.mechanism = mech_type;
00429     mech.pParameter = iv;
00430     mech.ulParameterLen = ivlen;
00431 
00432     <span class="comment">/* initialize a decryption operation */</span>
00433     <span class="keywordflow">if</span> (C_DecryptInit(hSession, &amp;mech, hkey) != CKR_OK ) {
00434         QUITFUN(SNMPERR_GENERR, pkcs_decrypt_quit);
00435     }
00436     <span class="comment">/* continue a multiple-part decryption operation */</span>
00437     <span class="keywordflow">if</span> (C_DecryptUpdate(hSession, ciphertext, ctlen, plaintext,
00438                                         ptlen) != CKR_OK) {
00439         QUITFUN(SNMPERR_GENERR, pkcs_decrypt_quit);
00440     }
00441     <span class="comment">/* finish a multiple-part decryption operation */</span>
00442     <span class="keywordflow">if</span> (C_DecryptFinal(hSession, plaintext, ptlen) != CKR_OK) {
00443         QUITFUN(SNMPERR_GENERR, pkcs_decrypt_quit);
00444     }
00445 
00446   pkcs_decrypt_quit:
00447     <span class="keywordflow">if</span> (key != (CK_OBJECT_HANDLE) 0) {
00448         (void) C_DestroyObject(hSession, hkey);
00449     }
00450     <span class="keywordflow">return</span> rval;
00451 }
00452 
00453 <span class="comment">/*</span>
00454 <span class="comment"> * Convert a passphrase into a master user key, Ku, according to the</span>
00455 <span class="comment"> * algorithm given in RFC 2274 concerning the SNMPv3 User Security Model (USM)</span>
00456 <span class="comment"> */</span>
00457 <span class="keywordtype">int</span>
00458 pkcs_generate_Ku(CK_MECHANISM_TYPE mech_type, u_char * passphrase, u_int pplen,
00459                  u_char * Ku, size_t * kulen)
00460 {
00461     <span class="keywordtype">int</span>                rval = SNMPERR_SUCCESS, nbytes = USM_LENGTH_EXPANDED_PASSPHRASE;
00462     CK_SESSION_HANDLE hSession;
00463     CK_MECHANISM mech;
00464     u_int        i, pindex = 0;
00465     u_char        buf[USM_LENGTH_KU_HASHBLOCK], *bufp;
00466 
00467     <span class="keywordflow">if</span> (get_session_handle(mech_type, CKF_DIGEST, &amp;hSession) != CKR_OK ||
00468         hSession == NULL) {
00469         QUITFUN(SNMPERR_GENERR, pkcs_generate_Ku_quit);
00470     }
00471 
00472     mech.mechanism = mech_type;
00473     mech.pParameter = NULL_PTR;
00474     mech.ulParameterLen = 0;
00475 
00476     <span class="comment">/* initialize a message-digesting operation */</span>
00477     <span class="keywordflow">if</span> (C_DigestInit(hSession, &amp;mech)!= CKR_OK ) {
00478         QUITFUN(SNMPERR_GENERR, pkcs_generate_Ku_quit);
00479     }
00480 
00481     <span class="keywordflow">while</span> (nbytes &gt; 0) {
00482         bufp = buf;
00483         <span class="keywordflow">for</span> (i = 0; i &lt; USM_LENGTH_KU_HASHBLOCK; i++) {
00484            <span class="comment">/*</span>
00485 <span class="comment">            * fill a buffer with the supplied passphrase.  When the end</span>
00486 <span class="comment">            * of the passphrase is reachedcycle back to the beginning.</span>
00487 <span class="comment">            */</span>
00488             *bufp++ = passphrase[pindex++ % pplen];
00489         }
00490         <span class="comment">/* continue a multiple-part message-digesting operation */</span>
00491         <span class="keywordflow">if</span> (C_DigestUpdate(hSession, buf, USM_LENGTH_KU_HASHBLOCK) != CKR_OK ) {
00492             QUITFUN(SNMPERR_GENERR, pkcs_generate_Ku_quit);
00493         }
00494         nbytes -= USM_LENGTH_KU_HASHBLOCK;
00495     }
00496     <span class="comment">/* finish a multiple-part message-digesting operation */</span>
00497     <span class="keywordflow">if</span> (C_DigestFinal(hSession, Ku, kulen) != CKR_OK) {
00498         QUITFUN(SNMPERR_GENERR, pkcs_generate_Ku_quit);
00499     }
00500 
00501   pkcs_generate_Ku_quit:
00502     <span class="keywordflow">return</span> rval;
00503 }
00504    
00505 <span class="comment">/*</span>
00506 <span class="comment"> * pkcserr_stringor: returns a string representation of the given </span>
00507 <span class="comment"> * return code.</span>
00508 <span class="comment"> */</span>
00509 <span class="keyword">static</span> <span class="keywordtype">char</span> *
00510 pkcserr_string(CK_RV rv)
00511 {
00512     <span class="keyword">static</span> <span class="keywordtype">char</span> errstr[128];
00513     <span class="keywordflow">switch</span> (rv) {
00514     <span class="keywordflow">case</span> CKR_OK:
00515         <span class="keywordflow">return</span> (<span class="stringliteral">"CKR_OK"</span>);
00516         <span class="keywordflow">break</span>;
00517     <span class="keywordflow">case</span> CKR_CANCEL:
00518         <span class="keywordflow">return</span> (<span class="stringliteral">"CKR_CANCEL"</span>);
00519         <span class="keywordflow">break</span>;
00520     <span class="keywordflow">case</span> CKR_HOST_MEMORY:
00521         <span class="keywordflow">return</span> (<span class="stringliteral">"CKR_HOST_MEMORY"</span>);
00522         <span class="keywordflow">break</span>;
00523     <span class="keywordflow">case</span> CKR_SLOT_ID_INVALID:
00524         <span class="keywordflow">return</span> (<span class="stringliteral">"CKR_SLOT_ID_INVALID"</span>);
00525         <span class="keywordflow">break</span>;
00526     <span class="keywordflow">case</span> CKR_GENERAL_ERROR:
00527         <span class="keywordflow">return</span> (<span class="stringliteral">"CKR_GENERAL_ERROR"</span>);
00528         <span class="keywordflow">break</span>;
00529     <span class="keywordflow">case</span> CKR_FUNCTION_FAILED:
00530         <span class="keywordflow">return</span> (<span class="stringliteral">"CKR_FUNCTION_FAILED"</span>);
00531         <span class="keywordflow">break</span>;
00532     <span class="keywordflow">case</span> CKR_ARGUMENTS_BAD:
00533         <span class="keywordflow">return</span> (<span class="stringliteral">"CKR_ARGUMENTS_BAD"</span>);
00534         <span class="keywordflow">break</span>;
00535     <span class="keywordflow">case</span> CKR_NO_EVENT:
00536         <span class="keywordflow">return</span> (<span class="stringliteral">"CKR_NO_EVENT"</span>);
00537         <span class="keywordflow">break</span>;
00538     <span class="keywordflow">case</span> CKR_NEED_TO_CREATE_THREADS:
00539         <span class="keywordflow">return</span> (<span class="stringliteral">"CKR_NEED_TO_CREATE_THREADS"</span>);
00540         <span class="keywordflow">break</span>;
00541     <span class="keywordflow">case</span> CKR_CANT_LOCK:
00542         <span class="keywordflow">return</span> (<span class="stringliteral">"CKR_CANT_LOCK"</span>);
00543         <span class="keywordflow">break</span>;
00544     <span class="keywordflow">case</span> CKR_ATTRIBUTE_READ_ONLY:
00545         <span class="keywordflow">return</span> (<span class="stringliteral">"CKR_ATTRIBUTE_READ_ONLY"</span>);
00546         <span class="keywordflow">break</span>;
00547     <span class="keywordflow">case</span> CKR_ATTRIBUTE_SENSITIVE:
00548         <span class="keywordflow">return</span> (<span class="stringliteral">"CKR_ATTRIBUTE_SENSITIVE"</span>);
00549         <span class="keywordflow">break</span>;
00550     <span class="keywordflow">case</span> CKR_ATTRIBUTE_TYPE_INVALID:
00551         <span class="keywordflow">return</span> (<span class="stringliteral">"CKR_ATTRIBUTE_TYPE_INVALID"</span>);
00552         <span class="keywordflow">break</span>;
00553     <span class="keywordflow">case</span> CKR_ATTRIBUTE_VALUE_INVALID:
00554         <span class="keywordflow">return</span> (<span class="stringliteral">"CKR_ATTRIBUTE_VALUE_INVALID"</span>);
00555         <span class="keywordflow">break</span>;
00556     <span class="keywordflow">case</span> CKR_DATA_INVALID:
00557         <span class="keywordflow">return</span> (<span class="stringliteral">"CKR_DATA_INVALID"</span>);
00558         <span class="keywordflow">break</span>;
00559     <span class="keywordflow">case</span> CKR_DATA_LEN_RANGE:
00560         <span class="keywordflow">return</span> (<span class="stringliteral">"CKR_DATA_LEN_RANGE"</span>);
00561         <span class="keywordflow">break</span>;
00562     <span class="keywordflow">case</span> CKR_DEVICE_ERROR:
00563         <span class="keywordflow">return</span> (<span class="stringliteral">"CKR_DEVICE_ERROR"</span>);
00564         <span class="keywordflow">break</span>;
00565     <span class="keywordflow">case</span> CKR_DEVICE_MEMORY:
00566         <span class="keywordflow">return</span> (<span class="stringliteral">"CKR_DEVICE_MEMORY"</span>);
00567         <span class="keywordflow">break</span>;
00568     <span class="keywordflow">case</span> CKR_DEVICE_REMOVED:
00569         <span class="keywordflow">return</span> (<span class="stringliteral">"CKR_DEVICE_REMOVED"</span>);
00570         <span class="keywordflow">break</span>;
00571     <span class="keywordflow">case</span> CKR_ENCRYPTED_DATA_INVALID:
00572         <span class="keywordflow">return</span> (<span class="stringliteral">"CKR_ENCRYPTED_DATA_INVALID"</span>);
00573         <span class="keywordflow">break</span>;
00574     <span class="keywordflow">case</span> CKR_ENCRYPTED_DATA_LEN_RANGE:
00575         <span class="keywordflow">return</span> (<span class="stringliteral">"CKR_ENCRYPTED_DATA_LEN_RANGE"</span>);
00576         <span class="keywordflow">break</span>;
00577     <span class="keywordflow">case</span> CKR_FUNCTION_CANCELED:
00578         <span class="keywordflow">return</span> (<span class="stringliteral">"CKR_FUNCTION_CANCELED"</span>);
00579         <span class="keywordflow">break</span>;
00580     <span class="keywordflow">case</span> CKR_FUNCTION_NOT_PARALLEL:
00581         <span class="keywordflow">return</span> (<span class="stringliteral">"CKR_FUNCTION_NOT_PARALLEL"</span>);
00582         <span class="keywordflow">break</span>;
00583     <span class="keywordflow">case</span> CKR_FUNCTION_NOT_SUPPORTED:
00584         <span class="keywordflow">return</span> (<span class="stringliteral">"CKR_FUNCTION_NOT_SUPPORTED"</span>);
00585         <span class="keywordflow">break</span>;
00586     <span class="keywordflow">case</span> CKR_KEY_HANDLE_INVALID:
00587         <span class="keywordflow">return</span> (<span class="stringliteral">"CKR_KEY_HANDLE_INVALID"</span>);
00588         <span class="keywordflow">break</span>;
00589     <span class="keywordflow">case</span> CKR_KEY_SIZE_RANGE:
00590         <span class="keywordflow">return</span> (<span class="stringliteral">"CKR_KEY_SIZE_RANGE"</span>);
00591         <span class="keywordflow">break</span>;
00592     <span class="keywordflow">case</span> CKR_KEY_TYPE_INCONSISTENT:
00593         <span class="keywordflow">return</span> (<span class="stringliteral">"CKR_KEY_TYPE_INCONSISTENT"</span>);
00594         <span class="keywordflow">break</span>;
00595     <span class="keywordflow">case</span> CKR_KEY_NOT_NEEDED:
00596         <span class="keywordflow">return</span> (<span class="stringliteral">"CKR_KEY_NOT_NEEDED"</span>);
00597         <span class="keywordflow">break</span>;
00598     <span class="keywordflow">case</span> CKR_KEY_CHANGED:
00599         <span class="keywordflow">return</span> (<span class="stringliteral">"CKR_KEY_CHANGED"</span>);
00600         <span class="keywordflow">break</span>;
00601     <span class="keywordflow">case</span> CKR_KEY_NEEDED:
00602         <span class="keywordflow">return</span> (<span class="stringliteral">"CKR_KEY_NEEDED"</span>);
00603         <span class="keywordflow">break</span>;
00604     <span class="keywordflow">case</span> CKR_KEY_INDIGESTIBLE:
00605         <span class="keywordflow">return</span> (<span class="stringliteral">"CKR_KEY_INDIGESTIBLE"</span>);
00606         <span class="keywordflow">break</span>;
00607     <span class="keywordflow">case</span> CKR_KEY_FUNCTION_NOT_PERMITTED:
00608         <span class="keywordflow">return</span> (<span class="stringliteral">"CKR_KEY_FUNCTION_NOT_PERMITTED"</span>);
00609         <span class="keywordflow">break</span>;
00610     <span class="keywordflow">case</span> CKR_KEY_NOT_WRAPPABLE:
00611         <span class="keywordflow">return</span> (<span class="stringliteral">"CKR_KEY_NOT_WRAPPABLE"</span>);
00612         <span class="keywordflow">break</span>;
00613     <span class="keywordflow">case</span> CKR_KEY_UNEXTRACTABLE:
00614         <span class="keywordflow">return</span> (<span class="stringliteral">"CKR_KEY_UNEXTRACTABLE"</span>);
00615         <span class="keywordflow">break</span>;
00616     <span class="keywordflow">case</span> CKR_MECHANISM_INVALID:
00617         <span class="keywordflow">return</span> (<span class="stringliteral">"CKR_MECHANISM_INVALID"</span>);
00618         <span class="keywordflow">break</span>;
00619     <span class="keywordflow">case</span> CKR_MECHANISM_PARAM_INVALID:
00620         <span class="keywordflow">return</span> (<span class="stringliteral">"CKR_MECHANISM_PARAM_INVALID"</span>);
00621         <span class="keywordflow">break</span>;
00622     <span class="keywordflow">case</span> CKR_OBJECT_HANDLE_INVALID:
00623         <span class="keywordflow">return</span> (<span class="stringliteral">"CKR_OBJECT_HANDLE_INVALID"</span>);
00624         <span class="keywordflow">break</span>;
00625     <span class="keywordflow">case</span> CKR_OPERATION_ACTIVE:
00626         <span class="keywordflow">return</span> (<span class="stringliteral">"CKR_OPERATION_ACTIVE"</span>);
00627         <span class="keywordflow">break</span>;
00628     <span class="keywordflow">case</span> CKR_OPERATION_NOT_INITIALIZED:
00629         <span class="keywordflow">return</span> (<span class="stringliteral">"CKR_OPERATION_NOT_INITIALIZED"</span>);
00630         <span class="keywordflow">break</span>;
00631     <span class="keywordflow">case</span> CKR_PIN_INCORRECT:
00632         <span class="keywordflow">return</span> (<span class="stringliteral">"CKR_PIN_INCORRECT"</span>);
00633         <span class="keywordflow">break</span>;
00634     <span class="keywordflow">case</span> CKR_PIN_INVALID:
00635         <span class="keywordflow">return</span> (<span class="stringliteral">"CKR_PIN_INVALID"</span>);
00636         <span class="keywordflow">break</span>;
00637     <span class="keywordflow">case</span> CKR_PIN_LEN_RANGE:
00638         <span class="keywordflow">return</span> (<span class="stringliteral">"CKR_PIN_LEN_RANGE"</span>);
00639         <span class="keywordflow">break</span>;
00640     <span class="keywordflow">case</span> CKR_PIN_EXPIRED:
00641         <span class="keywordflow">return</span> (<span class="stringliteral">"CKR_PIN_EXPIRED"</span>);
00642         <span class="keywordflow">break</span>;
00643     <span class="keywordflow">case</span> CKR_PIN_LOCKED:
00644         <span class="keywordflow">return</span> (<span class="stringliteral">"CKR_PIN_LOCKED"</span>);
00645         <span class="keywordflow">break</span>;
00646     <span class="keywordflow">case</span> CKR_SESSION_CLOSED:
00647         <span class="keywordflow">return</span> (<span class="stringliteral">"CKR_SESSION_CLOSED"</span>);
00648         <span class="keywordflow">break</span>;
00649     <span class="keywordflow">case</span> CKR_SESSION_COUNT:
00650         <span class="keywordflow">return</span> (<span class="stringliteral">"CKR_SESSION_COUNT"</span>);
00651         <span class="keywordflow">break</span>;
00652     <span class="keywordflow">case</span> CKR_SESSION_HANDLE_INVALID:
00653         <span class="keywordflow">return</span> (<span class="stringliteral">"CKR_SESSION_HANDLE_INVALID"</span>);
00654         <span class="keywordflow">break</span>;
00655     <span class="keywordflow">case</span> CKR_SESSION_PARALLEL_NOT_SUPPORTED:
00656         <span class="keywordflow">return</span> (<span class="stringliteral">"CKR_SESSION_PARALLEL_NOT_SUPPORTED"</span>);
00657         <span class="keywordflow">break</span>;
00658     <span class="keywordflow">case</span> CKR_SESSION_READ_ONLY:
00659         <span class="keywordflow">return</span> (<span class="stringliteral">"CKR_SESSION_READ_ONLY"</span>);
00660         <span class="keywordflow">break</span>;
00661     <span class="keywordflow">case</span> CKR_SESSION_EXISTS:
00662         <span class="keywordflow">return</span> (<span class="stringliteral">"CKR_SESSION_EXISTS"</span>);
00663         <span class="keywordflow">break</span>;
00664     <span class="keywordflow">case</span> CKR_SESSION_READ_ONLY_EXISTS:
00665         <span class="keywordflow">return</span> (<span class="stringliteral">"CKR_SESSION_READ_ONLY_EXISTS"</span>);
00666         <span class="keywordflow">break</span>;
00667     <span class="keywordflow">case</span> CKR_SESSION_READ_WRITE_SO_EXISTS:
00668         <span class="keywordflow">return</span> (<span class="stringliteral">"CKR_SESSION_READ_WRITE_SO_EXISTS"</span>);
00669         <span class="keywordflow">break</span>;
00670     <span class="keywordflow">case</span> CKR_SIGNATURE_INVALID:
00671         <span class="keywordflow">return</span> (<span class="stringliteral">"CKR_SIGNATURE_INVALID"</span>);
00672         <span class="keywordflow">break</span>;
00673     <span class="keywordflow">case</span> CKR_SIGNATURE_LEN_RANGE:
00674         <span class="keywordflow">return</span> (<span class="stringliteral">"CKR_SIGNATURE_LEN_RANGE"</span>);
00675         <span class="keywordflow">break</span>;
00676     <span class="keywordflow">case</span> CKR_TEMPLATE_INCOMPLETE:
00677         <span class="keywordflow">return</span> (<span class="stringliteral">"CKR_TEMPLATE_INCOMPLETE"</span>);
00678         <span class="keywordflow">break</span>;
00679     <span class="keywordflow">case</span> CKR_TEMPLATE_INCONSISTENT:
00680         <span class="keywordflow">return</span> (<span class="stringliteral">"CKR_TEMPLATE_INCONSISTENT"</span>);
00681         <span class="keywordflow">break</span>;
00682     <span class="keywordflow">case</span> CKR_TOKEN_NOT_PRESENT:
00683         <span class="keywordflow">return</span> (<span class="stringliteral">"CKR_TOKEN_NOT_PRESENT"</span>);
00684         <span class="keywordflow">break</span>;
00685     <span class="keywordflow">case</span> CKR_TOKEN_NOT_RECOGNIZED:
00686         <span class="keywordflow">return</span> (<span class="stringliteral">"CKR_TOKEN_NOT_RECOGNIZED"</span>);
00687         <span class="keywordflow">break</span>;
00688     <span class="keywordflow">case</span> CKR_TOKEN_WRITE_PROTECTED:
00689         <span class="keywordflow">return</span> (<span class="stringliteral">"CKR_TOKEN_WRITE_PROTECTED"</span>);
00690         <span class="keywordflow">break</span>;
00691     <span class="keywordflow">case</span> CKR_UNWRAPPING_KEY_HANDLE_INVALID:
00692         <span class="keywordflow">return</span> (<span class="stringliteral">"CKR_UNWRAPPING_KEY_HANDLE_INVALID"</span>);
00693         <span class="keywordflow">break</span>;
00694     <span class="keywordflow">case</span> CKR_UNWRAPPING_KEY_SIZE_RANGE:
00695         <span class="keywordflow">return</span> (<span class="stringliteral">"CKR_UNWRAPPING_KEY_SIZE_RANGE"</span>);
00696         <span class="keywordflow">break</span>;
00697     <span class="keywordflow">case</span> CKR_UNWRAPPING_KEY_TYPE_INCONSISTENT:
00698         <span class="keywordflow">return</span> (<span class=
"stringliteral">"CKR_UNWRAPPING_KEY_TYPE_INCONSISTENT"</span>);
00699         <span class="keywordflow">break</span>;
00700     <span class="keywordflow">case</span> CKR_USER_ALREADY_LOGGED_IN:
00701         <span class="keywordflow">return</span> (<span class="stringliteral">"CKR_USER_ALREADY_LOGGED_IN"</span>);
00702         <span class="keywordflow">break</span>;
00703     <span class="keywordflow">case</span> CKR_USER_NOT_LOGGED_IN:
00704         <span class="keywordflow">return</span> (<span class="stringliteral">"CKR_USER_NOT_LOGGED_IN"</span>);
00705         <span class="keywordflow">break</span>;
00706     <span class="keywordflow">case</span> CKR_USER_PIN_NOT_INITIALIZED:
00707         <span class="keywordflow">return</span> (<span class="stringliteral">"CKR_USER_PIN_NOT_INITIALIZED"</span>);
00708         <span class="keywordflow">break</span>;
00709     <span class="keywordflow">case</span> CKR_USER_TYPE_INVALID:
00710         <span class="keywordflow">return</span> (<span class="stringliteral">"CKR_USER_TYPE_INVALID"</span>);
00711         <span class="keywordflow">break</span>;
00712     <span class="keywordflow">case</span> CKR_USER_ANOTHER_ALREADY_LOGGED_IN:
00713         <span class="keywordflow">return</span> (<span class="stringliteral">"CKR_USER_ANOTHER_ALREADY_LOGGED_IN"</span>);
00714         <span class="keywordflow">break</span>;
00715     <span class="keywordflow">case</span> CKR_USER_TOO_MANY_TYPES:
00716         <span class="keywordflow">return</span> (<span class="stringliteral">"CKR_USER_TOO_MANY_TYPES"</span>);
00717         <span class="keywordflow">break</span>;
00718     <span class="keywordflow">case</span> CKR_WRAPPED_KEY_INVALID:
00719         <span class="keywordflow">return</span> (<span class="stringliteral">"CKR_WRAPPED_KEY_INVALID"</span>);
00720         <span class="keywordflow">break</span>;
00721     <span class="keywordflow">case</span> CKR_WRAPPED_KEY_LEN_RANGE:
00722         <span class="keywordflow">return</span> (<span class="stringliteral">"CKR_WRAPPED_KEY_LEN_RANGE"</span>);
00723         <span class="keywordflow">break</span>;
00724     <span class="keywordflow">case</span> CKR_WRAPPING_KEY_HANDLE_INVALID:
00725         <span class="keywordflow">return</span> (<span class="stringliteral">"CKR_WRAPPING_KEY_HANDLE_INVALID"</span>);
00726         <span class="keywordflow">break</span>;
00727     <span class="keywordflow">case</span> CKR_WRAPPING_KEY_SIZE_RANGE:
00728         <span class="keywordflow">return</span> (<span class="stringliteral">"CKR_WRAPPING_KEY_SIZE_RANGE"</span>);
00729         <span class="keywordflow">break</span>;
00730     <span class="keywordflow">case</span> CKR_WRAPPING_KEY_TYPE_INCONSISTENT:
00731         <span class="keywordflow">return</span> (<span class="stringliteral">"CKR_WRAPPING_KEY_TYPE_INCONSISTENT"</span>);
00732         <span class="keywordflow">break</span>;
00733     <span class="keywordflow">case</span> CKR_RANDOM_SEED_NOT_SUPPORTED:
00734         <span class="keywordflow">return</span> (<span class="stringliteral">"CKR_RANDOM_SEED_NOT_SUPPORTED"</span>);
00735         <span class="keywordflow">break</span>;
00736     <span class="keywordflow">case</span> CKR_RANDOM_NO_RNG:
00737         <span class="keywordflow">return</span> (<span class="stringliteral">"CKR_RANDOM_NO_RNG"</span>);
00738         <span class="keywordflow">break</span>;
00739     <span class="keywordflow">case</span> CKR_DOMAIN_PARAMS_INVALID:
00740         <span class="keywordflow">return</span> (<span class="stringliteral">"CKR_DOMAIN_PARAMS_INVALID"</span>);
00741         <span class="keywordflow">break</span>;
00742     <span class="keywordflow">case</span> CKR_BUFFER_TOO_SMALL:
00743         <span class="keywordflow">return</span> (<span class="stringliteral">"CKR_BUFFER_TOO_SMALL"</span>);
00744         <span class="keywordflow">break</span>;
00745     <span class="keywordflow">case</span> CKR_SAVED_STATE_INVALID:
00746         <span class="keywordflow">return</span> (<span class="stringliteral">"CKR_SAVED_STATE_INVALID"</span>);
00747         <span class="keywordflow">break</span>;
00748     <span class="keywordflow">case</span> CKR_INFORMATION_SENSITIVE:
00749         <span class="keywordflow">return</span> (<span class="stringliteral">"CKR_INFORMATION_SENSITIVE"</span>);
00750         <span class="keywordflow">break</span>;
00751     <span class="keywordflow">case</span> CKR_STATE_UNSAVEABLE:
00752         <span class="keywordflow">return</span> (<span class="stringliteral">"CKR_STATE_UNSAVEABLE"</span>);
00753         <span class="keywordflow">break</span>;
00754     <span class="keywordflow">case</span> CKR_CRYPTOKI_NOT_INITIALIZED:
00755         <span class="keywordflow">return</span> (<span class="stringliteral">"CKR_CRYPTOKI_NOT_INITIALIZED"</span>);
00756         <span class="keywordflow">break</span>;
00757     <span class="keywordflow">case</span> CKR_CRYPTOKI_ALREADY_INITIALIZED:
00758         <span class="keywordflow">return</span> (<span class="stringliteral">"CKR_CRYPTOKI_ALREADY_INITIALIZED"</span>);
00759         <span class="keywordflow">break</span>;
00760     <span class="keywordflow">case</span> CKR_MUTEX_BAD:
00761         <span class="keywordflow">return</span> (<span class="stringliteral">"CKR_MUTEX_BAD"</span>);
00762         <span class="keywordflow">break</span>;
00763     <span class="keywordflow">case</span> CKR_MUTEX_NOT_LOCKED:
00764         <span class="keywordflow">return</span> (<span class="stringliteral">"CKR_MUTEX_NOT_LOCKED"</span>);
00765         <span class="keywordflow">break</span>;
00766     <span class="keywordflow">case</span> CKR_VENDOR_DEFINED:
00767         <span class="keywordflow">return</span> (<span class="stringliteral">"CKR_VENDOR_DEFINED"</span>);
00768         <span class="keywordflow">break</span>;
00769     <span class="keywordflow">default</span>:
00770         <span class="comment">/* rv not found */</span>
00771         snprintf(errstr, <span class="keyword">sizeof</span> (errstr),
00772             <span class="stringliteral">"Unknown return code: 0x%x"</span>, rv);
00773         <span class="keywordflow">return</span> (errstr);
00774         <span class="keywordflow">break</span>;
00775     }
00776 }
00777 <span class="preprocessor">#endif</span>
</pre>
  </div>
  <hr size="1" />

  <address style="align: right;">
    <small><!--#include virtual="/sfbutton.html" --><br />
    Generated on Thu Oct 28 21:46:58 2004 for net-snmp by&nbsp; <a href="http://www.doxygen.org/index.html"><img src=
    "doxygen.png" alt="doxygen" align="middle" border="0" /></a> 1.3.9.1</small>
<!-- CONTENT END -->
<!--#include virtual="/page-bottom.html" -->

