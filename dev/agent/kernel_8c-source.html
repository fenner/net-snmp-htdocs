<!--#set var="section" value="development" -->
<!--#include virtual="/page-top.html" -->
<!-- CONTENT START -->
  <!-- Generated by Doxygen 1.3.9.1 -->

  <div class="qindex">
    <a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="modules.html">Modules</a> | <a class=
    "qindex" href="annotated.html">Data&nbsp;Structures</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class=
    "qindex" href="functions.html">Data&nbsp;Fields</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a> | <a class=
    "qindex" href="examples.html">Examples</a>
  </div>

  <div class="nav">
    <a class="el" href="dir_000003.html">agent</a>
  </div>

  <h1>kernel.c</h1>

  <div class="fragment">
    <pre class="fragment">
00001 
00002 <span class="comment">/*</span>
00003 <span class="comment"> *  13 Jun 91  wsak (wk0x@andrew) added mips support</span>
00004 <span class="comment"> */</span>
00005 
00006 <span class="preprocessor">#include &lt;net-snmp/net-snmp-config.h&gt;</span>
00007 
00008 <span class="preprocessor">#ifdef CAN_USE_NLIST</span>
00009 
00010 <span class="preprocessor">#include &lt;sys/types.h&gt;</span>
00011 <span class="preprocessor">#if HAVE_STDLIB_H</span>
00012 <span class="preprocessor">#include &lt;stdlib.h&gt;</span>
00013 <span class="preprocessor">#endif</span>
00014 <span class="preprocessor">#if HAVE_UNISTD_H</span>
00015 <span class="preprocessor">#include &lt;unistd.h&gt;</span>
00016 <span class="preprocessor">#endif</span>
00017 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
00018 <span class="preprocessor">#include &lt;errno.h&gt;</span>
00019 <span class="preprocessor">#if HAVE_STRING_H</span>
00020 <span class="preprocessor">#include &lt;string.h&gt;</span>
00021 <span class="preprocessor">#endif</span>
00022 <span class="preprocessor">#if HAVE_FCNTL_H</span>
00023 <span class="preprocessor">#include &lt;fcntl.h&gt;</span>
00024 <span class="preprocessor">#endif</span>
00025 <span class="preprocessor">#if HAVE_NETINET_IN_H</span>
00026 <span class="preprocessor">#include &lt;netinet/in.h&gt;</span>
00027 <span class="preprocessor">#endif</span>
00028 <span class="preprocessor">#if HAVE_KVM_H</span>
00029 <span class="preprocessor">#include &lt;kvm.h&gt;</span>
00030 <span class="preprocessor">#endif</span>
00031 
00032 <span class="preprocessor">#include &lt;net-snmp/net-snmp-includes.h&gt;</span>
00033 
00034 <span class="preprocessor">#include "kernel.h"</span>
00035 <span class="preprocessor">#include &lt;net-snmp/agent/ds_agent.h&gt;</span>
00036 
00037 <span class="preprocessor">#ifndef NULL</span>
00038 <span class="preprocessor">#define NULL 0</span>
00039 <span class="preprocessor">#endif</span>
00040 
00041 
00042 <span class="preprocessor">#if HAVE_KVM_H</span>
00043 kvm_t          *kd;
00044 
00045 <span class="keywordtype">void</span>
00046 init_kmem(<span class="keyword">const</span> <span class="keywordtype">char</span> *file)
00047 {
00048 <span class="preprocessor">#if HAVE_KVM_OPENFILES</span>
00049     <span class="keywordtype">char</span>            err[4096];
00050     kd = kvm_openfiles(NULL, NULL, NULL, O_RDONLY, err);
00051     <span class="keywordflow">if</span> (kd == NULL &amp;&amp; !netsnmp_ds_get_boolean(NETSNMP_DS_APPLICATION_ID, 
00052                                            NETSNMP_DS_AGENT_NO_ROOT_ACCESS)) {
00053         <a class="code" href="group__snmp__logging.html#ga39">snmp_log</a>(LOG_CRIT, <span class=
"stringliteral">"init_kmem: kvm_openfiles failed: %s\n"</span>, err);
00054         exit(1);
00055     }
00056 <span class="preprocessor">#else</span>
00057     kd = kvm_open(NULL, NULL, NULL, O_RDONLY, NULL);
00058     <span class="keywordflow">if</span> (!kd &amp;&amp; !netsnmp_ds_get_boolean(NETSNMP_DS_APPLICATION_ID, 
00059                                        NETSNMP_DS_AGENT_NO_ROOT_ACCESS)) {
00060         <a class="code" href="group__snmp__logging.html#ga39">snmp_log</a>(LOG_CRIT, <span class=
"stringliteral">"init_kmem: kvm_open failed: %s\n"</span>,
00061                  strerror(errno));
00062         exit(1);
00063     }
00064 <span class="preprocessor">#endif                          </span><span class="comment">/* HAVE_KVM_OPENFILES */</span>
00065 }
00066 
00067 
00068 <span class="comment">/*</span>
00069 <span class="comment"> *  klookup:</span>
00070 <span class="comment"> *</span>
00071 <span class="comment"> *  It seeks to the location  off  in kmem</span>
00072 <span class="comment"> *  It does a read into  target  of  siz  bytes.</span>
00073 <span class="comment"> *</span>
00074 <span class="comment"> *  Return 0 on failure and 1 on sucess.</span>
00075 <span class="comment"> *</span>
00076 <span class="comment"> */</span>
00077 
00078 
00079 <span class="keywordtype">int</span>
00080 klookup(<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> off, <span class=
"keywordtype">char</span> *target, <span class="keywordtype">int</span> siz)
00081 {
00082     <span class="keywordtype">int</span>             result;
00083     <span class="keywordflow">if</span> (kd == NULL)
00084         <span class="keywordflow">return</span> 0;
00085     result = kvm_read(kd, off, target, siz);
00086     <span class="keywordflow">if</span> (result != siz) {
00087 <span class="preprocessor">#if HAVE_KVM_OPENFILES</span>
00088         <a class="code" href="group__snmp__logging.html#ga39">snmp_log</a>(LOG_ERR, <span class=
"stringliteral">"kvm_read(*, %lx, %p, %d) = %d: %s\n"</span>, off,
00089                  target, siz, result, kvm_geterr(kd));
00090 <span class="preprocessor">#else</span>
00091         <a class="code" href="group__snmp__logging.html#ga39">snmp_log</a>(LOG_ERR, <span class=
"stringliteral">"kvm_read(*, %lx, %p, %d) = %d: "</span>, off, target,
00092                  siz, result);
00093         snmp_log_perror(<span class="stringliteral">"klookup"</span>);
00094 <span class="preprocessor">#endif</span>
00095         <span class="keywordflow">return</span> 0;
00096     }
00097     <span class="keywordflow">return</span> 1;
00098 }
00099 
00100 <span class="preprocessor">#else                           </span><span class="comment">/* HAVE_KVM_H */</span>
00101 
00102 <span class="keyword">static</span> off_t    klseek(off_t);
00103 <span class="keyword">static</span> <span class="keywordtype">int</span>      klread(<span class=
"keywordtype">char</span> *, <span class="keywordtype">int</span>);
00104 <span class="keywordtype">int</span>             swap, mem, kmem;
00105 
00106 <span class="keywordtype">void</span>
00107 init_kmem(<span class="keyword">const</span> <span class="keywordtype">char</span> *file)
00108 {
00109     kmem = open(file, O_RDONLY);
00110     <span class="keywordflow">if</span> (kmem &lt; 0 &amp;&amp; !netsnmp_ds_get_boolean(NETSNMP_DS_APPLICATION_ID, 
00111                                             NETSNMP_DS_AGENT_NO_ROOT_ACCESS)) {
00112         snmp_log_perror(file);
00113         exit(1);
00114     }
00115     fcntl(kmem, F_SETFD, 1);
00116     mem = open(<span class="stringliteral">"/dev/mem"</span>, O_RDONLY);
00117     <span class="keywordflow">if</span> (mem &lt; 0 &amp;&amp; !netsnmp_ds_get_boolean(NETSNMP_DS_APPLICATION_ID, 
00118                                            NETSNMP_DS_AGENT_NO_ROOT_ACCESS)) {
00119         snmp_log_perror(<span class="stringliteral">"/dev/mem"</span>);
00120         exit(1);
00121     }
00122     fcntl(mem, F_SETFD, 1);
00123 <span class="preprocessor">#ifdef DMEM_LOC</span>
00124     swap = open(DMEM_LOC, O_RDONLY);
00125     <span class="keywordflow">if</span> (swap &lt; 0 &amp;&amp; !netsnmp_ds_get_boolean(NETSNMP_DS_APPLICATION_ID, 
00126                                             NETSNMP_DS_AGENT_NO_ROOT_ACCESS)) {
00127         snmp_log_perror(DMEM_LOC);
00128         exit(1);
00129     }
00130     fcntl(swap, F_SETFD, 1);
00131 <span class="preprocessor">#endif</span>
00132 }
00133 
00134 
00135 <span class="comment">/*</span>
00136 <span class="comment"> *  Seek into the kernel for a value.</span>
00137 <span class="comment"> */</span>
00138 <span class="keyword">static</span>          off_t
00139 klseek(off_t base)
00140 {
00141     <span class="keywordflow">return</span> (lseek(kmem, (off_t) base, SEEK_SET));
00142 }
00143 
00144 
00145 <span class="comment">/*</span>
00146 <span class="comment"> *  Read from the kernel </span>
00147 <span class="comment"> */</span>
00148 <span class="keyword">static</span> <span class="keywordtype">int</span>
00149 klread(<span class="keywordtype">char</span> *buf, <span class="keywordtype">int</span> buflen)
00150 {
00151     <span class="keywordflow">return</span> (read(kmem, buf, buflen));
00152 }
00153 
00154 
00155 <span class="comment">/*</span>
00156 <span class="comment"> *  klookup:</span>
00157 <span class="comment"> *</span>
00158 <span class="comment"> *  It seeks to the location  off  in kmem</span>
00159 <span class="comment"> *  It does a read into  target  of  siz  bytes.</span>
00160 <span class="comment"> *</span>
00161 <span class="comment"> *  Return 0 on failure and 1 on sucess.</span>
00162 <span class="comment"> *</span>
00163 <span class="comment"> */</span>
00164 
00165 
00166 <span class="keywordtype">int</span>
00167 klookup(<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> off, <span class=
"keywordtype">char</span> *target, <span class="keywordtype">int</span> siz)
00168 {
00169     <span class="keywordtype">long</span>            retsiz;
00170 
00171     <span class="keywordflow">if</span> (kmem &lt; 0)
00172         <span class="keywordflow">return</span> 0;
00173 
00174     <span class="keywordflow">if</span> ((retsiz = klseek((off_t) off)) != off) {
00175         <a class="code" href="group__snmp__logging.html#ga39">snmp_log</a>(LOG_ERR, <span class=
"stringliteral">"klookup(%lx, %p, %d): "</span>, off, target, siz);
00176         snmp_log_perror(<span class="stringliteral">"klseek"</span>);
00177 <span class="preprocessor">#ifdef EXIT_ON_BAD_KLREAD</span>
00178         exit(1);
00179 <span class="preprocessor">#endif</span>
00180         <span class="keywordflow">return</span> (0);
00181     }
00182     <span class="keywordflow">if</span> ((retsiz = klread(target, siz)) != siz) {
00183         <span class="keywordflow">if</span> (snmp_get_do_debugging()) {
00184             <span class="comment">/*</span>
00185 <span class="comment">             * these happen too often on too many architectures to print them</span>
00186 <span class="comment">             * unless we're in debugging mode. People get very full log files. </span>
00187 <span class="comment">             */</span>
00188             <a class="code" href="group__snmp__logging.html#ga39">snmp_log</a>(LOG_ERR, <span class=
"stringliteral">"klookup(%lx, %p, %d): "</span>, off, target, siz);
00189             snmp_log_perror(<span class="stringliteral">"klread"</span>);
00190         }
00191 <span class="preprocessor">#ifdef EXIT_ON_BAD_KLREAD</span>
00192         exit(1);
00193 <span class="preprocessor">#endif</span>
00194         <span class="keywordflow">return</span> (0);
00195     }
00196     <span class="keywordflow">return</span> (1);
00197 }
00198 
00199 <span class="preprocessor">#endif                          </span><span class="comment">/* HAVE_KVM_H */</span>
00200 
00201 <span class="preprocessor">#endif                          </span><span class="comment">/* CAN_USE_NLIST */</span>
</pre>
  </div>
  <hr size="1" />

  <address style="align: right;">
    <small><!--#include virtual="/sfbutton.html" --><br />
    Generated on Thu Nov 25 17:51:37 2004 for net-snmp by&nbsp; <a href="http://www.doxygen.org/index.html"><img src=
    "doxygen.png" alt="doxygen" align="middle" border="0" /></a> 1.3.9.1</small>
  </address>
<!-- CONTENT END -->
<!--#include virtual="/page-bottom.html" -->

