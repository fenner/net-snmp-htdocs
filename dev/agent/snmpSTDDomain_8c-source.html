<!--#set var="section" value="development" -->
<!--#include virtual="/page-top.html" -->
<!-- CONTENT START -->
  <!-- Generated by Doxygen 1.3.9.1 -->

  <div class="qindex">
    <a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="modules.html">Modules</a> | <a class=
    "qindex" href="annotated.html">Data&nbsp;Structures</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class=
    "qindex" href="functions.html">Data&nbsp;Fields</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a> | <a class=
    "qindex" href="examples.html">Examples</a>
  </div>

  <div class="nav">
    <a class="el" href="dir_000005.html">snmplib</a>
  </div>

  <h1>snmpSTDDomain.c</h1>

  <div class="fragment">
    <pre class="fragment">
00001 <span class="preprocessor">#include &lt;net-snmp/net-snmp-config.h&gt;</span>
00002 
00003 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
00004 <span class="preprocessor">#include &lt;sys/types.h&gt;</span>
00005 <span class="preprocessor">#include &lt;signal.h&gt;</span>
00006 <span class="preprocessor">#include &lt;errno.h&gt;</span>
00007 
00008 <span class="preprocessor">#if HAVE_STRING_H</span>
00009 <span class="preprocessor">#include &lt;string.h&gt;</span>
00010 <span class="preprocessor">#else</span>
00011 <span class="preprocessor">#include &lt;strings.h&gt;</span>
00012 <span class="preprocessor">#endif</span>
00013 <span class="preprocessor">#if HAVE_STDLIB_H</span>
00014 <span class="preprocessor">#include &lt;stdlib.h&gt;</span>
00015 <span class="preprocessor">#endif</span>
00016 <span class="preprocessor">#if HAVE_UNISTD_H</span>
00017 <span class="preprocessor">#include &lt;unistd.h&gt;</span>
00018 <span class="preprocessor">#endif</span>
00019 
00020 <span class="preprocessor">#if HAVE_DMALLOC_H</span>
00021 <span class="preprocessor">#include &lt;dmalloc.h&gt;</span>
00022 <span class="preprocessor">#endif</span>
00023 
00024 <span class="preprocessor">#include &lt;net-snmp/types.h&gt;</span>
00025 <span class="preprocessor">#include &lt;net-snmp/output_api.h&gt;</span>
00026 
00027 <span class="preprocessor">#include &lt;net-snmp/library/snmp_transport.h&gt;</span>
00028 <span class="preprocessor">#include &lt;net-snmp/library/snmpSTDDomain.h&gt;</span>
00029 <span class="preprocessor">#include &lt;net-snmp/library/tools.h&gt;</span>
00030 
00031 oid netsnmp_snmpSTDDomain[] = { TRANSPORT_DOMAIN_STD_IP };
00032 <span class="keyword">static</span> netsnmp_tdomain stdDomain;
00033 
00034 <span class="comment">/*</span>
00035 <span class="comment"> * Return a string representing the address in data, or else the "far end"</span>
00036 <span class="comment"> * address if data is NULL.  </span>
00037 <span class="comment"> */</span>
00038 
00039 <span class="keyword">static</span> <span class="keywordtype">char</span> *
00040 netsnmp_std_fmtaddr(netsnmp_transport *t, <span class="keywordtype">void</span> *data, <span class=
"keywordtype">int</span> len)
00041 {
00042     <span class="keywordtype">char</span> *buf;
00043     DEBUGMSGTL((<span class="stringliteral">"domain:std"</span>,<span class=
"stringliteral">"formatting addr.  data=%x\n"</span>,t-&gt;data));
00044     <span class="keywordflow">if</span> (t-&gt;data) {
00045         netsnmp_std_data *data = t-&gt;data;
00046         buf = malloc(SNMP_MAXBUF_MEDIUM);
00047         <span class="keywordflow">if</span> (!buf)
00048             <span class="keywordflow">return</span> strdup(<span class="stringliteral">"STDInOut"</span>);
00049         snprintf(buf, SNMP_MAXBUF_MEDIUM, <span class="stringliteral">"STD:%s"</span>, data-&gt;prog);
00050         DEBUGMSGTL((<span class="stringliteral">"domain:std"</span>,<span class=
"stringliteral">"  formatted:=%s\n"</span>,buf));
00051         <span class="keywordflow">return</span> buf;
00052     }
00053     <span class="keywordflow">return</span> strdup(<span class="stringliteral">"STDInOut"</span>);
00054 }
00055 
00056 
00057 
00058 <span class="comment">/*</span>
00059 <span class="comment"> * You can write something into opaque that will subsequently get passed back </span>
00060 <span class="comment"> * to your send function if you like.  For instance, you might want to</span>
00061 <span class="comment"> * remember where a PDU came from, so that you can send a reply there...  </span>
00062 <span class="comment"> */</span>
00063 
00064 <span class="keyword">static</span> <span class="keywordtype">int</span>
00065 netsnmp_std_recv(netsnmp_transport *t, <span class="keywordtype">void</span> *buf, <span class=
"keywordtype">int</span> size,
00066                  <span class="keywordtype">void</span> **opaque, <span class="keywordtype">int</span> *olength)
00067 {
00068     <span class="keywordtype">int</span> rc = -1;
00069 
00070     DEBUGMSGTL((<span class="stringliteral">"domain:std"</span>,<span class=
"stringliteral">"recv on sock %d.  data=%x\n"</span>,t-&gt;sock, t-&gt;data));
00071     <span class="keywordflow">while</span> (rc &lt; 0) {
00072         rc = read(t-&gt;sock, buf, size);
00073         DEBUGMSGTL((<span class="stringliteral">"domain:std"</span>,<span class=
"stringliteral">"  bytes: %d.\n"</span>, rc));
00074         <span class="keywordflow">if</span> (rc &lt; 0 &amp;&amp; errno != EINTR) {
00075             DEBUGMSGTL((<span class="stringliteral">"netsnmp_std"</span>, <span class=
"stringliteral">" read on fd %d failed: %d (\"%s\")\n"</span>,
00076                         t-&gt;sock, errno, strerror(errno)));
00077             <span class="keywordflow">break</span>;
00078         }
00079         <span class="keywordflow">if</span> (rc == 0) {
00080             <span class="comment">/* 0 input is probably bad since we selected on it */</span>
00081             <span class="keywordflow">return</span> -1;
00082         }
00083         DEBUGMSGTL((<span class="stringliteral">"netsnmp_std"</span>, <span class=
"stringliteral">"read on stdin got %d bytes\n"</span>, rc));
00084     }
00085 
00086     <span class="keywordflow">return</span> rc;
00087 }
00088 
00089 
00090 
00091 <span class="keyword">static</span> <span class="keywordtype">int</span>
00092 netsnmp_std_send(netsnmp_transport *t, <span class="keywordtype">void</span> *buf, <span class=
"keywordtype">int</span> size,
00093                  <span class="keywordtype">void</span> **opaque, <span class="keywordtype">int</span> *olength)
00094 {
00095     <span class="keywordtype">int</span> rc = -1;
00096 
00097     DEBUGMSGTL((<span class="stringliteral">"domain:std"</span>,<span class=
"stringliteral">"send on sock.  data=%x\n"</span>, t-&gt;data));
00098     <span class="keywordflow">while</span> (rc &lt; 0) {
00099         <span class="keywordflow">if</span> (t-&gt;data) {
00100             netsnmp_std_data *data = t-&gt;data;
00101             rc = write(data-&gt;outfd, buf, size);
00102         } <span class="keywordflow">else</span> {
00103             <span class="comment">/* straight to stdout */</span>
00104             rc = write(1, buf, size);
00105         }
00106         <span class="keywordflow">if</span> (rc &lt; 0 &amp;&amp; errno != EINTR) {
00107             <span class="keywordflow">break</span>;
00108         }
00109     }
00110     <span class="keywordflow">return</span> rc;
00111 }
00112 
00113 <span class="keyword">static</span> <span class="keywordtype">int</span>
00114 netsnmp_std_close(netsnmp_transport *t)
00115 {
00116     DEBUGMSGTL((<span class="stringliteral">"domain:std"</span>,<span class=
"stringliteral">"close.  data=%x\n"</span>, t-&gt;data));
00117     <span class="keywordflow">if</span> (t-&gt;data) {
00118         netsnmp_std_data *data = t-&gt;data;
00119         close(data-&gt;outfd);
00120         close(t-&gt;sock);
00121 
00122         <span class="comment">/* kill the child too */</span>
00123         DEBUGMSGTL((<span class="stringliteral">"domain:std"</span>,<span class=
"stringliteral">" killing %d\n"</span>, data-&gt;childpid));
00124         kill(data-&gt;childpid, SIGTERM);
00125         sleep(1);
00126         kill(data-&gt;childpid, SIGKILL);
00127         <span class="comment">/* XXX: set an alarm to kill harder the child */</span>
00128     } <span class="keywordflow">else</span> {
00129         <span class="comment">/* close stdout/in */</span>
00130         close(1);
00131         close(0);
00132     }
00133     <span class="keywordflow">return</span> 0;
00134 }
00135 
00136 
00137 
00138 <span class="keyword">static</span> <span class="keywordtype">int</span>
00139 netsnmp_std_accept(netsnmp_transport *t)
00140 {
00141     DEBUGMSGTL((<span class="stringliteral">"domain:std"</span>,<span class=
"stringliteral">" accept data=%x\n"</span>, t-&gt;data));
00142     <span class="comment">/* nothing to do here */</span>
00143     <span class="keywordflow">return</span> 0;
00144 }
00145 
00146 <span class="comment">/*</span>
00147 <span class="comment"> * Open a STDIN/STDOUT -based transport for SNMP.</span>
00148 <span class="comment"> */</span>
00149 
00150 netsnmp_transport *
00151 netsnmp_std_transport(<span class="keyword">const</span> <span class=
"keywordtype">char</span> *instring, size_t instring_len)
00152 {
00153     netsnmp_transport *t;
00154 
00155     t = (netsnmp_transport *) malloc(<span class="keyword">sizeof</span>(netsnmp_transport));
00156     <span class="keywordflow">if</span> (t == NULL) {
00157         <span class="keywordflow">return</span> NULL;
00158     }
00159     memset(t, 0, <span class="keyword">sizeof</span>(netsnmp_transport));
00160 
00161     t-&gt;domain = netsnmp_snmpSTDDomain;
00162     t-&gt;domain_length =
00163         <span class="keyword">sizeof</span>(netsnmp_snmpSTDDomain) / <span class=
"keyword">sizeof</span>(netsnmp_snmpSTDDomain[0]);
00164 
00165     t-&gt;sock = 0;
00166     t-&gt;flags = NETSNMP_TRANSPORT_FLAG_STREAM | NETSNMP_TRANSPORT_FLAG_TUNNELED;
00167 
00168     <span class="comment">/*</span>
00169 <span class="comment">     * Message size is not limited by this transport (hence msgMaxSize</span>
00170 <span class="comment">     * is equal to the maximum legal size of an SNMP message).  </span>
00171 <span class="comment">     */</span>
00172 
00173     t-&gt;msgMaxSize = 0x7fffffff;
00174     t-&gt;f_recv     = netsnmp_std_recv;
00175     t-&gt;f_send     = netsnmp_std_send;
00176     t-&gt;f_close    = netsnmp_std_close;
00177     t-&gt;f_accept   = netsnmp_std_accept;
00178     t-&gt;f_fmtaddr  = netsnmp_std_fmtaddr;
00179 
00180     <span class="comment">/*</span>
00181 <span class="comment">     * if instring is not null length, it specifies a path to a prog</span>
00182 <span class="comment">     * XXX: plus args</span>
00183 <span class="comment">     */</span>
00184     <span class="keywordflow">if</span> (instring_len != 0) {
00185         <span class="keywordtype">int</span> infd[2], outfd[2];  <span class=
"comment">/* sockets to and from the client */</span>
00186         <span class="keywordtype">int</span> childpid;
00187 
00188         <span class="keywordflow">if</span> (pipe(infd) || pipe(outfd)) {
00189             <a class="code" href="group__snmp__logging.html#ga41">snmp_log</a>(LOG_ERR,
00190                      <span class="stringliteral">"Failed to create needed pipes for a STD transport"</span>);
00191             netsnmp_transport_free(t);
00192             <span class="keywordflow">return</span> NULL;
00193         }
00194 
00195         childpid = fork();
00196         <span class="comment">/* parentpid =&gt; childpid */</span>
00197         <span class="comment">/* infd[1]   =&gt; infd[0] */</span>
00198         <span class="comment">/* outfd[0]  &lt;= outfd[1] */</span>
00199 
00200         <span class="keywordflow">if</span> (childpid) {
00201             netsnmp_std_data *data;
00202             
00203             <span class="comment">/* we're in the parent */</span>
00204             close(infd[0]);
00205             close(outfd[1]);
00206 
00207             data = <a class="code" href="group__util.html#ga39">SNMP_MALLOC_TYPEDEF</a>(netsnmp_std_data);
00208             <span class="keywordflow">if</span> (!data) {
00209                 <a class="code" href="group__snmp__logging.html#ga41">snmp_log</a>(LOG_ERR, <span class=
"stringliteral">"snmpSTDDomain: memdup failed"</span>);
00210                 netsnmp_transport_free(t);
00211                 <span class="keywordflow">return</span> NULL;
00212             }
00213             t-&gt;data = data;
00214             t-&gt;data_length = <span class="keyword">sizeof</span>(netsnmp_transport_free);
00215             t-&gt;sock = outfd[0];
00216             data-&gt;prog = strdup(instring);
00217             data-&gt;outfd = infd[1];
00218             data-&gt;childpid = childpid;
00219             DEBUGMSGTL((<span class="stringliteral">"domain:std"</span>,<span class=
"stringliteral">"parent.  data=%x\n"</span>, t-&gt;data));
00220         } <span class="keywordflow">else</span> {
00221             <span class="comment">/* we're in the child */</span>
00222 
00223             <span class="comment">/* close stdin */</span>
00224             close(0);
00225             <span class="comment">/* copy pipe output to stdout */</span>
00226             dup(infd[0]);
00227 
00228             <span class="comment">/* close stdout */</span>
00229             close(1);
00230             <span class="comment">/* copy pipe output to stdin */</span>
00231             dup(outfd[1]);
00232             
00233             <span class="comment">/* close all the pipes themselves */</span>
00234             close(infd[0]);
00235             close(infd[1]);
00236             close(outfd[0]);
00237             close(outfd[1]);
00238 
00239             <span class="comment">/* call exec */</span>
00240             system(instring);
00241             <span class="comment">/* XXX: TODO: use exec form instead; needs args */</span>
00242             <span class="comment">/* execv(instring, NULL); */</span>
00243             exit(0);
00244 
00245             <span class="comment">/* ack...  we should never ever get here */</span>
00246             <a class="code" href="group__snmp__logging.html#ga41">snmp_log</a>(LOG_ERR, <span class=
"stringliteral">"STD transport returned after execv()\n"</span>);
00247         }
00248     }            
00249 
00250     <span class="keywordflow">return</span> t;
00251 }
00252 
00253 netsnmp_transport *
00254 netsnmp_std_create_tstring(<span class="keyword">const</span> <span class="keywordtype">char</span> *instring, <span class=
"keywordtype">int</span> local)
00255 {
00256     <span class="keywordflow">return</span> netsnmp_std_transport(instring, strlen(instring));
00257 }
00258 
00259 netsnmp_transport *
00260 netsnmp_std_create_ostring(<span class="keyword">const</span> u_char * o, size_t o_len, <span class=
"keywordtype">int</span> local)
00261 {
00262     <span class="keywordflow">return</span> netsnmp_std_transport(o, o_len);
00263 }
00264 
00265 <span class="keywordtype">void</span>
00266 netsnmp_std_ctor(<span class="keywordtype">void</span>)
00267 {
00268     stdDomain.name = netsnmp_snmpSTDDomain;
00269     stdDomain.name_length = <span class="keyword">sizeof</span>(netsnmp_snmpSTDDomain) / <span class=
"keyword">sizeof</span>(oid);
00270     stdDomain.prefix = calloc(2, <span class="keyword">sizeof</span>(<span class="keywordtype">char</span> *));
00271     stdDomain.prefix[0] = <span class="stringliteral">"std"</span>;
00272 
00273     stdDomain.f_create_from_tstring = netsnmp_std_create_tstring;
00274     stdDomain.f_create_from_ostring = netsnmp_std_create_ostring;
00275 
00276     netsnmp_tdomain_register(&amp;stdDomain);
00277 }
</pre>
  </div>
  <hr size="1" />

  <address style="align: right;">
    <small>Generated on Fri Dec 30 13:47:49 2005 for net-snmp by&nbsp; <a href="http://www.doxygen.org/index.html"><img src=
    "doxygen.png" alt="doxygen" align="middle" border="0" /></a> 1.3.9.1</small>
  </address>
<!-- CONTENT END -->
<!--#include virtual="/page-bottom.html" -->

