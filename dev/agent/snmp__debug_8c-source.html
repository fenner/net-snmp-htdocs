<!--#set var="section" value="development" -->
<!--#include virtual="/page-top.html" -->
<!-- CONTENT START -->
  <!-- Generated by Doxygen 1.3.9.1 -->

  <div class="qindex">
    <a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="modules.html">Modules</a> | <a class=
    "qindex" href="annotated.html">Data&nbsp;Structures</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class=
    "qindex" href="functions.html">Data&nbsp;Fields</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a> | <a class=
    "qindex" href="examples.html">Examples</a>
  </div>

  <div class="nav">
    <a class="el" href="dir_000005.html">snmplib</a>
  </div>

  <h1>snmp_debug.c</h1>

  <div class="fragment">
    <pre class="fragment">
00001 <span class="preprocessor">#include &lt;net-snmp/net-snmp-config.h&gt;</span>
00002 
00003 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
00004 <span class="preprocessor">#if HAVE_STDLIB_H</span>
00005 <span class="preprocessor">#include &lt;stdlib.h&gt;</span>
00006 <span class="preprocessor">#endif</span>
00007 <span class="preprocessor">#if HAVE_STRING_H</span>
00008 <span class="preprocessor">#include &lt;string.h&gt;</span>
00009 <span class="preprocessor">#else</span>
00010 <span class="preprocessor">#include &lt;strings.h&gt;</span>
00011 <span class="preprocessor">#endif</span>
00012 <span class="preprocessor">#include &lt;sys/types.h&gt;</span>
00013 <span class="preprocessor">#if HAVE_NETINET_IN_H</span>
00014 <span class="preprocessor">#include &lt;netinet/in.h&gt;</span>
00015 <span class="preprocessor">#endif</span>
00016 <span class="preprocessor">#if HAVE_STDARG_H</span>
00017 <span class="preprocessor">#include &lt;stdarg.h&gt;</span>
00018 <span class="preprocessor">#else</span>
00019 <span class="preprocessor">#include &lt;varargs.h&gt;</span>
00020 <span class="preprocessor">#endif</span>
00021 <span class="preprocessor">#if HAVE_WINSOCK_H</span>
00022 <span class="preprocessor">#include &lt;winsock.h&gt;</span>
00023 <span class="preprocessor">#endif</span>
00024 
00025 <span class="preprocessor">#if HAVE_DMALLOC_H</span>
00026 <span class="preprocessor">#include &lt;dmalloc.h&gt;</span>
00027 <span class="preprocessor">#endif</span>
00028 
00029 <span class="preprocessor">#include &lt;net-snmp/types.h&gt;</span>
00030 <span class="preprocessor">#include &lt;net-snmp/output_api.h&gt;</span>
00031 <span class="preprocessor">#include &lt;net-snmp/library/snmp_debug.h&gt;</span>        <span class=
"comment">/* For this file's "internal" definitions */</span>
00032 <span class="preprocessor">#include &lt;net-snmp/config_api.h&gt;</span>
00033 <span class="preprocessor">#include &lt;net-snmp/utilities.h&gt;</span>
00034 
00035 <span class="preprocessor">#include &lt;net-snmp/library/mib.h&gt;</span>
00036 <span class="preprocessor">#include &lt;net-snmp/library/snmp_api.h&gt;</span>
00037 
00038 <span class="preprocessor">#define SNMP_DEBUG_DISABLED           0</span>
00039 <span class="preprocessor">#define SNMP_DEBUG_ACTIVE             1</span>
00040 <span class="preprocessor">#define SNMP_DEBUG_EXCLUDED           2</span>
00041 
00042 <span class="keyword">static</span> <span class="keywordtype">int</span>      dodebug = SNMP_ALWAYS_DEBUG;
00043 <span class="keywordtype">int</span>             debug_num_tokens = 0;
00044 <span class="keywordtype">int</span>             debug_num_excluded = 0;
00045 <span class="keyword">static</span> <span class="keywordtype">int</span>      debug_print_everything = 0;
00046 
00047 netsnmp_token_descr dbg_tokens[MAX_DEBUG_TOKENS];
00048 
00049 <span class="preprocessor">#ifdef NETSNMP_DEBUG_STATS</span>
00050 netsnmp_container  *dbg_stats = NULL;
00051  <span class="keyword">static</span> <span class="keywordtype">int</span> _debug_cmp( <span class=
"keyword">const</span> <span class="keywordtype">void</span> *lhs, <span class="keyword">const</span> <span class=
"keywordtype">void</span> *rhs );
00052  <span class="keyword">static</span> <span class=
"keywordtype">int</span> _save_debug_stat(netsnmp_token_descr *tb, <span class="keywordtype">void</span> *type);
00053  <span class="keyword">static</span> <span class="keywordtype">int</span> _debug_stats_callback(<span class=
"keywordtype">int</span> majorID, <span class="keywordtype">int</span> minorID,
00054                    <span class="keywordtype">void</span> *serverarg, <span class="keywordtype">void</span> *clientarg);
00055 <span class="preprocessor">#endif</span>
00056 
00057 <span class="comment">/*</span>
00058 <span class="comment"> * indent debugging:  provide a space padded section to return an indent for </span>
00059 <span class="comment"> */</span>
00060 <span class="keyword">static</span> <span class="keywordtype">int</span>      debugindent = 0;
00061 <span class="preprocessor">#define INDENTMAX 80</span>
00062 <span class="keyword">static</span> <span class="keywordtype">char</span>     debugindentchars[] =
00063     <span class="stringliteral">"                                                                                "</span>;
00064 
00065 <span class="comment">/*</span>
00066 <span class="comment"> * Prototype definitions </span>
00067 <span class="comment"> */</span>
00068 <span class="keywordtype">void</span>            debug_config_register_tokens(<span class=
"keyword">const</span> <span class="keywordtype">char</span> *configtoken,
00069                                              <span class="keywordtype">char</span> *tokens);
00070 <span class="keywordtype">void</span>            debug_config_turn_on_debugging(<span class=
"keyword">const</span> <span class="keywordtype">char</span> *configtoken,
00071                                                <span class="keywordtype">char</span> *line);
00072 
00073 <span class="keywordtype">char</span>           *
00074 debug_indent(<span class="keywordtype">void</span>)
00075 {
00076     <span class="keywordflow">return</span> debugindentchars;
00077 }
00078 
00079 <span class="keywordtype">void</span>
00080 debug_indent_add(<span class="keywordtype">int</span> amount)
00081 {
00082     <span class="keywordflow">if</span> (debugindent + amount &gt;= 0 &amp;&amp; debugindent + amount &lt; 80) {
00083         debugindentchars[debugindent] = <span class="charliteral">' '</span>;
00084         debugindent += amount;
00085         debugindentchars[debugindent] = <span class="charliteral">'\0'</span>;
00086     }
00087 }
00088 
00089 <span class="keywordtype">void</span>
00090 debug_config_register_tokens(<span class="keyword">const</span> <span class=
"keywordtype">char</span> *configtoken, <span class="keywordtype">char</span> *tokens)
00091 {
00092     debug_register_tokens(tokens);
00093 }
00094 
00095 <span class="keywordtype">void</span>
00096 debug_config_turn_on_debugging(<span class="keyword">const</span> <span class=
"keywordtype">char</span> *configtoken, <span class="keywordtype">char</span> *line)
00097 {
00098     snmp_set_do_debugging(atoi(line));
00099 }
00100 
00101 <span class="keywordtype">void</span>
00102 snmp_debug_init(<span class="keywordtype">void</span>)
00103 {
00104     debugindentchars[0] = <span class="charliteral">'\0'</span>; <span class=
"comment">/* zero out the debugging indent array. */</span>
00105     <span class="comment">/*</span>
00106 <span class="comment">     * Hmmm....</span>
00107 <span class="comment">     *   this "init" routine seems to be called *after* processing</span>
00108 <span class="comment">     *   the command line options.   So we can't clear the debug</span>
00109 <span class="comment">     *   token array here, and will just have to rely on it being</span>
00110 <span class="comment">     *   initialised to 0 automatically.</span>
00111 <span class="comment">     * So much for trying to program responsibly :-)</span>
00112 <span class="comment">     */</span>
00113 <span class="comment">/*  memset(dbg_tokens, 0, MAX_DEBUG_TOKENS*sizeof(struct token_dscr));  */</span>
00114     register_prenetsnmp_mib_handler(<span class="stringliteral">"snmp"</span>, <span class=
"stringliteral">"doDebugging"</span>,
00115                                     debug_config_turn_on_debugging, NULL,
00116                                     <span class="stringliteral">"(1|0)"</span>);
00117     register_prenetsnmp_mib_handler(<span class="stringliteral">"snmp"</span>, <span class=
"stringliteral">"debugTokens"</span>,
00118                                     debug_config_register_tokens, NULL,
00119                                     <span class="stringliteral">"token[,token...]"</span>);
00120 
00121 <span class="preprocessor">#ifdef NETSNMP_DEBUG_STATS</span>
00122     <span class="comment">/*</span>
00123 <span class="comment">     * debug stats</span>
00124 <span class="comment">     */</span>
00125     dbg_stats = netsnmp_container_find(<span class="stringliteral">"debug_exclude:table_container"</span>);
00126     <span class="keywordflow">if</span> (NULL != dbg_stats) {
00127         dbg_stats-&gt;compare = _debug_cmp;
00128         netsnmp_register_callback(SNMP_CALLBACK_LIBRARY,
00129                                   SNMP_CALLBACK_STORE_DATA,
00130                                   _debug_stats_callback, dbg_stats, 1024);
00131     }
00132 <span class="preprocessor">#endif</span>
00133 }
00134 
00135 <span class="keywordtype">void</span>
00136 debug_register_tokens(<span class="keywordtype">char</span> *tokens)
00137 {
00138     <span class="keywordtype">char</span>           *newp, *cp;
00139     <span class="keywordtype">char</span>           *st;
00140     <span class="keywordtype">int</span>             status;
00141 
00142     <span class="keywordflow">if</span> (tokens == 0 || *tokens == 0)
00143         <span class="keywordflow">return</span>;
00144 
00145     newp = strdup(tokens);      <span class="comment">/* strtok_r messes it up */</span>
00146     cp = strtok_r(newp, DEBUG_TOKEN_DELIMITER, &amp;st);
00147     <span class="keywordflow">while</span> (cp) {
00148         <span class="keywordflow">if</span> (strlen(cp) &lt; MAX_DEBUG_TOKEN_LEN) {
00149             <span class="keywordflow">if</span> (strcasecmp(cp, DEBUG_ALWAYS_TOKEN) == 0) {
00150                 debug_print_everything = 1;
00151             } <span class="keywordflow">else</span> <span class=
"keywordflow">if</span> (debug_num_tokens &lt; MAX_DEBUG_TOKENS) {
00152                 <span class="keywordflow">if</span> (<span class="charliteral">'-'</span> == *cp) {
00153                     ++cp;
00154                     status = SNMP_DEBUG_EXCLUDED;
00155                 }
00156                 <span class="keywordflow">else</span>
00157                     status = SNMP_DEBUG_ACTIVE;
00158                 dbg_tokens[debug_num_tokens].token_name = strdup(cp);
00159                 dbg_tokens[debug_num_tokens++].enabled  = status;
00160                 <a class="code" href="group__snmp__logging.html#ga41">snmp_log</a>(LOG_NOTICE, <span class=
"stringliteral">"registered debug token %s, %d\n"</span>, cp, status);
00161             } <span class="keywordflow">else</span> {
00162                 <a class="code" href="group__snmp__logging.html#ga41">snmp_log</a>(LOG_NOTICE, <span class=
"stringliteral">"Unable to register debug token %s\n"</span>, cp);
00163             }
00164         } <span class="keywordflow">else</span> {
00165             <a class="code" href="group__snmp__logging.html#ga41">snmp_log</a>(LOG_NOTICE, <span class=
"stringliteral">"Debug token %s over length\n"</span>, cp);
00166         }
00167         cp = strtok_r(NULL, DEBUG_TOKEN_DELIMITER, &amp;st);
00168     }
00169     free(newp);
00170 }
00171 
00172 
00173 <span class="comment">/* </span>
00174 <span class="comment"> * Print all registered tokens along with their current status</span>
00175 <span class="comment"> */</span>
00176 <span class="keywordtype">void</span> 
00177 debug_print_registered_tokens(<span class="keywordtype">void</span>) {
00178     <span class="keywordtype">int</span> i;
00179 
00180     <a class="code" href="group__snmp__logging.html#ga41">snmp_log</a>(LOG_INFO, <span class=
"stringliteral">"%d tokens registered :\n"</span>, debug_num_tokens);
00181     <span class="keywordflow">for</span> (i=0; i&lt;debug_num_tokens; i++) {
00182         <a class="code" href="group__snmp__logging.html#ga41">snmp_log</a>( LOG_INFO, <span class=
"stringliteral">"%d) %s : %d\n"</span>, 
00183                  i, dbg_tokens [i].token_name, dbg_tokens [i].enabled);
00184     }
00185 }
00186 
00187 
00188 <span class="comment">/*</span>
00189 <span class="comment"> * Enable logs on a given token</span>
00190 <span class="comment"> */</span>
00191 <span class="keywordtype">int</span>
00192 debug_enable_token_logs (<span class="keyword">const</span> <span class="keywordtype">char</span> *token) {
00193     <span class="keywordtype">int</span> i;
00194 
00195     <span class="comment">/* debugging flag is on or off */</span>
00196     <span class="keywordflow">if</span> (!dodebug)
00197         <span class="keywordflow">return</span> SNMPERR_GENERR;
00198 
00199     <span class="keywordflow">if</span> (debug_num_tokens == 0 || debug_print_everything) {
00200         <span class="comment">/* no tokens specified, print everything */</span>
00201         <span class="keywordflow">return</span> SNMPERR_SUCCESS;
00202     } <span class="keywordflow">else</span> {
00203         <span class="keywordflow">for</span>(i=0; i &lt; debug_num_tokens; i++) {
00204             <span class="keywordflow">if</span> (dbg_tokens[i].token_name &amp;&amp;
00205                 strncmp(dbg_tokens[i].token_name, token, 
00206                         strlen(dbg_tokens[i].token_name)) == 0) {
00207                 dbg_tokens[i].enabled = SNMP_DEBUG_ACTIVE;
00208                 <span class="keywordflow">return</span> SNMPERR_SUCCESS;
00209             }
00210         }
00211     }
00212     <span class="keywordflow">return</span> SNMPERR_GENERR;
00213 }
00214 
00215 <span class="comment">/*</span>
00216 <span class="comment"> * Diable logs on a given token</span>
00217 <span class="comment"> */</span>
00218 <span class="keywordtype">int</span>
00219 debug_disable_token_logs (<span class="keyword">const</span> <span class="keywordtype">char</span> *token) {
00220     <span class="keywordtype">int</span> i;
00221 
00222     <span class="comment">/* debugging flag is on or off */</span>
00223     <span class="keywordflow">if</span> (!dodebug)
00224         <span class="keywordflow">return</span> SNMPERR_GENERR;
00225 
00226     <span class="keywordflow">if</span> (debug_num_tokens == 0 || debug_print_everything) {
00227         <span class="comment">/* no tokens specified, print everything */</span>
00228         <span class="keywordflow">return</span> SNMPERR_SUCCESS;
00229     } <span class="keywordflow">else</span> {
00230         <span class="keywordflow">for</span>(i=0; i &lt; debug_num_tokens; i++) {
00231             <span class="keywordflow">if</span> (strncmp(dbg_tokens[i].token_name, token, 
00232                   strlen(dbg_tokens[i].token_name)) == 0) {
00233                 dbg_tokens[i].enabled = SNMP_DEBUG_DISABLED;
00234                 <span class="keywordflow">return</span> SNMPERR_SUCCESS;
00235             }
00236         }
00237     }
00238     <span class="keywordflow">return</span> SNMPERR_GENERR;
00239 }
00240 
00241 
00242 <span class="comment">/*</span>
00243 <span class="comment"> * debug_is_token_registered(char *TOKEN):</span>
00244 <span class="comment"> * </span>
00245 <span class="comment"> * returns SNMPERR_SUCCESS</span>
00246 <span class="comment"> * or SNMPERR_GENERR</span>
00247 <span class="comment"> * </span>
00248 <span class="comment"> * if TOKEN has been registered and debugging support is turned on.</span>
00249 <span class="comment"> */</span>
00250 <span class="keywordtype">int</span>
00251 debug_is_token_registered(<span class="keyword">const</span> <span class="keywordtype">char</span> *token)
00252 {
00253     <span class="keywordtype">int</span>             i, rc;
00254 
00255     <span class="comment">/*</span>
00256 <span class="comment">     * debugging flag is on or off </span>
00257 <span class="comment">     */</span>
00258     <span class="keywordflow">if</span> (!dodebug)
00259         <span class="keywordflow">return</span> SNMPERR_GENERR;
00260 
00261     <span class="keywordflow">if</span> (debug_num_tokens == 0 || debug_print_everything) {
00262         <span class="comment">/*</span>
00263 <span class="comment">         * no tokens specified, print everything </span>
00264 <span class="comment">         * (unless something might be excluded)</span>
00265 <span class="comment">         */</span>
00266         <span class="keywordflow">if</span> (debug_num_excluded) {
00267             rc = SNMPERR_SUCCESS; <span class="comment">/* ! found = success */</span>
00268         } <span class="keywordflow">else</span> {
00269             <span class="keywordflow">return</span> SNMPERR_SUCCESS;
00270         }
00271     }
00272     <span class="keywordflow">else</span>
00273         rc = SNMPERR_GENERR; <span class="comment">/* ! found = err */</span>
00274 
00275     <span class="keywordflow">for</span> (i = 0; i &lt; debug_num_tokens; i++) {
00276         <span class="keywordflow">if</span> (SNMP_DEBUG_DISABLED == dbg_tokens[i].enabled)
00277             <span class="keywordflow">continue</span>;
00278         <span class="keywordflow">if</span> (dbg_tokens[i].token_name &amp;&amp;
00279             strncmp(dbg_tokens[i].token_name, token,
00280                     strlen(dbg_tokens[i].token_name)) == 0) {
00281             <span class="keywordflow">if</span> (SNMP_DEBUG_ACTIVE == dbg_tokens[i].enabled)
00282                 <span class="keywordflow">return</span> SNMPERR_SUCCESS; <span class="comment">/* active */</span>
00283             <span class="keywordflow">else</span>
00284                 <span class="keywordflow">return</span> SNMPERR_GENERR; <span class="comment">/* excluded */</span>
00285         }
00286     }
00287 
00288 <span class="preprocessor">#ifdef NETSNMP_DEBUG_STATS</span>
00289     <span class="keywordflow">if</span> ((SNMPERR_SUCCESS == rc) &amp;&amp; (NULL != dbg_stats)) {
00290         netsnmp_token_descr td, *found;
00291 
00292         td.token_name = token;
00293         found = CONTAINER_FIND(dbg_stats, &amp;td);
00294         <span class="keywordflow">if</span> (NULL == found) {
00295             found = <a class="code" href="group__util.html#ga39">SNMP_MALLOC_TYPEDEF</a>(netsnmp_token_descr);
00296             netsnmp_assert(NULL != found);
00297             found-&gt;token_name = strdup(token);
00298             netsnmp_assert(0 == found-&gt;enabled);
00299             CONTAINER_INSERT(dbg_stats, found);
00300         }
00301         ++found-&gt;enabled;
00302 <span class="comment">//        snmp_log(LOG_ERR,"tok %s, %d hits\n", token, found-&gt;enabled);</span>
00303     }
00304 <span class="preprocessor">#endif</span>
00305 
00306     <span class="keywordflow">return</span> rc;
00307 }
00308 
00309 <span class="keywordtype">void</span>
00310 <span class="preprocessor">#if HAVE_STDARG_H</span>
00311 debugmsg(<span class="keyword">const</span> <span class="keywordtype">char</span> *token, <span class=
"keyword">const</span> <span class="keywordtype">char</span> *format, ...)
00312 #<span class="keywordflow">else</span>
00313 debugmsg(va_alist)
00314      va_dcl
00315 #endif
00316 {
00317     va_list         debugargs;
00318 
00319 <span class="preprocessor">#if HAVE_STDARG_H</span>
00320     va_start(debugargs, format);
00321 <span class="preprocessor">#else</span>
00322     <span class="keyword">const</span> <span class="keywordtype">char</span>     *format;
00323     <span class="keyword">const</span> <span class="keywordtype">char</span>     *token;
00324 
00325     va_start(debugargs);
00326     token = va_arg(debugargs, <span class="keyword">const</span> <span class="keywordtype">char</span> *);
00327     format = va_arg(debugargs, <span class="keyword">const</span> <span class="keywordtype">char</span> *);   <span class=
"comment">/* ??? */</span>
00328 <span class="preprocessor">#endif</span>
00329 
00330     <span class="keywordflow">if</span> (debug_is_token_registered(token) == SNMPERR_SUCCESS) {
00331         snmp_vlog(LOG_DEBUG, format, debugargs);
00332     }
00333     va_end(debugargs);
00334 }
00335 
00336 <span class="keywordtype">void</span>
00337 debugmsg_oid(<span class="keyword">const</span> <span class="keywordtype">char</span> *token, <span class=
"keyword">const</span> oid * theoid, size_t len)
00338 {
00339     u_char         *buf = NULL;
00340     size_t          buf_len = 0, out_len = 0;
00341 
00342     <span class="keywordflow">if</span> (sprint_realloc_objid(&amp;buf, &amp;buf_len, &amp;out_len, 1, theoid, len)) {
00343         <span class="keywordflow">if</span> (buf != NULL) {
00344             debugmsg(token, <span class="stringliteral">"%s"</span>, buf);
00345         }
00346     } <span class="keywordflow">else</span> {
00347         <span class="keywordflow">if</span> (buf != NULL) {
00348             debugmsg(token, <span class="stringliteral">"%s [TRUNCATED]"</span>, buf);
00349         }
00350     }
00351 
00352     <span class="keywordflow">if</span> (buf != NULL) {
00353         free(buf);
00354     }
00355 }
00356 
00357 <span class="keywordtype">void</span>
00358 debugmsg_suboid(<span class="keyword">const</span> <span class="keywordtype">char</span> *token, <span class=
"keyword">const</span> oid * theoid, size_t len)
00359 {
00360     u_char         *buf = NULL;
00361     size_t          buf_len = 0, out_len = 0;
00362     <span class="keywordtype">int</span>             buf_overflow = 0;
00363 
00364     netsnmp_sprint_realloc_objid(&amp;buf, &amp;buf_len, &amp;out_len, 1,
00365                                  &amp;buf_overflow, theoid, len);
00366     <span class="keywordflow">if</span>(buf_overflow) {
00367         <span class="keywordflow">if</span> (buf != NULL) {
00368             debugmsg(token, <span class="stringliteral">"%s [TRUNCATED]"</span>, buf);
00369         }
00370     } <span class="keywordflow">else</span> {
00371         <span class="keywordflow">if</span> (buf != NULL) {
00372             debugmsg(token, <span class="stringliteral">"%s"</span>, buf);
00373         }
00374     }
00375 
00376     <span class="keywordflow">if</span> (buf != NULL) {
00377         free(buf);
00378     }
00379 }
00380 
00381 <span class="keywordtype">void</span>
00382 debugmsg_var(<span class="keyword">const</span> <span class="keywordtype">char</span> *token, <a class="code" href=
"structvariable__list.html">netsnmp_variable_list</a> * var)
00383 {
00384     u_char         *buf = NULL;
00385     size_t          buf_len = 0, out_len = 0;
00386 
00387     <span class="keywordflow">if</span> (var == NULL || token == NULL) {
00388         <span class="keywordflow">return</span>;
00389     }
00390 
00391     <span class="keywordflow">if</span> (sprint_realloc_variable(&amp;buf, &amp;buf_len, &amp;out_len, 1,
00392                                 var-&gt;<a class="code" href="structvariable__list.html#o1">name</a>, var-&gt;<a class=
"code" href="structvariable__list.html#o2">name_length</a>, var)) {
00393         <span class="keywordflow">if</span> (buf != NULL) {
00394             debugmsg(token, <span class="stringliteral">"%s"</span>, buf);
00395         }
00396     } <span class="keywordflow">else</span> {
00397         <span class="keywordflow">if</span> (buf != NULL) {
00398             debugmsg(token, <span class="stringliteral">"%s [TRUNCATED]"</span>, buf);
00399         }
00400     }
00401 
00402     <span class="keywordflow">if</span> (buf != NULL) {
00403         free(buf);
00404     }
00405 }
00406 
00407 <span class="keywordtype">void</span>
00408 debugmsg_oidrange(<span class="keyword">const</span> <span class="keywordtype">char</span> *token, <span class=
"keyword">const</span> oid * theoid, size_t len,
00409                   size_t var_subid, oid range_ubound)
00410 {
00411     u_char         *buf = NULL;
00412     size_t          buf_len = 0, out_len = 0, i = 0;
00413     <span class="keywordtype">int</span>             rc = 0;
00414 
00415     <span class="keywordflow">if</span> (var_subid == 0) {
00416         rc = sprint_realloc_objid(&amp;buf, &amp;buf_len, &amp;out_len, 1, theoid,
00417                                   len);
00418     } <span class="keywordflow">else</span> {
00419         <span class="keywordtype">char</span>            tmpbuf[128];
00420         <span class="comment">/* XXX - ? check for 0 == var_subid -1 ? */</span>
00421         rc = sprint_realloc_objid(&amp;buf, &amp;buf_len, &amp;out_len, 1, theoid,
00422                                   var_subid-1);  <span class="comment">/* Adjust for C's 0-based array indexing */</span>
00423         <span class="keywordflow">if</span> (rc) {
00424             sprintf(tmpbuf, <span class="stringliteral">".%lu--%lu"</span>, theoid[var_subid - 1],
00425                     range_ubound);
00426             rc = snmp_strcat(&amp;buf, &amp;buf_len, &amp;out_len, 1, tmpbuf);
00427             <span class="keywordflow">if</span> (rc) {
00428                 <span class="keywordflow">for</span> (i = var_subid; i &lt; len; i++) {
00429                     sprintf(tmpbuf, <span class="stringliteral">".%lu"</span>, theoid[i]);
00430                     <span class="keywordflow">if</span> (!snmp_strcat(&amp;buf, &amp;buf_len, &amp;out_len, 1, tmpbuf)) {
00431                         <span class="keywordflow">break</span>;
00432                     }
00433                 }
00434             }
00435         }
00436     }
00437 
00438 
00439     <span class="keywordflow">if</span> (buf != NULL) {
00440         debugmsg(token, <span class="stringliteral">"%s%s"</span>, buf, rc ? <span class=
"stringliteral">""</span> : <span class="stringliteral">" [TRUNCATED]"</span>);
00441         free(buf);
00442     }
00443 }
00444 
00445 <span class="keywordtype">void</span>
00446 debugmsg_hex(<span class="keyword">const</span> <span class="keywordtype">char</span> *token, u_char * thedata, size_t len)
00447 {
00448     u_char         *buf = NULL;
00449     size_t          buf_len = 0, out_len = 0;
00450 
00451     <span class="keywordflow">if</span> (sprint_realloc_hexstring
00452         (&amp;buf, &amp;buf_len, &amp;out_len, 1, thedata, len)) {
00453         <span class="keywordflow">if</span> (buf != NULL) {
00454             debugmsg(token, <span class="stringliteral">"%s"</span>, buf);
00455         }
00456     } <span class="keywordflow">else</span> {
00457         <span class="keywordflow">if</span> (buf != NULL) {
00458             debugmsg(token, <span class="stringliteral">"%s [TRUNCATED]"</span>, buf);
00459         }
00460     }
00461 
00462     <span class="keywordflow">if</span> (buf != NULL) {
00463         free(buf);
00464     }
00465 }
00466 
00467 <span class="keywordtype">void</span>
00468 debugmsg_hextli(<span class="keyword">const</span> <span class=
"keywordtype">char</span> *token, u_char * thedata, size_t len)
00469 {
00470     <span class="keywordtype">char</span>            buf[SPRINT_MAX_LEN], token2[SPRINT_MAX_LEN];
00471     u_char         *b3 = NULL;
00472     size_t          b3_len = 0, o3_len = 0;
00473     <span class="keywordtype">int</span>             incr;
00474     sprintf(token2, <span class="stringliteral">"dumpx_%s"</span>, token);
00475 
00476     <span class="comment">/*</span>
00477 <span class="comment">     * XX tracing lines removed from this function DEBUGTRACE; </span>
00478 <span class="comment">     */</span>
00479     DEBUGIF(token2) {
00480         <span class="keywordflow">for</span> (incr = 16; len &gt; 0; len -= incr, thedata += incr) {
00481             <span class="keywordflow">if</span> ((int) len &lt; incr) {
00482                 incr = len;
00483             }
00484             <span class="comment">/*</span>
00485 <span class="comment">             * XXnext two lines were DEBUGPRINTINDENT(token);</span>
00486 <span class="comment">             */</span>
00487             sprintf(buf, <span class="stringliteral">"dumpx%s"</span>, token);
00488             debugmsg(buf, <span class="stringliteral">"%s: %s"</span>, token2, debug_indent());
00489             <span class="keywordflow">if</span> (sprint_realloc_hexstring
00490                 (&amp;b3, &amp;b3_len, &amp;o3_len, 1, thedata, incr)) {
00491                 <span class="keywordflow">if</span> (b3 != NULL) {
00492                     debugmsg(token2, <span class="stringliteral">"%s"</span>, b3);
00493                 }
00494             } <span class="keywordflow">else</span> {
00495                 <span class="keywordflow">if</span> (b3 != NULL) {
00496                     debugmsg(token2, <span class="stringliteral">"%s [TRUNCATED]"</span>, b3);
00497                 }
00498             }
00499             o3_len = 0;
00500         }
00501     }
00502     <span class="keywordflow">if</span> (b3 != NULL) {
00503         free(b3);
00504     }
00505 }
00506 
00507 <span class="keywordtype">void</span>
00508 <span class="preprocessor">#if HAVE_STDARG_H</span>
00509 debugmsgtoken(<span class="keyword">const</span> <span class="keywordtype">char</span> *token, <span class=
"keyword">const</span> <span class="keywordtype">char</span> *format, ...)
00510 #<span class="keywordflow">else</span>
00511 debugmsgtoken(va_alist)
00512      va_dcl
00513 #endif
00514 {
00515     va_list         debugargs;
00516 
00517 <span class="preprocessor">#if HAVE_STDARG_H</span>
00518     va_start(debugargs, format);
00519 <span class="preprocessor">#else</span>
00520     <span class="keyword">const</span> <span class="keywordtype">char</span>     *token;
00521 
00522     va_start(debugargs);
00523     token = va_arg(debugargs, <span class="keyword">const</span> <span class="keywordtype">char</span> *);
00524 <span class="preprocessor">#endif</span>
00525 
00526     debugmsg(token, <span class="stringliteral">"%s: "</span>, token);
00527 
00528     va_end(debugargs);
00529 }
00530 
00531 <span class="keywordtype">void</span>
00532 <span class="preprocessor">#if HAVE_STDARG_H</span>
00533 debug_combo_nc(<span class="keyword">const</span> <span class="keywordtype">char</span> *token, <span class=
"keyword">const</span> <span class="keywordtype">char</span> *format, ...)
00534 #<span class="keywordflow">else</span>
00535 debug_combo_nc(va_alist)
00536      va_dcl
00537 #endif
00538 {
00539     va_list         debugargs;
00540 
00541 <span class="preprocessor">#if HAVE_STDARG_H</span>
00542     va_start(debugargs, format);
00543 <span class="preprocessor">#else</span>
00544     <span class="keyword">const</span> <span class="keywordtype">char</span>     *format;
00545     <span class="keyword">const</span> <span class="keywordtype">char</span>     *token;
00546 
00547     va_start(debugargs);
00548     token = va_arg(debugargs, <span class="keyword">const</span> <span class="keywordtype">char</span> *);
00549     format = va_arg(debugargs, <span class="keyword">const</span> <span class="keywordtype">char</span> *);   <span class=
"comment">/* ??? */</span>
00550 <span class="preprocessor">#endif</span>
00551 
00552     <a class="code" href="group__snmp__logging.html#ga41">snmp_log</a>(LOG_DEBUG, <span class=
"stringliteral">"%s: "</span>, token);
00553     snmp_vlog(LOG_DEBUG, format, debugargs);
00554 
00555     va_end(debugargs);
00556 }
00557 
00558 <span class="comment">/*</span>
00559 <span class="comment"> * for speed, these shouldn't be in default_storage space </span>
00560 <span class="comment"> */</span>
00561 <span class="keywordtype">void</span>
00562 snmp_set_do_debugging(<span class="keywordtype">int</span> val)
00563 {
00564     dodebug = val;
00565 }
00566 
00567 <span class="keywordtype">int</span>
00568 snmp_get_do_debugging(<span class="keywordtype">void</span>)
00569 {
00570     <span class="keywordflow">return</span> dodebug;
00571 }
00572 
00573 <span class="preprocessor">#ifdef NETSNMP_DEBUG_STATS</span>
00574 <span class="comment">/************************************************************</span>
00575 <span class="comment"> * compare two context pointers here. Return -1 if lhs &lt; rhs,</span>
00576 <span class="comment"> * 0 if lhs == rhs, and 1 if lhs &gt; rhs.</span>
00577 <span class="comment"> */</span>
00578 <span class="keyword">static</span> <span class="keywordtype">int</span>
00579 _debug_cmp( <span class="keyword">const</span> <span class="keywordtype">void</span> *lhs, <span class=
"keyword">const</span> <span class="keywordtype">void</span> *rhs )
00580 {
00581     netsnmp_token_descr *dbg_l = (netsnmp_token_descr *)lhs;
00582     netsnmp_token_descr *dbg_r = (netsnmp_token_descr *)rhs;
00583 
00584 <span class="comment">//    snmp_log(LOG_ERR,"%s/%s\n",dbg_l-&gt;token_name, dbg_r-&gt;token_name);</span>
00585     <span class="keywordflow">return</span> strcmp(dbg_l-&gt;token_name, dbg_r-&gt;token_name);
00586 }
00587 
00588 
00589 <span class="keyword">static</span> <span class="keywordtype">int</span>
00590 _save_debug_stat(netsnmp_token_descr *tb, <span class="keywordtype">void</span> *type)
00591 {
00592     <span class="keywordtype">char</span> buf[256];
00593 
00594     snprintf(buf, <span class="keyword">sizeof</span>(buf), <span class="stringliteral">"debug_hits %s %d"</span>,
00595              tb-&gt;token_name, tb-&gt;enabled);
00596     <a class="code" href="group__read__config.html#ga40">read_config_store</a>((<span class=
"keywordtype">char</span> *) type, buf);
00597 
00598     <span class="keywordflow">return</span> SNMP_ERR_NOERROR;
00599 }
00600 
00601 <span class="keyword">static</span> <span class="keywordtype">int</span>
00602 _debug_stats_callback(<span class="keywordtype">int</span> majorID, <span class="keywordtype">int</span> minorID,
00603                   <span class="keywordtype">void</span> *serverarg, <span class="keywordtype">void</span> *clientarg)
00604 {
00605     <span class="keywordtype">char</span>            sep[] =
00606         <span class="stringliteral">"##############################################################"</span>;
00607     <span class="keywordtype">char</span>            buf[] =
00608         <span class="stringliteral">"#\n"</span> <span class="stringliteral">"# debug stats\n"</span> <span class=
"stringliteral">"#"</span>;
00609     <span class="keywordtype">char</span>           *type = netsnmp_ds_get_string(NETSNMP_DS_LIBRARY_ID,
00610                                                  NETSNMP_DS_LIB_APPTYPE);
00611 
00612     <a class="code" href="group__read__config.html#ga40">read_config_store</a>((<span class=
"keywordtype">char</span> *) type, sep);
00613     <a class="code" href="group__read__config.html#ga40">read_config_store</a>((<span class=
"keywordtype">char</span> *) type, buf);
00614 
00615     <span class="comment">/*</span>
00616 <span class="comment">     * save all rows</span>
00617 <span class="comment">     */</span>
00618     CONTAINER_FOR_EACH((netsnmp_container *) clientarg,
00619                        (netsnmp_container_obj_func *)
00620                        _save_debug_stat, type);
00621 
00622     <a class="code" href="group__read__config.html#ga40">read_config_store</a>((<span class=
"keywordtype">char</span> *) type, sep);
00623     <a class="code" href="group__read__config.html#ga40">read_config_store</a>((<span class=
"keywordtype">char</span> *) type, <span class="stringliteral">"\n"</span>);
00624 
00625     <span class="comment">/*</span>
00626 <span class="comment">     * never fails </span>
00627 <span class="comment">     */</span>
00628     <span class="keywordflow">return</span> SNMPERR_SUCCESS;
00629 }
00630 <span class="preprocessor">#endif</span>
00631 
</pre>
  </div>
  <hr size="1" />

  <address style="align: right;">
    <small>Generated on Fri Dec 30 13:47:48 2005 for net-snmp by&nbsp; <a href="http://www.doxygen.org/index.html"><img src=
    "doxygen.png" alt="doxygen" align="middle" border="0" /></a> 1.3.9.1</small>
  </address>
<!-- CONTENT END -->
<!--#include virtual="/page-bottom.html" -->

