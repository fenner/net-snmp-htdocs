<!--#set var="section" value="development" -->
<!--#include virtual="/page-top.html" -->
<!-- CONTENT START -->
  <div class="qindex">
    <a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="modules.html">Modules</a> | <a class=
    "qindex" href="annotated.html">Data&nbsp;Structures</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class=
    "qindex" href="functions.html">Data&nbsp;Fields</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a> | <a class=
    "qindex" href="examples.html">Examples</a>
  </div>

  <div class="nav">
    <a class="el" href="dir_000003.html">agent</a>&nbsp;/&nbsp;<a class="el" href="dir_000004.html">helpers</a>
  </div>

  <h1>baby_steps.c</h1>

  <div class="fragment">
    <pre class="fragment">
00001 <span class="comment">/*</span>
00002 <span class="comment"> * baby_steps.c</span>
00003 <span class="comment"> * $Id$</span>
00004 <span class="comment"> */</span>
00005 <span class="preprocessor">#include &lt;net-snmp/net-snmp-config.h&gt;</span>
00006 <span class="preprocessor">#include &lt;net-snmp/net-snmp-includes.h&gt;</span>
00007 <span class="preprocessor">#include &lt;net-snmp/agent/net-snmp-agent-includes.h&gt;</span>
00008 
00009 <span class="preprocessor">#include &lt;net-snmp/agent/baby_steps.h&gt;</span>
00010 
00011 <span class="preprocessor">#if HAVE_DMALLOC_H</span>
00012 <span class="preprocessor">#include &lt;dmalloc.h&gt;</span>
00013 <span class="preprocessor">#endif</span>
00014 
00015 <span class="preprocessor">#define BABY_STEPS_PER_MODE_MAX     4</span>
00016 <span class="preprocessor">#define BSTEP_USE_ORIGINAL          0xffff</span>
00017 
00018 <span class="keyword">static</span> u_short get_mode_map[BABY_STEPS_PER_MODE_MAX] = {
00019     MODE_BSTEP_PRE_REQUEST, MODE_BSTEP_OBJECT_LOOKUP, BSTEP_USE_ORIGINAL, MODE_BSTEP_POST_REQUEST };
00020 
00021 <span class="keyword">static</span> u_short set_mode_map[SNMP_MSG_INTERNAL_SET_MAX][BABY_STEPS_PER_MODE_MAX] = {
00022     <span class="comment">/*R1*/</span>
00023     { MODE_BSTEP_PRE_REQUEST, MODE_BSTEP_OBJECT_LOOKUP, MODE_BSTEP_ROW_CREATE,
00024       MODE_BSTEP_CHECK_VALUE },
00025     <span class="comment">/*R2*/</span>
00026     { MODE_BSTEP_UNDO_SETUP, BABY_STEP_NONE, BABY_STEP_NONE, BABY_STEP_NONE },
00027     <span class="comment">/*A */</span>
00028     { MODE_BSTEP_SET_VALUE,MODE_BSTEP_CHECK_CONSISTENCY,
00029       MODE_BSTEP_COMMIT, BABY_STEP_NONE },
00030     <span class="comment">/*C */</span>
00031     { MODE_BSTEP_IRREVERSIBLE_COMMIT, MODE_BSTEP_UNDO_CLEANUP, MODE_BSTEP_POST_REQUEST,
00032       BABY_STEP_NONE},
00033     <span class="comment">/*F */</span>
00034     { MODE_BSTEP_UNDO_CLEANUP, MODE_BSTEP_POST_REQUEST, BABY_STEP_NONE,
00035       BABY_STEP_NONE },
00036     <span class="comment">/*U */</span>
00037     { MODE_BSTEP_UNDO_COMMIT, MODE_BSTEP_UNDO_SET, MODE_BSTEP_UNDO_CLEANUP,
00038       MODE_BSTEP_POST_REQUEST}
00039 };
00040 
00041 <span class="keyword">static</span> <span class="keywordtype">int</span>
00042 _baby_steps_helper(<a class="code" href="structnetsnmp__mib__handler__s.html">netsnmp_mib_handler</a> *handler,
00043                    <a class="code" href=
"structnetsnmp__handler__registration__s.html">netsnmp_handler_registration</a> *reginfo,
00044                    <a class="code" href=
"structnetsnmp__agent__request__info__s.html">netsnmp_agent_request_info</a> *reqinfo,
00045                    <a class="code" href="structnetsnmp__request__info__s.html">netsnmp_request_info</a> *requests);
00046 <span class="keyword">static</span> <span class="keywordtype">int</span>
00047 _baby_steps_access_multiplexer(<a class="code" href="structnetsnmp__mib__handler__s.html">netsnmp_mib_handler</a> *handler,
00048                                <a class="code" href=
"structnetsnmp__handler__registration__s.html">netsnmp_handler_registration</a> *reginfo,
00049                                <a class="code" href=
"structnetsnmp__agent__request__info__s.html">netsnmp_agent_request_info</a> *reqinfo,
00050                                <a class="code" href=
"structnetsnmp__request__info__s.html">netsnmp_request_info</a> *requests);
00051     
00060 <a class="code" href="structnetsnmp__mib__handler__s.html">netsnmp_mib_handler</a> *
<a name="l00061" id="l00061"></a><a class="code" href="group__baby__steps.html#ga0">00061</a> <a class="code" href=
"group__baby__steps.html#ga0">netsnmp_baby_steps_handler_get</a>(u_long modes)
00062 {
00063     <a class="code" href="structnetsnmp__mib__handler__s.html">netsnmp_mib_handler</a> *mh;
00064     netsnmp_baby_steps_modes *md;
00065 
00066     mh = <a class="code" href="group__handler.html#ga7">netsnmp_create_handler</a>(<span class=
"stringliteral">"baby_steps"</span>, _baby_steps_helper);
00067     <span class="keywordflow">if</span>(!mh)
00068         <span class="keywordflow">return</span> NULL;
00069 
00070     md = <a class="code" href="group__util.html#ga39">SNMP_MALLOC_TYPEDEF</a>(netsnmp_baby_steps_modes);
00071     <span class="keywordflow">if</span> (NULL == md) {
00072         <a class="code" href="group__snmp__logging.html#ga39">snmp_log</a>(LOG_ERR,<span class=
"stringliteral">"malloc failed in netsnmp_baby_steps_handler_get\n"</span>);
00073         <a class="code" href="group__handler.html#ga19">netsnmp_handler_free</a>(mh);
00074         mh = NULL;
00075     }
00076     <span class="keywordflow">else</span> {
00077         mh-&gt;<a class="code" href="structnetsnmp__mib__handler__s.html#o1">myvoid</a> = md;
00078         <span class="keywordflow">if</span> (0 == modes)
00079             modes = BABY_STEP_ALL;
00080         md-&gt;registered = modes;
00081     }
00082 
00083     <span class="comment">/*</span>
00084 <span class="comment">     * don't set MIB_HANDLER_AUTO_NEXT, since we need to call lower</span>
00085 <span class="comment">     * handlers with a munged mode.</span>
00086 <span class="comment">     */</span>
00087     
00088     <span class="keywordflow">return</span> mh;
00089 }
00090 
00092 <span class="keyword">static</span> <span class="keywordtype">int</span>
00093 _baby_steps_helper(<a class="code" href="structnetsnmp__mib__handler__s.html">netsnmp_mib_handler</a> *handler,
00094                          <a class="code" href=
"structnetsnmp__handler__registration__s.html">netsnmp_handler_registration</a> *reginfo,
00095                          <a class="code" href=
"structnetsnmp__agent__request__info__s.html">netsnmp_agent_request_info</a> *reqinfo,
00096                          <a class="code" href="structnetsnmp__request__info__s.html">netsnmp_request_info</a> *requests)
00097 {
00098     netsnmp_baby_steps_modes *bs_modes;
00099     <span class="keywordtype">int</span> save_mode, i, rc = SNMP_ERR_NOERROR;
00100     u_short *mode_map_ptr;
00101     
00102     DEBUGMSGTL((<span class="stringliteral">"baby_steps"</span>, <span class=
"stringliteral">"Got request, mode %s\n"</span>,
00103                 se_find_label_in_slist(<span class="stringliteral">"agent_mode"</span>,reqinfo-&gt;<a class="code" href=
"structnetsnmp__agent__request__info__s.html#o0">mode</a>)));
00104 
00105     bs_modes = handler-&gt;<a class="code" href="structnetsnmp__mib__handler__s.html#o1">myvoid</a>;
00106     netsnmp_assert(NULL != bs_modes);
00107 
00108     <span class="keywordflow">switch</span> (reqinfo-&gt;<a class="code" href=
"structnetsnmp__agent__request__info__s.html#o0">mode</a>) {
00109 
00110     <span class="keywordflow">case</span> MODE_SET_RESERVE1:
00111         <span class="comment">/*</span>
00112 <span class="comment">         * clear completed modes</span>
00113 <span class="comment">         * xxx-rks: this will break for pdus with set requests to different</span>
00114 <span class="comment">         * rows in the same table when the handler is set up to use the row</span>
00115 <span class="comment">         * merge helper as well (or if requests are serialized).</span>
00116 <span class="comment">         */</span>
00117         bs_modes-&gt;completed = 0;
00120     <span class="keywordflow">case</span> MODE_SET_RESERVE2:
00121     <span class="keywordflow">case</span> MODE_SET_ACTION:
00122     <span class="keywordflow">case</span> MODE_SET_COMMIT:
00123     <span class="keywordflow">case</span> MODE_SET_FREE:
00124     <span class="keywordflow">case</span> MODE_SET_UNDO:
00125         mode_map_ptr = set_mode_map[reqinfo-&gt;<a class="code" href=
"structnetsnmp__agent__request__info__s.html#o0">mode</a>];
00126         <span class="keywordflow">break</span>;
00127             
00128     <span class="keywordflow">default</span>:
00129         <span class="comment">/*</span>
00130 <span class="comment">         * clear completed modes</span>
00131 <span class="comment">         */</span>
00132         bs_modes-&gt;completed = 0;
00133 
00134         mode_map_ptr = get_mode_map;
00135     }
00136 
00137     <span class="comment">/*</span>
00138 <span class="comment">     * NOTE: if you update this chart, please update the versions in</span>
00139 <span class="comment">     *       local/mib2c-conf.d/parent-set.m2i</span>
00140 <span class="comment">     *       agent/mibgroup/helpers/baby_steps.c</span>
00141 <span class="comment">     * while you're at it.</span>
00142 <span class="comment">     */</span>
00143     <span class="comment">/*</span>
00144 <span class="comment">     ***********************************************************************</span>
00145 <span class="comment">     * Baby Steps Flow Chart (2004.06.05)                                  *</span>
00146 <span class="comment">     *                                                                     *</span>
00147 <span class="comment">     * +--------------+    +================+    U = unconditional path    *</span>
00148 <span class="comment">     * |optional state|    ||required state||    S = path for success      *</span>
00149 <span class="comment">     * +--------------+    +================+    E = path for error        *</span>
00150 <span class="comment">     ***********************************************************************</span>
00151 <span class="comment">     *</span>
00152 <span class="comment">     *                        +--------------+</span>
00153 <span class="comment">     *                        |     pre      |</span>
00154 <span class="comment">     *                        |   request    |</span>
00155 <span class="comment">     *                        +--------------+</span>
00156 <span class="comment">     *                               | U</span>
00157 <span class="comment">     * +-------------+        +==============+</span>
00158 <span class="comment">     * |    row    |f|&lt;-------||  object    ||</span>
00159 <span class="comment">     * |  create   |1|      E ||  lookup    ||</span>
00160 <span class="comment">     * +-------------+        +==============+</span>
00161 <span class="comment">     *     E |   | S                 | S</span>
00162 <span class="comment">     *       |   +------------------&gt;|</span>
00163 <span class="comment">     *       |                +==============+</span>
00164 <span class="comment">     *       |              E ||   check    ||</span>
00165 <span class="comment">     *       |&lt;---------------||   values   ||</span>
00166 <span class="comment">     *       |                +==============+</span>
00167 <span class="comment">     *       |                       | S</span>
00168 <span class="comment">     *       |                +==============+</span>
00169 <span class="comment">     *       |       +&lt;-------||   undo     ||</span>
00170 <span class="comment">     *       |       |      E ||   setup    ||</span>
00171 <span class="comment">     *       |       |        +==============+</span>
00172 <span class="comment">     *       |       |               | S</span>
00173 <span class="comment">     *       |       |        +==============+</span>
00174 <span class="comment">     *       |       |        ||    set     ||--------------------------&gt;+</span>
00175 <span class="comment">     *       |       |        ||   value    || E                         |</span>
00176 <span class="comment">     *       |       |        +==============+                           |</span>
00177 <span class="comment">     *       |       |               | S                                 |</span>
00178 <span class="comment">     *       |       |        +--------------+                           |</span>
00179 <span class="comment">     *       |       |        |    check     |--------------------------&gt;|</span>
00180 <span class="comment">     *       |       |        |  consistency | E                         |</span>
00181 <span class="comment">     *       |       |        +--------------+                           |</span>
00182 <span class="comment">     *       |       |               | S                                 |</span>
00183 <span class="comment">     *       |       |        +==============+         +==============+  |</span>
00184 <span class="comment">     *       |       |        ||   commit   ||--------&gt;||     undo   ||  |</span>
00185 <span class="comment">     *       |       |        ||            || E       ||    commit  ||  |</span>
00186 <span class="comment">     *       |       |        +==============+         +==============+  |</span>
00187 <span class="comment">     *       |       |               | S                     U |&lt;--------+</span>
00188 <span class="comment">     *       |       |        +--------------+         +==============+</span>
00189 <span class="comment">     *       |       |        | irreversible |         ||    undo    ||</span>
00190 <span class="comment">     *       |       |        |    commit    |         ||     set    ||</span>
00191 <span class="comment">     *       |       |        +--------------+         +==============+</span>
00192 <span class="comment">     *       |       |               | U                     U |</span>
00193 <span class="comment">     *       |       +--------------&gt;|&lt;------------------------+</span>
00194 <span class="comment">     *       |                +==============+</span>
00195 <span class="comment">     *       |                ||   undo     ||</span>
00196 <span class="comment">     *       |                ||  cleanup   ||</span>
00197 <span class="comment">     *       |                +==============+</span>
00198 <span class="comment">     *       +----------------------&gt;| U</span>
00199 <span class="comment">     *                               |</span>
00200 <span class="comment">     *                          (err &amp;&amp; f1)-------------------&gt;+</span>
00201 <span class="comment">     *                               |                         |</span>
00202 <span class="comment">     *                        +--------------+         +--------------+</span>
00203 <span class="comment">     *                        |    post      |&lt;--------|      row     |</span>
00204 <span class="comment">     *                        |   request    |       U |    release   |</span>
00205 <span class="comment">     *                        +--------------+         +--------------+</span>
00206 <span class="comment">     *</span>
00207 <span class="comment">     */</span>
00208     <span class="comment">/*</span>
00209 <span class="comment">     * save original mode</span>
00210 <span class="comment">     */</span>
00211     save_mode = reqinfo-&gt;<a class="code" href="structnetsnmp__agent__request__info__s.html#o0">mode</a>;
00212     <span class="keywordflow">for</span>(i = 0; i &lt; BABY_STEPS_PER_MODE_MAX; ++i ) {
00213         <span class="comment">/*</span>
00214 <span class="comment">         * break if we run out of baby steps for this mode</span>
00215 <span class="comment">         */</span>
00216         <span class="keywordflow">if</span>(mode_map_ptr[i] == BABY_STEP_NONE)
00217             <span class="keywordflow">break</span>;
00218 
00219         DEBUGMSGTL((<span class="stringliteral">"baby_steps"</span>, <span class=
"stringliteral">" baby step mode %s\n"</span>,
00220                     se_find_label_in_slist(<span class="stringliteral">"babystep_mode"</span>,mode_map_ptr[i])));
00221 
00222         <span class="comment">/*</span>
00223 <span class="comment">         * skip modes the handler didn't register for</span>
00224 <span class="comment">         */</span>
00225         <span class="keywordflow">if</span> (BSTEP_USE_ORIGINAL != mode_map_ptr[i]) {
00226             u_int    mode_flag;
00227 
00228             <span class="comment">/*</span>
00229 <span class="comment">             * skip undo commit if commit wasn't hit, and</span>
00230 <span class="comment">             * undo_cleanup if undo_setup wasn't hit.</span>
00231 <span class="comment">             */</span>
00232             <span class="keywordflow">if</span>((MODE_SET_UNDO == save_mode) &amp;&amp;
00233                (MODE_BSTEP_UNDO_COMMIT == mode_map_ptr[i]) &amp;&amp;
00234                !(BABY_STEP_COMMIT &amp; bs_modes-&gt;completed)) {
00235                 DEBUGMSGTL((<span class="stringliteral">"baby_steps"</span>,
00236                             <span class="stringliteral">"   skipping commit undo (no commit)\n"</span>));
00237                 <span class="keywordflow">continue</span>;
00238             }
00239             <span class="keywordflow">else</span> <span class=
"keywordflow">if</span>((MODE_SET_FREE == save_mode) &amp;&amp;
00240                (MODE_BSTEP_UNDO_CLEANUP == mode_map_ptr[i]) &amp;&amp;
00241                !(BABY_STEP_UNDO_SETUP &amp; bs_modes-&gt;completed)) {
00242                 DEBUGMSGTL((<span class="stringliteral">"baby_steps"</span>,
00243                             <span class="stringliteral">"   skipping undo cleanup (no undo setup)\n"</span>));
00244                 <span class="keywordflow">continue</span>;
00245             }
00246 
00247             reqinfo-&gt;<a class="code" href="structnetsnmp__agent__request__info__s.html#o0">mode</a> = mode_map_ptr[i];
00248             mode_flag = netsnmp_baby_step_mode2flag( mode_map_ptr[i] );
00249             <span class="keywordflow">if</span>((mode_flag &amp; bs_modes-&gt;registered))
00250                 bs_modes-&gt;completed |= mode_flag;
00251             <span class="keywordflow">else</span> {
00252                 DEBUGMSGTL((<span class="stringliteral">"baby_steps"</span>,
00253                             <span class="stringliteral">"   skipping mode (not registered)\n"</span>));
00254                 <span class="keywordflow">continue</span>;
00255             }
00256 
00257         
00258         }
00259         <span class="keywordflow">else</span> {
00260             reqinfo-&gt;<a class="code" href="structnetsnmp__agent__request__info__s.html#o0">mode</a> = save_mode;
00261         }
00262 
00263 <span class="preprocessor">#ifdef BABY_STEPS_NEXT_MODE</span>
00264         <span class="comment">/*</span>
00265 <span class="comment">         * I can't remember why I wanted the next mode in the request,</span>
00266 <span class="comment">         * but it's not used anywhere, so don't use this code. saved,</span>
00267 <span class="comment">         * in case I remember why I thought needed it. - rstory 040911</span>
00268 <span class="comment">         */</span>
00269         <span class="keywordflow">if</span>((BABY_STEPS_PER_MODE_MAX - 1) == i)
00270             reqinfo-&gt;next_mode_ok = BABY_STEP_NONE;
00271         <span class="keywordflow">else</span> {
00272             <span class="keywordflow">if</span>(BSTEP_USE_ORIGINAL == mode_map_ptr[i+1])
00273                 reqinfo-&gt;next_mode_ok = save_mode;
00274             <span class="keywordflow">else</span>
00275                 reqinfo-&gt;next_mode_ok = mode_map_ptr[i+1];
00276         }
00277 <span class="preprocessor">#endif</span>
00278 
00279         <span class="comment">/*</span>
00280 <span class="comment">         * call handlers for baby step</span>
00281 <span class="comment">         */</span>
00282         rc = <a class="code" href="group__handler.html#ga17">netsnmp_call_next_handler</a>(handler, reginfo, reqinfo,
00283                                        requests);
00284 
00285         <span class="comment">/*</span>
00286 <span class="comment">         * check for error calling handler (unlikely, but...)</span>
00287 <span class="comment">         */</span>
00288         <span class="keywordflow">if</span>(rc) {
00289             DEBUGMSGTL((<span class="stringliteral">"baby_steps"</span>, <span class=
"stringliteral">"   ERROR:handler error\n"</span>));
00290             <span class="keywordflow">break</span>;
00291         }
00292 
00293         <span class="comment">/*</span>
00294 <span class="comment">         * check for errors in any of the requests for reserve1,</span>
00295 <span class="comment">         * reserve2 and action. (there is no recovery from errors</span>
00296 <span class="comment">         * in commit, free or undo.)</span>
00297 <span class="comment">         */</span>
00298         <span class="keywordflow">if</span> (save_mode &lt; SNMP_MSG_INTERNAL_SET_COMMIT) {
00299             rc = netsnmp_check_requests_error(requests);
00300             <span class="keywordflow">if</span>(rc) {
00301                 DEBUGMSGTL((<span class="stringliteral">"baby_steps"</span>, <span class=
"stringliteral">"   ERROR:request error\n"</span>));
00302                 <span class="keywordflow">break</span>;
00303             }
00304         }
00305     }
00306 
00307     <span class="comment">/*</span>
00308 <span class="comment">     * restore original mode</span>
00309 <span class="comment">     */</span>
00310     reqinfo-&gt;<a class="code" href="structnetsnmp__agent__request__info__s.html#o0">mode</a> = save_mode;
00311 
00312     
00313     <span class="keywordflow">return</span> rc;
00314 }
00315 
00320 <span class="keywordtype">void</span>
<a name="l00321" id="l00321"></a><a class="code" href="group__baby__steps.html#ga2">00321</a> <a class="code" href=
"group__baby__steps.html#ga2">netsnmp_baby_steps_handler_init</a>(<span class="keywordtype">void</span>)
00322 {
00323     <a class="code" href="group__handler.html#ga36">netsnmp_register_handler_by_name</a>(<span class=
"stringliteral">"baby_steps"</span>,
00324                                      <a class="code" href=
"group__baby__steps.html#ga0">netsnmp_baby_steps_handler_get</a>(BABY_STEP_ALL));
00325 }
00326 
00337 <a class="code" href="structnetsnmp__mib__handler__s.html">netsnmp_mib_handler</a> *
<a name="l00338" id="l00338"></a><a class="code" href="group__baby__steps.html#ga3">00338</a> <a class="code" href=
"group__baby__steps.html#ga3">netsnmp_baby_steps_access_multiplexer_get</a>(netsnmp_baby_steps_access_methods *am)
00339 {
00340     <a class="code" href="structnetsnmp__mib__handler__s.html">netsnmp_mib_handler</a> *mh;
00341 
00342     mh = <a class="code" href="group__handler.html#ga7">netsnmp_create_handler</a>(<span class=
"stringliteral">"baby_steps_mux"</span>,
00343                                 _baby_steps_access_multiplexer);
00344     <span class="keywordflow">if</span>(!mh)
00345         <span class="keywordflow">return</span> NULL;
00346 
00347     mh-&gt;<a class="code" href="structnetsnmp__mib__handler__s.html#o1">myvoid</a> = am;
00348     mh-&gt;<a class="code" href="structnetsnmp__mib__handler__s.html#o2">flags</a> |= MIB_HANDLER_AUTO_NEXT;
00349     
00350     <span class="keywordflow">return</span> mh;
00351 }
00352 
00354 <span class="keyword">static</span> <span class="keywordtype">int</span>
00355 _baby_steps_access_multiplexer(<a class="code" href="structnetsnmp__mib__handler__s.html">netsnmp_mib_handler</a> *handler,
00356                                <a class="code" href=
"structnetsnmp__handler__registration__s.html">netsnmp_handler_registration</a> *reginfo,
00357                                <a class="code" href=
"structnetsnmp__agent__request__info__s.html">netsnmp_agent_request_info</a> *reqinfo,
00358                                <a class="code" href=
"structnetsnmp__request__info__s.html">netsnmp_request_info</a> *requests)
00359 {
00360     <span class="keywordtype">void</span> *temp_void;
00361     Netsnmp_Node_Handler *method = NULL;
00362     netsnmp_baby_steps_access_methods *access_methods;
00363     <span class="keywordtype">int</span> rc = SNMP_ERR_NOERROR;
00364 
00366     netsnmp_assert((handler!=NULL) &amp;&amp; (reginfo!=NULL) &amp;&amp; (reqinfo!=NULL) &amp;&amp;
00367                    (requests!=NULL));
00368 
00369     DEBUGMSGT((<span class="stringliteral">"baby_steps_mux"</span>, <span class="stringliteral">"mode %s\n"</span>,
00370                se_find_label_in_slist(<span class="stringliteral">"babystep_mode"</span>,reqinfo-&gt;<a class="code" href=
"structnetsnmp__agent__request__info__s.html#o0">mode</a>)));
00371 
00372     access_methods = (netsnmp_baby_steps_access_methods *)handler-&gt;<a class="code" href=
"structnetsnmp__mib__handler__s.html#o1">myvoid</a>;
00373     <span class="keywordflow">if</span>(!access_methods) {
00374         <a class="code" href="group__snmp__logging.html#ga39">snmp_log</a>(LOG_ERR,<span class=
"stringliteral">"baby_steps_access_multiplexer has no methods\n"</span>);
00375         <span class="keywordflow">return</span> SNMPERR_GENERR;
00376     }
00377 
00378     <span class="keywordflow">switch</span>(reqinfo-&gt;<a class="code" href=
"structnetsnmp__agent__request__info__s.html#o0">mode</a>) {
00379         
00380     <span class="keywordflow">case</span> MODE_BSTEP_PRE_REQUEST:
00381         <span class="keywordflow">if</span>( access_methods-&gt;pre_request )
00382             method = access_methods-&gt;pre_request;
00383         <span class="keywordflow">break</span>;
00384         
00385     <span class="keywordflow">case</span> MODE_BSTEP_OBJECT_LOOKUP:
00386         <span class="keywordflow">if</span>( access_methods-&gt;object_lookup )
00387             method = access_methods-&gt;object_lookup;
00388         <span class="keywordflow">break</span>;
00389 
00390     <span class="keywordflow">case</span> SNMP_MSG_GET:
00391     <span class="keywordflow">case</span> SNMP_MSG_GETNEXT:
00392         <span class="keywordflow">if</span>( access_methods-&gt;get_values )
00393             method = access_methods-&gt;get_values;
00394         <span class="keywordflow">break</span>;
00395         
00396     <span class="keywordflow">case</span> MODE_BSTEP_CHECK_VALUE:
00397         <span class="keywordflow">if</span>( access_methods-&gt;object_syntax_checks )
00398             method = access_methods-&gt;object_syntax_checks;
00399         <span class="keywordflow">break</span>;
00400 
00401     <span class="keywordflow">case</span> MODE_BSTEP_ROW_CREATE:
00402         <span class="keywordflow">if</span>( access_methods-&gt;row_creation )
00403             method = access_methods-&gt;row_creation;
00404         <span class="keywordflow">break</span>;
00405 
00406     <span class="keywordflow">case</span> MODE_BSTEP_UNDO_SETUP:
00407         <span class="keywordflow">if</span>( access_methods-&gt;undo_setup )
00408             method = access_methods-&gt;undo_setup;
00409         <span class="keywordflow">break</span>;
00410 
00411     <span class="keywordflow">case</span> MODE_BSTEP_SET_VALUE:
00412         <span class="keywordflow">if</span>( access_methods-&gt;set_values )
00413             method = access_methods-&gt;set_values;
00414         <span class="keywordflow">break</span>;
00415 
00416     <span class="keywordflow">case</span> MODE_BSTEP_CHECK_CONSISTENCY:
00417         <span class="keywordflow">if</span>( access_methods-&gt;consistency_checks )
00418             method = access_methods-&gt;consistency_checks;
00419         <span class="keywordflow">break</span>;
00420 
00421     <span class="keywordflow">case</span> MODE_BSTEP_UNDO_SET:
00422         <span class="keywordflow">if</span>( access_methods-&gt;undo_sets )
00423             method = access_methods-&gt;undo_sets;
00424         <span class="keywordflow">break</span>;
00425 
00426     <span class="keywordflow">case</span> MODE_BSTEP_COMMIT:
00427         <span class="keywordflow">if</span>( access_methods-&gt;commit )
00428             method = access_methods-&gt;commit;
00429         <span class="keywordflow">break</span>;
00430 
00431     <span class="keywordflow">case</span> MODE_BSTEP_UNDO_COMMIT:
00432         <span class="keywordflow">if</span>( access_methods-&gt;undo_commit )
00433             method = access_methods-&gt;undo_commit;
00434         <span class="keywordflow">break</span>;
00435 
00436     <span class="keywordflow">case</span> MODE_BSTEP_IRREVERSIBLE_COMMIT:
00437         <span class="keywordflow">if</span>( access_methods-&gt;irreversible_commit )
00438             method = access_methods-&gt;irreversible_commit;
00439         <span class="keywordflow">break</span>;
00440 
00441     <span class="keywordflow">case</span> MODE_BSTEP_UNDO_CLEANUP:
00442         <span class="keywordflow">if</span>( access_methods-&gt;undo_cleanup )
00443             method = access_methods-&gt;undo_cleanup;
00444         <span class="keywordflow">break</span>;
00445         
00446     <span class="keywordflow">case</span> MODE_BSTEP_POST_REQUEST:
00447         <span class="keywordflow">if</span>( access_methods-&gt;post_request )
00448             method = access_methods-&gt;post_request;
00449         <span class="keywordflow">break</span>;
00450 
00451     <span class="keywordflow">default</span>:
00452         <a class="code" href="group__snmp__logging.html#ga39">snmp_log</a>(LOG_ERR,<span class=
"stringliteral">"unknown mode %d\n"</span>, reqinfo-&gt;<a class="code" href=
"structnetsnmp__agent__request__info__s.html#o0">mode</a>);
00453         <span class="keywordflow">return</span> SNMP_ERR_GENERR;
00454     }
00455 
00456     <span class="comment">/*</span>
00457 <span class="comment">     * if method exists, set up handler void and call method.</span>
00458 <span class="comment">     */</span>
00459     <span class="keywordflow">if</span>(NULL != method) {
00460         temp_void = handler-&gt;<a class="code" href="structnetsnmp__mib__handler__s.html#o1">myvoid</a>;
00461         handler-&gt;<a class="code" href=
"structnetsnmp__mib__handler__s.html#o1">myvoid</a> = access_methods-&gt;my_access_void;
00462         rc = (*method)(handler, reginfo, reqinfo, requests);
00463         handler-&gt;<a class="code" href="structnetsnmp__mib__handler__s.html#o1">myvoid</a> = temp_void;
00464     }
00465     <span class="keywordflow">else</span> {
00466         rc = SNMP_ERR_GENERR;
00467         <a class="code" href="group__snmp__logging.html#ga39">snmp_log</a>(LOG_ERR,<span class=
"stringliteral">"baby steps multiplexer handler called for a mode "</span>
00468                  <span class="stringliteral">"with no handler\n"</span>);
00469         netsnmp_assert(NULL != method);
00470     }
00471 
00472     <span class="comment">/*</span>
00473 <span class="comment">     * don't call any lower handlers, it will be done for us </span>
00474 <span class="comment">     * since we set MIB_HANDLER_AUTO_NEXT</span>
00475 <span class="comment">     */</span>
00476 
00477     <span class="keywordflow">return</span> rc;
00478 }
00479 
00480 <span class="comment">/*</span>
00481 <span class="comment"> * give a baby step mode, return the flag for that mode</span>
00482 <span class="comment"> */</span>
00483 <span class="keywordtype">int</span>
00484 netsnmp_baby_step_mode2flag( u_int mode )
00485 {
00486     <span class="keywordflow">switch</span>( mode ) {
00487         <span class="keywordflow">case</span> MODE_BSTEP_OBJECT_LOOKUP:
00488             <span class="keywordflow">return</span> BABY_STEP_OBJECT_LOOKUP;
00489         <span class="keywordflow">case</span> MODE_BSTEP_SET_VALUE:
00490             <span class="keywordflow">return</span> BABY_STEP_SET_VALUE;
00491         <span class="keywordflow">case</span> MODE_BSTEP_IRREVERSIBLE_COMMIT:
00492             <span class="keywordflow">return</span> BABY_STEP_IRREVERSIBLE_COMMIT;
00493         <span class="keywordflow">case</span> MODE_BSTEP_CHECK_VALUE:
00494             <span class="keywordflow">return</span> BABY_STEP_CHECK_VALUE;
00495         <span class="keywordflow">case</span> MODE_BSTEP_PRE_REQUEST:
00496             <span class="keywordflow">return</span> BABY_STEP_PRE_REQUEST;
00497         <span class="keywordflow">case</span> MODE_BSTEP_POST_REQUEST:
00498             <span class="keywordflow">return</span> BABY_STEP_POST_REQUEST;
00499         <span class="keywordflow">case</span> MODE_BSTEP_UNDO_SETUP:
00500             <span class="keywordflow">return</span> BABY_STEP_UNDO_SETUP;
00501         <span class="keywordflow">case</span> MODE_BSTEP_UNDO_CLEANUP:
00502             <span class="keywordflow">return</span> BABY_STEP_UNDO_CLEANUP;
00503         <span class="keywordflow">case</span> MODE_BSTEP_UNDO_SET:
00504             <span class="keywordflow">return</span> BABY_STEP_UNDO_SET;
00505         <span class="keywordflow">case</span> MODE_BSTEP_ROW_CREATE:
00506             <span class="keywordflow">return</span> BABY_STEP_ROW_CREATE;
00507         <span class="keywordflow">case</span> MODE_BSTEP_CHECK_CONSISTENCY:
00508             <span class="keywordflow">return</span> BABY_STEP_CHECK_CONSISTENCY;
00509         <span class="keywordflow">case</span> MODE_BSTEP_COMMIT:
00510             <span class="keywordflow">return</span> BABY_STEP_COMMIT;
00511         <span class="keywordflow">case</span> MODE_BSTEP_UNDO_COMMIT:
00512             <span class="keywordflow">return</span> BABY_STEP_UNDO_COMMIT;
00513         <span class="keywordflow">default</span>:
00514             netsnmp_assert(<span class="stringliteral">"unknown flag"</span>);
00515             <span class="keywordflow">break</span>;
00516     }
00517     <span class="keywordflow">return</span> 0;
00518 }
</pre>
  </div>
  <hr size="1" />

  <address style="align: right;">
    <small><!--#include virtual="/sfbutton.html" --><br />
    Generated on Thu Oct 28 21:46:56 2004 for net-snmp by&nbsp; <a href="http://www.doxygen.org/index.html"><img src=
    "doxygen.png" alt="doxygen" align="middle" border="0" /></a> 1.3.9.1</small>
<!-- CONTENT END -->
<!--#include virtual="/page-bottom.html" -->

