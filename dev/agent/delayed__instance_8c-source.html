<!--#set var="section" value="development" -->
<!--#include virtual="/page-top.html" -->
<!-- CONTENT START -->
  <div class="qindex">
    <a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="modules.html">Modules</a> | <a class=
    "qindex" href="annotated.html">Data&nbsp;Structures</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class=
    "qindex" href="functions.html">Data&nbsp;Fields</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a> | <a class=
    "qindex" href="examples.html">Examples</a>
  </div>

  <div class="nav">
    <a class="el" href="dir_000003.html">agent</a>&nbsp;/&nbsp;<a class="el" href=
    "dir_000007.html">mibgroup</a>&nbsp;/&nbsp;<a class="el" href="dir_000008.html">examples</a>
  </div>

  <h1>delayed_instance.c</h1>

  <div class="fragment">
    <pre class="fragment">
00001 
00025 <span class="preprocessor">#include &lt;net-snmp/net-snmp-config.h&gt;</span>
00026 <span class="preprocessor">#include &lt;net-snmp/net-snmp-includes.h&gt;</span>
00027 <span class="preprocessor">#include &lt;net-snmp/agent/net-snmp-agent-includes.h&gt;</span>
00028 
00029 <span class="preprocessor">#include "delayed_instance.h"</span>
00030 
00031 <span class="keyword">static</span> u_long   delay_time = 1;
00032 
00033 <span class="keywordtype">void</span>
00034 init_delayed_instance(<span class="keywordtype">void</span>)
00035 {
00036     <span class="keyword">static</span> oid      my_delayed_oid[] =
00037         { 1, 3, 6, 1, 4, 1, 8072, 2, 1, 2, 0 };
00038     <span class="comment">/*</span>
00039 <span class="comment">     * delayed handler test</span>
00040 <span class="comment">     */</span>
00041     <a class="code" href="structnetsnmp__handler__registration__s.html">netsnmp_handler_registration</a> *my_test;
00042 
00043     my_test =
00044         netsnmp_create_handler_registration(<span class="stringliteral">"delayed_instance_example"</span>,
00045                                             delayed_instance_handler,
00046                                             my_delayed_oid,
00047                                             OID_LENGTH(my_delayed_oid),
00048                                             HANDLER_CAN_RWRITE);
00049 
00050     <a class="code" href="group__instance.html#ga1">netsnmp_register_instance</a>(my_test);
00051 }
00052 
00053 <span class="preprocessor">#define DELAYED_INSTANCE_SET_NAME "test_delayed"</span>
00054 
00055 <span class="keywordtype">int</span>
00056 delayed_instance_handler(<a class="code" href="structnetsnmp__mib__handler__s.html">netsnmp_mib_handler</a> *handler,
00057                          <a class="code" href=
"structnetsnmp__handler__registration__s.html">netsnmp_handler_registration</a> *reginfo,
00058                          <a class="code" href=
"structnetsnmp__agent__request__info__s.html">netsnmp_agent_request_info</a> *reqinfo,
00059                          <a class="code" href="structnetsnmp__request__info__s.html">netsnmp_request_info</a> *requests)
00060 {
00061 
00062     DEBUGMSGTL((<span class="stringliteral">"delayed_instance"</span>, <span class=
"stringliteral">"Got request, mode = %d:\n"</span>,
00063                 reqinfo-&gt;<a class="code" href="structnetsnmp__agent__request__info__s.html#o0">mode</a>));
00064 
00065     <span class="keywordflow">switch</span> (reqinfo-&gt;<a class="code" href=
"structnetsnmp__agent__request__info__s.html#o0">mode</a>) {
00066         <span class="comment">/*</span>
00067 <span class="comment">         * here we merely mention that we'll answer this request</span>
00068 <span class="comment">         * later.  we don't actually care about the mode type in this</span>
00069 <span class="comment">         * example, but for certain cases you may, so I'll leave in the</span>
00070 <span class="comment">         * otherwise useless switch and case statements </span>
00071 <span class="comment">         */</span>
00072 
00073     <span class="keywordflow">default</span>:
00074         <span class="comment">/*</span>
00075 <span class="comment">         * mark this variable as something that can't be handled now.</span>
00076 <span class="comment">         * We'll answer it later. </span>
00077 <span class="comment">         */</span>
00078         requests-&gt;<a class="code" href="structnetsnmp__request__info__s.html#o5">delegated</a> = 1;
00079 
00080         <span class="comment">/*</span>
00081 <span class="comment">         * register an alarm to update the results at a later</span>
00082 <span class="comment">         * time.  Normally, we might have to query something else</span>
00083 <span class="comment">         * (like an external request sent to a different network</span>
00084 <span class="comment">         * or system socket, etc), but for this example we'll do</span>
00085 <span class="comment">         * something really simply and just insert an alarm for a</span>
00086 <span class="comment">         * certain period of time </span>
00087 <span class="comment">         */</span>
00088         <a class="code" href="group__snmp__alarm.html#ga14">snmp_alarm_register</a>(delay_time, <span class=
"comment">/* seconds */</span>
00089                             0,  <span class="comment">/* dont repeat. */</span>
00090                             return_delayed_response,    <span class="comment">/* the function</span>
00091 <span class="comment">                                                         * to call */</span>
00092                             <span class="comment">/*</span>
00093 <span class="comment">                             * here we create a "cache" of useful</span>
00094 <span class="comment">                             * information that we'll want later</span>
00095 <span class="comment">                             * on.  This argument is passed back</span>
00096 <span class="comment">                             * to us in the callback function for</span>
00097 <span class="comment">                             * an alarm </span>
00098 <span class="comment">                             */</span>
00099                             (<span class="keywordtype">void</span> *)
00100                             <a class="code" href="group__handler.html#ga23">netsnmp_create_delegated_cache</a>(handler,
00101                                                            reginfo,
00102                                                            reqinfo,
00103                                                            requests,
00104                                                            NULL));
00105         <span class="keywordflow">break</span>;
00106 
00107     }
00108 
00109     <span class="keywordflow">return</span> SNMP_ERR_NOERROR;
00110 }
00111 
00112 <span class="keywordtype">void</span>
00113 return_delayed_response(<span class="keywordtype">unsigned</span> <span class=
"keywordtype">int</span> clientreg, <span class="keywordtype">void</span> *clientarg)
00114 {
00115     <span class="comment">/*</span>
00116 <span class="comment">     * extract the cache from the passed argument </span>
00117 <span class="comment">     */</span>
00118     netsnmp_delegated_cache *cache = (netsnmp_delegated_cache *) clientarg;
00119 
00120     <a class="code" href="structnetsnmp__request__info__s.html">netsnmp_request_info</a> *requests;
00121     <a class="code" href="structnetsnmp__agent__request__info__s.html">netsnmp_agent_request_info</a> *reqinfo;
00122     u_long         *delay_time_cache = NULL;
00123 
00124     <span class="comment">/*</span>
00125 <span class="comment">     * here we double check that the cache we created earlier is still</span>
00126 <span class="comment">     * * valid.  If not, the request timed out for some reason and we</span>
00127 <span class="comment">     * * don't need to keep processing things.  Should never happen, but</span>
00128 <span class="comment">     * * this double checks. </span>
00129 <span class="comment">     */</span>
00130     cache = <a class="code" href="group__handler.html#ga24">netsnmp_handler_check_cache</a>(cache);
00131 
00132     <span class="keywordflow">if</span> (!cache) {
00133         <a class="code" href="group__snmp__logging.html#ga39">snmp_log</a>(LOG_ERR, <span class=
"stringliteral">"illegal call to return delayed response\n"</span>);
00134         <span class="keywordflow">return</span>;
00135     }
00136 
00137     <span class="comment">/*</span>
00138 <span class="comment">     * re-establish the previous pointers we are used to having </span>
00139 <span class="comment">     */</span>
00140     reqinfo = cache-&gt;reqinfo;
00141     requests = cache-&gt;requests;
00142 
00143     DEBUGMSGTL((<span class="stringliteral">"delayed_instance"</span>,
00144                 <span class="stringliteral">"continuing delayed request, mode = %d\n"</span>,
00145                 cache-&gt;reqinfo-&gt;mode));
00146 
00147     <span class="comment">/*</span>
00148 <span class="comment">     * mention that it's no longer delegated, and we've now answered</span>
00149 <span class="comment">     * the query (which we'll do down below). </span>
00150 <span class="comment">     */</span>
00151     requests-&gt;<a class="code" href="structnetsnmp__request__info__s.html#o5">delegated</a> = 0;
00152 
00153     <span class="keywordflow">switch</span> (cache-&gt;reqinfo-&gt;mode) {
00154         <span class="comment">/*</span>
00155 <span class="comment">         * registering as an instance means we don't need to deal with</span>
00156 <span class="comment">         * getnext processing, so we don't handle it here at all.</span>
00157 <span class="comment">         * </span>
00158 <span class="comment">         * However, since the instance handler already reset the mode</span>
00159 <span class="comment">         * back to GETNEXT from the faked GET mode, we need to do the</span>
00160 <span class="comment">         * same thing in both cases.  This should be fixed in future</span>
00161 <span class="comment">         * versions of net-snmp hopefully. </span>
00162 <span class="comment">         */</span>
00163 
00164     <span class="keywordflow">case</span> MODE_GET:
00165     <span class="keywordflow">case</span> MODE_GETNEXT:
00166         <span class="comment">/*</span>
00167 <span class="comment">         * return the currend delay time </span>
00168 <span class="comment">         */</span>
00169         <a class="code" href="group__snmp__client.html#ga18">snmp_set_var_typed_value</a>(cache-&gt;requests-&gt;requestvb,
00170                                  ASN_INTEGER,
00171                                  (u_char *) &amp; delay_time,
00172                                  <span class="keyword">sizeof</span>(delay_time));
00173         <span class="keywordflow">break</span>;
00174 
00175     <span class="keywordflow">case</span> MODE_SET_RESERVE1:
00176         <span class="comment">/*</span>
00177 <span class="comment">         * check type </span>
00178 <span class="comment">         */</span>
00179         <span class="keywordflow">if</span> (requests-&gt;<a class="code" href=
"structnetsnmp__request__info__s.html#o0">requestvb</a>-&gt;<a class="code" href=
"structvariable__list.html#o3">type</a> != ASN_INTEGER) {
00180             <span class="comment">/*</span>
00181 <span class="comment">             * not an integer.  Bad dog, no bone. </span>
00182 <span class="comment">             */</span>
00183             <a class="code" href="group__snmp__agent.html#ga79">netsnmp_set_request_error</a>(reqinfo, requests,
00184                                       SNMP_ERR_WRONGTYPE);
00185             <span class="comment">/*</span>
00186 <span class="comment">             * we don't need the cache any longer </span>
00187 <span class="comment">             */</span>
00188             <a class="code" href="group__handler.html#ga25">netsnmp_free_delegated_cache</a>(cache);
00189             <span class="keywordflow">return</span>;
00190         }
00191         <span class="keywordflow">break</span>;
00192 
00193     <span class="keywordflow">case</span> MODE_SET_RESERVE2:
00194         <span class="comment">/*</span>
00195 <span class="comment">         * store old value for UNDO support in the future. </span>
00196 <span class="comment">         */</span>
00197         <a class="code" href="group__util.html#ga5">memdup</a>((u_char **) &amp; delay_time_cache,
00198                (u_char *) &amp; delay_time, <span class="keyword">sizeof</span>(delay_time));
00199 
00200         <span class="comment">/*</span>
00201 <span class="comment">         * malloc failed </span>
00202 <span class="comment">         */</span>
00203         <span class="keywordflow">if</span> (delay_time_cache == NULL) {
00204             <a class="code" href="group__snmp__agent.html#ga79">netsnmp_set_request_error</a>(reqinfo, requests,
00205                                       SNMP_ERR_RESOURCEUNAVAILABLE);
00206             <a class="code" href="group__handler.html#ga25">netsnmp_free_delegated_cache</a>(cache);
00207             <span class="keywordflow">return</span>;
00208         }
00209 
00210         <span class="comment">/*</span>
00211 <span class="comment">         * Add our temporary information to the request itself.</span>
00212 <span class="comment">         * This is then retrivable later.  The free function</span>
00213 <span class="comment">         * passed auto-frees it when the request is later</span>
00214 <span class="comment">         * deleted.  </span>
00215 <span class="comment">         */</span>
00216         <a class="code" href="group__handler.html#ga27">netsnmp_request_add_list_data</a>(requests,
00217                                       netsnmp_create_data_list
00218                                       (DELAYED_INSTANCE_SET_NAME,
00219                                        delay_time_cache, free));
00220         <span class="keywordflow">break</span>;
00221 
00222     <span class="keywordflow">case</span> MODE_SET_ACTION:
00223         <span class="comment">/*</span>
00224 <span class="comment">         * update current value </span>
00225 <span class="comment">         */</span>
00226         delay_time = *(requests-&gt;<a class="code" href=
"structnetsnmp__request__info__s.html#o0">requestvb</a>-&gt;<a class="code" href="structvariable__list.html#o4">val</a>.integer);
00227         DEBUGMSGTL((<span class="stringliteral">"testhandler"</span>, <span class=
"stringliteral">"updated delay_time -&gt; %d\n"</span>,
00228                     delay_time));
00229         <span class="keywordflow">break</span>;
00230 
00231     <span class="keywordflow">case</span> MODE_SET_UNDO:
00232         <span class="comment">/*</span>
00233 <span class="comment">         * ack, something somewhere failed.  We reset back to the</span>
00234 <span class="comment">         * previously old value by extracting the previosuly</span>
00235 <span class="comment">         * stored information back out of the request </span>
00236 <span class="comment">         */</span>
00237         delay_time =
00238             *((u_long *) <a class="code" href="group__handler.html#ga29">netsnmp_request_get_list_data</a>(requests,
00239                                                        DELAYED_INSTANCE_SET_NAME));
00240         <span class="keywordflow">break</span>;
00241 
00242     <span class="keywordflow">case</span> MODE_SET_COMMIT:
00243     <span class="keywordflow">case</span> MODE_SET_FREE:
00244         <span class="comment">/*</span>
00245 <span class="comment">         * the only thing to do here is free the old memdup'ed</span>
00246 <span class="comment">         * value, but it's auto-freed by the datalist recovery, so</span>
00247 <span class="comment">         * we don't have anything to actually do here </span>
00248 <span class="comment">         */</span>
00249         <span class="keywordflow">break</span>;
00250     }
00251 
00252     <span class="comment">/*</span>
00253 <span class="comment">     * free the information cache </span>
00254 <span class="comment">     */</span>
00255     <a class="code" href="group__handler.html#ga25">netsnmp_free_delegated_cache</a>(cache);
00256 }
</pre>
  </div>
  <hr size="1" />

  <address style="align: right;">
    <small><!--#include virtual="/sfbutton.html" --><br />
    Generated on Thu Oct 28 21:46:57 2004 for net-snmp by&nbsp; <a href="http://www.doxygen.org/index.html"><img src=
    "doxygen.png" alt="doxygen" align="middle" border="0" /></a> 1.3.9.1</small>
<!-- CONTENT END -->
<!--#include virtual="/page-bottom.html" -->

