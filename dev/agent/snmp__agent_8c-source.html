<!--#set var="section" value="development" -->
<!--#include virtual="/page-top.html" -->
<!-- CONTENT START -->
  <!-- Generated by Doxygen 1.3.9.1 -->

  <div class="qindex">
    <a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="modules.html">Modules</a> | <a class=
    "qindex" href="annotated.html">Data&nbsp;Structures</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class=
    "qindex" href="functions.html">Data&nbsp;Fields</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a> | <a class=
    "qindex" href="examples.html">Examples</a>
  </div>

  <div class="nav">
    <a class="el" href="dir_000003.html">agent</a>
  </div>

  <h1>snmp_agent.c</h1>

  <div class="fragment">
    <pre class="fragment">
00001 <span class="comment">/*</span>
00002 <span class="comment"> * snmp_agent.c</span>
00003 <span class="comment"> *</span>
00004 <span class="comment"> * Simple Network Management Protocol (RFC 1067).</span>
00005 <span class="comment"> */</span>
00006 <span class="comment">/* Portions of this file are subject to the following copyright(s).  See</span>
00007 <span class="comment"> * the Net-SNMP's COPYING file for more details and other copyrights</span>
00008 <span class="comment"> * that may apply:</span>
00009 <span class="comment"> */</span>
00010 <span class="comment">/* Portions of this file are subject to the following copyrights.  See</span>
00011 <span class="comment"> * the Net-SNMP's COPYING file for more details and other copyrights</span>
00012 <span class="comment"> * that may apply:</span>
00013 <span class="comment"> */</span>
00014 <span class="comment">/***********************************************************</span>
00015 <span class="comment">        Copyright 1988, 1989 by Carnegie Mellon University</span>
00016 
00017 <span class="comment">                      All Rights Reserved</span>
00018 
00019 <span class="comment">Permission to use, copy, modify, and distribute this software and its </span>
00020 <span class="comment">documentation for any purpose and without fee is hereby granted, </span>
00021 <span class="comment">provided that the above copyright notice appear in all copies and that</span>
00022 <span class="comment">both that copyright notice and this permission notice appear in </span>
00023 <span class="comment">supporting documentation, and that the name of CMU not be</span>
00024 <span class="comment">used in advertising or publicity pertaining to distribution of the</span>
00025 <span class="comment">software without specific, written prior permission.  </span>
00026 
00027 <span class="comment">CMU DISCLAIMS ALL WARRANTIES WITH REGARD TO THIS SOFTWARE, INCLUDING</span>
00028 <span class="comment">ALL IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS, IN NO EVENT SHALL</span>
00029 <span class="comment">CMU BE LIABLE FOR ANY SPECIAL, INDIRECT OR CONSEQUENTIAL DAMAGES OR</span>
00030 <span class="comment">ANY DAMAGES WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS,</span>
00031 <span class="comment">WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION,</span>
00032 <span class="comment">ARISING OUT OF OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS</span>
00033 <span class="comment">SOFTWARE.</span>
00034 <span class="comment">******************************************************************/</span>
00035 <span class="comment">/*</span>
00036 <span class="comment"> * Portions of this file are copyrighted by:</span>
00037 <span class="comment"> * Copyright &copy; 2003 Sun Microsystems, Inc. All rights </span>
00038 <span class="comment"> * reserved.  Use is subject to license terms specified in the </span>
00039 <span class="comment"> * COPYING file distributed with the Net-SNMP package.</span>
00040 <span class="comment"> */</span>
00046 <span class="preprocessor">#include &lt;net-snmp/net-snmp-config.h&gt;</span>
00047 
00048 <span class="preprocessor">#include &lt;sys/types.h&gt;</span>
00049 <span class="preprocessor">#ifdef HAVE_LIMITS_H</span>
00050 <span class="preprocessor">#include &lt;limits.h&gt;</span>
00051 <span class="preprocessor">#endif</span>
00052 <span class="preprocessor">#ifdef HAVE_STDLIB_H</span>
00053 <span class="preprocessor">#include &lt;stdlib.h&gt;</span>
00054 <span class="preprocessor">#endif</span>
00055 <span class="preprocessor">#if HAVE_UNISTD_H</span>
00056 <span class="preprocessor">#include &lt;unistd.h&gt;</span>
00057 <span class="preprocessor">#endif</span>
00058 <span class="preprocessor">#if HAVE_STRING_H</span>
00059 <span class="preprocessor">#include &lt;string.h&gt;</span>
00060 <span class="preprocessor">#endif</span>
00061 <span class="preprocessor">#if TIME_WITH_SYS_TIME</span>
00062 <span class="preprocessor"># ifdef WIN32</span>
00063 <span class="preprocessor">#  include &lt;sys/timeb.h&gt;</span>
00064 <span class="preprocessor"># else</span>
00065 <span class="preprocessor">#  include &lt;sys/time.h&gt;</span>
00066 <span class="preprocessor"># endif</span>
00067 <span class="preprocessor"># include &lt;time.h&gt;</span>
00068 <span class="preprocessor">#else</span>
00069 <span class="preprocessor"># if HAVE_SYS_TIME_H</span>
00070 <span class="preprocessor">#  include &lt;sys/time.h&gt;</span>
00071 <span class="preprocessor"># else</span>
00072 <span class="preprocessor">#  include &lt;time.h&gt;</span>
00073 <span class="preprocessor"># endif</span>
00074 <span class="preprocessor">#endif</span>
00075 <span class="preprocessor">#if HAVE_SYS_SELECT_H</span>
00076 <span class="preprocessor">#include &lt;sys/select.h&gt;</span>
00077 <span class="preprocessor">#endif</span>
00078 <span class="preprocessor">#if HAVE_NETINET_IN_H</span>
00079 <span class="preprocessor">#include &lt;netinet/in.h&gt;</span>
00080 <span class="preprocessor">#endif</span>
00081 <span class="preprocessor">#include &lt;errno.h&gt;</span>
00082 <span class="preprocessor">#if HAVE_WINSOCK_H</span>
00083 <span class="preprocessor">#include &lt;winsock.h&gt;</span>
00084 <span class="preprocessor">#endif</span>
00085 
00086 <span class="preprocessor">#define SNMP_NEED_REQUEST_LIST</span>
00087 <span class="preprocessor">#include &lt;net-snmp/net-snmp-includes.h&gt;</span>
00088 <span class="preprocessor">#include &lt;net-snmp/agent/net-snmp-agent-includes.h&gt;</span>
00089 <span class="preprocessor">#include &lt;net-snmp/library/snmp_assert.h&gt;</span>
00090 
00091 <span class="preprocessor">#if HAVE_SYSLOG_H</span>
00092 <span class="preprocessor">#include &lt;syslog.h&gt;</span>
00093 <span class="preprocessor">#endif</span>
00094 
00095 <span class="preprocessor">#ifdef USE_LIBWRAP</span>
00096 <span class="preprocessor">#include &lt;tcpd.h&gt;</span>
00097 <span class="keywordtype">int</span>             allow_severity = LOG_INFO;
00098 <span class="keywordtype">int</span>             deny_severity = LOG_WARNING;
00099 <span class="preprocessor">#endif</span>
00100 
00101 <span class="preprocessor">#include "snmpd.h"</span>
00102 <span class="preprocessor">#include "mibgroup/struct.h"</span>
00103 <span class="preprocessor">#include "mibgroup/util_funcs.h"</span>
00104 <span class="preprocessor">#include &lt;net-snmp/agent/mib_module_config.h&gt;</span>
00105 <span class="preprocessor">#include &lt;net-snmp/agent/mib_modules.h&gt;</span>
00106 
00107 <span class="preprocessor">#ifdef USING_AGENTX_PROTOCOL_MODULE</span>
00108 <span class="preprocessor">#include "agentx/protocol.h"</span>
00109 <span class="preprocessor">#endif</span>
00110 
00111 <span class="preprocessor">#ifdef USING_AGENTX_MASTER_MODULE</span>
00112 <span class="preprocessor">#include "agentx/master.h"</span>
00113 <span class="preprocessor">#endif</span>
00114 
00115 <span class="preprocessor">#ifdef USING_SMUX_MODULE</span>
00116 <span class="preprocessor">#include "smux/smux.h"</span>
00117 <span class="preprocessor">#endif</span>
00118 
00119 oid      version_sysoid[] = { SYSTEM_MIB };
00120 <span class="keywordtype">int</span>      version_sysoid_len = OID_LENGTH(version_sysoid);
00121 
00122 <span class="preprocessor">#define SNMP_ADDRCACHE_SIZE 10</span>
00123 <span class="preprocessor">#define SNMP_ADDRCACHE_MAXAGE 300 </span><span class="comment">/* in seconds */</span>
00124 
00125 <span class="keyword">enum</span> {
00126     SNMP_ADDRCACHE_UNUSED = 0,
00127     SNMP_ADDRCACHE_USED = 1
00128 };
00129 
00130 <span class="keyword">struct </span>addrCache {
00131     <span class="keywordtype">char</span>           *addr;
00132     <span class="keywordtype">int</span>            status;
00133     <span class="keyword">struct </span>timeval lastHit;
00134 };
00135 
00136 <span class="keyword">static</span> <span class="keyword">struct </span>addrCache addrCache[SNMP_ADDRCACHE_SIZE];
00137 <span class="keywordtype">int</span>             log_addresses = 0;
00138 
00139 
00140 
00141 <span class="keyword">typedef</span> <span class="keyword">struct </span>_agent_nsap {
00142     <span class="keywordtype">int</span>             handle;
00143     netsnmp_transport *t;
00144     <span class="keywordtype">void</span>           *s;          <span class=
"comment">/*  Opaque internal session pointer.  */</span>
00145     <span class="keyword">struct </span>_agent_nsap *next;
00146 } agent_nsap;
00147 
00148 <span class="keyword">static</span> agent_nsap *agent_nsap_list = NULL;
00149 <span class="keyword">static</span> netsnmp_agent_session *agent_session_list = NULL;
00150 <span class="keyword">static</span> netsnmp_agent_session *netsnmp_processing_set = NULL;
00151 netsnmp_agent_session *agent_delegated_list = NULL;
00152 netsnmp_agent_session *netsnmp_agent_queued_list = NULL;
00153 
00154 
00155 <span class="keywordtype">int</span>             netsnmp_agent_check_packet(<a class="code" href=
"structsnmp__session.html">netsnmp_session</a> *,
00156                                            <span class="keyword">struct</span> netsnmp_transport_s *,
00157                                            <span class="keywordtype">void</span> *, <span class="keywordtype">int</span>);
00158 <span class="keywordtype">int</span>             netsnmp_agent_check_parse(<a class="code" href=
"structsnmp__session.html">netsnmp_session</a> *, <a class="code" href="structsnmp__pdu.html">netsnmp_pdu</a> *,
00159                                           <span class="keywordtype">int</span>);
00160 <span class="keywordtype">void</span>            delete_subnetsnmp_tree_cache(netsnmp_agent_session *asp);
00161 <span class="keywordtype">int</span>             <a class="code" href=
"group__snmp__agent.html#ga19">handle_pdu</a>(netsnmp_agent_session *asp);
00162 <span class="keywordtype">int</span>             netsnmp_handle_request(netsnmp_agent_session *asp,
00163                                        <span class="keywordtype">int</span> status);
00164 <span class="keywordtype">int</span>             <a class="code" href=
"group__snmp__agent.html#ga21">netsnmp_wrap_up_request</a>(netsnmp_agent_session *asp,
00165                                         <span class="keywordtype">int</span> status);
00166 <span class="keywordtype">int</span>             check_delayed_request(netsnmp_agent_session *asp);
00167 <span class="keywordtype">int</span>             <a class="code" href=
"group__snmp__agent.html#ga23">handle_getnext_loop</a>(netsnmp_agent_session *asp);
00168 <span class="keywordtype">int</span>             handle_set_loop(netsnmp_agent_session *asp);
00169 
00170 <span class="keywordtype">int</span>             netsnmp_check_queued_chain_for(netsnmp_agent_session *asp);
00171 <span class="keywordtype">int</span>             netsnmp_add_queued(netsnmp_agent_session *asp);
00172 <span class="keywordtype">int</span>             netsnmp_remove_from_delegated(netsnmp_agent_session *asp);
00173 
00174 
00175 <span class="keyword">static</span> <span class="keywordtype">int</span>      current_globalid = 0;
00176 
00177 <span class="keywordtype">int</span>      netsnmp_running = 1;
00178 
00179 <span class="keywordtype">int</span>
00180 netsnmp_allocate_globalcacheid(<span class="keywordtype">void</span>)
00181 {
00182     <span class="keywordflow">return</span> ++current_globalid;
00183 }
00184 
00185 <span class="keywordtype">int</span>
00186 netsnmp_get_local_cachid(netsnmp_cachemap *cache_store, <span class="keywordtype">int</span> globalid)
00187 {
00188     <span class="keywordflow">while</span> (cache_store != NULL) {
00189         <span class="keywordflow">if</span> (cache_store-&gt;globalid == globalid)
00190             <span class="keywordflow">return</span> cache_store-&gt;cacheid;
00191         cache_store = cache_store-&gt;next;
00192     }
00193     <span class="keywordflow">return</span> -1;
00194 }
00195 
00196 netsnmp_cachemap *
00197 netsnmp_get_or_add_local_cachid(netsnmp_cachemap **cache_store,
00198                                 <span class="keywordtype">int</span> globalid, <span class=
"keywordtype">int</span> localid)
00199 {
00200     netsnmp_cachemap *tmpp;
00201 
00202     tmpp = <a class="code" href="group__util.html#ga39">SNMP_MALLOC_TYPEDEF</a>(netsnmp_cachemap);
00203     <span class="keywordflow">if</span> (*cache_store) {
00204         tmpp-&gt;next = *cache_store;
00205         *cache_store = tmpp;
00206     } <span class="keywordflow">else</span> {
00207         *cache_store = tmpp;
00208     }
00209 
00210     tmpp-&gt;globalid = globalid;
00211     tmpp-&gt;cacheid = localid;
00212     <span class="keywordflow">return</span> tmpp;
00213 }
00214 
00215 <span class="keywordtype">void</span>
00216 netsnmp_free_cachemap(netsnmp_cachemap *cache_store)
00217 {
00218     netsnmp_cachemap *tmpp;
00219     <span class="keywordflow">while</span> (cache_store) {
00220         tmpp = cache_store;
00221         cache_store = cache_store-&gt;next;
00222         <a class="code" href="group__util.html#ga36">SNMP_FREE</a>(tmpp);
00223     }
00224 }
00225 
00226 
00227 <span class="keyword">typedef</span> <span class="keyword">struct </span>agent_set_cache_s {
00228     <span class="comment">/*</span>
00229 <span class="comment">     * match on these 2 </span>
00230 <span class="comment">     */</span>
00231     <span class="keywordtype">int</span>             transID;
00232     <a class="code" href="structsnmp__session.html">netsnmp_session</a> *sess;
00233 
00234     <span class="comment">/*</span>
00235 <span class="comment">     * store this info </span>
00236 <span class="comment">     */</span>
00237     netsnmp_tree_cache *treecache;
00238     <span class="keywordtype">int</span>             treecache_len;
00239     <span class="keywordtype">int</span>             treecache_num;
00240 
00241     <span class="keywordtype">int</span>             vbcount;
00242     <a class="code" href="structnetsnmp__request__info__s.html">netsnmp_request_info</a> *requests;
00243     <a class="code" href="structvariable__list.html">netsnmp_variable_list</a> *saved_vars;
00244     <a class="code" href="structnetsnmp__data__list__s.html">netsnmp_data_list</a> *agent_data;
00245 
00246     <span class="comment">/*</span>
00247 <span class="comment">     * list </span>
00248 <span class="comment">     */</span>
00249     <span class="keyword">struct </span>agent_set_cache_s *next;
00250 } agent_set_cache;
00251 
00252 <span class="keyword">static</span> agent_set_cache *Sets = NULL;
00253 
00254 agent_set_cache *
00255 save_set_cache(netsnmp_agent_session *asp)
00256 {
00257     agent_set_cache *ptr;
00258 
00259     <span class="keywordflow">if</span> (!asp || !asp-&gt;reqinfo || !asp-&gt;pdu)
00260         <span class="keywordflow">return</span> NULL;
00261 
00262     ptr = <a class="code" href="group__util.html#ga39">SNMP_MALLOC_TYPEDEF</a>(agent_set_cache);
00263     <span class="keywordflow">if</span> (ptr == NULL)
00264         <span class="keywordflow">return</span> NULL;
00265 
00266     <span class="comment">/*</span>
00267 <span class="comment">     * Save the important information </span>
00268 <span class="comment">     */</span>
00269     DEBUGMSGTL((<span class="stringliteral">"verbose:asp"</span>, <span class=
"stringliteral">"asp %p reqinfo %p saved in cache (mode %d)\n"</span>,
00270                 asp, asp-&gt;reqinfo, asp-&gt;pdu-&gt;command));
00271     ptr-&gt;transID = asp-&gt;pdu-&gt;transid;
00272     ptr-&gt;sess = asp-&gt;session;
00273     ptr-&gt;treecache = asp-&gt;treecache;
00274     ptr-&gt;treecache_len = asp-&gt;treecache_len;
00275     ptr-&gt;treecache_num = asp-&gt;treecache_num;
00276     ptr-&gt;agent_data = asp-&gt;reqinfo-&gt;agent_data;
00277     ptr-&gt;requests = asp-&gt;requests;
00278     ptr-&gt;saved_vars = asp-&gt;pdu-&gt;variables; <span class=
"comment">/* requests contains pointers to variables */</span>
00279     ptr-&gt;vbcount = asp-&gt;vbcount;
00280 
00281     <span class="comment">/*</span>
00282 <span class="comment">     * make the agent forget about what we've saved </span>
00283 <span class="comment">     */</span>
00284     asp-&gt;treecache = NULL;
00285     asp-&gt;reqinfo-&gt;agent_data = NULL;
00286     asp-&gt;pdu-&gt;variables = NULL;
00287     asp-&gt;requests = NULL;
00288 
00289     ptr-&gt;next = Sets;
00290     Sets = ptr;
00291 
00292     <span class="keywordflow">return</span> ptr;
00293 }
00294 
00295 <span class="keywordtype">int</span>
00296 get_set_cache(netsnmp_agent_session *asp)
00297 {
00298     agent_set_cache *ptr, *prev = NULL;
00299 
00300     <span class="keywordflow">for</span> (ptr = Sets; ptr != NULL; ptr = ptr-&gt;next) {
00301         <span class=
"keywordflow">if</span> (ptr-&gt;sess == asp-&gt;session &amp;&amp; ptr-&gt;transID == asp-&gt;pdu-&gt;transid) {
00302             <span class="comment">/*</span>
00303 <span class="comment">             * remove this item from list</span>
00304 <span class="comment">             */</span>
00305             <span class="keywordflow">if</span> (prev)
00306                 prev-&gt;next = ptr-&gt;next;
00307             <span class="keywordflow">else</span>
00308                 Sets = ptr-&gt;next;
00309 
00310             <span class="comment">/*</span>
00311 <span class="comment">             * found it.  Get the needed data </span>
00312 <span class="comment">             */</span>
00313             asp-&gt;treecache = ptr-&gt;treecache;
00314             asp-&gt;treecache_len = ptr-&gt;treecache_len;
00315             asp-&gt;treecache_num = ptr-&gt;treecache_num;
00316 
00317             <span class="comment">/*</span>
00318 <span class="comment">             * Free previously allocated requests before overwriting by</span>
00319 <span class="comment">             * cached ones, otherwise memory leaks!</span>
00320 <span class="comment">             */</span>
00321             <span class="keywordflow">if</span> (asp-&gt;requests) {
00322                 <span class="comment">/*</span>
00323 <span class="comment">                 * I don't think this case should ever happen. Please email</span>
00324 <span class="comment">                 * the net-snmp-coders@lists.sourceforge.net if you have</span>
00325 <span class="comment">                 * a test case that hits this assert. -- rstory</span>
00326 <span class="comment">                 */</span>
00327                 <span class="keywordtype">int</span> i;
00328                 netsnmp_assert(NULL == asp-&gt;requests); <span class="comment">/* see note above */</span>
00329                 <span class="keywordflow">for</span> (i = 0; i &lt; asp-&gt;vbcount; i++) {
00330                     <a class="code" href=
"group__handler.html#ga31">netsnmp_free_request_data_sets</a>(&amp;asp-&gt;requests[i]);
00331                 }
00332                 free(asp-&gt;requests);
00333             }
00334             <span class="comment">/*</span>
00335 <span class="comment">             * If we replace asp-&gt;requests with the info from the set cache,</span>
00336 <span class="comment">             * we should replace asp-&gt;pdu-&gt;variables also with the cached</span>
00337 <span class="comment">             * info, as asp-&gt;requests contains pointers to them.  And we</span>
00338 <span class="comment">             * should also free the current asp-&gt;pdu-&gt;variables list...</span>
00339 <span class="comment">             */</span>
00340             <span class="keywordflow">if</span> (ptr-&gt;saved_vars) {
00341                 <span class="keywordflow">if</span> (asp-&gt;pdu-&gt;variables)
00342                     snmp_free_varbind(asp-&gt;pdu-&gt;variables);
00343                 asp-&gt;pdu-&gt;variables = ptr-&gt;saved_vars;
00344                 asp-&gt;vbcount = ptr-&gt;vbcount;
00345             } <span class="keywordflow">else</span> {
00346                 <span class="comment">/*</span>
00347 <span class="comment">                 * when would we not have saved variables? someone</span>
00348 <span class="comment">                 * let me know if they hit this assert. -- rstory</span>
00349 <span class="comment">                 */</span>
00350                 netsnmp_assert(NULL != ptr-&gt;saved_vars);
00351             }
00352             asp-&gt;requests = ptr-&gt;requests;
00353 
00354             netsnmp_assert(NULL != asp-&gt;reqinfo);
00355             asp-&gt;reqinfo-&gt;asp = asp;
00356             asp-&gt;reqinfo-&gt;agent_data = ptr-&gt;agent_data;
00357             
00358             <span class="comment">/*</span>
00359 <span class="comment">             * update request reqinfo, if it's out of date.</span>
00360 <span class="comment">             * yyy-rks: investigate when/why sometimes they match,</span>
00361 <span class="comment">             * sometimes they don't.</span>
00362 <span class="comment">             */</span>
00363             <span class="keywordflow">if</span>(asp-&gt;requests-&gt;agent_req_info != asp-&gt;reqinfo) {
00364                 <span class="comment">/*</span>
00365 <span class="comment">                 * - one don't match case: agentx subagents. prev asp &amp; reqinfo</span>
00366 <span class="comment">                 *   freed, request reqinfo ptrs not cleared.</span>
00367 <span class="comment">                 */</span>
00368                 <a class="code" href=
"structnetsnmp__request__info__s.html">netsnmp_request_info</a> *tmp = asp-&gt;requests;
00369                 DEBUGMSGTL((<span class="stringliteral">"verbose:asp"</span>,
00370                             <span class="stringliteral">"  reqinfo %p doesn't match cached reqinfo %p\n"</span>,
00371                             asp-&gt;reqinfo, asp-&gt;requests-&gt;agent_req_info));
00372                 <span class="keywordflow">for</span>(; tmp; tmp = tmp-&gt;<a class="code" href=
"structnetsnmp__request__info__s.html#o13">next</a>)
00373                     tmp-&gt;<a class="code" href=
"structnetsnmp__request__info__s.html#o2">agent_req_info</a> = asp-&gt;reqinfo;
00374             } <span class="keywordflow">else</span> {
00375                 <span class="comment">/*</span>
00376 <span class="comment">                 * - match case: ?</span>
00377 <span class="comment">                 */</span>
00378                 DEBUGMSGTL((<span class="stringliteral">"verbose:asp"</span>,
00379                             <span class="stringliteral">"  reqinfo %p matches cached reqinfo %p\n"</span>,
00380                             asp-&gt;reqinfo, asp-&gt;requests-&gt;agent_req_info));
00381             }
00382 
00383             <a class="code" href="group__util.html#ga36">SNMP_FREE</a>(ptr);
00384             <span class="keywordflow">return</span> SNMP_ERR_NOERROR;
00385         }
00386         prev = ptr;
00387     }
00388     <span class="keywordflow">return</span> SNMP_ERR_GENERR;
00389 }
00390 
00391 <span class="comment">/* Bulkcache holds the values for the *repeating* varbinds (only),</span>
00392 <span class="comment"> *   but ordered "by column" - i.e. the repetitions for each</span>
00393 <span class="comment"> *   repeating varbind follow on immediately from one another,</span>
00394 <span class="comment"> *   rather than being interleaved, as required by the protocol.</span>
00395 <span class="comment"> *</span>
00396 <span class="comment"> * So we need to rearrange the varbind list so it's ordered "by row".</span>
00397 <span class="comment"> *</span>
00398 <span class="comment"> * In the following code chunk:</span>
00399 <span class="comment"> *     n            = # non-repeating varbinds</span>
00400 <span class="comment"> *     r            = # repeating varbinds</span>
00401 <span class="comment"> *     asp-&gt;vbcount = # varbinds in the incoming PDU</span>
00402 <span class="comment"> *         (So asp-&gt;vbcount = n+r)</span>
00403 <span class="comment"> *</span>
00404 <span class="comment"> *     repeats = Desired # of repetitions (of 'r' varbinds)</span>
00405 <span class="comment"> */</span>
00406 NETSNMP_STATIC_INLINE <span class="keywordtype">void</span>
00407 _reorder_getbulk(netsnmp_agent_session *asp)
00408 {
00409     <span class="keywordtype">int</span>             i, n = 0, r = 0;
00410     <span class="keywordtype">int</span>             repeats = asp-&gt;pdu-&gt;errindex;
00411     <span class="keywordtype">int</span>             j;
00412     <span class="keywordtype">int</span>             all_eoMib;
00413     <a class="code" href="structvariable__list.html">netsnmp_variable_list</a> *prev = NULL;
00414             
00415     <span class="keywordflow">if</span> (asp-&gt;vbcount == 0)  <span class="comment">/* Nothing to do! */</span>
00416         <span class="keywordflow">return</span>;
00417 
00418     <span class="keywordflow">if</span> (asp-&gt;pdu-&gt;errstat &lt; asp-&gt;vbcount) {
00419         n = asp-&gt;pdu-&gt;errstat;
00420     } <span class="keywordflow">else</span> {
00421         n = asp-&gt;vbcount;
00422     }
00423     <span class="keywordflow">if</span> ((r = asp-&gt;vbcount - n) &lt; 0) {
00424         r = 0;
00425     }
00426 
00427     <span class="comment">/* we do nothing if there is nothing repeated */</span>
00428     <span class="keywordflow">if</span> (r == 0)
00429         <span class="keywordflow">return</span>;
00430             
00431     <span class="comment">/*</span>
00432 <span class="comment">     * For each of the original repeating varbinds (except the last),</span>
00433 <span class="comment">     *  go through the block of results for that varbind,</span>
00434 <span class="comment">     *  and link each instance to the corresponding instance</span>
00435 <span class="comment">     *  in the next block.</span>
00436 <span class="comment">     */</span>
00437     <span class="keywordflow">for</span> (i = 0; i &lt; r - 1; i++) {
00438         prev = NULL;
00439         <span class="keywordflow">for</span> (j = 0; j &lt; repeats; j++) {
00440             <span class="comment">/*</span>
00441 <span class="comment">             *  If we don't have a valid name for a given repetition</span>
00442 <span class="comment">             *   (and probably for all the ones that follow as well),</span>
00443 <span class="comment">             *   extend the previous result to indicate 'endOfMibView'</span>
00444 <span class="comment">             */</span>
00445             <span class="keywordflow">if</span> (asp-&gt;bulkcache[i * repeats + j]-&gt;name_length == 0
00446                 &amp;&amp; prev) {
00447                 snmp_set_var_objid(
00448                     asp-&gt;bulkcache[i * repeats + j],
00449                     prev-&gt;<a class="code" href="structvariable__list.html#o1">name</a>, prev-&gt;<a class="code" href=
"structvariable__list.html#o2">name_length</a>);
00450                 <a class="code" href="group__snmp__client.html#ga19">snmp_set_var_typed_value</a>(
00451                     asp-&gt;bulkcache[i * repeats + j],
00452                     SNMP_ENDOFMIBVIEW, NULL, 0);
00453             }
00454             prev = asp-&gt;bulkcache[i * repeats + j];
00455 
00456             asp-&gt;bulkcache[i * repeats + j]-&gt;<a class="code" href="structvariable__list.html#o0">next_variable</a> =
00457                 asp-&gt;bulkcache[(i + 1) * repeats + j];
00458         }
00459     }
00460     <span class="comment">/*</span>
00461 <span class="comment">     * For the last of the original repeating varbinds,</span>
00462 <span class="comment">     *  go through that block of results, and link each</span>
00463 <span class="comment">     *  instance to the *next* instance in the *first* block.</span>
00464 <span class="comment">     *</span>
00465 <span class="comment">     * The very last instance of this block is left untouched</span>
00466 <span class="comment">     *  since it (correctly) points to the end of the list.</span>
00467 <span class="comment">     */</span>
00468     <span class="keywordflow">if</span> (r &gt; 0) {
00469         prev = NULL;
00470         <span class="keywordflow">for</span> (j = 0; j &lt; repeats - 1; j++) {
00471             <span class="comment">/*</span>
00472 <span class="comment">             *  Fill in missing names with 'endOfMibView' as above...</span>
00473 <span class="comment">             */</span>
00474             <span class="keywordflow">if</span> (asp-&gt;bulkcache[(r - 1) * repeats + j]-&gt;name_length == 0
00475                 &amp;&amp; prev) {
00476                 snmp_set_var_objid(
00477                     asp-&gt;bulkcache[(r - 1) * repeats + j],
00478                     prev-&gt;<a class="code" href="structvariable__list.html#o1">name</a>, prev-&gt;<a class="code" href=
"structvariable__list.html#o2">name_length</a>);
00479                 <a class="code" href="group__snmp__client.html#ga19">snmp_set_var_typed_value</a>(
00480                     asp-&gt;bulkcache[(r - 1) * repeats + j],
00481                     SNMP_ENDOFMIBVIEW, NULL, 0);
00482             }
00483             prev = asp-&gt;bulkcache[(r - 1) * repeats + j];
00484             asp-&gt;bulkcache[(r - 1) * repeats + j]-&gt;<a class="code" href=
"structvariable__list.html#o0">next_variable</a> =
00485                 asp-&gt;bulkcache[j + 1];
00486         }
00487         <span class="comment">/*</span>
00488 <span class="comment">         *  ... Not forgetting the very last entry</span>
00489 <span class="comment">         */</span>
00490         <span class="keywordflow">if</span> (asp-&gt;bulkcache[r * repeats - 1]-&gt;name_length == 0
00491             &amp;&amp; prev) {
00492             snmp_set_var_objid(
00493                 asp-&gt;bulkcache[r * repeats - 1],
00494                 prev-&gt;<a class="code" href="structvariable__list.html#o1">name</a>, prev-&gt;<a class="code" href=
"structvariable__list.html#o2">name_length</a>);
00495             <a class="code" href="group__snmp__client.html#ga19">snmp_set_var_typed_value</a>(
00496                 asp-&gt;bulkcache[r * repeats - 1],
00497                 SNMP_ENDOFMIBVIEW, NULL, 0);
00498         }
00499     }
00500 
00501     <span class="comment">/*</span>
00502 <span class="comment">     * If we've got a full row of endOfMibViews, then we</span>
00503 <span class="comment">     *  can truncate the result varbind list after that.</span>
00504 <span class="comment">     *</span>
00505 <span class="comment">     * Look for endOfMibView exception values in the list of</span>
00506 <span class="comment">     *  repetitions for the first varbind, and check the </span>
00507 <span class="comment">     *  corresponding instances for the other varbinds</span>
00508 <span class="comment">     *  (following the next_variable links).</span>
00509 <span class="comment">     *</span>
00510 <span class="comment">     * If they're all endOfMibView too, then we can terminate</span>
00511 <span class="comment">     *  the linked list there, and free any redundant varbinds.</span>
00512 <span class="comment">     */</span>
00513     all_eoMib = 0;
00514     <span class="keywordflow">for</span> (i = 0; i &lt; repeats; i++) {
00515         <span class="keywordflow">if</span> (asp-&gt;bulkcache[i]-&gt;type == SNMP_ENDOFMIBVIEW) {
00516             all_eoMib = 1;
00517             <span class="keywordflow">for</span> (j = 1, prev=asp-&gt;bulkcache[i];
00518                  j &lt; r;
00519                  j++, prev=prev-&gt;<a class="code" href="structvariable__list.html#o0">next_variable</a>) {
00520                 <span class="keywordflow">if</span> (prev-&gt;type != SNMP_ENDOFMIBVIEW) {
00521                     all_eoMib = 0;
00522                     <span class="keywordflow">break</span>;      <span class="comment">/* Found a real value */</span>
00523                 }
00524             }
00525             <span class="keywordflow">if</span> (all_eoMib) {
00526                 <span class="comment">/*</span>
00527 <span class="comment">                 * This is indeed a full endOfMibView row.</span>
00528 <span class="comment">                 * Terminate the list here &amp; free the rest.</span>
00529 <span class="comment">                 */</span>
00530                 snmp_free_varbind( prev-&gt;next_variable );
00531                 prev-&gt;<a class="code" href="structvariable__list.html#o0">next_variable</a> = NULL;
00532                 <span class="keywordflow">break</span>;
00533             }
00534         }
00535     }
00536 }
00537 
00538 
00539 <span class="keywordtype">int</span>
00540 getNextSessID()
00541 {
00542     <span class="keyword">static</span> <span class="keywordtype">int</span>      SessionID = 0;
00543 
00544     <span class="keywordflow">return</span> ++SessionID;
00545 }
00546 
00559 <span class="keywordtype">int</span>
<a name="l00560" id="l00560"></a><a class="code" href="group__snmp__agent.html#ga36">00560</a> <a class="code" href=
"group__snmp__agent.html#ga36">agent_check_and_process</a>(<span class="keywordtype">int</span> block)
00561 {
00562     <span class="keywordtype">int</span>             numfds;
00563     fd_set          fdset;
00564     <span class="keyword">struct </span>timeval  timeout = { LONG_MAX, 0 }, *tvp = &amp;timeout;
00565     <span class="keywordtype">int</span>             count;
00566     <span class="keywordtype">int</span>             fakeblock = 0;
00567 
00568     numfds = 0;
00569     FD_ZERO(&amp;fdset);
00570     snmp_select_info(&amp;numfds, &amp;fdset, tvp, &amp;fakeblock);
00571     <span class="keywordflow">if</span> (block != 0 &amp;&amp; fakeblock != 0) {
00572         <span class="comment">/*</span>
00573 <span class="comment">         * There are no alarms registered, and the caller asked for blocking, so</span>
00574 <span class="comment">         * let select() block forever.  </span>
00575 <span class="comment">         */</span>
00576 
00577         tvp = NULL;
00578     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (block != 0 &amp;&amp; fakeblock == 0) {
00579         <span class="comment">/*</span>
00580 <span class="comment">         * The caller asked for blocking, but there is an alarm due sooner than</span>
00581 <span class="comment">         * LONG_MAX seconds from now, so use the modified timeout returned by</span>
00582 <span class="comment">         * snmp_select_info as the timeout for select().  </span>
00583 <span class="comment">         */</span>
00584 
00585     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (block == 0) {
00586         <span class="comment">/*</span>
00587 <span class="comment">         * The caller does not want us to block at all.  </span>
00588 <span class="comment">         */</span>
00589 
00590         tvp-&gt;tv_sec = 0;
00591         tvp-&gt;tv_usec = 0;
00592     }
00593 
00594     count = select(numfds, &amp;fdset, 0, 0, tvp);
00595 
00596     <span class="keywordflow">if</span> (count &gt; 0) {
00597         <span class="comment">/*</span>
00598 <span class="comment">         * packets found, process them </span>
00599 <span class="comment">         */</span>
00600         snmp_read(&amp;fdset);
00601     } <span class="keywordflow">else</span>
00602         <span class="keywordflow">switch</span> (count) {
00603         <span class="keywordflow">case</span> 0:
00604             snmp_timeout();
00605             <span class="keywordflow">break</span>;
00606         <span class="keywordflow">case</span> -1:
00607             <span class="keywordflow">if</span> (errno != EINTR) {
00608                 snmp_log_perror(<span class="stringliteral">"select"</span>);
00609             }
00610             <span class="keywordflow">return</span> -1;
00611         <span class="keywordflow">default</span>:
00612             <a class="code" href="group__snmp__logging.html#ga41">snmp_log</a>(LOG_ERR, <span class=
"stringliteral">"select returned %d\n"</span>, count);
00613             <span class="keywordflow">return</span> -1;
00614         }                       <span class="comment">/* endif -- count&gt;0 */</span>
00615 
00616     <span class="comment">/*</span>
00617 <span class="comment">     * Run requested alarms.  </span>
00618 <span class="comment">     */</span>
00619     run_alarms();
00620 
00621     netsnmp_check_outstanding_agent_requests();
00622 
00623     <span class="keywordflow">return</span> count;
00624 }
00625 
00626 
00627 <span class="comment">/*</span>
00628 <span class="comment"> * Set up the address cache.  </span>
00629 <span class="comment"> */</span>
00630 <span class="keywordtype">void</span>
00631 netsnmp_addrcache_initialise(<span class="keywordtype">void</span>)
00632 {
00633     <span class="keywordtype">int</span>             i = 0;
00634 
00635     <span class="keywordflow">for</span> (i = 0; i &lt; SNMP_ADDRCACHE_SIZE; i++) {
00636         addrCache[i].addr = NULL;
00637         addrCache[i].status = SNMP_ADDRCACHE_UNUSED;
00638     }
00639 }
00640 
00641 <span class="comment">/*</span>
00642 <span class="comment"> * Adds a new entry to the cache of addresses that</span>
00643 <span class="comment"> * have recently made connections to the agent.</span>
00644 <span class="comment"> * Returns 0 if the entry already exists (but updates</span>
00645 <span class="comment"> * the entry with a new timestamp) and 1 if the</span>
00646 <span class="comment"> * entry did not previously exist.</span>
00647 <span class="comment"> *</span>
00648 <span class="comment"> * Implements a simple LRU cache replacement</span>
00649 <span class="comment"> * policy. Uses a linear search, which should be</span>
00650 <span class="comment"> * okay, as long as SNMP_ADDRCACHE_SIZE remains</span>
00651 <span class="comment"> * relatively small.</span>
00652 <span class="comment"> *</span>
00653 <span class="comment"> * @retval 0 : updated existing entry</span>
00654 <span class="comment"> * @retval 1 : added new entry</span>
00655 <span class="comment"> */</span>
00656 <span class="keywordtype">int</span>
00657 netsnmp_addrcache_add(<span class="keyword">const</span> <span class="keywordtype">char</span> *addr)
00658 {
00659     <span class="keywordtype">int</span> oldest = -1; <span class="comment">/* Index of the oldest cache entry */</span>
00660     <span class="keywordtype">int</span> unused = -1; <span class=
"comment">/* Index of the first free cache entry */</span>
00661     <span class="keywordtype">int</span> i; <span class="comment">/* Looping variable */</span>
00662     <span class="keywordtype">int</span> rc = -1;
00663     <span class="keyword">struct </span>timeval now; <span class="comment">/* What time is it now? */</span>
00664     <span class="keyword">struct </span>timeval aged; <span class="comment">/* Oldest allowable cache entry */</span>
00665 
00666     <span class="comment">/*</span>
00667 <span class="comment">     * First get the current and oldest allowable timestamps</span>
00668 <span class="comment">     */</span>
00669     gettimeofday(&amp;now, (<span class="keyword">struct</span> timezone*) NULL);
00670     aged.tv_sec = now.tv_sec - SNMP_ADDRCACHE_MAXAGE;
00671     aged.tv_usec = now.tv_usec;
00672 
00673     <span class="comment">/*</span>
00674 <span class="comment">     * Now look for a place to put this thing</span>
00675 <span class="comment">     */</span>
00676     <span class="keywordflow">for</span>(i = 0; i &lt; SNMP_ADDRCACHE_SIZE; i++) {
00677         <span class="keywordflow">if</span> (addrCache[i].status == SNMP_ADDRCACHE_UNUSED) { <span class=
"comment">/* If unused */</span>
00678             <span class="comment">/*</span>
00679 <span class="comment">             * remember this location, in case addr isn't in the cache</span>
00680 <span class="comment">             */</span>
00681             <span class="keywordflow">if</span> (unused &lt; 0)
00682                 unused = i;
00683         }
00684         <span class="keywordflow">else</span> { <span class="comment">/* If used */</span>
00685             <span class="keywordflow">if</span> ((NULL != addr) &amp;&amp; (strcmp(addrCache[i].addr, addr) == 0)) {
00686                 <span class="comment">/*</span>
00687 <span class="comment">                 * found a match</span>
00688 <span class="comment">                 */</span>
00689                 memcpy(&amp;addrCache[i].lastHit, &amp;now, <span class="keyword">sizeof</span>(<span class=
"keyword">struct</span> timeval));
00690                 <span class="keywordflow">if</span> (timercmp(&amp;addrCache[i].lastHit, &amp;aged, &lt;))
00691                     rc = 1; <span class="comment">/* should have expired, so is new */</span>
00692                 <span class="keywordflow">else</span>
00693                     rc = 0; <span class="comment">/* not expired, so is existing entry */</span>
00694                 <span class="keywordflow">break</span>;
00695             }
00696             <span class="keywordflow">else</span> {
00697                 <span class="comment">/*</span>
00698 <span class="comment">                 * Used, but not this address. check if it's stale.</span>
00699 <span class="comment">                 */</span>
00700                 <span class="keywordflow">if</span> (timercmp(&amp;addrCache[i].lastHit, &amp;aged, &lt;)) {
00701                     <span class="comment">/*</span>
00702 <span class="comment">                     * Stale, reuse</span>
00703 <span class="comment">                     */</span>
00704                     <a class="code" href="group__util.html#ga36">SNMP_FREE</a>(addrCache[i].addr);
00705                     addrCache[i].status = SNMP_ADDRCACHE_UNUSED;
00706                     <span class="comment">/*</span>
00707 <span class="comment">                     * remember this location, in case addr isn't in the cache</span>
00708 <span class="comment">                     */</span>
00709                     <span class="keywordflow">if</span> (unused &lt; 0)
00710                         unused = i;
00711                 }
00712                 <span class="keywordflow">else</span> {
00713                     <span class="comment">/*</span>
00714 <span class="comment">                     * Still fresh, but a candidate for LRU replacement</span>
00715 <span class="comment">                     */</span>
00716                     <span class="keywordflow">if</span> (oldest &lt; 0)
00717                         oldest = i;
00718                     <span class="keywordflow">else</span> <span class=
"keywordflow">if</span> (timercmp(&amp;addrCache[i].lastHit,
00719                                       &amp;addrCache[oldest].lastHit, &lt;))
00720                         oldest = i;
00721                 } <span class="comment">/* fresh */</span>
00722             } <span class="comment">/* used, no match */</span>
00723         } <span class="comment">/* used */</span>
00724     } <span class="comment">/* for loop */</span>
00725 
00726     <span class="keywordflow">if</span> ((-1 == rc) &amp;&amp; (NULL != addr)) {
00727         <span class="comment">/*</span>
00728 <span class="comment">         * We didn't find the entry in the cache</span>
00729 <span class="comment">         */</span>
00730         <span class="keywordflow">if</span> (unused &gt;= 0) {
00731             <span class="comment">/*</span>
00732 <span class="comment">             * If we have a slot free anyway, use it</span>
00733 <span class="comment">             */</span>
00734             addrCache[unused].addr = strdup(addr);
00735             addrCache[unused].status = SNMP_ADDRCACHE_USED;
00736             memcpy(&amp;addrCache[unused].lastHit, &amp;now, <span class="keyword">sizeof</span>(<span class=
"keyword">struct</span> timeval));
00737         }
00738         <span class="keywordflow">else</span> { <span class="comment">/* Otherwise, replace oldest entry */</span>
00739             <span class="keywordflow">if</span> (netsnmp_ds_get_boolean(NETSNMP_DS_APPLICATION_ID,
00740                                        NETSNMP_DS_AGENT_VERBOSE))
00741                 <a class="code" href="group__snmp__logging.html#ga41">snmp_log</a>(LOG_INFO, <span class=
"stringliteral">"Purging address from address cache: %s"</span>,
00742                          addrCache[oldest].addr);
00743             
00744             free(addrCache[oldest].addr);
00745             addrCache[oldest].addr = strdup(addr);
00746             memcpy(&amp;addrCache[oldest].lastHit, &amp;now, <span class="keyword">sizeof</span>(<span class=
"keyword">struct</span> timeval));
00747         }
00748         rc = 1;
00749     }
00750     <span class="keywordflow">if</span> ((log_addresses &amp;&amp; (1 == rc)) ||
00751         netsnmp_ds_get_boolean(NETSNMP_DS_APPLICATION_ID,
00752                                NETSNMP_DS_AGENT_VERBOSE)) {
00753         <a class="code" href="group__snmp__logging.html#ga41">snmp_log</a>(LOG_INFO, <span class=
"stringliteral">"Received SNMP packet(s) from %s\n"</span>, addr);
00754      }
00755 
00756     <span class="keywordflow">return</span> rc;
00757 }
00758 
00759 <span class="comment">/*</span>
00760 <span class="comment"> * Age the entries in the address cache.  </span>
00761 <span class="comment"> *</span>
00762 <span class="comment"> * backwards compatability; not used anywhere</span>
00763 <span class="comment"> */</span>
00764 <span class="keywordtype">void</span>
00765 netsnmp_addrcache_age(<span class="keywordtype">void</span>)
00766 {
00767     (void)netsnmp_addrcache_add(NULL);
00768 }
00769 
00770 <span class="comment">/*******************************************************************-o-******</span>
00771 <span class="comment"> * netsnmp_agent_check_packet</span>
00772 <span class="comment"> *</span>
00773 <span class="comment"> * Parameters:</span>
00774 <span class="comment"> *      session, transport, transport_data, transport_data_length</span>
00775 <span class="comment"> *      </span>
00776 <span class="comment"> * Returns:</span>
00777 <span class="comment"> *      1       On success.</span>
00778 <span class="comment"> *      0       On error.</span>
00779 <span class="comment"> *</span>
00780 <span class="comment"> * Handler for all incoming messages (a.k.a. packets) for the agent.  If using</span>
00781 <span class="comment"> * the libwrap utility, log the connection and deny/allow the access. Print</span>
00782 <span class="comment"> * output when appropriate, and increment the incoming counter.</span>
00783 <span class="comment"> *</span>
00784 <span class="comment"> */</span>
00785 
00786 <span class="keywordtype">int</span>
00787 netsnmp_agent_check_packet(<a class="code" href="structsnmp__session.html">netsnmp_session</a> * session,
00788                            netsnmp_transport *transport,
00789                            <span class="keywordtype">void</span> *transport_data, <span class=
"keywordtype">int</span> transport_data_length)
00790 {
00791     <span class="keywordtype">char</span>           *addr_string = NULL;
00792 <span class="preprocessor">#ifdef  USE_LIBWRAP</span>
00793     <span class="keywordtype">char</span> *tcpudpaddr, *name;
00794 
00795     name = netsnmp_ds_get_string(NETSNMP_DS_LIBRARY_ID, 
00796                                  NETSNMP_DS_LIB_APPTYPE);
00797 <span class="preprocessor">#endif</span>
00798 
00799     <span class="comment">/*</span>
00800 <span class="comment">     * Log the message and/or dump the message.</span>
00801 <span class="comment">     * Optionally cache the network address of the sender.</span>
00802 <span class="comment">     */</span>
00803 
00804     <span class="keywordflow">if</span> (transport != NULL &amp;&amp; transport-&gt;f_fmtaddr != NULL) {
00805         <span class="comment">/*</span>
00806 <span class="comment">         * Okay I do know how to format this address for logging.  </span>
00807 <span class="comment">         */</span>
00808         addr_string = transport-&gt;f_fmtaddr(transport, transport_data,
00809                                            transport_data_length);
00810         <span class="comment">/*</span>
00811 <span class="comment">         * Don't forget to free() it.  </span>
00812 <span class="comment">         */</span>
00813     }
00814 <span class="preprocessor">#ifdef  USE_LIBWRAP</span>
00815     <span class="comment">/* Catch udp,udp6,tcp,tcp6 transports using "[" */</span>
00816     tcpudpaddr = strstr(addr_string, <span class="stringliteral">"["</span>);
00817     <span class="keywordflow">if</span> ( tcpudpaddr != 0 ) {
00818         <span class="keywordtype">char</span> sbuf[64];
00819         <span class="keywordtype">char</span> *xp;
00820         strncpy(sbuf, tcpudpaddr + 1, <span class="keyword">sizeof</span>(sbuf));
00821         sbuf[<span class="keyword">sizeof</span>(sbuf)-1] = <span class="charliteral">'\0'</span>;
00822         xp = strstr(sbuf, <span class="stringliteral">"]"</span>);
00823         <span class="keywordflow">if</span> (xp)
00824             *xp = <span class="charliteral">'\0'</span>;
00825  
00826         <span class="keywordflow">if</span> (hosts_ctl(name, STRING_UNKNOWN, sbuf, STRING_UNKNOWN)) {
00827             <a class="code" href="group__snmp__logging.html#ga41">snmp_log</a>(allow_severity, <span class=
"stringliteral">"Connection from %s\n"</span>, addr_string);
00828         } <span class="keywordflow">else</span> {
00829             <a class="code" href="group__snmp__logging.html#ga41">snmp_log</a>(deny_severity, <span class=
"stringliteral">"Connection from %s REFUSED\n"</span>,
00830                      addr_string);
00831             <a class="code" href="group__util.html#ga36">SNMP_FREE</a>(addr_string);
00832             <span class="keywordflow">return</span> 0;
00833         }
00834     } <span class="keywordflow">else</span> {
00835         <span class="comment">/*</span>
00836 <span class="comment">         * don't log callback connections.</span>
00837 <span class="comment">         * What about 'Local IPC', 'IPX' and 'AAL5 PVC'?</span>
00838 <span class="comment">         */</span>
00839         <span class="keywordflow">if</span> (0 == strncmp(addr_string, <span class="stringliteral">"callback"</span>, 8))
00840             ;
00841         <span class="keywordflow">else</span> <span class=
"keywordflow">if</span> (hosts_ctl(name, STRING_UNKNOWN, STRING_UNKNOWN, STRING_UNKNOWN)){
00842             <a class="code" href="group__snmp__logging.html#ga41">snmp_log</a>(allow_severity, <span class=
"stringliteral">"Connection from &lt;UNKNOWN&gt; (%s)\n"</span>, addr_string);
00843             addr_string = strdup(<span class="stringliteral">"&lt;UNKNOWN&gt;"</span>);
00844         } <span class="keywordflow">else</span> {
00845             <a class="code" href="group__snmp__logging.html#ga41">snmp_log</a>(deny_severity, <span class=
"stringliteral">"Connection from &lt;UNKNOWN&gt; (%s) REFUSED\n"</span>, addr_string);
00846             <span class="keywordflow">return</span> 0;
00847         }
00848     }
00849 <span class="preprocessor">#endif                          </span><span class="comment">/*USE_LIBWRAP */</span>
00850 
00851     snmp_increment_statistic(STAT_SNMPINPKTS);
00852 
00853     <span class="keywordflow">if</span> (addr_string != NULL) {
00854         netsnmp_addrcache_add(addr_string);
00855         <a class="code" href="group__util.html#ga36">SNMP_FREE</a>(addr_string);
00856     }
00857     <span class="keywordflow">return</span> 1;
00858 }
00859 
00860 
00861 <span class="keywordtype">int</span>
00862 netsnmp_agent_check_parse(<a class="code" href="structsnmp__session.html">netsnmp_session</a> * session, <a class="code"
href="structsnmp__pdu.html">netsnmp_pdu</a> *pdu,
00863                           <span class="keywordtype">int</span> result)
00864 {
00865     <span class="keywordflow">if</span> (result == 0) {
00866         <span class="keywordflow">if</span> (<a class="code" href=
"group__snmp__logging.html#ga12">snmp_get_do_logging</a>() &amp;&amp;
00867             netsnmp_ds_get_boolean(NETSNMP_DS_APPLICATION_ID, 
00868                                    NETSNMP_DS_AGENT_VERBOSE)) {
00869             <a class="code" href="structvariable__list.html">netsnmp_variable_list</a> *var_ptr;
00870 
00871             <span class="keywordflow">switch</span> (pdu-&gt;<a class="code" href="structsnmp__pdu.html#o1">command</a>) {
00872             <span class="keywordflow">case</span> SNMP_MSG_GET:
00873                 <a class="code" href="group__snmp__logging.html#ga41">snmp_log</a>(LOG_DEBUG, <span class=
"stringliteral">"  GET message\n"</span>);
00874                 <span class="keywordflow">break</span>;
00875             <span class="keywordflow">case</span> SNMP_MSG_GETNEXT:
00876                 <a class="code" href="group__snmp__logging.html#ga41">snmp_log</a>(LOG_DEBUG, <span class=
"stringliteral">"  GETNEXT message\n"</span>);
00877                 <span class="keywordflow">break</span>;
00878             <span class="keywordflow">case</span> SNMP_MSG_RESPONSE:
00879                 <a class="code" href="group__snmp__logging.html#ga41">snmp_log</a>(LOG_DEBUG, <span class=
"stringliteral">"  RESPONSE message\n"</span>);
00880                 <span class="keywordflow">break</span>;
00881             <span class="keywordflow">case</span> SNMP_MSG_SET:
00882                 <a class="code" href="group__snmp__logging.html#ga41">snmp_log</a>(LOG_DEBUG, <span class=
"stringliteral">"  SET message\n"</span>);
00883                 <span class="keywordflow">break</span>;
00884             <span class="keywordflow">case</span> SNMP_MSG_TRAP:
00885                 <a class="code" href="group__snmp__logging.html#ga41">snmp_log</a>(LOG_DEBUG, <span class=
"stringliteral">"  TRAP message\n"</span>);
00886                 <span class="keywordflow">break</span>;
00887             <span class="keywordflow">case</span> SNMP_MSG_GETBULK:
00888                 <a class="code" href="group__snmp__logging.html#ga41">snmp_log</a>(LOG_DEBUG, <span class=
"stringliteral">"  GETBULK message, non-rep=%ld, max_rep=%ld\n"</span>,
00889                          pdu-&gt;<a class="code" href="structsnmp__pdu.html#o6">errstat</a>, pdu-&gt;<a class="code" href=
"structsnmp__pdu.html#o7">errindex</a>);
00890                 <span class="keywordflow">break</span>;
00891             <span class="keywordflow">case</span> SNMP_MSG_INFORM:
00892                 <a class="code" href="group__snmp__logging.html#ga41">snmp_log</a>(LOG_DEBUG, <span class=
"stringliteral">"  INFORM message\n"</span>);
00893                 <span class="keywordflow">break</span>;
00894             <span class="keywordflow">case</span> SNMP_MSG_TRAP2:
00895                 <a class="code" href="group__snmp__logging.html#ga41">snmp_log</a>(LOG_DEBUG, <span class=
"stringliteral">"  TRAP2 message\n"</span>);
00896                 <span class="keywordflow">break</span>;
00897             <span class="keywordflow">case</span> SNMP_MSG_REPORT:
00898                 <a class="code" href="group__snmp__logging.html#ga41">snmp_log</a>(LOG_DEBUG, <span class=
"stringliteral">"  REPORT message\n"</span>);
00899                 <span class="keywordflow">break</span>;
00900 
00901             <span class="keywordflow">case</span> SNMP_MSG_INTERNAL_SET_RESERVE1:
00902                 <a class="code" href="group__snmp__logging.html#ga41">snmp_log</a>(LOG_DEBUG, <span class=
"stringliteral">"  INTERNAL RESERVE1 message\n"</span>);
00903                 <span class="keywordflow">break</span>;
00904 
00905             <span class="keywordflow">case</span> SNMP_MSG_INTERNAL_SET_RESERVE2:
00906                 <a class="code" href="group__snmp__logging.html#ga41">snmp_log</a>(LOG_DEBUG, <span class=
"stringliteral">"  INTERNAL RESERVE2 message\n"</span>);
00907                 <span class="keywordflow">break</span>;
00908 
00909             <span class="keywordflow">case</span> SNMP_MSG_INTERNAL_SET_ACTION:
00910                 <a class="code" href="group__snmp__logging.html#ga41">snmp_log</a>(LOG_DEBUG, <span class=
"stringliteral">"  INTERNAL ACTION message\n"</span>);
00911                 <span class="keywordflow">break</span>;
00912 
00913             <span class="keywordflow">case</span> SNMP_MSG_INTERNAL_SET_COMMIT:
00914                 <a class="code" href="group__snmp__logging.html#ga41">snmp_log</a>(LOG_DEBUG, <span class=
"stringliteral">"  INTERNAL COMMIT message\n"</span>);
00915                 <span class="keywordflow">break</span>;
00916 
00917             <span class="keywordflow">case</span> SNMP_MSG_INTERNAL_SET_FREE:
00918                 <a class="code" href="group__snmp__logging.html#ga41">snmp_log</a>(LOG_DEBUG, <span class=
"stringliteral">"  INTERNAL FREE message\n"</span>);
00919                 <span class="keywordflow">break</span>;
00920 
00921             <span class="keywordflow">case</span> SNMP_MSG_INTERNAL_SET_UNDO:
00922                 <a class="code" href="group__snmp__logging.html#ga41">snmp_log</a>(LOG_DEBUG, <span class=
"stringliteral">"  INTERNAL UNDO message\n"</span>);
00923                 <span class="keywordflow">break</span>;
00924 
00925             <span class="keywordflow">default</span>:
00926                 <a class="code" href="group__snmp__logging.html#ga41">snmp_log</a>(LOG_DEBUG, <span class=
"stringliteral">"  UNKNOWN message, type=%02X\n"</span>,
00927                          pdu-&gt;<a class="code" href="structsnmp__pdu.html#o1">command</a>);
00928                 snmp_increment_statistic(STAT_SNMPINASNPARSEERRS);
00929                 <span class="keywordflow">return</span> 0;
00930             }
00931 
00932             <span class="keywordflow">for</span> (var_ptr = pdu-&gt;<a class="code" href=
"structsnmp__pdu.html#o17">variables</a>; var_ptr != NULL;
00933                  var_ptr = var_ptr-&gt;<a class="code" href="structvariable__list.html#o0">next_variable</a>) {
00934                 size_t          c_oidlen = 256, c_outlen = 0;
00935                 u_char         *c_oid = (u_char *) malloc(c_oidlen);
00936 
00937                 <span class="keywordflow">if</span> (c_oid) {
00938                     <span class="keywordflow">if</span> (!sprint_realloc_objid
00939                         (&amp;c_oid, &amp;c_oidlen, &amp;c_outlen, 1, var_ptr-&gt;<a class="code" href=
"structvariable__list.html#o1">name</a>,
00940                          var_ptr-&gt;<a class="code" href="structvariable__list.html#o2">name_length</a>)) {
00941                         <a class="code" href="group__snmp__logging.html#ga41">snmp_log</a>(LOG_DEBUG, <span class=
"stringliteral">"    -- %s [TRUNCATED]\n"</span>,
00942                                  c_oid);
00943                     } <span class="keywordflow">else</span> {
00944                         <a class="code" href="group__snmp__logging.html#ga41">snmp_log</a>(LOG_DEBUG, <span class=
"stringliteral">"    -- %s\n"</span>, c_oid);
00945                     }
00946                     <a class="code" href="group__util.html#ga36">SNMP_FREE</a>(c_oid);
00947                 }
00948             }
00949         }
00950         <span class="keywordflow">return</span> 1;
00951     }
00952     <span class="keywordflow">return</span> 0;                   <span class=
"comment">/* XXX: does it matter what the return value</span>
00953 <span class="comment">                                 * is?  Yes: if we return 0, then the PDU is</span>
00954 <span class="comment">                                 * dumped.  */</span>
00955 }
00956 
00957 
00958 <span class="comment">/*</span>
00959 <span class="comment"> * Global access to the primary session structure for this agent.</span>
00960 <span class="comment"> * for Index Allocation use initially. </span>
00961 <span class="comment"> */</span>
00962 
00963 <span class="comment">/*</span>
00964 <span class="comment"> * I don't understand what this is for at the moment.  AFAICS as long as it</span>
00965 <span class="comment"> * gets set and points at a session, that's fine.  ???  </span>
00966 <span class="comment"> */</span>
00967 
00968 <a class="code" href="structsnmp__session.html">netsnmp_session</a> *main_session = NULL;
00969 
00970 
00971 
00972 <span class="comment">/*</span>
00973 <span class="comment"> * Set up an agent session on the given transport.  Return a handle</span>
00974 <span class="comment"> * which may later be used to de-register this transport.  A return</span>
00975 <span class="comment"> * value of -1 indicates an error.  </span>
00976 <span class="comment"> */</span>
00977 
00978 <span class="keywordtype">int</span>
00979 netsnmp_register_agent_nsap(netsnmp_transport *t)
00980 {
00981     <a class="code" href="structsnmp__session.html">netsnmp_session</a> *s, *sp = NULL;
00982     agent_nsap     *a = NULL, *n = NULL, **prevNext = &amp;agent_nsap_list;
00983     <span class="keywordtype">int</span>             handle = 0;
00984     <span class="keywordtype">void</span>           *isp = NULL;
00985 
00986     <span class="keywordflow">if</span> (t == NULL) {
00987         <span class="keywordflow">return</span> -1;
00988     }
00989 
00990     DEBUGMSGTL((<span class="stringliteral">"netsnmp_register_agent_nsap"</span>, <span class=
"stringliteral">"fd %d\n"</span>, t-&gt;sock));
00991 
00992     n = (agent_nsap *) malloc(<span class="keyword">sizeof</span>(agent_nsap));
00993     <span class="keywordflow">if</span> (n == NULL) {
00994         <span class="keywordflow">return</span> -1;
00995     }
00996     s = (<a class="code" href="structsnmp__session.html">netsnmp_session</a> *) malloc(<span class=
"keyword">sizeof</span>(<a class="code" href="structsnmp__session.html">netsnmp_session</a>));
00997     <span class="keywordflow">if</span> (s == NULL) {
00998         <a class="code" href="group__util.html#ga36">SNMP_FREE</a>(n);
00999         <span class="keywordflow">return</span> -1;
01000     }
01001     memset(s, 0, <span class="keyword">sizeof</span>(<a class="code" href="structsnmp__session.html">netsnmp_session</a>));
01002     snmp_sess_init(s);
01003 
01004     <span class="comment">/*</span>
01005 <span class="comment">     * Set up the session appropriately for an agent.  </span>
01006 <span class="comment">     */</span>
01007 
01008     s-&gt;<a class="code" href="structsnmp__session.html#o0">version</a> = SNMP_DEFAULT_VERSION;
01009     s-&gt;<a class="code" href="structsnmp__session.html#o11">callback</a> = handle_snmp_packet;
01010     s-&gt;<a class="code" href="structsnmp__session.html#o10">authenticator</a> = NULL;
01011     s-&gt;<a class="code" href="structsnmp__session.html#o3">flags</a> = netsnmp_ds_get_int(NETSNMP_DS_APPLICATION_ID, 
01012                                   NETSNMP_DS_AGENT_FLAGS);
01013     s-&gt;<a class="code" href="structsnmp__session.html#o20">isAuthoritative</a> = SNMP_SESS_AUTHORITATIVE;
01014 
01015     sp = snmp_add(s, t, netsnmp_agent_check_packet,
01016                   netsnmp_agent_check_parse);
01017     <span class="keywordflow">if</span> (sp == NULL) {
01018         <a class="code" href="group__util.html#ga36">SNMP_FREE</a>(s);
01019         <a class="code" href="group__util.html#ga36">SNMP_FREE</a>(n);
01020         <span class="keywordflow">return</span> -1;
01021     }
01022 
01023     isp = snmp_sess_pointer(sp);
01024     <span class="keywordflow">if</span> (isp == NULL) {          <span class="comment">/*  over-cautious  */</span>
01025         <a class="code" href="group__util.html#ga36">SNMP_FREE</a>(s);
01026         <a class="code" href="group__util.html#ga36">SNMP_FREE</a>(n);
01027         <span class="keywordflow">return</span> -1;
01028     }
01029 
01030     n-&gt;s = isp;
01031     n-&gt;t = t;
01032 
01033     <span class="keywordflow">if</span> (main_session == NULL) {
01034         main_session = snmp_sess_session(isp);
01035     }
01036 
01037     <span class="keywordflow">for</span> (a = agent_nsap_list; a != NULL &amp;&amp; handle + 1 &gt;= a-&gt;handle;
01038          a = a-&gt;next) {
01039         handle = a-&gt;handle;
01040         prevNext = &amp;(a-&gt;next);
01041     }
01042 
01043     <span class="keywordflow">if</span> (handle &lt; INT_MAX) {
01044         n-&gt;handle = handle + 1;
01045         n-&gt;<a class="code" href="structsnmp__session.html#o5">next</a> = a;
01046         *prevNext = n;
01047         <a class="code" href="group__util.html#ga36">SNMP_FREE</a>(s);
01048         <span class="keywordflow">return</span> n-&gt;handle;
01049     } <span class="keywordflow">else</span> {
01050         <a class="code" href="group__util.html#ga36">SNMP_FREE</a>(s);
01051         <a class="code" href="group__util.html#ga36">SNMP_FREE</a>(n);
01052         <span class="keywordflow">return</span> -1;
01053     }
01054 }
01055 
01056 <span class="keywordtype">void</span>
01057 netsnmp_deregister_agent_nsap(<span class="keywordtype">int</span> handle)
01058 {
01059     agent_nsap     *a = NULL, **prevNext = &amp;agent_nsap_list;
01060     <span class="keywordtype">int</span>             main_session_deregistered = 0;
01061 
01062     DEBUGMSGTL((<span class="stringliteral">"netsnmp_deregister_agent_nsap"</span>, <span class=
"stringliteral">"handle %d\n"</span>, handle));
01063 
01064     <span class=
"keywordflow">for</span> (a = agent_nsap_list; a != NULL &amp;&amp; a-&gt;handle &lt; handle; a = a-&gt;next) {
01065         prevNext = &amp;(a-&gt;next);
01066     }
01067 
01068     <span class="keywordflow">if</span> (a != NULL &amp;&amp; a-&gt;handle == handle) {
01069         *prevNext = a-&gt;<a class="code" href="structsnmp__session.html#o5">next</a>;
01070         <span class="keywordflow">if</span> (main_session == snmp_sess_session(a-&gt;s)) {
01071             main_session_deregistered = 1;
01072         }
01073         snmp_close(snmp_sess_session(a-&gt;s));
01074         <span class="comment">/*</span>
01075 <span class="comment">         * The above free()s the transport and session pointers.  </span>
01076 <span class="comment">         */</span>
01077         <a class="code" href="group__util.html#ga36">SNMP_FREE</a>(a);
01078     }
01079 
01080     <span class="comment">/*</span>
01081 <span class="comment">     * If we've deregistered the session that main_session used to point to,</span>
01082 <span class="comment">     * then make it point to another one, or in the last resort, make it equal</span>
01083 <span class="comment">     * to NULL.  Basically this shouldn't ever happen in normal operation</span>
01084 <span class="comment">     * because main_session starts off pointing at the first session added by</span>
01085 <span class="comment">     * init_master_agent(), which then discards the handle.  </span>
01086 <span class="comment">     */</span>
01087 
01088     <span class="keywordflow">if</span> (main_session_deregistered) {
01089         <span class="keywordflow">if</span> (agent_nsap_list != NULL) {
01090             DEBUGMSGTL((<span class="stringliteral">"snmp_agent"</span>,
01091                         <span class="stringliteral">"WARNING: main_session ptr changed from %p to %p\n"</span>,
01092                         main_session, snmp_sess_session(agent_nsap_list-&gt;s)));
01093             main_session = snmp_sess_session(agent_nsap_list-&gt;s);
01094         } <span class="keywordflow">else</span> {
01095             DEBUGMSGTL((<span class="stringliteral">"snmp_agent"</span>,
01096                         <span class="stringliteral">"WARNING: main_session ptr changed from %p to NULL\n"</span>,
01097                         main_session));
01098             main_session = NULL;
01099         }
01100     }
01101 }
01102 
01103 
01104 
01105 <span class="comment">/*</span>
01106 <span class="comment"> * </span>
01107 <span class="comment"> * This function has been modified to use the experimental</span>
01108 <span class="comment"> * netsnmp_register_agent_nsap interface.  The major responsibility of this</span>
01109 <span class="comment"> * function now is to interpret a string specified to the agent (via -p on the</span>
01110 <span class="comment"> * command line, or from a configuration file) as a list of agent NSAPs on</span>
01111 <span class="comment"> * which to listen for SNMP packets.  Typically, when you add a new transport</span>
01112 <span class="comment"> * domain "foo", you add code here such that if the "foo" code is compiled</span>
01113 <span class="comment"> * into the agent (SNMP_TRANSPORT_FOO_DOMAIN is defined), then a token of the</span>
01114 <span class="comment"> * form "foo:bletch-3a0054ef%wob&amp;wob" gets turned into the appropriate</span>
01115 <span class="comment"> * transport descriptor.  netsnmp_register_agent_nsap is then called with that</span>
01116 <span class="comment"> * transport descriptor and sets up a listening agent session on it.</span>
01117 <span class="comment"> * </span>
01118 <span class="comment"> * Everything then works much as normal: the agent runs in an infinite loop</span>
01119 <span class="comment"> * (in the snmpd.c/receive()routine), which calls snmp_read() when a request</span>
01120 <span class="comment"> * is readable on any of the given transports.  This routine then traverses</span>
01121 <span class="comment"> * the library 'Sessions' list to identify the relevant session and eventually</span>
01122 <span class="comment"> * invokes '_sess_read'.  This then processes the incoming packet, calling the</span>
01123 <span class="comment"> * pre_parse, parse, post_parse and callback routines in turn.</span>
01124 <span class="comment"> * </span>
01125 <span class="comment"> * JBPN 20001117</span>
01126 <span class="comment"> */</span>
01127 
01128 <span class="keywordtype">int</span>
01129 init_master_agent(<span class="keywordtype">void</span>)
01130 {
01131     netsnmp_transport *transport;
01132     <span class="keywordtype">char</span>           *cptr;
01133     <span class="keywordtype">char</span>            buf[SPRINT_MAX_LEN];
01134     <span class="keywordtype">char</span>           *st;
01135 
01136     <span class="comment">/* default to a default cache size */</span>
01137     <a class="code" href="group__agent__registry.html#ga9">netsnmp_set_lookup_cache_size</a>(-1);
01138 
01139     <span class="keywordflow">if</span> (netsnmp_ds_get_boolean(NETSNMP_DS_APPLICATION_ID, 
01140                                NETSNMP_DS_AGENT_ROLE) != MASTER_AGENT) {
01141         DEBUGMSGTL((<span class="stringliteral">"snmp_agent"</span>,
01142                     <span class="stringliteral">"init_master_agent; not master agent\n"</span>));
01143 
01144         netsnmp_assert(<span class="stringliteral">"agent role !master &amp;&amp; !sub_agent"</span>);
01145         
01146         <span class="keywordflow">return</span> 0;               <span class=
"comment">/*  No error if ! MASTER_AGENT  */</span>
01147     }
01148 <span class="preprocessor">#ifdef USING_AGENTX_MASTER_MODULE</span>
01149     <span class="keywordflow">if</span> (netsnmp_ds_get_boolean(NETSNMP_DS_APPLICATION_ID, 
01150                                NETSNMP_DS_AGENT_AGENTX_MASTER) == 1)
01151         real_init_master();
01152 <span class="preprocessor">#endif</span>
01153 <span class="preprocessor">#ifdef USING_SMUX_MODULE</span>
01154     <span class="keywordflow">if</span>(should_init(<span class="stringliteral">"smux"</span>))
01155     real_init_smux();
01156 <span class="preprocessor">#endif</span>
01157 
01158     <span class="comment">/*</span>
01159 <span class="comment">     * Have specific agent ports been specified?  </span>
01160 <span class="comment">     */</span>
01161     cptr = netsnmp_ds_get_string(NETSNMP_DS_APPLICATION_ID, 
01162                                  NETSNMP_DS_AGENT_PORTS);
01163 
01164     <span class="keywordflow">if</span> (cptr) {
01165         snprintf(buf, <span class="keyword">sizeof</span>(buf), <span class="stringliteral">"%s"</span>, cptr);
01166         buf[ <span class="keyword">sizeof</span>(buf)-1 ] = 0;
01167     } <span class="keywordflow">else</span> {
01168         <span class="comment">/*</span>
01169 <span class="comment">         * No, so just specify the default port.  </span>
01170 <span class="comment">         */</span>
01171         <span class=
"keywordflow">if</span> (netsnmp_ds_get_int(NETSNMP_DS_APPLICATION_ID, NETSNMP_DS_AGENT_FLAGS) &amp; SNMP_FLAGS_STREAM_SOCKET) {
01172             sprintf(buf, <span class="stringliteral">"tcp:%d"</span>, SNMP_PORT);
01173         } <span class="keywordflow">else</span> {
01174             sprintf(buf, <span class="stringliteral">"udp:%d"</span>, SNMP_PORT);
01175         }
01176     }
01177 
01178     DEBUGMSGTL((<span class="stringliteral">"snmp_agent"</span>, <span class=
"stringliteral">"final port spec: %s\n"</span>, buf));
01179     cptr = strtok_r(buf, <span class="stringliteral">","</span>, &amp;st);
01180     <span class="keywordflow">while</span> (cptr) {
01181         <span class="comment">/*</span>
01182 <span class="comment">         * Specification format: </span>
01183 <span class="comment">         * </span>
01184 <span class="comment">         * NONE:                      (a pseudo-transport)</span>
01185 <span class="comment">         * UDP:[address:]port        (also default if no transport is specified)</span>
01186 <span class="comment">         * TCP:[address:]port         (if supported)</span>
01187 <span class="comment">         * Unix:pathname              (if supported)</span>
01188 <span class="comment">         * AAL5PVC:itf.vpi.vci        (if supported)</span>
01189 <span class="comment">         * IPX:[network]:node[/port] (if supported)</span>
01190 <span class="comment">         * </span>
01191 <span class="comment">         */</span>
01192 
01193         DEBUGMSGTL((<span class="stringliteral">"snmp_agent"</span>, <span class=
"stringliteral">"installing master agent on port %s\n"</span>,
01194                     cptr));
01195 
01196         <span class="keywordflow">if</span> (!cptr || !(*cptr)) {
01197             <a class="code" href="group__snmp__logging.html#ga41">snmp_log</a>(LOG_ERR, <span class=
"stringliteral">"improper port specification\n"</span>);
01198             <span class="keywordflow">return</span> 1;
01199         }
01200 
01201         <span class="keywordflow">if</span> (strncasecmp(cptr, <span class="stringliteral">"none"</span>, 4) == 0) {
01202             DEBUGMSGTL((<span class="stringliteral">"snmp_agent"</span>,
01203                         <span class="stringliteral">"init_master_agent; pseudo-transport \"none\" requested\n"</span>));
01204             <span class="keywordflow">return</span> 0;
01205         }
01206         transport = netsnmp_tdomain_transport(cptr, 1, <span class="stringliteral">"udp"</span>);
01207 
01208         <span class="keywordflow">if</span> (transport == NULL) {
01209             <a class="code" href="group__snmp__logging.html#ga41">snmp_log</a>(LOG_ERR, <span class=
"stringliteral">"Error opening specified endpoint \"%s\"\n"</span>,
01210                      cptr);
01211             <span class="keywordflow">return</span> 1;
01212         }
01213 
01214         <span class="keywordflow">if</span> (netsnmp_register_agent_nsap(transport) == 0) {
01215             <a class="code" href="group__snmp__logging.html#ga41">snmp_log</a>(LOG_ERR,
01216                      <span class="stringliteral">"Error registering specified transport \"%s\" as an agent NSAP\n"</span>,
01217                      cptr);
01218             <span class="keywordflow">return</span> 1;
01219         } <span class="keywordflow">else</span> {
01220             DEBUGMSGTL((<span class="stringliteral">"snmp_agent"</span>,
01221                         <span class="stringliteral">"init_master_agent; \"%s\" registered as an agent NSAP\n"</span>,
01222                         cptr));
01223         }
01224 
01225         <span class="comment">/*</span>
01226 <span class="comment">         * Next transport please...  </span>
01227 <span class="comment">         */</span>
01228         cptr = strtok_r(NULL, <span class="stringliteral">","</span>, &amp;st);
01229     }
01230 
01231     <span class="keywordflow">return</span> 0;
01232 }
01233 
01234 <span class="keywordtype">void</span>
01235 clear_nsap_list(<span class="keywordtype">void</span>)
01236 {
01237     DEBUGMSGTL((<span class="stringliteral">"clear_nsap_list"</span>, <span class=
"stringliteral">"clear the nsap list\n"</span>));
01238 
01239     <span class="keywordflow">while</span> (agent_nsap_list != NULL)
01240         netsnmp_deregister_agent_nsap(agent_nsap_list-&gt;handle);
01241 }
01242 
01243 <span class="keywordtype">void</span>
01244 shutdown_master_agent(<span class="keywordtype">void</span>)
01245 {
01246     clear_nsap_list();
01247 }
01248 
01249 
01250 netsnmp_agent_session *
01251 init_agent_snmp_session(<a class="code" href="structsnmp__session.html">netsnmp_session</a> * session, <a class="code"
href="structsnmp__pdu.html">netsnmp_pdu</a> *pdu)
01252 {
01253     netsnmp_agent_session *asp = (netsnmp_agent_session *)
01254         calloc(1, <span class="keyword">sizeof</span>(netsnmp_agent_session));
01255 
01256     <span class="keywordflow">if</span> (asp == NULL) {
01257         <span class="keywordflow">return</span> NULL;
01258     }
01259 
01260     DEBUGMSGTL((<span class="stringliteral">"snmp_agent"</span>,<span class=
"stringliteral">"agent_sesion %08p created\n"</span>, asp));
01261     asp-&gt;session = session;
01262     asp-&gt;pdu = snmp_clone_pdu(pdu);
01263     asp-&gt;orig_pdu = snmp_clone_pdu(pdu);
01264     asp-&gt;rw = READ;
01265     asp-&gt;exact = TRUE;
01266     asp-&gt;next = NULL;
01267     asp-&gt;mode = RESERVE1;
01268     asp-&gt;status = SNMP_ERR_NOERROR;
01269     asp-&gt;index = 0;
01270     asp-&gt;oldmode = 0;
01271     asp-&gt;treecache_num = -1;
01272     asp-&gt;treecache_len = 0;
01273     asp-&gt;reqinfo = <a class="code" href="group__util.html#ga39">SNMP_MALLOC_TYPEDEF</a>(<a class="code" href=
"structnetsnmp__agent__request__info__s.html">netsnmp_agent_request_info</a>);
01274     DEBUGMSGTL((<span class="stringliteral">"verbose:asp"</span>, <span class=
"stringliteral">"asp %p reqinfo %p created\n"</span>,
01275                 asp, asp-&gt;reqinfo));
01276 
01277     <span class="keywordflow">return</span> asp;
01278 }
01279 
01280 <span class="keywordtype">void</span>
01281 free_agent_snmp_session(netsnmp_agent_session *asp)
01282 {
01283     <span class="keywordflow">if</span> (!asp)
01284         <span class="keywordflow">return</span>;
01285 
01286     DEBUGMSGTL((<span class="stringliteral">"snmp_agent"</span>,<span class=
"stringliteral">"agent_session %08p released\n"</span>, asp));
01287 
01288     netsnmp_remove_from_delegated(asp);
01289     
01290     DEBUGMSGTL((<span class="stringliteral">"verbose:asp"</span>, <span class=
"stringliteral">"asp %p reqinfo %p freed\n"</span>,
01291                 asp, asp-&gt;reqinfo));
01292     <span class="keywordflow">if</span> (asp-&gt;orig_pdu)
01293         snmp_free_pdu(asp-&gt;orig_pdu);
01294     <span class="keywordflow">if</span> (asp-&gt;pdu)
01295         snmp_free_pdu(asp-&gt;pdu);
01296     <span class="keywordflow">if</span> (asp-&gt;reqinfo)
01297         netsnmp_free_agent_request_info(asp-&gt;reqinfo);
01298     <span class="keywordflow">if</span> (asp-&gt;treecache) {
01299         <a class="code" href="group__util.html#ga36">SNMP_FREE</a>(asp-&gt;treecache);
01300     }
01301     <span class="keywordflow">if</span> (asp-&gt;bulkcache) {
01302         <a class="code" href="group__util.html#ga36">SNMP_FREE</a>(asp-&gt;bulkcache);
01303     }
01304     <span class="keywordflow">if</span> (asp-&gt;requests) {
01305         <span class="keywordtype">int</span>             i;
01306         <span class="keywordflow">for</span> (i = 0; i &lt; asp-&gt;vbcount; i++) {
01307             <a class="code" href="group__handler.html#ga31">netsnmp_free_request_data_sets</a>(&amp;asp-&gt;requests[i]);
01308         }
01309         <a class="code" href="group__util.html#ga36">SNMP_FREE</a>(asp-&gt;requests);
01310     }
01311     <span class="keywordflow">if</span> (asp-&gt;cache_store) {
01312         netsnmp_free_cachemap(asp-&gt;cache_store);
01313         asp-&gt;cache_store = NULL;
01314     }
01315     <a class="code" href="group__util.html#ga36">SNMP_FREE</a>(asp);
01316 }
01317 
01318 <span class="keywordtype">int</span>
01319 netsnmp_check_for_delegated(netsnmp_agent_session *asp)
01320 {
01321     <span class="keywordtype">int</span>             i;
01322     <a class="code" href="structnetsnmp__request__info__s.html">netsnmp_request_info</a> *request;
01323 
01324     <span class="keywordflow">if</span> (NULL == asp-&gt;treecache)
01325         <span class="keywordflow">return</span> 0;
01326     
01327     <span class="keywordflow">for</span> (i = 0; i &lt;= asp-&gt;treecache_num; i++) {
01328         <span class="keywordflow">for</span> (request = asp-&gt;treecache[i].requests_begin; request;
01329              request = request-&gt;<a class="code" href="structnetsnmp__request__info__s.html#o13">next</a>) {
01330             <span class="keywordflow">if</span> (request-&gt;<a class="code" href=
"structnetsnmp__request__info__s.html#o5">delegated</a>)
01331                 <span class="keywordflow">return</span> 1;
01332         }
01333     }
01334     <span class="keywordflow">return</span> 0;
01335 }
01336 
01337 <span class="keywordtype">int</span>
01338 netsnmp_check_delegated_chain_for(netsnmp_agent_session *asp)
01339 {
01340     netsnmp_agent_session *asptmp;
01341     <span class="keywordflow">for</span> (asptmp = agent_delegated_list; asptmp; asptmp = asptmp-&gt;next) {
01342         <span class="keywordflow">if</span> (asptmp == asp)
01343             <span class="keywordflow">return</span> 1;
01344     }
01345     <span class="keywordflow">return</span> 0;
01346 }
01347 
01348 <span class="keywordtype">int</span>
01349 netsnmp_check_for_delegated_and_add(netsnmp_agent_session *asp)
01350 {
01351     <span class="keywordflow">if</span> (netsnmp_check_for_delegated(asp)) {
01352         <span class="keywordflow">if</span> (!netsnmp_check_delegated_chain_for(asp)) {
01353             <span class="comment">/*</span>
01354 <span class="comment">             * add to delegated request chain </span>
01355 <span class="comment">             */</span>
01356             asp-&gt;next = agent_delegated_list;
01357             agent_delegated_list = asp;
01358             DEBUGMSGTL((<span class="stringliteral">"snmp_agent"</span>, <span class=
"stringliteral">"delegate session == %08p\n"</span>, asp));
01359         }
01360         <span class="keywordflow">return</span> 1;
01361     }
01362     <span class="keywordflow">return</span> 0;
01363 }
01364 
01365 <span class="keywordtype">int</span>
01366 netsnmp_remove_from_delegated(netsnmp_agent_session *asp)
01367 {
01368     netsnmp_agent_session *curr, *prev = NULL;
01369     
01370     <span class="keywordflow">for</span> (curr = agent_delegated_list; curr; prev = curr, curr = curr-&gt;next) {
01371         <span class="comment">/*</span>
01372 <span class="comment">         * is this us?</span>
01373 <span class="comment">         */</span>
01374         <span class="keywordflow">if</span> (curr != asp)
01375             <span class="keywordflow">continue</span>;
01376         
01377         <span class="comment">/*</span>
01378 <span class="comment">         * remove from queue </span>
01379 <span class="comment">         */</span>
01380         <span class="keywordflow">if</span> (prev != NULL)
01381             prev-&gt;next = asp-&gt;next;
01382         <span class="keywordflow">else</span>
01383             agent_delegated_list = asp-&gt;next;
01384 
01385         DEBUGMSGTL((<span class="stringliteral">"snmp_agent"</span>, <span class=
"stringliteral">"remove delegated session == %08p\n"</span>, asp));
01386 
01387         <span class="keywordflow">return</span> 1;
01388     }
01389 
01390     <span class="keywordflow">return</span> 0;
01391 }
01392 
01393 <span class="comment">/*</span>
01394 <span class="comment"> * netsnmp_remove_delegated_requests_for_session</span>
01395 <span class="comment"> *</span>
01396 <span class="comment"> * called when a session is being closed. Check all delegated requests to</span>
01397 <span class="comment"> * see if the are waiting on this session, and if set, set the status for</span>
01398 <span class="comment"> * that request to GENERR.</span>
01399 <span class="comment"> */</span>
01400 <span class="keywordtype">int</span>
01401 netsnmp_remove_delegated_requests_for_session(<a class="code" href="structsnmp__session.html">netsnmp_session</a> *sess)
01402 {
01403     netsnmp_agent_session *asp;
01404     <span class="keywordtype">int</span> count = 0;
01405     
01406     <span class="keywordflow">for</span> (asp = agent_delegated_list; asp; asp = asp-&gt;next) {
01407         <span class="comment">/*</span>
01408 <span class="comment">         * check each request</span>
01409 <span class="comment">         */</span>
01410         <a class="code" href="structnetsnmp__request__info__s.html">netsnmp_request_info</a> *request;
01411         <span class="keywordflow">for</span>(request = asp-&gt;requests; request; request = request-&gt;<a class="code"
href="structnetsnmp__request__info__s.html#o13">next</a>) {
01412             <span class="comment">/*</span>
01413 <span class="comment">             * check session</span>
01414 <span class="comment">             */</span>
01415             netsnmp_assert(NULL!=request-&gt;<a class="code" href="structnetsnmp__request__info__s.html#o15">subtree</a>);
01416             <span class="keywordflow">if</span>(request-&gt;<a class="code" href=
"structnetsnmp__request__info__s.html#o15">subtree</a>-&gt;session != sess)
01417                 <span class="keywordflow">continue</span>;
01418 
01419             <span class="comment">/*</span>
01420 <span class="comment">             * matched! mark request as done</span>
01421 <span class="comment">             */</span>
01422             <a class="code" href="group__snmp__agent.html#ga72">netsnmp_request_set_error</a>(request, SNMP_ERR_GENERR);
01423             ++count;
01424         }
01425     }
01426 
01427     <span class="comment">/*</span>
01428 <span class="comment">     * if we found any, that request may be finished now</span>
01429 <span class="comment">     */</span>
01430     <span class="keywordflow">if</span>(count) {
01431         DEBUGMSGTL((<span class="stringliteral">"snmp_agent"</span>, <span class=
"stringliteral">"removed %d delegated request(s) for session "</span>
01432                     <span class="stringliteral">"%08p\n"</span>, count, sess));
01433         netsnmp_check_outstanding_agent_requests();
01434     }
01435     
01436     <span class="keywordflow">return</span> count;
01437 }
01438 
01439 <span class="keywordtype">int</span>
01440 netsnmp_check_queued_chain_for(netsnmp_agent_session *asp)
01441 {
01442     netsnmp_agent_session *asptmp;
01443     <span class="keywordflow">for</span> (asptmp = netsnmp_agent_queued_list; asptmp; asptmp = asptmp-&gt;next) {
01444         <span class="keywordflow">if</span> (asptmp == asp)
01445             <span class="keywordflow">return</span> 1;
01446     }
01447     <span class="keywordflow">return</span> 0;
01448 }
01449 
01450 <span class="keywordtype">int</span>
01451 netsnmp_add_queued(netsnmp_agent_session *asp)
01452 {
01453     netsnmp_agent_session *asp_tmp;
01454 
01455     <span class="comment">/*</span>
01456 <span class="comment">     * first item?</span>
01457 <span class="comment">     */</span>
01458     <span class="keywordflow">if</span> (NULL == netsnmp_agent_queued_list) {
01459         netsnmp_agent_queued_list = asp;
01460         <span class="keywordflow">return</span> 1;
01461     }
01462 
01463 
01464     <span class="comment">/*</span>
01465 <span class="comment">     * add to end of queued request chain </span>
01466 <span class="comment">     */</span>
01467     asp_tmp = netsnmp_agent_queued_list;
01468     <span class="keywordflow">for</span> (; asp_tmp; asp_tmp = asp_tmp-&gt;next) {
01469         <span class="comment">/*</span>
01470 <span class="comment">         * already in queue?</span>
01471 <span class="comment">         */</span>
01472         <span class="keywordflow">if</span> (asp_tmp == asp)
01473             <span class="keywordflow">break</span>;
01474 
01475         <span class="comment">/*</span>
01476 <span class="comment">         * end of queue?</span>
01477 <span class="comment">         */</span>
01478         <span class="keywordflow">if</span> (NULL == asp_tmp-&gt;next)
01479             asp_tmp-&gt;next = asp;
01480     }
01481     <span class="keywordflow">return</span> 1;
01482 }
01483 
01484 
01485 <span class="keywordtype">int</span>
<a name="l01486" id="l01486"></a><a class="code" href="group__snmp__agent.html#ga21">01486</a> <a class="code" href=
"group__snmp__agent.html#ga21">netsnmp_wrap_up_request</a>(netsnmp_agent_session *asp, <span class=
"keywordtype">int</span> status)
01487 {
01488     <a class="code" href="structvariable__list.html">netsnmp_variable_list</a> *var_ptr;
01489     <span class="keywordtype">int</span>             i;
01490 
01491     <span class="comment">/*</span>
01492 <span class="comment">     * if this request was a set, clear the global now that we are</span>
01493 <span class="comment">     * done.</span>
01494 <span class="comment">     */</span>
01495     <span class="keywordflow">if</span> (asp == netsnmp_processing_set) {
01496         DEBUGMSGTL((<span class="stringliteral">"snmp_agent"</span>, <span class=
"stringliteral">"SET request complete, asp = %08p\n"</span>,
01497                     asp));
01498         netsnmp_processing_set = NULL;
01499     }
01500 
01501     <span class="keywordflow">if</span> (asp-&gt;pdu) {
01502         <span class="comment">/*</span>
01503 <span class="comment">         * If we've got an error status, then this needs to be</span>
01504 <span class="comment">         *  passed back up to the higher levels....</span>
01505 <span class="comment">         */</span>
01506         <span class="keywordflow">if</span> ( status != 0  &amp;&amp; asp-&gt;status == 0 )
01507             asp-&gt;status = status;
01508 
01509         <span class="keywordflow">switch</span> (asp-&gt;pdu-&gt;command) {
01510             <span class="keywordflow">case</span> SNMP_MSG_INTERNAL_SET_BEGIN:
01511             <span class="keywordflow">case</span> SNMP_MSG_INTERNAL_SET_RESERVE1:
01512             <span class="keywordflow">case</span> SNMP_MSG_INTERNAL_SET_RESERVE2:
01513             <span class="keywordflow">case</span> SNMP_MSG_INTERNAL_SET_ACTION:
01514                 <span class="comment">/*</span>
01515 <span class="comment">                 * some stuff needs to be saved in special subagent cases </span>
01516 <span class="comment">                 */</span>
01517                 save_set_cache(asp);
01518                 <span class="keywordflow">break</span>;
01519 
01520             <span class="keywordflow">case</span> SNMP_MSG_GETBULK:
01521                 <span class="comment">/*</span>
01522 <span class="comment">                 * for a GETBULK response we need to rearrange the varbinds </span>
01523 <span class="comment">                 */</span>
01524                 _reorder_getbulk(asp);
01525                 <span class="keywordflow">break</span>;
01526         }
01527 
01528         <span class="comment">/*</span>
01529 <span class="comment">         * May need to "dumb down" a SET error status for a</span>
01530 <span class="comment">         * v1 query.  See RFC2576 - section 4.3</span>
01531 <span class="comment">         */</span>
01532 <span class="preprocessor">#ifndef DISABLE_SNMPV1</span>
01533         <span class="keywordflow">if</span> ((asp-&gt;pdu-&gt;command == SNMP_MSG_SET) &amp;&amp;
01534             (asp-&gt;pdu-&gt;version == SNMP_VERSION_1)) {
01535             <span class="keywordflow">switch</span> (asp-&gt;status) {
01536                 <span class="keywordflow">case</span> SNMP_ERR_WRONGVALUE:
01537                 <span class="keywordflow">case</span> SNMP_ERR_WRONGENCODING:
01538                 <span class="keywordflow">case</span> SNMP_ERR_WRONGTYPE:
01539                 <span class="keywordflow">case</span> SNMP_ERR_WRONGLENGTH:
01540                 <span class="keywordflow">case</span> SNMP_ERR_INCONSISTENTVALUE:
01541                     status = SNMP_ERR_BADVALUE;
01542                     asp-&gt;status = SNMP_ERR_BADVALUE;
01543                     <span class="keywordflow">break</span>;
01544                 <span class="keywordflow">case</span> SNMP_ERR_NOACCESS:
01545                 <span class="keywordflow">case</span> SNMP_ERR_NOTWRITABLE:
01546                 <span class="keywordflow">case</span> SNMP_ERR_NOCREATION:
01547                 <span class="keywordflow">case</span> SNMP_ERR_INCONSISTENTNAME:
01548                 <span class="keywordflow">case</span> SNMP_ERR_AUTHORIZATIONERROR:
01549                     status = SNMP_ERR_NOSUCHNAME;
01550                     asp-&gt;status = SNMP_ERR_NOSUCHNAME;
01551                     <span class="keywordflow">break</span>;
01552                 <span class="keywordflow">case</span> SNMP_ERR_RESOURCEUNAVAILABLE:
01553                 <span class="keywordflow">case</span> SNMP_ERR_COMMITFAILED:
01554                 <span class="keywordflow">case</span> SNMP_ERR_UNDOFAILED:
01555                     status = SNMP_ERR_GENERR;
01556                     asp-&gt;status = SNMP_ERR_GENERR;
01557                     <span class="keywordflow">break</span>;
01558             }
01559         }
01560         <span class="comment">/*</span>
01561 <span class="comment">         * Similarly we may need to "dumb down" v2 exception</span>
01562 <span class="comment">         *  types to throw an error for a v1 query.</span>
01563 <span class="comment">         *  See RFC2576 - section 4.1.2.3</span>
01564 <span class="comment">         */</span>
01565         <span class="keywordflow">if</span> ((asp-&gt;pdu-&gt;command != SNMP_MSG_SET) &amp;&amp;
01566             (asp-&gt;pdu-&gt;version == SNMP_VERSION_1)) {
01567             <span class="keywordflow">for</span> (var_ptr = asp-&gt;pdu-&gt;variables, i = 1;
01568                  var_ptr != NULL; var_ptr = var_ptr-&gt;<a class="code" href=
"structvariable__list.html#o0">next_variable</a>, i++) {
01569                 <span class="keywordflow">switch</span> (var_ptr-&gt;<a class="code" href=
"structvariable__list.html#o3">type</a>) {
01570                     <span class="keywordflow">case</span> SNMP_NOSUCHOBJECT:
01571                     <span class="keywordflow">case</span> SNMP_NOSUCHINSTANCE:
01572                     <span class="keywordflow">case</span> SNMP_ENDOFMIBVIEW:
01573                     <span class="keywordflow">case</span> ASN_COUNTER64:
01574                         status = SNMP_ERR_NOSUCHNAME;
01575                         asp-&gt;status = SNMP_ERR_NOSUCHNAME;
01576                         asp-&gt;index = i;
01577                         <span class="keywordflow">break</span>;
01578                 }
01579             }
01580         }
01581 <span class="preprocessor">#endif </span><span class="comment">/* snmpv1 support */</span>
01582     } 
01584     <span class="comment">/*</span>
01585 <span class="comment">     * Update the snmp error-count statistics</span>
01586 <span class="comment">     *   XXX - should we include the V2 errors in this or not?</span>
01587 <span class="comment">     */</span>
01588 <span class="preprocessor">#define INCLUDE_V2ERRORS_IN_V1STATS</span>
01589 
01590     <span class="keywordflow">switch</span> (status) {
01591 <span class="preprocessor">#ifdef INCLUDE_V2ERRORS_IN_V1STATS</span>
01592     <span class="keywordflow">case</span> SNMP_ERR_WRONGVALUE:
01593     <span class="keywordflow">case</span> SNMP_ERR_WRONGENCODING:
01594     <span class="keywordflow">case</span> SNMP_ERR_WRONGTYPE:
01595     <span class="keywordflow">case</span> SNMP_ERR_WRONGLENGTH:
01596     <span class="keywordflow">case</span> SNMP_ERR_INCONSISTENTVALUE:
01597 <span class="preprocessor">#endif</span>
01598     <span class="keywordflow">case</span> SNMP_ERR_BADVALUE:
01599         snmp_increment_statistic(STAT_SNMPOUTBADVALUES);
01600         <span class="keywordflow">break</span>;
01601 <span class="preprocessor">#ifdef INCLUDE_V2ERRORS_IN_V1STATS</span>
01602     <span class="keywordflow">case</span> SNMP_ERR_NOACCESS:
01603     <span class="keywordflow">case</span> SNMP_ERR_NOTWRITABLE:
01604     <span class="keywordflow">case</span> SNMP_ERR_NOCREATION:
01605     <span class="keywordflow">case</span> SNMP_ERR_INCONSISTENTNAME:
01606     <span class="keywordflow">case</span> SNMP_ERR_AUTHORIZATIONERROR:
01607 <span class="preprocessor">#endif</span>
01608     <span class="keywordflow">case</span> SNMP_ERR_NOSUCHNAME:
01609         snmp_increment_statistic(STAT_SNMPOUTNOSUCHNAMES);
01610         <span class="keywordflow">break</span>;
01611 <span class="preprocessor">#ifdef INCLUDE_V2ERRORS_IN_V1STATS</span>
01612     <span class="keywordflow">case</span> SNMP_ERR_RESOURCEUNAVAILABLE:
01613     <span class="keywordflow">case</span> SNMP_ERR_COMMITFAILED:
01614     <span class="keywordflow">case</span> SNMP_ERR_UNDOFAILED:
01615 <span class="preprocessor">#endif</span>
01616     <span class="keywordflow">case</span> SNMP_ERR_GENERR:
01617         snmp_increment_statistic(STAT_SNMPOUTGENERRS);
01618         <span class="keywordflow">break</span>;
01619 
01620     <span class="keywordflow">case</span> SNMP_ERR_TOOBIG:
01621         snmp_increment_statistic(STAT_SNMPOUTTOOBIGS);
01622         <span class="keywordflow">break</span>;
01623     }
01624 
01625     <span class="keywordflow">if</span> ((status == SNMP_ERR_NOERROR) &amp;&amp; (asp-&gt;pdu)) {
01626         snmp_increment_statistic_by((asp-&gt;pdu-&gt;command == SNMP_MSG_SET ?
01627                                      STAT_SNMPINTOTALSETVARS :
01628                                      STAT_SNMPINTOTALREQVARS),
01629                                     count_varbinds(asp-&gt;pdu-&gt;variables));
01630     } <span class="keywordflow">else</span> {
01631         <span class="comment">/*</span>
01632 <span class="comment">         * Use a copy of the original request</span>
01633 <span class="comment">         *   to report failures.</span>
01634 <span class="comment">         */</span>
01635         snmp_free_pdu(asp-&gt;pdu);
01636         asp-&gt;pdu = asp-&gt;orig_pdu;
01637         asp-&gt;orig_pdu = NULL;
01638     }
01639     <span class="keywordflow">if</span> (asp-&gt;pdu) {
01640         asp-&gt;pdu-&gt;<a class="code" href="structsnmp__pdu.html#o1">command</a> = SNMP_MSG_RESPONSE;
01641         asp-&gt;pdu-&gt;<a class="code" href="structsnmp__pdu.html#o6">errstat</a> = asp-&gt;status;
01642         asp-&gt;pdu-&gt;<a class="code" href="structsnmp__pdu.html#o7">errindex</a> = asp-&gt;index;
01643         <span class="keywordflow">if</span> (!snmp_send(asp-&gt;session, asp-&gt;pdu)) {
01644             <a class="code" href="structvariable__list.html">netsnmp_variable_list</a> *var_ptr;
01645             snmp_perror(<span class="stringliteral">"send response"</span>);
01646             <span class="keywordflow">for</span> (var_ptr = asp-&gt;pdu-&gt;variables; var_ptr != NULL;
01647                      var_ptr = var_ptr-&gt;<a class="code" href="structvariable__list.html#o0">next_variable</a>) {
01648                 size_t  c_oidlen = 256, c_outlen = 0;
01649                 u_char *c_oid = (u_char *) malloc(c_oidlen);
01650 
01651                 <span class="keywordflow">if</span> (c_oid) {
01652                     <span class=
"keywordflow">if</span> (!sprint_realloc_objid (&amp;c_oid, &amp;c_oidlen, &amp;c_outlen, 1,
01653                                                var_ptr-&gt;<a class="code" href="structvariable__list.html#o1">name</a>,
01654                                                var_ptr-&gt;<a class="code" href=
"structvariable__list.html#o2">name_length</a>)) {
01655                         <a class="code" href="group__snmp__logging.html#ga41">snmp_log</a>(LOG_ERR, <span class=
"stringliteral">"    -- %s [TRUNCATED]\n"</span>, c_oid);
01656                     } <span class="keywordflow">else</span> {
01657                         <a class="code" href="group__snmp__logging.html#ga41">snmp_log</a>(LOG_ERR, <span class=
"stringliteral">"    -- %s\n"</span>, c_oid);
01658                     }
01659                     <a class="code" href="group__util.html#ga36">SNMP_FREE</a>(c_oid);
01660                 }
01661             }
01662             snmp_free_pdu(asp-&gt;pdu);
01663             asp-&gt;pdu = NULL;
01664         }
01665         snmp_increment_statistic(STAT_SNMPOUTPKTS);
01666         snmp_increment_statistic(STAT_SNMPOUTGETRESPONSES);
01667         asp-&gt;pdu = NULL; <span class="comment">/* yyy-rks: redundant, no? */</span>
01668         netsnmp_remove_and_free_agent_snmp_session(asp);
01669     }
01670     <span class="keywordflow">return</span> 1;
01671 }
01672 
01673 <span class="keywordtype">void</span>
01674 dump_sess_list(<span class="keywordtype">void</span>)
01675 {
01676     netsnmp_agent_session *a;
01677 
01678     DEBUGMSGTL((<span class="stringliteral">"snmp_agent"</span>, <span class=
"stringliteral">"DUMP agent_sess_list -&gt; "</span>));
01679     <span class="keywordflow">for</span> (a = agent_session_list; a != NULL; a = a-&gt;next) {
01680         DEBUGMSG((<span class="stringliteral">"snmp_agent"</span>, <span class=
"stringliteral">"%08p[session %08p] -&gt; "</span>, a, a-&gt;session));
01681     }
01682     DEBUGMSG((<span class="stringliteral">"snmp_agent"</span>, <span class="stringliteral">"[NIL]\n"</span>));
01683 }
01684 
01685 <span class="keywordtype">void</span>
01686 netsnmp_remove_and_free_agent_snmp_session(netsnmp_agent_session *asp)
01687 {
01688     netsnmp_agent_session *a, **prevNext = &amp;agent_session_list;
01689 
01690     DEBUGMSGTL((<span class="stringliteral">"snmp_agent"</span>, <span class=
"stringliteral">"REMOVE session == %08p\n"</span>, asp));
01691 
01692     <span class="keywordflow">for</span> (a = agent_session_list; a != NULL; a = *prevNext) {
01693         <span class="keywordflow">if</span> (a == asp) {
01694             *prevNext = a-&gt;next;
01695             a-&gt;next = NULL;
01696             free_agent_snmp_session(a);
01697             asp = NULL;
01698             <span class="keywordflow">break</span>;
01699         } <span class="keywordflow">else</span> {
01700             prevNext = &amp;(a-&gt;next);
01701         }
01702     }
01703 
01704     <span class="keywordflow">if</span> (a == NULL &amp;&amp; asp != NULL) {
01705         <span class="comment">/*</span>
01706 <span class="comment">         * We coulnd't find it on the list, so free it anyway.  </span>
01707 <span class="comment">         */</span>
01708         free_agent_snmp_session(asp);
01709     }
01710 }
01711 
01712 <span class="keywordtype">void</span>
01713 netsnmp_free_agent_snmp_session_by_session(<a class="code" href="structsnmp__session.html">netsnmp_session</a> * sess,
01714                                            <span class="keywordtype">void</span> (*free_request)
01715                                            (netsnmp_request_list *))
01716 {
01717     netsnmp_agent_session *a, *next, **prevNext = &amp;agent_session_list;
01718 
01719     DEBUGMSGTL((<span class="stringliteral">"snmp_agent"</span>, <span class=
"stringliteral">"REMOVE session == %08p\n"</span>, sess));
01720 
01721     <span class="keywordflow">for</span> (a = agent_session_list; a != NULL; a = next) {
01722         <span class="keywordflow">if</span> (a-&gt;session == sess) {
01723             *prevNext = a-&gt;next;
01724             next = a-&gt;next;
01725             free_agent_snmp_session(a);
01726         } <span class="keywordflow">else</span> {
01727             prevNext = &amp;(a-&gt;next);
01728             next = a-&gt;next;
01729         }
01730     }
01731 }
01732 
01734 <span class="keywordtype">int</span>
<a name="l01735" id="l01735"></a><a class="code" href="group__snmp__agent.html#ga55">01735</a> <a class="code" href=
"group__snmp__agent.html#ga55">handle_snmp_packet</a>(<span class="keywordtype">int</span> op, <a class="code" href=
"structsnmp__session.html">netsnmp_session</a> * session, <span class="keywordtype">int</span> reqid,
01736                    <a class="code" href="structsnmp__pdu.html">netsnmp_pdu</a> *pdu, <span class=
"keywordtype">void</span> *magic)
01737 {
01738     netsnmp_agent_session *asp;
01739     <span class="keywordtype">int</span>             status, access_ret, rc;
01740 
01741     <span class="comment">/*</span>
01742 <span class="comment">     * We only support receiving here.  </span>
01743 <span class="comment">     */</span>
01744     <span class="keywordflow">if</span> (op != NETSNMP_CALLBACK_OP_RECEIVED_MESSAGE) {
01745         <span class="keywordflow">return</span> 1;
01746     }
01747 
01748     <span class="comment">/*</span>
01749 <span class="comment">     * RESPONSE messages won't get this far, but TRAP-like messages</span>
01750 <span class="comment">     * might.  </span>
01751 <span class="comment">     */</span>
01752     <span class="keywordflow">if</span> (pdu-&gt;<a class="code" href=
"structsnmp__pdu.html#o1">command</a> == SNMP_MSG_TRAP || pdu-&gt;<a class="code" href=
"structsnmp__pdu.html#o1">command</a> == SNMP_MSG_INFORM ||
01753         pdu-&gt;<a class="code" href="structsnmp__pdu.html#o1">command</a> == SNMP_MSG_TRAP2) {
01754         DEBUGMSGTL((<span class="stringliteral">"snmp_agent"</span>, <span class=
"stringliteral">"received trap-like PDU (%02x)\n"</span>,
01755                     pdu-&gt;<a class="code" href="structsnmp__pdu.html#o1">command</a>));
01756         pdu-&gt;<a class="code" href="structsnmp__pdu.html#o1">command</a> = SNMP_MSG_TRAP2;
01757         snmp_increment_statistic(STAT_SNMPUNKNOWNPDUHANDLERS);
01758         <span class="keywordflow">return</span> 1;
01759     }
01760 
01761     <span class="comment">/*</span>
01762 <span class="comment">     * send snmpv3 authfail trap.</span>
01763 <span class="comment">     */</span>
01764     <span class="keywordflow">if</span> (pdu-&gt;<a class="code" href=
"structsnmp__pdu.html#o0">version</a>  == SNMP_VERSION_3 &amp;&amp; 
01765         session-&gt;<a class="code" href=
"structsnmp__session.html#o14">s_snmp_errno</a> == SNMPERR_USM_AUTHENTICATIONFAILURE) {
01766            <a class="code" href="group__agent__trap.html#ga43">send_easy_trap</a>(SNMP_TRAP_AUTHFAIL, 0);
01767            <span class="keywordflow">return</span> 1;
01768     } 
01769         
01770     <span class="keywordflow">if</span> (magic == NULL) {
01771         asp = init_agent_snmp_session(session, pdu);
01772         status = SNMP_ERR_NOERROR;
01773     } <span class="keywordflow">else</span> {
01774         asp = (netsnmp_agent_session *) magic;
01775         status = asp-&gt;status;
01776     }
01777 
01778     <span class="keywordflow">if</span> ((access_ret = check_access(asp-&gt;pdu)) != 0) {
01779         <span class="keywordflow">if</span> (access_ret == VACM_NOSUCHCONTEXT) {
01780             <span class="comment">/*</span>
01781 <span class="comment">             * rfc3413 section 3.2, step 5 says that we increment the</span>
01782 <span class="comment">             * counter but don't return a response of any kind </span>
01783 <span class="comment">             */</span>
01784 
01785             <span class="comment">/*</span>
01786 <span class="comment">             * we currently don't support unavailable contexts, as</span>
01787 <span class="comment">             * there is no reason to that I currently know of </span>
01788 <span class="comment">             */</span>
01789             snmp_increment_statistic(STAT_SNMPUNKNOWNCONTEXTS);
01790 
01791             <span class="comment">/*</span>
01792 <span class="comment">             * drop the request </span>
01793 <span class="comment">             */</span>
01794             netsnmp_remove_and_free_agent_snmp_session(asp);
01795             <span class="keywordflow">return</span> 0;
01796         } <span class="keywordflow">else</span> {
01797             <span class="comment">/*</span>
01798 <span class="comment">             * access control setup is incorrect </span>
01799 <span class="comment">             */</span>
01800             <a class="code" href="group__agent__trap.html#ga43">send_easy_trap</a>(SNMP_TRAP_AUTHFAIL, 0);
01801 <span class="preprocessor">#if !defined(DISABLE_SNMPV1) || !defined(DISABLE_SNMPV2C)</span>
01802 <span class="preprocessor">#if defined(DISABLE_SNMPV1)</span>
01803             <span class="keywordflow">if</span> (asp-&gt;pdu-&gt;version != SNMP_VERSION_2c) {
01804 <span class="preprocessor">#else</span>
01805 <span class="preprocessor">#if defined(DISABLE_SNMPV2C)</span>
01806             <span class="keywordflow">if</span> (asp-&gt;pdu-&gt;version != SNMP_VERSION_1) {
01807 <span class="preprocessor">#else</span>
01808             <span class="keywordflow">if</span> (asp-&gt;pdu-&gt;version != SNMP_VERSION_1
01809                 &amp;&amp; asp-&gt;pdu-&gt;version != SNMP_VERSION_2c) {
01810 <span class="preprocessor">#endif</span>
01811 <span class="preprocessor">#endif</span>
01812                 asp-&gt;pdu-&gt;<a class="code" href="structsnmp__pdu.html#o6">errstat</a> = SNMP_ERR_AUTHORIZATIONERROR;
01813                 asp-&gt;pdu-&gt;<a class="code" href="structsnmp__pdu.html#o1">command</a> = SNMP_MSG_RESPONSE;
01814                 snmp_increment_statistic(STAT_SNMPOUTPKTS);
01815                 <span class="keywordflow">if</span> (!snmp_send(asp-&gt;session, asp-&gt;pdu))
01816                     snmp_free_pdu(asp-&gt;pdu);
01817                 asp-&gt;pdu = NULL;
01818                 netsnmp_remove_and_free_agent_snmp_session(asp);
01819                 <span class="keywordflow">return</span> 1;
01820             } <span class="keywordflow">else</span> {
01821 <span class="preprocessor">#endif </span><span class="comment">/* support for community based SNMP */</span>
01822                 <span class="comment">/*</span>
01823 <span class="comment">                 * drop the request </span>
01824 <span class="comment">                 */</span>
01825                 netsnmp_remove_and_free_agent_snmp_session(asp);
01826                 <span class="keywordflow">return</span> 0;
01827 <span class="preprocessor">#if !defined(DISABLE_SNMPV1) || !defined(DISABLE_SNMPV2C)</span>
01828             }
01829 <span class="preprocessor">#endif </span><span class="comment">/* support for community based SNMP */</span>
01830         }
01831     }
01832 
01833     rc = netsnmp_handle_request(asp, status);
01834 
01835     <span class="comment">/*</span>
01836 <span class="comment">     * done </span>
01837 <span class="comment">     */</span>
01838     DEBUGMSGTL((<span class="stringliteral">"snmp_agent"</span>, <span class=
"stringliteral">"end of handle_snmp_packet, asp = %08p\n"</span>,
01839                 asp));
01840     <span class="keywordflow">return</span> rc;
01841 }
01842 
01843 <a class="code" href="structnetsnmp__request__info__s.html">netsnmp_request_info</a> *
<a name="l01844" id="l01844"></a><a class="code" href="group__snmp__agent.html#ga56">01844</a> <a class="code" href=
"group__snmp__agent.html#ga56">netsnmp_add_varbind_to_cache</a>(netsnmp_agent_session *asp, <span class=
"keywordtype">int</span> vbcount,
01845                              <a class="code" href="structvariable__list.html">netsnmp_variable_list</a> * varbind_ptr,
01846                              netsnmp_subtree *tp)
01847 {
01848     <a class="code" href="structnetsnmp__request__info__s.html">netsnmp_request_info</a> *request = NULL;
01849     <span class="keywordtype">int</span>             cacheid;
01850 
01851     DEBUGMSGTL((<span class="stringliteral">"snmp_agent"</span>, <span class=
"stringliteral">"add_vb_to_cache(%8p, %d, "</span>, asp, vbcount));
01852     DEBUGMSGOID((<span class="stringliteral">"snmp_agent"</span>, varbind_ptr-&gt;<a class="code" href=
"structvariable__list.html#o1">name</a>,
01853                  varbind_ptr-&gt;<a class="code" href="structvariable__list.html#o2">name_length</a>));
01854     DEBUGMSG((<span class="stringliteral">"snmp_agent"</span>, <span class="stringliteral">", %8p)\n"</span>, tp));
01855 
01856     <span class="keywordflow">if</span> (tp &amp;&amp;
01857         (asp-&gt;pdu-&gt;command == SNMP_MSG_GETNEXT ||
01858          asp-&gt;pdu-&gt;command == SNMP_MSG_GETBULK)) {
01859         <span class="keywordtype">int</span> result;
01860         <span class="keywordtype">int</span> prefix_len;
01861 
01862         prefix_len = <a class="code" href="group__library.html#ga108">netsnmp_oid_find_prefix</a>(tp-&gt;start_a,
01863                                              tp-&gt;start_len,
01864                                              tp-&gt;end_a, tp-&gt;end_len);
01865         result =
01866             <a class="code" href=
"group__agent__registry.html#ga40">netsnmp_acm_check_subtree</a>(asp-&gt;pdu, tp-&gt;start_a, prefix_len);
01867 
01868         <span class="keywordflow">while</span> (result == VACM_NOTINVIEW) {
01869             <span class="comment">/* the entire subtree is not in view. Skip it. */</span>
01877             tp = tp-&gt;<a class="code" href="structnetsnmp__request__info__s.html#o13">next</a>;
01878             <span class="keywordflow">if</span> (tp) {
01879                 prefix_len = <a class="code" href="group__library.html#ga108">netsnmp_oid_find_prefix</a>(tp-&gt;start_a,
01880                                                      tp-&gt;start_len,
01881                                                      tp-&gt;end_a,
01882                                                      tp-&gt;end_len);
01883                 result =
01884                     <a class="code" href="group__agent__registry.html#ga40">netsnmp_acm_check_subtree</a>(asp-&gt;pdu,
01885                                               tp-&gt;start_a, prefix_len);
01886             }
01887             <span class="keywordflow">else</span>
01888                 <span class="keywordflow">break</span>;
01889         }
01890     }
01891     <span class="keywordflow">if</span> (tp == NULL) {
01892         <span class="comment">/*</span>
01893 <span class="comment">         * no appropriate registration found </span>
01894 <span class="comment">         */</span>
01895         <span class="comment">/*</span>
01896 <span class="comment">         * make up the response ourselves </span>
01897 <span class="comment">         */</span>
01898         <span class="keywordflow">switch</span> (asp-&gt;pdu-&gt;command) {
01899         <span class="keywordflow">case</span> SNMP_MSG_GETNEXT:
01900         <span class="keywordflow">case</span> SNMP_MSG_GETBULK:
01901             varbind_ptr-&gt;<a class="code" href="structvariable__list.html#o3">type</a> = SNMP_ENDOFMIBVIEW;
01902             <span class="keywordflow">break</span>;
01903 
01904         <span class="keywordflow">case</span> SNMP_MSG_SET:
01905         <span class="keywordflow">case</span> SNMP_MSG_GET:
01906             varbind_ptr-&gt;<a class="code" href="structvariable__list.html#o3">type</a> = SNMP_NOSUCHOBJECT;
01907             <span class="keywordflow">break</span>;
01908 
01909         <span class="keywordflow">default</span>:
01910             <span class="keywordflow">return</span> NULL;        <span class="comment">/* shouldn't get here */</span>
01911         }
01912     } <span class="keywordflow">else</span> {
01913         DEBUGMSGTL((<span class="stringliteral">"snmp_agent"</span>, <span class="stringliteral">"tp-&gt;start "</span>));
01914         DEBUGMSGOID((<span class="stringliteral">"snmp_agent"</span>, tp-&gt;start_a, tp-&gt;start_len));
01915         DEBUGMSG((<span class="stringliteral">"snmp_agent"</span>, <span class="stringliteral">", tp-&gt;end "</span>));
01916         DEBUGMSGOID((<span class="stringliteral">"snmp_agent"</span>, tp-&gt;end_a, tp-&gt;end_len));
01917         DEBUGMSG((<span class="stringliteral">"snmp_agent"</span>, <span class="stringliteral">", \n"</span>));
01918 
01919         <span class="comment">/*</span>
01920 <span class="comment">         * malloc the request structure </span>
01921 <span class="comment">         */</span>
01922         request = &amp;(asp-&gt;requests[vbcount - 1]);
01923         request-&gt;<a class="code" href="structnetsnmp__request__info__s.html#o9">index</a> = vbcount;
01924         request-&gt;<a class="code" href="structnetsnmp__request__info__s.html#o5">delegated</a> = 0;
01925         request-&gt;<a class="code" href="structnetsnmp__request__info__s.html#o6">processed</a> = 0;
01926         request-&gt;<a class="code" href="structnetsnmp__request__info__s.html#o8">status</a> = 0;
01927         request-&gt;<a class="code" href="structnetsnmp__request__info__s.html#o15">subtree</a> = tp;
01928         request-&gt;<a class="code" href="structnetsnmp__request__info__s.html#o2">agent_req_info</a> = asp-&gt;reqinfo;
01929         <span class="keywordflow">if</span> (request-&gt;<a class="code" href=
"structnetsnmp__request__info__s.html#o1">parent_data</a>) {
01930             <a class="code" href="group__handler.html#ga31">netsnmp_free_request_data_sets</a>(request);
01931         }
01932         DEBUGMSGTL((<span class="stringliteral">"verbose:asp"</span>, <span class=
"stringliteral">"asp %p reqinfo %p assigned to request\n"</span>,
01933                     asp, asp-&gt;reqinfo));
01934 
01935         <span class="comment">/*</span>
01936 <span class="comment">         * for non-SET modes, set the type to NULL </span>
01937 <span class="comment">         */</span>
01938         <span class="keywordflow">if</span> (!MODE_IS_SET(asp-&gt;pdu-&gt;command)) {
01939         DEBUGMSGTL((<span class="stringliteral">"verbose:asp"</span>, <span class=
"stringliteral">"asp %p reqinfo %p assigned to request\n"</span>,
01940                     asp, asp-&gt;reqinfo));
01941             <span class="keywordflow">if</span> (varbind_ptr-&gt;<a class="code" href=
"structvariable__list.html#o3">type</a> == ASN_PRIV_INCL_RANGE) {
01942                 DEBUGMSGTL((<span class="stringliteral">"snmp_agent"</span>, <span class=
"stringliteral">"varbind %d is inclusive\n"</span>,
01943                             request-&gt;<a class="code" href="structnetsnmp__request__info__s.html#o9">index</a>));
01944                 request-&gt;<a class="code" href="structnetsnmp__request__info__s.html#o7">inclusive</a> = 1;
01945             }
01946             varbind_ptr-&gt;<a class="code" href="structvariable__list.html#o3">type</a> = ASN_NULL;
01947         }
01948 
01949         <span class="comment">/*</span>
01950 <span class="comment">         * place them in a cache </span>
01951 <span class="comment">         */</span>
01952         <span class="keywordflow">if</span> (tp-&gt;global_cacheid) {
01953             <span class="comment">/*</span>
01954 <span class="comment">             * we need to merge all marked subtrees together </span>
01955 <span class="comment">             */</span>
01956             <span class="keywordflow">if</span> (asp-&gt;cache_store &amp;&amp; -1 !=
01957                 (cacheid = netsnmp_get_local_cachid(asp-&gt;cache_store,
01958                                                     tp-&gt;global_cacheid))) {
01959             } <span class="keywordflow">else</span> {
01960                 cacheid = ++(asp-&gt;treecache_num);
01961                 netsnmp_get_or_add_local_cachid(&amp;asp-&gt;cache_store,
01962                                                 tp-&gt;global_cacheid,
01963                                                 cacheid);
01964                 <span class="keywordflow">goto</span> mallocslot;        <span class="comment">/* XXX: ick */</span>
01965             }
01966         } <span class="keywordflow">else</span> <span class=
"keywordflow">if</span> (tp-&gt;cacheid &gt; -1 &amp;&amp; tp-&gt;cacheid &lt;= asp-&gt;treecache_num &amp;&amp;
01967                    asp-&gt;treecache[tp-&gt;cacheid].subtree == tp) {
01968             <span class="comment">/*</span>
01969 <span class="comment">             * we have already added a request to this tree</span>
01970 <span class="comment">             * pointer before </span>
01971 <span class="comment">             */</span>
01972             cacheid = tp-&gt;cacheid;
01973         } <span class="keywordflow">else</span> {
01974             cacheid = ++(asp-&gt;treecache_num);
01975           mallocslot:
01976             <span class="comment">/*</span>
01977 <span class="comment">             * new slot needed </span>
01978 <span class="comment">             */</span>
01979             <span class="keywordflow">if</span> (asp-&gt;treecache_num &gt;= asp-&gt;treecache_len) {
01980                 <span class="comment">/*</span>
01981 <span class="comment">                 * exapand cache array </span>
01982 <span class="comment">                 */</span>
01983                 <span class="comment">/*</span>
01984 <span class="comment">                 * WWW: non-linear expansion needed (with cap) </span>
01985 <span class="comment">                 */</span>
01986 <span class="preprocessor">#define CACHE_GROW_SIZE 16</span>
01987                 asp-&gt;treecache_len =
01988                     (asp-&gt;treecache_len + CACHE_GROW_SIZE);
01989                 asp-&gt;treecache =
01990                     realloc(asp-&gt;treecache,
01991                             <span class="keyword">sizeof</span>(netsnmp_tree_cache) *
01992                             asp-&gt;treecache_len);
01993                 <span class="keywordflow">if</span> (asp-&gt;treecache == NULL)
01994                     <span class="keywordflow">return</span> NULL;
01995                 memset(&amp;(asp-&gt;treecache[cacheid]), 0x00,
01996                        <span class="keyword">sizeof</span>(netsnmp_tree_cache) * (CACHE_GROW_SIZE));
01997             }
01998             asp-&gt;treecache[cacheid].subtree = tp;
01999             asp-&gt;treecache[cacheid].requests_begin = request;
02000             tp-&gt;cacheid = cacheid;
02001         }
02002 
02003         <span class="comment">/*</span>
02004 <span class="comment">         * if this is a search type, get the ending range oid as well </span>
02005 <span class="comment">         */</span>
02006         <span class="keywordflow">if</span> (asp-&gt;pdu-&gt;command == SNMP_MSG_GETNEXT ||
02007             asp-&gt;pdu-&gt;command == SNMP_MSG_GETBULK) {
02008             request-&gt;<a class="code" href="structnetsnmp__request__info__s.html#o3">range_end</a> = tp-&gt;end_a;
02009             request-&gt;<a class="code" href="structnetsnmp__request__info__s.html#o4">range_end_len</a> = tp-&gt;end_len;
02010         } <span class="keywordflow">else</span> {
02011             request-&gt;<a class="code" href="structnetsnmp__request__info__s.html#o3">range_end</a> = NULL;
02012             request-&gt;<a class="code" href="structnetsnmp__request__info__s.html#o4">range_end_len</a> = 0;
02013         }
02014 
02015         <span class="comment">/*</span>
02016 <span class="comment">         * link into chain </span>
02017 <span class="comment">         */</span>
02018         <span class="keywordflow">if</span> (asp-&gt;treecache[cacheid].requests_end)
02019             asp-&gt;treecache[cacheid].requests_end-&gt;<a class="code" href=
"structnetsnmp__request__info__s.html#o13">next</a> = request;
02020         request-&gt;<a class="code" href="structnetsnmp__request__info__s.html#o13">next</a> = NULL;
02021         request-&gt;<a class="code" href=
"structnetsnmp__request__info__s.html#o14">prev</a> = asp-&gt;treecache[cacheid].requests_end;
02022         asp-&gt;treecache[cacheid].requests_end = request;
02023 
02024         <span class="comment">/*</span>
02025 <span class="comment">         * add the given request to the list of requests they need</span>
02026 <span class="comment">         * to handle results for </span>
02027 <span class="comment">         */</span>
02028         request-&gt;<a class="code" href="structnetsnmp__request__info__s.html#o0">requestvb</a> = request-&gt;<a class=
"code" href="structnetsnmp__request__info__s.html#o12">requestvb_start</a> = varbind_ptr;
02029     }
02030     <span class="keywordflow">return</span> request;
02031 }
02032 
02033 <span class="comment">/*</span>
02034 <span class="comment"> * check the ACM(s) for the results on each of the varbinds.</span>
02035 <span class="comment"> * If ACM disallows it, replace the value with type</span>
02036 <span class="comment"> * </span>
02037 <span class="comment"> * Returns number of varbinds with ACM errors</span>
02038 <span class="comment"> */</span>
02039 <span class="keywordtype">int</span>
02040 check_acm(netsnmp_agent_session *asp, u_char type)
02041 {
02042     <span class="keywordtype">int</span>             view;
02043     <span class="keywordtype">int</span>             i, j, k;
02044     <a class="code" href="structnetsnmp__request__info__s.html">netsnmp_request_info</a> *request;
02045     <span class="keywordtype">int</span>             ret = 0;
02046     <a class="code" href="structvariable__list.html">netsnmp_variable_list</a> *vb, *vb2, *vbc;
02047     <span class="keywordtype">int</span>             earliest = 0;
02048 
02049     <span class="keywordflow">for</span> (i = 0; i &lt;= asp-&gt;treecache_num; i++) {
02050         <span class="keywordflow">for</span> (request = asp-&gt;treecache[i].requests_begin;
02051              request; request = request-&gt;<a class="code" href="structnetsnmp__request__info__s.html#o13">next</a>) {
02052             <span class="comment">/*</span>
02053 <span class="comment">             * for each request, run it through in_a_view() </span>
02054 <span class="comment">             */</span>
02055             earliest = 0;
02056             <span class="keywordflow">for</span>(j = request-&gt;<a class="code" href=
"structnetsnmp__request__info__s.html#o10">repeat</a>, vb = request-&gt;<a class="code" href=
"structnetsnmp__request__info__s.html#o12">requestvb_start</a>;
02057                 vb &amp;&amp; j &gt; -1;
02058                 j--, vb = vb-&gt;<a class="code" href="structvariable__list.html#o0">next_variable</a>) {
02059                 <span class="keywordflow">if</span> (vb-&gt;type != ASN_NULL &amp;&amp;
02060                     vb-&gt;type != ASN_PRIV_RETRY) { <span class="comment">/* not yet processed */</span>
02061                     view =
02062                         in_a_view(vb-&gt;name, &amp;vb-&gt;name_length,
02063                                   asp-&gt;pdu, vb-&gt;type);
02064 
02065                     <span class="comment">/*</span>
02066 <span class="comment">                     * if a ACM error occurs, mark it as type passed in </span>
02067 <span class="comment">                     */</span>
02068                     <span class="keywordflow">if</span> (view != VACM_SUCCESS) {
02069                         ret++;
02070                         <span class="keywordflow">if</span> (request-&gt;<a class="code" href=
"structnetsnmp__request__info__s.html#o10">repeat</a> &lt; request-&gt;<a class="code" href=
"structnetsnmp__request__info__s.html#o11">orig_repeat</a>) {
02071                             <span class="comment">/* basically this means a GETBULK */</span>
02072                             request-&gt;<a class="code" href="structnetsnmp__request__info__s.html#o10">repeat</a>++;
02073                             <span class="keywordflow">if</span> (!earliest) {
02074                                 request-&gt;<a class="code" href=
"structnetsnmp__request__info__s.html#o0">requestvb</a> = vb;
02075                                 earliest = 1;
02076                             }
02077 
02078                             <span class="comment">/* ugh.  if a whole now exists, we need to</span>
02079 <span class="comment">                               move the contents up the chain and fill</span>
02080 <span class="comment">                               in at the end else we won't end up</span>
02081 <span class="comment">                               lexographically sorted properly */</span>
02082                             <span class="keywordflow">if</span> (j &gt; -1 &amp;&amp; vb-&gt;next_variable &amp;&amp;
02083                                 vb-&gt;next_variable-&gt;type != ASN_NULL &amp;&amp;
02084                                 vb-&gt;next_variable-&gt;type != ASN_PRIV_RETRY) {
02085                                 <span class="keywordflow">for</span>(k = j, vbc = vb, vb2 = vb-&gt;<a class="code" href=
"structvariable__list.html#o0">next_variable</a>;
02086                                     k &gt; -2 &amp;&amp; vbc &amp;&amp; vb2;
02087                                     k--, vbc = vb2, vb2 = vb2-&gt;<a class="code" href=
"structvariable__list.html#o0">next_variable</a>) {
02088                                     <span class="comment">/* clone next into the current */</span>
02089                                     snmp_clone_var(vb2, vbc);
02090                                     vbc-&gt;<a class="code" href="structvariable__list.html#o0">next_variable</a> = vb2;
02091                                 }
02092                             }
02093                         }
02094                         <a class="code" href=
"group__snmp__client.html#ga19">snmp_set_var_typed_value</a>(vb, type, NULL, 0);
02095                     }
02096                 }
02097             }
02098         }
02099     }
02100     <span class="keywordflow">return</span> ret;
02101 }
02102 
02103 
02104 <span class="keywordtype">int</span>
02105 netsnmp_create_subtree_cache(netsnmp_agent_session *asp)
02106 {
02107     netsnmp_subtree *tp;
02108     <a class="code" href="structvariable__list.html">netsnmp_variable_list</a> *varbind_ptr, *vbsave, *vbptr, **prevNext;
02109     <span class="keywordtype">int</span>             view;
02110     <span class="keywordtype">int</span>             vbcount = 0;
02111     <span class="keywordtype">int</span>             bulkcount = 0, bulkrep = 0;
02112     <span class="keywordtype">int</span>             i = 0, n = 0, r = 0;
02113     <a class="code" href="structnetsnmp__request__info__s.html">netsnmp_request_info</a> *request;
02114 
02115     <span class="keywordflow">if</span> (asp-&gt;treecache == NULL &amp;&amp; asp-&gt;treecache_len == 0) {
02116         asp-&gt;treecache_len = <a class="code" href="group__util.html#ga45">SNMP_MAX</a>(1 + asp-&gt;vbcount / 4, 16);
02117         asp-&gt;treecache =
02118             calloc(asp-&gt;treecache_len, <span class="keyword">sizeof</span>(netsnmp_tree_cache));
02119         <span class="keywordflow">if</span> (asp-&gt;treecache == NULL)
02120             <span class="keywordflow">return</span> SNMP_ERR_GENERR;
02121     }
02122     asp-&gt;treecache_num = -1;
02123 
02124     <span class="keywordflow">if</span> (asp-&gt;pdu-&gt;command == SNMP_MSG_GETBULK) {
02125         <span class="comment">/*</span>
02126 <span class="comment">         * getbulk prep </span>
02127 <span class="comment">         */</span>
02128         <span class="keywordtype">int</span>             count = count_varbinds(asp-&gt;pdu-&gt;variables);
02129 
02130         <span class="keywordflow">if</span> (asp-&gt;pdu-&gt;errstat &lt; 0) {
02131             asp-&gt;pdu-&gt;errstat = 0;
02132         }
02133         <span class="keywordflow">if</span> (asp-&gt;pdu-&gt;errindex &lt; 0) {
02134             asp-&gt;pdu-&gt;errindex = 0;
02135         }
02136 
02137         <span class="keywordflow">if</span> (asp-&gt;pdu-&gt;errstat &lt; count) {
02138             n = asp-&gt;pdu-&gt;errstat;
02139         } <span class="keywordflow">else</span> {
02140             n = count;
02141         }
02142         <span class="keywordflow">if</span> ((r = count - n) &lt;= 0) {
02143             r = 0;
02144             asp-&gt;bulkcache = NULL;
02145         } <span class="keywordflow">else</span> {
02146             asp-&gt;bulkcache =
02147                 (<a class="code" href=
"structvariable__list.html">netsnmp_variable_list</a> **) malloc(asp-&gt;pdu-&gt;errindex * r *
02148                                                   <span class="keyword">sizeof</span>(<span class="keyword">struct</span>
02149                                                          varbind_list *));
02150         }
02151         DEBUGMSGTL((<span class="stringliteral">"snmp_agent"</span>, <span class=
"stringliteral">"GETBULK N = %d, M = %d, R = %d\n"</span>,
02152                     n, asp-&gt;pdu-&gt;errindex, r));
02153     }
02154 
02155     <span class="comment">/*</span>
02156 <span class="comment">     * collect varbinds into their registered trees </span>
02157 <span class="comment">     */</span>
02158     prevNext = &amp;(asp-&gt;pdu-&gt;variables);
02159     <span class="keywordflow">for</span> (varbind_ptr = asp-&gt;pdu-&gt;variables; varbind_ptr;
02160          varbind_ptr = vbsave) {
02161 
02162         <span class="comment">/*</span>
02163 <span class="comment">         * getbulk mess with this pointer, so save it </span>
02164 <span class="comment">         */</span>
02165         vbsave = varbind_ptr-&gt;<a class="code" href="structvariable__list.html#o0">next_variable</a>;
02166 
02167         <span class="keywordflow">if</span> (asp-&gt;pdu-&gt;command == SNMP_MSG_GETBULK) {
02168             <span class="keywordflow">if</span> (n &gt; 0) {
02169                 n--;
02170             } <span class="keywordflow">else</span> {
02171                 <span class="comment">/*</span>
02172 <span class="comment">                 * repeate request varbinds on GETBULK.  These will</span>
02173 <span class="comment">                 * have to be properly rearranged later though as</span>
02174 <span class="comment">                 * responses are supposed to actually be interlaced</span>
02175 <span class="comment">                 * with each other.  This is done with the asp-&gt;bulkcache. </span>
02176 <span class="comment">                 */</span>
02177                 bulkrep = asp-&gt;pdu-&gt;errindex - 1;
02178                 <span class="keywordflow">if</span> (asp-&gt;pdu-&gt;errindex &gt; 0) {
02179                     vbptr = varbind_ptr;
02180                     asp-&gt;bulkcache[bulkcount++] = vbptr;
02181 
02182                     <span class="keywordflow">for</span> (i = 1; i &lt; asp-&gt;pdu-&gt;errindex; i++) {
02183                         vbptr-&gt;<a class="code" href="structvariable__list.html#o0">next_variable</a> =
02184                             <a class="code" href="group__util.html#ga38">SNMP_MALLOC_STRUCT</a>(<a class="code" href=
"structvariable__list.html">variable_list</a>);
02185                         <span class="comment">/*</span>
02186 <span class="comment">                         * don't clone the oid as it's got to be</span>
02187 <span class="comment">                         * overwwritten anyway </span>
02188 <span class="comment">                         */</span>
02189                         <span class="keywordflow">if</span> (!vbptr-&gt;<a class="code" href=
"structvariable__list.html#o0">next_variable</a>) {
02190                             <span class="comment">/*</span>
02191 <span class="comment">                             * XXXWWW: ack!!! </span>
02192 <span class="comment">                             */</span>
02193                         } <span class="keywordflow">else</span> {
02194                             vbptr = vbptr-&gt;<a class="code" href="structvariable__list.html#o0">next_variable</a>;
02195                             vbptr-&gt;<a class="code" href="structvariable__list.html#o2">name_length</a> = 0;
02196                             vbptr-&gt;<a class="code" href="structvariable__list.html#o3">type</a> = ASN_NULL;
02197                             asp-&gt;bulkcache[bulkcount++] = vbptr;
02198                         }
02199                     }
02200                     vbptr-&gt;<a class="code" href="structvariable__list.html#o0">next_variable</a> = vbsave;
02201                 } <span class="keywordflow">else</span> {
02202                     <span class="comment">/*</span>
02203 <span class="comment">                     * 0 repeats requested for this varbind, so take it off</span>
02204 <span class="comment">                     * the list.  </span>
02205 <span class="comment">                     */</span>
02206                     vbptr = varbind_ptr;
02207                     *prevNext = vbptr-&gt;<a class="code" href="structvariable__list.html#o0">next_variable</a>;
02208                     vbptr-&gt;<a class="code" href="structvariable__list.html#o0">next_variable</a> = NULL;
02209                     snmp_free_varbind(vbptr);
02210                     asp-&gt;vbcount--;
02211                     <span class="keywordflow">continue</span>;
02212                 }
02213             }
02214         }
02215 
02216         <span class="comment">/*</span>
02217 <span class="comment">         * count the varbinds </span>
02218 <span class="comment">         */</span>
02219         ++vbcount;
02220 
02221         <span class="comment">/*</span>
02222 <span class="comment">         * find the owning tree </span>
02223 <span class="comment">         */</span>
02224         tp = netsnmp_subtree_find(varbind_ptr-&gt;<a class="code" href=
"structvariable__list.html#o1">name</a>, varbind_ptr-&gt;<a class="code" href="structvariable__list.html#o2">name_length</a>,
02225                                   NULL, asp-&gt;pdu-&gt;contextName);
02226 
02227         <span class="comment">/*</span>
02228 <span class="comment">         * check access control </span>
02229 <span class="comment">         */</span>
02230         <span class="keywordflow">switch</span> (asp-&gt;pdu-&gt;command) {
02231         <span class="keywordflow">case</span> SNMP_MSG_GET:
02232             view = in_a_view(varbind_ptr-&gt;<a class="code" href=
"structvariable__list.html#o1">name</a>, &amp;varbind_ptr-&gt;<a class="code" href=
"structvariable__list.html#o2">name_length</a>,
02233                              asp-&gt;pdu, varbind_ptr-&gt;<a class="code" href="structvariable__list.html#o3">type</a>);
02234             <span class="keywordflow">if</span> (view != VACM_SUCCESS)
02235                 <a class="code" href=
"group__snmp__client.html#ga19">snmp_set_var_typed_value</a>(varbind_ptr, SNMP_NOSUCHOBJECT,
02236                                          NULL, 0);
02237             <span class="keywordflow">break</span>;
02238 
02239         <span class="keywordflow">case</span> SNMP_MSG_SET:
02240             view = in_a_view(varbind_ptr-&gt;<a class="code" href=
"structvariable__list.html#o1">name</a>, &amp;varbind_ptr-&gt;<a class="code" href=
"structvariable__list.html#o2">name_length</a>,
02241                              asp-&gt;pdu, varbind_ptr-&gt;<a class="code" href="structvariable__list.html#o3">type</a>);
02242             <span class="keywordflow">if</span> (view != VACM_SUCCESS)
02243                 <span class="keywordflow">return</span> SNMP_ERR_NOTWRITABLE;
02244             <span class="keywordflow">break</span>;
02245 
02246         <span class="keywordflow">case</span> SNMP_MSG_GETNEXT:
02247         <span class="keywordflow">case</span> SNMP_MSG_GETBULK:
02248         <span class="keywordflow">default</span>:
02249             view = VACM_SUCCESS;
02250             <span class="comment">/*</span>
02251 <span class="comment">             * XXXWWW: check VACM here to see if "tp" is even worthwhile </span>
02252 <span class="comment">             */</span>
02253         }
02254         <span class="keywordflow">if</span> (view == VACM_SUCCESS) {
02255             request = <a class="code" href=
"group__snmp__agent.html#ga56">netsnmp_add_varbind_to_cache</a>(asp, vbcount, varbind_ptr,
02256                                                    tp);
02257             <span class="keywordflow">if</span> (request &amp;&amp; asp-&gt;pdu-&gt;command == SNMP_MSG_GETBULK) {
02258                 request-&gt;<a class="code" href=
"structnetsnmp__request__info__s.html#o10">repeat</a> = request-&gt;<a class="code" href=
"structnetsnmp__request__info__s.html#o11">orig_repeat</a> = bulkrep;
02259             }
02260         }
02261 
02262         prevNext = &amp;(varbind_ptr-&gt;<a class="code" href="structvariable__list.html#o0">next_variable</a>);
02263     }
02264 
02265     <span class="keywordflow">return</span> SNMPERR_SUCCESS;
02266 }
02267 
02268 <span class="comment">/*</span>
02269 <span class="comment"> * this function is only applicable in getnext like contexts </span>
02270 <span class="comment"> */</span>
02271 <span class="keywordtype">int</span>
02272 netsnmp_reassign_requests(netsnmp_agent_session *asp)
02273 {
02274     <span class="comment">/*</span>
02275 <span class="comment">     * assume all the requests have been filled or rejected by the</span>
02276 <span class="comment">     * subtrees, so reassign the rejected ones to the next subtree in</span>
02277 <span class="comment">     * the chain </span>
02278 <span class="comment">     */</span>
02279 
02280     <span class="keywordtype">int</span>             i;
02281 
02282     <span class="comment">/*</span>
02283 <span class="comment">     * get old info </span>
02284 <span class="comment">     */</span>
02285     netsnmp_tree_cache *old_treecache = asp-&gt;treecache;
02286 
02287     <span class="comment">/*</span>
02288 <span class="comment">     * malloc new space </span>
02289 <span class="comment">     */</span>
02290     asp-&gt;treecache =
02291         (netsnmp_tree_cache *) calloc(asp-&gt;treecache_len,
02292                                       <span class="keyword">sizeof</span>(netsnmp_tree_cache));
02293     asp-&gt;treecache_num = -1;
02294     <span class="keywordflow">if</span> (asp-&gt;cache_store) {
02295         netsnmp_free_cachemap(asp-&gt;cache_store);
02296         asp-&gt;cache_store = NULL;
02297     }
02298 
02299     <span class="keywordflow">for</span> (i = 0; i &lt; asp-&gt;vbcount; i++) {
02300         <span class="keywordflow">if</span> (asp-&gt;requests[i].requestvb == NULL) {
02301             <span class="comment">/*</span>
02302 <span class="comment">             * Occurs when there's a mixture of still active</span>
02303 <span class="comment">             *   and "endOfMibView" repetitions</span>
02304 <span class="comment">             */</span>
02305             <span class="keywordflow">continue</span>;
02306         }
02307         <span class="keywordflow">if</span> (asp-&gt;requests[i].requestvb-&gt;type == ASN_NULL) {
02308             <span class="keywordflow">if</span> (!<a class="code" href=
"group__snmp__agent.html#ga56">netsnmp_add_varbind_to_cache</a>(asp, asp-&gt;requests[i].index,
02309                                               asp-&gt;requests[i].requestvb,
02310                                               asp-&gt;requests[i].subtree-&gt;next)) {
02311                 <span class="keywordflow">if</span> (old_treecache != NULL) {
02312                     <a class="code" href="group__util.html#ga36">SNMP_FREE</a>(old_treecache);
02313                     old_treecache = NULL;
02314                 }
02315             }
02316         } <span class="keywordflow">else</span> <span class=
"keywordflow">if</span> (asp-&gt;requests[i].requestvb-&gt;type == ASN_PRIV_RETRY) {
02317             <span class="comment">/*</span>
02318 <span class="comment">             * re-add the same subtree </span>
02319 <span class="comment">             */</span>
02320             asp-&gt;requests[i].requestvb-&gt;<a class="code" href="structvariable__list.html#o3">type</a> = ASN_NULL;
02321             <span class="keywordflow">if</span> (!<a class="code" href=
"group__snmp__agent.html#ga56">netsnmp_add_varbind_to_cache</a>(asp, asp-&gt;requests[i].index,
02322                                               asp-&gt;requests[i].requestvb,
02323                                               asp-&gt;requests[i].subtree)) {
02324                 <span class="keywordflow">if</span> (old_treecache != NULL) {
02325                     <a class="code" href="group__util.html#ga36">SNMP_FREE</a>(old_treecache);
02326                     old_treecache = NULL;
02327                 }
02328             }
02329         }
02330     }
02331 
02332     <span class="keywordflow">if</span> (old_treecache != NULL) {
02333         <a class="code" href="group__util.html#ga36">SNMP_FREE</a>(old_treecache);
02334     }
02335     <span class="keywordflow">return</span> SNMP_ERR_NOERROR;
02336 }
02337 
02338 <span class="keywordtype">void</span>
02339 netsnmp_delete_request_infos(<a class="code" href="structnetsnmp__request__info__s.html">netsnmp_request_info</a> *reqlist)
02340 {
02341     <span class="keywordflow">while</span> (reqlist) {
02342         <a class="code" href="group__handler.html#ga31">netsnmp_free_request_data_sets</a>(reqlist);
02343         reqlist = reqlist-&gt;<a class="code" href="structnetsnmp__request__info__s.html#o13">next</a>;
02344     }
02345 }
02346 
02347 <span class="keywordtype">void</span>
02348 netsnmp_delete_subtree_cache(netsnmp_agent_session *asp)
02349 {
02350     <span class="keywordflow">while</span> (asp-&gt;treecache_num &gt;= 0) {
02351         <span class="comment">/*</span>
02352 <span class="comment">         * don't delete subtrees </span>
02353 <span class="comment">         */</span>
02354         netsnmp_delete_request_infos(asp-&gt;treecache[asp-&gt;treecache_num].
02355                                      requests_begin);
02356         asp-&gt;treecache_num--;
02357     }
02358 }
02359 
02360 <span class="comment">/*</span>
02361 <span class="comment"> * check all requests for errors</span>
02362 <span class="comment"> *</span>
02363 <span class="comment"> * @Note:</span>
02364 <span class="comment"> * This function is a little different from the others in that</span>
02365 <span class="comment"> * it does not use any linked lists, instead using the original</span>
02366 <span class="comment"> * asp requests array. This is of particular importance for</span>
02367 <span class="comment"> * cases where the linked lists are unreliable. One known instance</span>
02368 <span class="comment"> * of this scenario occurs when the row_merge helper is used, which</span>
02369 <span class="comment"> * may temporarily disrupts linked lists during its (and its childrens)</span>
02370 <span class="comment"> * handling of requests.</span>
02371 <span class="comment"> */</span>
02372 <span class="keywordtype">int</span>
02373 netsnmp_check_all_requests_error(netsnmp_agent_session *asp,
02374                                  <span class="keywordtype">int</span> look_for_specific)
02375 {
02376     <span class="keywordtype">int</span> i;
02377 
02378     <span class="comment">/*</span>
02379 <span class="comment">     * find any errors marked in the requests </span>
02380 <span class="comment">     */</span>
02381     <span class="keywordflow">for</span>( i = 0; i &lt; asp-&gt;vbcount; ++i ) {
02382         <span class="keywordflow">if</span> ((SNMP_ERR_NOERROR != asp-&gt;requests[i].status) &amp;&amp;
02383             (!look_for_specific ||
02384              asp-&gt;requests[i].status == look_for_specific))
02385             <span class="keywordflow">return</span> asp-&gt;requests[i].<a class="code" href=
"structnetsnmp__request__info__s.html#o8">status</a>;
02386     }
02387 
02388     <span class="keywordflow">return</span> SNMP_ERR_NOERROR;
02389 }
02390 
02391 <span class="keywordtype">int</span>
02392 netsnmp_check_requests_error(<a class="code" href=
"structnetsnmp__request__info__s.html">netsnmp_request_info</a> *requests)
02393 {
02394     <span class="comment">/*</span>
02395 <span class="comment">     * find any errors marked in the requests </span>
02396 <span class="comment">     */</span>
02397     <span class="keywordflow">for</span> (;requests;requests = requests-&gt;<a class="code" href=
"structnetsnmp__request__info__s.html#o13">next</a>) {
02398         <span class="keywordflow">if</span> (requests-&gt;<a class="code" href=
"structnetsnmp__request__info__s.html#o8">status</a> != SNMP_ERR_NOERROR)
02399             <span class="keywordflow">return</span> requests-&gt;<a class="code" href=
"structnetsnmp__request__info__s.html#o8">status</a>;
02400     }
02401     <span class="keywordflow">return</span> SNMP_ERR_NOERROR;
02402 }
02403 
02404 <span class="keywordtype">int</span>
02405 netsnmp_check_requests_status(netsnmp_agent_session *asp,
02406                               <a class="code" href=
"structnetsnmp__request__info__s.html">netsnmp_request_info</a> *requests,
02407                               <span class="keywordtype">int</span> look_for_specific)
02408 {
02409     <span class="comment">/*</span>
02410 <span class="comment">     * find any errors marked in the requests </span>
02411 <span class="comment">     */</span>
02412     <span class="keywordflow">while</span> (requests) {
02413         <span class="keywordflow">if</span>(requests-&gt;<a class="code" href=
"structnetsnmp__request__info__s.html#o2">agent_req_info</a> != asp-&gt;reqinfo) {
02414             DEBUGMSGTL((<span class="stringliteral">"verbose:asp"</span>,
02415                         <span class="stringliteral">"**reqinfo %p doesn't match cached reqinfo %p\n"</span>,
02416                         asp-&gt;reqinfo, requests-&gt;<a class="code" href=
"structnetsnmp__request__info__s.html#o2">agent_req_info</a>));
02417         }
02418         <span class="keywordflow">if</span> (requests-&gt;<a class="code" href=
"structnetsnmp__request__info__s.html#o8">status</a> != SNMP_ERR_NOERROR &amp;&amp;
02419             (!look_for_specific || requests-&gt;<a class="code" href=
"structnetsnmp__request__info__s.html#o8">status</a> == look_for_specific)
02420             &amp;&amp; (look_for_specific || asp-&gt;index == 0
02421                 || requests-&gt;<a class="code" href=
"structnetsnmp__request__info__s.html#o9">index</a> &lt; asp-&gt;<a class="code" href=
"structnetsnmp__request__info__s.html#o9">index</a>)) {
02422             asp-&gt;<a class="code" href="structnetsnmp__request__info__s.html#o9">index</a> = requests-&gt;<a class="code"
href="structnetsnmp__request__info__s.html#o9">index</a>;
02423             asp-&gt;<a class="code" href="structnetsnmp__request__info__s.html#o8">status</a> = requests-&gt;<a class=
"code" href="structnetsnmp__request__info__s.html#o8">status</a>;
02424         }
02425         requests = requests-&gt;<a class="code" href="structnetsnmp__request__info__s.html#o13">next</a>;
02426     }
02427     <span class="keywordflow">return</span> asp-&gt;<a class="code" href=
"structnetsnmp__request__info__s.html#o8">status</a>;
02428 }
02429 
02430 <span class="keywordtype">int</span>
02431 netsnmp_check_all_requests_status(netsnmp_agent_session *asp,
02432                                   <span class="keywordtype">int</span> look_for_specific)
02433 {
02434     <span class="keywordtype">int</span>             i;
02435     <span class="keywordflow">for</span> (i = 0; i &lt;= asp-&gt;treecache_num; i++) {
02436         netsnmp_check_requests_status(asp,
02437                                       asp-&gt;treecache[i].requests_begin,
02438                                       look_for_specific);
02439     }
02440     <span class="keywordflow">return</span> asp-&gt;<a class="code" href=
"structnetsnmp__request__info__s.html#o8">status</a>;
02441 }
02442 
02443 <span class="keywordtype">int</span>
02444 handle_var_requests(netsnmp_agent_session *asp)
02445 {
02446     <span class="keywordtype">int</span>             i, retstatus = SNMP_ERR_NOERROR,
02447         status = SNMP_ERR_NOERROR, final_status = SNMP_ERR_NOERROR;
02448     <a class="code" href="structnetsnmp__handler__registration__s.html">netsnmp_handler_registration</a> *reginfo;
02449 
02450     asp-&gt;reqinfo-&gt;asp = asp;
02451     asp-&gt;reqinfo-&gt;mode = asp-&gt;mode;
02452 
02453     <span class="comment">/*</span>
02454 <span class="comment">     * now, have the subtrees in the cache go search for their results </span>
02455 <span class="comment">     */</span>
02456     <span class="keywordflow">for</span> (i = 0; i &lt;= asp-&gt;treecache_num; i++) {
02457         <span class="comment">/*</span>
02458 <span class="comment">         * don't call handlers w/null reginfo.</span>
02459 <span class="comment">         * - when is this? sub agent disconnected while request processing?</span>
02460 <span class="comment">         * - should this case encompass more of this subroutine?</span>
02461 <span class="comment">         *   - does check_request_status make send if handlers weren't called?</span>
02462 <span class="comment">         */</span>
02463         <span class="keywordflow">if</span>(NULL != asp-&gt;treecache[i].subtree-&gt;reginfo) {
02464             reginfo = asp-&gt;treecache[i].subtree-&gt;reginfo;
02465             status = netsnmp_call_handlers(reginfo, asp-&gt;reqinfo,
02466                                            asp-&gt;treecache[i].requests_begin);
02467         }
02468         <span class="keywordflow">else</span>
02469             status = SNMP_ERR_GENERR;
02470 
02471         <span class="comment">/*</span>
02472 <span class="comment">         * find any errors marked in the requests.  For later parts of</span>
02473 <span class="comment">         * SET processing, only check for new errors specific to that</span>
02474 <span class="comment">         * set processing directive (which must superceed the previous</span>
02475 <span class="comment">         * errors).</span>
02476 <span class="comment">         */</span>
02477         <span class="keywordflow">switch</span> (asp-&gt;mode) {
02478         <span class="keywordflow">case</span> MODE_SET_COMMIT:
02479             retstatus = netsnmp_check_requests_status(asp,
02480                                                       asp-&gt;treecache[i].
02481                                                       requests_begin,
02482                                                       SNMP_ERR_COMMITFAILED);
02483             <span class="keywordflow">break</span>;
02484 
02485         <span class="keywordflow">case</span> MODE_SET_UNDO:
02486             retstatus = netsnmp_check_requests_status(asp,
02487                                                       asp-&gt;treecache[i].
02488                                                       requests_begin,
02489                                                       SNMP_ERR_UNDOFAILED);
02490             <span class="keywordflow">break</span>;
02491 
02492         <span class="keywordflow">default</span>:
02493             retstatus = netsnmp_check_requests_status(asp,
02494                                                       asp-&gt;treecache[i].
02495                                                       requests_begin, 0);
02496             <span class="keywordflow">break</span>;
02497         }
02498 
02499         <span class="comment">/*</span>
02500 <span class="comment">         * always take lowest varbind if possible </span>
02501 <span class="comment">         */</span>
02502         <span class="keywordflow">if</span> (retstatus != SNMP_ERR_NOERROR) {
02503             status = retstatus;
02504         }
02505 
02506         <span class="comment">/*</span>
02507 <span class="comment">         * other things we know less about (no index) </span>
02508 <span class="comment">         */</span>
02509         <span class="comment">/*</span>
02510 <span class="comment">         * WWW: drop support for this? </span>
02511 <span class="comment">         */</span>
02512         <span class="keywordflow">if</span> (final_status == SNMP_ERR_NOERROR &amp;&amp; status != SNMP_ERR_NOERROR) {
02513             <span class="comment">/*</span>
02514 <span class="comment">             * we can't break here, since some processing needs to be</span>
02515 <span class="comment">             * done for all requests anyway (IE, SET handling for UNDO</span>
02516 <span class="comment">             * needs to be called regardless of previous status</span>
02517 <span class="comment">             * results.</span>
02518 <span class="comment">             * WWW:  This should be predictable though and</span>
02519 <span class="comment">             * breaking should be possible in some cases (eg GET,</span>
02520 <span class="comment">             * GETNEXT, ...) </span>
02521 <span class="comment">             */</span>
02522             final_status = status;
02523         }
02524     }
02525 
02526     <span class="keywordflow">return</span> final_status;
02527 }
02528 
02529 <span class="comment">/*</span>
02530 <span class="comment"> * loop through our sessions known delegated sessions and check to see</span>
02531 <span class="comment"> * if they've completed yet. If there are no more delegated sessions,</span>
02532 <span class="comment"> * check for and process any queued requests</span>
02533 <span class="comment"> */</span>
02534 <span class="keywordtype">void</span>
02535 netsnmp_check_outstanding_agent_requests(<span class="keywordtype">void</span>)
02536 {
02537     netsnmp_agent_session *asp, *prev_asp = NULL, *next_asp = NULL;
02538 
02539     <span class="comment">/*</span>
02540 <span class="comment">     * deal with delegated requests</span>
02541 <span class="comment">     */</span>
02542     <span class="keywordflow">for</span> (asp = agent_delegated_list; asp; asp = next_asp) {
02543         next_asp = asp-&gt;next;   <span class="comment">/* save in case we clean up asp */</span>
02544         <span class="keywordflow">if</span> (!netsnmp_check_for_delegated(asp)) {
02545 
02546             <span class="comment">/*</span>
02547 <span class="comment">             * we're done with this one, remove from queue </span>
02548 <span class="comment">             */</span>
02549             <span class="keywordflow">if</span> (prev_asp != NULL)
02550                 prev_asp-&gt;next = asp-&gt;next;
02551             <span class="keywordflow">else</span>
02552                 agent_delegated_list = asp-&gt;next;
02553             asp-&gt;next = NULL;
02554 
02555             <span class="comment">/*</span>
02556 <span class="comment">             * check request status</span>
02557 <span class="comment">             */</span>
02558             netsnmp_check_all_requests_status(asp, 0);
02559             
02560             <span class="comment">/*</span>
02561 <span class="comment">             * continue processing or finish up </span>
02562 <span class="comment">             */</span>
02563             check_delayed_request(asp);
02564 
02565             <span class="comment">/*</span>
02566 <span class="comment">             * if head was removed, don't drop it if it</span>
02567 <span class="comment">             * was it re-queued</span>
02568 <span class="comment">             */</span>
02569             <span class="keywordflow">if</span> ((prev_asp == NULL) &amp;&amp; (agent_delegated_list == asp)) {
02570                 prev_asp = asp;
02571             }
02572         } <span class="keywordflow">else</span> {
02573 
02574             <span class="comment">/*</span>
02575 <span class="comment">             * asp is still on the queue</span>
02576 <span class="comment">             */</span>
02577             prev_asp = asp;
02578         }
02579     }
02580 
02581     <span class="comment">/*</span>
02582 <span class="comment">     * if we are processing a set and there are more delegated</span>
02583 <span class="comment">     * requests, keep waiting before getting to queued requests.</span>
02584 <span class="comment">     */</span>
02585     <span class="keywordflow">if</span> (netsnmp_processing_set &amp;&amp; (NULL != agent_delegated_list))
02586         <span class="keywordflow">return</span>;
02587 
02588     <span class="keywordflow">while</span> (netsnmp_agent_queued_list) {
02589 
02590         <span class="comment">/*</span>
02591 <span class="comment">         * if we are processing a set, the first item better be</span>
02592 <span class="comment">         * the set being (or waiting to be) processed.</span>
02593 <span class="comment">         */</span>
02594         netsnmp_assert((!netsnmp_processing_set) ||
02595                        (netsnmp_processing_set == netsnmp_agent_queued_list));
02596 
02597         <span class="comment">/*</span>
02598 <span class="comment">         * if the top request is a set, don't pop it</span>
02599 <span class="comment">         * off if there are delegated requests</span>
02600 <span class="comment">         */</span>
02601         <span class="keywordflow">if</span> ((netsnmp_agent_queued_list-&gt;pdu-&gt;command == SNMP_MSG_SET) &amp;&amp;
02602             (agent_delegated_list)) {
02603 
02604             netsnmp_assert(netsnmp_processing_set == NULL);
02605 
02606             netsnmp_processing_set = netsnmp_agent_queued_list;
02607             DEBUGMSGTL((<span class="stringliteral">"snmp_agent"</span>, <span class=
"stringliteral">"SET request remains queued while "</span>
02608                         <span class="stringliteral">"delegated requests finish, asp = %08p\n"</span>, asp));
02609             <span class="keywordflow">break</span>;
02610         }
02611 
02612         <span class="comment">/*</span>
02613 <span class="comment">         * pop the first request and process it</span>
02614 <span class="comment">         */</span>
02615         asp = netsnmp_agent_queued_list;
02616         netsnmp_agent_queued_list = asp-&gt;next;
02617         DEBUGMSGTL((<span class="stringliteral">"snmp_agent"</span>,
02618                     <span class="stringliteral">"processing queued request, asp = %08p\n"</span>, asp));
02619 
02620         netsnmp_handle_request(asp, asp-&gt;status);
02621 
02622         <span class="comment">/*</span>
02623 <span class="comment">         * if we hit a set, stop</span>
02624 <span class="comment">         */</span>
02625         <span class="keywordflow">if</span> (NULL != netsnmp_processing_set)
02626             <span class="keywordflow">break</span>;
02627     }
02628 }
02629 
02635 <span class="keywordtype">int</span>
<a name="l02636" id="l02636"></a><a class="code" href="group__snmp__agent.html#ga68">02636</a> <a class="code" href=
"group__snmp__agent.html#ga68">netsnmp_check_transaction_id</a>(<span class="keywordtype">int</span> transaction_id)
02637 {
02638     netsnmp_agent_session *asp, *prev_asp = NULL;
02639 
02640     <span class="keywordflow">for</span> (asp = agent_delegated_list; asp; prev_asp = asp, asp = asp-&gt;next) {
02641         <span class="keywordflow">if</span> (asp-&gt;pdu-&gt;transid == transaction_id)
02642             <span class="keywordflow">return</span> SNMPERR_SUCCESS;
02643     }
02644     <span class="keywordflow">return</span> SNMPERR_GENERR;
02645 }
02646 
02647 
02648 <span class="comment">/*</span>
02649 <span class="comment"> * check_delayed_request(asp)</span>
02650 <span class="comment"> *</span>
02651 <span class="comment"> * Called to rexamine a set of requests and continue processing them</span>
02652 <span class="comment"> * once all the previous (delayed) requests have been handled one way</span>
02653 <span class="comment"> * or another.</span>
02654 <span class="comment"> */</span>
02655 
02656 <span class="keywordtype">int</span>
02657 check_delayed_request(netsnmp_agent_session *asp)
02658 {
02659     <span class="keywordtype">int</span>             status = SNMP_ERR_NOERROR;
02660 
02661     DEBUGMSGTL((<span class="stringliteral">"snmp_agent"</span>, <span class=
"stringliteral">"processing delegated request, asp = %08p\n"</span>,
02662                 asp));
02663 
02664     <span class="keywordflow">switch</span> (asp-&gt;mode) {
02665     <span class="keywordflow">case</span> SNMP_MSG_GETBULK:
02666     <span class="keywordflow">case</span> SNMP_MSG_GETNEXT:
02667         netsnmp_check_all_requests_status(asp, 0);
02668         <a class="code" href="group__snmp__agent.html#ga23">handle_getnext_loop</a>(asp);
02669         <span class="keywordflow">if</span> (netsnmp_check_for_delegated(asp) &amp;&amp;
02670             <a class="code" href=
"group__snmp__agent.html#ga68">netsnmp_check_transaction_id</a>(asp-&gt;pdu-&gt;transid) !=
02671             SNMPERR_SUCCESS) {
02672             <span class="comment">/*</span>
02673 <span class="comment">             * add to delegated request chain </span>
02674 <span class="comment">             */</span>
02675             <span class="keywordflow">if</span> (!netsnmp_check_delegated_chain_for(asp)) {
02676                 asp-&gt;next = agent_delegated_list;
02677                 agent_delegated_list = asp;
02678             }
02679         }
02680         <span class="keywordflow">break</span>;
02681 
02682     <span class="keywordflow">case</span> MODE_SET_COMMIT:
02683         netsnmp_check_all_requests_status(asp, SNMP_ERR_COMMITFAILED);
02684         <span class="keywordflow">goto</span> settop;
02685 
02686     <span class="keywordflow">case</span> MODE_SET_UNDO:
02687         netsnmp_check_all_requests_status(asp, SNMP_ERR_UNDOFAILED);
02688         <span class="keywordflow">goto</span> settop;
02689 
02690     <span class="keywordflow">case</span> MODE_SET_BEGIN:
02691     <span class="keywordflow">case</span> MODE_SET_RESERVE1:
02692     <span class="keywordflow">case</span> MODE_SET_RESERVE2:
02693     <span class="keywordflow">case</span> MODE_SET_ACTION:
02694     <span class="keywordflow">case</span> MODE_SET_FREE:
02695       settop:
02696         handle_set_loop(asp);
02697         <span class=
"keywordflow">if</span> (asp-&gt;mode != FINISHED_SUCCESS &amp;&amp; asp-&gt;mode != FINISHED_FAILURE) {
02698 
02699             <span class="keywordflow">if</span> (netsnmp_check_for_delegated_and_add(asp)) {
02700                 <span class="comment">/*</span>
02701 <span class="comment">                 * add to delegated request chain </span>
02702 <span class="comment">                 */</span>
02703                 <span class="keywordflow">if</span> (!asp-&gt;status)
02704                     asp-&gt;status = status;
02705             }
02706 
02707             <span class="keywordflow">return</span> SNMP_ERR_NOERROR;
02708         }
02709         <span class="keywordflow">break</span>;
02710 
02711     <span class="keywordflow">default</span>:
02712         <span class="keywordflow">break</span>;
02713     }
02714 
02715     <span class="comment">/*</span>
02716 <span class="comment">     * if we don't have anything outstanding (delegated), wrap up </span>
02717 <span class="comment">     */</span>
02718     <span class="keywordflow">if</span> (!netsnmp_check_for_delegated(asp))
02719         <span class="keywordflow">return</span> <a class="code" href=
"group__snmp__agent.html#ga21">netsnmp_wrap_up_request</a>(asp, status);
02720 
02721     <span class="keywordflow">return</span> 1;
02722 }
02723 
02725 <span class="keywordtype">int</span>
<a name="l02726" id="l02726"></a><a class="code" href="group__snmp__agent.html#ga69">02726</a> <a class="code" href=
"group__snmp__agent.html#ga69">check_getnext_results</a>(netsnmp_agent_session *asp)
02727 {
02728     <span class="comment">/*</span>
02729 <span class="comment">     * get old info </span>
02730 <span class="comment">     */</span>
02731     netsnmp_tree_cache *old_treecache = asp-&gt;treecache;
02732     <span class="keywordtype">int</span>             old_treecache_num = asp-&gt;treecache_num;
02733     <span class="keywordtype">int</span>             count = 0;
02734     <span class="keywordtype">int</span>             i, special = 0;
02735     <a class="code" href="structnetsnmp__request__info__s.html">netsnmp_request_info</a> *request;
02736 
02737     <span class="keywordflow">if</span> (asp-&gt;mode == SNMP_MSG_GET) {
02738         <span class="comment">/*</span>
02739 <span class="comment">         * Special case for doing INCLUSIVE getNext operations in</span>
02740 <span class="comment">         * AgentX subagents.  </span>
02741 <span class="comment">         */</span>
02742         DEBUGMSGTL((<span class="stringliteral">"snmp_agent"</span>,
02743                     <span class="stringliteral">"asp-&gt;mode == SNMP_MSG_GET in ch_getnext\n"</span>));
02744         asp-&gt;mode = asp-&gt;oldmode;
02745         special = 1;
02746     }
02747 
02748     <span class="keywordflow">for</span> (i = 0; i &lt;= old_treecache_num; i++) {
02749         <span class="keywordflow">for</span> (request = old_treecache[i].requests_begin; request;
02750              request = request-&gt;<a class="code" href="structnetsnmp__request__info__s.html#o13">next</a>) {
02751 
02752             <span class="comment">/*</span>
02753 <span class="comment">             * If we have just done the special case AgentX GET, then any</span>
02754 <span class="comment">             * requests which were not INCLUSIVE will now have a wrong</span>
02755 <span class="comment">             * response, so junk them and retry from the same place (except</span>
02756 <span class="comment">             * that this time the handler will be called in "inexact"</span>
02757 <span class="comment">             * mode).  </span>
02758 <span class="comment">             */</span>
02759 
02760             <span class="keywordflow">if</span> (special) {
02761                 <span class="keywordflow">if</span> (!request-&gt;<a class="code" href=
"structnetsnmp__request__info__s.html#o7">inclusive</a>) {
02762                     DEBUGMSGTL((<span class="stringliteral">"snmp_agent"</span>,
02763                                 <span class="stringliteral">"request %d wasn't inclusive\n"</span>,
02764                                 request-&gt;<a class="code" href="structnetsnmp__request__info__s.html#o9">index</a>));
02765                     <a class="code" href="group__snmp__client.html#ga19">snmp_set_var_typed_value</a>(request-&gt;<a class=
"code" href="structnetsnmp__request__info__s.html#o0">requestvb</a>,
02766                                              ASN_PRIV_RETRY, NULL, 0);
02767                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (request-&gt;<a class="code"
href="structnetsnmp__request__info__s.html#o0">requestvb</a>-&gt;<a class="code" href=
"structvariable__list.html#o3">type</a> == ASN_NULL ||
02768                            request-&gt;<a class="code" href=
"structnetsnmp__request__info__s.html#o0">requestvb</a>-&gt;<a class="code" href=
"structvariable__list.html#o3">type</a> == SNMP_NOSUCHINSTANCE ||
02769                            request-&gt;<a class="code" href=
"structnetsnmp__request__info__s.html#o0">requestvb</a>-&gt;<a class="code" href=
"structvariable__list.html#o3">type</a> == SNMP_NOSUCHOBJECT) {
02770                     <span class="comment">/*</span>
02771 <span class="comment">                     * it was inclusive, but no results.  Still retry this</span>
02772 <span class="comment">                     * search. </span>
02773 <span class="comment">                     */</span>
02774                     <a class="code" href="group__snmp__client.html#ga19">snmp_set_var_typed_value</a>(request-&gt;<a class=
"code" href="structnetsnmp__request__info__s.html#o0">requestvb</a>,
02775                                              ASN_PRIV_RETRY, NULL, 0);
02776                 }
02777             }
02778 
02779             <span class="comment">/*</span>
02780 <span class="comment">             * out of range? </span>
02781 <span class="comment">             */</span>
02782             <span class="keywordflow">if</span> (<a class="code" href=
"group__library.html#ga103">snmp_oid_compare</a>(request-&gt;<a class="code" href=
"structnetsnmp__request__info__s.html#o0">requestvb</a>-&gt;<a class="code" href="structvariable__list.html#o1">name</a>,
02783                                  request-&gt;<a class="code" href=
"structnetsnmp__request__info__s.html#o0">requestvb</a>-&gt;<a class="code" href="structvariable__list.html#o2">name_length</a>,
02784                                  request-&gt;<a class="code" href="structnetsnmp__request__info__s.html#o3">range_end</a>,
02785                                  request-&gt;<a class="code" href=
"structnetsnmp__request__info__s.html#o4">range_end_len</a>) &gt;= 0) {
02786                 <span class="comment">/*</span>
02787 <span class="comment">                 * ack, it's beyond the accepted end of range. </span>
02788 <span class="comment">                 */</span>
02789                 <span class="comment">/*</span>
02790 <span class="comment">                 * fix it by setting the oid to the end of range oid instead </span>
02791 <span class="comment">                 */</span>
02792                 DEBUGMSGTL((<span class="stringliteral">"check_getnext_results"</span>,
02793                             <span class="stringliteral">"request response %d out of range\n"</span>,
02794                             request-&gt;<a class="code" href="structnetsnmp__request__info__s.html#o9">index</a>));
02795                 request-&gt;<a class="code" href="structnetsnmp__request__info__s.html#o7">inclusive</a> = 1;
02796                 <span class="comment">/*</span>
02797 <span class="comment">                 * XXX: should set this to the original OID? </span>
02798 <span class="comment">                 */</span>
02799                 snmp_set_var_objid(request-&gt;<a class="code" href=
"structnetsnmp__request__info__s.html#o0">requestvb</a>,
02800                                    request-&gt;<a class="code" href=
"structnetsnmp__request__info__s.html#o3">range_end</a>,
02801                                    request-&gt;<a class="code" href=
"structnetsnmp__request__info__s.html#o4">range_end_len</a>);
02802                 <a class="code" href="group__snmp__client.html#ga19">snmp_set_var_typed_value</a>(request-&gt;<a class=
"code" href="structnetsnmp__request__info__s.html#o0">requestvb</a>, ASN_NULL,
02803                                          NULL, 0);
02804             }
02805 
02806             <span class="comment">/*</span>
02807 <span class="comment">             * mark any existent requests with illegal results as NULL </span>
02808 <span class="comment">             */</span>
02809             <span class="keywordflow">if</span> (request-&gt;<a class="code" href=
"structnetsnmp__request__info__s.html#o0">requestvb</a>-&gt;<a class="code" href=
"structvariable__list.html#o3">type</a> == SNMP_ENDOFMIBVIEW) {
02810                 <span class="comment">/*</span>
02811 <span class="comment">                 * illegal response from a subagent.  Change it back to NULL </span>
02812 <span class="comment">                 */</span>
02813                 request-&gt;<a class="code" href="structnetsnmp__request__info__s.html#o0">requestvb</a>-&gt;<a class=
"code" href="structvariable__list.html#o3">type</a> = ASN_NULL;
02814                 request-&gt;<a class="code" href="structnetsnmp__request__info__s.html#o7">inclusive</a> = 1;
02815             }
02816 
02817             <span class="keywordflow">if</span> (request-&gt;<a class="code" href=
"structnetsnmp__request__info__s.html#o0">requestvb</a>-&gt;<a class="code" href=
"structvariable__list.html#o3">type</a> == ASN_NULL ||
02818                 request-&gt;<a class="code" href="structnetsnmp__request__info__s.html#o0">requestvb</a>-&gt;<a class=
"code" href="structvariable__list.html#o3">type</a> == ASN_PRIV_RETRY ||
02819                 (asp-&gt;reqinfo-&gt;mode == MODE_GETBULK
02820                  &amp;&amp; request-&gt;<a class="code" href="structnetsnmp__request__info__s.html#o10">repeat</a> &gt; 0))
02821                 count++;
02822         }
02823     }
02824     <span class="keywordflow">return</span> count;
02825 }
02826 
02830 <span class="keywordtype">int</span>
<a name="l02831" id="l02831"></a><a class="code" href="group__snmp__agent.html#ga23">02831</a> <a class="code" href=
"group__snmp__agent.html#ga23">handle_getnext_loop</a>(netsnmp_agent_session *asp)
02832 {
02833     <span class="keywordtype">int</span>             status;
02834     <a class="code" href="structvariable__list.html">netsnmp_variable_list</a> *var_ptr;
02835 
02836     <span class="comment">/*</span>
02837 <span class="comment">     * loop </span>
02838 <span class="comment">     */</span>
02839     <span class="keywordflow">while</span> (netsnmp_running) {
02840 
02841         <span class="comment">/*</span>
02842 <span class="comment">         * bail for now if anything is delegated. </span>
02843 <span class="comment">         */</span>
02844         <span class="keywordflow">if</span> (netsnmp_check_for_delegated(asp)) {
02845             <span class="keywordflow">return</span> SNMP_ERR_NOERROR;
02846         }
02847 
02848         <span class="comment">/*</span>
02849 <span class="comment">         * check vacm against results </span>
02850 <span class="comment">         */</span>
02851         check_acm(asp, ASN_PRIV_RETRY);
02852 
02853         <span class="comment">/*</span>
02854 <span class="comment">         * need to keep going we're not done yet. </span>
02855 <span class="comment">         */</span>
02856         <span class="keywordflow">if</span> (!<a class="code" href=
"group__snmp__agent.html#ga69">check_getnext_results</a>(asp))
02857             <span class="comment">/*</span>
02858 <span class="comment">             * nothing left, quit now </span>
02859 <span class="comment">             */</span>
02860             <span class="keywordflow">break</span>;
02861 
02862         <span class="comment">/*</span>
02863 <span class="comment">         * never had a request (empty pdu), quit now </span>
02864 <span class="comment">         */</span>
02865         <span class="comment">/*</span>
02866 <span class="comment">         * XXXWWW: huh?  this would be too late, no?  shouldn't we</span>
02867 <span class="comment">         * catch this earlier? </span>
02868 <span class="comment">         */</span>
02869         <span class="comment">/*</span>
02870 <span class="comment">         * if (count == 0)</span>
02871 <span class="comment">         * break; </span>
02872 <span class="comment">         */</span>
02873 
02874         DEBUGIF(<span class="stringliteral">"results"</span>) {
02875             DEBUGMSGTL((<span class="stringliteral">"results"</span>,
02876                         <span class="stringliteral">"getnext results, before next pass:\n"</span>));
02877             <span class="keywordflow">for</span> (var_ptr = asp-&gt;pdu-&gt;variables; var_ptr;
02878                  var_ptr = var_ptr-&gt;<a class="code" href="structvariable__list.html#o0">next_variable</a>) {
02879                 DEBUGMSGTL((<span class="stringliteral">"results"</span>, <span class="stringliteral">"\t"</span>));
02880                 DEBUGMSGVAR((<span class="stringliteral">"results"</span>, var_ptr));
02881                 DEBUGMSG((<span class="stringliteral">"results"</span>, <span class="stringliteral">"\n"</span>));
02882             }
02883         }
02884 
02885         netsnmp_reassign_requests(asp);
02886         status = handle_var_requests(asp);
02887         <span class="keywordflow">if</span> (status != SNMP_ERR_NOERROR) {
02888             <span class="keywordflow">return</span> status;      <span class=
"comment">/* should never really happen */</span>
02889         }
02890     }
02891     <span class="keywordflow">return</span> SNMP_ERR_NOERROR;
02892 }
02893 
02894 <span class="keywordtype">int</span>
02895 handle_set(netsnmp_agent_session *asp)
02896 {
02897     <span class="keywordtype">int</span>             status;
02898     <span class="comment">/*</span>
02899 <span class="comment">     * SETS require 3-4 passes through the var_op_list.</span>
02900 <span class="comment">     * The first two</span>
02901 <span class="comment">     * passes verify that all types, lengths, and values are valid</span>
02902 <span class="comment">     * and may reserve resources and the third does the set and a</span>
02903 <span class="comment">     * fourth executes any actions.  Then the identical GET RESPONSE</span>
02904 <span class="comment">     * packet is returned.</span>
02905 <span class="comment">     * If either of the first two passes returns an error, another</span>
02906 <span class="comment">     * pass is made so that any reserved resources can be freed.</span>
02907 <span class="comment">     * If the third pass returns an error, another pass is</span>
02908 <span class="comment">     * made so that</span>
02909 <span class="comment">     * any changes can be reversed.</span>
02910 <span class="comment">     * If the fourth pass (or any of the error handling passes)</span>
02911 <span class="comment">     * return an error, we'd rather not know about it!</span>
02912 <span class="comment">     */</span>
02913     <span class="keywordflow">if</span> (!(asp-&gt;pdu-&gt;flags &amp; UCD_MSG_FLAG_ONE_PASS_ONLY)) {
02914         <span class="keywordflow">switch</span> (asp-&gt;mode) {
02915         <span class="keywordflow">case</span> MODE_SET_BEGIN:
02916             snmp_increment_statistic(STAT_SNMPINSETREQUESTS);
02917             asp-&gt;rw = WRITE;    <span class="comment">/* WWW: still needed? */</span>
02918             asp-&gt;mode = MODE_SET_RESERVE1;
02919             asp-&gt;<a class="code" href="structnetsnmp__request__info__s.html#o8">status</a> = SNMP_ERR_NOERROR;
02920             <span class="keywordflow">break</span>;
02921 
02922         <span class="keywordflow">case</span> MODE_SET_RESERVE1:
02923 
02924             <span class="keywordflow">if</span> (asp-&gt;status != SNMP_ERR_NOERROR)
02925                 asp-&gt;mode = MODE_SET_FREE;
02926             <span class="keywordflow">else</span>
02927                 asp-&gt;mode = MODE_SET_RESERVE2;
02928             <span class="keywordflow">break</span>;
02929 
02930         <span class="keywordflow">case</span> MODE_SET_RESERVE2:
02931             <span class="keywordflow">if</span> (asp-&gt;status != SNMP_ERR_NOERROR)
02932                 asp-&gt;mode = MODE_SET_FREE;
02933             <span class="keywordflow">else</span>
02934                 asp-&gt;mode = MODE_SET_ACTION;
02935             <span class="keywordflow">break</span>;
02936 
02937         <span class="keywordflow">case</span> MODE_SET_ACTION:
02938             <span class="keywordflow">if</span> (asp-&gt;status != SNMP_ERR_NOERROR)
02939                 asp-&gt;mode = MODE_SET_UNDO;
02940             <span class="keywordflow">else</span>
02941                 asp-&gt;mode = MODE_SET_COMMIT;
02942             <span class="keywordflow">break</span>;
02943 
02944         <span class="keywordflow">case</span> MODE_SET_COMMIT:
02945             <span class="keywordflow">if</span> (asp-&gt;status != SNMP_ERR_NOERROR) {
02946                 asp-&gt;mode = FINISHED_FAILURE;
02947             } <span class="keywordflow">else</span> {
02948                 asp-&gt;mode = FINISHED_SUCCESS;
02949             }
02950             <span class="keywordflow">break</span>;
02951 
02952         <span class="keywordflow">case</span> MODE_SET_UNDO:
02953             asp-&gt;mode = FINISHED_FAILURE;
02954             <span class="keywordflow">break</span>;
02955 
02956         <span class="keywordflow">case</span> MODE_SET_FREE:
02957             asp-&gt;mode = FINISHED_FAILURE;
02958             <span class="keywordflow">break</span>;
02959         }
02960     }
02961 
02962     <span class="keywordflow">if</span> (asp-&gt;mode != FINISHED_SUCCESS &amp;&amp; asp-&gt;mode != FINISHED_FAILURE) {
02963         DEBUGMSGTL((<span class="stringliteral">"agent_set"</span>, <span class=
"stringliteral">"doing set mode = %d (%s)\n"</span>, asp-&gt;mode,
02964                     se_find_label_in_slist(<span class="stringliteral">"agent_mode"</span>, asp-&gt;mode)));
02965         status = handle_var_requests(asp);
02966         DEBUGMSGTL((<span class="stringliteral">"agent_set"</span>, <span class=
"stringliteral">"did set mode = %d, status = %d\n"</span>,
02967                     asp-&gt;mode, status));
02968         <span class="keywordflow">if</span> ((status != SNMP_ERR_NOERROR &amp;&amp; asp-&gt;status == SNMP_ERR_NOERROR) ||
02969             status == SNMP_ERR_COMMITFAILED || 
02970             status == SNMP_ERR_UNDOFAILED) {
02971             asp-&gt;<a class="code" href="structnetsnmp__request__info__s.html#o8">status</a> = status;
02972         }
02973     }
02974     <span class="keywordflow">return</span> asp-&gt;<a class="code" href=
"structnetsnmp__request__info__s.html#o8">status</a>;
02975 }
02976 
02977 <span class="keywordtype">int</span>
02978 handle_set_loop(netsnmp_agent_session *asp)
02979 {
02980     <span class="keywordflow">while</span> (asp-&gt;mode != FINISHED_FAILURE &amp;&amp; asp-&gt;mode != FINISHED_SUCCESS) {
02981         handle_set(asp);
02982         <span class="keywordflow">if</span> (netsnmp_check_for_delegated(asp)) {
02983             <span class="keywordflow">return</span> SNMP_ERR_NOERROR;
02984         }
02985         <span class="keywordflow">if</span> (asp-&gt;pdu-&gt;flags &amp; UCD_MSG_FLAG_ONE_PASS_ONLY) {
02986             <span class="keywordflow">return</span> asp-&gt;<a class="code" href=
"structnetsnmp__request__info__s.html#o8">status</a>;
02987         }
02988     }
02989     <span class="keywordflow">return</span> asp-&gt;<a class="code" href=
"structnetsnmp__request__info__s.html#o8">status</a>;
02990 }
02991 
02992 <span class="keywordtype">int</span>
02993 netsnmp_handle_request(netsnmp_agent_session *asp, <span class="keywordtype">int</span> status)
02994 {
02995     <span class="comment">/*</span>
02996 <span class="comment">     * if this isn't a delegated request trying to finish,</span>
02997 <span class="comment">     * processing of a set request should not start until all</span>
02998 <span class="comment">     * delegated requests have completed, and no other new requests</span>
02999 <span class="comment">     * should be processed until the set request completes.</span>
03000 <span class="comment">     */</span>
03001     <span class="keywordflow">if</span> ((0 == netsnmp_check_delegated_chain_for(asp)) &amp;&amp;
03002         (asp != netsnmp_processing_set)) {
03003         <span class="comment">/*</span>
03004 <span class="comment">         * if we are processing a set and this is not a delegated</span>
03005 <span class="comment">         * request, queue the request</span>
03006 <span class="comment">         */</span>
03007         <span class="keywordflow">if</span> (netsnmp_processing_set) {
03008             netsnmp_add_queued(asp);
03009             DEBUGMSGTL((<span class="stringliteral">"snmp_agent"</span>,
03010                         <span class="stringliteral">"request queued while processing set, "</span>
03011                         <span class="stringliteral">"asp = %08p\n"</span>, asp));
03012             <span class="keywordflow">return</span> 1;
03013         }
03014 
03015         <span class="comment">/*</span>
03016 <span class="comment">         * check for set request</span>
03017 <span class="comment">         */</span>
03018         <span class="keywordflow">if</span> (asp-&gt;pdu-&gt;command == SNMP_MSG_SET) {
03019             netsnmp_processing_set = asp;
03020 
03021             <span class="comment">/*</span>
03022 <span class="comment">             * if there are delegated requests, we must wait for them</span>
03023 <span class="comment">             * to finish.</span>
03024 <span class="comment">             */</span>
03025             <span class="keywordflow">if</span> (agent_delegated_list) {
03026                 DEBUGMSGTL((<span class="stringliteral">"snmp_agent"</span>, <span class=
"stringliteral">"SET request queued while "</span>
03027                             <span class="stringliteral">"delegated requests finish, asp = %08p\n"</span>,
03028                             asp));
03029                 netsnmp_add_queued(asp);
03030                 <span class="keywordflow">return</span> 1;
03031             }
03032         }
03033     }
03034 
03035     <span class="comment">/*</span>
03036 <span class="comment">     * process the request </span>
03037 <span class="comment">     */</span>
03038     status = <a class="code" href="group__snmp__agent.html#ga19">handle_pdu</a>(asp);
03039 
03040     <span class="comment">/*</span>
03041 <span class="comment">     * print the results in appropriate debugging mode </span>
03042 <span class="comment">     */</span>
03043     DEBUGIF(<span class="stringliteral">"results"</span>) {
03044         <a class="code" href="structvariable__list.html">netsnmp_variable_list</a> *var_ptr;
03045         DEBUGMSGTL((<span class="stringliteral">"results"</span>, <span class=
"stringliteral">"request results (status = %d):\n"</span>,
03046                     status));
03047         <span class="keywordflow">for</span> (var_ptr = asp-&gt;pdu-&gt;variables; var_ptr;
03048              var_ptr = var_ptr-&gt;<a class="code" href="structvariable__list.html#o0">next_variable</a>) {
03049             DEBUGMSGTL((<span class="stringliteral">"results"</span>, <span class="stringliteral">"\t"</span>));
03050             DEBUGMSGVAR((<span class="stringliteral">"results"</span>, var_ptr));
03051             DEBUGMSG((<span class="stringliteral">"results"</span>, <span class="stringliteral">"\n"</span>));
03052         }
03053     }
03054 
03055     <span class="comment">/*</span>
03056 <span class="comment">     * check for uncompleted requests </span>
03057 <span class="comment">     */</span>
03058     <span class="keywordflow">if</span> (netsnmp_check_for_delegated_and_add(asp)) {
03059         <span class="comment">/*</span>
03060 <span class="comment">         * add to delegated request chain </span>
03061 <span class="comment">         */</span>
03062         asp-&gt;<a class="code" href="structnetsnmp__request__info__s.html#o8">status</a> = status;
03063     } <span class="keywordflow">else</span> {
03064         <span class="comment">/*</span>
03065 <span class="comment">         * if we don't have anything outstanding (delegated), wrap up</span>
03066 <span class="comment">         */</span>
03067         <span class="keywordflow">return</span> <a class="code" href=
"group__snmp__agent.html#ga21">netsnmp_wrap_up_request</a>(asp, status);
03068     }
03069 
03070     <span class="keywordflow">return</span> 1;
03071 }
03072 
03124 <span class="keywordtype">int</span>
<a name="l03125" id="l03125"></a><a class="code" href="group__snmp__agent.html#ga19">03125</a> <a class="code" href=
"group__snmp__agent.html#ga19">handle_pdu</a>(netsnmp_agent_session *asp)
03126 {
03127     <span class="keywordtype">int</span>             status, inclusives = 0;
03128     <a class="code" href="structvariable__list.html">netsnmp_variable_list</a> *v = NULL;
03129 
03130     <span class="comment">/*</span>
03131 <span class="comment">     * for illegal requests, mark all nodes as ASN_NULL </span>
03132 <span class="comment">     */</span>
03133     <span class="keywordflow">switch</span> (asp-&gt;pdu-&gt;command) {
03134 
03135     <span class="keywordflow">case</span> SNMP_MSG_INTERNAL_SET_RESERVE2:
03136     <span class="keywordflow">case</span> SNMP_MSG_INTERNAL_SET_ACTION:
03137     <span class="keywordflow">case</span> SNMP_MSG_INTERNAL_SET_COMMIT:
03138     <span class="keywordflow">case</span> SNMP_MSG_INTERNAL_SET_FREE:
03139     <span class="keywordflow">case</span> SNMP_MSG_INTERNAL_SET_UNDO:
03140         status = get_set_cache(asp);
03141         <span class="keywordflow">if</span> (status != SNMP_ERR_NOERROR)
03142             <span class="keywordflow">return</span> status;
03143         <span class="keywordflow">break</span>;
03144 
03145     <span class="keywordflow">case</span> SNMP_MSG_GET:
03146     <span class="keywordflow">case</span> SNMP_MSG_GETNEXT:
03147     <span class="keywordflow">case</span> SNMP_MSG_GETBULK:
03148         <span class="keywordflow">for</span> (v = asp-&gt;pdu-&gt;variables; v != NULL; v = v-&gt;<a class="code" href=
"structvariable__list.html#o0">next_variable</a>) {
03149             <span class="keywordflow">if</span> (v-&gt;<a class="code" href=
"structvariable__list.html#o3">type</a> == ASN_PRIV_INCL_RANGE) {
03150                 <span class="comment">/*</span>
03151 <span class="comment">                 * Leave the type for now (it gets set to</span>
03152 <span class="comment">                 * ASN_NULL in netsnmp_add_varbind_to_cache,</span>
03153 <span class="comment">                 * called by create_subnetsnmp_tree_cache below).</span>
03154 <span class="comment">                 * If we set it to ASN_NULL now, we wouldn't be</span>
03155 <span class="comment">                 * able to distinguish INCLUSIVE search</span>
03156 <span class="comment">                 * ranges.  </span>
03157 <span class="comment">                 */</span>
03158                 inclusives++;
03159             } <span class="keywordflow">else</span> {
03160                 <a class="code" href="group__snmp__client.html#ga19">snmp_set_var_typed_value</a>(v, ASN_NULL, NULL, 0);
03161             }
03162         }
03163         <span class="comment">/*</span>
03164 <span class="comment">         * fall through </span>
03165 <span class="comment">         */</span>
03166 
03167     <span class="keywordflow">case</span> SNMP_MSG_INTERNAL_SET_BEGIN:
03168     <span class="keywordflow">case</span> SNMP_MSG_INTERNAL_SET_RESERVE1:
03169     <span class="keywordflow">default</span>:
03170         asp-&gt;vbcount = count_varbinds(asp-&gt;pdu-&gt;variables);
03171         <span class="keywordflow">if</span> (asp-&gt;vbcount) <span class=
"comment">/* efence doesn't like 0 size allocs */</span>
03172             asp-&gt;requests = (<a class="code" href="structnetsnmp__request__info__s.html">netsnmp_request_info</a> *)
03173                 calloc(asp-&gt;vbcount, <span class="keyword">sizeof</span>(<a class="code" href=
"structnetsnmp__request__info__s.html">netsnmp_request_info</a>));
03174         <span class="comment">/*</span>
03175 <span class="comment">         * collect varbinds </span>
03176 <span class="comment">         */</span>
03177         status = netsnmp_create_subtree_cache(asp);
03178         <span class="keywordflow">if</span> (status != SNMP_ERR_NOERROR)
03179             <span class="keywordflow">return</span> status;
03180     }
03181 
03182     asp-&gt;mode = asp-&gt;pdu-&gt;command;
03183     <span class="keywordflow">switch</span> (asp-&gt;mode) {
03184     <span class="keywordflow">case</span> SNMP_MSG_GET:
03185         <span class="comment">/*</span>
03186 <span class="comment">         * increment the message type counter </span>
03187 <span class="comment">         */</span>
03188         snmp_increment_statistic(STAT_SNMPINGETREQUESTS);
03189 
03190         <span class="comment">/*</span>
03191 <span class="comment">         * check vacm ahead of time </span>
03192 <span class="comment">         */</span>
03193         check_acm(asp, SNMP_NOSUCHOBJECT);
03194 
03195         <span class="comment">/*</span>
03196 <span class="comment">         * get the results </span>
03197 <span class="comment">         */</span>
03198         status = handle_var_requests(asp);
03199 
03200         <span class="comment">/*</span>
03201 <span class="comment">         * Deal with unhandled results -&gt; noSuchInstance (rather</span>
03202 <span class="comment">         * than noSuchObject -- in that case, the type will</span>
03203 <span class="comment">         * already have been set to noSuchObject when we realised</span>
03204 <span class="comment">         * we couldn't find an appropriate tree).  </span>
03205 <span class="comment">         */</span>
03206         <span class="keywordflow">if</span> (status == SNMP_ERR_NOERROR)
03207             snmp_replace_var_types(asp-&gt;pdu-&gt;variables, ASN_NULL,
03208                                    SNMP_NOSUCHINSTANCE);
03209         <span class="keywordflow">break</span>;
03210 
03211     <span class="keywordflow">case</span> SNMP_MSG_GETNEXT:
03212         snmp_increment_statistic(STAT_SNMPINGETNEXTS);
03213         <span class="comment">/*</span>
03214 <span class="comment">         * fall through </span>
03215 <span class="comment">         */</span>
03216 
03217     <span class="keywordflow">case</span> SNMP_MSG_GETBULK:     <span class=
"comment">/* note: there is no getbulk stat */</span>
03218         <span class="comment">/*</span>
03219 <span class="comment">         * loop through our mib tree till we find an</span>
03220 <span class="comment">         * appropriate response to return to the caller. </span>
03221 <span class="comment">         */</span>
03222 
03223         <span class="keywordflow">if</span> (inclusives) {
03224             <span class="comment">/*</span>
03225 <span class="comment">             * This is a special case for AgentX INCLUSIVE getNext</span>
03226 <span class="comment">             * requests where a result lexi-equal to the request is okay</span>
03227 <span class="comment">             * but if such a result does not exist, we still want the</span>
03228 <span class="comment">             * lexi-next one.  So basically we do a GET first, and if any</span>
03229 <span class="comment">             * of the INCLUSIVE requests are satisfied, we use that</span>
03230 <span class="comment">             * value.  Then, unsatisfied INCLUSIVE requests, and</span>
03231 <span class="comment">             * non-INCLUSIVE requests get done as normal.  </span>
03232 <span class="comment">             */</span>
03233 
03234             DEBUGMSGTL((<span class="stringliteral">"snmp_agent"</span>, <span class=
"stringliteral">"inclusive range(s) in getNext\n"</span>));
03235             asp-&gt;oldmode = asp-&gt;mode;
03236             asp-&gt;mode = SNMP_MSG_GET;
03237         }
03238 
03239         <span class="comment">/*</span>
03240 <span class="comment">         * first pass </span>
03241 <span class="comment">         */</span>
03242         status = handle_var_requests(asp);
03243         <span class="keywordflow">if</span> (status != SNMP_ERR_NOERROR) {
03244             <span class="keywordflow">if</span> (!inclusives)
03245                 <span class="keywordflow">return</span> status;  <span class=
"comment">/* should never really happen */</span>
03246             <span class="keywordflow">else</span>
03247                 asp-&gt;<a class="code" href="structnetsnmp__request__info__s.html#o8">status</a> = SNMP_ERR_NOERROR;
03248         }
03249 
03250         <span class="comment">/*</span>
03251 <span class="comment">         * loop through our mib tree till we find an</span>
03252 <span class="comment">         * appropriate response to return to the caller. </span>
03253 <span class="comment">         */</span>
03254 
03255         status = <a class="code" href="group__snmp__agent.html#ga23">handle_getnext_loop</a>(asp);
03256         <span class="keywordflow">break</span>;
03257 
03258     <span class="keywordflow">case</span> SNMP_MSG_SET:
03259 <span class="preprocessor">#ifdef DISABLE_SET_SUPPORT</span>
03260         <span class="keywordflow">return</span> SNMP_ERR_NOTWRITABLE;
03261 <span class="preprocessor">#else</span>
03262         <span class="comment">/*</span>
03263 <span class="comment">         * check access permissions first </span>
03264 <span class="comment">         */</span>
03265         <span class="keywordflow">if</span> (check_acm(asp, SNMP_NOSUCHOBJECT))
03266             <span class="keywordflow">return</span> SNMP_ERR_NOTWRITABLE;
03267 
03268         asp-&gt;mode = MODE_SET_BEGIN;
03269         status = handle_set_loop(asp);
03270 <span class="preprocessor">#endif</span>
03271         <span class="keywordflow">break</span>;
03272 
03273     <span class="keywordflow">case</span> SNMP_MSG_INTERNAL_SET_BEGIN:
03274     <span class="keywordflow">case</span> SNMP_MSG_INTERNAL_SET_RESERVE1:
03275     <span class="keywordflow">case</span> SNMP_MSG_INTERNAL_SET_RESERVE2:
03276     <span class="keywordflow">case</span> SNMP_MSG_INTERNAL_SET_ACTION:
03277     <span class="keywordflow">case</span> SNMP_MSG_INTERNAL_SET_COMMIT:
03278     <span class="keywordflow">case</span> SNMP_MSG_INTERNAL_SET_FREE:
03279     <span class="keywordflow">case</span> SNMP_MSG_INTERNAL_SET_UNDO:
03280         asp-&gt;pdu-&gt;flags |= UCD_MSG_FLAG_ONE_PASS_ONLY;
03281         status = handle_set_loop(asp);
03282         <span class="comment">/*</span>
03283 <span class="comment">         * asp related cache is saved in cleanup </span>
03284 <span class="comment">         */</span>
03285         <span class="keywordflow">break</span>;
03286 
03287     <span class="keywordflow">case</span> SNMP_MSG_RESPONSE:
03288         snmp_increment_statistic(STAT_SNMPINGETRESPONSES);
03289         <span class="keywordflow">return</span> SNMP_ERR_NOERROR;
03290 
03291     <span class="keywordflow">case</span> SNMP_MSG_TRAP:
03292     <span class="keywordflow">case</span> SNMP_MSG_TRAP2:
03293         snmp_increment_statistic(STAT_SNMPINTRAPS);
03294         <span class="keywordflow">return</span> SNMP_ERR_NOERROR;
03295 
03296     <span class="keywordflow">default</span>:
03297         <span class="comment">/*</span>
03298 <span class="comment">         * WWW: are reports counted somewhere ? </span>
03299 <span class="comment">         */</span>
03300         snmp_increment_statistic(STAT_SNMPINASNPARSEERRS);
03301         <span class="keywordflow">return</span> SNMPERR_GENERR;  <span class="comment">/* shouldn't get here */</span>
03302         <span class="comment">/*</span>
03303 <span class="comment">         * WWW </span>
03304 <span class="comment">         */</span>
03305     }
03306     <span class="keywordflow">return</span> status;
03307 }
03308 
03312 NETSNMP_STATIC_INLINE <span class="keywordtype">int</span>
<a name="l03313" id="l03313"></a><a class="code" href="group__snmp__agent.html#ga71">03313</a> <a class="code" href=
"group__snmp__agent.html#ga71">_request_set_error</a>(<a class="code" href=
"structnetsnmp__request__info__s.html">netsnmp_request_info</a> *request, <span class="keywordtype">int</span> mode, <span class=
"keywordtype">int</span> error_value)
03314 {
03315     <span class="keywordflow">if</span> (!request)
03316         <span class="keywordflow">return</span> SNMPERR_NO_VARS;
03317 
03318     request-&gt;<a class="code" href="structnetsnmp__request__info__s.html#o6">processed</a> = 1;
03319     request-&gt;<a class="code" href="structnetsnmp__request__info__s.html#o5">delegated</a> = REQUEST_IS_NOT_DELEGATED;
03320 
03321     <span class="keywordflow">switch</span> (error_value) {
03322     <span class="keywordflow">case</span> SNMP_NOSUCHOBJECT:
03323     <span class="keywordflow">case</span> SNMP_NOSUCHINSTANCE:
03324     <span class="keywordflow">case</span> SNMP_ENDOFMIBVIEW:
03325         <span class="comment">/*</span>
03326 <span class="comment">         * these are exceptions that should be put in the varbind</span>
03327 <span class="comment">         * in the case of a GET but should be translated for a SET</span>
03328 <span class="comment">         * into a real error status code and put in the request </span>
03329 <span class="comment">         */</span>
03330         <span class="keywordflow">switch</span> (mode) {
03331         <span class="keywordflow">case</span> MODE_GET:
03332         <span class="keywordflow">case</span> MODE_GETNEXT:
03333         <span class="keywordflow">case</span> MODE_GETBULK:
03334             request-&gt;<a class="code" href="structnetsnmp__request__info__s.html#o0">requestvb</a>-&gt;<a class="code"
href="structvariable__list.html#o3">type</a> = error_value;
03335             <span class="keywordflow">return</span> SNMPERR_SUCCESS;
03336 
03337             <span class="comment">/*</span>
03338 <span class="comment">             * These are technically illegal to set by the</span>
03339 <span class="comment">             * client APIs for these modes.  But accepting</span>
03340 <span class="comment">             * them here allows the 'sparse_table' helper to</span>
03341 <span class="comment">             * provide some common table handling processing</span>
03342 <span class="comment">             *</span>
03343 <span class="comment">            snmp_log(LOG_ERR, "Illegal error_value %d for mode %d ignored\n",</span>
03344 <span class="comment">                     error_value, mode);</span>
03345 <span class="comment">            return SNMPERR_VALUE;</span>
03346 <span class="comment">             */</span>
03347 
03348         <span class="keywordflow">default</span>:
03349             request-&gt;<a class="code" href=
"structnetsnmp__request__info__s.html#o8">status</a> = SNMP_ERR_NOSUCHNAME;      <span class="comment">/* WWW: correct? */</span>
03350             <span class="keywordflow">return</span> SNMPERR_SUCCESS;
03351         }
03352         <span class="keywordflow">break</span>;                  <span class="comment">/* never get here */</span>
03353 
03354     <span class="keywordflow">default</span>:
03355         <span class="keywordflow">if</span> (error_value &lt; 0) {
03356             <span class="comment">/*</span>
03357 <span class="comment">             * illegal local error code.  translate to generr </span>
03358 <span class="comment">             */</span>
03359             <span class="comment">/*</span>
03360 <span class="comment">             * WWW: full translation map? </span>
03361 <span class="comment">             */</span>
03362             <a class="code" href="group__snmp__logging.html#ga41">snmp_log</a>(LOG_ERR, <span class=
"stringliteral">"Illegal error_value %d translated to %d\n"</span>,
03363                      error_value, SNMP_ERR_GENERR);
03364             request-&gt;<a class="code" href="structnetsnmp__request__info__s.html#o8">status</a> = SNMP_ERR_GENERR;
03365         } <span class="keywordflow">else</span> {
03366             <span class="comment">/*</span>
03367 <span class="comment">             * WWW: translations and mode checking? </span>
03368 <span class="comment">             */</span>
03369             request-&gt;<a class="code" href="structnetsnmp__request__info__s.html#o8">status</a> = error_value;
03370         }
03371         <span class="keywordflow">return</span> SNMPERR_SUCCESS;
03372     }
03373     <span class="keywordflow">return</span> SNMPERR_SUCCESS;
03374 }
03375 
03380 <span class="keywordtype">int</span>
<a name="l03381" id="l03381"></a><a class="code" href="group__snmp__agent.html#ga72">03381</a> <a class="code" href=
"group__snmp__agent.html#ga72">netsnmp_request_set_error</a>(<a class="code" href=
"structnetsnmp__request__info__s.html">netsnmp_request_info</a> *request, <span class="keywordtype">int</span> error_value)
03382 {
03383     <span class="keywordflow">if</span> (!request || !request-&gt;<a class="code" href=
"structnetsnmp__request__info__s.html#o2">agent_req_info</a>)
03384         <span class="keywordflow">return</span> SNMPERR_NO_VARS;
03385 
03386     <span class="keywordflow">return</span> <a class="code" href=
"group__snmp__agent.html#ga71">_request_set_error</a>(request, request-&gt;<a class="code" href=
"structnetsnmp__request__info__s.html#o2">agent_req_info</a>-&gt;<a class="code" href=
"structnetsnmp__agent__request__info__s.html#o0">mode</a>,
03387                               error_value);
03388 }
03389 
03395 NETSNMP_INLINE <span class="keywordtype">int</span>
<a name="l03396" id="l03396"></a><a class="code" href="group__snmp__agent.html#ga73">03396</a> <a class="code" href=
"group__snmp__agent.html#ga73">netsnmp_request_set_error_all</a>( <a class="code" href=
"structnetsnmp__request__info__s.html">netsnmp_request_info</a> *requests, <span class="keywordtype">int</span> error)
03397 {
03398     <span class="keywordtype">int</span> mode, rc, result = SNMPERR_SUCCESS;
03399 
03400     <span class="keywordflow">if</span>((NULL == requests) || (NULL == requests-&gt;<a class="code" href=
"structnetsnmp__request__info__s.html#o2">agent_req_info</a>))
03401         <span class="keywordflow">return</span> SNMPERR_NO_VARS;
03402     
03403     mode = requests-&gt;<a class="code" href="structnetsnmp__request__info__s.html#o2">agent_req_info</a>-&gt;<a class=
"code" href="structnetsnmp__agent__request__info__s.html#o0">mode</a>; <span class="comment">/* every req has same mode */</span>
03404     
03405     <span class="keywordflow">for</span>(; requests ; requests = requests-&gt;<a class="code" href=
"structnetsnmp__request__info__s.html#o13">next</a>) {
03406 
03408         netsnmp_assert(NULL != requests-&gt;<a class="code" href=
"structnetsnmp__request__info__s.html#o2">agent_req_info</a>);
03409         netsnmp_assert(mode == requests-&gt;<a class="code" href=
"structnetsnmp__request__info__s.html#o2">agent_req_info</a>-&gt;<a class="code" href=
"structnetsnmp__agent__request__info__s.html#o0">mode</a>);
03410 
03411         <span class="comment">/*</span>
03412 <span class="comment">         * set error for this request. Log any errors, save the last</span>
03413 <span class="comment">         * to return to the user.</span>
03414 <span class="comment">         */</span>
03415         <span class="keywordflow">if</span>((rc = <a class="code" href=
"group__snmp__agent.html#ga71">_request_set_error</a>(requests, mode, error))) {
03416             <a class="code" href="group__snmp__logging.html#ga41">snmp_log</a>(LOG_WARNING,<span class=
"stringliteral">"got %d while setting request error\n"</span>, rc);
03417             result = rc;
03418         }
03419     }
03420     <span class="keywordflow">return</span> result;
03421 }
03422 
03423 <span class="keyword">extern</span> <span class="keyword">struct </span>timeval starttime;
03424 
03425                 <span class="comment">/*</span>
03426 <span class="comment">                 * Return the value of 'sysUpTime' at the given marker </span>
03427 <span class="comment">                 */</span>
03428 u_long
03429 netsnmp_marker_uptime(marker_t pm)
03430 {
03431     u_long          res;
03432     marker_t        start = (marker_t) &amp; starttime;
03433 
03434     res = <a class="code" href="group__util.html#ga19">uatime_hdiff</a>(start, pm);
03435     <span class="keywordflow">return</span> res;                 <span class=
"comment">/* atime_diff works in msec, not csec */</span>
03436 }
03437 
03438                         <span class="comment">/*</span>
03439 <span class="comment">                         * struct timeval equivalents of these </span>
03440 <span class="comment">                         */</span>
03441 u_long
03442 netsnmp_timeval_uptime(<span class="keyword">struct</span> timeval * tv)
03443 {
03444     <span class="keywordflow">return</span> netsnmp_marker_uptime((marker_t) tv);
03445 }
03446 
03447                 <span class="comment">/*</span>
03448 <span class="comment">                 * Return the current value of 'sysUpTime' </span>
03449 <span class="comment">                 */</span>
03450 u_long
03451 netsnmp_get_agent_uptime(<span class="keywordtype">void</span>)
03452 {
03453     <span class="keyword">struct </span>timeval  now;
03454     gettimeofday(&amp;now, NULL);
03455 
03456     <span class="keywordflow">return</span> netsnmp_timeval_uptime(&amp;now);
03457 }
03458 
03459 
03460 
03461 NETSNMP_INLINE <span class="keywordtype">void</span>
03462 netsnmp_agent_add_list_data(<a class="code" href=
"structnetsnmp__agent__request__info__s.html">netsnmp_agent_request_info</a> *ari,
03463                             <a class="code" href="structnetsnmp__data__list__s.html">netsnmp_data_list</a> *node)
03464 {
03465     <span class="keywordflow">if</span> (ari) {
03466         <span class="keywordflow">if</span> (ari-&gt;<a class="code" href=
"structnetsnmp__agent__request__info__s.html#o2">agent_data</a>) {
03467             <a class="code" href="group__data__list.html#ga4">netsnmp_add_list_data</a>(&amp;ari-&gt;<a class="code" href=
"structnetsnmp__agent__request__info__s.html#o2">agent_data</a>, node);
03468         } <span class="keywordflow">else</span> {
03469             ari-&gt;<a class="code" href="structnetsnmp__agent__request__info__s.html#o2">agent_data</a> = node;
03470         }
03471     }
03472 }
03473 
03474 NETSNMP_INLINE <span class="keywordtype">int</span>
03475 netsnmp_agent_remove_list_data(<a class="code" href=
"structnetsnmp__agent__request__info__s.html">netsnmp_agent_request_info</a> *ari,
03476                                <span class="keyword">const</span> <span class="keywordtype">char</span> * name)
03477 {
03478     <span class="keywordflow">if</span> ((NULL == ari) || (NULL == ari-&gt;<a class="code" href=
"structnetsnmp__agent__request__info__s.html#o2">agent_data</a>))
03479         <span class="keywordflow">return</span> 1;
03480 
03481     <span class="keywordflow">return</span> <a class="code" href=
"group__data__list.html#ga9">netsnmp_remove_list_node</a>(&amp;ari-&gt;<a class="code" href=
"structnetsnmp__agent__request__info__s.html#o2">agent_data</a>, name);
03482 }
03483 
03484 NETSNMP_INLINE <span class="keywordtype">void</span>    *
03485 netsnmp_agent_get_list_data(<a class="code" href=
"structnetsnmp__agent__request__info__s.html">netsnmp_agent_request_info</a> *ari,
03486                             <span class="keyword">const</span> <span class="keywordtype">char</span> *name)
03487 {
03488     <span class="keywordflow">if</span> (ari) {
03489         <span class="keywordflow">return</span> <a class="code" href=
"group__data__list.html#ga7">netsnmp_get_list_data</a>(ari-&gt;<a class="code" href=
"structnetsnmp__agent__request__info__s.html#o2">agent_data</a>, name);
03490     }
03491     <span class="keywordflow">return</span> NULL;
03492 }
03493 
03494 NETSNMP_INLINE <span class="keywordtype">void</span>
03495 netsnmp_free_agent_data_set(<a class="code" href=
"structnetsnmp__agent__request__info__s.html">netsnmp_agent_request_info</a> *ari)
03496 {
03497     <span class="keywordflow">if</span> (ari) {
03498         <a class="code" href="group__data__list.html#ga1">netsnmp_free_list_data</a>(ari-&gt;<a class="code" href=
"structnetsnmp__agent__request__info__s.html#o2">agent_data</a>);
03499     }
03500 }
03501 
03502 NETSNMP_INLINE <span class="keywordtype">void</span>
03503 netsnmp_free_agent_data_sets(<a class="code" href=
"structnetsnmp__agent__request__info__s.html">netsnmp_agent_request_info</a> *ari)
03504 {
03505     <span class="keywordflow">if</span> (ari) {
03506         <a class="code" href="group__data__list.html#ga2">netsnmp_free_all_list_data</a>(ari-&gt;<a class="code" href=
"structnetsnmp__agent__request__info__s.html#o2">agent_data</a>);
03507     }
03508 }
03509 
03510 NETSNMP_INLINE <span class="keywordtype">void</span>
03511 netsnmp_free_agent_request_info(<a class="code" href=
"structnetsnmp__agent__request__info__s.html">netsnmp_agent_request_info</a> *ari)
03512 {
03513     <span class="keywordflow">if</span> (ari) {
03514         <span class="keywordflow">if</span> (ari-&gt;<a class="code" href=
"structnetsnmp__agent__request__info__s.html#o2">agent_data</a>) {
03515             <a class="code" href="group__data__list.html#ga2">netsnmp_free_all_list_data</a>(ari-&gt;<a class="code" href=
"structnetsnmp__agent__request__info__s.html#o2">agent_data</a>);
03516         }
03517         <a class="code" href="group__util.html#ga36">SNMP_FREE</a>(ari);
03518     }
03519 }
03520 
03521 <span class="comment">/*************************************************************************</span>
03522 <span class="comment"> *</span>
03523 <span class="comment"> * deprecated functions</span>
03524 <span class="comment"> *</span>
03525 <span class="comment"> */</span>
03526 
03534 <span class="keywordtype">int</span>
<a name="l03535" id="l03535"></a><a class="code" href="group__snmp__agent.html#ga83">03535</a> <a class="code" href=
"group__snmp__agent.html#ga83">netsnmp_set_request_error</a>(<a class="code" href=
"structnetsnmp__agent__request__info__s.html">netsnmp_agent_request_info</a> *reqinfo,
03536                           <a class="code" href=
"structnetsnmp__request__info__s.html">netsnmp_request_info</a> *request, <span class="keywordtype">int</span> error_value)
03537 {
03538     <span class="keywordflow">if</span> (!request || !reqinfo)
03539         <span class="keywordflow">return</span> error_value;
03540 
03541     <a class="code" href="group__snmp__agent.html#ga71">_request_set_error</a>(request, reqinfo-&gt;<a class="code" href=
"structnetsnmp__agent__request__info__s.html#o0">mode</a>, error_value);
03542     
03543     <span class="keywordflow">return</span> error_value;
03544 }
03545 
03553 <span class="keywordtype">int</span>
<a name="l03554" id="l03554"></a><a class="code" href="group__snmp__agent.html#ga84">03554</a> <a class="code" href=
"group__snmp__agent.html#ga84">netsnmp_set_mode_request_error</a>(<span class="keywordtype">int</span> mode, <a class="code"
href="structnetsnmp__request__info__s.html">netsnmp_request_info</a> *request,
03555                                <span class="keywordtype">int</span> error_value)
03556 {
03557     <a class="code" href="group__snmp__agent.html#ga71">_request_set_error</a>(request, mode, error_value);
03558     
03559     <span class="keywordflow">return</span> error_value;
03560 }
03561 
03569 <span class="keywordtype">int</span>
<a name="l03570" id="l03570"></a><a class="code" href="group__snmp__agent.html#ga85">03570</a> <a class="code" href=
"group__snmp__agent.html#ga85">netsnmp_set_all_requests_error</a>(<a class="code" href=
"structnetsnmp__agent__request__info__s.html">netsnmp_agent_request_info</a> *reqinfo,
03571                                <a class="code" href=
"structnetsnmp__request__info__s.html">netsnmp_request_info</a> *requests,
03572                                <span class="keywordtype">int</span> error_value)
03573 {
03574     <a class="code" href="group__snmp__agent.html#ga73">netsnmp_request_set_error_all</a>(requests, error_value);
03575     <span class="keywordflow">return</span> error_value;
03576 }
</pre>
  </div>
  <hr size="1" />

  <address style="align: right;">
    <small>Generated on Fri Dec 30 13:47:47 2005 for net-snmp by&nbsp; <a href="http://www.doxygen.org/index.html"><img src=
    "doxygen.png" alt="doxygen" align="middle" border="0" /></a> 1.3.9.1</small>
  </address>
<!-- CONTENT END -->
<!--#include virtual="/page-bottom.html" -->

