<!--#set var="section" value="development" -->
<!--#include virtual="/page-top.html" -->
<!-- CONTENT START -->
  <!-- Generated by Doxygen 1.3.9.1 -->

  <div class="qindex">
    <a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="modules.html">Modules</a> | <a class=
    "qindex" href="annotated.html">Data&nbsp;Structures</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class=
    "qindex" href="functions.html">Data&nbsp;Fields</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a> | <a class=
    "qindex" href="examples.html">Examples</a>
  </div>

  <div class="nav">
    <a class="el" href="dir_000003.html">agent</a>
  </div>

  <h1>snmp_agent.c</h1>

  <div class="fragment">
    <pre class="fragment">
00001 <span class="comment">/*</span>
00002 <span class="comment"> * snmp_agent.c</span>
00003 <span class="comment"> *</span>
00004 <span class="comment"> * Simple Network Management Protocol (RFC 1067).</span>
00005 <span class="comment"> */</span>
00006 <span class="comment">/* Portions of this file are subject to the following copyright(s).  See</span>
00007 <span class="comment"> * the Net-SNMP's COPYING file for more details and other copyrights</span>
00008 <span class="comment"> * that may apply:</span>
00009 <span class="comment"> */</span>
00010 <span class="comment">/* Portions of this file are subject to the following copyrights.  See</span>
00011 <span class="comment"> * the Net-SNMP's COPYING file for more details and other copyrights</span>
00012 <span class="comment"> * that may apply:</span>
00013 <span class="comment"> */</span>
00014 <span class="comment">/***********************************************************</span>
00015 <span class="comment">        Copyright 1988, 1989 by Carnegie Mellon University</span>
00016 
00017 <span class="comment">                      All Rights Reserved</span>
00018 
00019 <span class="comment">Permission to use, copy, modify, and distribute this software and its </span>
00020 <span class="comment">documentation for any purpose and without fee is hereby granted, </span>
00021 <span class="comment">provided that the above copyright notice appear in all copies and that</span>
00022 <span class="comment">both that copyright notice and this permission notice appear in </span>
00023 <span class="comment">supporting documentation, and that the name of CMU not be</span>
00024 <span class="comment">used in advertising or publicity pertaining to distribution of the</span>
00025 <span class="comment">software without specific, written prior permission.  </span>
00026 
00027 <span class="comment">CMU DISCLAIMS ALL WARRANTIES WITH REGARD TO THIS SOFTWARE, INCLUDING</span>
00028 <span class="comment">ALL IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS, IN NO EVENT SHALL</span>
00029 <span class="comment">CMU BE LIABLE FOR ANY SPECIAL, INDIRECT OR CONSEQUENTIAL DAMAGES OR</span>
00030 <span class="comment">ANY DAMAGES WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS,</span>
00031 <span class="comment">WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION,</span>
00032 <span class="comment">ARISING OUT OF OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS</span>
00033 <span class="comment">SOFTWARE.</span>
00034 <span class="comment">******************************************************************/</span>
00035 <span class="comment">/*</span>
00036 <span class="comment"> * Portions of this file are copyrighted by:</span>
00037 <span class="comment"> * Copyright &copy; 2003 Sun Microsystems, Inc. All rights </span>
00038 <span class="comment"> * reserved.  Use is subject to license terms specified in the </span>
00039 <span class="comment"> * COPYING file distributed with the Net-SNMP package.</span>
00040 <span class="comment"> */</span>
00046 <span class="preprocessor">#include &lt;net-snmp/net-snmp-config.h&gt;</span>
00047 
00048 <span class="preprocessor">#include &lt;sys/types.h&gt;</span>
00049 <span class="preprocessor">#ifdef HAVE_LIMITS_H</span>
00050 <span class="preprocessor">#include &lt;limits.h&gt;</span>
00051 <span class="preprocessor">#endif</span>
00052 <span class="preprocessor">#ifdef HAVE_STDLIB_H</span>
00053 <span class="preprocessor">#include &lt;stdlib.h&gt;</span>
00054 <span class="preprocessor">#endif</span>
00055 <span class="preprocessor">#if HAVE_UNISTD_H</span>
00056 <span class="preprocessor">#include &lt;unistd.h&gt;</span>
00057 <span class="preprocessor">#endif</span>
00058 <span class="preprocessor">#if HAVE_STRING_H</span>
00059 <span class="preprocessor">#include &lt;string.h&gt;</span>
00060 <span class="preprocessor">#endif</span>
00061 <span class="preprocessor">#if TIME_WITH_SYS_TIME</span>
00062 <span class="preprocessor"># ifdef WIN32</span>
00063 <span class="preprocessor">#  include &lt;sys/timeb.h&gt;</span>
00064 <span class="preprocessor"># else</span>
00065 <span class="preprocessor">#  include &lt;sys/time.h&gt;</span>
00066 <span class="preprocessor"># endif</span>
00067 <span class="preprocessor"># include &lt;time.h&gt;</span>
00068 <span class="preprocessor">#else</span>
00069 <span class="preprocessor"># if HAVE_SYS_TIME_H</span>
00070 <span class="preprocessor">#  include &lt;sys/time.h&gt;</span>
00071 <span class="preprocessor"># else</span>
00072 <span class="preprocessor">#  include &lt;time.h&gt;</span>
00073 <span class="preprocessor"># endif</span>
00074 <span class="preprocessor">#endif</span>
00075 <span class="preprocessor">#if HAVE_SYS_SELECT_H</span>
00076 <span class="preprocessor">#include &lt;sys/select.h&gt;</span>
00077 <span class="preprocessor">#endif</span>
00078 <span class="preprocessor">#if HAVE_NETINET_IN_H</span>
00079 <span class="preprocessor">#include &lt;netinet/in.h&gt;</span>
00080 <span class="preprocessor">#endif</span>
00081 <span class="preprocessor">#include &lt;errno.h&gt;</span>
00082 <span class="preprocessor">#if HAVE_WINSOCK_H</span>
00083 <span class="preprocessor">#include &lt;winsock.h&gt;</span>
00084 <span class="preprocessor">#endif</span>
00085 
00086 <span class="preprocessor">#if HAVE_DMALLOC_H</span>
00087 <span class="preprocessor">#include &lt;dmalloc.h&gt;</span>
00088 <span class="preprocessor">#endif</span>
00089 
00090 <span class="preprocessor">#define SNMP_NEED_REQUEST_LIST</span>
00091 <span class="preprocessor">#include &lt;net-snmp/net-snmp-includes.h&gt;</span>
00092 <span class="preprocessor">#include &lt;net-snmp/agent/net-snmp-agent-includes.h&gt;</span>
00093 <span class="preprocessor">#include &lt;net-snmp/library/snmp_assert.h&gt;</span>
00094 
00095 <span class="preprocessor">#ifdef USE_LIBWRAP</span>
00096 <span class="preprocessor">#include &lt;tcpd.h&gt;</span>
00097 <span class="preprocessor">#include &lt;syslog.h&gt;</span>
00098 <span class="keywordtype">int</span>             allow_severity = LOG_INFO;
00099 <span class="keywordtype">int</span>             deny_severity = LOG_WARNING;
00100 <span class="preprocessor">#endif</span>
00101 
00102 <span class="preprocessor">#include "snmpd.h"</span>
00103 <span class="preprocessor">#include "mibgroup/struct.h"</span>
00104 <span class="preprocessor">#include "mibgroup/util_funcs.h"</span>
00105 <span class="preprocessor">#include &lt;net-snmp/agent/mib_module_config.h&gt;</span>
00106 <span class="preprocessor">#include &lt;net-snmp/agent/mib_modules.h&gt;</span>
00107 
00108 <span class="preprocessor">#ifdef USING_AGENTX_PROTOCOL_MODULE</span>
00109 <span class="preprocessor">#include "agentx/protocol.h"</span>
00110 <span class="preprocessor">#endif</span>
00111 
00112 <span class="preprocessor">#ifdef USING_AGENTX_MASTER_MODULE</span>
00113 <span class="preprocessor">#include "agentx/master.h"</span>
00114 <span class="preprocessor">#endif</span>
00115 
00116 <span class="preprocessor">#ifdef USING_SMUX_MODULE</span>
00117 <span class="preprocessor">#include "smux/smux.h"</span>
00118 <span class="preprocessor">#endif</span>
00119 
00120 <span class="preprocessor">#define SNMP_ADDRCACHE_SIZE 10</span>
00121 <span class="preprocessor">#define SNMP_ADDRCACHE_MAXAGE 300 </span><span class="comment">/* in seconds */</span>
00122 
00123 <span class="keyword">enum</span> {
00124     SNMP_ADDRCACHE_UNUSED = 0,
00125     SNMP_ADDRCACHE_USED = 1
00126 };
00127 
00128 <span class="keyword">struct </span>addrCache {
00129     <span class="keywordtype">char</span>           *addr;
00130     <span class="keywordtype">int</span>            status;
00131     <span class="keyword">struct </span>timeval lastHit;
00132 };
00133 
00134 <span class="keyword">static</span> <span class="keyword">struct </span>addrCache addrCache[SNMP_ADDRCACHE_SIZE];
00135 <span class="keywordtype">int</span>             log_addresses = 0;
00136 
00137 
00138 
00139 <span class="keyword">typedef</span> <span class="keyword">struct </span>_agent_nsap {
00140     <span class="keywordtype">int</span>             handle;
00141     netsnmp_transport *t;
00142     <span class="keywordtype">void</span>           *s;          <span class=
"comment">/*  Opaque internal session pointer.  */</span>
00143     <span class="keyword">struct </span>_agent_nsap *next;
00144 } agent_nsap;
00145 
00146 <span class="keyword">static</span> agent_nsap *agent_nsap_list = NULL;
00147 <span class="keyword">static</span> netsnmp_agent_session *agent_session_list = NULL;
00148 <span class="keyword">static</span> netsnmp_agent_session *netsnmp_processing_set = NULL;
00149 netsnmp_agent_session *agent_delegated_list = NULL;
00150 netsnmp_agent_session *netsnmp_agent_queued_list = NULL;
00151 
00152 
00153 <span class="keywordtype">int</span>             netsnmp_agent_check_packet(<a class="code" href=
"structsnmp__session.html">netsnmp_session</a> *,
00154                                            <span class="keyword">struct</span> netsnmp_transport_s *,
00155                                            <span class="keywordtype">void</span> *, <span class="keywordtype">int</span>);
00156 <span class="keywordtype">int</span>             netsnmp_agent_check_parse(<a class="code" href=
"structsnmp__session.html">netsnmp_session</a> *, <a class="code" href="structsnmp__pdu.html">netsnmp_pdu</a> *,
00157                                           <span class="keywordtype">int</span>);
00158 <span class="keywordtype">void</span>            delete_subnetsnmp_tree_cache(netsnmp_agent_session *asp);
00159 <span class="keywordtype">int</span>             <a class="code" href=
"group__snmp__agent.html#ga16">handle_pdu</a>(netsnmp_agent_session *asp);
00160 <span class="keywordtype">int</span>             netsnmp_handle_request(netsnmp_agent_session *asp,
00161                                        <span class="keywordtype">int</span> status);
00162 <span class="keywordtype">int</span>             <a class="code" href=
"group__snmp__agent.html#ga18">netsnmp_wrap_up_request</a>(netsnmp_agent_session *asp,
00163                                         <span class="keywordtype">int</span> status);
00164 <span class="keywordtype">int</span>             check_delayed_request(netsnmp_agent_session *asp);
00165 <span class="keywordtype">int</span>             <a class="code" href=
"group__snmp__agent.html#ga20">handle_getnext_loop</a>(netsnmp_agent_session *asp);
00166 <span class="keywordtype">int</span>             handle_set_loop(netsnmp_agent_session *asp);
00167 
00168 <span class="keywordtype">int</span>             netsnmp_check_queued_chain_for(netsnmp_agent_session *asp);
00169 <span class="keywordtype">int</span>             netsnmp_add_queued(netsnmp_agent_session *asp);
00170 <span class="keywordtype">int</span>             netsnmp_remove_from_delegated(netsnmp_agent_session *asp);
00171 
00172 
00173 <span class="keyword">static</span> <span class="keywordtype">int</span>      current_globalid = 0;
00174 
00175 <span class="keywordtype">int</span>
00176 netsnmp_allocate_globalcacheid(<span class="keywordtype">void</span>)
00177 {
00178     <span class="keywordflow">return</span> ++current_globalid;
00179 }
00180 
00181 <span class="keywordtype">int</span>
00182 netsnmp_get_local_cachid(netsnmp_cachemap *cache_store, <span class="keywordtype">int</span> globalid)
00183 {
00184     <span class="keywordflow">while</span> (cache_store != NULL) {
00185         <span class="keywordflow">if</span> (cache_store-&gt;globalid == globalid)
00186             <span class="keywordflow">return</span> cache_store-&gt;cacheid;
00187         cache_store = cache_store-&gt;next;
00188     }
00189     <span class="keywordflow">return</span> -1;
00190 }
00191 
00192 netsnmp_cachemap *
00193 netsnmp_get_or_add_local_cachid(netsnmp_cachemap **cache_store,
00194                                 <span class="keywordtype">int</span> globalid, <span class=
"keywordtype">int</span> localid)
00195 {
00196     netsnmp_cachemap *tmpp;
00197 
00198     tmpp = <a class="code" href="group__util.html#ga39">SNMP_MALLOC_TYPEDEF</a>(netsnmp_cachemap);
00199     <span class="keywordflow">if</span> (*cache_store) {
00200         tmpp-&gt;next = *cache_store;
00201         *cache_store = tmpp;
00202     } <span class="keywordflow">else</span> {
00203         *cache_store = tmpp;
00204     }
00205 
00206     tmpp-&gt;globalid = globalid;
00207     tmpp-&gt;cacheid = localid;
00208     <span class="keywordflow">return</span> tmpp;
00209 }
00210 
00211 <span class="keywordtype">void</span>
00212 netsnmp_free_cachemap(netsnmp_cachemap *cache_store)
00213 {
00214     netsnmp_cachemap *tmpp;
00215     <span class="keywordflow">while</span> (cache_store) {
00216         tmpp = cache_store;
00217         cache_store = cache_store-&gt;next;
00218         <a class="code" href="group__util.html#ga36">SNMP_FREE</a>(tmpp);
00219     }
00220 }
00221 
00222 
00223 <span class="keyword">typedef</span> <span class="keyword">struct </span>agent_set_cache_s {
00224     <span class="comment">/*</span>
00225 <span class="comment">     * match on these 2 </span>
00226 <span class="comment">     */</span>
00227     <span class="keywordtype">int</span>             transID;
00228     <a class="code" href="structsnmp__session.html">netsnmp_session</a> *sess;
00229 
00230     <span class="comment">/*</span>
00231 <span class="comment">     * store this info </span>
00232 <span class="comment">     */</span>
00233     netsnmp_tree_cache *treecache;
00234     <span class="keywordtype">int</span>             treecache_len;
00235     <span class="keywordtype">int</span>             treecache_num;
00236 
00237     <span class="keywordtype">int</span>             vbcount;
00238     <a class="code" href="structnetsnmp__request__info__s.html">netsnmp_request_info</a> *requests;
00239     <a class="code" href="structvariable__list.html">netsnmp_variable_list</a> *saved_vars;
00240     <a class="code" href="structnetsnmp__data__list__s.html">netsnmp_data_list</a> *agent_data;
00241 
00242     <span class="comment">/*</span>
00243 <span class="comment">     * list </span>
00244 <span class="comment">     */</span>
00245     <span class="keyword">struct </span>agent_set_cache_s *next;
00246 } agent_set_cache;
00247 
00248 <span class="keyword">static</span> agent_set_cache *Sets = NULL;
00249 
00250 agent_set_cache *
00251 save_set_cache(netsnmp_agent_session *asp)
00252 {
00253     agent_set_cache *ptr;
00254 
00255     <span class="keywordflow">if</span> (!asp || !asp-&gt;reqinfo || !asp-&gt;pdu)
00256         <span class="keywordflow">return</span> NULL;
00257 
00258     ptr = <a class="code" href="group__util.html#ga39">SNMP_MALLOC_TYPEDEF</a>(agent_set_cache);
00259     <span class="keywordflow">if</span> (ptr == NULL)
00260         <span class="keywordflow">return</span> NULL;
00261 
00262     <span class="comment">/*</span>
00263 <span class="comment">     * Save the important information </span>
00264 <span class="comment">     */</span>
00265     DEBUGMSGTL((<span class="stringliteral">"verbose:asp"</span>, <span class=
"stringliteral">"asp %p reqinfo %p saved in cache (mode %d)\n"</span>,
00266                 asp, asp-&gt;reqinfo, asp-&gt;pdu-&gt;command));
00267     ptr-&gt;transID = asp-&gt;pdu-&gt;transid;
00268     ptr-&gt;sess = asp-&gt;session;
00269     ptr-&gt;treecache = asp-&gt;treecache;
00270     ptr-&gt;treecache_len = asp-&gt;treecache_len;
00271     ptr-&gt;treecache_num = asp-&gt;treecache_num;
00272     ptr-&gt;agent_data = asp-&gt;reqinfo-&gt;agent_data;
00273     ptr-&gt;requests = asp-&gt;requests;
00274     ptr-&gt;saved_vars = asp-&gt;pdu-&gt;variables; <span class=
"comment">/* requests contains pointers to variables */</span>
00275     ptr-&gt;vbcount = asp-&gt;vbcount;
00276 
00277     <span class="comment">/*</span>
00278 <span class="comment">     * make the agent forget about what we've saved </span>
00279 <span class="comment">     */</span>
00280     asp-&gt;treecache = NULL;
00281     asp-&gt;reqinfo-&gt;agent_data = NULL;
00282     asp-&gt;pdu-&gt;variables = NULL;
00283     asp-&gt;requests = NULL;
00284 
00285     ptr-&gt;next = Sets;
00286     Sets = ptr;
00287 
00288     <span class="keywordflow">return</span> ptr;
00289 }
00290 
00291 <span class="keywordtype">int</span>
00292 get_set_cache(netsnmp_agent_session *asp)
00293 {
00294     agent_set_cache *ptr, *prev = NULL;
00295 
00296     <span class="keywordflow">for</span> (ptr = Sets; ptr != NULL; ptr = ptr-&gt;next) {
00297         <span class=
"keywordflow">if</span> (ptr-&gt;sess == asp-&gt;session &amp;&amp; ptr-&gt;transID == asp-&gt;pdu-&gt;transid) {
00298             <span class="comment">/*</span>
00299 <span class="comment">             * remove this item from list</span>
00300 <span class="comment">             */</span>
00301             <span class="keywordflow">if</span> (prev)
00302                 prev-&gt;next = ptr-&gt;next;
00303             <span class="keywordflow">else</span>
00304                 Sets = ptr-&gt;next;
00305 
00306             <span class="comment">/*</span>
00307 <span class="comment">             * found it.  Get the needed data </span>
00308 <span class="comment">             */</span>
00309             asp-&gt;treecache = ptr-&gt;treecache;
00310             asp-&gt;treecache_len = ptr-&gt;treecache_len;
00311             asp-&gt;treecache_num = ptr-&gt;treecache_num;
00312 
00313             <span class="comment">/*</span>
00314 <span class="comment">             * Free previously allocated requests before overwriting by</span>
00315 <span class="comment">             * cached ones, otherwise memory leaks!</span>
00316 <span class="comment">             */</span>
00317             <span class="keywordflow">if</span> (asp-&gt;requests) {
00318                 <span class="comment">/*</span>
00319 <span class="comment">                 * I don't think this case should ever happen. Please email</span>
00320 <span class="comment">                 * the net-snmp-coders@lists.sourceforge.net if you have</span>
00321 <span class="comment">                 * a test case that hits this assert. -- rstory</span>
00322 <span class="comment">                 */</span>
00323                 <span class="keywordtype">int</span> i;
00324                 netsnmp_assert(NULL == asp-&gt;requests); <span class="comment">/* see note above */</span>
00325                 <span class="keywordflow">for</span> (i = 0; i &lt; asp-&gt;vbcount; i++) {
00326                     <a class="code" href=
"group__handler.html#ga31">netsnmp_free_request_data_sets</a>(&amp;asp-&gt;requests[i]);
00327                 }
00328                 free(asp-&gt;requests);
00329             }
00330             <span class="comment">/*</span>
00331 <span class="comment">             * If we replace asp-&gt;requests with the info from the set cache,</span>
00332 <span class="comment">             * we should replace asp-&gt;pdu-&gt;variables also with the cached</span>
00333 <span class="comment">             * info, as asp-&gt;requests contains pointers to them.  And we</span>
00334 <span class="comment">             * should also free the current asp-&gt;pdu-&gt;variables list...</span>
00335 <span class="comment">             */</span>
00336             <span class="keywordflow">if</span> (ptr-&gt;saved_vars) {
00337                 <span class="keywordflow">if</span> (asp-&gt;pdu-&gt;variables)
00338                     snmp_free_varbind(asp-&gt;pdu-&gt;variables);
00339                 asp-&gt;pdu-&gt;variables = ptr-&gt;saved_vars;
00340                 asp-&gt;vbcount = ptr-&gt;vbcount;
00341             } <span class="keywordflow">else</span> {
00342                 <span class="comment">/*</span>
00343 <span class="comment">                 * when would we not have saved variables? someone</span>
00344 <span class="comment">                 * let me know if they hit this assert. -- rstory</span>
00345 <span class="comment">                 */</span>
00346                 netsnmp_assert(NULL != ptr-&gt;saved_vars);
00347             }
00348             asp-&gt;requests = ptr-&gt;requests;
00349 
00350             netsnmp_assert(NULL != asp-&gt;reqinfo);
00351             asp-&gt;reqinfo-&gt;asp = asp;
00352             asp-&gt;reqinfo-&gt;agent_data = ptr-&gt;agent_data;
00353             
00354             <span class="comment">/*</span>
00355 <span class="comment">             * update request reqinfo, if it's out of date.</span>
00356 <span class="comment">             * yyy-rks: investigate when/why sometimes they match,</span>
00357 <span class="comment">             * sometimes they don't.</span>
00358 <span class="comment">             */</span>
00359             <span class="keywordflow">if</span>(asp-&gt;requests-&gt;agent_req_info != asp-&gt;reqinfo) {
00360                 <span class="comment">/*</span>
00361 <span class="comment">                 * - one don't match case: agentx subagents. prev asp &amp; reqinfo</span>
00362 <span class="comment">                 *   freed, request reqinfo ptrs not cleared.</span>
00363 <span class="comment">                 */</span>
00364                 <a class="code" href=
"structnetsnmp__request__info__s.html">netsnmp_request_info</a> *tmp = asp-&gt;requests;
00365                 DEBUGMSGTL((<span class="stringliteral">"verbose:asp"</span>,
00366                             <span class="stringliteral">"  reqinfo %p doesn't match cached reqinfo %p\n"</span>,
00367                             asp-&gt;reqinfo, asp-&gt;requests-&gt;agent_req_info));
00368                 <span class="keywordflow">for</span>(; tmp; tmp = tmp-&gt;<a class="code" href=
"structnetsnmp__request__info__s.html#o13">next</a>)
00369                     tmp-&gt;<a class="code" href=
"structnetsnmp__request__info__s.html#o2">agent_req_info</a> = asp-&gt;reqinfo;
00370             } <span class="keywordflow">else</span> {
00371                 <span class="comment">/*</span>
00372 <span class="comment">                 * - match case: ?</span>
00373 <span class="comment">                 */</span>
00374                 DEBUGMSGTL((<span class="stringliteral">"verbose:asp"</span>,
00375                             <span class="stringliteral">"  reqinfo %p matches cached reqinfo %p\n"</span>,
00376                             asp-&gt;reqinfo, asp-&gt;requests-&gt;agent_req_info));
00377             }
00378 
00379             <a class="code" href="group__util.html#ga36">SNMP_FREE</a>(ptr);
00380             <span class="keywordflow">return</span> SNMP_ERR_NOERROR;
00381         }
00382         prev = ptr;
00383     }
00384     <span class="keywordflow">return</span> SNMP_ERR_GENERR;
00385 }
00386 
00387 <span class="comment">/* Bulkcache holds the values for the *repeating* varbinds (only),</span>
00388 <span class="comment"> *   but ordered "by column" - i.e. the repetitions for each</span>
00389 <span class="comment"> *   repeating varbind follow on immediately from one another,</span>
00390 <span class="comment"> *   rather than being interleaved, as required by the protocol.</span>
00391 <span class="comment"> *</span>
00392 <span class="comment"> * So we need to rearrange the varbind list so it's ordered "by row".</span>
00393 <span class="comment"> *</span>
00394 <span class="comment"> * In the following code chunk:</span>
00395 <span class="comment"> *     n            = # non-repeating varbinds</span>
00396 <span class="comment"> *     r            = # repeating varbinds</span>
00397 <span class="comment"> *     asp-&gt;vbcount = # varbinds in the incoming PDU</span>
00398 <span class="comment"> *         (So asp-&gt;vbcount = n+r)</span>
00399 <span class="comment"> *</span>
00400 <span class="comment"> *     repeats = Desired # of repetitions (of 'r' varbinds)</span>
00401 <span class="comment"> */</span>
00402 NETSNMP_STATIC_INLINE <span class="keywordtype">void</span>
00403 _reorder_getbulk(netsnmp_agent_session *asp)
00404 {
00405     <span class="keywordtype">int</span>             i, n = 0, r = 0;
00406     <span class="keywordtype">int</span>             repeats = asp-&gt;pdu-&gt;errindex;
00407     <span class="keywordtype">int</span>             j;
00408     <span class="keywordtype">int</span>             all_eoMib;
00409     <a class="code" href="structvariable__list.html">netsnmp_variable_list</a> *prev = NULL;
00410             
00411     <span class="keywordflow">if</span> (asp-&gt;vbcount == 0)  <span class="comment">/* Nothing to do! */</span>
00412         <span class="keywordflow">return</span>;
00413 
00414     <span class="keywordflow">if</span> (asp-&gt;pdu-&gt;errstat &lt; asp-&gt;vbcount) {
00415         n = asp-&gt;pdu-&gt;errstat;
00416     } <span class="keywordflow">else</span> {
00417         n = asp-&gt;vbcount;
00418     }
00419     <span class="keywordflow">if</span> ((r = asp-&gt;vbcount - n) &lt; 0) {
00420         r = 0;
00421     }
00422 
00423     <span class="comment">/* we do nothing if there is nothing repeated */</span>
00424     <span class="keywordflow">if</span> (r == 0)
00425         <span class="keywordflow">return</span>;
00426             
00427     <span class="comment">/*</span>
00428 <span class="comment">     * For each of the original repeating varbinds (except the last),</span>
00429 <span class="comment">     *  go through the block of results for that varbind,</span>
00430 <span class="comment">     *  and link each instance to the corresponding instance</span>
00431 <span class="comment">     *  in the next block.</span>
00432 <span class="comment">     */</span>
00433     <span class="keywordflow">for</span> (i = 0; i &lt; r - 1; i++) {
00434         prev = NULL;
00435         <span class="keywordflow">for</span> (j = 0; j &lt; repeats; j++) {
00436             <span class="comment">/*</span>
00437 <span class="comment">             *  If we don't have a valid name for a given repetition</span>
00438 <span class="comment">             *   (and probably for all the ones that follow as well),</span>
00439 <span class="comment">             *   extend the previous result to indicate 'endOfMibView'</span>
00440 <span class="comment">             */</span>
00441             <span class="keywordflow">if</span> (asp-&gt;bulkcache[i * repeats + j]-&gt;name_length == 0
00442                 &amp;&amp; prev) {
00443                 snmp_set_var_objid(
00444                     asp-&gt;bulkcache[i * repeats + j],
00445                     prev-&gt;<a class="code" href="structvariable__list.html#o1">name</a>, prev-&gt;<a class="code" href=
"structvariable__list.html#o2">name_length</a>);
00446                 <a class="code" href="group__snmp__client.html#ga18">snmp_set_var_typed_value</a>(
00447                     asp-&gt;bulkcache[i * repeats + j],
00448                     SNMP_ENDOFMIBVIEW, NULL, 0);
00449             }
00450             prev = asp-&gt;bulkcache[i * repeats + j];
00451 
00452             asp-&gt;bulkcache[i * repeats + j]-&gt;<a class="code" href="structvariable__list.html#o0">next_variable</a> =
00453                 asp-&gt;bulkcache[(i + 1) * repeats + j];
00454         }
00455     }
00456     <span class="comment">/*</span>
00457 <span class="comment">     * For the last of the original repeating varbinds,</span>
00458 <span class="comment">     *  go through that block of results, and link each</span>
00459 <span class="comment">     *  instance to the *next* instance in the *first* block.</span>
00460 <span class="comment">     *</span>
00461 <span class="comment">     * The very last instance of this block is left untouched</span>
00462 <span class="comment">     *  since it (correctly) points to the end of the list.</span>
00463 <span class="comment">     */</span>
00464     <span class="keywordflow">if</span> (r &gt; 0) {
00465         prev = NULL;
00466         <span class="keywordflow">for</span> (j = 0; j &lt; repeats - 1; j++) {
00467             <span class="comment">/*</span>
00468 <span class="comment">             *  Fill in missing names with 'endOfMibView' as above...</span>
00469 <span class="comment">             */</span>
00470             <span class="keywordflow">if</span> (asp-&gt;bulkcache[(r - 1) * repeats + j]-&gt;name_length == 0
00471                 &amp;&amp; prev) {
00472                 snmp_set_var_objid(
00473                     asp-&gt;bulkcache[(r - 1) * repeats + j],
00474                     prev-&gt;<a class="code" href="structvariable__list.html#o1">name</a>, prev-&gt;<a class="code" href=
"structvariable__list.html#o2">name_length</a>);
00475                 <a class="code" href="group__snmp__client.html#ga18">snmp_set_var_typed_value</a>(
00476                     asp-&gt;bulkcache[(r - 1) * repeats + j],
00477                     SNMP_ENDOFMIBVIEW, NULL, 0);
00478             }
00479             prev = asp-&gt;bulkcache[(r - 1) * repeats + j];
00480             asp-&gt;bulkcache[(r - 1) * repeats + j]-&gt;<a class="code" href=
"structvariable__list.html#o0">next_variable</a> =
00481                 asp-&gt;bulkcache[j + 1];
00482         }
00483         <span class="comment">/*</span>
00484 <span class="comment">         *  ... Not forgetting the very last entry</span>
00485 <span class="comment">         */</span>
00486         <span class="keywordflow">if</span> (asp-&gt;bulkcache[r * repeats - 1]-&gt;name_length == 0
00487             &amp;&amp; prev) {
00488             snmp_set_var_objid(
00489                 asp-&gt;bulkcache[r * repeats - 1],
00490                 prev-&gt;<a class="code" href="structvariable__list.html#o1">name</a>, prev-&gt;<a class="code" href=
"structvariable__list.html#o2">name_length</a>);
00491             <a class="code" href="group__snmp__client.html#ga18">snmp_set_var_typed_value</a>(
00492                 asp-&gt;bulkcache[r * repeats - 1],
00493                 SNMP_ENDOFMIBVIEW, NULL, 0);
00494         }
00495     }
00496 
00497     <span class="comment">/*</span>
00498 <span class="comment">     * If we've got a full row of endOfMibViews, then we</span>
00499 <span class="comment">     *  can truncate the result varbind list after that.</span>
00500 <span class="comment">     *</span>
00501 <span class="comment">     * Look for endOfMibView exception values in the list of</span>
00502 <span class="comment">     *  repetitions for the first varbind, and check the </span>
00503 <span class="comment">     *  corresponding instances for the other varbinds</span>
00504 <span class="comment">     *  (following the next_variable links).</span>
00505 <span class="comment">     *</span>
00506 <span class="comment">     * If they're all endOfMibView too, then we can terminate</span>
00507 <span class="comment">     *  the linked list there, and free any redundant varbinds.</span>
00508 <span class="comment">     */</span>
00509     all_eoMib = 0;
00510     <span class="keywordflow">for</span> (i = 0; i &lt; repeats; i++) {
00511         <span class="keywordflow">if</span> (asp-&gt;bulkcache[i]-&gt;type == SNMP_ENDOFMIBVIEW) {
00512             all_eoMib = 1;
00513             <span class="keywordflow">for</span> (j = 1, prev=asp-&gt;bulkcache[i];
00514                  j &lt; r;
00515                  j++, prev=prev-&gt;<a class="code" href="structvariable__list.html#o0">next_variable</a>) {
00516                 <span class="keywordflow">if</span> (prev-&gt;type != SNMP_ENDOFMIBVIEW) {
00517                     all_eoMib = 0;
00518                     <span class="keywordflow">break</span>;      <span class="comment">/* Found a real value */</span>
00519                 }
00520             }
00521             <span class="keywordflow">if</span> (all_eoMib) {
00522                 <span class="comment">/*</span>
00523 <span class="comment">                 * This is indeed a full endOfMibView row.</span>
00524 <span class="comment">                 * Terminate the list here &amp; free the rest.</span>
00525 <span class="comment">                 */</span>
00526                 snmp_free_varbind( prev-&gt;next_variable );
00527                 prev-&gt;<a class="code" href="structvariable__list.html#o0">next_variable</a> = NULL;
00528                 <span class="keywordflow">break</span>;
00529             }
00530         }
00531     }
00532 }
00533 
00534 
00535 <span class="keywordtype">int</span>
00536 getNextSessID()
00537 {
00538     <span class="keyword">static</span> <span class="keywordtype">int</span>      SessionID = 0;
00539 
00540     <span class="keywordflow">return</span> ++SessionID;
00541 }
00542 
00555 <span class="keywordtype">int</span>
<a name="l00556" id="l00556"></a><a class="code" href="group__snmp__agent.html#ga33">00556</a> <a class="code" href=
"group__snmp__agent.html#ga33">agent_check_and_process</a>(<span class="keywordtype">int</span> block)
00557 {
00558     <span class="keywordtype">int</span>             numfds;
00559     fd_set          fdset;
00560     <span class="keyword">struct </span>timeval  timeout = { LONG_MAX, 0 }, *tvp = &amp;timeout;
00561     <span class="keywordtype">int</span>             count;
00562     <span class="keywordtype">int</span>             fakeblock = 0;
00563 
00564     numfds = 0;
00565     FD_ZERO(&amp;fdset);
00566     snmp_select_info(&amp;numfds, &amp;fdset, tvp, &amp;fakeblock);
00567     <span class="keywordflow">if</span> (block != 0 &amp;&amp; fakeblock != 0) {
00568         <span class="comment">/*</span>
00569 <span class="comment">         * There are no alarms registered, and the caller asked for blocking, so</span>
00570 <span class="comment">         * let select() block forever.  </span>
00571 <span class="comment">         */</span>
00572 
00573         tvp = NULL;
00574     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (block != 0 &amp;&amp; fakeblock == 0) {
00575         <span class="comment">/*</span>
00576 <span class="comment">         * The caller asked for blocking, but there is an alarm due sooner than</span>
00577 <span class="comment">         * LONG_MAX seconds from now, so use the modified timeout returned by</span>
00578 <span class="comment">         * snmp_select_info as the timeout for select().  </span>
00579 <span class="comment">         */</span>
00580 
00581     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (block == 0) {
00582         <span class="comment">/*</span>
00583 <span class="comment">         * The caller does not want us to block at all.  </span>
00584 <span class="comment">         */</span>
00585 
00586         tvp-&gt;tv_sec = 0;
00587         tvp-&gt;tv_usec = 0;
00588     }
00589 
00590     count = select(numfds, &amp;fdset, 0, 0, tvp);
00591 
00592     <span class="keywordflow">if</span> (count &gt; 0) {
00593         <span class="comment">/*</span>
00594 <span class="comment">         * packets found, process them </span>
00595 <span class="comment">         */</span>
00596         snmp_read(&amp;fdset);
00597     } <span class="keywordflow">else</span>
00598         <span class="keywordflow">switch</span> (count) {
00599         <span class="keywordflow">case</span> 0:
00600             snmp_timeout();
00601             <span class="keywordflow">break</span>;
00602         <span class="keywordflow">case</span> -1:
00603             <span class="keywordflow">if</span> (errno != EINTR) {
00604                 snmp_log_perror(<span class="stringliteral">"select"</span>);
00605             }
00606             <span class="keywordflow">return</span> -1;
00607         <span class="keywordflow">default</span>:
00608             <a class="code" href="group__snmp__logging.html#ga39">snmp_log</a>(LOG_ERR, <span class=
"stringliteral">"select returned %d\n"</span>, count);
00609             <span class="keywordflow">return</span> -1;
00610         }                       <span class="comment">/* endif -- count&gt;0 */</span>
00611 
00612     <span class="comment">/*</span>
00613 <span class="comment">     * Run requested alarms.  </span>
00614 <span class="comment">     */</span>
00615     run_alarms();
00616 
00617     netsnmp_check_outstanding_agent_requests();
00618 
00619     <span class="keywordflow">return</span> count;
00620 }
00621 
00622 
00623 <span class="comment">/*</span>
00624 <span class="comment"> * Set up the address cache.  </span>
00625 <span class="comment"> */</span>
00626 <span class="keywordtype">void</span>
00627 netsnmp_addrcache_initialise(<span class="keywordtype">void</span>)
00628 {
00629     <span class="keywordtype">int</span>             i = 0;
00630 
00631     <span class="keywordflow">for</span> (i = 0; i &lt; SNMP_ADDRCACHE_SIZE; i++) {
00632         addrCache[i].addr = NULL;
00633         addrCache[i].status = SNMP_ADDRCACHE_UNUSED;
00634     }
00635 }
00636 
00637 <span class="comment">/*</span>
00638 <span class="comment"> * Adds a new entry to the cache of addresses that</span>
00639 <span class="comment"> * have recently made connections to the agent.</span>
00640 <span class="comment"> * Returns 0 if the entry already exists (but updates</span>
00641 <span class="comment"> * the entry with a new timestamp) and 1 if the</span>
00642 <span class="comment"> * entry did not previously exist.</span>
00643 <span class="comment"> *</span>
00644 <span class="comment"> * Implements a simple LRU cache replacement</span>
00645 <span class="comment"> * policy. Uses a linear search, which should be</span>
00646 <span class="comment"> * okay, as long as SNMP_ADDRCACHE_SIZE remains</span>
00647 <span class="comment"> * relatively small.</span>
00648 <span class="comment"> *</span>
00649 <span class="comment"> * @retval 0 : updated existing entry</span>
00650 <span class="comment"> * @retval 1 : added new entry</span>
00651 <span class="comment"> */</span>
00652 <span class="keywordtype">int</span>
00653 netsnmp_addrcache_add(<span class="keyword">const</span> <span class="keywordtype">char</span> *addr)
00654 {
00655     <span class="keywordtype">int</span> oldest = -1; <span class="comment">/* Index of the oldest cache entry */</span>
00656     <span class="keywordtype">int</span> unused = -1; <span class=
"comment">/* Index of the first free cache entry */</span>
00657     <span class="keywordtype">int</span> i; <span class="comment">/* Looping variable */</span>
00658     <span class="keywordtype">int</span> rc = -1;
00659     <span class="keyword">struct </span>timeval now; <span class="comment">/* What time is it now? */</span>
00660     <span class="keyword">struct </span>timeval aged; <span class="comment">/* Oldest allowable cache entry */</span>
00661 
00662     <span class="comment">/*</span>
00663 <span class="comment">     * First get the current and oldest allowable timestamps</span>
00664 <span class="comment">     */</span>
00665     gettimeofday(&amp;now, (<span class="keyword">struct</span> timezone*) NULL);
00666     aged.tv_sec = now.tv_sec - SNMP_ADDRCACHE_MAXAGE;
00667     aged.tv_usec = now.tv_usec;
00668 
00669     <span class="comment">/*</span>
00670 <span class="comment">     * Now look for a place to put this thing</span>
00671 <span class="comment">     */</span>
00672     <span class="keywordflow">for</span>(i = 0; i &lt; SNMP_ADDRCACHE_SIZE; i++) {
00673         <span class="keywordflow">if</span> (addrCache[i].status == SNMP_ADDRCACHE_UNUSED) { <span class=
"comment">/* If unused */</span>
00674             <span class="comment">/*</span>
00675 <span class="comment">             * remember this location, in case addr isn't in the cache</span>
00676 <span class="comment">             */</span>
00677             <span class="keywordflow">if</span> (unused &lt; 0)
00678                 unused = i;
00679         }
00680         <span class="keywordflow">else</span> { <span class="comment">/* If used */</span>
00681             <span class="keywordflow">if</span> ((NULL != addr) &amp;&amp; (strcmp(addrCache[i].addr, addr) == 0)) {
00682                 <span class="comment">/*</span>
00683 <span class="comment">                 * found a match</span>
00684 <span class="comment">                 */</span>
00685                 memcpy(&amp;addrCache[i].lastHit, &amp;now, <span class="keyword">sizeof</span>(<span class=
"keyword">struct</span> timeval));
00686                 <span class="keywordflow">if</span> (timercmp(&amp;addrCache[i].lastHit, &amp;aged, &lt;))
00687                     rc = 1; <span class="comment">/* should have expired, so is new */</span>
00688                 <span class="keywordflow">else</span>
00689                     rc = 0; <span class="comment">/* not expired, so is existing entry */</span>
00690                 <span class="keywordflow">break</span>;
00691             }
00692             <span class="keywordflow">else</span> {
00693                 <span class="comment">/*</span>
00694 <span class="comment">                 * Used, but not this address. check if it's stale.</span>
00695 <span class="comment">                 */</span>
00696                 <span class="keywordflow">if</span> (timercmp(&amp;addrCache[i].lastHit, &amp;aged, &lt;)) {
00697                     <span class="comment">/*</span>
00698 <span class="comment">                     * Stale, reuse</span>
00699 <span class="comment">                     */</span>
00700                     <a class="code" href="group__util.html#ga36">SNMP_FREE</a>(addrCache[i].addr);
00701                     addrCache[i].status = SNMP_ADDRCACHE_UNUSED;
00702                     <span class="comment">/*</span>
00703 <span class="comment">                     * remember this location, in case addr isn't in the cache</span>
00704 <span class="comment">                     */</span>
00705                     <span class="keywordflow">if</span> (unused &lt; 0)
00706                         unused = i;
00707                 }
00708                 <span class="keywordflow">else</span> {
00709                     <span class="comment">/*</span>
00710 <span class="comment">                     * Still fresh, but a candidate for LRU replacement</span>
00711 <span class="comment">                     */</span>
00712                     <span class="keywordflow">if</span> (oldest &lt; 0)
00713                         oldest = i;
00714                     <span class="keywordflow">else</span> <span class=
"keywordflow">if</span> (timercmp(&amp;addrCache[i].lastHit,
00715                                       &amp;addrCache[oldest].lastHit, &lt;))
00716                         oldest = i;
00717                 } <span class="comment">/* fresh */</span>
00718             } <span class="comment">/* used, no match */</span>
00719         } <span class="comment">/* used */</span>
00720     } <span class="comment">/* for loop */</span>
00721 
00722     <span class="keywordflow">if</span> ((-1 == rc) &amp;&amp; (NULL != addr)) {
00723         <span class="comment">/*</span>
00724 <span class="comment">         * We didn't find the entry in the cache</span>
00725 <span class="comment">         */</span>
00726         <span class="keywordflow">if</span> (unused &gt;= 0) {
00727             <span class="comment">/*</span>
00728 <span class="comment">             * If we have a slot free anyway, use it</span>
00729 <span class="comment">             */</span>
00730             addrCache[unused].addr = strdup(addr);
00731             addrCache[unused].status = SNMP_ADDRCACHE_USED;
00732             memcpy(&amp;addrCache[unused].lastHit, &amp;now, <span class="keyword">sizeof</span>(<span class=
"keyword">struct</span> timeval));
00733         }
00734         <span class="keywordflow">else</span> { <span class="comment">/* Otherwise, replace oldest entry */</span>
00735             <span class="keywordflow">if</span> (netsnmp_ds_get_boolean(NETSNMP_DS_APPLICATION_ID,
00736                                        NETSNMP_DS_AGENT_VERBOSE))
00737                 <a class="code" href="group__snmp__logging.html#ga39">snmp_log</a>(LOG_INFO, <span class=
"stringliteral">"Purging address from address cache: %s"</span>,
00738                          addrCache[oldest].addr);
00739             
00740             free(addrCache[oldest].addr);
00741             addrCache[oldest].addr = strdup(addr);
00742             memcpy(&amp;addrCache[oldest].lastHit, &amp;now, <span class="keyword">sizeof</span>(<span class=
"keyword">struct</span> timeval));
00743         }
00744         rc = 1;
00745     }
00746     <span class="keywordflow">if</span> ((log_addresses &amp;&amp; (1 == rc)) ||
00747         netsnmp_ds_get_boolean(NETSNMP_DS_APPLICATION_ID,
00748                                NETSNMP_DS_AGENT_VERBOSE)) {
00749         <a class="code" href="group__snmp__logging.html#ga39">snmp_log</a>(LOG_INFO, <span class=
"stringliteral">"Received SNMP packet(s) from %s\n"</span>, addr);
00750      }
00751 
00752     <span class="keywordflow">return</span> rc;
00753 }
00754 
00755 <span class="comment">/*</span>
00756 <span class="comment"> * Age the entries in the address cache.  </span>
00757 <span class="comment"> *</span>
00758 <span class="comment"> * backwards compatability; not used anywhere</span>
00759 <span class="comment"> */</span>
00760 <span class="keywordtype">void</span>
00761 netsnmp_addrcache_age(<span class="keywordtype">void</span>)
00762 {
00763     (void)netsnmp_addrcache_add(NULL);
00764 }
00765 
00766 <span class="comment">/*******************************************************************-o-******</span>
00767 <span class="comment"> * netsnmp_agent_check_packet</span>
00768 <span class="comment"> *</span>
00769 <span class="comment"> * Parameters:</span>
00770 <span class="comment"> *      session, transport, transport_data, transport_data_length</span>
00771 <span class="comment"> *      </span>
00772 <span class="comment"> * Returns:</span>
00773 <span class="comment"> *      1       On success.</span>
00774 <span class="comment"> *      0       On error.</span>
00775 <span class="comment"> *</span>
00776 <span class="comment"> * Handler for all incoming messages (a.k.a. packets) for the agent.  If using</span>
00777 <span class="comment"> * the libwrap utility, log the connection and deny/allow the access. Print</span>
00778 <span class="comment"> * output when appropriate, and increment the incoming counter.</span>
00779 <span class="comment"> *</span>
00780 <span class="comment"> */</span>
00781 
00782 <span class="keywordtype">int</span>
00783 netsnmp_agent_check_packet(<a class="code" href="structsnmp__session.html">netsnmp_session</a> * session,
00784                            netsnmp_transport *transport,
00785                            <span class="keywordtype">void</span> *transport_data, <span class=
"keywordtype">int</span> transport_data_length)
00786 {
00787     <span class="keywordtype">char</span>           *addr_string = NULL;
00788 <span class="preprocessor">#ifdef  USE_LIBWRAP</span>
00789     <span class="keywordtype">char</span> *tcpudpaddr;
00790 <span class="preprocessor">#endif</span>
00791 
00792     <span class="comment">/*</span>
00793 <span class="comment">     * Log the message and/or dump the message.</span>
00794 <span class="comment">     * Optionally cache the network address of the sender.</span>
00795 <span class="comment">     */</span>
00796 
00797     <span class="keywordflow">if</span> (transport != NULL &amp;&amp; transport-&gt;f_fmtaddr != NULL) {
00798         <span class="comment">/*</span>
00799 <span class="comment">         * Okay I do know how to format this address for logging.  </span>
00800 <span class="comment">         */</span>
00801         addr_string = transport-&gt;f_fmtaddr(transport, transport_data,
00802                                            transport_data_length);
00803         <span class="comment">/*</span>
00804 <span class="comment">         * Don't forget to free() it.  </span>
00805 <span class="comment">         */</span>
00806     }
00807 <span class="preprocessor">#ifdef  USE_LIBWRAP</span>
00808     <span class="comment">/* Catch udp,udp6,tcp,tcp6 transports using "[" */</span>
00809     tcpudpaddr = strstr(addr_string, <span class="stringliteral">"["</span>);
00810     <span class="keywordflow">if</span> ( tcpudpaddr != 0 ) {
00811         <span class="keywordtype">char</span> sbuf[64];
00812         <span class="keywordtype">char</span> *xp;
00813         strncpy(sbuf, tcpudpaddr + 1, <span class="keyword">sizeof</span>(sbuf));
00814         sbuf[<span class="keyword">sizeof</span>(sbuf)-1] = <span class="charliteral">'\0'</span>;
00815         xp = strstr(sbuf, <span class="stringliteral">"]"</span>);
00816         <span class="keywordflow">if</span> (xp)
00817             *xp = <span class="charliteral">'\0'</span>;
00818  
00819         <span class="keywordflow">if</span> (hosts_ctl(<span class=
"stringliteral">"snmpd"</span>, STRING_UNKNOWN, sbuf, STRING_UNKNOWN)) {
00820             <a class="code" href="group__snmp__logging.html#ga39">snmp_log</a>(allow_severity, <span class=
"stringliteral">"Connection from %s\n"</span>, addr_string);
00821         } <span class="keywordflow">else</span> {
00822             <a class="code" href="group__snmp__logging.html#ga39">snmp_log</a>(deny_severity, <span class=
"stringliteral">"Connection from %s REFUSED\n"</span>,
00823                      addr_string);
00824             <a class="code" href="group__util.html#ga36">SNMP_FREE</a>(addr_string);
00825             <span class="keywordflow">return</span> 0;
00826         }
00827     } <span class="keywordflow">else</span> {
00828         <span class="keywordflow">if</span> (hosts_ctl(<span class=
"stringliteral">"snmpd"</span>, STRING_UNKNOWN, STRING_UNKNOWN, STRING_UNKNOWN)){
00829             <a class="code" href="group__snmp__logging.html#ga39">snmp_log</a>(allow_severity, <span class=
"stringliteral">"Connection from &lt;UNKNOWN&gt;\n"</span>);
00830             addr_string = strdup(<span class="stringliteral">"&lt;UNKNOWN&gt;"</span>);
00831         } <span class="keywordflow">else</span> {
00832             <a class="code" href="group__snmp__logging.html#ga39">snmp_log</a>(deny_severity, <span class=
"stringliteral">"Connection from &lt;UNKNOWN&gt; REFUSED\n"</span>);
00833             <span class="keywordflow">return</span> 0;
00834         }
00835     }
00836 <span class="preprocessor">#endif                          </span><span class="comment">/*USE_LIBWRAP */</span>
00837 
00838     snmp_increment_statistic(STAT_SNMPINPKTS);
00839 
00840     <span class="keywordflow">if</span> (addr_string != NULL) {
00841         netsnmp_addrcache_add(addr_string);
00842         <a class="code" href="group__util.html#ga36">SNMP_FREE</a>(addr_string);
00843     }
00844     <span class="keywordflow">return</span> 1;
00845 }
00846 
00847 
00848 <span class="keywordtype">int</span>
00849 netsnmp_agent_check_parse(<a class="code" href="structsnmp__session.html">netsnmp_session</a> * session, <a class="code"
href="structsnmp__pdu.html">netsnmp_pdu</a> *pdu,
00850                           <span class="keywordtype">int</span> result)
00851 {
00852     <span class="keywordflow">if</span> (result == 0) {
00853         <span class="keywordflow">if</span> (<a class="code" href=
"group__snmp__logging.html#ga11">snmp_get_do_logging</a>() &amp;&amp;
00854             netsnmp_ds_get_boolean(NETSNMP_DS_APPLICATION_ID, 
00855                                    NETSNMP_DS_AGENT_VERBOSE)) {
00856             <a class="code" href="structvariable__list.html">netsnmp_variable_list</a> *var_ptr;
00857 
00858             <span class="keywordflow">switch</span> (pdu-&gt;<a class="code" href="structsnmp__pdu.html#o1">command</a>) {
00859             <span class="keywordflow">case</span> SNMP_MSG_GET:
00860                 <a class="code" href="group__snmp__logging.html#ga39">snmp_log</a>(LOG_DEBUG, <span class=
"stringliteral">"  GET message\n"</span>);
00861                 <span class="keywordflow">break</span>;
00862             <span class="keywordflow">case</span> SNMP_MSG_GETNEXT:
00863                 <a class="code" href="group__snmp__logging.html#ga39">snmp_log</a>(LOG_DEBUG, <span class=
"stringliteral">"  GETNEXT message\n"</span>);
00864                 <span class="keywordflow">break</span>;
00865             <span class="keywordflow">case</span> SNMP_MSG_RESPONSE:
00866                 <a class="code" href="group__snmp__logging.html#ga39">snmp_log</a>(LOG_DEBUG, <span class=
"stringliteral">"  RESPONSE message\n"</span>);
00867                 <span class="keywordflow">break</span>;
00868             <span class="keywordflow">case</span> SNMP_MSG_SET:
00869                 <a class="code" href="group__snmp__logging.html#ga39">snmp_log</a>(LOG_DEBUG, <span class=
"stringliteral">"  SET message\n"</span>);
00870                 <span class="keywordflow">break</span>;
00871             <span class="keywordflow">case</span> SNMP_MSG_TRAP:
00872                 <a class="code" href="group__snmp__logging.html#ga39">snmp_log</a>(LOG_DEBUG, <span class=
"stringliteral">"  TRAP message\n"</span>);
00873                 <span class="keywordflow">break</span>;
00874             <span class="keywordflow">case</span> SNMP_MSG_GETBULK:
00875                 <a class="code" href="group__snmp__logging.html#ga39">snmp_log</a>(LOG_DEBUG, <span class=
"stringliteral">"  GETBULK message, non-rep=%d, max_rep=%d\n"</span>,
00876                          pdu-&gt;<a class="code" href="structsnmp__pdu.html#o6">errstat</a>, pdu-&gt;<a class="code" href=
"structsnmp__pdu.html#o7">errindex</a>);
00877                 <span class="keywordflow">break</span>;
00878             <span class="keywordflow">case</span> SNMP_MSG_INFORM:
00879                 <a class="code" href="group__snmp__logging.html#ga39">snmp_log</a>(LOG_DEBUG, <span class=
"stringliteral">"  INFORM message\n"</span>);
00880                 <span class="keywordflow">break</span>;
00881             <span class="keywordflow">case</span> SNMP_MSG_TRAP2:
00882                 <a class="code" href="group__snmp__logging.html#ga39">snmp_log</a>(LOG_DEBUG, <span class=
"stringliteral">"  TRAP2 message\n"</span>);
00883                 <span class="keywordflow">break</span>;
00884             <span class="keywordflow">case</span> SNMP_MSG_REPORT:
00885                 <a class="code" href="group__snmp__logging.html#ga39">snmp_log</a>(LOG_DEBUG, <span class=
"stringliteral">"  REPORT message\n"</span>);
00886                 <span class="keywordflow">break</span>;
00887 
00888             <span class="keywordflow">case</span> SNMP_MSG_INTERNAL_SET_RESERVE1:
00889                 <a class="code" href="group__snmp__logging.html#ga39">snmp_log</a>(LOG_DEBUG, <span class=
"stringliteral">"  INTERNAL RESERVE1 message\n"</span>);
00890                 <span class="keywordflow">break</span>;
00891 
00892             <span class="keywordflow">case</span> SNMP_MSG_INTERNAL_SET_RESERVE2:
00893                 <a class="code" href="group__snmp__logging.html#ga39">snmp_log</a>(LOG_DEBUG, <span class=
"stringliteral">"  INTERNAL RESERVE2 message\n"</span>);
00894                 <span class="keywordflow">break</span>;
00895 
00896             <span class="keywordflow">case</span> SNMP_MSG_INTERNAL_SET_ACTION:
00897                 <a class="code" href="group__snmp__logging.html#ga39">snmp_log</a>(LOG_DEBUG, <span class=
"stringliteral">"  INTERNAL ACTION message\n"</span>);
00898                 <span class="keywordflow">break</span>;
00899 
00900             <span class="keywordflow">case</span> SNMP_MSG_INTERNAL_SET_COMMIT:
00901                 <a class="code" href="group__snmp__logging.html#ga39">snmp_log</a>(LOG_DEBUG, <span class=
"stringliteral">"  INTERNAL COMMIT message\n"</span>);
00902                 <span class="keywordflow">break</span>;
00903 
00904             <span class="keywordflow">case</span> SNMP_MSG_INTERNAL_SET_FREE:
00905                 <a class="code" href="group__snmp__logging.html#ga39">snmp_log</a>(LOG_DEBUG, <span class=
"stringliteral">"  INTERNAL FREE message\n"</span>);
00906                 <span class="keywordflow">break</span>;
00907 
00908             <span class="keywordflow">case</span> SNMP_MSG_INTERNAL_SET_UNDO:
00909                 <a class="code" href="group__snmp__logging.html#ga39">snmp_log</a>(LOG_DEBUG, <span class=
"stringliteral">"  INTERNAL UNDO message\n"</span>);
00910                 <span class="keywordflow">break</span>;
00911 
00912             <span class="keywordflow">default</span>:
00913                 <a class="code" href="group__snmp__logging.html#ga39">snmp_log</a>(LOG_DEBUG, <span class=
"stringliteral">"  UNKNOWN message, type=%02X\n"</span>,
00914                          pdu-&gt;<a class="code" href="structsnmp__pdu.html#o1">command</a>);
00915                 snmp_increment_statistic(STAT_SNMPINASNPARSEERRS);
00916                 <span class="keywordflow">return</span> 0;
00917             }
00918 
00919             <span class="keywordflow">for</span> (var_ptr = pdu-&gt;<a class="code" href=
"structsnmp__pdu.html#o17">variables</a>; var_ptr != NULL;
00920                  var_ptr = var_ptr-&gt;<a class="code" href="structvariable__list.html#o0">next_variable</a>) {
00921                 size_t          c_oidlen = 256, c_outlen = 0;
00922                 u_char         *c_oid = (u_char *) malloc(c_oidlen);
00923 
00924                 <span class="keywordflow">if</span> (c_oid) {
00925                     <span class="keywordflow">if</span> (!sprint_realloc_objid
00926                         (&amp;c_oid, &amp;c_oidlen, &amp;c_outlen, 1, var_ptr-&gt;<a class="code" href=
"structvariable__list.html#o1">name</a>,
00927                          var_ptr-&gt;<a class="code" href="structvariable__list.html#o2">name_length</a>)) {
00928                         <a class="code" href="group__snmp__logging.html#ga39">snmp_log</a>(LOG_DEBUG, <span class=
"stringliteral">"    -- %s [TRUNCATED]\n"</span>,
00929                                  c_oid);
00930                     } <span class="keywordflow">else</span> {
00931                         <a class="code" href="group__snmp__logging.html#ga39">snmp_log</a>(LOG_DEBUG, <span class=
"stringliteral">"    -- %s\n"</span>, c_oid);
00932                     }
00933                     <a class="code" href="group__util.html#ga36">SNMP_FREE</a>(c_oid);
00934                 }
00935             }
00936         }
00937         <span class="keywordflow">return</span> 1;
00938     }
00939     <span class="keywordflow">return</span> 0;                   <span class=
"comment">/* XXX: does it matter what the return value</span>
00940 <span class="comment">                                 * is?  Yes: if we return 0, then the PDU is</span>
00941 <span class="comment">                                 * dumped.  */</span>
00942 }
00943 
00944 
00945 <span class="comment">/*</span>
00946 <span class="comment"> * Global access to the primary session structure for this agent.</span>
00947 <span class="comment"> * for Index Allocation use initially. </span>
00948 <span class="comment"> */</span>
00949 
00950 <span class="comment">/*</span>
00951 <span class="comment"> * I don't understand what this is for at the moment.  AFAICS as long as it</span>
00952 <span class="comment"> * gets set and points at a session, that's fine.  ???  </span>
00953 <span class="comment"> */</span>
00954 
00955 <a class="code" href="structsnmp__session.html">netsnmp_session</a> *main_session = NULL;
00956 
00957 
00958 
00959 <span class="comment">/*</span>
00960 <span class="comment"> * Set up an agent session on the given transport.  Return a handle</span>
00961 <span class="comment"> * which may later be used to de-register this transport.  A return</span>
00962 <span class="comment"> * value of -1 indicates an error.  </span>
00963 <span class="comment"> */</span>
00964 
00965 <span class="keywordtype">int</span>
00966 netsnmp_register_agent_nsap(netsnmp_transport *t)
00967 {
00968     <a class="code" href="structsnmp__session.html">netsnmp_session</a> *s, *sp = NULL;
00969     agent_nsap     *a = NULL, *n = NULL, **prevNext = &amp;agent_nsap_list;
00970     <span class="keywordtype">int</span>             handle = 0;
00971     <span class="keywordtype">void</span>           *isp = NULL;
00972 
00973     <span class="keywordflow">if</span> (t == NULL) {
00974         <span class="keywordflow">return</span> -1;
00975     }
00976 
00977     DEBUGMSGTL((<span class="stringliteral">"netsnmp_register_agent_nsap"</span>, <span class=
"stringliteral">"fd %d\n"</span>, t-&gt;sock));
00978 
00979     n = (agent_nsap *) malloc(<span class="keyword">sizeof</span>(agent_nsap));
00980     <span class="keywordflow">if</span> (n == NULL) {
00981         <span class="keywordflow">return</span> -1;
00982     }
00983     s = (<a class="code" href="structsnmp__session.html">netsnmp_session</a> *) malloc(<span class=
"keyword">sizeof</span>(<a class="code" href="structsnmp__session.html">netsnmp_session</a>));
00984     <span class="keywordflow">if</span> (s == NULL) {
00985         <a class="code" href="group__util.html#ga36">SNMP_FREE</a>(n);
00986         <span class="keywordflow">return</span> -1;
00987     }
00988     memset(s, 0, <span class="keyword">sizeof</span>(<a class="code" href="structsnmp__session.html">netsnmp_session</a>));
00989     snmp_sess_init(s);
00990 
00991     <span class="comment">/*</span>
00992 <span class="comment">     * Set up the session appropriately for an agent.  </span>
00993 <span class="comment">     */</span>
00994 
00995     s-&gt;<a class="code" href="structsnmp__session.html#o0">version</a> = SNMP_DEFAULT_VERSION;
00996     s-&gt;<a class="code" href="structsnmp__session.html#o11">callback</a> = handle_snmp_packet;
00997     s-&gt;<a class="code" href="structsnmp__session.html#o10">authenticator</a> = NULL;
00998     s-&gt;<a class="code" href="structsnmp__session.html#o3">flags</a> = netsnmp_ds_get_int(NETSNMP_DS_APPLICATION_ID, 
00999                                   NETSNMP_DS_AGENT_FLAGS);
01000     s-&gt;<a class="code" href="structsnmp__session.html#o20">isAuthoritative</a> = SNMP_SESS_AUTHORITATIVE;
01001 
01002     sp = snmp_add(s, t, netsnmp_agent_check_packet,
01003                   netsnmp_agent_check_parse);
01004     <span class="keywordflow">if</span> (sp == NULL) {
01005         <a class="code" href="group__util.html#ga36">SNMP_FREE</a>(s);
01006         <a class="code" href="group__util.html#ga36">SNMP_FREE</a>(n);
01007         <span class="keywordflow">return</span> -1;
01008     }
01009 
01010     isp = snmp_sess_pointer(sp);
01011     <span class="keywordflow">if</span> (isp == NULL) {          <span class="comment">/*  over-cautious  */</span>
01012         <a class="code" href="group__util.html#ga36">SNMP_FREE</a>(s);
01013         <a class="code" href="group__util.html#ga36">SNMP_FREE</a>(n);
01014         <span class="keywordflow">return</span> -1;
01015     }
01016 
01017     n-&gt;s = isp;
01018     n-&gt;t = t;
01019 
01020     <span class="keywordflow">if</span> (main_session == NULL) {
01021         main_session = snmp_sess_session(isp);
01022     }
01023 
01024     <span class="keywordflow">for</span> (a = agent_nsap_list; a != NULL &amp;&amp; handle + 1 &gt;= a-&gt;handle;
01025          a = a-&gt;next) {
01026         handle = a-&gt;handle;
01027         prevNext = &amp;(a-&gt;next);
01028     }
01029 
01030     <span class="keywordflow">if</span> (handle &lt; INT_MAX) {
01031         n-&gt;handle = handle + 1;
01032         n-&gt;<a class="code" href="structsnmp__session.html#o5">next</a> = a;
01033         *prevNext = n;
01034         <a class="code" href="group__util.html#ga36">SNMP_FREE</a>(s);
01035         <span class="keywordflow">return</span> n-&gt;handle;
01036     } <span class="keywordflow">else</span> {
01037         <a class="code" href="group__util.html#ga36">SNMP_FREE</a>(s);
01038         <a class="code" href="group__util.html#ga36">SNMP_FREE</a>(n);
01039         <span class="keywordflow">return</span> -1;
01040     }
01041 }
01042 
01043 <span class="keywordtype">void</span>
01044 netsnmp_deregister_agent_nsap(<span class="keywordtype">int</span> handle)
01045 {
01046     agent_nsap     *a = NULL, **prevNext = &amp;agent_nsap_list;
01047     <span class="keywordtype">int</span>             main_session_deregistered = 0;
01048 
01049     DEBUGMSGTL((<span class="stringliteral">"netsnmp_deregister_agent_nsap"</span>, <span class=
"stringliteral">"handle %d\n"</span>, handle));
01050 
01051     <span class=
"keywordflow">for</span> (a = agent_nsap_list; a != NULL &amp;&amp; a-&gt;handle &lt; handle; a = a-&gt;next) {
01052         prevNext = &amp;(a-&gt;next);
01053     }
01054 
01055     <span class="keywordflow">if</span> (a != NULL &amp;&amp; a-&gt;handle == handle) {
01056         *prevNext = a-&gt;<a class="code" href="structsnmp__session.html#o5">next</a>;
01057         <span class="keywordflow">if</span> (main_session == snmp_sess_session(a-&gt;s)) {
01058             main_session_deregistered = 1;
01059         }
01060         snmp_close(snmp_sess_session(a-&gt;s));
01061         <span class="comment">/*</span>
01062 <span class="comment">         * The above free()s the transport and session pointers.  </span>
01063 <span class="comment">         */</span>
01064         <a class="code" href="group__util.html#ga36">SNMP_FREE</a>(a);
01065     }
01066 
01067     <span class="comment">/*</span>
01068 <span class="comment">     * If we've deregistered the session that main_session used to point to,</span>
01069 <span class="comment">     * then make it point to another one, or in the last resort, make it equal</span>
01070 <span class="comment">     * to NULL.  Basically this shouldn't ever happen in normal operation</span>
01071 <span class="comment">     * because main_session starts off pointing at the first session added by</span>
01072 <span class="comment">     * init_master_agent(), which then discards the handle.  </span>
01073 <span class="comment">     */</span>
01074 
01075     <span class="keywordflow">if</span> (main_session_deregistered) {
01076         <span class="keywordflow">if</span> (agent_nsap_list != NULL) {
01077             DEBUGMSGTL((<span class="stringliteral">"snmp_agent"</span>,
01078                         <span class="stringliteral">"WARNING: main_session ptr changed from %p to %p\n"</span>,
01079                         main_session, snmp_sess_session(agent_nsap_list-&gt;s)));
01080             main_session = snmp_sess_session(agent_nsap_list-&gt;s);
01081         } <span class="keywordflow">else</span> {
01082             DEBUGMSGTL((<span class="stringliteral">"snmp_agent"</span>,
01083                         <span class="stringliteral">"WARNING: main_session ptr changed from %p to NULL\n"</span>,
01084                         main_session));
01085             main_session = NULL;
01086         }
01087     }
01088 }
01089 
01090 
01091 
01092 <span class="comment">/*</span>
01093 <span class="comment"> * </span>
01094 <span class="comment"> * This function has been modified to use the experimental</span>
01095 <span class="comment"> * netsnmp_register_agent_nsap interface.  The major responsibility of this</span>
01096 <span class="comment"> * function now is to interpret a string specified to the agent (via -p on the</span>
01097 <span class="comment"> * command line, or from a configuration file) as a list of agent NSAPs on</span>
01098 <span class="comment"> * which to listen for SNMP packets.  Typically, when you add a new transport</span>
01099 <span class="comment"> * domain "foo", you add code here such that if the "foo" code is compiled</span>
01100 <span class="comment"> * into the agent (SNMP_TRANSPORT_FOO_DOMAIN is defined), then a token of the</span>
01101 <span class="comment"> * form "foo:bletch-3a0054ef%wob&amp;wob" gets turned into the appropriate</span>
01102 <span class="comment"> * transport descriptor.  netsnmp_register_agent_nsap is then called with that</span>
01103 <span class="comment"> * transport descriptor and sets up a listening agent session on it.</span>
01104 <span class="comment"> * </span>
01105 <span class="comment"> * Everything then works much as normal: the agent runs in an infinite loop</span>
01106 <span class="comment"> * (in the snmpd.c/receive()routine), which calls snmp_read() when a request</span>
01107 <span class="comment"> * is readable on any of the given transports.  This routine then traverses</span>
01108 <span class="comment"> * the library 'Sessions' list to identify the relevant session and eventually</span>
01109 <span class="comment"> * invokes '_sess_read'.  This then processes the incoming packet, calling the</span>
01110 <span class="comment"> * pre_parse, parse, post_parse and callback routines in turn.</span>
01111 <span class="comment"> * </span>
01112 <span class="comment"> * JBPN 20001117</span>
01113 <span class="comment"> */</span>
01114 
01115 <span class="keywordtype">int</span>
01116 init_master_agent(<span class="keywordtype">void</span>)
01117 {
01118     netsnmp_transport *transport;
01119     <span class="keywordtype">char</span>           *cptr;
01120     <span class="keywordtype">char</span>            buf[SPRINT_MAX_LEN];
01121     <span class="keywordtype">char</span>           *st;
01122 
01123     <span class="comment">/* default to a default cache size */</span>
01124     <a class="code" href="group__agent__registry.html#ga21">netsnmp_set_lookup_cache_size</a>(-1);
01125 
01126     <span class="keywordflow">if</span> (netsnmp_ds_get_boolean(NETSNMP_DS_APPLICATION_ID, 
01127                                NETSNMP_DS_AGENT_ROLE) != MASTER_AGENT) {
01128         DEBUGMSGTL((<span class="stringliteral">"snmp_agent"</span>,
01129                     <span class="stringliteral">"init_master_agent; not master agent\n"</span>));
01130         <span class="keywordflow">return</span> 0;               <span class=
"comment">/*  No error if ! MASTER_AGENT  */</span>
01131     }
01132 <span class="preprocessor">#ifdef USING_AGENTX_MASTER_MODULE</span>
01133     <span class="keywordflow">if</span> (netsnmp_ds_get_boolean(NETSNMP_DS_APPLICATION_ID, 
01134                                NETSNMP_DS_AGENT_AGENTX_MASTER) == 1)
01135         real_init_master();
01136 <span class="preprocessor">#endif</span>
01137 <span class="preprocessor">#ifdef USING_SMUX_MODULE</span>
01138     <span class="keywordflow">if</span>(should_init(<span class="stringliteral">"smux"</span>))
01139     real_init_smux();
01140 <span class="preprocessor">#endif</span>
01141 
01142     <span class="comment">/*</span>
01143 <span class="comment">     * Have specific agent ports been specified?  </span>
01144 <span class="comment">     */</span>
01145     cptr = netsnmp_ds_get_string(NETSNMP_DS_APPLICATION_ID, 
01146                                  NETSNMP_DS_AGENT_PORTS);
01147 
01148     <span class="keywordflow">if</span> (cptr) {
01149         snprintf(buf, <span class="keyword">sizeof</span>(buf), <span class="stringliteral">"%s"</span>, cptr);
01150         buf[ <span class="keyword">sizeof</span>(buf)-1 ] = 0;
01151     } <span class="keywordflow">else</span> {
01152         <span class="comment">/*</span>
01153 <span class="comment">         * No, so just specify the default port.  </span>
01154 <span class="comment">         */</span>
01155         <span class=
"keywordflow">if</span> (netsnmp_ds_get_int(NETSNMP_DS_APPLICATION_ID, NETSNMP_DS_AGENT_FLAGS) &amp; SNMP_FLAGS_STREAM_SOCKET) {
01156             sprintf(buf, <span class="stringliteral">"tcp:%d"</span>, SNMP_PORT);
01157         } <span class="keywordflow">else</span> {
01158             sprintf(buf, <span class="stringliteral">"udp:%d"</span>, SNMP_PORT);
01159         }
01160     }
01161 
01162     DEBUGMSGTL((<span class="stringliteral">"snmp_agent"</span>, <span class=
"stringliteral">"final port spec: %s\n"</span>, buf));
01163     cptr = strtok_r(buf, <span class="stringliteral">","</span>, &amp;st);
01164     <span class="keywordflow">while</span> (cptr) {
01165         <span class="comment">/*</span>
01166 <span class="comment">         * Specification format: </span>
01167 <span class="comment">         * </span>
01168 <span class="comment">         * NONE:                      (a pseudo-transport)</span>
01169 <span class="comment">         * UDP:[address:]port        (also default if no transport is specified)</span>
01170 <span class="comment">         * TCP:[address:]port         (if supported)</span>
01171 <span class="comment">         * Unix:pathname              (if supported)</span>
01172 <span class="comment">         * AAL5PVC:itf.vpi.vci        (if supported)</span>
01173 <span class="comment">         * IPX:[network]:node[/port] (if supported)</span>
01174 <span class="comment">         * </span>
01175 <span class="comment">         */</span>
01176 
01177         DEBUGMSGTL((<span class="stringliteral">"snmp_agent"</span>, <span class=
"stringliteral">"installing master agent on port %s\n"</span>,
01178                     cptr));
01179 
01180         <span class="keywordflow">if</span> (!cptr || !(*cptr)) {
01181             <a class="code" href="group__snmp__logging.html#ga39">snmp_log</a>(LOG_ERR, <span class=
"stringliteral">"improper port specification\n"</span>);
01182             <span class="keywordflow">return</span> 1;
01183         }
01184 
01185         <span class="keywordflow">if</span> (strncasecmp(cptr, <span class="stringliteral">"none"</span>, 4) == 0) {
01186             DEBUGMSGTL((<span class="stringliteral">"snmp_agent"</span>,
01187                         <span class="stringliteral">"init_master_agent; pseudo-transport \"none\" requested\n"</span>));
01188             <span class="keywordflow">return</span> 0;
01189         }
01190         transport = netsnmp_tdomain_transport(cptr, 1, <span class="stringliteral">"udp"</span>);
01191 
01192         <span class="keywordflow">if</span> (transport == NULL) {
01193             <a class="code" href="group__snmp__logging.html#ga39">snmp_log</a>(LOG_ERR, <span class=
"stringliteral">"Error opening specified endpoint \"%s\"\n"</span>,
01194                      cptr);
01195             <span class="keywordflow">return</span> 1;
01196         }
01197 
01198         <span class="keywordflow">if</span> (netsnmp_register_agent_nsap(transport) == 0) {
01199             <a class="code" href="group__snmp__logging.html#ga39">snmp_log</a>(LOG_ERR,
01200                      <span class="stringliteral">"Error registering specified transport \"%s\" as an agent NSAP\n"</span>,
01201                      cptr);
01202             <span class="keywordflow">return</span> 1;
01203         } <span class="keywordflow">else</span> {
01204             DEBUGMSGTL((<span class="stringliteral">"snmp_agent"</span>,
01205                         <span class="stringliteral">"init_master_agent; \"%s\" registered as an agent NSAP\n"</span>,
01206                         cptr));
01207         }
01208 
01209         <span class="comment">/*</span>
01210 <span class="comment">         * Next transport please...  </span>
01211 <span class="comment">         */</span>
01212         cptr = strtok_r(NULL, <span class="stringliteral">","</span>, &amp;st);
01213     }
01214 
01215     <span class="keywordflow">return</span> 0;
01216 }
01217 
01218 <span class="keywordtype">void</span>
01219 clear_nsap_list(<span class="keywordtype">void</span>)
01220 {
01221     DEBUGMSGTL((<span class="stringliteral">"clear_nsap_list"</span>, <span class=
"stringliteral">"clear the nsap list\n"</span>));
01222 
01223     <span class="keywordflow">while</span> (agent_nsap_list != NULL)
01224         netsnmp_deregister_agent_nsap(agent_nsap_list-&gt;handle);
01225 }
01226 
01227 <span class="keywordtype">void</span>
01228 shutdown_master_agent(<span class="keywordtype">void</span>)
01229 {
01230     clear_nsap_list();
01231 }
01232 
01233 
01234 netsnmp_agent_session *
01235 init_agent_snmp_session(<a class="code" href="structsnmp__session.html">netsnmp_session</a> * session, <a class="code"
href="structsnmp__pdu.html">netsnmp_pdu</a> *pdu)
01236 {
01237     netsnmp_agent_session *asp = (netsnmp_agent_session *)
01238         calloc(1, <span class="keyword">sizeof</span>(netsnmp_agent_session));
01239 
01240     <span class="keywordflow">if</span> (asp == NULL) {
01241         <span class="keywordflow">return</span> NULL;
01242     }
01243 
01244     DEBUGMSGTL((<span class="stringliteral">"snmp_agent"</span>,<span class=
"stringliteral">"agent_sesion %08p created\n"</span>, asp));
01245     asp-&gt;session = session;
01246     asp-&gt;pdu = snmp_clone_pdu(pdu);
01247     asp-&gt;orig_pdu = snmp_clone_pdu(pdu);
01248     asp-&gt;rw = READ;
01249     asp-&gt;exact = TRUE;
01250     asp-&gt;next = NULL;
01251     asp-&gt;mode = RESERVE1;
01252     asp-&gt;status = SNMP_ERR_NOERROR;
01253     asp-&gt;index = 0;
01254     asp-&gt;oldmode = 0;
01255     asp-&gt;treecache_num = -1;
01256     asp-&gt;treecache_len = 0;
01257     asp-&gt;reqinfo = <a class="code" href="group__util.html#ga39">SNMP_MALLOC_TYPEDEF</a>(<a class="code" href=
"structnetsnmp__agent__request__info__s.html">netsnmp_agent_request_info</a>);
01258     DEBUGMSGTL((<span class="stringliteral">"verbose:asp"</span>, <span class=
"stringliteral">"asp %p reqinfo %p created\n"</span>,
01259                 asp, asp-&gt;reqinfo));
01260 
01261     <span class="keywordflow">return</span> asp;
01262 }
01263 
01264 <span class="keywordtype">void</span>
01265 free_agent_snmp_session(netsnmp_agent_session *asp)
01266 {
01267     <span class="keywordflow">if</span> (!asp)
01268         <span class="keywordflow">return</span>;
01269 
01270     DEBUGMSGTL((<span class="stringliteral">"snmp_agent"</span>,<span class=
"stringliteral">"agent_session %08p released\n"</span>, asp));
01271 
01272     netsnmp_remove_from_delegated(asp);
01273     
01274     DEBUGMSGTL((<span class="stringliteral">"verbose:asp"</span>, <span class=
"stringliteral">"asp %p reqinfo %p freed\n"</span>,
01275                 asp, asp-&gt;reqinfo));
01276     <span class="keywordflow">if</span> (asp-&gt;orig_pdu)
01277         snmp_free_pdu(asp-&gt;orig_pdu);
01278     <span class="keywordflow">if</span> (asp-&gt;pdu)
01279         snmp_free_pdu(asp-&gt;pdu);
01280     <span class="keywordflow">if</span> (asp-&gt;reqinfo)
01281         netsnmp_free_agent_request_info(asp-&gt;reqinfo);
01282     <span class="keywordflow">if</span> (asp-&gt;treecache) {
01283         <a class="code" href="group__util.html#ga36">SNMP_FREE</a>(asp-&gt;treecache);
01284     }
01285     <span class="keywordflow">if</span> (asp-&gt;bulkcache) {
01286         <a class="code" href="group__util.html#ga36">SNMP_FREE</a>(asp-&gt;bulkcache);
01287     }
01288     <span class="keywordflow">if</span> (asp-&gt;requests) {
01289         <span class="keywordtype">int</span>             i;
01290         <span class="keywordflow">for</span> (i = 0; i &lt; asp-&gt;vbcount; i++) {
01291             <a class="code" href="group__handler.html#ga31">netsnmp_free_request_data_sets</a>(&amp;asp-&gt;requests[i]);
01292         }
01293         <a class="code" href="group__util.html#ga36">SNMP_FREE</a>(asp-&gt;requests);
01294     }
01295     <span class="keywordflow">if</span> (asp-&gt;cache_store) {
01296         netsnmp_free_cachemap(asp-&gt;cache_store);
01297         asp-&gt;cache_store = NULL;
01298     }
01299     <a class="code" href="group__util.html#ga36">SNMP_FREE</a>(asp);
01300 }
01301 
01302 <span class="keywordtype">int</span>
01303 netsnmp_check_for_delegated(netsnmp_agent_session *asp)
01304 {
01305     <span class="keywordtype">int</span>             i;
01306     <a class="code" href="structnetsnmp__request__info__s.html">netsnmp_request_info</a> *request;
01307 
01308     <span class="keywordflow">if</span> (NULL == asp-&gt;treecache)
01309         <span class="keywordflow">return</span> 0;
01310     
01311     <span class="keywordflow">for</span> (i = 0; i &lt;= asp-&gt;treecache_num; i++) {
01312         <span class="keywordflow">for</span> (request = asp-&gt;treecache[i].requests_begin; request;
01313              request = request-&gt;<a class="code" href="structnetsnmp__request__info__s.html#o13">next</a>) {
01314             <span class="keywordflow">if</span> (request-&gt;<a class="code" href=
"structnetsnmp__request__info__s.html#o5">delegated</a>)
01315                 <span class="keywordflow">return</span> 1;
01316         }
01317     }
01318     <span class="keywordflow">return</span> 0;
01319 }
01320 
01321 <span class="keywordtype">int</span>
01322 netsnmp_check_delegated_chain_for(netsnmp_agent_session *asp)
01323 {
01324     netsnmp_agent_session *asptmp;
01325     <span class="keywordflow">for</span> (asptmp = agent_delegated_list; asptmp; asptmp = asptmp-&gt;next) {
01326         <span class="keywordflow">if</span> (asptmp == asp)
01327             <span class="keywordflow">return</span> 1;
01328     }
01329     <span class="keywordflow">return</span> 0;
01330 }
01331 
01332 <span class="keywordtype">int</span>
01333 netsnmp_check_for_delegated_and_add(netsnmp_agent_session *asp)
01334 {
01335     <span class="keywordflow">if</span> (netsnmp_check_for_delegated(asp)) {
01336         <span class="keywordflow">if</span> (!netsnmp_check_delegated_chain_for(asp)) {
01337             <span class="comment">/*</span>
01338 <span class="comment">             * add to delegated request chain </span>
01339 <span class="comment">             */</span>
01340             asp-&gt;next = agent_delegated_list;
01341             agent_delegated_list = asp;
01342             DEBUGMSGTL((<span class="stringliteral">"snmp_agent"</span>, <span class=
"stringliteral">"delegate session == %08p\n"</span>, asp));
01343         }
01344         <span class="keywordflow">return</span> 1;
01345     }
01346     <span class="keywordflow">return</span> 0;
01347 }
01348 
01349 <span class="keywordtype">int</span>
01350 netsnmp_remove_from_delegated(netsnmp_agent_session *asp)
01351 {
01352     netsnmp_agent_session *curr, *prev = NULL;
01353     
01354     <span class="keywordflow">for</span> (curr = agent_delegated_list; curr; prev = curr, curr = curr-&gt;next) {
01355         <span class="comment">/*</span>
01356 <span class="comment">         * is this us?</span>
01357 <span class="comment">         */</span>
01358         <span class="keywordflow">if</span> (curr != asp)
01359             <span class="keywordflow">continue</span>;
01360         
01361         <span class="comment">/*</span>
01362 <span class="comment">         * remove from queue </span>
01363 <span class="comment">         */</span>
01364         <span class="keywordflow">if</span> (prev != NULL)
01365             prev-&gt;next = asp-&gt;next;
01366         <span class="keywordflow">else</span>
01367             agent_delegated_list = asp-&gt;next;
01368 
01369         DEBUGMSGTL((<span class="stringliteral">"snmp_agent"</span>, <span class=
"stringliteral">"remove delegated session == %08p\n"</span>, asp));
01370 
01371         <span class="keywordflow">return</span> 1;
01372     }
01373 
01374     <span class="keywordflow">return</span> 0;
01375 }
01376 
01377 <span class="comment">/*</span>
01378 <span class="comment"> * netsnmp_remove_delegated_requests_for_session</span>
01379 <span class="comment"> *</span>
01380 <span class="comment"> * called when a session is being closed. Check all delegated requests to</span>
01381 <span class="comment"> * see if the are waiting on this session, and if set, set the status for</span>
01382 <span class="comment"> * that request to GENERR.</span>
01383 <span class="comment"> */</span>
01384 <span class="keywordtype">int</span>
01385 netsnmp_remove_delegated_requests_for_session(<a class="code" href="structsnmp__session.html">netsnmp_session</a> *sess)
01386 {
01387     netsnmp_agent_session *asp;
01388     <span class="keywordtype">int</span> count = 0;
01389     
01390     <span class="keywordflow">for</span> (asp = agent_delegated_list; asp; asp = asp-&gt;next) {
01391         <span class="comment">/*</span>
01392 <span class="comment">         * check each request</span>
01393 <span class="comment">         */</span>
01394         <a class="code" href="structnetsnmp__request__info__s.html">netsnmp_request_info</a> *request;
01395         <span class="keywordflow">for</span>(request = asp-&gt;requests; request; request = request-&gt;<a class="code"
href="structnetsnmp__request__info__s.html#o13">next</a>) {
01396             <span class="comment">/*</span>
01397 <span class="comment">             * check session</span>
01398 <span class="comment">             */</span>
01399             netsnmp_assert(NULL!=request-&gt;<a class="code" href="structnetsnmp__request__info__s.html#o15">subtree</a>);
01400             <span class="keywordflow">if</span>(request-&gt;<a class="code" href=
"structnetsnmp__request__info__s.html#o15">subtree</a>-&gt;session != sess)
01401                 <span class="keywordflow">continue</span>;
01402 
01403             <span class="comment">/*</span>
01404 <span class="comment">             * matched! mark request as done</span>
01405 <span class="comment">             */</span>
01406             <a class="code" href="group__snmp__agent.html#ga68">netsnmp_request_set_error</a>(request, SNMP_ERR_GENERR);
01407             ++count;
01408         }
01409     }
01410 
01411     <span class="comment">/*</span>
01412 <span class="comment">     * if we found any, that request may be finished now</span>
01413 <span class="comment">     */</span>
01414     <span class="keywordflow">if</span>(count) {
01415         DEBUGMSGTL((<span class="stringliteral">"snmp_agent"</span>, <span class=
"stringliteral">"removed %d delegated request(s) for session "</span>
01416                     <span class="stringliteral">"%08p\n"</span>, count, sess));
01417         netsnmp_check_outstanding_agent_requests();
01418     }
01419     
01420     <span class="keywordflow">return</span> count;
01421 }
01422 
01423 <span class="keywordtype">int</span>
01424 netsnmp_check_queued_chain_for(netsnmp_agent_session *asp)
01425 {
01426     netsnmp_agent_session *asptmp;
01427     <span class="keywordflow">for</span> (asptmp = netsnmp_agent_queued_list; asptmp; asptmp = asptmp-&gt;next) {
01428         <span class="keywordflow">if</span> (asptmp == asp)
01429             <span class="keywordflow">return</span> 1;
01430     }
01431     <span class="keywordflow">return</span> 0;
01432 }
01433 
01434 <span class="keywordtype">int</span>
01435 netsnmp_add_queued(netsnmp_agent_session *asp)
01436 {
01437     netsnmp_agent_session *asp_tmp;
01438 
01439     <span class="comment">/*</span>
01440 <span class="comment">     * first item?</span>
01441 <span class="comment">     */</span>
01442     <span class="keywordflow">if</span> (NULL == netsnmp_agent_queued_list) {
01443         netsnmp_agent_queued_list = asp;
01444         <span class="keywordflow">return</span> 1;
01445     }
01446 
01447 
01448     <span class="comment">/*</span>
01449 <span class="comment">     * add to end of queued request chain </span>
01450 <span class="comment">     */</span>
01451     asp_tmp = netsnmp_agent_queued_list;
01452     <span class="keywordflow">for</span> (; asp_tmp; asp_tmp = asp_tmp-&gt;next) {
01453         <span class="comment">/*</span>
01454 <span class="comment">         * already in queue?</span>
01455 <span class="comment">         */</span>
01456         <span class="keywordflow">if</span> (asp_tmp == asp)
01457             <span class="keywordflow">break</span>;
01458 
01459         <span class="comment">/*</span>
01460 <span class="comment">         * end of queue?</span>
01461 <span class="comment">         */</span>
01462         <span class="keywordflow">if</span> (NULL == asp_tmp-&gt;next)
01463             asp_tmp-&gt;next = asp;
01464     }
01465     <span class="keywordflow">return</span> 1;
01466 }
01467 
01468 
01469 <span class="keywordtype">int</span>
<a name="l01470" id="l01470"></a><a class="code" href="group__snmp__agent.html#ga18">01470</a> <a class="code" href=
"group__snmp__agent.html#ga18">netsnmp_wrap_up_request</a>(netsnmp_agent_session *asp, <span class=
"keywordtype">int</span> status)
01471 {
01472     <a class="code" href="structvariable__list.html">netsnmp_variable_list</a> *var_ptr;
01473     <span class="keywordtype">int</span>             i;
01474 
01475     <span class="comment">/*</span>
01476 <span class="comment">     * if this request was a set, clear the global now that we are</span>
01477 <span class="comment">     * done.</span>
01478 <span class="comment">     */</span>
01479     <span class="keywordflow">if</span> (asp == netsnmp_processing_set) {
01480         DEBUGMSGTL((<span class="stringliteral">"snmp_agent"</span>, <span class=
"stringliteral">"SET request complete, asp = %08p\n"</span>,
01481                     asp));
01482         netsnmp_processing_set = NULL;
01483     }
01484 
01485     <span class="keywordflow">if</span> (asp-&gt;pdu) {
01486         <span class="comment">/*</span>
01487 <span class="comment">         * If we've got an error status, then this needs to be</span>
01488 <span class="comment">         *  passed back up to the higher levels....</span>
01489 <span class="comment">         */</span>
01490         <span class="keywordflow">if</span> ( status != 0  &amp;&amp; asp-&gt;status == 0 )
01491             asp-&gt;status = status;
01492 
01493         <span class="keywordflow">switch</span> (asp-&gt;pdu-&gt;command) {
01494             <span class="keywordflow">case</span> SNMP_MSG_INTERNAL_SET_BEGIN:
01495             <span class="keywordflow">case</span> SNMP_MSG_INTERNAL_SET_RESERVE1:
01496             <span class="keywordflow">case</span> SNMP_MSG_INTERNAL_SET_RESERVE2:
01497             <span class="keywordflow">case</span> SNMP_MSG_INTERNAL_SET_ACTION:
01498                 <span class="comment">/*</span>
01499 <span class="comment">                 * some stuff needs to be saved in special subagent cases </span>
01500 <span class="comment">                 */</span>
01501                 save_set_cache(asp);
01502                 <span class="keywordflow">break</span>;
01503 
01504             <span class="keywordflow">case</span> SNMP_MSG_GETBULK:
01505                 <span class="comment">/*</span>
01506 <span class="comment">                 * for a GETBULK response we need to rearrange the varbinds </span>
01507 <span class="comment">                 */</span>
01508                 _reorder_getbulk(asp);
01509                 <span class="keywordflow">break</span>;
01510         }
01511 
01512         <span class="comment">/*</span>
01513 <span class="comment">         * May need to "dumb down" a SET error status for a</span>
01514 <span class="comment">         * v1 query.  See RFC2576 - section 4.3</span>
01515 <span class="comment">         */</span>
01516 <span class="preprocessor">#ifndef DISABLE_SNMPV1</span>
01517         <span class="keywordflow">if</span> ((asp-&gt;pdu-&gt;command == SNMP_MSG_SET) &amp;&amp;
01518             (asp-&gt;pdu-&gt;version == SNMP_VERSION_1)) {
01519             <span class="keywordflow">switch</span> (asp-&gt;status) {
01520                 <span class="keywordflow">case</span> SNMP_ERR_WRONGVALUE:
01521                 <span class="keywordflow">case</span> SNMP_ERR_WRONGENCODING:
01522                 <span class="keywordflow">case</span> SNMP_ERR_WRONGTYPE:
01523                 <span class="keywordflow">case</span> SNMP_ERR_WRONGLENGTH:
01524                 <span class="keywordflow">case</span> SNMP_ERR_INCONSISTENTVALUE:
01525                     status = SNMP_ERR_BADVALUE;
01526                     asp-&gt;status = SNMP_ERR_BADVALUE;
01527                     <span class="keywordflow">break</span>;
01528                 <span class="keywordflow">case</span> SNMP_ERR_NOACCESS:
01529                 <span class="keywordflow">case</span> SNMP_ERR_NOTWRITABLE:
01530                 <span class="keywordflow">case</span> SNMP_ERR_NOCREATION:
01531                 <span class="keywordflow">case</span> SNMP_ERR_INCONSISTENTNAME:
01532                 <span class="keywordflow">case</span> SNMP_ERR_AUTHORIZATIONERROR:
01533                     status = SNMP_ERR_NOSUCHNAME;
01534                     asp-&gt;status = SNMP_ERR_NOSUCHNAME;
01535                     <span class="keywordflow">break</span>;
01536                 <span class="keywordflow">case</span> SNMP_ERR_RESOURCEUNAVAILABLE:
01537                 <span class="keywordflow">case</span> SNMP_ERR_COMMITFAILED:
01538                 <span class="keywordflow">case</span> SNMP_ERR_UNDOFAILED:
01539                     status = SNMP_ERR_GENERR;
01540                     asp-&gt;status = SNMP_ERR_GENERR;
01541                     <span class="keywordflow">break</span>;
01542             }
01543         }
01544         <span class="comment">/*</span>
01545 <span class="comment">         * Similarly we may need to "dumb down" v2 exception</span>
01546 <span class="comment">         *  types to throw an error for a v1 query.</span>
01547 <span class="comment">         *  See RFC2576 - section 4.1.2.3</span>
01548 <span class="comment">         */</span>
01549         <span class="keywordflow">if</span> ((asp-&gt;pdu-&gt;command != SNMP_MSG_SET) &amp;&amp;
01550             (asp-&gt;pdu-&gt;version == SNMP_VERSION_1)) {
01551             <span class="keywordflow">for</span> (var_ptr = asp-&gt;pdu-&gt;variables, i = 1;
01552                  var_ptr != NULL; var_ptr = var_ptr-&gt;<a class="code" href=
"structvariable__list.html#o0">next_variable</a>, i++) {
01553                 <span class="keywordflow">switch</span> (var_ptr-&gt;<a class="code" href=
"structvariable__list.html#o3">type</a>) {
01554                     <span class="keywordflow">case</span> SNMP_NOSUCHOBJECT:
01555                     <span class="keywordflow">case</span> SNMP_NOSUCHINSTANCE:
01556                     <span class="keywordflow">case</span> SNMP_ENDOFMIBVIEW:
01557                     <span class="keywordflow">case</span> ASN_COUNTER64:
01558                         status = SNMP_ERR_NOSUCHNAME;
01559                         asp-&gt;status = SNMP_ERR_NOSUCHNAME;
01560                         asp-&gt;index = i;
01561                         <span class="keywordflow">break</span>;
01562                 }
01563             }
01564         }
01565 <span class="preprocessor">#endif </span><span class="comment">/* snmpv1 support */</span>
01566     } 
01568     <span class="comment">/*</span>
01569 <span class="comment">     * Update the snmp error-count statistics</span>
01570 <span class="comment">     *   XXX - should we include the V2 errors in this or not?</span>
01571 <span class="comment">     */</span>
01572 <span class="preprocessor">#define INCLUDE_V2ERRORS_IN_V1STATS</span>
01573 
01574     <span class="keywordflow">switch</span> (status) {
01575 <span class="preprocessor">#ifdef INCLUDE_V2ERRORS_IN_V1STATS</span>
01576     <span class="keywordflow">case</span> SNMP_ERR_WRONGVALUE:
01577     <span class="keywordflow">case</span> SNMP_ERR_WRONGENCODING:
01578     <span class="keywordflow">case</span> SNMP_ERR_WRONGTYPE:
01579     <span class="keywordflow">case</span> SNMP_ERR_WRONGLENGTH:
01580     <span class="keywordflow">case</span> SNMP_ERR_INCONSISTENTVALUE:
01581 <span class="preprocessor">#endif</span>
01582     <span class="keywordflow">case</span> SNMP_ERR_BADVALUE:
01583         snmp_increment_statistic(STAT_SNMPOUTBADVALUES);
01584         <span class="keywordflow">break</span>;
01585 <span class="preprocessor">#ifdef INCLUDE_V2ERRORS_IN_V1STATS</span>
01586     <span class="keywordflow">case</span> SNMP_ERR_NOACCESS:
01587     <span class="keywordflow">case</span> SNMP_ERR_NOTWRITABLE:
01588     <span class="keywordflow">case</span> SNMP_ERR_NOCREATION:
01589     <span class="keywordflow">case</span> SNMP_ERR_INCONSISTENTNAME:
01590     <span class="keywordflow">case</span> SNMP_ERR_AUTHORIZATIONERROR:
01591 <span class="preprocessor">#endif</span>
01592     <span class="keywordflow">case</span> SNMP_ERR_NOSUCHNAME:
01593         snmp_increment_statistic(STAT_SNMPOUTNOSUCHNAMES);
01594         <span class="keywordflow">break</span>;
01595 <span class="preprocessor">#ifdef INCLUDE_V2ERRORS_IN_V1STATS</span>
01596     <span class="keywordflow">case</span> SNMP_ERR_RESOURCEUNAVAILABLE:
01597     <span class="keywordflow">case</span> SNMP_ERR_COMMITFAILED:
01598     <span class="keywordflow">case</span> SNMP_ERR_UNDOFAILED:
01599 <span class="preprocessor">#endif</span>
01600     <span class="keywordflow">case</span> SNMP_ERR_GENERR:
01601         snmp_increment_statistic(STAT_SNMPOUTGENERRS);
01602         <span class="keywordflow">break</span>;
01603 
01604     <span class="keywordflow">case</span> SNMP_ERR_TOOBIG:
01605         snmp_increment_statistic(STAT_SNMPOUTTOOBIGS);
01606         <span class="keywordflow">break</span>;
01607     }
01608 
01609     <span class="keywordflow">if</span> ((status == SNMP_ERR_NOERROR) &amp;&amp; (asp-&gt;pdu)) {
01610         snmp_increment_statistic_by((asp-&gt;pdu-&gt;command == SNMP_MSG_SET ?
01611                                      STAT_SNMPINTOTALSETVARS :
01612                                      STAT_SNMPINTOTALREQVARS),
01613                                     count_varbinds(asp-&gt;pdu-&gt;variables));
01614     } <span class="keywordflow">else</span> {
01615         <span class="comment">/*</span>
01616 <span class="comment">         * Use a copy of the original request</span>
01617 <span class="comment">         *   to report failures.</span>
01618 <span class="comment">         */</span>
01619         snmp_free_pdu(asp-&gt;pdu);
01620         asp-&gt;pdu = asp-&gt;orig_pdu;
01621         asp-&gt;orig_pdu = NULL;
01622     }
01623     <span class="keywordflow">if</span> (asp-&gt;pdu) {
01624         asp-&gt;pdu-&gt;<a class="code" href="structsnmp__pdu.html#o1">command</a> = SNMP_MSG_RESPONSE;
01625         asp-&gt;pdu-&gt;<a class="code" href="structsnmp__pdu.html#o6">errstat</a> = asp-&gt;status;
01626         asp-&gt;pdu-&gt;<a class="code" href="structsnmp__pdu.html#o7">errindex</a> = asp-&gt;index;
01627         <span class="keywordflow">if</span> (!snmp_send(asp-&gt;session, asp-&gt;pdu)) {
01628             snmp_perror(<span class="stringliteral">"send response"</span>);
01629             snmp_free_pdu(asp-&gt;pdu);
01630             asp-&gt;pdu = NULL;
01631         }
01632         snmp_increment_statistic(STAT_SNMPOUTPKTS);
01633         snmp_increment_statistic(STAT_SNMPOUTGETRESPONSES);
01634         asp-&gt;pdu = NULL; <span class="comment">/* yyy-rks: redundant, no? */</span>
01635         netsnmp_remove_and_free_agent_snmp_session(asp);
01636     }
01637     <span class="keywordflow">return</span> 1;
01638 }
01639 
01640 <span class="keywordtype">void</span>
01641 dump_sess_list(<span class="keywordtype">void</span>)
01642 {
01643     netsnmp_agent_session *a;
01644 
01645     DEBUGMSGTL((<span class="stringliteral">"snmp_agent"</span>, <span class=
"stringliteral">"DUMP agent_sess_list -&gt; "</span>));
01646     <span class="keywordflow">for</span> (a = agent_session_list; a != NULL; a = a-&gt;next) {
01647         DEBUGMSG((<span class="stringliteral">"snmp_agent"</span>, <span class=
"stringliteral">"%08p[session %08p] -&gt; "</span>, a, a-&gt;session));
01648     }
01649     DEBUGMSG((<span class="stringliteral">"snmp_agent"</span>, <span class="stringliteral">"[NIL]\n"</span>));
01650 }
01651 
01652 <span class="keywordtype">void</span>
01653 netsnmp_remove_and_free_agent_snmp_session(netsnmp_agent_session *asp)
01654 {
01655     netsnmp_agent_session *a, **prevNext = &amp;agent_session_list;
01656 
01657     DEBUGMSGTL((<span class="stringliteral">"snmp_agent"</span>, <span class=
"stringliteral">"REMOVE session == %08p\n"</span>, asp));
01658 
01659     <span class="keywordflow">for</span> (a = agent_session_list; a != NULL; a = *prevNext) {
01660         <span class="keywordflow">if</span> (a == asp) {
01661             *prevNext = a-&gt;next;
01662             a-&gt;next = NULL;
01663             free_agent_snmp_session(a);
01664             asp = NULL;
01665             <span class="keywordflow">break</span>;
01666         } <span class="keywordflow">else</span> {
01667             prevNext = &amp;(a-&gt;next);
01668         }
01669     }
01670 
01671     <span class="keywordflow">if</span> (a == NULL &amp;&amp; asp != NULL) {
01672         <span class="comment">/*</span>
01673 <span class="comment">         * We coulnd't find it on the list, so free it anyway.  </span>
01674 <span class="comment">         */</span>
01675         free_agent_snmp_session(asp);
01676     }
01677 }
01678 
01679 <span class="keywordtype">void</span>
01680 netsnmp_free_agent_snmp_session_by_session(<a class="code" href="structsnmp__session.html">netsnmp_session</a> * sess,
01681                                            <span class="keywordtype">void</span> (*free_request)
01682                                            (netsnmp_request_list *))
01683 {
01684     netsnmp_agent_session *a, *next, **prevNext = &amp;agent_session_list;
01685 
01686     DEBUGMSGTL((<span class="stringliteral">"snmp_agent"</span>, <span class=
"stringliteral">"REMOVE session == %08p\n"</span>, sess));
01687 
01688     <span class="keywordflow">for</span> (a = agent_session_list; a != NULL; a = next) {
01689         <span class="keywordflow">if</span> (a-&gt;session == sess) {
01690             *prevNext = a-&gt;next;
01691             next = a-&gt;next;
01692             free_agent_snmp_session(a);
01693         } <span class="keywordflow">else</span> {
01694             prevNext = &amp;(a-&gt;next);
01695             next = a-&gt;next;
01696         }
01697     }
01698 }
01699 
01701 <span class="keywordtype">int</span>
<a name="l01702" id="l01702"></a><a class="code" href="group__snmp__agent.html#ga52">01702</a> <a class="code" href=
"group__snmp__agent.html#ga52">handle_snmp_packet</a>(<span class="keywordtype">int</span> op, <a class="code" href=
"structsnmp__session.html">netsnmp_session</a> * session, <span class="keywordtype">int</span> reqid,
01703                    <a class="code" href="structsnmp__pdu.html">netsnmp_pdu</a> *pdu, <span class=
"keywordtype">void</span> *magic)
01704 {
01705     netsnmp_agent_session *asp;
01706     <span class="keywordtype">int</span>             status, access_ret, rc;
01707 
01708     <span class="comment">/*</span>
01709 <span class="comment">     * We only support receiving here.  </span>
01710 <span class="comment">     */</span>
01711     <span class="keywordflow">if</span> (op != NETSNMP_CALLBACK_OP_RECEIVED_MESSAGE) {
01712         <span class="keywordflow">return</span> 1;
01713     }
01714 
01715     <span class="comment">/*</span>
01716 <span class="comment">     * RESPONSE messages won't get this far, but TRAP-like messages</span>
01717 <span class="comment">     * might.  </span>
01718 <span class="comment">     */</span>
01719     <span class="keywordflow">if</span> (pdu-&gt;<a class="code" href=
"structsnmp__pdu.html#o1">command</a> == SNMP_MSG_TRAP || pdu-&gt;<a class="code" href=
"structsnmp__pdu.html#o1">command</a> == SNMP_MSG_INFORM ||
01720         pdu-&gt;<a class="code" href="structsnmp__pdu.html#o1">command</a> == SNMP_MSG_TRAP2) {
01721         DEBUGMSGTL((<span class="stringliteral">"snmp_agent"</span>, <span class=
"stringliteral">"received trap-like PDU (%02x)\n"</span>,
01722                     pdu-&gt;<a class="code" href="structsnmp__pdu.html#o1">command</a>));
01723         pdu-&gt;<a class="code" href="structsnmp__pdu.html#o1">command</a> = SNMP_MSG_TRAP2;
01724         snmp_increment_statistic(STAT_SNMPUNKNOWNPDUHANDLERS);
01725         <span class="keywordflow">return</span> 1;
01726     }
01727 
01728     <span class="comment">/*</span>
01729 <span class="comment">     * send snmpv3 authfail trap.</span>
01730 <span class="comment">     */</span>
01731     <span class="keywordflow">if</span> (pdu-&gt;<a class="code" href=
"structsnmp__pdu.html#o0">version</a>  == SNMP_VERSION_3 &amp;&amp; 
01732         session-&gt;<a class="code" href=
"structsnmp__session.html#o14">s_snmp_errno</a> == SNMPERR_USM_AUTHENTICATIONFAILURE) {
01733            <a class="code" href="group__agent__trap.html#ga43">send_easy_trap</a>(SNMP_TRAP_AUTHFAIL, 0);
01734            <span class="keywordflow">return</span> 1;
01735     } 
01736         
01737     <span class="keywordflow">if</span> (magic == NULL) {
01738         asp = init_agent_snmp_session(session, pdu);
01739         status = SNMP_ERR_NOERROR;
01740     } <span class="keywordflow">else</span> {
01741         asp = (netsnmp_agent_session *) magic;
01742         status = asp-&gt;status;
01743     }
01744 
01745     <span class="keywordflow">if</span> ((access_ret = check_access(asp-&gt;pdu)) != 0) {
01746         <span class="keywordflow">if</span> (access_ret == VACM_NOSUCHCONTEXT) {
01747             <span class="comment">/*</span>
01748 <span class="comment">             * rfc2573 section 3.2, step 5 says that we increment the</span>
01749 <span class="comment">             * counter but don't return a response of any kind </span>
01750 <span class="comment">             */</span>
01751 
01752             <span class="comment">/*</span>
01753 <span class="comment">             * we currently don't support unavailable contexts, as</span>
01754 <span class="comment">             * there is no reason to that I currently know of </span>
01755 <span class="comment">             */</span>
01756             snmp_increment_statistic(STAT_SNMPUNKNOWNCONTEXTS);
01757 
01758             <span class="comment">/*</span>
01759 <span class="comment">             * drop the request </span>
01760 <span class="comment">             */</span>
01761             netsnmp_remove_and_free_agent_snmp_session(asp);
01762             <span class="keywordflow">return</span> 0;
01763         } <span class="keywordflow">else</span> {
01764             <span class="comment">/*</span>
01765 <span class="comment">             * access control setup is incorrect </span>
01766 <span class="comment">             */</span>
01767             <a class="code" href="group__agent__trap.html#ga43">send_easy_trap</a>(SNMP_TRAP_AUTHFAIL, 0);
01768 <span class="preprocessor">#if !defined(DISABLE_SNMPV1) || !defined(DISABLE_SNMPV2C)</span>
01769             <span class="keywordflow">if</span> (asp-&gt;pdu-&gt;version != SNMP_VERSION_1
01770                 &amp;&amp; asp-&gt;pdu-&gt;version != SNMP_VERSION_2c) {
01771                 asp-&gt;pdu-&gt;<a class="code" href="structsnmp__pdu.html#o6">errstat</a> = SNMP_ERR_AUTHORIZATIONERROR;
01772                 asp-&gt;pdu-&gt;<a class="code" href="structsnmp__pdu.html#o1">command</a> = SNMP_MSG_RESPONSE;
01773                 snmp_increment_statistic(STAT_SNMPOUTPKTS);
01774                 <span class="keywordflow">if</span> (!snmp_send(asp-&gt;session, asp-&gt;pdu))
01775                     snmp_free_pdu(asp-&gt;pdu);
01776                 asp-&gt;pdu = NULL;
01777                 netsnmp_remove_and_free_agent_snmp_session(asp);
01778                 <span class="keywordflow">return</span> 1;
01779             } <span class="keywordflow">else</span> {
01780 <span class="preprocessor">#endif </span><span class="comment">/* support for community based SNMP */</span>
01781                 <span class="comment">/*</span>
01782 <span class="comment">                 * drop the request </span>
01783 <span class="comment">                 */</span>
01784                 netsnmp_remove_and_free_agent_snmp_session(asp);
01785                 <span class="keywordflow">return</span> 0;
01786 <span class="preprocessor">#if !defined(DISABLE_SNMPV1) || !defined(DISABLE_SNMPV2C)</span>
01787             }
01788 <span class="preprocessor">#endif </span><span class="comment">/* support for community based SNMP */</span>
01789         }
01790     }
01791 
01792     rc = netsnmp_handle_request(asp, status);
01793 
01794     <span class="comment">/*</span>
01795 <span class="comment">     * done </span>
01796 <span class="comment">     */</span>
01797     DEBUGMSGTL((<span class="stringliteral">"snmp_agent"</span>, <span class=
"stringliteral">"end of handle_snmp_packet, asp = %08p\n"</span>,
01798                 asp));
01799     <span class="keywordflow">return</span> rc;
01800 }
01801 
01802 <a class="code" href="structnetsnmp__request__info__s.html">netsnmp_request_info</a> *
<a name="l01803" id="l01803"></a><a class="code" href="group__snmp__agent.html#ga53">01803</a> <a class="code" href=
"group__snmp__agent.html#ga53">netsnmp_add_varbind_to_cache</a>(netsnmp_agent_session *asp, <span class=
"keywordtype">int</span> vbcount,
01804                              <a class="code" href="structvariable__list.html">netsnmp_variable_list</a> * varbind_ptr,
01805                              netsnmp_subtree *tp)
01806 {
01807     <a class="code" href="structnetsnmp__request__info__s.html">netsnmp_request_info</a> *request = NULL;
01808     <span class="keywordtype">int</span>             cacheid;
01809 
01810     DEBUGMSGTL((<span class="stringliteral">"snmp_agent"</span>, <span class=
"stringliteral">"add_vb_to_cache(%8p, %d, "</span>, asp, vbcount));
01811     DEBUGMSGOID((<span class="stringliteral">"snmp_agent"</span>, varbind_ptr-&gt;<a class="code" href=
"structvariable__list.html#o1">name</a>,
01812                  varbind_ptr-&gt;<a class="code" href="structvariable__list.html#o2">name_length</a>));
01813     DEBUGMSG((<span class="stringliteral">"snmp_agent"</span>, <span class="stringliteral">", %8p)\n"</span>, tp));
01814 
01815     <span class="keywordflow">if</span> (tp &amp;&amp;
01816         (asp-&gt;pdu-&gt;command == SNMP_MSG_GETNEXT ||
01817          asp-&gt;pdu-&gt;command == SNMP_MSG_GETBULK)) {
01818         <span class="keywordtype">int</span> result;
01819         <span class="keywordtype">int</span> prefix_len;
01820 
01821         prefix_len = <a class="code" href="group__library.html#ga102">netsnmp_oid_find_prefix</a>(tp-&gt;start_a,
01822                                              tp-&gt;start_len,
01823                                              tp-&gt;end_a, tp-&gt;end_len);
01824         result =
01825             <a class="code" href=
"group__agent__registry.html#ga50">netsnmp_acm_check_subtree</a>(asp-&gt;pdu, tp-&gt;start_a, prefix_len);
01826 
01827         <span class="keywordflow">while</span> (result == VACM_NOTINVIEW) {
01828             <span class="comment">/* the entire subtree is not in view. Skip it. */</span>
01836             tp = tp-&gt;<a class="code" href="structnetsnmp__request__info__s.html#o13">next</a>;
01837             <span class="keywordflow">if</span> (tp) {
01838                 prefix_len = <a class="code" href="group__library.html#ga102">netsnmp_oid_find_prefix</a>(tp-&gt;start_a,
01839                                                      tp-&gt;start_len,
01840                                                      tp-&gt;end_a,
01841                                                      tp-&gt;end_len);
01842                 result =
01843                     <a class="code" href="group__agent__registry.html#ga50">netsnmp_acm_check_subtree</a>(asp-&gt;pdu,
01844                                               tp-&gt;start_a, prefix_len);
01845             }
01846             <span class="keywordflow">else</span>
01847                 <span class="keywordflow">break</span>;
01848         }
01849     }
01850     <span class="keywordflow">if</span> (tp == NULL) {
01851         <span class="comment">/*</span>
01852 <span class="comment">         * no appropriate registration found </span>
01853 <span class="comment">         */</span>
01854         <span class="comment">/*</span>
01855 <span class="comment">         * make up the response ourselves </span>
01856 <span class="comment">         */</span>
01857         <span class="keywordflow">switch</span> (asp-&gt;pdu-&gt;command) {
01858         <span class="keywordflow">case</span> SNMP_MSG_GETNEXT:
01859         <span class="keywordflow">case</span> SNMP_MSG_GETBULK:
01860             varbind_ptr-&gt;<a class="code" href="structvariable__list.html#o3">type</a> = SNMP_ENDOFMIBVIEW;
01861             <span class="keywordflow">break</span>;
01862 
01863         <span class="keywordflow">case</span> SNMP_MSG_SET:
01864         <span class="keywordflow">case</span> SNMP_MSG_GET:
01865             varbind_ptr-&gt;<a class="code" href="structvariable__list.html#o3">type</a> = SNMP_NOSUCHOBJECT;
01866             <span class="keywordflow">break</span>;
01867 
01868         <span class="keywordflow">default</span>:
01869             <span class="keywordflow">return</span> NULL;        <span class="comment">/* shouldn't get here */</span>
01870         }
01871     } <span class="keywordflow">else</span> {
01872         DEBUGMSGTL((<span class="stringliteral">"snmp_agent"</span>, <span class="stringliteral">"tp-&gt;start "</span>));
01873         DEBUGMSGOID((<span class="stringliteral">"snmp_agent"</span>, tp-&gt;start_a, tp-&gt;start_len));
01874         DEBUGMSG((<span class="stringliteral">"snmp_agent"</span>, <span class="stringliteral">", tp-&gt;end "</span>));
01875         DEBUGMSGOID((<span class="stringliteral">"snmp_agent"</span>, tp-&gt;end_a, tp-&gt;end_len));
01876         DEBUGMSG((<span class="stringliteral">"snmp_agent"</span>, <span class="stringliteral">", \n"</span>));
01877 
01878         <span class="comment">/*</span>
01879 <span class="comment">         * malloc the request structure </span>
01880 <span class="comment">         */</span>
01881         request = &amp;(asp-&gt;requests[vbcount - 1]);
01882         request-&gt;<a class="code" href="structnetsnmp__request__info__s.html#o9">index</a> = vbcount;
01883         request-&gt;<a class="code" href="structnetsnmp__request__info__s.html#o5">delegated</a> = 0;
01884         request-&gt;<a class="code" href="structnetsnmp__request__info__s.html#o6">processed</a> = 0;
01885         request-&gt;<a class="code" href="structnetsnmp__request__info__s.html#o8">status</a> = 0;
01886         request-&gt;<a class="code" href="structnetsnmp__request__info__s.html#o15">subtree</a> = tp;
01887         request-&gt;<a class="code" href="structnetsnmp__request__info__s.html#o2">agent_req_info</a> = asp-&gt;reqinfo;
01888         <span class="keywordflow">if</span> (request-&gt;<a class="code" href=
"structnetsnmp__request__info__s.html#o1">parent_data</a>) {
01889             <a class="code" href="group__handler.html#ga31">netsnmp_free_request_data_sets</a>(request);
01890         }
01891         DEBUGMSGTL((<span class="stringliteral">"verbose:asp"</span>, <span class=
"stringliteral">"asp %p reqinfo %p assigned to request\n"</span>,
01892                     asp, asp-&gt;reqinfo));
01893 
01894         <span class="comment">/*</span>
01895 <span class="comment">         * for non-SET modes, set the type to NULL </span>
01896 <span class="comment">         */</span>
01897         <span class="keywordflow">if</span> (!MODE_IS_SET(asp-&gt;pdu-&gt;command)) {
01898         DEBUGMSGTL((<span class="stringliteral">"verbose:asp"</span>, <span class=
"stringliteral">"asp %p reqinfo %p assigned to request\n"</span>,
01899                     asp, asp-&gt;reqinfo));
01900             <span class="keywordflow">if</span> (varbind_ptr-&gt;<a class="code" href=
"structvariable__list.html#o3">type</a> == ASN_PRIV_INCL_RANGE) {
01901                 DEBUGMSGTL((<span class="stringliteral">"snmp_agent"</span>, <span class=
"stringliteral">"varbind %d is inclusive\n"</span>,
01902                             request-&gt;<a class="code" href="structnetsnmp__request__info__s.html#o9">index</a>));
01903                 request-&gt;<a class="code" href="structnetsnmp__request__info__s.html#o7">inclusive</a> = 1;
01904             }
01905             varbind_ptr-&gt;<a class="code" href="structvariable__list.html#o3">type</a> = ASN_NULL;
01906         }
01907 
01908         <span class="comment">/*</span>
01909 <span class="comment">         * place them in a cache </span>
01910 <span class="comment">         */</span>
01911         <span class="keywordflow">if</span> (tp-&gt;global_cacheid) {
01912             <span class="comment">/*</span>
01913 <span class="comment">             * we need to merge all marked subtrees together </span>
01914 <span class="comment">             */</span>
01915             <span class="keywordflow">if</span> (asp-&gt;cache_store &amp;&amp; -1 !=
01916                 (cacheid = netsnmp_get_local_cachid(asp-&gt;cache_store,
01917                                                     tp-&gt;global_cacheid))) {
01918             } <span class="keywordflow">else</span> {
01919                 cacheid = ++(asp-&gt;treecache_num);
01920                 netsnmp_get_or_add_local_cachid(&amp;asp-&gt;cache_store,
01921                                                 tp-&gt;global_cacheid,
01922                                                 cacheid);
01923                 <span class="keywordflow">goto</span> mallocslot;        <span class="comment">/* XXX: ick */</span>
01924             }
01925         } <span class="keywordflow">else</span> <span class=
"keywordflow">if</span> (tp-&gt;cacheid &gt; -1 &amp;&amp; tp-&gt;cacheid &lt;= asp-&gt;treecache_num &amp;&amp;
01926                    asp-&gt;treecache[tp-&gt;cacheid].subtree == tp) {
01927             <span class="comment">/*</span>
01928 <span class="comment">             * we have already added a request to this tree</span>
01929 <span class="comment">             * pointer before </span>
01930 <span class="comment">             */</span>
01931             cacheid = tp-&gt;cacheid;
01932         } <span class="keywordflow">else</span> {
01933             cacheid = ++(asp-&gt;treecache_num);
01934           mallocslot:
01935             <span class="comment">/*</span>
01936 <span class="comment">             * new slot needed </span>
01937 <span class="comment">             */</span>
01938             <span class="keywordflow">if</span> (asp-&gt;treecache_num &gt;= asp-&gt;treecache_len) {
01939                 <span class="comment">/*</span>
01940 <span class="comment">                 * exapand cache array </span>
01941 <span class="comment">                 */</span>
01942                 <span class="comment">/*</span>
01943 <span class="comment">                 * WWW: non-linear expansion needed (with cap) </span>
01944 <span class="comment">                 */</span>
01945 <span class="preprocessor">#define CACHE_GROW_SIZE 16</span>
01946                 asp-&gt;treecache_len =
01947                     (asp-&gt;treecache_len + CACHE_GROW_SIZE);
01948                 asp-&gt;treecache =
01949                     realloc(asp-&gt;treecache,
01950                             <span class="keyword">sizeof</span>(netsnmp_tree_cache) *
01951                             asp-&gt;treecache_len);
01952                 <span class="keywordflow">if</span> (asp-&gt;treecache == NULL)
01953                     <span class="keywordflow">return</span> NULL;
01954                 memset(&amp;(asp-&gt;treecache[cacheid]), 0x00,
01955                        <span class="keyword">sizeof</span>(netsnmp_tree_cache) * (CACHE_GROW_SIZE));
01956             }
01957             asp-&gt;treecache[cacheid].subtree = tp;
01958             asp-&gt;treecache[cacheid].requests_begin = request;
01959             tp-&gt;cacheid = cacheid;
01960         }
01961 
01962         <span class="comment">/*</span>
01963 <span class="comment">         * if this is a search type, get the ending range oid as well </span>
01964 <span class="comment">         */</span>
01965         <span class="keywordflow">if</span> (asp-&gt;pdu-&gt;command == SNMP_MSG_GETNEXT ||
01966             asp-&gt;pdu-&gt;command == SNMP_MSG_GETBULK) {
01967             request-&gt;<a class="code" href="structnetsnmp__request__info__s.html#o3">range_end</a> = tp-&gt;end_a;
01968             request-&gt;<a class="code" href="structnetsnmp__request__info__s.html#o4">range_end_len</a> = tp-&gt;end_len;
01969         } <span class="keywordflow">else</span> {
01970             request-&gt;<a class="code" href="structnetsnmp__request__info__s.html#o3">range_end</a> = NULL;
01971             request-&gt;<a class="code" href="structnetsnmp__request__info__s.html#o4">range_end_len</a> = 0;
01972         }
01973 
01974         <span class="comment">/*</span>
01975 <span class="comment">         * link into chain </span>
01976 <span class="comment">         */</span>
01977         <span class="keywordflow">if</span> (asp-&gt;treecache[cacheid].requests_end)
01978             asp-&gt;treecache[cacheid].requests_end-&gt;<a class="code" href=
"structnetsnmp__request__info__s.html#o13">next</a> = request;
01979         request-&gt;<a class="code" href="structnetsnmp__request__info__s.html#o13">next</a> = NULL;
01980         request-&gt;<a class="code" href=
"structnetsnmp__request__info__s.html#o14">prev</a> = asp-&gt;treecache[cacheid].requests_end;
01981         asp-&gt;treecache[cacheid].requests_end = request;
01982 
01983         <span class="comment">/*</span>
01984 <span class="comment">         * add the given request to the list of requests they need</span>
01985 <span class="comment">         * to handle results for </span>
01986 <span class="comment">         */</span>
01987         request-&gt;<a class="code" href="structnetsnmp__request__info__s.html#o0">requestvb</a> = request-&gt;<a class=
"code" href="structnetsnmp__request__info__s.html#o12">requestvb_start</a> = varbind_ptr;
01988     }
01989     <span class="keywordflow">return</span> request;
01990 }
01991 
01992 <span class="comment">/*</span>
01993 <span class="comment"> * check the ACM(s) for the results on each of the varbinds.</span>
01994 <span class="comment"> * If ACM disallows it, replace the value with type</span>
01995 <span class="comment"> * </span>
01996 <span class="comment"> * Returns number of varbinds with ACM errors</span>
01997 <span class="comment"> */</span>
01998 <span class="keywordtype">int</span>
01999 check_acm(netsnmp_agent_session *asp, u_char type)
02000 {
02001     <span class="keywordtype">int</span>             view;
02002     <span class="keywordtype">int</span>             i, j, k;
02003     <a class="code" href="structnetsnmp__request__info__s.html">netsnmp_request_info</a> *request;
02004     <span class="keywordtype">int</span>             ret = 0;
02005     <a class="code" href="structvariable__list.html">netsnmp_variable_list</a> *vb, *vb2, *vbc;
02006     <span class="keywordtype">int</span>             earliest = 0;
02007 
02008     <span class="keywordflow">for</span> (i = 0; i &lt;= asp-&gt;treecache_num; i++) {
02009         <span class="keywordflow">for</span> (request = asp-&gt;treecache[i].requests_begin;
02010              request; request = request-&gt;<a class="code" href="structnetsnmp__request__info__s.html#o13">next</a>) {
02011             <span class="comment">/*</span>
02012 <span class="comment">             * for each request, run it through in_a_view() </span>
02013 <span class="comment">             */</span>
02014             earliest = 0;
02015             <span class="keywordflow">for</span>(j = request-&gt;<a class="code" href=
"structnetsnmp__request__info__s.html#o10">repeat</a>, vb = request-&gt;<a class="code" href=
"structnetsnmp__request__info__s.html#o12">requestvb_start</a>;
02016                 vb &amp;&amp; j &gt; -1;
02017                 j--, vb = vb-&gt;<a class="code" href="structvariable__list.html#o0">next_variable</a>) {
02018                 <span class="keywordflow">if</span> (vb-&gt;type != ASN_NULL &amp;&amp;
02019                     vb-&gt;type != ASN_PRIV_RETRY) { <span class="comment">/* not yet processed */</span>
02020                     view =
02021                         in_a_view(vb-&gt;name, &amp;vb-&gt;name_length,
02022                                   asp-&gt;pdu, vb-&gt;type);
02023 
02024                     <span class="comment">/*</span>
02025 <span class="comment">                     * if a ACM error occurs, mark it as type passed in </span>
02026 <span class="comment">                     */</span>
02027                     <span class="keywordflow">if</span> (view != VACM_SUCCESS) {
02028                         ret++;
02029                         <span class="keywordflow">if</span> (request-&gt;<a class="code" href=
"structnetsnmp__request__info__s.html#o10">repeat</a> &lt; request-&gt;<a class="code" href=
"structnetsnmp__request__info__s.html#o11">orig_repeat</a>) {
02030                             <span class="comment">/* basically this means a GETBULK */</span>
02031                             request-&gt;<a class="code" href="structnetsnmp__request__info__s.html#o10">repeat</a>++;
02032                             <span class="keywordflow">if</span> (!earliest) {
02033                                 request-&gt;<a class="code" href=
"structnetsnmp__request__info__s.html#o0">requestvb</a> = vb;
02034                                 earliest = 1;
02035                             }
02036 
02037                             <span class="comment">/* ugh.  if a whole now exists, we need to</span>
02038 <span class="comment">                               move the contents up the chain and fill</span>
02039 <span class="comment">                               in at the end else we won't end up</span>
02040 <span class="comment">                               lexographically sorted properly */</span>
02041                             <span class="keywordflow">if</span> (j &gt; -1 &amp;&amp; vb-&gt;next_variable &amp;&amp;
02042                                 vb-&gt;next_variable-&gt;type != ASN_NULL &amp;&amp;
02043                                 vb-&gt;next_variable-&gt;type != ASN_PRIV_RETRY) {
02044                                 <span class="keywordflow">for</span>(k = j, vbc = vb, vb2 = vb-&gt;<a class="code" href=
"structvariable__list.html#o0">next_variable</a>;
02045                                     k &gt; -2 &amp;&amp; vbc &amp;&amp; vb2;
02046                                     k--, vbc = vb2, vb2 = vb2-&gt;<a class="code" href=
"structvariable__list.html#o0">next_variable</a>) {
02047                                     <span class="comment">/* clone next into the current */</span>
02048                                     snmp_clone_var(vb2, vbc);
02049                                     vbc-&gt;<a class="code" href="structvariable__list.html#o0">next_variable</a> = vb2;
02050                                 }
02051                             }
02052                         }
02053                         <a class="code" href=
"group__snmp__client.html#ga18">snmp_set_var_typed_value</a>(vb, type, NULL, 0);
02054                     }
02055                 }
02056             }
02057         }
02058     }
02059     <span class="keywordflow">return</span> ret;
02060 }
02061 
02062 
02063 <span class="keywordtype">int</span>
02064 netsnmp_create_subtree_cache(netsnmp_agent_session *asp)
02065 {
02066     netsnmp_subtree *tp;
02067     <a class="code" href="structvariable__list.html">netsnmp_variable_list</a> *varbind_ptr, *vbsave, *vbptr, **prevNext;
02068     <span class="keywordtype">int</span>             view;
02069     <span class="keywordtype">int</span>             vbcount = 0;
02070     <span class="keywordtype">int</span>             bulkcount = 0, bulkrep = 0;
02071     <span class="keywordtype">int</span>             i = 0, n = 0, r = 0;
02072     <a class="code" href="structnetsnmp__request__info__s.html">netsnmp_request_info</a> *request;
02073 
02074     <span class="keywordflow">if</span> (asp-&gt;treecache == NULL &amp;&amp; asp-&gt;treecache_len == 0) {
02075         asp-&gt;treecache_len = <a class="code" href="group__util.html#ga45">SNMP_MAX</a>(1 + asp-&gt;vbcount / 4, 16);
02076         asp-&gt;treecache =
02077             calloc(asp-&gt;treecache_len, <span class="keyword">sizeof</span>(netsnmp_tree_cache));
02078         <span class="keywordflow">if</span> (asp-&gt;treecache == NULL)
02079             <span class="keywordflow">return</span> SNMP_ERR_GENERR;
02080     }
02081     asp-&gt;treecache_num = -1;
02082 
02083     <span class="keywordflow">if</span> (asp-&gt;pdu-&gt;command == SNMP_MSG_GETBULK) {
02084         <span class="comment">/*</span>
02085 <span class="comment">         * getbulk prep </span>
02086 <span class="comment">         */</span>
02087         <span class="keywordtype">int</span>             count = count_varbinds(asp-&gt;pdu-&gt;variables);
02088 
02089         <span class="keywordflow">if</span> (asp-&gt;pdu-&gt;errstat &lt; 0) {
02090             asp-&gt;pdu-&gt;errstat = 0;
02091         }
02092         <span class="keywordflow">if</span> (asp-&gt;pdu-&gt;errindex &lt; 0) {
02093             asp-&gt;pdu-&gt;errindex = 0;
02094         }
02095 
02096         <span class="keywordflow">if</span> (asp-&gt;pdu-&gt;errstat &lt; count) {
02097             n = asp-&gt;pdu-&gt;errstat;
02098         } <span class="keywordflow">else</span> {
02099             n = count;
02100         }
02101         <span class="keywordflow">if</span> ((r = count - n) &lt;= 0) {
02102             r = 0;
02103             asp-&gt;bulkcache = NULL;
02104         } <span class="keywordflow">else</span> {
02105             asp-&gt;bulkcache =
02106                 (<a class="code" href=
"structvariable__list.html">netsnmp_variable_list</a> **) malloc(asp-&gt;pdu-&gt;errindex * r *
02107                                                   <span class="keyword">sizeof</span>(<span class="keyword">struct</span>
02108                                                          varbind_list *));
02109         }
02110         DEBUGMSGTL((<span class="stringliteral">"snmp_agent"</span>, <span class=
"stringliteral">"GETBULK N = %d, M = %d, R = %d\n"</span>,
02111                     n, asp-&gt;pdu-&gt;errindex, r));
02112     }
02113 
02114     <span class="comment">/*</span>
02115 <span class="comment">     * collect varbinds into their registered trees </span>
02116 <span class="comment">     */</span>
02117     prevNext = &amp;(asp-&gt;pdu-&gt;variables);
02118     <span class="keywordflow">for</span> (varbind_ptr = asp-&gt;pdu-&gt;variables; varbind_ptr;
02119          varbind_ptr = vbsave) {
02120 
02121         <span class="comment">/*</span>
02122 <span class="comment">         * getbulk mess with this pointer, so save it </span>
02123 <span class="comment">         */</span>
02124         vbsave = varbind_ptr-&gt;<a class="code" href="structvariable__list.html#o0">next_variable</a>;
02125 
02126         <span class="keywordflow">if</span> (asp-&gt;pdu-&gt;command == SNMP_MSG_GETBULK) {
02127             <span class="keywordflow">if</span> (n &gt; 0) {
02128                 n--;
02129             } <span class="keywordflow">else</span> {
02130                 <span class="comment">/*</span>
02131 <span class="comment">                 * repeate request varbinds on GETBULK.  These will</span>
02132 <span class="comment">                 * have to be properly rearranged later though as</span>
02133 <span class="comment">                 * responses are supposed to actually be interlaced</span>
02134 <span class="comment">                 * with each other.  This is done with the asp-&gt;bulkcache. </span>
02135 <span class="comment">                 */</span>
02136                 bulkrep = asp-&gt;pdu-&gt;errindex - 1;
02137                 <span class="keywordflow">if</span> (asp-&gt;pdu-&gt;errindex &gt; 0) {
02138                     vbptr = varbind_ptr;
02139                     asp-&gt;bulkcache[bulkcount++] = vbptr;
02140 
02141                     <span class="keywordflow">for</span> (i = 1; i &lt; asp-&gt;pdu-&gt;errindex; i++) {
02142                         vbptr-&gt;<a class="code" href="structvariable__list.html#o0">next_variable</a> =
02143                             <a class="code" href="group__util.html#ga38">SNMP_MALLOC_STRUCT</a>(<a class="code" href=
"structvariable__list.html">variable_list</a>);
02144                         <span class="comment">/*</span>
02145 <span class="comment">                         * don't clone the oid as it's got to be</span>
02146 <span class="comment">                         * overwwritten anyway </span>
02147 <span class="comment">                         */</span>
02148                         <span class="keywordflow">if</span> (!vbptr-&gt;<a class="code" href=
"structvariable__list.html#o0">next_variable</a>) {
02149                             <span class="comment">/*</span>
02150 <span class="comment">                             * XXXWWW: ack!!! </span>
02151 <span class="comment">                             */</span>
02152                         } <span class="keywordflow">else</span> {
02153                             vbptr = vbptr-&gt;<a class="code" href="structvariable__list.html#o0">next_variable</a>;
02154                             vbptr-&gt;<a class="code" href="structvariable__list.html#o2">name_length</a> = 0;
02155                             vbptr-&gt;<a class="code" href="structvariable__list.html#o3">type</a> = ASN_NULL;
02156                             asp-&gt;bulkcache[bulkcount++] = vbptr;
02157                         }
02158                     }
02159                     vbptr-&gt;<a class="code" href="structvariable__list.html#o0">next_variable</a> = vbsave;
02160                 } <span class="keywordflow">else</span> {
02161                     <span class="comment">/*</span>
02162 <span class="comment">                     * 0 repeats requested for this varbind, so take it off</span>
02163 <span class="comment">                     * the list.  </span>
02164 <span class="comment">                     */</span>
02165                     vbptr = varbind_ptr;
02166                     *prevNext = vbptr-&gt;<a class="code" href="structvariable__list.html#o0">next_variable</a>;
02167                     vbptr-&gt;<a class="code" href="structvariable__list.html#o0">next_variable</a> = NULL;
02168                     snmp_free_varbind(vbptr);
02169                     asp-&gt;vbcount--;
02170                     <span class="keywordflow">continue</span>;
02171                 }
02172             }
02173         }
02174 
02175         <span class="comment">/*</span>
02176 <span class="comment">         * count the varbinds </span>
02177 <span class="comment">         */</span>
02178         ++vbcount;
02179 
02180         <span class="comment">/*</span>
02181 <span class="comment">         * find the owning tree </span>
02182 <span class="comment">         */</span>
02183         tp = netsnmp_subtree_find(varbind_ptr-&gt;<a class="code" href=
"structvariable__list.html#o1">name</a>, varbind_ptr-&gt;<a class="code" href="structvariable__list.html#o2">name_length</a>,
02184                                   NULL, asp-&gt;pdu-&gt;contextName);
02185 
02186         <span class="comment">/*</span>
02187 <span class="comment">         * check access control </span>
02188 <span class="comment">         */</span>
02189         <span class="keywordflow">switch</span> (asp-&gt;pdu-&gt;command) {
02190         <span class="keywordflow">case</span> SNMP_MSG_GET:
02191             view = in_a_view(varbind_ptr-&gt;<a class="code" href=
"structvariable__list.html#o1">name</a>, &amp;varbind_ptr-&gt;<a class="code" href=
"structvariable__list.html#o2">name_length</a>,
02192                              asp-&gt;pdu, varbind_ptr-&gt;<a class="code" href="structvariable__list.html#o3">type</a>);
02193             <span class="keywordflow">if</span> (view != VACM_SUCCESS)
02194                 <a class="code" href=
"group__snmp__client.html#ga18">snmp_set_var_typed_value</a>(varbind_ptr, SNMP_NOSUCHOBJECT,
02195                                          NULL, 0);
02196             <span class="keywordflow">break</span>;
02197 
02198         <span class="keywordflow">case</span> SNMP_MSG_SET:
02199             view = in_a_view(varbind_ptr-&gt;<a class="code" href=
"structvariable__list.html#o1">name</a>, &amp;varbind_ptr-&gt;<a class="code" href=
"structvariable__list.html#o2">name_length</a>,
02200                              asp-&gt;pdu, varbind_ptr-&gt;<a class="code" href="structvariable__list.html#o3">type</a>);
02201             <span class="keywordflow">if</span> (view != VACM_SUCCESS)
02202                 <span class="keywordflow">return</span> SNMP_ERR_NOTWRITABLE;
02203             <span class="keywordflow">break</span>;
02204 
02205         <span class="keywordflow">case</span> SNMP_MSG_GETNEXT:
02206         <span class="keywordflow">case</span> SNMP_MSG_GETBULK:
02207         <span class="keywordflow">default</span>:
02208             view = VACM_SUCCESS;
02209             <span class="comment">/*</span>
02210 <span class="comment">             * XXXWWW: check VACM here to see if "tp" is even worthwhile </span>
02211 <span class="comment">             */</span>
02212         }
02213         <span class="keywordflow">if</span> (view == VACM_SUCCESS) {
02214             request = <a class="code" href=
"group__snmp__agent.html#ga53">netsnmp_add_varbind_to_cache</a>(asp, vbcount, varbind_ptr,
02215                                                    tp);
02216             <span class="keywordflow">if</span> (request &amp;&amp; asp-&gt;pdu-&gt;command == SNMP_MSG_GETBULK) {
02217                 request-&gt;<a class="code" href=
"structnetsnmp__request__info__s.html#o10">repeat</a> = request-&gt;<a class="code" href=
"structnetsnmp__request__info__s.html#o11">orig_repeat</a> = bulkrep;
02218             }
02219         }
02220 
02221         prevNext = &amp;(varbind_ptr-&gt;<a class="code" href="structvariable__list.html#o0">next_variable</a>);
02222     }
02223 
02224     <span class="keywordflow">return</span> SNMPERR_SUCCESS;
02225 }
02226 
02227 <span class="comment">/*</span>
02228 <span class="comment"> * this function is only applicable in getnext like contexts </span>
02229 <span class="comment"> */</span>
02230 <span class="keywordtype">int</span>
02231 netsnmp_reassign_requests(netsnmp_agent_session *asp)
02232 {
02233     <span class="comment">/*</span>
02234 <span class="comment">     * assume all the requests have been filled or rejected by the</span>
02235 <span class="comment">     * subtrees, so reassign the rejected ones to the next subtree in</span>
02236 <span class="comment">     * the chain </span>
02237 <span class="comment">     */</span>
02238 
02239     <span class="keywordtype">int</span>             i;
02240 
02241     <span class="comment">/*</span>
02242 <span class="comment">     * get old info </span>
02243 <span class="comment">     */</span>
02244     netsnmp_tree_cache *old_treecache = asp-&gt;treecache;
02245 
02246     <span class="comment">/*</span>
02247 <span class="comment">     * malloc new space </span>
02248 <span class="comment">     */</span>
02249     asp-&gt;treecache =
02250         (netsnmp_tree_cache *) calloc(asp-&gt;treecache_len,
02251                                       <span class="keyword">sizeof</span>(netsnmp_tree_cache));
02252     asp-&gt;treecache_num = -1;
02253     <span class="keywordflow">if</span> (asp-&gt;cache_store) {
02254         netsnmp_free_cachemap(asp-&gt;cache_store);
02255         asp-&gt;cache_store = NULL;
02256     }
02257 
02258     <span class="keywordflow">for</span> (i = 0; i &lt; asp-&gt;vbcount; i++) {
02259         <span class="keywordflow">if</span> (asp-&gt;requests[i].requestvb == NULL) {
02260             <span class="comment">/*</span>
02261 <span class="comment">             * Occurs when there's a mixture of still active</span>
02262 <span class="comment">             *   and "endOfMibView" repetitions</span>
02263 <span class="comment">             */</span>
02264             <span class="keywordflow">continue</span>;
02265         }
02266         <span class="keywordflow">if</span> (asp-&gt;requests[i].requestvb-&gt;type == ASN_NULL) {
02267             <span class="keywordflow">if</span> (!<a class="code" href=
"group__snmp__agent.html#ga53">netsnmp_add_varbind_to_cache</a>(asp, asp-&gt;requests[i].index,
02268                                               asp-&gt;requests[i].requestvb,
02269                                               asp-&gt;requests[i].subtree-&gt;next)) {
02270                 <span class="keywordflow">if</span> (old_treecache != NULL) {
02271                     <a class="code" href="group__util.html#ga36">SNMP_FREE</a>(old_treecache);
02272                     old_treecache = NULL;
02273                 }
02274             }
02275         } <span class="keywordflow">else</span> <span class=
"keywordflow">if</span> (asp-&gt;requests[i].requestvb-&gt;type == ASN_PRIV_RETRY) {
02276             <span class="comment">/*</span>
02277 <span class="comment">             * re-add the same subtree </span>
02278 <span class="comment">             */</span>
02279             asp-&gt;requests[i].requestvb-&gt;<a class="code" href="structvariable__list.html#o3">type</a> = ASN_NULL;
02280             <span class="keywordflow">if</span> (!<a class="code" href=
"group__snmp__agent.html#ga53">netsnmp_add_varbind_to_cache</a>(asp, asp-&gt;requests[i].index,
02281                                               asp-&gt;requests[i].requestvb,
02282                                               asp-&gt;requests[i].subtree)) {
02283                 <span class="keywordflow">if</span> (old_treecache != NULL) {
02284                     <a class="code" href="group__util.html#ga36">SNMP_FREE</a>(old_treecache);
02285                     old_treecache = NULL;
02286                 }
02287             }
02288         }
02289     }
02290 
02291     <span class="keywordflow">if</span> (old_treecache != NULL) {
02292         <a class="code" href="group__util.html#ga36">SNMP_FREE</a>(old_treecache);
02293     }
02294     <span class="keywordflow">return</span> SNMP_ERR_NOERROR;
02295 }
02296 
02297 <span class="keywordtype">void</span>
02298 netsnmp_delete_request_infos(<a class="code" href="structnetsnmp__request__info__s.html">netsnmp_request_info</a> *reqlist)
02299 {
02300     <span class="keywordflow">while</span> (reqlist) {
02301         <a class="code" href="group__handler.html#ga31">netsnmp_free_request_data_sets</a>(reqlist);
02302         reqlist = reqlist-&gt;<a class="code" href="structnetsnmp__request__info__s.html#o13">next</a>;
02303     }
02304 }
02305 
02306 <span class="keywordtype">void</span>
02307 netsnmp_delete_subtree_cache(netsnmp_agent_session *asp)
02308 {
02309     <span class="keywordflow">while</span> (asp-&gt;treecache_num &gt;= 0) {
02310         <span class="comment">/*</span>
02311 <span class="comment">         * don't delete subtrees </span>
02312 <span class="comment">         */</span>
02313         netsnmp_delete_request_infos(asp-&gt;treecache[asp-&gt;treecache_num].
02314                                      requests_begin);
02315         asp-&gt;treecache_num--;
02316     }
02317 }
02318 
02319 <span class="keywordtype">int</span>
02320 netsnmp_check_requests_error(<a class="code" href=
"structnetsnmp__request__info__s.html">netsnmp_request_info</a> *requests)
02321 {
02322     <span class="comment">/*</span>
02323 <span class="comment">     * find any errors marked in the requests </span>
02324 <span class="comment">     */</span>
02325     <span class="keywordflow">for</span> (;requests;requests = requests-&gt;<a class="code" href=
"structnetsnmp__request__info__s.html#o13">next</a>) {
02326         <span class="keywordflow">if</span> (requests-&gt;<a class="code" href=
"structnetsnmp__request__info__s.html#o8">status</a> != SNMP_ERR_NOERROR)
02327             <span class="keywordflow">return</span> requests-&gt;<a class="code" href=
"structnetsnmp__request__info__s.html#o8">status</a>;
02328     }
02329     <span class="keywordflow">return</span> SNMP_ERR_NOERROR;
02330 }
02331 
02332 <span class="keywordtype">int</span>
02333 netsnmp_check_requests_status(netsnmp_agent_session *asp,
02334                               <a class="code" href=
"structnetsnmp__request__info__s.html">netsnmp_request_info</a> *requests,
02335                               <span class="keywordtype">int</span> look_for_specific)
02336 {
02337     <span class="comment">/*</span>
02338 <span class="comment">     * find any errors marked in the requests </span>
02339 <span class="comment">     */</span>
02340     <span class="keywordflow">while</span> (requests) {
02341         <span class="keywordflow">if</span>(requests-&gt;<a class="code" href=
"structnetsnmp__request__info__s.html#o2">agent_req_info</a> != asp-&gt;reqinfo) {
02342             DEBUGMSGTL((<span class="stringliteral">"verbose:asp"</span>,
02343                         <span class="stringliteral">"**reqinfo %p doesn't match cached reqinfo %p\n"</span>,
02344                         asp-&gt;reqinfo, requests-&gt;<a class="code" href=
"structnetsnmp__request__info__s.html#o2">agent_req_info</a>));
02345             netsnmp_assert(requests-&gt;<a class="code" href=
"structnetsnmp__request__info__s.html#o2">agent_req_info</a> == asp-&gt;reqinfo);<span class="comment">/* DEBUG */</span>
02346         }
02347         <span class="keywordflow">if</span> (requests-&gt;<a class="code" href=
"structnetsnmp__request__info__s.html#o8">status</a> != SNMP_ERR_NOERROR &amp;&amp;
02348             (!look_for_specific || requests-&gt;<a class="code" href=
"structnetsnmp__request__info__s.html#o8">status</a> == look_for_specific)
02349             &amp;&amp; (look_for_specific || asp-&gt;index == 0
02350                 || requests-&gt;<a class="code" href=
"structnetsnmp__request__info__s.html#o9">index</a> &lt; asp-&gt;<a class="code" href=
"structnetsnmp__request__info__s.html#o9">index</a>)) {
02351             asp-&gt;<a class="code" href="structnetsnmp__request__info__s.html#o9">index</a> = requests-&gt;<a class="code"
href="structnetsnmp__request__info__s.html#o9">index</a>;
02352             asp-&gt;<a class="code" href="structnetsnmp__request__info__s.html#o8">status</a> = requests-&gt;<a class=
"code" href="structnetsnmp__request__info__s.html#o8">status</a>;
02353         }
02354         requests = requests-&gt;<a class="code" href="structnetsnmp__request__info__s.html#o13">next</a>;
02355     }
02356     <span class="keywordflow">return</span> asp-&gt;<a class="code" href=
"structnetsnmp__request__info__s.html#o8">status</a>;
02357 }
02358 
02359 <span class="keywordtype">int</span>
02360 netsnmp_check_all_requests_status(netsnmp_agent_session *asp,
02361                                   <span class="keywordtype">int</span> look_for_specific)
02362 {
02363     <span class="keywordtype">int</span>             i;
02364     <span class="keywordflow">for</span> (i = 0; i &lt;= asp-&gt;treecache_num; i++) {
02365         netsnmp_check_requests_status(asp,
02366                                       asp-&gt;treecache[i].requests_begin,
02367                                       look_for_specific);
02368     }
02369     <span class="keywordflow">return</span> asp-&gt;<a class="code" href=
"structnetsnmp__request__info__s.html#o8">status</a>;
02370 }
02371 
02372 <span class="keywordtype">int</span>
02373 handle_var_requests(netsnmp_agent_session *asp)
02374 {
02375     <span class="keywordtype">int</span>             i, retstatus = SNMP_ERR_NOERROR,
02376         status = SNMP_ERR_NOERROR, final_status = SNMP_ERR_NOERROR;
02377     <a class="code" href="structnetsnmp__handler__registration__s.html">netsnmp_handler_registration</a> *reginfo;
02378 
02379     asp-&gt;reqinfo-&gt;asp = asp;
02380     asp-&gt;reqinfo-&gt;mode = asp-&gt;mode;
02381 
02382     <span class="comment">/*</span>
02383 <span class="comment">     * now, have the subtrees in the cache go search for their results </span>
02384 <span class="comment">     */</span>
02385     <span class="keywordflow">for</span> (i = 0; i &lt;= asp-&gt;treecache_num; i++) {
02386         <span class="comment">/*</span>
02387 <span class="comment">         * don't call handlers w/null reginfo.</span>
02388 <span class="comment">         * - when is this? sub agent disconnected while request processing?</span>
02389 <span class="comment">         * - should this case encompass more of this subroutine?</span>
02390 <span class="comment">         *   - does check_request_status make send if handlers weren't called?</span>
02391 <span class="comment">         */</span>
02392         <span class="keywordflow">if</span>(NULL != asp-&gt;treecache[i].subtree-&gt;reginfo) {
02393             reginfo = asp-&gt;treecache[i].subtree-&gt;reginfo;
02394             status = netsnmp_call_handlers(reginfo, asp-&gt;reqinfo,
02395                                            asp-&gt;treecache[i].requests_begin);
02396         }
02397         <span class="keywordflow">else</span>
02398             status = SNMP_ERR_GENERR;
02399 
02400         <span class="comment">/*</span>
02401 <span class="comment">         * find any errors marked in the requests.  For later parts of</span>
02402 <span class="comment">         * SET processing, only check for new errors specific to that</span>
02403 <span class="comment">         * set processing directive (which must superceed the previous</span>
02404 <span class="comment">         * errors).</span>
02405 <span class="comment">         */</span>
02406         <span class="keywordflow">switch</span> (asp-&gt;mode) {
02407         <span class="keywordflow">case</span> MODE_SET_COMMIT:
02408             retstatus = netsnmp_check_requests_status(asp,
02409                                                       asp-&gt;treecache[i].
02410                                                       requests_begin,
02411                                                       SNMP_ERR_COMMITFAILED);
02412             <span class="keywordflow">break</span>;
02413 
02414         <span class="keywordflow">case</span> MODE_SET_UNDO:
02415             retstatus = netsnmp_check_requests_status(asp,
02416                                                       asp-&gt;treecache[i].
02417                                                       requests_begin,
02418                                                       SNMP_ERR_UNDOFAILED);
02419             <span class="keywordflow">break</span>;
02420 
02421         <span class="keywordflow">default</span>:
02422             retstatus = netsnmp_check_requests_status(asp,
02423                                                       asp-&gt;treecache[i].
02424                                                       requests_begin, 0);
02425             <span class="keywordflow">break</span>;
02426         }
02427 
02428         <span class="comment">/*</span>
02429 <span class="comment">         * always take lowest varbind if possible </span>
02430 <span class="comment">         */</span>
02431         <span class="keywordflow">if</span> (retstatus != SNMP_ERR_NOERROR) {
02432             status = retstatus;
02433         }
02434 
02435         <span class="comment">/*</span>
02436 <span class="comment">         * other things we know less about (no index) </span>
02437 <span class="comment">         */</span>
02438         <span class="comment">/*</span>
02439 <span class="comment">         * WWW: drop support for this? </span>
02440 <span class="comment">         */</span>
02441         <span class="keywordflow">if</span> (final_status == SNMP_ERR_NOERROR &amp;&amp; status != SNMP_ERR_NOERROR) {
02442             <span class="comment">/*</span>
02443 <span class="comment">             * we can't break here, since some processing needs to be</span>
02444 <span class="comment">             * done for all requests anyway (IE, SET handling for UNDO</span>
02445 <span class="comment">             * needs to be called regardless of previous status</span>
02446 <span class="comment">             * results.</span>
02447 <span class="comment">             * WWW:  This should be predictable though and</span>
02448 <span class="comment">             * breaking should be possible in some cases (eg GET,</span>
02449 <span class="comment">             * GETNEXT, ...) </span>
02450 <span class="comment">             */</span>
02451             final_status = status;
02452         }
02453     }
02454 
02455     <span class="keywordflow">return</span> final_status;
02456 }
02457 
02458 <span class="comment">/*</span>
02459 <span class="comment"> * loop through our sessions known delegated sessions and check to see</span>
02460 <span class="comment"> * if they've completed yet. If there are no more delegated sessions,</span>
02461 <span class="comment"> * check for and process any queued requests</span>
02462 <span class="comment"> */</span>
02463 <span class="keywordtype">void</span>
02464 netsnmp_check_outstanding_agent_requests(<span class="keywordtype">void</span>)
02465 {
02466     netsnmp_agent_session *asp, *prev_asp = NULL, *next_asp = NULL;
02467 
02468     <span class="comment">/*</span>
02469 <span class="comment">     * deal with delegated requests</span>
02470 <span class="comment">     */</span>
02471     <span class="keywordflow">for</span> (asp = agent_delegated_list; asp; asp = next_asp) {
02472         next_asp = asp-&gt;next;   <span class="comment">/* save in case we clean up asp */</span>
02473         <span class="keywordflow">if</span> (!netsnmp_check_for_delegated(asp)) {
02474 
02475             <span class="comment">/*</span>
02476 <span class="comment">             * we're done with this one, remove from queue </span>
02477 <span class="comment">             */</span>
02478             <span class="keywordflow">if</span> (prev_asp != NULL)
02479                 prev_asp-&gt;next = asp-&gt;next;
02480             <span class="keywordflow">else</span>
02481                 agent_delegated_list = asp-&gt;next;
02482             asp-&gt;next = NULL;
02483 
02484             <span class="comment">/*</span>
02485 <span class="comment">             * check request status</span>
02486 <span class="comment">             */</span>
02487             netsnmp_check_all_requests_status(asp, 0);
02488             
02489             <span class="comment">/*</span>
02490 <span class="comment">             * continue processing or finish up </span>
02491 <span class="comment">             */</span>
02492             check_delayed_request(asp);
02493 
02494             <span class="comment">/*</span>
02495 <span class="comment">             * if head was removed, don't drop it if it</span>
02496 <span class="comment">             * was it re-queued</span>
02497 <span class="comment">             */</span>
02498             <span class="keywordflow">if</span> ((prev_asp == NULL) &amp;&amp; (agent_delegated_list == asp)) {
02499                 prev_asp = asp;
02500             }
02501         } <span class="keywordflow">else</span> {
02502 
02503             <span class="comment">/*</span>
02504 <span class="comment">             * asp is still on the queue</span>
02505 <span class="comment">             */</span>
02506             prev_asp = asp;
02507         }
02508     }
02509 
02510     <span class="comment">/*</span>
02511 <span class="comment">     * if we are processing a set and there are more delegated</span>
02512 <span class="comment">     * requests, keep waiting before getting to queued requests.</span>
02513 <span class="comment">     */</span>
02514     <span class="keywordflow">if</span> (netsnmp_processing_set &amp;&amp; (NULL != agent_delegated_list))
02515         <span class="keywordflow">return</span>;
02516 
02517     <span class="keywordflow">while</span> (netsnmp_agent_queued_list) {
02518 
02519         <span class="comment">/*</span>
02520 <span class="comment">         * if we are processing a set, the first item better be</span>
02521 <span class="comment">         * the set being (or waiting to be) processed.</span>
02522 <span class="comment">         */</span>
02523         netsnmp_assert((!netsnmp_processing_set) ||
02524                        (netsnmp_processing_set == netsnmp_agent_queued_list));
02525 
02526         <span class="comment">/*</span>
02527 <span class="comment">         * if the top request is a set, don't pop it</span>
02528 <span class="comment">         * off if there are delegated requests</span>
02529 <span class="comment">         */</span>
02530         <span class="keywordflow">if</span> ((netsnmp_agent_queued_list-&gt;pdu-&gt;command == SNMP_MSG_SET) &amp;&amp;
02531             (agent_delegated_list)) {
02532 
02533             netsnmp_assert(netsnmp_processing_set == NULL);
02534 
02535             netsnmp_processing_set = netsnmp_agent_queued_list;
02536             DEBUGMSGTL((<span class="stringliteral">"snmp_agent"</span>, <span class=
"stringliteral">"SET request remains queued while "</span>
02537                         <span class="stringliteral">"delegated requests finish, asp = %08p\n"</span>, asp));
02538             <span class="keywordflow">break</span>;
02539         }
02540 
02541         <span class="comment">/*</span>
02542 <span class="comment">         * pop the first request and process it</span>
02543 <span class="comment">         */</span>
02544         asp = netsnmp_agent_queued_list;
02545         netsnmp_agent_queued_list = asp-&gt;next;
02546         DEBUGMSGTL((<span class="stringliteral">"snmp_agent"</span>,
02547                     <span class="stringliteral">"processing queued request, asp = %08p\n"</span>, asp));
02548 
02549         netsnmp_handle_request(asp, asp-&gt;status);
02550 
02551         <span class="comment">/*</span>
02552 <span class="comment">         * if we hit a set, stop</span>
02553 <span class="comment">         */</span>
02554         <span class="keywordflow">if</span> (NULL != netsnmp_processing_set)
02555             <span class="keywordflow">break</span>;
02556     }
02557 }
02558 
02564 <span class="keywordtype">int</span>
<a name="l02565" id="l02565"></a><a class="code" href="group__snmp__agent.html#ga64">02565</a> <a class="code" href=
"group__snmp__agent.html#ga64">netsnmp_check_transaction_id</a>(<span class="keywordtype">int</span> transaction_id)
02566 {
02567     netsnmp_agent_session *asp, *prev_asp = NULL;
02568 
02569     <span class="keywordflow">for</span> (asp = agent_delegated_list; asp; prev_asp = asp, asp = asp-&gt;next) {
02570         <span class="keywordflow">if</span> (asp-&gt;pdu-&gt;transid == transaction_id)
02571             <span class="keywordflow">return</span> SNMPERR_SUCCESS;
02572     }
02573     <span class="keywordflow">return</span> SNMPERR_GENERR;
02574 }
02575 
02576 
02577 <span class="comment">/*</span>
02578 <span class="comment"> * check_delayed_request(asp)</span>
02579 <span class="comment"> *</span>
02580 <span class="comment"> * Called to rexamine a set of requests and continue processing them</span>
02581 <span class="comment"> * once all the previous (delayed) requests have been handled one way</span>
02582 <span class="comment"> * or another.</span>
02583 <span class="comment"> */</span>
02584 
02585 <span class="keywordtype">int</span>
02586 check_delayed_request(netsnmp_agent_session *asp)
02587 {
02588     <span class="keywordtype">int</span>             status = SNMP_ERR_NOERROR;
02589 
02590     DEBUGMSGTL((<span class="stringliteral">"snmp_agent"</span>, <span class=
"stringliteral">"processing delegated request, asp = %08p\n"</span>,
02591                 asp));
02592 
02593     <span class="keywordflow">switch</span> (asp-&gt;mode) {
02594     <span class="keywordflow">case</span> SNMP_MSG_GETBULK:
02595     <span class="keywordflow">case</span> SNMP_MSG_GETNEXT:
02596         netsnmp_check_all_requests_status(asp, 0);
02597         <a class="code" href="group__snmp__agent.html#ga20">handle_getnext_loop</a>(asp);
02598         <span class="keywordflow">if</span> (netsnmp_check_for_delegated(asp) &amp;&amp;
02599             <a class="code" href=
"group__snmp__agent.html#ga64">netsnmp_check_transaction_id</a>(asp-&gt;pdu-&gt;transid) !=
02600             SNMPERR_SUCCESS) {
02601             <span class="comment">/*</span>
02602 <span class="comment">             * add to delegated request chain </span>
02603 <span class="comment">             */</span>
02604             <span class="keywordflow">if</span> (!netsnmp_check_delegated_chain_for(asp)) {
02605                 asp-&gt;next = agent_delegated_list;
02606                 agent_delegated_list = asp;
02607             }
02608         }
02609         <span class="keywordflow">break</span>;
02610 
02611     <span class="keywordflow">case</span> MODE_SET_COMMIT:
02612         netsnmp_check_all_requests_status(asp, SNMP_ERR_COMMITFAILED);
02613         <span class="keywordflow">goto</span> settop;
02614 
02615     <span class="keywordflow">case</span> MODE_SET_UNDO:
02616         netsnmp_check_all_requests_status(asp, SNMP_ERR_UNDOFAILED);
02617         <span class="keywordflow">goto</span> settop;
02618 
02619     <span class="keywordflow">case</span> MODE_SET_BEGIN:
02620     <span class="keywordflow">case</span> MODE_SET_RESERVE1:
02621     <span class="keywordflow">case</span> MODE_SET_RESERVE2:
02622     <span class="keywordflow">case</span> MODE_SET_ACTION:
02623     <span class="keywordflow">case</span> MODE_SET_FREE:
02624       settop:
02625         handle_set_loop(asp);
02626         <span class=
"keywordflow">if</span> (asp-&gt;mode != FINISHED_SUCCESS &amp;&amp; asp-&gt;mode != FINISHED_FAILURE) {
02627 
02628             <span class="keywordflow">if</span> (netsnmp_check_for_delegated_and_add(asp)) {
02629                 <span class="comment">/*</span>
02630 <span class="comment">                 * add to delegated request chain </span>
02631 <span class="comment">                 */</span>
02632                 <span class="keywordflow">if</span> (!asp-&gt;status)
02633                     asp-&gt;status = status;
02634             }
02635 
02636             <span class="keywordflow">return</span> SNMP_ERR_NOERROR;
02637         }
02638         <span class="keywordflow">break</span>;
02639 
02640     <span class="keywordflow">default</span>:
02641         <span class="keywordflow">break</span>;
02642     }
02643 
02644     <span class="comment">/*</span>
02645 <span class="comment">     * if we don't have anything outstanding (delegated), wrap up </span>
02646 <span class="comment">     */</span>
02647     <span class="keywordflow">if</span> (!netsnmp_check_for_delegated(asp))
02648         <span class="keywordflow">return</span> <a class="code" href=
"group__snmp__agent.html#ga18">netsnmp_wrap_up_request</a>(asp, status);
02649 
02650     <span class="keywordflow">return</span> 1;
02651 }
02652 
02654 <span class="keywordtype">int</span>
<a name="l02655" id="l02655"></a><a class="code" href="group__snmp__agent.html#ga65">02655</a> <a class="code" href=
"group__snmp__agent.html#ga65">check_getnext_results</a>(netsnmp_agent_session *asp)
02656 {
02657     <span class="comment">/*</span>
02658 <span class="comment">     * get old info </span>
02659 <span class="comment">     */</span>
02660     netsnmp_tree_cache *old_treecache = asp-&gt;treecache;
02661     <span class="keywordtype">int</span>             old_treecache_num = asp-&gt;treecache_num;
02662     <span class="keywordtype">int</span>             count = 0;
02663     <span class="keywordtype">int</span>             i, special = 0;
02664     <a class="code" href="structnetsnmp__request__info__s.html">netsnmp_request_info</a> *request;
02665 
02666     <span class="keywordflow">if</span> (asp-&gt;mode == SNMP_MSG_GET) {
02667         <span class="comment">/*</span>
02668 <span class="comment">         * Special case for doing INCLUSIVE getNext operations in</span>
02669 <span class="comment">         * AgentX subagents.  </span>
02670 <span class="comment">         */</span>
02671         DEBUGMSGTL((<span class="stringliteral">"snmp_agent"</span>,
02672                     <span class="stringliteral">"asp-&gt;mode == SNMP_MSG_GET in ch_getnext\n"</span>));
02673         asp-&gt;mode = asp-&gt;oldmode;
02674         special = 1;
02675     }
02676 
02677     <span class="keywordflow">for</span> (i = 0; i &lt;= old_treecache_num; i++) {
02678         <span class="keywordflow">for</span> (request = old_treecache[i].requests_begin; request;
02679              request = request-&gt;<a class="code" href="structnetsnmp__request__info__s.html#o13">next</a>) {
02680 
02681             <span class="comment">/*</span>
02682 <span class="comment">             * If we have just done the special case AgentX GET, then any</span>
02683 <span class="comment">             * requests which were not INCLUSIVE will now have a wrong</span>
02684 <span class="comment">             * response, so junk them and retry from the same place (except</span>
02685 <span class="comment">             * that this time the handler will be called in "inexact"</span>
02686 <span class="comment">             * mode).  </span>
02687 <span class="comment">             */</span>
02688 
02689             <span class="keywordflow">if</span> (special) {
02690                 <span class="keywordflow">if</span> (!request-&gt;<a class="code" href=
"structnetsnmp__request__info__s.html#o7">inclusive</a>) {
02691                     DEBUGMSGTL((<span class="stringliteral">"snmp_agent"</span>,
02692                                 <span class="stringliteral">"request %d wasn't inclusive\n"</span>,
02693                                 request-&gt;<a class="code" href="structnetsnmp__request__info__s.html#o9">index</a>));
02694                     <a class="code" href="group__snmp__client.html#ga18">snmp_set_var_typed_value</a>(request-&gt;<a class=
"code" href="structnetsnmp__request__info__s.html#o0">requestvb</a>,
02695                                              ASN_PRIV_RETRY, NULL, 0);
02696                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (request-&gt;<a class="code"
href="structnetsnmp__request__info__s.html#o0">requestvb</a>-&gt;<a class="code" href=
"structvariable__list.html#o3">type</a> == ASN_NULL ||
02697                            request-&gt;<a class="code" href=
"structnetsnmp__request__info__s.html#o0">requestvb</a>-&gt;<a class="code" href=
"structvariable__list.html#o3">type</a> == SNMP_NOSUCHINSTANCE ||
02698                            request-&gt;<a class="code" href=
"structnetsnmp__request__info__s.html#o0">requestvb</a>-&gt;<a class="code" href=
"structvariable__list.html#o3">type</a> == SNMP_NOSUCHOBJECT) {
02699                     <span class="comment">/*</span>
02700 <span class="comment">                     * it was inclusive, but no results.  Still retry this</span>
02701 <span class="comment">                     * search. </span>
02702 <span class="comment">                     */</span>
02703                     <a class="code" href="group__snmp__client.html#ga18">snmp_set_var_typed_value</a>(request-&gt;<a class=
"code" href="structnetsnmp__request__info__s.html#o0">requestvb</a>,
02704                                              ASN_PRIV_RETRY, NULL, 0);
02705                 }
02706             }
02707 
02708             <span class="comment">/*</span>
02709 <span class="comment">             * out of range? </span>
02710 <span class="comment">             */</span>
02711             <span class="keywordflow">if</span> (<a class="code" href=
"group__library.html#ga98">snmp_oid_compare</a>(request-&gt;<a class="code" href=
"structnetsnmp__request__info__s.html#o0">requestvb</a>-&gt;<a class="code" href="structvariable__list.html#o1">name</a>,
02712                                  request-&gt;<a class="code" href=
"structnetsnmp__request__info__s.html#o0">requestvb</a>-&gt;<a class="code" href="structvariable__list.html#o2">name_length</a>,
02713                                  request-&gt;<a class="code" href="structnetsnmp__request__info__s.html#o3">range_end</a>,
02714                                  request-&gt;<a class="code" href=
"structnetsnmp__request__info__s.html#o4">range_end_len</a>) &gt;= 0) {
02715                 <span class="comment">/*</span>
02716 <span class="comment">                 * ack, it's beyond the accepted end of range. </span>
02717 <span class="comment">                 */</span>
02718                 <span class="comment">/*</span>
02719 <span class="comment">                 * fix it by setting the oid to the end of range oid instead </span>
02720 <span class="comment">                 */</span>
02721                 DEBUGMSGTL((<span class="stringliteral">"check_getnext_results"</span>,
02722                             <span class="stringliteral">"request response %d out of range\n"</span>,
02723                             request-&gt;<a class="code" href="structnetsnmp__request__info__s.html#o9">index</a>));
02724                 request-&gt;<a class="code" href="structnetsnmp__request__info__s.html#o7">inclusive</a> = 1;
02725                 <span class="comment">/*</span>
02726 <span class="comment">                 * XXX: should set this to the original OID? </span>
02727 <span class="comment">                 */</span>
02728                 snmp_set_var_objid(request-&gt;<a class="code" href=
"structnetsnmp__request__info__s.html#o0">requestvb</a>,
02729                                    request-&gt;<a class="code" href=
"structnetsnmp__request__info__s.html#o3">range_end</a>,
02730                                    request-&gt;<a class="code" href=
"structnetsnmp__request__info__s.html#o4">range_end_len</a>);
02731                 <a class="code" href="group__snmp__client.html#ga18">snmp_set_var_typed_value</a>(request-&gt;<a class=
"code" href="structnetsnmp__request__info__s.html#o0">requestvb</a>, ASN_NULL,
02732                                          NULL, 0);
02733             }
02734 
02735             <span class="comment">/*</span>
02736 <span class="comment">             * mark any existent requests with illegal results as NULL </span>
02737 <span class="comment">             */</span>
02738             <span class="keywordflow">if</span> (request-&gt;<a class="code" href=
"structnetsnmp__request__info__s.html#o0">requestvb</a>-&gt;<a class="code" href=
"structvariable__list.html#o3">type</a> == SNMP_ENDOFMIBVIEW) {
02739                 <span class="comment">/*</span>
02740 <span class="comment">                 * illegal response from a subagent.  Change it back to NULL </span>
02741 <span class="comment">                 */</span>
02742                 request-&gt;<a class="code" href="structnetsnmp__request__info__s.html#o0">requestvb</a>-&gt;<a class=
"code" href="structvariable__list.html#o3">type</a> = ASN_NULL;
02743                 request-&gt;<a class="code" href="structnetsnmp__request__info__s.html#o7">inclusive</a> = 1;
02744             }
02745 
02746             <span class="keywordflow">if</span> (request-&gt;<a class="code" href=
"structnetsnmp__request__info__s.html#o0">requestvb</a>-&gt;<a class="code" href=
"structvariable__list.html#o3">type</a> == ASN_NULL ||
02747                 request-&gt;<a class="code" href="structnetsnmp__request__info__s.html#o0">requestvb</a>-&gt;<a class=
"code" href="structvariable__list.html#o3">type</a> == ASN_PRIV_RETRY ||
02748                 (asp-&gt;reqinfo-&gt;mode == MODE_GETBULK
02749                  &amp;&amp; request-&gt;<a class="code" href="structnetsnmp__request__info__s.html#o10">repeat</a> &gt; 0))
02750                 count++;
02751         }
02752     }
02753     <span class="keywordflow">return</span> count;
02754 }
02755 
02759 <span class="keywordtype">int</span>
<a name="l02760" id="l02760"></a><a class="code" href="group__snmp__agent.html#ga20">02760</a> <a class="code" href=
"group__snmp__agent.html#ga20">handle_getnext_loop</a>(netsnmp_agent_session *asp)
02761 {
02762     <span class="keywordtype">int</span>             status;
02763     <a class="code" href="structvariable__list.html">netsnmp_variable_list</a> *var_ptr;
02764 
02765     <span class="comment">/*</span>
02766 <span class="comment">     * loop </span>
02767 <span class="comment">     */</span>
02768     <span class="keywordflow">while</span> (1) {
02769 
02770         <span class="comment">/*</span>
02771 <span class="comment">         * bail for now if anything is delegated. </span>
02772 <span class="comment">         */</span>
02773         <span class="keywordflow">if</span> (netsnmp_check_for_delegated(asp)) {
02774             <span class="keywordflow">return</span> SNMP_ERR_NOERROR;
02775         }
02776 
02777         <span class="comment">/*</span>
02778 <span class="comment">         * check vacm against results </span>
02779 <span class="comment">         */</span>
02780         check_acm(asp, ASN_PRIV_RETRY);
02781 
02782         <span class="comment">/*</span>
02783 <span class="comment">         * need to keep going we're not done yet. </span>
02784 <span class="comment">         */</span>
02785         <span class="keywordflow">if</span> (!<a class="code" href=
"group__snmp__agent.html#ga65">check_getnext_results</a>(asp))
02786             <span class="comment">/*</span>
02787 <span class="comment">             * nothing left, quit now </span>
02788 <span class="comment">             */</span>
02789             <span class="keywordflow">break</span>;
02790 
02791         <span class="comment">/*</span>
02792 <span class="comment">         * never had a request (empty pdu), quit now </span>
02793 <span class="comment">         */</span>
02794         <span class="comment">/*</span>
02795 <span class="comment">         * XXXWWW: huh?  this would be too late, no?  shouldn't we</span>
02796 <span class="comment">         * catch this earlier? </span>
02797 <span class="comment">         */</span>
02798         <span class="comment">/*</span>
02799 <span class="comment">         * if (count == 0)</span>
02800 <span class="comment">         * break; </span>
02801 <span class="comment">         */</span>
02802 
02803         DEBUGIF(<span class="stringliteral">"results"</span>) {
02804             DEBUGMSGTL((<span class="stringliteral">"results"</span>,
02805                         <span class="stringliteral">"getnext results, before next pass:\n"</span>));
02806             <span class="keywordflow">for</span> (var_ptr = asp-&gt;pdu-&gt;variables; var_ptr;
02807                  var_ptr = var_ptr-&gt;<a class="code" href="structvariable__list.html#o0">next_variable</a>) {
02808                 DEBUGMSGTL((<span class="stringliteral">"results"</span>, <span class="stringliteral">"\t"</span>));
02809                 DEBUGMSGVAR((<span class="stringliteral">"results"</span>, var_ptr));
02810                 DEBUGMSG((<span class="stringliteral">"results"</span>, <span class="stringliteral">"\n"</span>));
02811             }
02812         }
02813 
02814         netsnmp_reassign_requests(asp);
02815         status = handle_var_requests(asp);
02816         <span class="keywordflow">if</span> (status != SNMP_ERR_NOERROR) {
02817             <span class="keywordflow">return</span> status;      <span class=
"comment">/* should never really happen */</span>
02818         }
02819     }
02820     <span class="keywordflow">return</span> SNMP_ERR_NOERROR;
02821 }
02822 
02823 <span class="keywordtype">int</span>
02824 handle_set(netsnmp_agent_session *asp)
02825 {
02826     <span class="keywordtype">int</span>             status;
02827     <span class="comment">/*</span>
02828 <span class="comment">     * SETS require 3-4 passes through the var_op_list.</span>
02829 <span class="comment">     * The first two</span>
02830 <span class="comment">     * passes verify that all types, lengths, and values are valid</span>
02831 <span class="comment">     * and may reserve resources and the third does the set and a</span>
02832 <span class="comment">     * fourth executes any actions.  Then the identical GET RESPONSE</span>
02833 <span class="comment">     * packet is returned.</span>
02834 <span class="comment">     * If either of the first two passes returns an error, another</span>
02835 <span class="comment">     * pass is made so that any reserved resources can be freed.</span>
02836 <span class="comment">     * If the third pass returns an error, another pass is</span>
02837 <span class="comment">     * made so that</span>
02838 <span class="comment">     * any changes can be reversed.</span>
02839 <span class="comment">     * If the fourth pass (or any of the error handling passes)</span>
02840 <span class="comment">     * return an error, we'd rather not know about it!</span>
02841 <span class="comment">     */</span>
02842     <span class="keywordflow">if</span> (!(asp-&gt;pdu-&gt;flags &amp; UCD_MSG_FLAG_ONE_PASS_ONLY)) {
02843         <span class="keywordflow">switch</span> (asp-&gt;mode) {
02844         <span class="keywordflow">case</span> MODE_SET_BEGIN:
02845             snmp_increment_statistic(STAT_SNMPINSETREQUESTS);
02846             asp-&gt;rw = WRITE;    <span class="comment">/* WWW: still needed? */</span>
02847             asp-&gt;mode = MODE_SET_RESERVE1;
02848             asp-&gt;<a class="code" href="structnetsnmp__request__info__s.html#o8">status</a> = SNMP_ERR_NOERROR;
02849             <span class="keywordflow">break</span>;
02850 
02851         <span class="keywordflow">case</span> MODE_SET_RESERVE1:
02852 
02853             <span class="keywordflow">if</span> (asp-&gt;status != SNMP_ERR_NOERROR)
02854                 asp-&gt;mode = MODE_SET_FREE;
02855             <span class="keywordflow">else</span>
02856                 asp-&gt;mode = MODE_SET_RESERVE2;
02857             <span class="keywordflow">break</span>;
02858 
02859         <span class="keywordflow">case</span> MODE_SET_RESERVE2:
02860             <span class="keywordflow">if</span> (asp-&gt;status != SNMP_ERR_NOERROR)
02861                 asp-&gt;mode = MODE_SET_FREE;
02862             <span class="keywordflow">else</span>
02863                 asp-&gt;mode = MODE_SET_ACTION;
02864             <span class="keywordflow">break</span>;
02865 
02866         <span class="keywordflow">case</span> MODE_SET_ACTION:
02867             <span class="keywordflow">if</span> (asp-&gt;status != SNMP_ERR_NOERROR)
02868                 asp-&gt;mode = MODE_SET_UNDO;
02869             <span class="keywordflow">else</span>
02870                 asp-&gt;mode = MODE_SET_COMMIT;
02871             <span class="keywordflow">break</span>;
02872 
02873         <span class="keywordflow">case</span> MODE_SET_COMMIT:
02874             <span class="keywordflow">if</span> (asp-&gt;status != SNMP_ERR_NOERROR) {
02875                 asp-&gt;mode = FINISHED_FAILURE;
02876             } <span class="keywordflow">else</span> {
02877                 asp-&gt;mode = FINISHED_SUCCESS;
02878             }
02879             <span class="keywordflow">break</span>;
02880 
02881         <span class="keywordflow">case</span> MODE_SET_UNDO:
02882             asp-&gt;mode = FINISHED_FAILURE;
02883             <span class="keywordflow">break</span>;
02884 
02885         <span class="keywordflow">case</span> MODE_SET_FREE:
02886             asp-&gt;mode = FINISHED_FAILURE;
02887             <span class="keywordflow">break</span>;
02888         }
02889     }
02890 
02891     <span class="keywordflow">if</span> (asp-&gt;mode != FINISHED_SUCCESS &amp;&amp; asp-&gt;mode != FINISHED_FAILURE) {
02892         DEBUGMSGTL((<span class="stringliteral">"agent_set"</span>, <span class=
"stringliteral">"doing set mode = %d (%s)\n"</span>, asp-&gt;mode,
02893                     se_find_label_in_slist(<span class="stringliteral">"agent_mode"</span>, asp-&gt;mode)));
02894         status = handle_var_requests(asp);
02895         DEBUGMSGTL((<span class="stringliteral">"agent_set"</span>, <span class=
"stringliteral">"did set mode = %d, status = %d\n"</span>,
02896                     asp-&gt;mode, status));
02897         <span class="keywordflow">if</span> ((status != SNMP_ERR_NOERROR &amp;&amp; asp-&gt;status == SNMP_ERR_NOERROR) ||
02898             status == SNMP_ERR_COMMITFAILED || 
02899             status == SNMP_ERR_UNDOFAILED) {
02900             asp-&gt;<a class="code" href="structnetsnmp__request__info__s.html#o8">status</a> = status;
02901         }
02902     }
02903     <span class="keywordflow">return</span> asp-&gt;<a class="code" href=
"structnetsnmp__request__info__s.html#o8">status</a>;
02904 }
02905 
02906 <span class="keywordtype">int</span>
02907 handle_set_loop(netsnmp_agent_session *asp)
02908 {
02909     <span class="keywordflow">while</span> (asp-&gt;mode != FINISHED_FAILURE &amp;&amp; asp-&gt;mode != FINISHED_SUCCESS) {
02910         handle_set(asp);
02911         <span class="keywordflow">if</span> (netsnmp_check_for_delegated(asp)) {
02912             <span class="keywordflow">return</span> SNMP_ERR_NOERROR;
02913         }
02914         <span class="keywordflow">if</span> (asp-&gt;pdu-&gt;flags &amp; UCD_MSG_FLAG_ONE_PASS_ONLY) {
02915             <span class="keywordflow">return</span> asp-&gt;<a class="code" href=
"structnetsnmp__request__info__s.html#o8">status</a>;
02916         }
02917     }
02918     <span class="keywordflow">return</span> asp-&gt;<a class="code" href=
"structnetsnmp__request__info__s.html#o8">status</a>;
02919 }
02920 
02921 <span class="keywordtype">int</span>
02922 netsnmp_handle_request(netsnmp_agent_session *asp, <span class="keywordtype">int</span> status)
02923 {
02924     <span class="comment">/*</span>
02925 <span class="comment">     * if this isn't a delegated request trying to finish,</span>
02926 <span class="comment">     * processing of a set request should not start until all</span>
02927 <span class="comment">     * delegated requests have completed, and no other new requests</span>
02928 <span class="comment">     * should be processed until the set request completes.</span>
02929 <span class="comment">     */</span>
02930     <span class="keywordflow">if</span> ((0 == netsnmp_check_delegated_chain_for(asp)) &amp;&amp;
02931         (asp != netsnmp_processing_set)) {
02932         <span class="comment">/*</span>
02933 <span class="comment">         * if we are processing a set and this is not a delegated</span>
02934 <span class="comment">         * request, queue the request</span>
02935 <span class="comment">         */</span>
02936         <span class="keywordflow">if</span> (netsnmp_processing_set) {
02937             netsnmp_add_queued(asp);
02938             DEBUGMSGTL((<span class="stringliteral">"snmp_agent"</span>,
02939                         <span class="stringliteral">"request queued while processing set, "</span>
02940                         <span class="stringliteral">"asp = %08p\n"</span>, asp));
02941             <span class="keywordflow">return</span> 1;
02942         }
02943 
02944         <span class="comment">/*</span>
02945 <span class="comment">         * check for set request</span>
02946 <span class="comment">         */</span>
02947         <span class="keywordflow">if</span> (asp-&gt;pdu-&gt;command == SNMP_MSG_SET) {
02948             netsnmp_processing_set = asp;
02949 
02950             <span class="comment">/*</span>
02951 <span class="comment">             * if there are delegated requests, we must wait for them</span>
02952 <span class="comment">             * to finish.</span>
02953 <span class="comment">             */</span>
02954             <span class="keywordflow">if</span> (agent_delegated_list) {
02955                 DEBUGMSGTL((<span class="stringliteral">"snmp_agent"</span>, <span class=
"stringliteral">"SET request queued while "</span>
02956                             <span class="stringliteral">"delegated requests finish, asp = %08p\n"</span>,
02957                             asp));
02958                 netsnmp_add_queued(asp);
02959                 <span class="keywordflow">return</span> 1;
02960             }
02961         }
02962     }
02963 
02964     <span class="comment">/*</span>
02965 <span class="comment">     * process the request </span>
02966 <span class="comment">     */</span>
02967     status = <a class="code" href="group__snmp__agent.html#ga16">handle_pdu</a>(asp);
02968 
02969     <span class="comment">/*</span>
02970 <span class="comment">     * print the results in appropriate debugging mode </span>
02971 <span class="comment">     */</span>
02972     DEBUGIF(<span class="stringliteral">"results"</span>) {
02973         <a class="code" href="structvariable__list.html">netsnmp_variable_list</a> *var_ptr;
02974         DEBUGMSGTL((<span class="stringliteral">"results"</span>, <span class=
"stringliteral">"request results (status = %d):\n"</span>,
02975                     status));
02976         <span class="keywordflow">for</span> (var_ptr = asp-&gt;pdu-&gt;variables; var_ptr;
02977              var_ptr = var_ptr-&gt;<a class="code" href="structvariable__list.html#o0">next_variable</a>) {
02978             DEBUGMSGTL((<span class="stringliteral">"results"</span>, <span class="stringliteral">"\t"</span>));
02979             DEBUGMSGVAR((<span class="stringliteral">"results"</span>, var_ptr));
02980             DEBUGMSG((<span class="stringliteral">"results"</span>, <span class="stringliteral">"\n"</span>));
02981         }
02982     }
02983 
02984     <span class="comment">/*</span>
02985 <span class="comment">     * check for uncompleted requests </span>
02986 <span class="comment">     */</span>
02987     <span class="keywordflow">if</span> (netsnmp_check_for_delegated_and_add(asp)) {
02988         <span class="comment">/*</span>
02989 <span class="comment">         * add to delegated request chain </span>
02990 <span class="comment">         */</span>
02991         asp-&gt;<a class="code" href="structnetsnmp__request__info__s.html#o8">status</a> = status;
02992     } <span class="keywordflow">else</span> {
02993         <span class="comment">/*</span>
02994 <span class="comment">         * if we don't have anything outstanding (delegated), wrap up</span>
02995 <span class="comment">         */</span>
02996         <span class="keywordflow">return</span> <a class="code" href=
"group__snmp__agent.html#ga18">netsnmp_wrap_up_request</a>(asp, status);
02997     }
02998 
02999     <span class="keywordflow">return</span> 1;
03000 }
03001 
03053 <span class="keywordtype">int</span>
<a name="l03054" id="l03054"></a><a class="code" href="group__snmp__agent.html#ga16">03054</a> <a class="code" href=
"group__snmp__agent.html#ga16">handle_pdu</a>(netsnmp_agent_session *asp)
03055 {
03056     <span class="keywordtype">int</span>             status, inclusives = 0;
03057     <a class="code" href="structvariable__list.html">netsnmp_variable_list</a> *v = NULL;
03058 
03059     <span class="comment">/*</span>
03060 <span class="comment">     * for illegal requests, mark all nodes as ASN_NULL </span>
03061 <span class="comment">     */</span>
03062     <span class="keywordflow">switch</span> (asp-&gt;pdu-&gt;command) {
03063 
03064     <span class="keywordflow">case</span> SNMP_MSG_INTERNAL_SET_RESERVE2:
03065     <span class="keywordflow">case</span> SNMP_MSG_INTERNAL_SET_ACTION:
03066     <span class="keywordflow">case</span> SNMP_MSG_INTERNAL_SET_COMMIT:
03067     <span class="keywordflow">case</span> SNMP_MSG_INTERNAL_SET_FREE:
03068     <span class="keywordflow">case</span> SNMP_MSG_INTERNAL_SET_UNDO:
03069         status = get_set_cache(asp);
03070         <span class="keywordflow">if</span> (status != SNMP_ERR_NOERROR)
03071             <span class="keywordflow">return</span> status;
03072         <span class="keywordflow">break</span>;
03073 
03074     <span class="keywordflow">case</span> SNMP_MSG_GET:
03075     <span class="keywordflow">case</span> SNMP_MSG_GETNEXT:
03076     <span class="keywordflow">case</span> SNMP_MSG_GETBULK:
03077         <span class="keywordflow">for</span> (v = asp-&gt;pdu-&gt;variables; v != NULL; v = v-&gt;<a class="code" href=
"structvariable__list.html#o0">next_variable</a>) {
03078             <span class="keywordflow">if</span> (v-&gt;<a class="code" href=
"structvariable__list.html#o3">type</a> == ASN_PRIV_INCL_RANGE) {
03079                 <span class="comment">/*</span>
03080 <span class="comment">                 * Leave the type for now (it gets set to</span>
03081 <span class="comment">                 * ASN_NULL in netsnmp_add_varbind_to_cache,</span>
03082 <span class="comment">                 * called by create_subnetsnmp_tree_cache below).</span>
03083 <span class="comment">                 * If we set it to ASN_NULL now, we wouldn't be</span>
03084 <span class="comment">                 * able to distinguish INCLUSIVE search</span>
03085 <span class="comment">                 * ranges.  </span>
03086 <span class="comment">                 */</span>
03087                 inclusives++;
03088             } <span class="keywordflow">else</span> {
03089                 <a class="code" href="group__snmp__client.html#ga18">snmp_set_var_typed_value</a>(v, ASN_NULL, NULL, 0);
03090             }
03091         }
03092         <span class="comment">/*</span>
03093 <span class="comment">         * fall through </span>
03094 <span class="comment">         */</span>
03095 
03096     <span class="keywordflow">case</span> SNMP_MSG_INTERNAL_SET_BEGIN:
03097     <span class="keywordflow">case</span> SNMP_MSG_INTERNAL_SET_RESERVE1:
03098     <span class="keywordflow">default</span>:
03099         asp-&gt;vbcount = count_varbinds(asp-&gt;pdu-&gt;variables);
03100         <span class="keywordflow">if</span> (asp-&gt;vbcount) <span class=
"comment">/* efence doesn't like 0 size allocs */</span>
03101             asp-&gt;requests = (<a class="code" href="structnetsnmp__request__info__s.html">netsnmp_request_info</a> *)
03102                 calloc(asp-&gt;vbcount, <span class="keyword">sizeof</span>(<a class="code" href=
"structnetsnmp__request__info__s.html">netsnmp_request_info</a>));
03103         <span class="comment">/*</span>
03104 <span class="comment">         * collect varbinds </span>
03105 <span class="comment">         */</span>
03106         status = netsnmp_create_subtree_cache(asp);
03107         <span class="keywordflow">if</span> (status != SNMP_ERR_NOERROR)
03108             <span class="keywordflow">return</span> status;
03109     }
03110 
03111     asp-&gt;mode = asp-&gt;pdu-&gt;command;
03112     <span class="keywordflow">switch</span> (asp-&gt;mode) {
03113     <span class="keywordflow">case</span> SNMP_MSG_GET:
03114         <span class="comment">/*</span>
03115 <span class="comment">         * increment the message type counter </span>
03116 <span class="comment">         */</span>
03117         snmp_increment_statistic(STAT_SNMPINGETREQUESTS);
03118 
03119         <span class="comment">/*</span>
03120 <span class="comment">         * check vacm ahead of time </span>
03121 <span class="comment">         */</span>
03122         check_acm(asp, SNMP_NOSUCHOBJECT);
03123 
03124         <span class="comment">/*</span>
03125 <span class="comment">         * get the results </span>
03126 <span class="comment">         */</span>
03127         status = handle_var_requests(asp);
03128 
03129         <span class="comment">/*</span>
03130 <span class="comment">         * Deal with unhandled results -&gt; noSuchInstance (rather</span>
03131 <span class="comment">         * than noSuchObject -- in that case, the type will</span>
03132 <span class="comment">         * already have been set to noSuchObject when we realised</span>
03133 <span class="comment">         * we couldn't find an appropriate tree).  </span>
03134 <span class="comment">         */</span>
03135         <span class="keywordflow">if</span> (status == SNMP_ERR_NOERROR)
03136             snmp_replace_var_types(asp-&gt;pdu-&gt;variables, ASN_NULL,
03137                                    SNMP_NOSUCHINSTANCE);
03138         <span class="keywordflow">break</span>;
03139 
03140     <span class="keywordflow">case</span> SNMP_MSG_GETNEXT:
03141         snmp_increment_statistic(STAT_SNMPINGETNEXTS);
03142         <span class="comment">/*</span>
03143 <span class="comment">         * fall through </span>
03144 <span class="comment">         */</span>
03145 
03146     <span class="keywordflow">case</span> SNMP_MSG_GETBULK:     <span class=
"comment">/* note: there is no getbulk stat */</span>
03147         <span class="comment">/*</span>
03148 <span class="comment">         * loop through our mib tree till we find an</span>
03149 <span class="comment">         * appropriate response to return to the caller. </span>
03150 <span class="comment">         */</span>
03151 
03152         <span class="keywordflow">if</span> (inclusives) {
03153             <span class="comment">/*</span>
03154 <span class="comment">             * This is a special case for AgentX INCLUSIVE getNext</span>
03155 <span class="comment">             * requests where a result lexi-equal to the request is okay</span>
03156 <span class="comment">             * but if such a result does not exist, we still want the</span>
03157 <span class="comment">             * lexi-next one.  So basically we do a GET first, and if any</span>
03158 <span class="comment">             * of the INCLUSIVE requests are satisfied, we use that</span>
03159 <span class="comment">             * value.  Then, unsatisfied INCLUSIVE requests, and</span>
03160 <span class="comment">             * non-INCLUSIVE requests get done as normal.  </span>
03161 <span class="comment">             */</span>
03162 
03163             DEBUGMSGTL((<span class="stringliteral">"snmp_agent"</span>, <span class=
"stringliteral">"inclusive range(s) in getNext\n"</span>));
03164             asp-&gt;oldmode = asp-&gt;mode;
03165             asp-&gt;mode = SNMP_MSG_GET;
03166         }
03167 
03168         <span class="comment">/*</span>
03169 <span class="comment">         * first pass </span>
03170 <span class="comment">         */</span>
03171         status = handle_var_requests(asp);
03172         <span class="keywordflow">if</span> (status != SNMP_ERR_NOERROR) {
03173             <span class="keywordflow">if</span> (!inclusives)
03174                 <span class="keywordflow">return</span> status;  <span class=
"comment">/* should never really happen */</span>
03175             <span class="keywordflow">else</span>
03176                 asp-&gt;<a class="code" href="structnetsnmp__request__info__s.html#o8">status</a> = SNMP_ERR_NOERROR;
03177         }
03178 
03179         <span class="comment">/*</span>
03180 <span class="comment">         * loop through our mib tree till we find an</span>
03181 <span class="comment">         * appropriate response to return to the caller. </span>
03182 <span class="comment">         */</span>
03183 
03184         status = <a class="code" href="group__snmp__agent.html#ga20">handle_getnext_loop</a>(asp);
03185         <span class="keywordflow">break</span>;
03186 
03187     <span class="keywordflow">case</span> SNMP_MSG_SET:
03188         <span class="comment">/*</span>
03189 <span class="comment">         * check access permissions first </span>
03190 <span class="comment">         */</span>
03191         <span class="keywordflow">if</span> (check_acm(asp, SNMP_NOSUCHOBJECT))
03192             <span class="keywordflow">return</span> SNMP_ERR_NOTWRITABLE;
03193 
03194         asp-&gt;mode = MODE_SET_BEGIN;
03195         status = handle_set_loop(asp);
03196 
03197         <span class="keywordflow">break</span>;
03198 
03199     <span class="keywordflow">case</span> SNMP_MSG_INTERNAL_SET_BEGIN:
03200     <span class="keywordflow">case</span> SNMP_MSG_INTERNAL_SET_RESERVE1:
03201     <span class="keywordflow">case</span> SNMP_MSG_INTERNAL_SET_RESERVE2:
03202     <span class="keywordflow">case</span> SNMP_MSG_INTERNAL_SET_ACTION:
03203     <span class="keywordflow">case</span> SNMP_MSG_INTERNAL_SET_COMMIT:
03204     <span class="keywordflow">case</span> SNMP_MSG_INTERNAL_SET_FREE:
03205     <span class="keywordflow">case</span> SNMP_MSG_INTERNAL_SET_UNDO:
03206         asp-&gt;pdu-&gt;flags |= UCD_MSG_FLAG_ONE_PASS_ONLY;
03207         status = handle_set_loop(asp);
03208         <span class="comment">/*</span>
03209 <span class="comment">         * asp related cache is saved in cleanup </span>
03210 <span class="comment">         */</span>
03211         <span class="keywordflow">break</span>;
03212 
03213     <span class="keywordflow">case</span> SNMP_MSG_RESPONSE:
03214         snmp_increment_statistic(STAT_SNMPINGETRESPONSES);
03215         <span class="keywordflow">return</span> SNMP_ERR_NOERROR;
03216 
03217     <span class="keywordflow">case</span> SNMP_MSG_TRAP:
03218     <span class="keywordflow">case</span> SNMP_MSG_TRAP2:
03219         snmp_increment_statistic(STAT_SNMPINTRAPS);
03220         <span class="keywordflow">return</span> SNMP_ERR_NOERROR;
03221 
03222     <span class="keywordflow">default</span>:
03223         <span class="comment">/*</span>
03224 <span class="comment">         * WWW: are reports counted somewhere ? </span>
03225 <span class="comment">         */</span>
03226         snmp_increment_statistic(STAT_SNMPINASNPARSEERRS);
03227         <span class="keywordflow">return</span> SNMPERR_GENERR;  <span class="comment">/* shouldn't get here */</span>
03228         <span class="comment">/*</span>
03229 <span class="comment">         * WWW </span>
03230 <span class="comment">         */</span>
03231     }
03232     <span class="keywordflow">return</span> status;
03233 }
03234 
03238 NETSNMP_STATIC_INLINE <span class="keywordtype">int</span>
<a name="l03239" id="l03239"></a><a class="code" href="group__snmp__agent.html#ga67">03239</a> <a class="code" href=
"group__snmp__agent.html#ga67">_request_set_error</a>(<a class="code" href=
"structnetsnmp__request__info__s.html">netsnmp_request_info</a> *request, <span class="keywordtype">int</span> mode, <span class=
"keywordtype">int</span> error_value)
03240 {
03241     <span class="keywordflow">if</span> (!request)
03242         <span class="keywordflow">return</span> SNMPERR_NO_VARS;
03243 
03244     request-&gt;<a class="code" href="structnetsnmp__request__info__s.html#o6">processed</a> = 1;
03245     request-&gt;<a class="code" href="structnetsnmp__request__info__s.html#o5">delegated</a> = REQUEST_IS_NOT_DELEGATED;
03246 
03247     <span class="keywordflow">switch</span> (error_value) {
03248     <span class="keywordflow">case</span> SNMP_NOSUCHOBJECT:
03249     <span class="keywordflow">case</span> SNMP_NOSUCHINSTANCE:
03250     <span class="keywordflow">case</span> SNMP_ENDOFMIBVIEW:
03251         <span class="comment">/*</span>
03252 <span class="comment">         * these are exceptions that should be put in the varbind</span>
03253 <span class="comment">         * in the case of a GET but should be translated for a SET</span>
03254 <span class="comment">         * into a real error status code and put in the request </span>
03255 <span class="comment">         */</span>
03256         <span class="keywordflow">switch</span> (mode) {
03257         <span class="keywordflow">case</span> MODE_GET:
03258         <span class="keywordflow">case</span> MODE_GETNEXT:
03259         <span class="keywordflow">case</span> MODE_GETBULK:
03260             request-&gt;<a class="code" href="structnetsnmp__request__info__s.html#o0">requestvb</a>-&gt;<a class="code"
href="structvariable__list.html#o3">type</a> = error_value;
03261             <span class="keywordflow">return</span> SNMPERR_SUCCESS;
03262 
03263             <span class="comment">/*</span>
03264 <span class="comment">             * These are technically illegal to set by the</span>
03265 <span class="comment">             * client APIs for these modes.  But accepting</span>
03266 <span class="comment">             * them here allows the 'sparse_table' helper to</span>
03267 <span class="comment">             * provide some common table handling processing</span>
03268 <span class="comment">             *</span>
03269 <span class="comment">            snmp_log(LOG_ERR, "Illegal error_value %d for mode %d ignored\n",</span>
03270 <span class="comment">                     error_value, mode);</span>
03271 <span class="comment">            return SNMPERR_VALUE;</span>
03272 <span class="comment">             */</span>
03273 
03274         <span class="keywordflow">default</span>:
03275             request-&gt;<a class="code" href=
"structnetsnmp__request__info__s.html#o8">status</a> = SNMP_ERR_NOSUCHNAME;      <span class="comment">/* WWW: correct? */</span>
03276             <span class="keywordflow">return</span> SNMPERR_SUCCESS;
03277         }
03278         <span class="keywordflow">break</span>;                  <span class="comment">/* never get here */</span>
03279 
03280     <span class="keywordflow">default</span>:
03281         <span class="keywordflow">if</span> (error_value &lt; 0) {
03282             <span class="comment">/*</span>
03283 <span class="comment">             * illegal local error code.  translate to generr </span>
03284 <span class="comment">             */</span>
03285             <span class="comment">/*</span>
03286 <span class="comment">             * WWW: full translation map? </span>
03287 <span class="comment">             */</span>
03288             <a class="code" href="group__snmp__logging.html#ga39">snmp_log</a>(LOG_ERR, <span class=
"stringliteral">"Illegal error_value %d translated to %d\n"</span>,
03289                      error_value, SNMP_ERR_GENERR);
03290             request-&gt;<a class="code" href="structnetsnmp__request__info__s.html#o8">status</a> = SNMP_ERR_GENERR;
03291         } <span class="keywordflow">else</span> {
03292             <span class="comment">/*</span>
03293 <span class="comment">             * WWW: translations and mode checking? </span>
03294 <span class="comment">             */</span>
03295             request-&gt;<a class="code" href="structnetsnmp__request__info__s.html#o8">status</a> = error_value;
03296         }
03297         <span class="keywordflow">return</span> SNMPERR_SUCCESS;
03298     }
03299     <span class="keywordflow">return</span> SNMPERR_SUCCESS;
03300 }
03301 
03306 <span class="keywordtype">int</span>
<a name="l03307" id="l03307"></a><a class="code" href="group__snmp__agent.html#ga68">03307</a> <a class="code" href=
"group__snmp__agent.html#ga68">netsnmp_request_set_error</a>(<a class="code" href=
"structnetsnmp__request__info__s.html">netsnmp_request_info</a> *request, <span class="keywordtype">int</span> error_value)
03308 {
03309     <span class="keywordflow">if</span> (!request || !request-&gt;<a class="code" href=
"structnetsnmp__request__info__s.html#o2">agent_req_info</a>)
03310         <span class="keywordflow">return</span> SNMPERR_NO_VARS;
03311 
03312     <span class="keywordflow">return</span> <a class="code" href=
"group__snmp__agent.html#ga67">_request_set_error</a>(request, request-&gt;<a class="code" href=
"structnetsnmp__request__info__s.html#o2">agent_req_info</a>-&gt;<a class="code" href=
"structnetsnmp__agent__request__info__s.html#o0">mode</a>,
03313                               error_value);
03314 }
03315 
03321 NETSNMP_INLINE <span class="keywordtype">int</span>
<a name="l03322" id="l03322"></a><a class="code" href="group__snmp__agent.html#ga69">03322</a> <a class="code" href=
"group__snmp__agent.html#ga69">netsnmp_request_set_error_all</a>( <a class="code" href=
"structnetsnmp__request__info__s.html">netsnmp_request_info</a> *requests, <span class="keywordtype">int</span> error)
03323 {
03324     <span class="keywordtype">int</span> mode, rc, result = SNMPERR_SUCCESS;
03325 
03326     <span class="keywordflow">if</span>((NULL == requests) || (NULL == requests-&gt;<a class="code" href=
"structnetsnmp__request__info__s.html#o2">agent_req_info</a>))
03327         <span class="keywordflow">return</span> SNMPERR_NO_VARS;
03328     
03329     mode = requests-&gt;<a class="code" href="structnetsnmp__request__info__s.html#o2">agent_req_info</a>-&gt;<a class=
"code" href="structnetsnmp__agent__request__info__s.html#o0">mode</a>; <span class="comment">/* every req has same mode */</span>
03330     
03331     <span class="keywordflow">for</span>(; requests ; requests = requests-&gt;<a class="code" href=
"structnetsnmp__request__info__s.html#o13">next</a>) {
03332 
03334         netsnmp_assert(NULL != requests-&gt;<a class="code" href=
"structnetsnmp__request__info__s.html#o2">agent_req_info</a>);
03335         netsnmp_assert(mode == requests-&gt;<a class="code" href=
"structnetsnmp__request__info__s.html#o2">agent_req_info</a>-&gt;<a class="code" href=
"structnetsnmp__agent__request__info__s.html#o0">mode</a>);
03336 
03337         <span class="comment">/*</span>
03338 <span class="comment">         * set error for this request. Log any errors, save the last</span>
03339 <span class="comment">         * to return to the user.</span>
03340 <span class="comment">         */</span>
03341         <span class="keywordflow">if</span>((rc = <a class="code" href=
"group__snmp__agent.html#ga67">_request_set_error</a>(requests, mode, error))) {
03342             <a class="code" href="group__snmp__logging.html#ga39">snmp_log</a>(LOG_WARNING,<span class=
"stringliteral">"got %d while setting request error\n"</span>, rc);
03343             result = rc;
03344         }
03345     }
03346     <span class="keywordflow">return</span> result;
03347 }
03348 
03349 <span class="keyword">extern</span> <span class="keyword">struct </span>timeval starttime;
03350 
03351                 <span class="comment">/*</span>
03352 <span class="comment">                 * Return the value of 'sysUpTime' at the given marker </span>
03353 <span class="comment">                 */</span>
03354 u_long
03355 netsnmp_marker_uptime(marker_t pm)
03356 {
03357     u_long          res;
03358     marker_t        start = (marker_t) &amp; starttime;
03359 
03360     res = <a class="code" href="group__util.html#ga19">uatime_hdiff</a>(start, pm);
03361     <span class="keywordflow">return</span> res;                 <span class=
"comment">/* atime_diff works in msec, not csec */</span>
03362 }
03363 
03364                         <span class="comment">/*</span>
03365 <span class="comment">                         * struct timeval equivalents of these </span>
03366 <span class="comment">                         */</span>
03367 u_long
03368 netsnmp_timeval_uptime(<span class="keyword">struct</span> timeval * tv)
03369 {
03370     <span class="keywordflow">return</span> netsnmp_marker_uptime((marker_t) tv);
03371 }
03372 
03373                 <span class="comment">/*</span>
03374 <span class="comment">                 * Return the current value of 'sysUpTime' </span>
03375 <span class="comment">                 */</span>
03376 u_long
03377 netsnmp_get_agent_uptime(<span class="keywordtype">void</span>)
03378 {
03379     <span class="keyword">struct </span>timeval  now;
03380     gettimeofday(&amp;now, NULL);
03381 
03382     <span class="keywordflow">return</span> netsnmp_timeval_uptime(&amp;now);
03383 }
03384 
03385 
03386 
03387 NETSNMP_INLINE <span class="keywordtype">void</span>
03388 netsnmp_agent_add_list_data(<a class="code" href=
"structnetsnmp__agent__request__info__s.html">netsnmp_agent_request_info</a> *ari,
03389                             <a class="code" href="structnetsnmp__data__list__s.html">netsnmp_data_list</a> *node)
03390 {
03391     <span class="keywordflow">if</span> (ari) {
03392         <span class="keywordflow">if</span> (ari-&gt;<a class="code" href=
"structnetsnmp__agent__request__info__s.html#o2">agent_data</a>) {
03393             <a class="code" href="group__data__list.html#ga4">netsnmp_add_list_data</a>(&amp;ari-&gt;<a class="code" href=
"structnetsnmp__agent__request__info__s.html#o2">agent_data</a>, node);
03394         } <span class="keywordflow">else</span> {
03395             ari-&gt;<a class="code" href="structnetsnmp__agent__request__info__s.html#o2">agent_data</a> = node;
03396         }
03397     }
03398 }
03399 
03400 NETSNMP_INLINE <span class="keywordtype">int</span>
03401 netsnmp_agent_remove_list_data(<a class="code" href=
"structnetsnmp__agent__request__info__s.html">netsnmp_agent_request_info</a> *ari,
03402                                <span class="keyword">const</span> <span class="keywordtype">char</span> * name)
03403 {
03404     <span class="keywordflow">if</span> ((NULL == ari) || (NULL == ari-&gt;<a class="code" href=
"structnetsnmp__agent__request__info__s.html#o2">agent_data</a>))
03405         <span class="keywordflow">return</span> 1;
03406 
03407     <span class="keywordflow">return</span> <a class="code" href=
"group__data__list.html#ga9">netsnmp_remove_list_node</a>(&amp;ari-&gt;<a class="code" href=
"structnetsnmp__agent__request__info__s.html#o2">agent_data</a>, name);
03408 }
03409 
03410 NETSNMP_INLINE <span class="keywordtype">void</span>    *
03411 netsnmp_agent_get_list_data(<a class="code" href=
"structnetsnmp__agent__request__info__s.html">netsnmp_agent_request_info</a> *ari,
03412                             <span class="keyword">const</span> <span class="keywordtype">char</span> *name)
03413 {
03414     <span class="keywordflow">if</span> (ari) {
03415         <span class="keywordflow">return</span> <a class="code" href=
"group__data__list.html#ga7">netsnmp_get_list_data</a>(ari-&gt;<a class="code" href=
"structnetsnmp__agent__request__info__s.html#o2">agent_data</a>, name);
03416     }
03417     <span class="keywordflow">return</span> NULL;
03418 }
03419 
03420 NETSNMP_INLINE <span class="keywordtype">void</span>
03421 netsnmp_free_agent_data_set(<a class="code" href=
"structnetsnmp__agent__request__info__s.html">netsnmp_agent_request_info</a> *ari)
03422 {
03423     <span class="keywordflow">if</span> (ari) {
03424         <a class="code" href="group__data__list.html#ga1">netsnmp_free_list_data</a>(ari-&gt;<a class="code" href=
"structnetsnmp__agent__request__info__s.html#o2">agent_data</a>);
03425     }
03426 }
03427 
03428 NETSNMP_INLINE <span class="keywordtype">void</span>
03429 netsnmp_free_agent_data_sets(<a class="code" href=
"structnetsnmp__agent__request__info__s.html">netsnmp_agent_request_info</a> *ari)
03430 {
03431     <span class="keywordflow">if</span> (ari) {
03432         <a class="code" href="group__data__list.html#ga2">netsnmp_free_all_list_data</a>(ari-&gt;<a class="code" href=
"structnetsnmp__agent__request__info__s.html#o2">agent_data</a>);
03433     }
03434 }
03435 
03436 NETSNMP_INLINE <span class="keywordtype">void</span>
03437 netsnmp_free_agent_request_info(<a class="code" href=
"structnetsnmp__agent__request__info__s.html">netsnmp_agent_request_info</a> *ari)
03438 {
03439     <span class="keywordflow">if</span> (ari) {
03440         <span class="keywordflow">if</span> (ari-&gt;<a class="code" href=
"structnetsnmp__agent__request__info__s.html#o2">agent_data</a>) {
03441             <a class="code" href="group__data__list.html#ga2">netsnmp_free_all_list_data</a>(ari-&gt;<a class="code" href=
"structnetsnmp__agent__request__info__s.html#o2">agent_data</a>);
03442         }
03443         <a class="code" href="group__util.html#ga36">SNMP_FREE</a>(ari);
03444     }
03445 }
03446 
03447 <span class="comment">/*************************************************************************</span>
03448 <span class="comment"> *</span>
03449 <span class="comment"> * deprecated functions</span>
03450 <span class="comment"> *</span>
03451 <span class="comment"> */</span>
03452 
03460 <span class="keywordtype">int</span>
<a name="l03461" id="l03461"></a><a class="code" href="group__snmp__agent.html#ga79">03461</a> <a class="code" href=
"group__snmp__agent.html#ga79">netsnmp_set_request_error</a>(<a class="code" href=
"structnetsnmp__agent__request__info__s.html">netsnmp_agent_request_info</a> *reqinfo,
03462                           <a class="code" href=
"structnetsnmp__request__info__s.html">netsnmp_request_info</a> *request, <span class="keywordtype">int</span> error_value)
03463 {
03464     <span class="keywordflow">if</span> (!request || !reqinfo)
03465         <span class="keywordflow">return</span> error_value;
03466 
03467     <a class="code" href="group__snmp__agent.html#ga67">_request_set_error</a>(request, reqinfo-&gt;<a class="code" href=
"structnetsnmp__agent__request__info__s.html#o0">mode</a>, error_value);
03468     
03469     <span class="keywordflow">return</span> error_value;
03470 }
03471 
03479 <span class="keywordtype">int</span>
<a name="l03480" id="l03480"></a><a class="code" href="group__snmp__agent.html#ga80">03480</a> <a class="code" href=
"group__snmp__agent.html#ga80">netsnmp_set_mode_request_error</a>(<span class="keywordtype">int</span> mode, <a class="code"
href="structnetsnmp__request__info__s.html">netsnmp_request_info</a> *request,
03481                                <span class="keywordtype">int</span> error_value)
03482 {
03483     <a class="code" href="group__snmp__agent.html#ga67">_request_set_error</a>(request, mode, error_value);
03484     
03485     <span class="keywordflow">return</span> error_value;
03486 }
03487 
03495 <span class="keywordtype">int</span>
<a name="l03496" id="l03496"></a><a class="code" href="group__snmp__agent.html#ga81">03496</a> <a class="code" href=
"group__snmp__agent.html#ga81">netsnmp_set_all_requests_error</a>(<a class="code" href=
"structnetsnmp__agent__request__info__s.html">netsnmp_agent_request_info</a> *reqinfo,
03497                                <a class="code" href=
"structnetsnmp__request__info__s.html">netsnmp_request_info</a> *requests,
03498                                <span class="keywordtype">int</span> error_value)
03499 {
03500     <a class="code" href="group__snmp__agent.html#ga69">netsnmp_request_set_error_all</a>(requests, error_value);
03501     <span class="keywordflow">return</span> error_value;
03502 }
</pre>
  </div>
  <hr size="1" />

  <address style="align: right;">
    <small><!--#include virtual="/sfbutton.html" --><br />
    Generated on Thu Nov 25 17:51:39 2004 for net-snmp by&nbsp; <a href="http://www.doxygen.org/index.html"><img src=
    "doxygen.png" alt="doxygen" align="middle" border="0" /></a> 1.3.9.1</small>
  </address>
<!-- CONTENT END -->
<!--#include virtual="/page-bottom.html" -->

