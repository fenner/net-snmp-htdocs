<!--#set var="section" value="development" -->
<!--#include virtual="/page-top.html" -->
<!-- CONTENT START -->
  <div class="qindex">
    <a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="modules.html">Modules</a> | <a class=
    "qindex" href="annotated.html">Data&nbsp;Structures</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class=
    "qindex" href="functions.html">Data&nbsp;Fields</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a> | <a class=
    "qindex" href="examples.html">Examples</a>
  </div>

  <div class="nav">
    <a class="el" href="dir_000005.html">snmplib</a>
  </div>

  <h1>snmp_parse_args.c</h1>

  <div class="fragment">
    <pre class="fragment">
00001 <span class="comment">/*</span>
00002 <span class="comment"> * snmp_parse_args.c</span>
00003 <span class="comment"> */</span>
00004 <span class="comment">/* Portions of this file are subject to the following copyright(s).  See</span>
00005 <span class="comment"> * the Net-SNMP's COPYING file for more details and other copyrights</span>
00006 <span class="comment"> * that may apply:</span>
00007 <span class="comment"> */</span>
00008 <span class="comment">/*</span>
00009 <span class="comment"> * Portions of this file are copyrighted by:</span>
00010 <span class="comment"> * Copyright @ 2003 Sun Microsystems, Inc. All rights reserved.</span>
00011 <span class="comment"> * Use is subject to license terms specified in the COPYING file</span>
00012 <span class="comment"> * distributed with the Net-SNMP package.</span>
00013 <span class="comment"> */</span>
00014 
00015 <span class="preprocessor">#include &lt;net-snmp/net-snmp-config.h&gt;</span>
00016 
00017 <span class="preprocessor">#if HAVE_STDLIB_H</span>
00018 <span class="preprocessor">#include &lt;stdlib.h&gt;</span>
00019 <span class="preprocessor">#endif</span>
00020 <span class="preprocessor">#if HAVE_UNISTD_H</span>
00021 <span class="preprocessor">#include &lt;unistd.h&gt;</span>
00022 <span class="preprocessor">#endif</span>
00023 <span class="preprocessor">#if HAVE_STRING_H</span>
00024 <span class="preprocessor">#include &lt;string.h&gt;</span>
00025 <span class="preprocessor">#else</span>
00026 <span class="preprocessor">#include &lt;strings.h&gt;</span>
00027 <span class="preprocessor">#endif</span>
00028 <span class="preprocessor">#include &lt;sys/types.h&gt;</span>
00029 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
00030 <span class="preprocessor">#if HAVE_UNISTD_H</span>
00031 <span class="preprocessor">#include &lt;unistd.h&gt;</span>
00032 <span class="preprocessor">#endif</span>
00033 <span class="preprocessor">#include &lt;ctype.h&gt;</span>
00034 <span class="preprocessor">#if HAVE_NETINET_IN_H</span>
00035 <span class="preprocessor">#include &lt;netinet/in.h&gt;</span>
00036 <span class="preprocessor">#endif</span>
00037 <span class="preprocessor">#if TIME_WITH_SYS_TIME</span>
00038 <span class="preprocessor"># ifdef WIN32</span>
00039 <span class="preprocessor">#  include &lt;sys/timeb.h&gt;</span>
00040 <span class="preprocessor"># else</span>
00041 <span class="preprocessor">#  include &lt;sys/time.h&gt;</span>
00042 <span class="preprocessor"># endif</span>
00043 <span class="preprocessor"># include &lt;time.h&gt;</span>
00044 <span class="preprocessor">#else</span>
00045 <span class="preprocessor"># if HAVE_SYS_TIME_H</span>
00046 <span class="preprocessor">#  include &lt;sys/time.h&gt;</span>
00047 <span class="preprocessor"># else</span>
00048 <span class="preprocessor">#  include &lt;time.h&gt;</span>
00049 <span class="preprocessor"># endif</span>
00050 <span class="preprocessor">#endif</span>
00051 <span class="preprocessor">#if HAVE_SYS_SELECT_H</span>
00052 <span class="preprocessor">#include &lt;sys/select.h&gt;</span>
00053 <span class="preprocessor">#endif</span>
00054 <span class="preprocessor">#if HAVE_WINSOCK_H</span>
00055 <span class="preprocessor">#include &lt;winsock.h&gt;</span>
00056 <span class="preprocessor">#endif</span>
00057 <span class="preprocessor">#if HAVE_NETDB_H</span>
00058 <span class="preprocessor">#include &lt;netdb.h&gt;</span>
00059 <span class="preprocessor">#endif</span>
00060 <span class="preprocessor">#if HAVE_ARPA_INET_H</span>
00061 <span class="preprocessor">#include &lt;arpa/inet.h&gt;</span>
00062 <span class="preprocessor">#endif</span>
00063 
00064 <span class="preprocessor">#include &lt;net-snmp/types.h&gt;</span>
00065 <span class="preprocessor">#include &lt;net-snmp/output_api.h&gt;</span>
00066 <span class="preprocessor">#include &lt;net-snmp/config_api.h&gt;</span>
00067 <span class="preprocessor">#include &lt;net-snmp/library/snmp_parse_args.h&gt;</span>   <span class=
"comment">/* for "internal" definitions */</span>
00068 <span class="preprocessor">#include &lt;net-snmp/utilities.h&gt;</span>
00069 
00070 <span class="preprocessor">#include &lt;net-snmp/library/snmp_api.h&gt;</span>
00071 <span class="preprocessor">#include &lt;net-snmp/library/snmp_client.h&gt;</span>
00072 <span class="preprocessor">#include &lt;net-snmp/library/mib.h&gt;</span>
00073 <span class="preprocessor">#include &lt;net-snmp/library/scapi.h&gt;</span>
00074 <span class="preprocessor">#include &lt;net-snmp/library/keytools.h&gt;</span>
00075 
00076 <span class="preprocessor">#include &lt;net-snmp/version.h&gt;</span>
00077 <span class="preprocessor">#include &lt;net-snmp/library/parse.h&gt;</span>
00078 <span class="preprocessor">#include &lt;net-snmp/library/snmpv3.h&gt;</span>
00079 <span class="preprocessor">#include &lt;net-snmp/library/transform_oids.h&gt;</span>
00080 
00081 <span class="keywordtype">int</span>             random_access = 0;
00082 
00083 <span class="keywordtype">void</span>
00084 snmp_parse_args_usage(FILE * outf)
00085 {
00086     fprintf(outf, <span class="stringliteral">"[OPTIONS] AGENT"</span>);
00087 }
00088 
00089 <span class="keywordtype">void</span>
00090 snmp_parse_args_descriptions(FILE * outf)
00091 {
00092     fprintf(outf, <span class="stringliteral">"  Version:  %s\n"</span>, netsnmp_get_version());
00093     fprintf(outf, <span class="stringliteral">"  Web:      http://www.net-snmp.org/\n"</span>);
00094     fprintf(outf,
00095             <span class="stringliteral">"  Email:    net-snmp-coders@lists.sourceforge.net\n\nOPTIONS:\n"</span>);
00096     fprintf(outf, <span class="stringliteral">"  -h, --help\t\tdisplay this help message\n"</span>);
00097     fprintf(outf,
00098             <span class="stringliteral">"  -H\t\t\tdisplay configuration file directives understood\n"</span>);
00099     fprintf(outf, <span class="stringliteral">"  -v 1|2c|3\t\tspecifies SNMP version to use\n"</span>);
00100     fprintf(outf, <span class="stringliteral">"  -V, --version\t\tdisplay package version number\n"</span>);
00101 <span class="preprocessor">#if !defined(DISABLE_SNMPV1) || !defined(DISABLE_SNMPV2C)</span>
00102     fprintf(outf, <span class="stringliteral">"SNMP Version 1 or 2c specific\n"</span>);
00103     fprintf(outf, <span class="stringliteral">"  -c COMMUNITY\t\tset the community string\n"</span>);
00104 <span class="preprocessor">#endif </span><span class="comment">/* support for community based SNMP */</span>
00105     fprintf(outf, <span class="stringliteral">"SNMP Version 3 specific\n"</span>);
00106     fprintf(outf,
00107             <span class="stringliteral">"  -a PROTOCOL\t\tset authentication protocol (MD5|SHA)\n"</span>);
00108     fprintf(outf,
00109             <span class="stringliteral">"  -A PASSPHRASE\t\tset authentication protocol pass phrase\n"</span>);
00110     fprintf(outf,
00111             <span class="stringliteral">"  -e ENGINE-ID\t\tset security engine ID (e.g. 800000020109840301)\n"</span>);
00112     fprintf(outf,
00113             <span class="stringliteral">"  -E ENGINE-ID\t\tset context engine ID (e.g. 800000020109840301)\n"</span>);
00114     fprintf(outf,
00115             <span class="stringliteral">"  -l LEVEL\t\tset security level (noAuthNoPriv|authNoPriv|authPriv)\n"</span>);
00116     fprintf(outf, <span class="stringliteral">"  -n CONTEXT\t\tset context name (e.g. bridge1)\n"</span>);
00117     fprintf(outf, <span class="stringliteral">"  -u USER-NAME\t\tset security name (e.g. bert)\n"</span>);
00118 <span class="preprocessor">#ifdef HAVE_AES</span>
00119     fprintf(outf, <span class="stringliteral">"  -x PROTOCOL\t\tset privacy protocol (DES|AES)\n"</span>);
00120 <span class="preprocessor">#else</span>
00121     fprintf(outf, <span class="stringliteral">"  -x PROTOCOL\t\tset privacy protocol (DES)\n"</span>);
00122 <span class="preprocessor">#endif</span>
00123     fprintf(outf, <span class="stringliteral">"  -X PASSPHRASE\t\tset privacy protocol pass phrase\n"</span>);
00124     fprintf(outf,
00125             <span class="stringliteral">"  -Z BOOTS,TIME\t\tset destination engine boots/time\n"</span>);
00126     fprintf(outf, <span class="stringliteral">"General communication options\n"</span>);
00127     fprintf(outf, <span class="stringliteral">"  -r RETRIES\t\tset the number of retries\n"</span>);
00128     fprintf(outf,
00129             <span class="stringliteral">"  -t TIMEOUT\t\tset the request timeout (in seconds)\n"</span>);
00130     fprintf(outf, <span class="stringliteral">"Debugging\n"</span>);
00131     fprintf(outf, <span class="stringliteral">"  -d\t\t\tdump input/output packets in hexadecimal\n"</span>);
00132     fprintf(outf,
00133             <span class=
"stringliteral">"  -D TOKEN[,...]\tturn on debugging output for the specified TOKENs\n\t\t\t   (ALL gives extremely verbose debugging output)\n"</span>);
00134     fprintf(outf, <span class="stringliteral">"General options\n"</span>);
00135     fprintf(outf,
00136             <span class="stringliteral">"  -m MIB[:...]\t\tload given list of MIBs (ALL loads everything)\n"</span>);
00137     fprintf(outf,
00138             <span class="stringliteral">"  -M DIR[:...]\t\tlook in given list of directories for MIBs\n"</span>);
00139 <span class="preprocessor">#ifndef DISABLE_MIB_LOADING</span>
00140     fprintf(outf,
00141             <span class="stringliteral">"  -P MIBOPTS\t\tToggle various defaults controlling MIB parsing:\n"</span>);
00142     snmp_mib_toggle_options_usage(<span class="stringliteral">"\t\t\t  "</span>, outf);
00143 <span class="preprocessor">#endif</span>
00144     fprintf(outf,
00145             <span class="stringliteral">"  -O OUTOPTS\t\tToggle various defaults controlling output display:\n"</span>);
00146     snmp_out_toggle_options_usage(<span class="stringliteral">"\t\t\t  "</span>, outf);
00147     fprintf(outf,
00148             <span class="stringliteral">"  -I INOPTS\t\tToggle various defaults controlling input parsing:\n"</span>);
00149     <a class="code" href="group__mib__utilities.html#ga51">snmp_in_toggle_options_usage</a>(<span class=
"stringliteral">"\t\t\t  "</span>, outf);
00150     fprintf(outf,
00151             <span class="stringliteral">"  -L LOGOPTS\t\tToggle various defaults controlling logging:\n"</span>);
00152     snmp_log_options_usage(<span class="stringliteral">"\t\t\t  "</span>, outf);
00153     fflush(outf);
00154 }
00155 
00156 <span class="preprocessor">#define BUF_SIZE 512</span>
00157 
00158 <span class="keywordtype">void</span>
00159 handle_long_opt(<span class="keyword">const</span> <span class="keywordtype">char</span> *myoptarg)
00160 {
00161     <span class="keywordtype">char</span>           *cp, *cp2;
00162     <span class="comment">/*</span>
00163 <span class="comment">     * else it's a long option, so process it like name=value </span>
00164 <span class="comment">     */</span>
00165     cp = malloc(strlen(myoptarg) + 3);
00166     strcpy(cp, myoptarg);
00167     cp2 = strchr(cp, <span class="charliteral">'='</span>);
00168     <span class="keywordflow">if</span> (!cp2 &amp;&amp; !strchr(cp, <span class="charliteral">' '</span>)) {
00169         <span class="comment">/*</span>
00170 <span class="comment">         * well, they didn't specify an argument as far as we</span>
00171 <span class="comment">         * can tell.  Give them a '1' as the argument (which</span>
00172 <span class="comment">         * works for boolean tokens and a few others) and let</span>
00173 <span class="comment">         * them suffer from there if it's not what they</span>
00174 <span class="comment">         * wanted </span>
00175 <span class="comment">         */</span>
00176         strcat(cp, <span class="stringliteral">" 1"</span>);
00177     } <span class="keywordflow">else</span> {
00178         <span class="comment">/*</span>
00179 <span class="comment">         * replace the '=' with a ' ' </span>
00180 <span class="comment">         */</span>
00181         <span class="keywordflow">if</span> (cp2)
00182             *cp2 = <span class="charliteral">' '</span>;
00183     }
00184     netsnmp_config(cp);
00185     free(cp);
00186 }
00187 
00188 <span class="keyword">extern</span> <span class="keywordtype">int</span>      snmpv3_options(<span class=
"keywordtype">char</span> *optarg, <a class="code" href="structsnmp__session.html">netsnmp_session</a> * session,
00189                                <span class="keywordtype">char</span> **Apsz, <span class=
"keywordtype">char</span> **Xpsz, <span class="keywordtype">int</span> argc,
00190                                <span class="keywordtype">char</span> *<span class="keyword">const</span> *argv);
00191 
00192 <span class="comment">/*</span>
00193 <span class="comment"> * This method does the real work for snmp_parse_args.  It takes an</span>
00194 <span class="comment"> * extra argument, proxy, and uses this to decide how to handle the lack of</span>
00195 <span class="comment"> * of a community string.</span>
00196 <span class="comment"> */</span>
00197 <span class="keywordtype">int</span>
00198 snmp_parse_args(<span class="keywordtype">int</span> argc,
00199                 <span class="keywordtype">char</span> **argv,
00200                 <a class="code" href="structsnmp__session.html">netsnmp_session</a> * session, <span class=
"keyword">const</span> <span class="keywordtype">char</span> *localOpts,
00201                 <span class="keywordtype">void</span> (*proc) (<span class="keywordtype">int</span>, <span class=
"keywordtype">char</span> *<span class="keyword">const</span> *, <span class="keywordtype">int</span>))
00202 {
00203     <span class="keyword">static</span> <span class=
"keywordtype">char</span>    *sensitive[4] = { NULL, NULL, NULL, NULL };
00204     <span class="keywordtype">int</span>             arg, sp = 0, zero_sensitive = 1, testcase = 0;
00205     <span class="keywordtype">char</span>           *cp;
00206     <span class="keywordtype">char</span>           *Apsz = NULL;
00207     <span class="keywordtype">char</span>           *Xpsz = NULL;
00208     <span class="keywordtype">char</span>           *Cpsz = NULL;
00209     <span class="keywordtype">char</span>            Opts[BUF_SIZE];
00210     <span class="keywordtype">int</span>             logopt = 0;
00211 
00212     <span class="comment">/*</span>
00213 <span class="comment">     * initialize session to default values </span>
00214 <span class="comment">     */</span>
00215     snmp_sess_init(session);
00216     strcpy(Opts, <span class="stringliteral">"Y:VhHm:M:O:I:P:D:dv:r:t:c:Z:e:E:n:u:l:x:X:a:A:p:T:-:3:s:S:L:"</span>);
00217     <span class="keywordflow">if</span> (localOpts)
00218         strcat(Opts, localOpts);
00219 
00220     <span class="keywordflow">if</span> (strcmp(argv[0], <span class="stringliteral">"snmpd-trapsess"</span>) == 0 ||
00221         strcmp(argv[0], <span class="stringliteral">"snmpd-proxy"</span>)    == 0) {
00222         <span class="comment">/*  Don't worry about zeroing sensitive parameters as they are not</span>
00223 <span class="comment">            on the command line anyway (called from internal config-line</span>
00224 <span class="comment">            handler).  */</span>
00225         zero_sensitive = 0;
00226     }
00227 
00228     <span class="comment">/*</span>
00229 <span class="comment">     * get the options </span>
00230 <span class="comment">     */</span>
00231     DEBUGMSGTL((<span class="stringliteral">"snmp_parse_args"</span>, <span class=
"stringliteral">"starting: %d/%d\n"</span>, optind, argc));
00232     <span class="keywordflow">for</span> (arg = 0; arg &lt; argc; arg++) {
00233         DEBUGMSGTL((<span class="stringliteral">"snmp_parse_args"</span>, <span class=
"stringliteral">" arg %d = %s\n"</span>, arg, argv[arg]));
00234     }
00235 
00236     optind = 1;
00237     <span class="keywordflow">while</span> ((arg = getopt(argc, argv, Opts)) != EOF) {
00238         DEBUGMSGTL((<span class="stringliteral">"snmp_parse_args"</span>, <span class=
"stringliteral">"handling (#%d): %c\n"</span>, optind, arg));
00239         <span class="keywordflow">switch</span> (arg) {
00240         <span class="keywordflow">case</span> <span class="charliteral">'-'</span>:
00241             <span class="keywordflow">if</span> (strcasecmp(optarg, <span class="stringliteral">"help"</span>) == 0) {
00242                 <span class="keywordflow">return</span> (-1);
00243             }
00244             <span class="keywordflow">if</span> (strcasecmp(optarg, <span class="stringliteral">"version"</span>) == 0) {
00245                 fprintf(stderr,<span class="stringliteral">"NET-SNMP version: %s\n"</span>,netsnmp_get_version());
00246                 <span class="keywordflow">return</span> (-2);
00247             }
00248 
00249             handle_long_opt(optarg);
00250             <span class="keywordflow">break</span>;
00251 
00252         <span class="keywordflow">case</span> <span class="charliteral">'V'</span>:
00253             fprintf(stderr, <span class="stringliteral">"NET-SNMP version: %s\n"</span>, netsnmp_get_version());
00254             <span class="keywordflow">return</span> (-2);
00255 
00256         <span class="keywordflow">case</span> <span class="charliteral">'h'</span>:
00257             <span class="keywordflow">return</span> (-1);
00258             <span class="keywordflow">break</span>;
00259 
00260         <span class="keywordflow">case</span> <span class="charliteral">'H'</span>:
00261             <a class="code" href="group__library.html#ga51">init_snmp</a>(<span class="stringliteral">"snmpapp"</span>);
00262             fprintf(stderr, <span class="stringliteral">"Configuration directives understood:\n"</span>);
00263             read_config_print_usage(<span class="stringliteral">"  "</span>);
00264             <span class="keywordflow">return</span> (-2);
00265 
00266         <span class="keywordflow">case</span> <span class="charliteral">'Y'</span>:
00267             netsnmp_config_remember(optarg);
00268             <span class="keywordflow">break</span>;
00269 
00270 <span class="preprocessor">#ifndef DISABLE_MIB_LOADING</span>
00271         <span class="keywordflow">case</span> <span class="charliteral">'m'</span>:
00272             setenv(<span class="stringliteral">"MIBS"</span>, optarg, 1);
00273             <span class="keywordflow">break</span>;
00274 
00275         <span class="keywordflow">case</span> <span class="charliteral">'M'</span>:
00276             <a class="code" href="group__mib__utilities.html#ga53">netsnmp_set_mib_directory</a>(optarg);
00277             <span class="keywordflow">break</span>;
00278 <span class="preprocessor">#endif </span><span class="comment">/* DISABLE_MIB_LOADING */</span>
00279 
00280         <span class="keywordflow">case</span> <span class="charliteral">'O'</span>:
00281             cp = snmp_out_toggle_options(optarg);
00282             <span class="keywordflow">if</span> (cp != NULL) {
00283                 fprintf(stderr, <span class="stringliteral">"Unknown output option passed to -O: %c.\n"</span>, 
00284                         *cp);
00285                 <span class="keywordflow">return</span> (-1);
00286             }
00287             <span class="keywordflow">break</span>;
00288 
00289         <span class="keywordflow">case</span> <span class="charliteral">'I'</span>:
00290             cp = snmp_in_options(optarg, argc, argv);
00291             <span class="keywordflow">if</span> (cp != NULL) {
00292                 fprintf(stderr, <span class="stringliteral">"Unknown input option passed to -I: %c.\n"</span>,
00293                         *cp);
00294                 <span class="keywordflow">return</span> (-1);
00295             }
00296             <span class="keywordflow">break</span>;
00297 
00298 <span class="preprocessor">#ifndef DISABLE_MIB_LOADING</span>
00299         <span class="keywordflow">case</span> <span class="charliteral">'P'</span>:
00300             cp = snmp_mib_toggle_options(optarg);
00301             <span class="keywordflow">if</span> (cp != NULL) {
00302                 fprintf(stderr,
00303                         <span class="stringliteral">"Unknown parsing option passed to -P: %c.\n"</span>, *cp);
00304                 <span class="keywordflow">return</span> (-1);
00305             }
00306             <span class="keywordflow">break</span>;
00307 <span class="preprocessor">#endif </span><span class="comment">/* DISABLE_MIB_LOADING */</span>
00308 
00309         <span class="keywordflow">case</span> <span class="charliteral">'D'</span>:
00310             debug_register_tokens(optarg);
00311             snmp_set_do_debugging(1);
00312             <span class="keywordflow">break</span>;
00313 
00314         <span class="keywordflow">case</span> <span class="charliteral">'d'</span>:
00315             <a class="code" href="group__default__store.html#ga8">netsnmp_ds_set_boolean</a>(NETSNMP_DS_LIBRARY_ID, 
00316                                    NETSNMP_DS_LIB_DUMP_PACKET, 1);
00317             <span class="keywordflow">break</span>;
00318 
00319         <span class="keywordflow">case</span> <span class="charliteral">'v'</span>:
00320             session-&gt;<a class="code" href="structsnmp__session.html#o0">version</a> = -1;
00321 <span class="preprocessor">#ifndef DISABLE_SNMPV1</span>
00322             <span class="keywordflow">if</span> (!strcmp(optarg, <span class="stringliteral">"1"</span>)) {
00323                 session-&gt;<a class="code" href="structsnmp__session.html#o0">version</a> = SNMP_VERSION_1;
00324             }
00325 <span class="preprocessor">#endif</span>
00326 <span class="preprocessor">#ifndef DISABLE_SNMPV2C</span>
00327             <span class="keywordflow">if</span> (!strcasecmp(optarg, <span class="stringliteral">"2c"</span>)) {
00328                 session-&gt;<a class="code" href="structsnmp__session.html#o0">version</a> = SNMP_VERSION_2c;
00329             }
00330 <span class="preprocessor">#endif</span>
00331             <span class="keywordflow">if</span> (!strcasecmp(optarg, <span class="stringliteral">"3"</span>)) {
00332                 session-&gt;<a class="code" href="structsnmp__session.html#o0">version</a> = SNMP_VERSION_3;
00333             }
00334             <span class="keywordflow">if</span> (session-&gt;<a class="code" href=
"structsnmp__session.html#o0">version</a> == -1) {
00335                 fprintf(stderr,
00336                         <span class="stringliteral">"Invalid version specified after -v flag: %s\n"</span>,
00337                         optarg);
00338                 <span class="keywordflow">return</span> (-1);
00339             }
00340             <span class="keywordflow">break</span>;
00341 
00342         <span class="keywordflow">case</span> <span class="charliteral">'p'</span>:
00343             fprintf(stderr, <span class="stringliteral">"Warning: -p option is no longer used - "</span>);
00344             fprintf(stderr, <span class="stringliteral">"specify the remote host as HOST:PORT\n"</span>);
00345             <span class="keywordflow">return</span> (-1);
00346             <span class="keywordflow">break</span>;
00347 
00348         <span class="keywordflow">case</span> <span class="charliteral">'T'</span>:
00349             fprintf(stderr, <span class="stringliteral">"Warning: -T option is no longer used - "</span>);
00350             fprintf(stderr, <span class="stringliteral">"specify the remote host as TRANSPORT:HOST\n"</span>);
00351             <span class="keywordflow">return</span> (-1);
00352             <span class="keywordflow">break</span>;
00353 
00354         <span class="keywordflow">case</span> <span class="charliteral">'t'</span>:
00355             session-&gt;<a class="code" href="structsnmp__session.html#o2">timeout</a> = atoi(optarg) * 1000000L;
00356             <span class="keywordflow">if</span> (session-&gt;<a class="code" href=
"structsnmp__session.html#o2">timeout</a> &lt; 0 || !isdigit(optarg[0])) {
00357                 fprintf(stderr, <span class="stringliteral">"Invalid timeout in seconds after -t flag.\n"</span>);
00358                 <span class="keywordflow">return</span> (-1);
00359             }
00360             <span class="keywordflow">break</span>;
00361 
00362         <span class="keywordflow">case</span> <span class="charliteral">'r'</span>:
00363             session-&gt;<a class="code" href="structsnmp__session.html#o1">retries</a> = atoi(optarg);
00364             <span class="keywordflow">if</span> (session-&gt;<a class="code" href=
"structsnmp__session.html#o1">retries</a> &lt; 0 || !isdigit(optarg[0])) {
00365                 fprintf(stderr, <span class="stringliteral">"Invalid number of retries after -r flag.\n"</span>);
00366                 <span class="keywordflow">return</span> (-1);
00367             }
00368             <span class="keywordflow">break</span>;
00369 
00370         <span class="keywordflow">case</span> <span class="charliteral">'c'</span>:
00371             <span class="keywordflow">if</span> (zero_sensitive) {
00372                 <span class="keywordflow">if</span> ((sensitive[sp] = strdup(optarg)) != NULL) {
00373                     Cpsz = sensitive[sp];
00374                     memset(optarg, <span class="charliteral">'\0'</span>, strlen(optarg));
00375                     sp++;
00376                 } <span class="keywordflow">else</span> {
00377                     fprintf(stderr, <span class="stringliteral">"malloc failure processing -c flag.\n"</span>);
00378                     <span class="keywordflow">return</span> -1;
00379                 }
00380             } <span class="keywordflow">else</span> {
00381                 Cpsz = optarg;
00382             }
00383             <span class="keywordflow">break</span>;
00384 
00385         <span class="keywordflow">case</span> <span class="charliteral">'3'</span>:
00386             <span class="comment">/*  TODO: This needs to zero things too.  */</span>
00387             <span class="keywordflow">if</span> (snmpv3_options(optarg, session, &amp;Apsz, &amp;Xpsz, argc, argv) &lt; 0){
00388                 <span class="keywordflow">return</span> (-1);
00389             }
00390             <span class="keywordflow">break</span>;
00391 
00392         <span class="keywordflow">case</span> <span class="charliteral">'L'</span>:
00393             <span class="keywordflow">if</span> (snmp_log_options(optarg, argc, argv) &lt; 0) {
00394                 <span class="keywordflow">return</span> (-1);
00395             }
00396             logopt = 1;
00397             <span class="keywordflow">break</span>;
00398 
00399 <span class="preprocessor">#define SNMPV3_CMD_OPTIONS</span>
00400 <span class="preprocessor">#ifdef  SNMPV3_CMD_OPTIONS</span>
00401         <span class="keywordflow">case</span> <span class="charliteral">'Z'</span>:
00402             session-&gt;<a class="code" href="structsnmp__session.html#o23">engineBoots</a> = strtoul(optarg, NULL, 10);
00403             <span class="keywordflow">if</span> (session-&gt;<a class="code" href=
"structsnmp__session.html#o23">engineBoots</a> == 0 || !isdigit(optarg[0])) {
00404                 fprintf(stderr, <span class="stringliteral">"Need engine boots value after -Z flag.\n"</span>);
00405                 <span class="keywordflow">return</span> (-1);
00406             }
00407             cp = strchr(optarg, <span class="charliteral">','</span>);
00408             <span class="keywordflow">if</span> (cp &amp;&amp; *(++cp) &amp;&amp; isdigit(*cp))
00409                 session-&gt;<a class="code" href="structsnmp__session.html#o24">engineTime</a> = strtoul(cp, NULL, 10);
00410             <span class="comment">/*</span>
00411 <span class="comment">             * Handle previous '-Z boot time' syntax </span>
00412 <span class="comment">             */</span>
00413             <span class="keywordflow">else</span> <span class=
"keywordflow">if</span> ((optind &lt; argc) &amp;&amp; isdigit(argv[optind][0]))
00414                 session-&gt;<a class="code" href=
"structsnmp__session.html#o24">engineTime</a> = strtoul(argv[optind], NULL, 10);
00415             <span class="keywordflow">else</span> {
00416                 fprintf(stderr, <span class="stringliteral">"Need engine time value after -Z flag.\n"</span>);
00417                 <span class="keywordflow">return</span> (-1);
00418             }
00419             <span class="keywordflow">break</span>;
00420 
00421         <span class="keywordflow">case</span> <span class="charliteral">'e'</span>:{
00422                 size_t ebuf_len = 32, eout_len = 0;
00423                 u_char *ebuf = (u_char *)malloc(ebuf_len);
00424 
00425                 <span class="keywordflow">if</span> (ebuf == NULL) {
00426                     fprintf(stderr, <span class="stringliteral">"malloc failure processing -e flag.\n"</span>);
00427                     <span class="keywordflow">return</span> (-1);
00428                 }
00429                 <span class="keywordflow">if</span> (!<a class="code" href="group__util.html#ga8">snmp_hex_to_binary</a>
00430                     (&amp;ebuf, &amp;ebuf_len, &amp;eout_len, 1, optarg)) {
00431                     fprintf(stderr, <span class="stringliteral">"Bad engine ID value after -e flag.\n"</span>);
00432                     free(ebuf);
00433                     <span class="keywordflow">return</span> (-1);
00434                 }
00435                 session-&gt;<a class="code" href="structsnmp__session.html#o27">securityEngineID</a> = ebuf;
00436                 session-&gt;<a class="code" href="structsnmp__session.html#o28">securityEngineIDLen</a> = eout_len;
00437                 <span class="keywordflow">break</span>;
00438             }
00439 
00440         <span class="keywordflow">case</span> <span class="charliteral">'E'</span>:{
00441                 size_t ebuf_len = 32, eout_len = 0;
00442                 u_char *ebuf = (u_char *)malloc(ebuf_len);
00443 
00444                 <span class="keywordflow">if</span> (ebuf == NULL) {
00445                     fprintf(stderr, <span class="stringliteral">"malloc failure processing -E flag.\n"</span>);
00446                     <span class="keywordflow">return</span> (-1);
00447                 }
00448                 <span class="keywordflow">if</span> (!<a class="code" href=
"group__util.html#ga8">snmp_hex_to_binary</a>(&amp;ebuf, &amp;ebuf_len,
00449                                         &amp;eout_len, 1, optarg)) {
00450                     fprintf(stderr, <span class="stringliteral">"Bad engine ID value after -E flag.\n"</span>);
00451                     free(ebuf);
00452                     <span class="keywordflow">return</span> (-1);
00453                 }
00454                 session-&gt;<a class="code" href="structsnmp__session.html#o21">contextEngineID</a> = ebuf;
00455                 session-&gt;<a class="code" href="structsnmp__session.html#o22">contextEngineIDLen</a> = eout_len;
00456                 <span class="keywordflow">break</span>;
00457             }
00458 
00459         <span class="keywordflow">case</span> <span class="charliteral">'n'</span>:
00460             session-&gt;<a class="code" href="structsnmp__session.html#o25">contextName</a> = optarg;
00461             session-&gt;<a class="code" href="structsnmp__session.html#o26">contextNameLen</a> = strlen(optarg);
00462             <span class="keywordflow">break</span>;
00463 
00464         <span class="keywordflow">case</span> <span class="charliteral">'u'</span>:
00465             <span class="keywordflow">if</span> (zero_sensitive) {
00466                 <span class="keywordflow">if</span> ((sensitive[sp] = strdup(optarg)) != NULL) {
00467                     session-&gt;<a class="code" href="structsnmp__session.html#o29">securityName</a> = sensitive[sp];
00468                     session-&gt;<a class="code" href=
"structsnmp__session.html#o30">securityNameLen</a> = strlen(sensitive[sp]);
00469                     memset(optarg, <span class="charliteral">'\0'</span>, strlen(optarg));
00470                     sp++;
00471                 } <span class="keywordflow">else</span> {
00472                     fprintf(stderr, <span class="stringliteral">"malloc failure processing -u flag.\n"</span>);
00473                     <span class="keywordflow">return</span> -1;
00474                 }
00475             } <span class="keywordflow">else</span> {
00476                 session-&gt;<a class="code" href="structsnmp__session.html#o29">securityName</a> = optarg;
00477                 session-&gt;<a class="code" href="structsnmp__session.html#o30">securityNameLen</a> = strlen(optarg);
00478             }
00479             <span class="keywordflow">break</span>;
00480 
00481         <span class="keywordflow">case</span> <span class="charliteral">'l'</span>:
00482             <span class="keywordflow">if</span> (!strcasecmp(optarg, <span class=
"stringliteral">"noAuthNoPriv"</span>) || !strcmp(optarg, <span class="stringliteral">"1"</span>)
00483                 || !strcasecmp(optarg, <span class="stringliteral">"noauth"</span>)
00484                 || !strcasecmp(optarg, <span class="stringliteral">"nanp"</span>)) {
00485                 session-&gt;<a class="code" href="structsnmp__session.html#o44">securityLevel</a> = SNMP_SEC_LEVEL_NOAUTH;
00486             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(optarg, <span class=
"stringliteral">"authNoPriv"</span>)
00487                        || !strcmp(optarg, <span class="stringliteral">"2"</span>)
00488                        || !strcasecmp(optarg, <span class="stringliteral">"auth"</span>)
00489                        || !strcasecmp(optarg, <span class="stringliteral">"anp"</span>)) {
00490                 session-&gt;<a class="code" href=
"structsnmp__session.html#o44">securityLevel</a> = SNMP_SEC_LEVEL_AUTHNOPRIV;
00491             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(optarg, <span class=
"stringliteral">"authPriv"</span>)
00492                        || !strcmp(optarg, <span class="stringliteral">"3"</span>)
00493                        || !strcasecmp(optarg, <span class="stringliteral">"priv"</span>)
00494                        || !strcasecmp(optarg, <span class="stringliteral">"ap"</span>)) {
00495                 session-&gt;<a class="code" href=
"structsnmp__session.html#o44">securityLevel</a> = SNMP_SEC_LEVEL_AUTHPRIV;
00496             } <span class="keywordflow">else</span> {
00497                 fprintf(stderr,
00498                         <span class="stringliteral">"Invalid security level specified after -l flag: %s\n"</span>,
00499                         optarg);
00500                 <span class="keywordflow">return</span> (-1);
00501             }
00502 
00503             <span class="keywordflow">break</span>;
00504 
00505         <span class="keywordflow">case</span> <span class="charliteral">'a'</span>:
00506 <span class="preprocessor">#ifndef DISABLE_MD5</span>
00507             <span class="keywordflow">if</span> (!strcasecmp(optarg, <span class="stringliteral">"MD5"</span>)) {
00508                 session-&gt;<a class="code" href=
"structsnmp__session.html#o31">securityAuthProto</a> = usmHMACMD5AuthProtocol;
00509                 session-&gt;<a class="code" href=
"structsnmp__session.html#o32">securityAuthProtoLen</a> = USM_AUTH_PROTO_MD5_LEN;
00510             } <span class="keywordflow">else</span>
00511 <span class="preprocessor">#endif</span>
00512                 <span class="keywordflow">if</span> (!strcasecmp(optarg, <span class="stringliteral">"SHA"</span>)) {
00513                 session-&gt;<a class="code" href=
"structsnmp__session.html#o31">securityAuthProto</a> = usmHMACSHA1AuthProtocol;
00514                 session-&gt;<a class="code" href=
"structsnmp__session.html#o32">securityAuthProtoLen</a> = USM_AUTH_PROTO_SHA_LEN;
00515             } <span class="keywordflow">else</span> {
00516                 fprintf(stderr,
00517                         <span class="stringliteral">"Invalid authentication protocol specified after -a flag: %s\n"</span>,
00518                         optarg);
00519                 <span class="keywordflow">return</span> (-1);
00520             }
00521             <span class="keywordflow">break</span>;
00522 
00523         <span class="keywordflow">case</span> <span class="charliteral">'x'</span>:
00524             testcase = 0;
00525 <span class="preprocessor">#ifndef DISABLE_DES</span>
00526             <span class="keywordflow">if</span> (!strcasecmp(optarg, <span class="stringliteral">"DES"</span>)) {
00527                 testcase = 1;
00528                 session-&gt;<a class="code" href="structsnmp__session.html#o37">securityPrivProto</a> = usmDESPrivProtocol;
00529                 session-&gt;<a class="code" href=
"structsnmp__session.html#o38">securityPrivProtoLen</a> = USM_PRIV_PROTO_DES_LEN;
00530             }
00531 <span class="preprocessor">#endif</span>
00532 <span class="preprocessor">#ifdef HAVE_AES</span>
00533             <span class="keywordflow">if</span> (!strcasecmp(optarg, <span class="stringliteral">"AES128"</span>) ||
00534                 !strcasecmp(optarg, <span class="stringliteral">"AES"</span>)) {
00535                 testcase = 1;
00536                 session-&gt;<a class="code" href="structsnmp__session.html#o37">securityPrivProto</a> = usmAESPrivProtocol;
00537                 session-&gt;<a class="code" href=
"structsnmp__session.html#o38">securityPrivProtoLen</a> = USM_PRIV_PROTO_AES_LEN;
00538             }
00539 <span class="preprocessor">#endif</span>
00540             <span class="keywordflow">if</span> (testcase == 0) {
00541                 fprintf(stderr,
00542                       <span class="stringliteral">"Invalid privacy protocol specified after -x flag: %s\n"</span>,
00543                         optarg);
00544                 <span class="keywordflow">return</span> (-1);
00545             }
00546             <span class="keywordflow">break</span>;
00547 
00548         <span class="keywordflow">case</span> <span class="charliteral">'A'</span>:
00549             <span class="keywordflow">if</span> (zero_sensitive) {
00550                 <span class="keywordflow">if</span> ((sensitive[sp] = strdup(optarg)) != NULL) {
00551                     Apsz = sensitive[sp];
00552                     memset(optarg, <span class="charliteral">'\0'</span>, strlen(optarg));
00553                     sp++;
00554                 } <span class="keywordflow">else</span> {
00555                     fprintf(stderr, <span class="stringliteral">"malloc failure processing -A flag.\n"</span>);
00556                     <span class="keywordflow">return</span> -1;
00557                 }
00558             } <span class="keywordflow">else</span> {
00559                 Apsz = optarg;
00560             }
00561             <span class="keywordflow">break</span>;
00562 
00563         <span class="keywordflow">case</span> <span class="charliteral">'X'</span>:
00564             <span class="keywordflow">if</span> (zero_sensitive) {
00565                 <span class="keywordflow">if</span> ((sensitive[sp] = strdup(optarg)) != NULL) {
00566                     Xpsz = sensitive[sp];
00567                     memset(optarg, <span class="charliteral">'\0'</span>, strlen(optarg));
00568                     sp++;
00569                 } <span class="keywordflow">else</span> {
00570                     fprintf(stderr, <span class="stringliteral">"malloc failure processing -X flag.\n"</span>);
00571                     <span class="keywordflow">return</span> -1;
00572                 }
00573             } <span class="keywordflow">else</span> {
00574                 Xpsz = optarg;
00575             }
00576             <span class="keywordflow">break</span>;
00577 <span class="preprocessor">#endif                          </span><span class="comment">/* SNMPV3_CMD_OPTIONS */</span>
00578 
00579         <span class="keywordflow">case</span> <span class="charliteral">'?'</span>:
00580             <span class="keywordflow">return</span> (-1);
00581             <span class="keywordflow">break</span>;
00582 
00583         <span class="keywordflow">default</span>:
00584             proc(argc, argv, arg);
00585             <span class="keywordflow">break</span>;
00586         }
00587     }
00588     DEBUGMSGTL((<span class="stringliteral">"snmp_parse_args"</span>, <span class=
"stringliteral">"finished: %d/%d\n"</span>, optind, argc));
00589     
00590     <span class="keywordflow">if</span> (!logopt)
00591         snmp_enable_stderrlog();
00592 
00593     <span class="comment">/*</span>
00594 <span class="comment">     * read in MIB database and initialize the snmp library</span>
00595 <span class="comment">     */</span>
00596     <a class="code" href="group__library.html#ga51">init_snmp</a>(<span class="stringliteral">"snmpapp"</span>);
00597 
00598     <span class="comment">/*</span>
00599 <span class="comment">     * session default version </span>
00600 <span class="comment">     */</span>
00601     <span class="keywordflow">if</span> (session-&gt;<a class="code" href=
"structsnmp__session.html#o0">version</a> == SNMP_DEFAULT_VERSION) {
00602         <span class="comment">/*</span>
00603 <span class="comment">         * run time default version </span>
00604 <span class="comment">         */</span>
00605         session-&gt;<a class="code" href=
"structsnmp__session.html#o0">version</a> = netsnmp_ds_get_int(NETSNMP_DS_LIBRARY_ID, 
00606                                               NETSNMP_DS_LIB_SNMPVERSION);
00607 
00608         <span class="comment">/*</span>
00609 <span class="comment">         * compile time default version </span>
00610 <span class="comment">         */</span>
00611         <span class="keywordflow">if</span> (!session-&gt;<a class="code" href="structsnmp__session.html#o0">version</a>) {
00612             <span class="keywordflow">switch</span> (DEFAULT_SNMP_VERSION) {
00613 <span class="preprocessor">#ifndef DISABLE_SNMPV1</span>
00614             <span class="keywordflow">case</span> 1:
00615                 session-&gt;<a class="code" href="structsnmp__session.html#o0">version</a> = SNMP_VERSION_1;
00616                 <span class="keywordflow">break</span>;
00617 <span class="preprocessor">#endif</span>
00618 
00619 <span class="preprocessor">#ifndef DISABLE_SNMPV2C</span>
00620             <span class="keywordflow">case</span> 2:
00621                 session-&gt;<a class="code" href="structsnmp__session.html#o0">version</a> = SNMP_VERSION_2c;
00622                 <span class="keywordflow">break</span>;
00623 <span class="preprocessor">#endif</span>
00624 
00625             <span class="keywordflow">case</span> 3:
00626                 session-&gt;<a class="code" href="structsnmp__session.html#o0">version</a> = SNMP_VERSION_3;
00627                 <span class="keywordflow">break</span>;
00628 
00629             <span class="keywordflow">default</span>:
00630                 <a class="code" href="group__snmp__logging.html#ga39">snmp_log</a>(LOG_ERR, <span class=
"stringliteral">"Can't determine a valid SNMP version for the session\n"</span>);
00631                 <span class="keywordflow">return</span>(-2);
00632             }
00633         } <span class="keywordflow">else</span> {
00634 <span class="preprocessor">#ifndef DISABLE_SNMPV1</span>
00635             <span class="keywordflow">if</span> (session-&gt;<a class="code" href=
"structsnmp__session.html#o0">version</a> == NETSNMP_DS_SNMP_VERSION_1)  <span class=
"comment">/* bogus value.  version 1 actually = 0 */</span>
00636                 session-&gt;<a class="code" href="structsnmp__session.html#o0">version</a> = SNMP_VERSION_1;
00637 <span class="preprocessor">#endif</span>
00638         }
00639     }
00640 
00641     <span class="comment">/*</span>
00642 <span class="comment">     * make master key from pass phrases </span>
00643 <span class="comment">     */</span>
00644     <span class="keywordflow">if</span> (Apsz) {
00645         session-&gt;<a class="code" href="structsnmp__session.html#o34">securityAuthKeyLen</a> = USM_AUTH_KU_LEN;
00646         <span class="keywordflow">if</span> (session-&gt;<a class="code" href=
"structsnmp__session.html#o31">securityAuthProto</a> == NULL) {
00647             <span class="comment">/*</span>
00648 <span class="comment">             * get .conf set default </span>
00649 <span class="comment">             */</span>
00650             <span class="keyword">const</span> oid      *def =
00651                 get_default_authtype(&amp;session-&gt;<a class="code" href=
"structsnmp__session.html#o32">securityAuthProtoLen</a>);
00652             session-&gt;<a class="code" href="structsnmp__session.html#o31">securityAuthProto</a> =
00653                 snmp_duplicate_objid(def, session-&gt;<a class="code" href=
"structsnmp__session.html#o32">securityAuthProtoLen</a>);
00654         }
00655         <span class="keywordflow">if</span> (session-&gt;<a class="code" href=
"structsnmp__session.html#o31">securityAuthProto</a> == NULL) {
00656 <span class="preprocessor">#ifndef DISABLE_MD5</span>
00657             <span class="comment">/*</span>
00658 <span class="comment">             * assume MD5</span>
00659 <span class="comment">             */</span>
00660             session-&gt;<a class="code" href="structsnmp__session.html#o31">securityAuthProto</a> =
00661                 snmp_duplicate_objid(usmHMACMD5AuthProtocol,
00662                                      USM_AUTH_PROTO_MD5_LEN);
00663             session-&gt;<a class="code" href=
"structsnmp__session.html#o32">securityAuthProtoLen</a> = USM_AUTH_PROTO_MD5_LEN;
00664 <span class="preprocessor">#else</span>
00665             session-&gt;<a class="code" href="structsnmp__session.html#o31">securityAuthProto</a> =
00666                 snmp_duplicate_objid(usmHMACSHA1AuthProtocol,
00667                                      USM_AUTH_PROTO_SHA_LEN);
00668             session-&gt;<a class="code" href=
"structsnmp__session.html#o32">securityAuthProtoLen</a> = USM_AUTH_PROTO_SHA_LEN;
00669 <span class="preprocessor">#endif</span>
00670         }
00671         <span class="keywordflow">if</span> (generate_Ku(session-&gt;<a class="code" href=
"structsnmp__session.html#o31">securityAuthProto</a>,
00672                         session-&gt;<a class="code" href="structsnmp__session.html#o32">securityAuthProtoLen</a>,
00673                         (u_char *) Apsz, strlen(Apsz),
00674                         session-&gt;<a class="code" href="structsnmp__session.html#o33">securityAuthKey</a>,
00675                         &amp;session-&gt;<a class="code" href=
"structsnmp__session.html#o34">securityAuthKeyLen</a>) != SNMPERR_SUCCESS) {
00676             snmp_perror(argv[0]);
00677             fprintf(stderr,
00678                     <span class=
"stringliteral">"Error generating a key (Ku) from the supplied authentication pass phrase. \n"</span>);
00679             <span class="keywordflow">return</span> (-2);
00680         }
00681     }
00682     <span class="keywordflow">if</span> (Xpsz) {
00683         session-&gt;<a class="code" href="structsnmp__session.html#o40">securityPrivKeyLen</a> = USM_PRIV_KU_LEN;
00684         <span class="keywordflow">if</span> (session-&gt;<a class="code" href=
"structsnmp__session.html#o37">securityPrivProto</a> == NULL) {
00685             <span class="comment">/*</span>
00686 <span class="comment">             * get .conf set default </span>
00687 <span class="comment">             */</span>
00688             <span class="keyword">const</span> oid      *def =
00689                 get_default_privtype(&amp;session-&gt;<a class="code" href=
"structsnmp__session.html#o38">securityPrivProtoLen</a>);
00690             session-&gt;<a class="code" href="structsnmp__session.html#o37">securityPrivProto</a> =
00691                 snmp_duplicate_objid(def, session-&gt;<a class="code" href=
"structsnmp__session.html#o38">securityPrivProtoLen</a>);
00692         }
00693         <span class="keywordflow">if</span> (session-&gt;<a class="code" href=
"structsnmp__session.html#o37">securityPrivProto</a> == NULL) {
00694             <span class="comment">/*</span>
00695 <span class="comment">             * assume DES </span>
00696 <span class="comment">             */</span>
00697 <span class="preprocessor">#ifndef DISABLE_DES</span>
00698             session-&gt;<a class="code" href="structsnmp__session.html#o37">securityPrivProto</a> =
00699                 snmp_duplicate_objid(usmDESPrivProtocol,
00700                                      USM_PRIV_PROTO_DES_LEN);
00701             session-&gt;<a class="code" href=
"structsnmp__session.html#o38">securityPrivProtoLen</a> = USM_PRIV_PROTO_DES_LEN;
00702 <span class="preprocessor">#else</span>
00703             session-&gt;<a class="code" href="structsnmp__session.html#o37">securityPrivProto</a> =
00704                 snmp_duplicate_objid(usmAESPrivProtocol,
00705                                      USM_PRIV_PROTO_AES_LEN);
00706             session-&gt;<a class="code" href=
"structsnmp__session.html#o38">securityPrivProtoLen</a> = USM_PRIV_PROTO_AES_LEN;
00707 <span class="preprocessor">#endif</span>
00708 
00709         }
00710         <span class="keywordflow">if</span> (generate_Ku(session-&gt;<a class="code" href=
"structsnmp__session.html#o31">securityAuthProto</a>,
00711                         session-&gt;<a class="code" href="structsnmp__session.html#o32">securityAuthProtoLen</a>,
00712                         (u_char *) Xpsz, strlen(Xpsz),
00713                         session-&gt;<a class="code" href="structsnmp__session.html#o39">securityPrivKey</a>,
00714                         &amp;session-&gt;<a class="code" href=
"structsnmp__session.html#o40">securityPrivKeyLen</a>) != SNMPERR_SUCCESS) {
00715             snmp_perror(argv[0]);
00716             fprintf(stderr,
00717                     <span class=
"stringliteral">"Error generating a key (Ku) from the supplied privacy pass phrase. \n"</span>);
00718             <span class="keywordflow">return</span> (-2);
00719         }
00720     }
00721     <span class="comment">/*</span>
00722 <span class="comment">     * get the hostname </span>
00723 <span class="comment">     */</span>
00724     <span class="keywordflow">if</span> (optind == argc) {
00725         fprintf(stderr, <span class="stringliteral">"No hostname specified.\n"</span>);
00726         <span class="keywordflow">return</span> (-1);
00727     }
00728     session-&gt;<a class="code" href="structsnmp__session.html#o6">peername</a> = argv[optind++]; <span class=
"comment">/* hostname */</span>
00729 
00730 <span class="preprocessor">#if !defined(DISABLE_SNMPV1) || !defined(DISABLE_SNMPV2C)</span>
00731     <span class="comment">/*</span>
00732 <span class="comment">     * If v1 or v2c, check community has been set, either by a -c option above,</span>
00733 <span class="comment">     * or via a default token somewhere.  </span>
00734 <span class="comment">     * If neither, it will be taken from the incoming request PDU.</span>
00735 <span class="comment">     */</span>
00736 
00737     <span class="keywordflow">if</span> (session-&gt;<a class="code" href=
"structsnmp__session.html#o0">version</a> == SNMP_VERSION_1 ||
00738         session-&gt;<a class="code" href="structsnmp__session.html#o0">version</a> == SNMP_VERSION_2c) {
00739         <span class="keywordflow">if</span> (Cpsz == NULL) {
00740             Cpsz = netsnmp_ds_get_string(NETSNMP_DS_LIBRARY_ID, 
00741                                          NETSNMP_DS_LIB_COMMUNITY);
00742             <span class="keywordflow">if</span> (Cpsz == NULL) {
00743                 <span class="keywordflow">if</span> (netsnmp_ds_get_boolean(NETSNMP_DS_LIBRARY_ID,
00744                                            NETSNMP_DS_LIB_IGNORE_NO_COMMUNITY)){
00745                     DEBUGMSGTL((<span class="stringliteral">"snmp_parse_args"</span>,
00746                                 <span class="stringliteral">"ignoring that the community string is not present\n"</span>));
00747                     session-&gt;<a class="code" href="structsnmp__session.html#o16">community</a> = NULL;
00748                     session-&gt;<a class="code" href="structsnmp__session.html#o17">community_len</a> = 0;
00749                 } <span class="keywordflow">else</span> {
00750                     fprintf(stderr, <span class="stringliteral">"No community name specified.\n"</span>);
00751                     <span class="keywordflow">return</span> (-1);
00752                 }
00753             }
00754         } <span class="keywordflow">else</span> {
00755             session-&gt;<a class="code" href="structsnmp__session.html#o16">community</a> = (<span class=
"keywordtype">unsigned</span> <span class="keywordtype">char</span> *)Cpsz;
00756             session-&gt;<a class="code" href="structsnmp__session.html#o17">community_len</a> = strlen(Cpsz);
00757         }
00758     }
00759 <span class="preprocessor">#endif </span><span class="comment">/* support for community based SNMP */</span>
00760 
00761     <span class="keywordflow">return</span> optind;
00762 }
</pre>
  </div>
  <hr size="1" />

  <address style="align: right;">
    <small><!--#include virtual="/sfbutton.html" --><br />
    Generated on Thu Oct 28 21:47:01 2004 for net-snmp by&nbsp; <a href="http://www.doxygen.org/index.html"><img src=
    "doxygen.png" alt="doxygen" align="middle" border="0" /></a> 1.3.9.1</small>
<!-- CONTENT END -->
<!--#include virtual="/page-bottom.html" -->

