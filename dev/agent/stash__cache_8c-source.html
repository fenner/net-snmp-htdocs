<!--#set var="section" value="development" -->
<!--#include virtual="/page-top.html" -->
<!-- CONTENT START -->
  <!-- Generated by Doxygen 1.3.9.1 -->

  <div class="qindex">
    <a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="modules.html">Modules</a> | <a class=
    "qindex" href="annotated.html">Data&nbsp;Structures</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class=
    "qindex" href="functions.html">Data&nbsp;Fields</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a> | <a class=
    "qindex" href="examples.html">Examples</a>
  </div>

  <div class="nav">
    <a class="el" href="dir_000003.html">agent</a>&nbsp;/&nbsp;<a class="el" href="dir_000004.html">helpers</a>
  </div>

  <h1>stash_cache.c</h1>

  <div class="fragment">
    <pre class="fragment">
00001 <span class="preprocessor">#include &lt;net-snmp/net-snmp-config.h&gt;</span>
00002 
00003 <span class="preprocessor">#if HAVE_STRING_H</span>
00004 <span class="preprocessor">#include &lt;string.h&gt;</span>
00005 <span class="preprocessor">#else</span>
00006 <span class="preprocessor">#include &lt;strings.h&gt;</span>
00007 <span class="preprocessor">#endif</span>
00008 
00009 <span class="preprocessor">#include &lt;net-snmp/net-snmp-includes.h&gt;</span>
00010 <span class="preprocessor">#include &lt;net-snmp/agent/net-snmp-agent-includes.h&gt;</span>
00011 
00012 <span class="preprocessor">#include &lt;net-snmp/agent/stash_cache.h&gt;</span>
00013 <span class="preprocessor">#include &lt;net-snmp/agent/stash_to_next.h&gt;</span>
00014 
00015 <span class="keyword">extern</span> NetsnmpCacheLoad _netsnmp_stash_cache_load;
00016 <span class="keyword">extern</span> NetsnmpCacheFree _netsnmp_stash_cache_free;
00017  
00028 netsnmp_stash_cache_info *
00029 netsnmp_get_new_stash_cache(<span class="keywordtype">void</span>)
00030 {
00031     netsnmp_stash_cache_info *cinfo;
00032 
00033     cinfo = <a class="code" href="group__util.html#ga39">SNMP_MALLOC_TYPEDEF</a>(netsnmp_stash_cache_info);
00034     cinfo-&gt;cache_length = 30;
00035     <span class="keywordflow">return</span> cinfo;
00036 }
00037 
00042 <a class="code" href="structnetsnmp__mib__handler__s.html">netsnmp_mib_handler</a> *
<a name="l00043" id="l00043"></a><a class="code" href="group__stash__cache.html#ga1">00043</a> <a class="code" href=
"group__stash__cache.html#ga1">netsnmp_get_timed_bare_stash_cache_handler</a>(<span class=
"keywordtype">int</span> timeout, oid *rootoid, size_t rootoid_len)
00044 {
00045     <a class="code" href="structnetsnmp__mib__handler__s.html">netsnmp_mib_handler</a> *handler;
00046     netsnmp_cache       *cinfo;
00047 
00048     cinfo = <a class="code" href=
"group__cache__handler.html#ga2">netsnmp_cache_create</a>( timeout, _netsnmp_stash_cache_load,
00049                                  _netsnmp_stash_cache_free, rootoid, rootoid_len );
00050 
00051     <span class="keywordflow">if</span> (!cinfo)
00052         <span class="keywordflow">return</span> NULL;
00053 
00054     handler = <a class="code" href="group__cache__handler.html#ga6">netsnmp_cache_handler_get</a>( cinfo );
00055     <span class="keywordflow">if</span> (!handler) {
00056         free(cinfo);
00057         <span class="keywordflow">return</span> NULL;
00058     }
00059 
00060     handler-&gt;<a class="code" href="structnetsnmp__mib__handler__s.html#o4">next</a> = <a class="code" href=
"group__handler.html#ga7">netsnmp_create_handler</a>(<span class=
"stringliteral">"stash_cache"</span>, netsnmp_stash_cache_helper);
00061     <span class="keywordflow">if</span> (!handler-&gt;<a class="code" href=
"structnetsnmp__mib__handler__s.html#o4">next</a>) {
00062         free(cinfo);
00063         <span class="keywordflow">return</span> NULL;
00064     }
00065 
00066     handler-&gt;<a class="code" href="structnetsnmp__mib__handler__s.html#o1">myvoid</a> = cinfo;
00067 
00068     <span class="keywordflow">return</span> handler;
00069 }
00070 
00075 <a class="code" href="structnetsnmp__mib__handler__s.html">netsnmp_mib_handler</a> *
<a name="l00076" id="l00076"></a><a class="code" href="group__stash__cache.html#ga2">00076</a> <a class="code" href=
"group__stash__cache.html#ga2">netsnmp_get_bare_stash_cache_handler</a>(<span class="keywordtype">void</span>)
00077 {
00078     <span class="keywordflow">return</span> <a class="code" href=
"group__stash__cache.html#ga1">netsnmp_get_timed_bare_stash_cache_handler</a>( 30, NULL, 0 );
00079 }
00080 
00084 <a class="code" href="structnetsnmp__mib__handler__s.html">netsnmp_mib_handler</a> *
<a name="l00085" id="l00085"></a><a class="code" href="group__stash__cache.html#ga3">00085</a> <a class="code" href=
"group__stash__cache.html#ga3">netsnmp_get_stash_cache_handler</a>(<span class="keywordtype">void</span>)
00086 {
00087     <a class="code" href="structnetsnmp__mib__handler__s.html">netsnmp_mib_handler</a> *handler = <a class="code" href=
"group__stash__cache.html#ga2">netsnmp_get_bare_stash_cache_handler</a>();
00088     <span class="keywordflow">if</span> (handler &amp;&amp; handler-&gt;<a class="code" href=
"structnetsnmp__mib__handler__s.html#o4">next</a>) {
00089         handler-&gt;<a class="code" href="structnetsnmp__mib__handler__s.html#o4">next</a>-&gt;<a class="code" href=
"structnetsnmp__mib__handler__s.html#o4">next</a> = <a class="code" href=
"group__stash__to__next.html#ga0">netsnmp_get_stash_to_next_handler</a>();
00090     }
00091     <span class="keywordflow">return</span> handler;
00092 }
00093 
00097 <a class="code" href="structnetsnmp__mib__handler__s.html">netsnmp_mib_handler</a> *
<a name="l00098" id="l00098"></a><a class="code" href="group__stash__cache.html#ga4">00098</a> <a class="code" href=
"group__stash__cache.html#ga4">netsnmp_get_timed_stash_cache_handler</a>(<span class=
"keywordtype">int</span> timeout, oid *rootoid, size_t rootoid_len)
00099 {
00100     <a class="code" href="structnetsnmp__mib__handler__s.html">netsnmp_mib_handler</a> *handler = 
00101        <a class="code" href=
"group__stash__cache.html#ga1">netsnmp_get_timed_bare_stash_cache_handler</a>(timeout, rootoid, rootoid_len);
00102     <span class="keywordflow">if</span> (handler &amp;&amp; handler-&gt;<a class="code" href=
"structnetsnmp__mib__handler__s.html#o4">next</a>) {
00103         handler-&gt;<a class="code" href="structnetsnmp__mib__handler__s.html#o4">next</a>-&gt;<a class="code" href=
"structnetsnmp__mib__handler__s.html#o4">next</a> = <a class="code" href=
"group__stash__to__next.html#ga0">netsnmp_get_stash_to_next_handler</a>();
00104     }
00105     <span class="keywordflow">return</span> handler;
00106 }
00107 
00109 netsnmp_oid_stash_node  **
<a name="l00110" id="l00110"></a><a class="code" href="group__stash__cache.html#ga5">00110</a> <a class="code" href=
"group__stash__cache.html#ga5">netsnmp_extract_stash_cache</a>(<a class="code" href=
"structnetsnmp__agent__request__info__s.html">netsnmp_agent_request_info</a> *reqinfo)
00111 {
00112     <span class="keywordflow">return</span> netsnmp_agent_get_list_data(reqinfo, STASH_CACHE_NAME);
00113 }
00114 
00115 
00117 <span class="keywordtype">int</span>
00118 netsnmp_stash_cache_helper(<a class="code" href="structnetsnmp__mib__handler__s.html">netsnmp_mib_handler</a> *handler,
00119                            <a class="code" href=
"structnetsnmp__handler__registration__s.html">netsnmp_handler_registration</a> *reginfo,
00120                            <a class="code" href=
"structnetsnmp__agent__request__info__s.html">netsnmp_agent_request_info</a> *reqinfo,
00121                            <a class="code" href="structnetsnmp__request__info__s.html">netsnmp_request_info</a> *requests)
00122 {
00123     netsnmp_cache            *cache;
00124     netsnmp_stash_cache_info *cinfo;
00125     netsnmp_oid_stash_node   *cnode;
00126     <a class="code" href="structvariable__list.html">netsnmp_variable_list</a>    *cdata;
00127     <a class="code" href="structnetsnmp__request__info__s.html">netsnmp_request_info</a>     *request;
00128 
00129     DEBUGMSGTL((<span class="stringliteral">"helper:stash_cache"</span>, <span class=
"stringliteral">"Got request\n"</span>));
00130 
00131     cache = <a class="code" href=
"group__cache__handler.html#ga12">netsnmp_cache_reqinfo_extract</a>( reqinfo, reginfo-&gt;<a class="code" href=
"structnetsnmp__handler__registration__s.html#o0">handlerName</a> );
00132     cinfo = (netsnmp_stash_cache_info *) cache-&gt;magic;
00133 
00134     <span class="keywordflow">switch</span> (reqinfo-&gt;<a class="code" href=
"structnetsnmp__agent__request__info__s.html#o0">mode</a>) {
00135 
00136     <span class="keywordflow">case</span> MODE_GET:
00137         DEBUGMSGTL((<span class="stringliteral">"helper:stash_cache"</span>, <span class=
"stringliteral">"Processing GET request\n"</span>));
00138         <span class="keywordflow">for</span>(request = requests; request; request = request-&gt;<a class="code" href=
"structnetsnmp__request__info__s.html#o13">next</a>) {
00139             cdata =
00140                 <a class="code" href="group__oid__stash.html#ga5">netsnmp_oid_stash_get_data</a>(cinfo-&gt;cache,
00141                                            requests-&gt;<a class="code" href=
"structnetsnmp__request__info__s.html#o0">requestvb</a>-&gt;<a class="code" href="structvariable__list.html#o1">name</a>,
00142                                            requests-&gt;<a class="code" href=
"structnetsnmp__request__info__s.html#o0">requestvb</a>-&gt;<a class="code" href="structvariable__list.html#o2">name_length</a>);
00143             <span class="keywordflow">if</span> (cdata &amp;&amp; cdata-&gt;<a class="code" href=
"structvariable__list.html#o4">val</a>.string &amp;&amp; cdata-&gt;<a class="code" href=
"structvariable__list.html#o5">val_len</a>) {
00144                 DEBUGMSGTL((<span class="stringliteral">"helper:stash_cache"</span>, <span class=
"stringliteral">"Found cached GET varbind\n"</span>));
00145                 DEBUGMSGOID((<span class="stringliteral">"helper:stash_cache"</span>, cdata-&gt;<a class="code" href=
"structvariable__list.html#o1">name</a>, cdata-&gt;<a class="code" href="structvariable__list.html#o2">name_length</a>));
00146                 DEBUGMSG((<span class="stringliteral">"helper:stash_cache"</span>, <span class=
"stringliteral">"\n"</span>));
00147                 <a class="code" href="group__snmp__client.html#ga19">snmp_set_var_typed_value</a>(request-&gt;<a class=
"code" href="structnetsnmp__request__info__s.html#o0">requestvb</a>, cdata-&gt;<a class="code" href=
"structvariable__list.html#o3">type</a>,
00148                                          cdata-&gt;<a class="code" href=
"structvariable__list.html#o4">val</a>.string, cdata-&gt;<a class="code" href="structvariable__list.html#o5">val_len</a>);
00149             }
00150         }
00151         <span class="keywordflow">return</span> SNMP_ERR_NOERROR;
00152         <span class="keywordflow">break</span>;
00153 
00154     <span class="keywordflow">case</span> MODE_GETNEXT:
00155         DEBUGMSGTL((<span class="stringliteral">"helper:stash_cache"</span>, <span class=
"stringliteral">"Processing GETNEXT request\n"</span>));
00156         <span class="keywordflow">for</span>(request = requests; request; request = request-&gt;<a class="code" href=
"structnetsnmp__request__info__s.html#o13">next</a>) {
00157             cnode =
00158                 <a class="code" href="group__oid__stash.html#ga4">netsnmp_oid_stash_getnext_node</a>(cinfo-&gt;cache,
00159                                                requests-&gt;<a class="code" href=
"structnetsnmp__request__info__s.html#o0">requestvb</a>-&gt;<a class="code" href="structvariable__list.html#o1">name</a>,
00160                                                requests-&gt;<a class="code" href=
"structnetsnmp__request__info__s.html#o0">requestvb</a>-&gt;<a class="code" href="structvariable__list.html#o2">name_length</a>);
00161             <span class="keywordflow">if</span> (cnode &amp;&amp; cnode-&gt;thedata) {
00162                 cdata = cnode-&gt;thedata;
00163                 <span class="keywordflow">if</span> (cdata-&gt;<a class="code" href=
"structvariable__list.html#o4">val</a>.string &amp;&amp; cdata-&gt;<a class="code" href=
"structvariable__list.html#o1">name</a> &amp;&amp; cdata-&gt;<a class="code" href=
"structvariable__list.html#o2">name_length</a>) {
00164                     DEBUGMSGTL((<span class="stringliteral">"helper:stash_cache"</span>, <span class=
"stringliteral">"Found cached GETNEXT varbind\n"</span>));
00165                     DEBUGMSGOID((<span class="stringliteral">"helper:stash_cache"</span>, cdata-&gt;<a class="code" href=
"structvariable__list.html#o1">name</a>, cdata-&gt;<a class="code" href="structvariable__list.html#o2">name_length</a>));
00166                     DEBUGMSG((<span class="stringliteral">"helper:stash_cache"</span>, <span class=
"stringliteral">"\n"</span>));
00167                     <a class="code" href="group__snmp__client.html#ga19">snmp_set_var_typed_value</a>(request-&gt;<a class=
"code" href="structnetsnmp__request__info__s.html#o0">requestvb</a>, cdata-&gt;<a class="code" href=
"structvariable__list.html#o3">type</a>,
00168                                              cdata-&gt;<a class="code" href=
"structvariable__list.html#o4">val</a>.string, cdata-&gt;<a class="code" href="structvariable__list.html#o5">val_len</a>);
00169                     snmp_set_var_objid(request-&gt;<a class="code" href=
"structnetsnmp__request__info__s.html#o0">requestvb</a>, cdata-&gt;<a class="code" href="structvariable__list.html#o1">name</a>,
00170                                        cdata-&gt;<a class="code" href="structvariable__list.html#o2">name_length</a>);
00171                 }
00172             }
00173         }
00174         <span class="keywordflow">return</span> SNMP_ERR_NOERROR;
00175         <span class="keywordflow">break</span>;
00176 
00177     <span class="keywordflow">default</span>:
00178         cinfo-&gt;cache_valid = 0;
00179         <span class="keywordflow">return</span> <a class="code" href=
"group__handler.html#ga17">netsnmp_call_next_handler</a>(handler, reginfo, reqinfo,
00180                                          requests);
00181     }
00182     <span class="keywordflow">return</span> SNMP_ERR_GENERR;     <span class="comment">/* should never get here */</span>
00183 }
00184 
00187 <span class="keywordtype">int</span>
<a name="l00188" id="l00188"></a><a class="code" href="group__stash__cache.html#ga7">00188</a> <a class="code" href=
"group__stash__cache.html#ga7">_netsnmp_stash_cache_load</a>( netsnmp_cache *cache, <span class=
"keywordtype">void</span> *magic )
00189 {
00190     <a class="code" href=
"structnetsnmp__mib__handler__s.html">netsnmp_mib_handler</a>          *handler  = cache-&gt;cache_hint-&gt;handler;
00191     <a class="code" href=
"structnetsnmp__handler__registration__s.html">netsnmp_handler_registration</a> *reginfo  = cache-&gt;cache_hint-&gt;reginfo;
00192     <a class="code" href=
"structnetsnmp__agent__request__info__s.html">netsnmp_agent_request_info</a>   *reqinfo  = cache-&gt;cache_hint-&gt;reqinfo;
00193     <a class="code" href=
"structnetsnmp__request__info__s.html">netsnmp_request_info</a>         *requests = cache-&gt;cache_hint-&gt;requests;
00194     netsnmp_stash_cache_info     *cinfo    = (netsnmp_stash_cache_info*) magic;
00195     <span class="keywordtype">int</span> old_mode;
00196     <span class="keywordtype">int</span> ret;
00197 
00198     <span class="keywordflow">if</span> (!cinfo) {
00199         cinfo = netsnmp_get_new_stash_cache();
00200         cache-&gt;magic = cinfo;
00201     }
00202 
00203     <span class="comment">/* change modes to the GET_STASH mode */</span>
00204     old_mode = reqinfo-&gt;<a class="code" href="structnetsnmp__agent__request__info__s.html#o0">mode</a>;
00205     reqinfo-&gt;<a class="code" href="structnetsnmp__agent__request__info__s.html#o0">mode</a> = MODE_GET_STASH;
00206     netsnmp_agent_add_list_data(reqinfo,
00207                                 <a class="code" href=
"group__data__list.html#ga3">netsnmp_create_data_list</a>(STASH_CACHE_NAME,
00208                                                          &amp;cinfo-&gt;cache, NULL));
00209 
00210     <span class="comment">/* have the next handler fill stuff in and switch modes back */</span>
00211     ret = <a class="code" href="group__handler.html#ga17">netsnmp_call_next_handler</a>(handler-&gt;<a class="code" href=
"structnetsnmp__mib__handler__s.html#o4">next</a>, reginfo, reqinfo, requests);
00212     reqinfo-&gt;<a class="code" href="structnetsnmp__agent__request__info__s.html#o0">mode</a> = old_mode;
00213 
00214     <span class="keywordflow">return</span> ret;
00215 }
00216 
00217 <span class="keywordtype">void</span>
00218 _netsnmp_stash_cache_free( netsnmp_cache *cache, <span class="keywordtype">void</span> *magic )
00219 {
00220     netsnmp_stash_cache_info *cinfo = (netsnmp_stash_cache_info*) magic;
00221     <a class="code" href="group__oid__stash.html#ga9">netsnmp_oid_stash_free</a>(&amp;cinfo-&gt;cache,
00222                           (NetSNMPStashFreeNode *) snmp_free_var);
00223     <span class="keywordflow">return</span>;
00224 }
00225 
00230 <span class="keywordtype">void</span>
<a name="l00231" id="l00231"></a><a class="code" href="group__stash__cache.html#ga9">00231</a> <a class="code" href=
"group__debug.html#ga8">netsnmp_init_stash_cache_helper</a>(<span class="keywordtype">void</span>)
00232 {
00233     <a class="code" href="group__handler.html#ga36">netsnmp_register_handler_by_name</a>(<span class=
"stringliteral">"stash_cache"</span>,
00234                                      <a class="code" href=
"group__stash__cache.html#ga3">netsnmp_get_stash_cache_handler</a>());
00235 }
</pre>
  </div>
  <hr size="1" />

  <address style="align: right;">
    <small>Generated on Fri Dec 30 13:47:50 2005 for net-snmp by&nbsp; <a href="http://www.doxygen.org/index.html"><img src=
    "doxygen.png" alt="doxygen" align="middle" border="0" /></a> 1.3.9.1</small>
  </address>
<!-- CONTENT END -->
<!--#include virtual="/page-bottom.html" -->

