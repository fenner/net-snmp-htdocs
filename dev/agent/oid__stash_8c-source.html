<!--#set var="section" value="development" -->
<!--#include virtual="/page-top.html" -->
<!-- CONTENT START -->
  <!-- Generated by Doxygen 1.3.9.1 -->

  <div class="qindex">
    <a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="modules.html">Modules</a> | <a class=
    "qindex" href="annotated.html">Data&nbsp;Structures</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class=
    "qindex" href="functions.html">Data&nbsp;Fields</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a> | <a class=
    "qindex" href="examples.html">Examples</a>
  </div>

  <div class="nav">
    <a class="el" href="dir_000005.html">snmplib</a>
  </div>

  <h1>oid_stash.c</h1>

  <div class="fragment">
    <pre class="fragment">
00001 <span class="preprocessor">#include &lt;net-snmp/net-snmp-config.h&gt;</span>
00002 
00003 <span class="preprocessor">#include &lt;string.h&gt;</span>
00004 
00005 <span class="preprocessor">#include &lt;stdlib.h&gt;</span>
00006 <span class="preprocessor">#include &lt;sys/types.h&gt;</span>
00007 
00008 <span class="preprocessor">#include &lt;net-snmp/net-snmp-includes.h&gt;</span>
00009 
00018 <span class="comment">/*</span>
00019 <span class="comment"> * xxx-rks: when you have some spare time:</span>
00020 <span class="comment"> *</span>
00021 <span class="comment"> * b) basically, everything currently creates one node per sub-oid,</span>
00022 <span class="comment"> *    which is less than optimal. add code to create nodes with the</span>
00023 <span class="comment"> *    longest possible OID per node, and split nodes when necessary</span>
00024 <span class="comment"> *    during adds.</span>
00025 <span class="comment"> *</span>
00026 <span class="comment"> * c) If you are feeling really ambitious, also merge split nodes if</span>
00027 <span class="comment"> *    possible on a delete.</span>
00028 <span class="comment"> *</span>
00029 <span class="comment"> * xxx-wes: uh, right, like I *ever* have that much time.</span>
00030 <span class="comment"> *</span>
00031 <span class="comment"> */</span>
00032 
00033 <span class="comment">/***************************************************************************</span>
00034 <span class="comment"> *</span>
00035 <span class="comment"> *</span>
00036 <span class="comment"> ***************************************************************************/</span>
00037 
00045 netsnmp_oid_stash_node *
<a name="l00046" id="l00046"></a><a class="code" href="group__oid__stash.html#ga0">00046</a> <a class="code" href=
"group__oid__stash.html#ga0">netsnmp_oid_stash_create_sized_node</a>(size_t mysize)
00047 {
00048     netsnmp_oid_stash_node *ret;
00049     ret = <a class="code" href="group__util.html#ga39">SNMP_MALLOC_TYPEDEF</a>(netsnmp_oid_stash_node);
00050     <span class="keywordflow">if</span> (!ret)
00051         <span class="keywordflow">return</span> NULL;
00052     ret-&gt;children = calloc(mysize, <span class="keyword">sizeof</span>(netsnmp_oid_stash_node *));
00053     <span class="keywordflow">if</span> (!ret-&gt;children) {
00054         free(ret);
00055         <span class="keywordflow">return</span> NULL;
00056     }
00057     ret-&gt;children_size = mysize;
00058     <span class="keywordflow">return</span> ret;
00059 }
00060 
00065 NETSNMP_INLINE netsnmp_oid_stash_node *
<a name="l00066" id="l00066"></a><a class="code" href="group__oid__stash.html#ga1">00066</a> <a class="code" href=
"group__oid__stash.html#ga1">netsnmp_oid_stash_create_node</a>(<span class="keywordtype">void</span>)
00067 {
00068     <span class="keywordflow">return</span> <a class="code" href=
"group__oid__stash.html#ga0">netsnmp_oid_stash_create_sized_node</a>(OID_STASH_CHILDREN_SIZE);
00069 }
00070 
00082 <span class="keywordtype">int</span>
<a name="l00083" id="l00083"></a><a class="code" href="group__oid__stash.html#ga2">00083</a> <a class="code" href=
"group__oid__stash.html#ga2">netsnmp_oid_stash_add_data</a>(netsnmp_oid_stash_node **root,
00084                            oid * lookup, size_t lookup_len, <span class="keywordtype">void</span> *mydata)
00085 {
00086     netsnmp_oid_stash_node *curnode, *tmpp, *loopp;
00087     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>    i;
00088 
00089     <span class="keywordflow">if</span> (!root || !lookup || lookup_len == 0)
00090         <span class="keywordflow">return</span> SNMPERR_GENERR;
00091 
00092     <span class="keywordflow">if</span> (!*root) {
00093         *root = <a class="code" href="group__oid__stash.html#ga1">netsnmp_oid_stash_create_node</a>();
00094         <span class="keywordflow">if</span> (!*root)
00095             <span class="keywordflow">return</span> SNMPERR_MALLOC;
00096     }
00097     DEBUGMSGTL(( <span class="stringliteral">"oid_stash"</span>, <span class="stringliteral">"stash_add_data "</span>));
00098     DEBUGMSGOID((<span class="stringliteral">"oid_stash"</span>, lookup, lookup_len));
00099     DEBUGMSG((   <span class="stringliteral">"oid_stash"</span>, <span class="stringliteral">"\n"</span>));
00100     tmpp = NULL;
00101     <span class="keywordflow">for</span> (curnode = *root, i = 0; i &lt; lookup_len; i++) {
00102         tmpp = curnode-&gt;children[lookup[i] % curnode-&gt;children_size];
00103         <span class="keywordflow">if</span> (!tmpp) {
00104             <span class="comment">/*</span>
00105 <span class="comment">             * no child in array at all </span>
00106 <span class="comment">             */</span>
00107             tmpp = curnode-&gt;children[lookup[i] % curnode-&gt;children_size] =
00108                 <a class="code" href="group__oid__stash.html#ga1">netsnmp_oid_stash_create_node</a>();
00109             tmpp-&gt;value = lookup[i];
00110             tmpp-&gt;parent = curnode;
00111         } <span class="keywordflow">else</span> {
00112             <span class="keywordflow">for</span> (loopp = tmpp; loopp; loopp = loopp-&gt;next_sibling) {
00113                 <span class="keywordflow">if</span> (loopp-&gt;value == lookup[i])
00114                     <span class="keywordflow">break</span>;
00115             }
00116             <span class="keywordflow">if</span> (loopp) {
00117                 tmpp = loopp;
00118             } <span class="keywordflow">else</span> {
00119                 <span class="comment">/*</span>
00120 <span class="comment">                 * none exists.  Create it </span>
00121 <span class="comment">                 */</span>
00122                 loopp = <a class="code" href="group__oid__stash.html#ga1">netsnmp_oid_stash_create_node</a>();
00123                 loopp-&gt;value = lookup[i];
00124                 loopp-&gt;next_sibling = tmpp;
00125                 loopp-&gt;parent = curnode;
00126                 tmpp-&gt;prev_sibling = loopp;
00127                 curnode-&gt;children[lookup[i] % curnode-&gt;children_size] =
00128                     loopp;
00129                 tmpp = loopp;
00130             }
00131             <span class="comment">/*</span>
00132 <span class="comment">             * tmpp now points to the proper node </span>
00133 <span class="comment">             */</span>
00134         }
00135         curnode = tmpp;
00136     }
00137     <span class="comment">/*</span>
00138 <span class="comment">     * tmpp now points to the exact match </span>
00139 <span class="comment">     */</span>
00140     <span class="keywordflow">if</span> (curnode-&gt;thedata)
00141         <span class="keywordflow">return</span> SNMPERR_GENERR;
00142     <span class="keywordflow">if</span> (NULL == tmpp)
00143         <span class="keywordflow">return</span> SNMPERR_GENERR;
00144     tmpp-&gt;thedata = mydata;
00145     <span class="keywordflow">return</span> SNMPERR_SUCCESS;
00146 }
00147 
00153 netsnmp_oid_stash_node *
<a name="l00154" id="l00154"></a><a class="code" href="group__oid__stash.html#ga3">00154</a> <a class="code" href=
"group__oid__stash.html#ga3">netsnmp_oid_stash_get_node</a>(netsnmp_oid_stash_node *root,
00155                            oid * lookup, size_t lookup_len)
00156 {
00157     netsnmp_oid_stash_node *curnode, *tmpp, *loopp;
00158     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>    i;
00159 
00160     <span class="keywordflow">if</span> (!root)
00161         <span class="keywordflow">return</span> NULL;
00162     tmpp = NULL;
00163     <span class="keywordflow">for</span> (curnode = root, i = 0; i &lt; lookup_len; i++) {
00164         tmpp = curnode-&gt;children[lookup[i] % curnode-&gt;children_size];
00165         <span class="keywordflow">if</span> (!tmpp) {
00166             <span class="keywordflow">return</span> NULL;
00167         } <span class="keywordflow">else</span> {
00168             <span class="keywordflow">for</span> (loopp = tmpp; loopp; loopp = loopp-&gt;next_sibling) {
00169                 <span class="keywordflow">if</span> (loopp-&gt;value == lookup[i])
00170                     <span class="keywordflow">break</span>;
00171             }
00172             <span class="keywordflow">if</span> (loopp) {
00173                 tmpp = loopp;
00174             } <span class="keywordflow">else</span> {
00175                 <span class="keywordflow">return</span> NULL;
00176             }
00177         }
00178         curnode = tmpp;
00179     }
00180     <span class="keywordflow">return</span> tmpp;
00181 }
00182 
00190 netsnmp_oid_stash_node *
<a name="l00191" id="l00191"></a><a class="code" href="group__oid__stash.html#ga4">00191</a> <a class="code" href=
"group__oid__stash.html#ga4">netsnmp_oid_stash_getnext_node</a>(netsnmp_oid_stash_node *root,
00192                                oid * lookup, size_t lookup_len)
00193 {
00194     netsnmp_oid_stash_node *curnode, *tmpp, *loopp;
00195     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>    i, j, bigger_than = 0, do_bigger = 0;
00196 
00197     <span class="keywordflow">if</span> (!root)
00198         <span class="keywordflow">return</span> NULL;
00199     tmpp = NULL;
00200 
00201     <span class="comment">/* get closest matching node */</span>
00202     <span class="keywordflow">for</span> (curnode = root, i = 0; i &lt; lookup_len; i++) {
00203         tmpp = curnode-&gt;children[lookup[i] % curnode-&gt;children_size];
00204         <span class="keywordflow">if</span> (!tmpp) {
00205             <span class="keywordflow">break</span>;
00206         } <span class="keywordflow">else</span> {
00207             <span class="keywordflow">for</span> (loopp = tmpp; loopp; loopp = loopp-&gt;next_sibling) {
00208                 <span class="keywordflow">if</span> (loopp-&gt;value == lookup[i])
00209                     <span class="keywordflow">break</span>;
00210             }
00211             <span class="keywordflow">if</span> (loopp) {
00212                 tmpp = loopp;
00213             } <span class="keywordflow">else</span> {
00214                 <span class="keywordflow">break</span>;
00215             }
00216         }
00217         curnode = tmpp;
00218     }
00219 
00220     <span class="comment">/* find the *next* node lexographically greater */</span>
00221     <span class="keywordflow">if</span> (!curnode)
00222         <span class="keywordflow">return</span> NULL; <span class="comment">/* ack! */</span>
00223 
00224     <span class="keywordflow">if</span> (i+1 &lt; lookup_len) {
00225         bigger_than = lookup[i+1];
00226         do_bigger = 1;
00227     }
00228 
00229     <span class="keywordflow">do</span> {
00230         <span class="comment">/* check the children first */</span>
00231         tmpp = NULL;
00232         <span class="comment">/* next child must be (next) greater than our next search node */</span>
00233         <span class="comment">/* XXX: should start this loop at best_nums[i]%... and wrap */</span>
00234         <span class="keywordflow">for</span>(j = 0; j &lt; curnode-&gt;children_size; j++) {
00235             <span class="keywordflow">for</span> (loopp = curnode-&gt;children[j];
00236                  loopp; loopp = loopp-&gt;next_sibling) {
00237                 <span class="keywordflow">if</span> ((!do_bigger || loopp-&gt;value &gt; bigger_than) &amp;&amp;
00238                     (!tmpp || tmpp-&gt;value &gt; loopp-&gt;value)) {
00239                     tmpp = loopp;
00240                     <span class="comment">/* XXX: can do better and include min_nums[i] */</span>
00241                     <span class="keywordflow">if</span> (tmpp-&gt;value &lt;= curnode-&gt;children_size-1) {
00242                         <span class="comment">/* best we can do. */</span>
00243                         <span class="keywordflow">goto</span> done_this_loop;
00244                     }
00245                 }
00246             }
00247         }
00248 
00249       done_this_loop:
00250         <span class="keywordflow">if</span> (tmpp &amp;&amp; tmpp-&gt;thedata)
00251             <span class="comment">/* found a node with data.  Go with it. */</span>
00252             <span class="keywordflow">return</span> tmpp;
00253 
00254         <span class="keywordflow">if</span> (tmpp) {
00255             <span class="comment">/* found a child node without data, maybe find a grandchild? */</span>
00256             do_bigger = 0;
00257             curnode = tmpp;
00258         } <span class="keywordflow">else</span> {
00259             <span class="comment">/* no respectable children (the bums), we'll have to go up.</span>
00260 <span class="comment">               But to do so, they must be better than our current best_num + 1.</span>
00261 <span class="comment">            */</span>
00262             do_bigger = 1;
00263             bigger_than = curnode-&gt;value;
00264             curnode = curnode-&gt;parent;
00265         }
00266     } <span class="keywordflow">while</span> (curnode);
00267 
00268     <span class="comment">/* fell off the top */</span>
00269     <span class="keywordflow">return</span> NULL;
00270 }
00271 
00281 <span class="keywordtype">void</span>           *
<a name="l00282" id="l00282"></a><a class="code" href="group__oid__stash.html#ga5">00282</a> <a class="code" href=
"group__oid__stash.html#ga5">netsnmp_oid_stash_get_data</a>(netsnmp_oid_stash_node *root,
00283                            oid * lookup, size_t lookup_len)
00284 {
00285     netsnmp_oid_stash_node *ret;
00286     ret = <a class="code" href="group__oid__stash.html#ga3">netsnmp_oid_stash_get_node</a>(root, lookup, lookup_len);
00287     <span class="keywordflow">if</span> (ret)
00288         <span class="keywordflow">return</span> ret-&gt;thedata;
00289     <span class="keywordflow">return</span> NULL;
00290 }
00291 
00300 <span class="keywordtype">int</span>
<a name="l00301" id="l00301"></a><a class="code" href="group__oid__stash.html#ga6">00301</a> <a class="code" href=
"group__oid__stash.html#ga6">netsnmp_oid_stash_store_all</a>(<span class="keywordtype">int</span> majorID, <span class=
"keywordtype">int</span> minorID,
00302                             <span class="keywordtype">void</span> *serverarg, <span class=
"keywordtype">void</span> *clientarg) {
00303     oid oidbase[MAX_OID_LEN];
00304     netsnmp_oid_stash_save_info *sinfo;
00305     
00306     <span class="keywordflow">if</span> (!clientarg)
00307         <span class="keywordflow">return</span> SNMP_ERR_NOERROR;
00308     
00309     sinfo = clientarg;
00310     <a class="code" href=
"group__oid__stash.html#ga7">netsnmp_oid_stash_store</a>(*(sinfo-&gt;root), sinfo-&gt;token, sinfo-&gt;dumpfn,
00311                             oidbase,0);
00312     <span class="keywordflow">return</span> SNMP_ERR_NOERROR;
00313 }
00314 
00330 <span class="keywordtype">void</span>
<a name="l00331" id="l00331"></a><a class="code" href="group__oid__stash.html#ga7">00331</a> <a class="code" href=
"group__oid__stash.html#ga7">netsnmp_oid_stash_store</a>(netsnmp_oid_stash_node *root,
00332                         <span class="keyword">const</span> <span class=
"keywordtype">char</span> *tokenname, NetSNMPStashDump *dumpfn,
00333                         oid *curoid, size_t curoid_len) {
00334 
00335     <span class="keywordtype">char</span> buf[SNMP_MAXBUF];
00336     netsnmp_oid_stash_node *tmpp;
00337     <span class="keywordtype">char</span> *cp;
00338     <span class="keywordtype">char</span> *appname = netsnmp_ds_get_string(NETSNMP_DS_LIBRARY_ID, 
00339                                           NETSNMP_DS_LIB_APPTYPE);
00340     <span class="keywordtype">int</span> i;
00341     
00342     <span class="keywordflow">if</span> (!tokenname || !root || !curoid || !dumpfn)
00343         <span class="keywordflow">return</span>;
00344 
00345     <span class="keywordflow">for</span> (i = 0; i &lt; (int)root-&gt;children_size; i++) {
00346         <span class="keywordflow">if</span> (root-&gt;children[i]) {
00347             <span class="keywordflow">for</span> (tmpp = root-&gt;children[i]; tmpp; tmpp = tmpp-&gt;next_sibling) {
00348                 curoid[curoid_len] = tmpp-&gt;value;
00349                 <span class="keywordflow">if</span> (tmpp-&gt;thedata) {
00350                     snprintf(buf, <span class="keyword">sizeof</span>(buf), <span class=
"stringliteral">"%s "</span>, tokenname);
00351                     cp = read_config_save_objid(buf+strlen(buf), curoid,
00352                                                 curoid_len+1);
00353                     *cp++ = <span class="charliteral">' '</span>;
00354                     *cp = <span class="charliteral">'\0'</span>;
00355                     <span class="keywordflow">if</span> ((*dumpfn)(cp, <span class=
"keyword">sizeof</span>(buf) - strlen(buf),
00356                                   tmpp-&gt;thedata, tmpp))
00357                         <a class="code" href="group__read__config.html#ga40">read_config_store</a>(appname, buf);
00358                 }
00359                 <a class="code" href="group__oid__stash.html#ga7">netsnmp_oid_stash_store</a>(tmpp, tokenname, dumpfn,
00360                                         curoid, curoid_len+1);
00361             }
00362         }
00363     }
00364 }
00365 
00370 <span class="keywordtype">void</span> 
<a name="l00371" id="l00371"></a><a class="code" href="group__oid__stash.html#ga8">00371</a> <a class="code" href=
"group__oid__stash.html#ga8">oid_stash_dump</a>(netsnmp_oid_stash_node *root, <span class="keywordtype">char</span> *prefix)
00372 {
00373     <span class="keywordtype">char</span>            myprefix[MAX_OID_LEN * 4];
00374     netsnmp_oid_stash_node *tmpp;
00375     <span class="keywordtype">int</span>             prefix_len = strlen(prefix) + 1;    <span class=
"comment">/* actually it's +2 */</span>
00376     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>    i;
00377 
00378     memset(myprefix, <span class="charliteral">' '</span>, MAX_OID_LEN * 4);
00379     myprefix[prefix_len] = <span class="charliteral">'\0'</span>;
00380 
00381     <span class="keywordflow">for</span> (i = 0; i &lt; root-&gt;children_size; i++) {
00382         <span class="keywordflow">if</span> (root-&gt;children[i]) {
00383             <span class="keywordflow">for</span> (tmpp = root-&gt;children[i]; tmpp; tmpp = tmpp-&gt;next_sibling) {
00384                 printf(<span class="stringliteral">"%s%ld@%d: %s\n"</span>, prefix, tmpp-&gt;value, i,
00385                        (tmpp-&gt;thedata) ? <span class="stringliteral">"DATA"</span> : <span class=
"stringliteral">""</span>);
00386                 <a class="code" href="group__oid__stash.html#ga8">oid_stash_dump</a>(tmpp, myprefix);
00387             }
00388         }
00389     }
00390 }
00391 
00397 <span class="keywordtype">void</span>
<a name="l00398" id="l00398"></a><a class="code" href="group__oid__stash.html#ga9">00398</a> <a class="code" href=
"group__oid__stash.html#ga9">netsnmp_oid_stash_free</a>(netsnmp_oid_stash_node **root,
00399                        NetSNMPStashFreeNode *freefn) {
00400 
00401     netsnmp_oid_stash_node *curnode, *tmpp;
00402     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>    i;
00403 
00404     <span class="keywordflow">if</span> (!root || !*root)
00405         <span class="keywordflow">return</span>;
00406 
00407     <span class="comment">/* loop through all our children and free each node */</span>
00408     <span class="keywordflow">for</span> (i = 0; i &lt; (*root)-&gt;children_size; i++) {
00409         <span class="keywordflow">if</span> ((*root)-&gt;children[i]) {
00410             <span class="keywordflow">for</span>(tmpp = (*root)-&gt;children[i]; tmpp; tmpp = curnode) {
00411                 <span class="keywordflow">if</span> (tmpp-&gt;thedata) {
00412                     <span class="keywordflow">if</span> (freefn)
00413                         (*freefn)(tmpp-&gt;thedata);
00414                     <span class="keywordflow">else</span>
00415                         free(tmpp-&gt;thedata);
00416                 }
00417                 curnode = tmpp-&gt;next_sibling;
00418                 <a class="code" href="group__oid__stash.html#ga9">netsnmp_oid_stash_free</a>(&amp;tmpp, freefn);
00419             }
00420         }
00421     }
00422     free((*root)-&gt;children);
00423     free (*root);
00424     *root = NULL;
00425 }
00426 
00427 <span class="keywordtype">void</span>
00428 netsnmp_oid_stash_no_free(<span class="keywordtype">void</span> *bogus)
00429 {
00430     <span class="comment">/* noop */</span>
00431 }
00432 
</pre>
  </div>
  <hr size="1" />

  <address style="align: right;">
    <small>Generated on Fri Dec 30 13:47:46 2005 for net-snmp by&nbsp; <a href="http://www.doxygen.org/index.html"><img src=
    "doxygen.png" alt="doxygen" align="middle" border="0" /></a> 1.3.9.1</small>
  </address>
<!-- CONTENT END -->
<!--#include virtual="/page-bottom.html" -->

