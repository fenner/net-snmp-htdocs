<!--#set var="section" value="development" -->
<!--#include virtual="/page-top.html" -->
<!-- CONTENT START -->
  <!-- Generated by Doxygen 1.3.9.1 -->

  <div class="qindex">
    <a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="modules.html">Modules</a> | <a class=
    "qindex" href="annotated.html">Data&nbsp;Structures</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class=
    "qindex" href="functions.html">Data&nbsp;Fields</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a> | <a class=
    "qindex" href="examples.html">Examples</a>
  </div>

  <div class="nav">
    <a class="el" href="dir_000003.html">agent</a>
  </div>

  <h1>snmpd.c</h1>

  <div class="fragment">
    <pre class="fragment">
00001 <span class="comment">/*</span>
00002 <span class="comment"> * snmpd.c</span>
00003 <span class="comment"> */</span>
00007 <span class="comment">/* Portions of this file are subject to the following copyrights.  See</span>
00008 <span class="comment"> * the Net-SNMP's COPYING file for more details and other copyrights</span>
00009 <span class="comment"> * that may apply:</span>
00010 <span class="comment"> */</span>
00011 <span class="comment">/*</span>
00012 <span class="comment"> * Copyright 1988, 1989 by Carnegie Mellon University</span>
00013 <span class="comment"> * </span>
00014 <span class="comment"> * All Rights Reserved</span>
00015 <span class="comment"> * </span>
00016 <span class="comment"> * Permission to use, copy, modify, and distribute this software and its </span>
00017 <span class="comment"> * documentation for any purpose and without fee is hereby granted, </span>
00018 <span class="comment"> * provided that the above copyright notice appear in all copies and that</span>
00019 <span class="comment"> * both that copyright notice and this permission notice appear in </span>
00020 <span class="comment"> * supporting documentation, and that the name of CMU not be</span>
00021 <span class="comment"> * used in advertising or publicity pertaining to distribution of the</span>
00022 <span class="comment"> * software without specific, written prior permission.  </span>
00023 <span class="comment"> * </span>
00024 <span class="comment"> * CMU DISCLAIMS ALL WARRANTIES WITH REGARD TO THIS SOFTWARE, INCLUDING</span>
00025 <span class="comment"> * ALL IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS, IN NO EVENT SHALL</span>
00026 <span class="comment"> * CMU BE LIABLE FOR ANY SPECIAL, INDIRECT OR CONSEQUENTIAL DAMAGES OR</span>
00027 <span class="comment"> * ANY DAMAGES WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS,</span>
00028 <span class="comment"> * WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION,</span>
00029 <span class="comment"> * ARISING OUT OF OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS</span>
00030 <span class="comment"> * SOFTWARE.</span>
00031 <span class="comment"> * *****************************************************************</span>
00032 <span class="comment"> */</span>
00033 <span class="comment">/*</span>
00034 <span class="comment"> * Copyright &copy; 2003 Sun Microsystems, Inc. All rights reserved.</span>
00035 <span class="comment"> * Use is subject to license terms specified in the COPYING file</span>
00036 <span class="comment"> * distributed with the Net-SNMP package.</span>
00037 <span class="comment"> */</span>
00038 <span class="preprocessor">#include &lt;net-snmp/net-snmp-config.h&gt;</span>
00039 
00040 <span class="preprocessor">#if HAVE_IO_H</span>
00041 <span class="preprocessor">#include &lt;io.h&gt;</span>
00042 <span class="preprocessor">#endif</span>
00043 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
00044 <span class="preprocessor">#include &lt;errno.h&gt;</span>
00045 <span class="preprocessor">#if HAVE_STRING_H</span>
00046 <span class="preprocessor">#include &lt;string.h&gt;</span>
00047 <span class="preprocessor">#else</span>
00048 <span class="preprocessor">#include &lt;strings.h&gt;</span>
00049 <span class="preprocessor">#endif</span>
00050 <span class="preprocessor">#if HAVE_STDLIB_H</span>
00051 <span class="preprocessor">#include &lt;stdlib.h&gt;</span>
00052 <span class="preprocessor">#endif</span>
00053 <span class="preprocessor">#if HAVE_UNISTD_H</span>
00054 <span class="preprocessor">#include &lt;unistd.h&gt;</span>
00055 <span class="preprocessor">#endif</span>
00056 <span class="preprocessor">#include &lt;sys/types.h&gt;</span>
00057 <span class="preprocessor">#if HAVE_NETINET_IN_H</span>
00058 <span class="preprocessor">#include &lt;netinet/in.h&gt;</span>
00059 <span class="preprocessor">#endif</span>
00060 <span class="preprocessor">#if HAVE_ARPA_INET_H</span>
00061 <span class="preprocessor">#include &lt;arpa/inet.h&gt;</span>
00062 <span class="preprocessor">#endif</span>
00063 <span class="preprocessor">#if TIME_WITH_SYS_TIME</span>
00064 <span class="preprocessor"># ifdef WIN32</span>
00065 <span class="preprocessor">#  include &lt;sys/timeb.h&gt;</span>
00066 <span class="preprocessor"># else</span>
00067 <span class="preprocessor">#  include &lt;sys/time.h&gt;</span>
00068 <span class="preprocessor"># endif</span>
00069 <span class="preprocessor"># include &lt;time.h&gt;</span>
00070 <span class="preprocessor">#else</span>
00071 <span class="preprocessor"># if HAVE_SYS_TIME_H</span>
00072 <span class="preprocessor">#  include &lt;sys/time.h&gt;</span>
00073 <span class="preprocessor"># else</span>
00074 <span class="preprocessor">#  include &lt;time.h&gt;</span>
00075 <span class="preprocessor"># endif</span>
00076 <span class="preprocessor">#endif</span>
00077 <span class="preprocessor">#if HAVE_SYS_SELECT_H</span>
00078 <span class="preprocessor">#include &lt;sys/select.h&gt;</span>
00079 <span class="preprocessor">#endif</span>
00080 <span class="preprocessor">#if HAVE_SYS_SOCKET_H</span>
00081 <span class="preprocessor">#include &lt;sys/socket.h&gt;</span>
00082 <span class="preprocessor">#elif HAVE_WINSOCK_H</span>
00083 <span class="preprocessor">#include &lt;winsock.h&gt;</span>
00084 <span class="preprocessor">#endif</span>
00085 <span class="preprocessor">#if HAVE_NET_IF_H</span>
00086 <span class="preprocessor">#include &lt;net/if.h&gt;</span>
00087 <span class="preprocessor">#endif</span>
00088 <span class="preprocessor">#if HAVE_INET_MIB2_H</span>
00089 <span class="preprocessor">#include &lt;inet/mib2.h&gt;</span>
00090 <span class="preprocessor">#endif</span>
00091 <span class="preprocessor">#if HAVE_SYS_IOCTL_H</span>
00092 <span class="preprocessor">#include &lt;sys/ioctl.h&gt;</span>
00093 <span class="preprocessor">#endif</span>
00094 <span class="preprocessor">#if HAVE_SYS_FILE_H</span>
00095 <span class="preprocessor">#include &lt;sys/file.h&gt;</span>
00096 <span class="preprocessor">#endif</span>
00097 <span class="preprocessor">#ifdef HAVE_FCNTL_H</span>
00098 <span class="preprocessor">#include &lt;fcntl.h&gt;</span>
00099 <span class="preprocessor">#endif</span>
00100 <span class="preprocessor">#if HAVE_SYS_WAIT_H</span>
00101 <span class="preprocessor">#include &lt;sys/wait.h&gt;</span>
00102 <span class="preprocessor">#endif</span>
00103 <span class="preprocessor">#include &lt;signal.h&gt;</span>
00104 <span class="preprocessor">#ifdef HAVE_SYS_PARAM_H</span>
00105 <span class="preprocessor">#include &lt;sys/param.h&gt;</span>
00106 <span class="preprocessor">#endif</span>
00107 <span class="preprocessor">#if HAVE_PROCESS_H              </span><span class="comment">/* Win32-getpid */</span>
00108 <span class="preprocessor">#include &lt;process.h&gt;</span>
00109 <span class="preprocessor">#endif</span>
00110 <span class="preprocessor">#if HAVE_LIMITS_H</span>
00111 <span class="preprocessor">#include &lt;limits.h&gt;</span>
00112 <span class="preprocessor">#endif</span>
00113 <span class="preprocessor">#if HAVE_PWD_H</span>
00114 <span class="preprocessor">#include &lt;pwd.h&gt;</span>
00115 <span class="preprocessor">#endif</span>
00116 <span class="preprocessor">#if HAVE_GRP_H</span>
00117 <span class="preprocessor">#include &lt;grp.h&gt;</span>
00118 <span class="preprocessor">#endif</span>
00119 
00120 <span class="preprocessor">#ifndef PATH_MAX</span>
00121 <span class="preprocessor"># ifdef _POSIX_PATH_MAX</span>
00122 <span class="preprocessor">#  define PATH_MAX _POSIX_PATH_MAX</span>
00123 <span class="preprocessor"># else</span>
00124 <span class="preprocessor">#  define PATH_MAX 255</span>
00125 <span class="preprocessor"># endif</span>
00126 <span class="preprocessor">#endif</span>
00127 
00128 <span class="preprocessor">#ifndef FD_SET</span>
00129 <span class="keyword">typedef</span> <span class="keywordtype">long</span>    fd_mask;
00130 <span class="preprocessor">#define NFDBITS (sizeof(fd_mask) * NBBY)        </span><span class=
"comment">/* bits per mask */</span>
00131 <span class="preprocessor">#define FD_SET(n, p)    ((p)-&gt;fds_bits[(n)/NFDBITS] |= (1 &lt;&lt; ((n) % NFDBITS)))</span>
00132 <span class=
"preprocessor">#define FD_CLR(n, p)    ((p)-&gt;fds_bits[(n)/NFDBITS] &amp;= ~(1 &lt;&lt; ((n) % NFDBITS)))</span>
00133 <span class=
"preprocessor">#define FD_ISSET(n, p)  ((p)-&gt;fds_bits[(n)/NFDBITS] &amp; (1 &lt;&lt; ((n) % NFDBITS)))</span>
00134 <span class="preprocessor">#define FD_ZERO(p)      memset((p), 0, sizeof(*(p)))</span>
00135 <span class="preprocessor">#endif</span>
00136 
00137 <span class="preprocessor">#include &lt;net-snmp/net-snmp-includes.h&gt;</span>
00138 <span class="preprocessor">#include &lt;net-snmp/agent/net-snmp-agent-includes.h&gt;</span>
00139 
00140 <span class="preprocessor">#include &lt;net-snmp/library/fd_event_manager.h&gt;</span>
00141 
00142 <span class="preprocessor">#include "m2m.h"</span>
00143 <span class="preprocessor">#include &lt;net-snmp/agent/mib_module_config.h&gt;</span>
00144 
00145 <span class="preprocessor">#include "snmpd.h"</span>
00146 <span class="preprocessor">#include "mibgroup/struct.h"</span>
00147 <span class="preprocessor">#include &lt;net-snmp/agent/mib_modules.h&gt;</span>
00148 
00149 <span class="preprocessor">#include "mibgroup/util_funcs.h"</span>
00150 
00151 <span class="preprocessor">#include &lt;net-snmp/agent/agent_trap.h&gt;</span>
00152 
00153 <span class="preprocessor">#include &lt;net-snmp/agent/table.h&gt;</span>
00154 <span class="preprocessor">#include &lt;net-snmp/agent/table_iterator.h&gt;</span>
00155 <span class="preprocessor">#include "mib_module_includes.h"</span>
00156 
00157 <span class="comment">/*</span>
00158 <span class="comment"> * Include winservice.h to support Windows Service</span>
00159 <span class="comment"> */</span>
00160 <span class="preprocessor">#ifdef WIN32</span>
00161 <span class="preprocessor">#include &lt;windows.h&gt;</span>
00162 <span class="preprocessor">#include &lt;tchar.h&gt;</span>
00163 <span class="preprocessor">#include &lt;net-snmp/library/winservice.h&gt;</span>
00164 
00165 <span class="preprocessor">#define WIN32SERVICE</span>
00166 
00167 <span class="preprocessor">#endif</span>
00168 
00169 <span class="comment">/*</span>
00170 <span class="comment"> * Globals.</span>
00171 <span class="comment"> */</span>
00172 <span class="preprocessor">#ifdef USE_LIBWRAP</span>
00173 <span class="preprocessor">#include &lt;tcpd.h&gt;</span>
00174 <span class="preprocessor">#endif                          </span><span class="comment">/* USE_LIBWRAP */</span>
00175 
00176 <span class="preprocessor">#define TIMETICK         500000L</span>
00177 
00178 <span class="keywordtype">int</span>             snmp_dump_packet;
00179 <span class="keywordtype">int</span>             reconfig = 0;
00180 <span class="keywordtype">int</span>             Facility = LOG_DAEMON;
00181 
00182 <span class="preprocessor">#ifdef WIN32SERVICE</span>
00183 <span class="comment">/*</span>
00184 <span class="comment"> * SNMP Agent Status </span>
00185 <span class="comment"> */</span>
00186 <span class="preprocessor">#define AGENT_RUNNING 1</span>
00187 <span class="preprocessor">#define AGENT_STOPPED 0</span>
00188 <span class="keywordtype">int</span>             agent_status = AGENT_STOPPED;
00189 <span class="comment">/* app_name_long used for Event Log (syslog), SCM, registry etc */</span>
00190 LPTSTR          app_name_long = _T(<span class="stringliteral">"Net-SNMP Agent"</span>);     <span class=
"comment">/* Application Name */</span>
00191 <span class="preprocessor">#endif</span>
00192 
00193 <span class="keyword">const</span> <span class="keywordtype">char</span>     *app_name = <span class=
"stringliteral">"snmpd"</span>;
00194 
00195 <span class="keyword">extern</span> <span class="keywordtype">int</span>      netsnmp_running;
00196 <span class="keyword">extern</span> <span class="keywordtype">char</span>   **argvrestartp;
00197 <span class="keyword">extern</span> <span class="keywordtype">char</span>    *argvrestart;
00198 <span class="keyword">extern</span> <span class="keywordtype">char</span>    *argvrestartname;
00199 
00200 <span class="preprocessor">#define NUM_SOCKETS     32</span>
00201 
00202 <span class="preprocessor">#ifdef USING_SMUX_MODULE</span>
00203 <span class="preprocessor">#include &lt;mibgroup/smux/smux.h&gt;</span>
00204 <span class="keyword">static</span> <span class="keywordtype">int</span>      sdlist[NUM_SOCKETS], sdlen = 0;
00205 <span class="preprocessor">#endif                          </span><span class="comment">/* USING_SMUX_MODULE */</span>
00206 
00207 <span class="comment">/*</span>
00208 <span class="comment"> * Prototypes.</span>
00209 <span class="comment"> */</span>
00210 <span class="keywordtype">int</span>             snmp_read_packet(<span class="keywordtype">int</span>);
00211 <span class="keywordtype">int</span>             snmp_input(<span class="keywordtype">int</span>, <a class="code" href=
"structsnmp__session.html">netsnmp_session</a> *, <span class="keywordtype">int</span>, <a class="code" href=
"structsnmp__pdu.html">netsnmp_pdu</a> *,
00212                            <span class="keywordtype">void</span> *);
00213 <span class="keyword">static</span> <span class="keywordtype">void</span>     usage(<span class=
"keywordtype">char</span> *);
00214 <span class="keyword">static</span> <span class="keywordtype">void</span>     SnmpTrapNodeDown(<span class=
"keywordtype">void</span>);
00215 <span class="keyword">static</span> <span class="keywordtype">int</span>      receive(<span class=
"keywordtype">void</span>);
00216 <span class="preprocessor">#ifdef WIN32SERVICE</span>
00217 <span class="keywordtype">void</span>            StopSnmpAgent(<span class="keywordtype">void</span>);
00218 <span class="keywordtype">int</span>             SnmpDaemonMain(<span class="keywordtype">int</span> argc, TCHAR * argv[]);
00219 <span class="keywordtype">int</span> __cdecl     _tmain(<span class="keywordtype">int</span> argc, TCHAR * argv[]);
00220 <span class="preprocessor">#else</span>
00221 <span class="keywordtype">int</span>             main(<span class="keywordtype">int</span>, <span class=
"keywordtype">char</span> **);
00222 <span class="preprocessor">#endif</span>
00223 
00224 <span class="comment">/*</span>
00225 <span class="comment"> * These definitions handle 4.2 systems without additional syslog facilities.</span>
00226 <span class="comment"> */</span>
00227 <span class="preprocessor">#ifndef LOG_CONS</span>
00228 <span class="preprocessor">#define LOG_CONS        0       </span><span class=
"comment">/* Don't bother if not defined... */</span>
00229 <span class="preprocessor">#endif</span>
00230 <span class="preprocessor">#ifndef LOG_PID</span>
00231 <span class="preprocessor">#define LOG_PID         0       </span><span class=
"comment">/* Don't bother if not defined... */</span>
00232 <span class="preprocessor">#endif</span>
00233 <span class="preprocessor">#ifndef LOG_LOCAL0</span>
00234 <span class="preprocessor">#define LOG_LOCAL0      0</span>
00235 <span class="preprocessor">#endif</span>
00236 <span class="preprocessor">#ifndef LOG_LOCAL1</span>
00237 <span class="preprocessor">#define LOG_LOCAL1      0</span>
00238 <span class="preprocessor">#endif</span>
00239 <span class="preprocessor">#ifndef LOG_LOCAL2</span>
00240 <span class="preprocessor">#define LOG_LOCAL2      0</span>
00241 <span class="preprocessor">#endif</span>
00242 <span class="preprocessor">#ifndef LOG_LOCAL3</span>
00243 <span class="preprocessor">#define LOG_LOCAL3      0</span>
00244 <span class="preprocessor">#endif</span>
00245 <span class="preprocessor">#ifndef LOG_LOCAL4</span>
00246 <span class="preprocessor">#define LOG_LOCAL4      0</span>
00247 <span class="preprocessor">#endif</span>
00248 <span class="preprocessor">#ifndef LOG_LOCAL5</span>
00249 <span class="preprocessor">#define LOG_LOCAL5      0</span>
00250 <span class="preprocessor">#endif</span>
00251 <span class="preprocessor">#ifndef LOG_LOCAL6</span>
00252 <span class="preprocessor">#define LOG_LOCAL6      0</span>
00253 <span class="preprocessor">#endif</span>
00254 <span class="preprocessor">#ifndef LOG_LOCAL7</span>
00255 <span class="preprocessor">#define LOG_LOCAL7      0</span>
00256 <span class="preprocessor">#endif</span>
00257 <span class="preprocessor">#ifndef LOG_DAEMON</span>
00258 <span class="preprocessor">#define LOG_DAEMON      0</span>
00259 <span class="preprocessor">#endif</span>
00260 
00261 
00262 <span class="keyword">static</span> <span class="keywordtype">void</span>
00263 usage(<span class="keywordtype">char</span> *prog)
00264 {
00265 <span class="preprocessor">#ifdef WIN32SERVICE</span>
00266     printf(<span class="stringliteral">"\nUsage:  %s [-register] [-quiet] [OPTIONS] [LISTENING ADDRESSES]"</span>,
00267            prog);
00268     printf(<span class="stringliteral">"\n        %s [-unregister] [-quiet]"</span>, prog);
00269 <span class="preprocessor">#else</span>
00270     printf(<span class="stringliteral">"\nUsage:  %s [OPTIONS] [LISTENING ADDRESSES]"</span>, prog);
00271 <span class="preprocessor">#endif</span>
00272     printf(<span class="stringliteral">"\n"</span>);
00273     printf(<span class="stringliteral">"\n\tVersion:  %s\n"</span>, netsnmp_get_version());
00274     printf(<span class="stringliteral">"\tWeb:      http://www.net-snmp.org/\n"</span>);
00275     printf(<span class="stringliteral">"\tEmail:    net-snmp-coders@lists.sourceforge.net\n"</span>);
00276     printf(<span class="stringliteral">"\n  -a\t\t\tlog addresses\n"</span>);
00277     printf(<span class="stringliteral">"  -A\t\t\tappend to the logfile rather than truncating it\n"</span>);
00278     printf(<span class="stringliteral">"  -c FILE[,...]\t\tread FILE(s) as configuration file(s)\n"</span>);
00279     printf(<span class="stringliteral">"  -C\t\t\tdo not read the default configuration files\n"</span>);
00280     printf(<span class="stringliteral">"  -d\t\t\tdump sent and received SNMP packets\n"</span>);
00281     printf(<span class="stringliteral">"  -D TOKEN[,...]\tturn on debugging output for the given TOKEN(s)\n"</span>
00282            <span class="stringliteral">"\t\t\t  (try ALL for extremely verbose output)\n"</span>);
00283     printf(<span class="stringliteral">"  -f\t\t\tdo not fork from the shell\n"</span>);
00284 <span class="preprocessor">#if HAVE_UNISTD_H</span>
00285     printf(<span class="stringliteral">"  -g GID\t\tchange to this numeric gid after opening\n"</span>
00286            <span class="stringliteral">"\t\t\t  transport endpoints\n"</span>);
00287 <span class="preprocessor">#endif</span>
00288     printf(<span class="stringliteral">"  -h, --help\t\tdisplay this usage message\n"</span>);
00289     printf(<span class="stringliteral">"  -H\t\t\tdisplay configuration file directives understood\n"</span>);
00290     printf(<span class="stringliteral">"  -I [-]INITLIST\tlist of mib modules to initialize (or not)\n"</span>);
00291     printf(<span class="stringliteral">"\t\t\t  (run snmpd with -Dmib_init for a list)\n"</span>);
00292     printf(<span class="stringliteral">"  -L &lt;LOGOPTS&gt;\t\ttoggle options controlling where to log to\n"</span>);
00293     snmp_log_options_usage(<span class="stringliteral">"\t"</span>, stdout);
00294     printf(<span class="stringliteral">"  -m MIBLIST\t\tuse MIBLIST instead of the default MIB list\n"</span>);
00295     printf(<span class=
"stringliteral">"  -M DIRLIST\t\tuse DIRLIST as the list of locations\n\t\t\t  to look for MIBs\n"</span>);
00296     printf(<span class="stringliteral">"  -p FILE\t\tstore process id in FILE\n"</span>);
00297     printf(<span class="stringliteral">"  -q\t\t\tprint information in a more parsable format\n"</span>);
00298     printf(<span class="stringliteral">"  -r\t\t\tdo not exit if files only accessible to root\n"</span>
00299            <span class="stringliteral">"\t\t\t  cannot be opened\n"</span>);
00300 <span class="preprocessor">#ifdef WIN32SERVICE</span>
00301     printf(<span class="stringliteral">"  -register\t\tregister as a Windows service\n"</span>);
00302     printf(<span class="stringliteral">"  \t\t\t  (followed by -quiet to prevent message popups)\n"</span>);
00303     printf(<span class="stringliteral">"  \t\t\t  (followed by the startup parameter list)\n"</span>);
00304     printf(<span class=
"stringliteral">"  \t\t\t  Note that some parameters are not relevant when running as a service\n"</span>);
00305 <span class="preprocessor">#endif</span>
00306 <span class="preprocessor">#if HAVE_UNISTD_H</span>
00307     printf(<span class="stringliteral">"  -u UID\t\tchange to this uid (numeric or textual) after\n"</span>
00308            <span class="stringliteral">"\t\t\t  opening transport endpoints\n"</span>);
00309 <span class="preprocessor">#endif</span>
00310 <span class="preprocessor">#ifdef WIN32SERVICE</span>
00311     printf(<span class="stringliteral">"  -unregister\t\tunregister as a Windows service\n"</span>);
00312     printf(<span class="stringliteral">"  \t\t\t  (followed -quiet to prevent message popups)\n"</span>);
00313 <span class="preprocessor">#endif</span>
00314     printf(<span class="stringliteral">"  -v, --version\t\tdisplay version information\n"</span>);
00315     printf(<span class="stringliteral">"  -V\t\t\tverbose display\n"</span>);
00316 <span class="preprocessor">#if defined(USING_AGENTX_SUBAGENT_MODULE)|| defined(USING_AGENTX_MASTER_MODULE)</span>
00317     printf(<span class="stringliteral">"  -x ADDRESS\t\tuse ADDRESS as AgentX address\n"</span>);
00318 <span class="preprocessor">#endif</span>
00319 <span class="preprocessor">#ifdef USING_AGENTX_SUBAGENT_MODULE</span>
00320     printf(<span class="stringliteral">"  -X\t\t\trun as an AgentX subagent rather than as an\n"</span>
00321            <span class="stringliteral">"\t\t\t  SNMP master agent\n"</span>);
00322 <span class="preprocessor">#endif</span>
00323 
00324     printf(<span class="stringliteral">"\nDeprecated options:\n"</span>);
00325     printf(<span class="stringliteral">"  -l FILE\t\tuse -Lf &lt;FILE&gt; instead\n"</span>);
00326     printf(<span class="stringliteral">"  -P\t\t\tuse -p instead\n"</span>);
00327     printf(<span class="stringliteral">"  -s\t\t\tuse -Lsd instead\n"</span>);
00328     printf(<span class="stringliteral">"  -S d|i|0-7\t\tuse -Ls &lt;facility&gt; instead\n"</span>);
00329 
00330     printf(<span class="stringliteral">"\n"</span>);
00331     exit(1);
00332 }
00333 
00334 <span class="keyword">static</span> <span class="keywordtype">void</span>
00335 version(<span class="keywordtype">void</span>)
00336 {
00337     printf(<span class="stringliteral">"\nNET-SNMP version:  %s\n"</span>, netsnmp_get_version());
00338     printf(<span class="stringliteral">"Web:               http://www.net-snmp.org/\n"</span>);
00339     printf(<span class="stringliteral">"Email:             net-snmp-coders@lists.sourceforge.net\n\n"</span>);
00340     exit(0);
00341 }
00342 
00343 RETSIGTYPE
00344 SnmpdShutDown(<span class="keywordtype">int</span> a)
00345 {
00346 <span class="preprocessor">#ifdef WIN32SERVICE</span>
00347     <span class="keyword">extern</span> <a class="code" href="structsnmp__session.html">netsnmp_session</a> *main_session;
00348 <span class="preprocessor">#endif</span>
00349     netsnmp_running = 0;
00350 <span class="preprocessor">#ifdef WIN32SERVICE</span>
00351     <span class="comment">/*</span>
00352 <span class="comment">     * In case of windows, select() in receive() function will not return </span>
00353 <span class="comment">     * on signal. Thats why following function is called, which closes the </span>
00354 <span class="comment">     * socket descriptors and causes the select() to return</span>
00355 <span class="comment">     */</span>
00356     snmp_close(main_session);
00357 <span class="preprocessor">#endif</span>
00358 }
00359 
00360 <span class="preprocessor">#ifdef SIGHUP</span>
00361 RETSIGTYPE
00362 SnmpdReconfig(<span class="keywordtype">int</span> a)
00363 {
00364     reconfig = 1;
00365     signal(SIGHUP, SnmpdReconfig);
00366 }
00367 <span class="preprocessor">#endif</span>
00368 
00369 <span class="preprocessor">#ifdef SIGUSR1</span>
00370 <span class="keyword">extern</span> <span class="keywordtype">void</span>     dump_registry(<span class=
"keywordtype">void</span>);
00371 RETSIGTYPE
00372 SnmpdDump(<span class="keywordtype">int</span> a)
00373 {
00374     dump_registry();
00375     signal(SIGUSR1, SnmpdDump);
00376 }
00377 <span class="preprocessor">#endif</span>
00378 
00379 RETSIGTYPE
00380 SnmpdCatchRandomSignal(<span class="keywordtype">int</span> a)
00381 {
00382     <span class="comment">/* Disable all logs and log the error via syslog */</span>
00383     snmp_disable_log();
00384     snmp_enable_syslog();
00385     <a class="code" href="group__snmp__logging.html#ga41">snmp_log</a>(LOG_ERR, <span class=
"stringliteral">"Exiting on signal %d\n"</span>, a);
00386     snmp_disable_syslog();
00387     exit(1);
00388 }
00389 
00390 <span class="keyword">static</span> <span class="keywordtype">void</span>
00391 SnmpTrapNodeDown(<span class="keywordtype">void</span>)
00392 {
00393     <a class="code" href="group__agent__trap.html#ga43">send_easy_trap</a>(SNMP_TRAP_ENTERPRISESPECIFIC, 2);
00394     <span class="comment">/*</span>
00395 <span class="comment">     * XXX  2 - Node Down #define it as NODE_DOWN_TRAP </span>
00396 <span class="comment">     */</span>
00397 }
00398 
00399 <span class="comment">/*******************************************************************-o-******</span>
00400 <span class="comment"> * main - Non Windows</span>
00401 <span class="comment"> * SnmpDaemonMain - Windows to support windows service</span>
00402 <span class="comment"> *</span>
00403 <span class="comment"> * Parameters:</span>
00404 <span class="comment"> *       argc</span>
00405 <span class="comment"> *      *argv[]</span>
00406 <span class="comment"> *      </span>
00407 <span class="comment"> * Returns:</span>
00408 <span class="comment"> *      0       Always succeeds.  (?)</span>
00409 <span class="comment"> *</span>
00410 <span class="comment"> *</span>
00411 <span class="comment"> * Setup and start the agent daemon.</span>
00412 <span class="comment"> *</span>
00413 <span class="comment"> * Also successfully EXITs with zero for some options.</span>
00414 <span class="comment"> */</span>
00415 <span class="keywordtype">int</span>
00416 <span class="preprocessor">#ifdef WIN32SERVICE</span>
00417 SnmpDaemonMain(<span class="keywordtype">int</span> argc, TCHAR * argv[])
00418 #<span class="keywordflow">else</span>
00419 main(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> *argv[])
00420 #endif
00421 {
00422     <span class="keywordtype">char</span>            options[128] = <span class=
"stringliteral">"aAc:CdD::fhHI:l:L:m:M:n:p:P:qrsS:UvV-:"</span>;
00423     <span class="keywordtype">int</span>             arg, i, ret;
00424     <span class="keywordtype">int</span>             dont_fork = 0, do_help = 0;
00425     <span class="keywordtype">int</span>             log_set = 0;
00426     <span class="keywordtype">int</span>             uid = 0, gid = 0;
00427     <span class="keywordtype">int</span>             agent_mode = -1;
00428     <span class="keywordtype">char</span>           *cptr, **argvptr;
00429     <span class="keywordtype">char</span>           *pid_file = NULL;
00430     <span class="keywordtype">char</span>            option_compatability[] = <span class="stringliteral">"-Le"</span>;
00431 <span class="preprocessor">#if HAVE_GETPID</span>
00432     <span class="keywordtype">int</span> fd;
00433     FILE           *PID;
00434 <span class="preprocessor">#endif</span>
00435 
00436 <span class="preprocessor">#ifndef WIN32</span>
00437     <span class="comment">/*</span>
00438 <span class="comment">     * close all non-standard file descriptors we may have</span>
00439 <span class="comment">     * inherited from the shell.</span>
00440 <span class="comment">     */</span>
00441     <span class="keywordflow">for</span> (i = getdtablesize() - 1; i &gt; 2; --i) {
00442         (void) close(i);
00443     }
00444 <span class="preprocessor">#endif </span><span class="comment">/* #WIN32 */</span>
00445     
00446     <span class="comment">/*</span>
00447 <span class="comment">     * register signals ASAP to prevent default action (usually core)</span>
00448 <span class="comment">     * for signals during startup...</span>
00449 <span class="comment">     */</span>
00450 <span class="preprocessor">#ifdef SIGTERM</span>
00451     DEBUGMSGTL((<span class="stringliteral">"signal"</span>, <span class=
"stringliteral">"registering SIGTERM signal handler\n"</span>));
00452     signal(SIGTERM, SnmpdShutDown);
00453 <span class="preprocessor">#endif</span>
00454 <span class="preprocessor">#ifdef SIGINT</span>
00455     DEBUGMSGTL((<span class="stringliteral">"signal"</span>, <span class=
"stringliteral">"registering SIGINT signal handler\n"</span>));
00456     signal(SIGINT, SnmpdShutDown);
00457 <span class="preprocessor">#endif</span>
00458 <span class="preprocessor">#ifdef SIGHUP</span>
00459     DEBUGMSGTL((<span class="stringliteral">"signal"</span>, <span class=
"stringliteral">"registering SIGHUP signal handler\n"</span>));
00460     signal(SIGHUP, SnmpdReconfig);
00461 <span class="preprocessor">#endif</span>
00462 <span class="preprocessor">#ifdef SIGUSR1</span>
00463     DEBUGMSGTL((<span class="stringliteral">"signal"</span>, <span class=
"stringliteral">"registering SIGUSR1 signal handler\n"</span>));
00464     signal(SIGUSR1, SnmpdDump);
00465 <span class="preprocessor">#endif</span>
00466 <span class="preprocessor">#ifdef SIGPIPE</span>
00467     DEBUGMSGTL((<span class="stringliteral">"signal"</span>, <span class=
"stringliteral">"registering SIGPIPE signal handler\n"</span>));
00468     signal(SIGPIPE, SIG_IGN);   <span class="comment">/* 'Inline' failure of wayward readers */</span>
00469 <span class="preprocessor">#endif</span>
00470 <span class="preprocessor">#ifdef SIGXFSZ</span>
00471     signal(SIGXFSZ, SnmpdCatchRandomSignal);
00472 <span class="preprocessor">#endif</span>
00473 
00474 <span class="preprocessor">#ifdef NO_ROOT_ACCESS</span>
00475     <span class="comment">/*</span>
00476 <span class="comment">     * Default to no.  </span>
00477 <span class="comment">     */</span>
00478     <a class="code" href="group__default__store.html#ga8">netsnmp_ds_set_boolean</a>(NETSNMP_DS_APPLICATION_ID, 
00479                            NETSNMP_DS_AGENT_NO_ROOT_ACCESS, 1);
00480 <span class="preprocessor">#endif</span>
00481     <span class="comment">/*</span>
00482 <span class="comment">     * Default to NOT running an AgentX master.  </span>
00483 <span class="comment">     */</span>
00484     <a class="code" href="group__default__store.html#ga8">netsnmp_ds_set_boolean</a>(NETSNMP_DS_APPLICATION_ID, 
00485                            NETSNMP_DS_AGENT_AGENTX_MASTER, 0);
00486     netsnmp_ds_set_int(NETSNMP_DS_APPLICATION_ID,
00487                        NETSNMP_DS_AGENT_AGENTX_TIMEOUT, -1);
00488     netsnmp_ds_set_int(NETSNMP_DS_APPLICATION_ID,
00489                        NETSNMP_DS_AGENT_AGENTX_RETRIES, -1);
00490 
00491     netsnmp_ds_set_int(NETSNMP_DS_APPLICATION_ID,
00492                        NETSNMP_DS_AGENT_CACHE_TIMEOUT, 5);
00493     <span class="comment">/*</span>
00494 <span class="comment">     * Add some options if they are available.  </span>
00495 <span class="comment">     */</span>
00496 <span class="preprocessor">#if HAVE_UNISTD_H</span>
00497     strcat(options, <span class="stringliteral">"g:u:"</span>);
00498 <span class="preprocessor">#endif</span>
00499 <span class="preprocessor">#if defined(USING_AGENTX_SUBAGENT_MODULE)|| defined(USING_AGENTX_MASTER_MODULE)</span>
00500     strcat(options, <span class="stringliteral">"x:"</span>);
00501 <span class="preprocessor">#endif</span>
00502 <span class="preprocessor">#ifdef USING_AGENTX_SUBAGENT_MODULE</span>
00503     strcat(options, <span class="stringliteral">"X"</span>);
00504 <span class="preprocessor">#endif</span>
00505 
00506     <span class="comment">/*</span>
00507 <span class="comment">     * This is incredibly ugly, but it's probably the simplest way</span>
00508 <span class="comment">     *  to handle the old '-L' option as well as the new '-Lx' style</span>
00509 <span class="comment">     */</span>
00510     <span class="keywordflow">for</span> (i=0; i&lt;argc; i++) {
00511         <span class="keywordflow">if</span> (!strcmp(argv[i], <span class="stringliteral">"-L"</span>))
00512             argv[i] = option_compatability;            
00513     }
00514 
00515 <span class="preprocessor">#ifdef WIN32</span>
00516     snmp_log_syslogname(app_name_long);
00517 <span class="preprocessor">#else</span>
00518     snmp_log_syslogname(app_name);
00519 <span class="preprocessor">#endif</span>
00520     netsnmp_ds_set_string(NETSNMP_DS_LIBRARY_ID,
00521                           NETSNMP_DS_LIB_APPTYPE, app_name);
00522 
00523     <span class="comment">/*</span>
00524 <span class="comment">     * Now process options normally.  </span>
00525 <span class="comment">     */</span>
00526     <span class="keywordflow">while</span> ((arg = getopt(argc, argv, options)) != EOF) {
00527         <span class="keywordflow">switch</span> (arg) {
00528         <span class="keywordflow">case</span> <span class="charliteral">'-'</span>:
00529             <span class="keywordflow">if</span> (strcasecmp(optarg, <span class="stringliteral">"help"</span>) == 0) {
00530                 usage(argv[0]);
00531             }
00532             <span class="keywordflow">if</span> (strcasecmp(optarg, <span class="stringliteral">"version"</span>) == 0) {
00533                 version();
00534             }
00535 
00536             handle_long_opt(optarg);
00537             <span class="keywordflow">break</span>;
00538 
00539         <span class="keywordflow">case</span> <span class="charliteral">'a'</span>:
00540             log_addresses++;
00541             <span class="keywordflow">break</span>;
00542 
00543         <span class="keywordflow">case</span> <span class="charliteral">'A'</span>:
00544             <a class="code" href="group__default__store.html#ga8">netsnmp_ds_set_boolean</a>(NETSNMP_DS_LIBRARY_ID,
00545                                    NETSNMP_DS_LIB_APPEND_LOGFILES, 1);
00546             <span class="keywordflow">break</span>;
00547 
00548         <span class="keywordflow">case</span> <span class="charliteral">'c'</span>:
00549             <span class="keywordflow">if</span> (optarg != NULL) {
00550                 netsnmp_ds_set_string(NETSNMP_DS_LIBRARY_ID, 
00551                                       NETSNMP_DS_LIB_OPTIONALCONFIG, optarg);
00552             } <span class="keywordflow">else</span> {
00553                 usage(argv[0]);
00554             }
00555             <span class="keywordflow">break</span>;
00556 
00557         <span class="keywordflow">case</span> <span class="charliteral">'C'</span>:
00558             <a class="code" href="group__default__store.html#ga8">netsnmp_ds_set_boolean</a>(NETSNMP_DS_LIBRARY_ID, 
00559                                    NETSNMP_DS_LIB_DONT_READ_CONFIGS, 1);
00560             <span class="keywordflow">break</span>;
00561 
00562         <span class="keywordflow">case</span> <span class="charliteral">'d'</span>:
00563             snmp_set_dump_packet(++snmp_dump_packet);
00564             <a class="code" href="group__default__store.html#ga8">netsnmp_ds_set_boolean</a>(NETSNMP_DS_APPLICATION_ID, 
00565                                    NETSNMP_DS_AGENT_VERBOSE, 1);
00566             <span class="keywordflow">break</span>;
00567 
00568         <span class="keywordflow">case</span> <span class="charliteral">'D'</span>:
00569             debug_register_tokens(optarg);
00570             snmp_set_do_debugging(1);
00571             <span class="keywordflow">break</span>;
00572 
00573         <span class="keywordflow">case</span> <span class="charliteral">'f'</span>:
00574             dont_fork = 1;
00575             <span class="keywordflow">break</span>;
00576 
00577 <span class="preprocessor">#if HAVE_UNISTD_H</span>
00578         <span class="keywordflow">case</span> <span class="charliteral">'g'</span>:
00579             <span class="keywordflow">if</span> (optarg != NULL) {
00580                 netsnmp_ds_set_int(NETSNMP_DS_APPLICATION_ID, 
00581                                    NETSNMP_DS_AGENT_GROUPID, atoi(optarg));
00582             } <span class="keywordflow">else</span> {
00583                 usage(argv[0]);
00584             }
00585             <span class="keywordflow">break</span>;
00586 <span class="preprocessor">#endif</span>
00587 
00588         <span class="keywordflow">case</span> <span class="charliteral">'h'</span>:
00589             usage(argv[0]);
00590             <span class="keywordflow">break</span>;
00591 
00592         <span class="keywordflow">case</span> <span class="charliteral">'H'</span>:
00593             do_help = 1;
00594             <span class="keywordflow">break</span>;
00595 
00596         <span class="keywordflow">case</span> <span class="charliteral">'I'</span>:
00597             <span class="keywordflow">if</span> (optarg != NULL) {
00598                 add_to_init_list(optarg);
00599             } <span class="keywordflow">else</span> {
00600                 usage(argv[0]);
00601             }
00602             <span class="keywordflow">break</span>;
00603 
00604         <span class="keywordflow">case</span> <span class="charliteral">'l'</span>:
00605             printf(<span class="stringliteral">"Warning: -l option is deprecated, use -Lf &lt;file&gt; instead\n"</span>);
00606             <span class="keywordflow">if</span> (optarg != NULL) {
00607                 <span class="keywordflow">if</span> (strlen(optarg) &gt; PATH_MAX) {
00608                     fprintf(stderr,
00609                             <span class="stringliteral">"%s: logfile path too long (limit %d chars)\n"</span>,
00610                             argv[0], PATH_MAX);
00611                     exit(1);
00612                 }
00613                 snmp_enable_filelog(optarg,
00614                                     netsnmp_ds_get_boolean(NETSNMP_DS_LIBRARY_ID,
00615                                                            NETSNMP_DS_LIB_APPEND_LOGFILES));
00616                 log_set = 1;
00617             } <span class="keywordflow">else</span> {
00618                 usage(argv[0]);
00619             }
00620             <span class="keywordflow">break</span>;
00621 
00622         <span class="keywordflow">case</span> <span class="charliteral">'L'</span>:
00623             <span class="keywordflow">if</span>  (snmp_log_options( optarg, argc, argv ) &lt; 0 ) {
00624                 usage(argv[0]);
00625             }
00626             log_set = 1;
00627             <span class="keywordflow">break</span>;
00628 
00629         <span class="keywordflow">case</span> <span class="charliteral">'m'</span>:
00630             <span class="keywordflow">if</span> (optarg != NULL) {
00631                 setenv(<span class="stringliteral">"MIBS"</span>, optarg, 1);
00632             } <span class="keywordflow">else</span> {
00633                 usage(argv[0]);
00634             }
00635             <span class="keywordflow">break</span>;
00636 
00637         <span class="keywordflow">case</span> <span class="charliteral">'M'</span>:
00638             <span class="keywordflow">if</span> (optarg != NULL) {
00639                 setenv(<span class="stringliteral">"MIBDIRS"</span>, optarg, 1);
00640             } <span class="keywordflow">else</span> {
00641                 usage(argv[0]);
00642             }
00643             <span class="keywordflow">break</span>;
00644 
00645         <span class="keywordflow">case</span> <span class="charliteral">'n'</span>:
00646             <span class="keywordflow">if</span> (optarg != NULL) {
00647                 app_name = optarg;
00648                 netsnmp_ds_set_string(NETSNMP_DS_LIBRARY_ID,
00649                                       NETSNMP_DS_LIB_APPTYPE, app_name);
00650             } <span class="keywordflow">else</span> {
00651                 usage(argv[0]);
00652             }
00653             <span class="keywordflow">break</span>;
00654 
00655         <span class="keywordflow">case</span> <span class="charliteral">'P'</span>:
00656             printf(<span class="stringliteral">"Warning: -P option is deprecated, use -p instead\n"</span>);
00657         <span class="keywordflow">case</span> <span class="charliteral">'p'</span>:
00658             <span class="keywordflow">if</span> (optarg != NULL) {
00659                 pid_file = optarg;
00660             } <span class="keywordflow">else</span> {
00661                 usage(argv[0]);
00662             }
00663             <span class="keywordflow">break</span>;
00664 
00665         <span class="keywordflow">case</span> <span class="charliteral">'q'</span>:
00666             snmp_set_quick_print(1);
00667             <span class="keywordflow">break</span>;
00668 
00669         <span class="keywordflow">case</span> <span class="charliteral">'r'</span>:
00670             netsnmp_ds_toggle_boolean(NETSNMP_DS_APPLICATION_ID, 
00671                                       NETSNMP_DS_AGENT_NO_ROOT_ACCESS);
00672             <span class="keywordflow">break</span>;
00673 
00674         <span class="keywordflow">case</span> <span class="charliteral">'s'</span>:
00675             printf(<span class="stringliteral">"Warning: -s option is deprecated, use -Lsd instead\n"</span>);
00676             snmp_enable_syslog();
00677             log_set = 1;
00678             <span class="keywordflow">break</span>;
00679 
00680         <span class="keywordflow">case</span> <span class="charliteral">'S'</span>:
00681             printf(<span class=
"stringliteral">"Warning: -S option is deprecated, use -Ls &lt;facility&gt; instead\n"</span>);
00682             <span class="keywordflow">if</span> (optarg != NULL) {
00683                 <span class="keywordflow">switch</span> (*optarg) {
00684                 <span class="keywordflow">case</span> <span class="charliteral">'d'</span>:
00685                 <span class="keywordflow">case</span> <span class="charliteral">'D'</span>:
00686                     Facility = LOG_DAEMON;
00687                     <span class="keywordflow">break</span>;
00688                 <span class="keywordflow">case</span> <span class="charliteral">'i'</span>:
00689                 <span class="keywordflow">case</span> <span class="charliteral">'I'</span>:
00690                     Facility = LOG_INFO;
00691                     <span class="keywordflow">break</span>;
00692                 <span class="keywordflow">case</span> <span class="charliteral">'0'</span>:
00693                     Facility = LOG_LOCAL0;
00694                     <span class="keywordflow">break</span>;
00695                 <span class="keywordflow">case</span> <span class="charliteral">'1'</span>:
00696                     Facility = LOG_LOCAL1;
00697                     <span class="keywordflow">break</span>;
00698                 <span class="keywordflow">case</span> <span class="charliteral">'2'</span>:
00699                     Facility = LOG_LOCAL2;
00700                     <span class="keywordflow">break</span>;
00701                 <span class="keywordflow">case</span> <span class="charliteral">'3'</span>:
00702                     Facility = LOG_LOCAL3;
00703                     <span class="keywordflow">break</span>;
00704                 <span class="keywordflow">case</span> <span class="charliteral">'4'</span>:
00705                     Facility = LOG_LOCAL4;
00706                     <span class="keywordflow">break</span>;
00707                 <span class="keywordflow">case</span> <span class="charliteral">'5'</span>:
00708                     Facility = LOG_LOCAL5;
00709                     <span class="keywordflow">break</span>;
00710                 <span class="keywordflow">case</span> <span class="charliteral">'6'</span>:
00711                     Facility = LOG_LOCAL6;
00712                     <span class="keywordflow">break</span>;
00713                 <span class="keywordflow">case</span> <span class="charliteral">'7'</span>:
00714                     Facility = LOG_LOCAL7;
00715                     <span class="keywordflow">break</span>;
00716                 <span class="keywordflow">default</span>:
00717                     fprintf(stderr, <span class="stringliteral">"invalid syslog facility: -S%c\n"</span>,*optarg);
00718                     usage(argv[0]);
00719                 }
00720                 snmp_enable_syslog_ident(snmp_log_syslogname(NULL), Facility);
00721                 log_set = 1;
00722             } <span class="keywordflow">else</span> {
00723                 fprintf(stderr, <span class="stringliteral">"no syslog facility specified\n"</span>);
00724                 usage(argv[0]);
00725             }
00726             <span class="keywordflow">break</span>;
00727 
00728         <span class="keywordflow">case</span> <span class="charliteral">'U'</span>:
00729             netsnmp_ds_toggle_boolean(NETSNMP_DS_APPLICATION_ID, 
00730                                       NETSNMP_DS_AGENT_LEAVE_PIDFILE);
00731             <span class="keywordflow">break</span>;
00732 
00733 <span class="preprocessor">#if HAVE_UNISTD_H</span>
00734         <span class="keywordflow">case</span> <span class="charliteral">'u'</span>:
00735             <span class="keywordflow">if</span> (optarg != NULL) {
00736                 <span class="keywordtype">char</span>           *ecp;
00737                 <span class="keywordtype">int</span>             uid;
00738 
00739                 uid = strtoul(optarg, &amp;ecp, 10);
00740                 <span class="keywordflow">if</span> (*ecp) {
00741 <span class="preprocessor">#if HAVE_GETPWNAM &amp;&amp; HAVE_PWD_H</span>
00742                     <span class="keyword">struct </span>passwd  *info;
00743                     info = getpwnam(optarg);
00744                     <span class="keywordflow">if</span> (info) {
00745                         uid = info-&gt;pw_uid;
00746                     } <span class="keywordflow">else</span> {
00747 <span class="preprocessor">#endif</span>
00748                         fprintf(stderr, <span class="stringliteral">"Bad user id: %s\n"</span>, optarg);
00749                         exit(1);
00750 <span class="preprocessor">#if HAVE_GETPWNAM &amp;&amp; HAVE_PWD_H</span>
00751                     }
00752 <span class="preprocessor">#endif</span>
00753                 }
00754                 netsnmp_ds_set_int(NETSNMP_DS_APPLICATION_ID, 
00755                                    NETSNMP_DS_AGENT_USERID, uid);
00756             } <span class="keywordflow">else</span> {
00757                 usage(argv[0]);
00758             }
00759             <span class="keywordflow">break</span>;
00760 <span class="preprocessor">#endif</span>
00761 
00762         <span class="keywordflow">case</span> <span class="charliteral">'v'</span>:
00763             version();
00764 
00765         <span class="keywordflow">case</span> <span class="charliteral">'V'</span>:
00766             <a class="code" href="group__default__store.html#ga8">netsnmp_ds_set_boolean</a>(NETSNMP_DS_APPLICATION_ID, 
00767                                    NETSNMP_DS_AGENT_VERBOSE, 1);
00768             <span class="keywordflow">break</span>;
00769 
00770 <span class="preprocessor">#if defined(USING_AGENTX_SUBAGENT_MODULE)|| defined(USING_AGENTX_MASTER_MODULE)</span>
00771         <span class="keywordflow">case</span> <span class="charliteral">'x'</span>:
00772             <span class="keywordflow">if</span> (optarg != NULL) {
00773                 netsnmp_ds_set_string(NETSNMP_DS_APPLICATION_ID, 
00774                                       NETSNMP_DS_AGENT_X_SOCKET, optarg);
00775             } <span class="keywordflow">else</span> {
00776                 usage(argv[0]);
00777             }
00778             <a class="code" href="group__default__store.html#ga8">netsnmp_ds_set_boolean</a>(NETSNMP_DS_APPLICATION_ID, 
00779                                    NETSNMP_DS_AGENT_AGENTX_MASTER, 1);
00780             <span class="keywordflow">break</span>;
00781 <span class="preprocessor">#endif</span>
00782 
00783         <span class="keywordflow">case</span> <span class="charliteral">'X'</span>:
00784 <span class="preprocessor">#if defined(USING_AGENTX_SUBAGENT_MODULE)</span>
00785             agent_mode = SUB_AGENT;
00786 <span class="preprocessor">#else</span>
00787             fprintf(stderr, <span class="stringliteral">"%s: Illegal argument -X:"</span>
00788                             <span class="stringliteral">"AgentX support not compiled in.\n"</span>, argv[0]);
00789             usage(argv[0]);
00790             exit(1);
00791 <span class="preprocessor">#endif</span>
00792             <span class="keywordflow">break</span>;
00793 
00794         <span class="keywordflow">default</span>:
00795             usage(argv[0]);
00796             <span class="keywordflow">break</span>;
00797         }
00798     }
00799 
00800     <span class="keywordflow">if</span> (do_help) {
00801         <a class="code" href="group__default__store.html#ga8">netsnmp_ds_set_boolean</a>(NETSNMP_DS_APPLICATION_ID, 
00802                                NETSNMP_DS_AGENT_NO_ROOT_ACCESS, 1);
00803         <a class="code" href="group__library.html#ga23">init_agent</a>(app_name);        <span class=
"comment">/* register our .conf handlers */</span>
00804         init_mib_modules();
00805         <a class="code" href="group__library.html#ga56">init_snmp</a>(app_name);
00806         fprintf(stderr, <span class="stringliteral">"Configuration directives understood:\n"</span>);
00807         read_config_print_usage(<span class="stringliteral">"  "</span>);
00808         exit(0);
00809     }
00810 
00811     <span class="keywordflow">if</span> (optind &lt; argc) {
00812         <span class="comment">/*</span>
00813 <span class="comment">         * There are optional transport addresses on the command line.  </span>
00814 <span class="comment">         */</span>
00815         DEBUGMSGTL((<span class="stringliteral">"snmpd/main"</span>, <span class=
"stringliteral">"optind %d, argc %d\n"</span>, optind, argc));
00816         <span class="keywordflow">for</span> (i = optind; i &lt; argc; i++) {
00817             <span class="keywordtype">char</span> *c, *astring;
00818             <span class="keywordflow">if</span> ((c = netsnmp_ds_get_string(NETSNMP_DS_APPLICATION_ID, 
00819                                            NETSNMP_DS_AGENT_PORTS))) {
00820                 astring = malloc(strlen(c) + 2 + strlen(argv[i]));
00821                 <span class="keywordflow">if</span> (astring == NULL) {
00822                     fprintf(stderr, <span class="stringliteral">"malloc failure processing argv[%d]\n"</span>, i);
00823                     exit(1);
00824                 }
00825                 sprintf(astring, <span class="stringliteral">"%s,%s"</span>, c, argv[i]);
00826                 netsnmp_ds_set_string(NETSNMP_DS_APPLICATION_ID, 
00827                                       NETSNMP_DS_AGENT_PORTS, astring);
00828                 <a class="code" href="group__util.html#ga36">SNMP_FREE</a>(astring);
00829             } <span class="keywordflow">else</span> {
00830                 netsnmp_ds_set_string(NETSNMP_DS_APPLICATION_ID, 
00831                                       NETSNMP_DS_AGENT_PORTS, argv[i]);
00832             }
00833         }
00834         DEBUGMSGTL((<span class="stringliteral">"snmpd/main"</span>, <span class="stringliteral">"port spec: %s\n"</span>,
00835                     netsnmp_ds_get_string(NETSNMP_DS_APPLICATION_ID, 
00836                                           NETSNMP_DS_AGENT_PORTS)));
00837     }
00838 
00839 <span class="preprocessor">#ifdef LOGFILE</span>
00840     <span class="keywordflow">if</span> (0 == log_set)
00841         snmp_enable_filelog(LOGFILE,
00842                             netsnmp_ds_get_boolean(NETSNMP_DS_LIBRARY_ID,
00843                                                    NETSNMP_DS_LIB_APPEND_LOGFILES));
00844 <span class="preprocessor">#endif</span>
00845 
00846     <span class="comment">/*</span>
00847 <span class="comment">     * Initialize a argv set to the current for restarting the agent.   </span>
00848 <span class="comment">     */</span>
00849     argvrestartp = (<span class="keywordtype">char</span> **)malloc((argc + 2) * <span class=
"keyword">sizeof</span>(<span class="keywordtype">char</span> *));
00850     argvptr = argvrestartp;
00851     <span class="keywordflow">for</span> (i = 0, ret = 1; i &lt; argc; i++) {
00852         ret += strlen(argv[i]) + 1;
00853     }
00854     argvrestart = (<span class="keywordtype">char</span> *) malloc(ret);
00855     argvrestartname = (<span class="keywordtype">char</span> *) malloc(strlen(argv[0]) + 1);
00856     <span class="keywordflow">if</span> (!argvrestartp || !argvrestart || !argvrestartname) {
00857         fprintf(stderr, <span class="stringliteral">"malloc failure processing argvrestart\n"</span>);
00858         exit(1);
00859     }
00860     strcpy(argvrestartname, argv[0]);
00861     <span class="keywordflow">if</span> (agent_mode == -1) {
00862         <span class="keywordflow">if</span> (strstr(argvrestartname, <span class=
"stringliteral">"agentxd"</span>) != NULL) {
00863             <a class="code" href="group__default__store.html#ga8">netsnmp_ds_set_boolean</a>(NETSNMP_DS_APPLICATION_ID, 
00864                                    NETSNMP_DS_AGENT_ROLE, SUB_AGENT);
00865         } <span class="keywordflow">else</span> {
00866             <a class="code" href="group__default__store.html#ga8">netsnmp_ds_set_boolean</a>(NETSNMP_DS_APPLICATION_ID, 
00867                                    NETSNMP_DS_AGENT_ROLE, MASTER_AGENT);
00868         }
00869     } <span class="keywordflow">else</span> {
00870         <a class="code" href="group__default__store.html#ga8">netsnmp_ds_set_boolean</a>(NETSNMP_DS_APPLICATION_ID, 
00871                                NETSNMP_DS_AGENT_ROLE, agent_mode);
00872     }
00873 
00874     <span class="keywordflow">for</span> (cptr = argvrestart, i = 0; i &lt; argc; i++) {
00875         strcpy(cptr, argv[i]);
00876         *(argvptr++) = cptr;
00877         cptr += strlen(argv[i]) + 1;
00878     }
00879     *cptr = 0;
00880     *argvptr = NULL;
00881 
00882 <span class="preprocessor">#ifdef BUFSIZ</span>
00883     setvbuf(stdout, NULL, _IOLBF, BUFSIZ);
00884 <span class="preprocessor">#endif</span>
00885     <span class="comment">/*</span>
00886 <span class="comment">     * Initialize the world.  Detach from the shell.  Create initial user.  </span>
00887 <span class="comment">     */</span>
00888     <span class="keywordflow">if</span>(!dont_fork) {
00889         <span class="keywordtype">int</span> quit = ! netsnmp_ds_get_boolean(NETSNMP_DS_APPLICATION_ID,
00890                                             NETSNMP_DS_AGENT_QUIT_IMMEDIATELY);
00891         ret = netsnmp_daemonize(quit, snmp_stderrlog_status());
00892         <span class="comment">/*</span>
00893 <span class="comment">         * xxx-rks: do we care if fork fails? I think we should...</span>
00894 <span class="comment">         */</span>
00895         <span class="keywordflow">if</span>(ret != 0)
00896             Exit(1);                <span class="comment">/*  Exit logs exit val for us  */</span>
00897     }
00898 
00899     SOCK_STARTUP;
00900     <a class="code" href="group__library.html#ga23">init_agent</a>(app_name);        <span class=
"comment">/* do what we need to do first. */</span>
00901     init_mib_modules();
00902 
00903     <span class="comment">/*</span>
00904 <span class="comment">     * start library </span>
00905 <span class="comment">     */</span>
00906     <a class="code" href="group__library.html#ga56">init_snmp</a>(app_name);
00907 
00908     <span class="keywordflow">if</span> ((ret = init_master_agent()) != 0) {
00909         <span class="comment">/*</span>
00910 <span class="comment">         * Some error opening one of the specified agent transports.  </span>
00911 <span class="comment">         */</span>
00912         Exit(1);                <span class="comment">/*  Exit logs exit val for us  */</span>
00913     }
00914 
00915     <span class="comment">/*</span>
00916 <span class="comment">     * Store persistent data immediately in case we crash later.  </span>
00917 <span class="comment">     */</span>
00918     snmp_store(app_name);
00919 
00920     <span class="comment">/*</span>
00921 <span class="comment">     * Send coldstart trap if possible.  </span>
00922 <span class="comment">     */</span>
00923     <a class="code" href="group__agent__trap.html#ga43">send_easy_trap</a>(0, 0);
00924 
00925 <span class="preprocessor">#if HAVE_GETPID</span>
00926     <span class="keywordflow">if</span> (pid_file != NULL) {
00927         <span class="comment">/*</span>
00928 <span class="comment">         * unlink the pid_file, if it exists, prior to open.  Without</span>
00929 <span class="comment">         * doing this the open will fail if the user specified pid_file</span>
00930 <span class="comment">         * already exists.</span>
00931 <span class="comment">         */</span>
00932         unlink(pid_file);
00933         fd = open(pid_file, O_CREAT | O_EXCL | O_WRONLY, 0600);
00934         <span class="keywordflow">if</span> (fd == -1) {
00935             snmp_log_perror(pid_file);
00936             <span class="keywordflow">if</span> (!netsnmp_ds_get_boolean(NETSNMP_DS_APPLICATION_ID, 
00937                                         NETSNMP_DS_AGENT_NO_ROOT_ACCESS)) {
00938                 exit(1);
00939             }
00940         } <span class="keywordflow">else</span> {
00941             <span class="keywordflow">if</span> ((PID = fdopen(fd, <span class="stringliteral">"w"</span>)) == NULL) {
00942                 snmp_log_perror(pid_file);
00943                 exit(1);
00944             } <span class="keywordflow">else</span> {
00945                 fprintf(PID, <span class="stringliteral">"%d\n"</span>, (<span class="keywordtype">int</span>) getpid());
00946                 fclose(PID);
00947             }
00948             close(fd);
00949         }
00950     }
00951 <span class="preprocessor">#endif</span>
00952 
00953 <span class="preprocessor">#if HAVE_UNISTD_H</span>
00954 <span class="preprocessor">#ifdef HAVE_SETGID</span>
00955     <span class="keywordflow">if</span> ((gid = netsnmp_ds_get_int(NETSNMP_DS_APPLICATION_ID, 
00956                                   NETSNMP_DS_AGENT_GROUPID)) != 0) {
00957         DEBUGMSGTL((<span class="stringliteral">"snmpd/main"</span>, <span class=
"stringliteral">"Changing gid to %d.\n"</span>, gid));
00958         <span class="keywordflow">if</span> (setgid(gid) == -1
00959 <span class="preprocessor">#ifdef HAVE_SETGROUPS</span>
00960             || setgroups(1, (gid_t *)&amp;gid) == -1
00961 <span class="preprocessor">#endif</span>
00962             ) {
00963             snmp_log_perror(<span class="stringliteral">"setgid failed"</span>);
00964             <span class="keywordflow">if</span> (!netsnmp_ds_get_boolean(NETSNMP_DS_APPLICATION_ID, 
00965                                         NETSNMP_DS_AGENT_NO_ROOT_ACCESS)) {
00966                 exit(1);
00967             }
00968         }
00969     }
00970 <span class="preprocessor">#endif</span>
00971 <span class="preprocessor">#ifdef HAVE_SETUID</span>
00972     <span class="keywordflow">if</span> ((uid = netsnmp_ds_get_int(NETSNMP_DS_APPLICATION_ID, 
00973                                   NETSNMP_DS_AGENT_USERID)) != 0) {
00974         DEBUGMSGTL((<span class="stringliteral">"snmpd/main"</span>, <span class=
"stringliteral">"Changing uid to %d.\n"</span>, uid));
00975         <span class="keywordflow">if</span> (setuid(uid) == -1) {
00976             snmp_log_perror(<span class="stringliteral">"setuid failed"</span>);
00977             <span class="keywordflow">if</span> (!netsnmp_ds_get_boolean(NETSNMP_DS_APPLICATION_ID, 
00978                                         NETSNMP_DS_AGENT_NO_ROOT_ACCESS)) {
00979                 exit(1);
00980             }
00981         }
00982     }
00983 <span class="preprocessor">#endif</span>
00984 <span class="preprocessor">#endif</span>
00985 
00986     <span class="comment">/*</span>
00987 <span class="comment">     * We're up, log our version number.  </span>
00988 <span class="comment">     */</span>
00989     <a class="code" href="group__snmp__logging.html#ga41">snmp_log</a>(LOG_INFO, <span class=
"stringliteral">"NET-SNMP version %s\n"</span>, netsnmp_get_version());
00990 <span class="preprocessor">#ifdef WIN32SERVICE</span>
00991     agent_status = AGENT_RUNNING;
00992 <span class="preprocessor">#endif</span>
00993     netsnmp_addrcache_initialise();
00994 
00995     <span class="comment">/*</span>
00996 <span class="comment">     * Forever monitor the dest_port for incoming PDUs.  </span>
00997 <span class="comment">     */</span>
00998     DEBUGMSGTL((<span class="stringliteral">"snmpd/main"</span>, <span class=
"stringliteral">"We're up.  Starting to process data.\n"</span>));
00999     <span class="keywordflow">if</span> (!netsnmp_ds_get_boolean(NETSNMP_DS_APPLICATION_ID, 
01000                                 NETSNMP_DS_AGENT_QUIT_IMMEDIATELY))
01001         receive();
01002     DEBUGMSGTL((<span class="stringliteral">"snmpd/main"</span>, <span class=
"stringliteral">"sending shutdown trap\n"</span>));
01003     SnmpTrapNodeDown();
01004     DEBUGMSGTL((<span class="stringliteral">"snmpd/main"</span>, <span class="stringliteral">"Bye...\n"</span>));
01005     <a class="code" href="group__library.html#ga58">snmp_shutdown</a>(app_name);
01006 <span class="preprocessor">#ifdef SHUTDOWN_AGENT_CLEANLY </span><span class="comment">/* broken code */</span>
01007     <span class="comment">/* these attempt to free all known memory, but result in double frees */</span>
01008     shutdown_master_agent();
01009     shutdown_agent();
01010 <span class="preprocessor">#endif</span>
01011 
01012     <span class="keywordflow">if</span> (!netsnmp_ds_get_boolean(NETSNMP_DS_APPLICATION_ID, 
01013                                 NETSNMP_DS_AGENT_LEAVE_PIDFILE) &amp;&amp;
01014         (pid_file != NULL)) {
01015         unlink(pid_file);
01016     }
01017 <span class="preprocessor">#ifdef WIN32SERVICE</span>
01018     agent_status = AGENT_STOPPED;
01019 <span class="preprocessor">#endif</span>
01020 
01021     <a class="code" href="group__util.html#ga36">SNMP_FREE</a>(argvrestartname);
01022     <a class="code" href="group__util.html#ga36">SNMP_FREE</a>(argvrestart);
01023     <a class="code" href="group__util.html#ga36">SNMP_FREE</a>(argvrestartp);
01024     SOCK_CLEANUP;
01025     <span class="keywordflow">return</span> 0;
01026 }                               <span class="comment">/* End main() -- snmpd */</span>
01027 
01028 <span class="comment">/*******************************************************************-o-******</span>
01029 <span class="comment"> * receive</span>
01030 <span class="comment"> *</span>
01031 <span class="comment"> * Parameters:</span>
01032 <span class="comment"> *      </span>
01033 <span class="comment"> * Returns:</span>
01034 <span class="comment"> *      0       On success.</span>
01035 <span class="comment"> *      -1      System error.</span>
01036 <span class="comment"> *</span>
01037 <span class="comment"> * Infinite while-loop which monitors incoming messges for the agent.</span>
01038 <span class="comment"> * Invoke the established message handlers for incoming messages on a per</span>
01039 <span class="comment"> * port basis.  Handle timeouts.</span>
01040 <span class="comment"> */</span>
01041 <span class="keyword">static</span> <span class="keywordtype">int</span>
01042 receive(<span class="keywordtype">void</span>)
01043 {
01044     <span class="keywordtype">int</span>             numfds;
01045     fd_set          readfds, writefds, exceptfds;
01046     <span class="keyword">struct </span>timeval  timeout, *tvp = &amp;timeout;
01047     <span class="keywordtype">int</span>             count, block, i;
01048 <span class="preprocessor">#ifdef  USING_SMUX_MODULE</span>
01049     <span class="keywordtype">int</span>             sd;
01050 <span class="preprocessor">#endif                          </span><span class="comment">/* USING_SMUX_MODULE */</span>
01051 
01052     <span class="comment">/*</span>
01053 <span class="comment">     * ignore early sighup during startup</span>
01054 <span class="comment">     */</span>
01055     reconfig = 0;
01056 
01057     <span class="comment">/*</span>
01058 <span class="comment">     * Loop-forever: execute message handlers for sockets with data</span>
01059 <span class="comment">     */</span>
01060     <span class="keywordflow">while</span> (netsnmp_running) {
01061         <span class="keywordflow">if</span> (reconfig) {
01062             reconfig = 0;
01063             <a class="code" href="group__snmp__logging.html#ga41">snmp_log</a>(LOG_INFO, <span class=
"stringliteral">"Reconfiguring daemon\n"</span>);
01064             <span class="comment">/*  Stop and restart logging.  This allows logfiles to be</span>
01065 <span class="comment">                rotated etc.  */</span>
01066             <a class="code" href="group__snmp__logging.html#ga22">netsnmp_logging_restart</a>();
01067             <a class="code" href="group__snmp__logging.html#ga41">snmp_log</a>(LOG_INFO, <span class=
"stringliteral">"NET-SNMP version %s restarted\n"</span>,
01068                      netsnmp_get_version());
01069             update_config();
01070             <a class="code" href="group__agent__trap.html#ga43">send_easy_trap</a>(SNMP_TRAP_ENTERPRISESPECIFIC, 3);
01071         }
01072 
01073         <span class="keywordflow">for</span> (i = 0; i &lt; NUM_EXTERNAL_SIGS; i++) {
01074             <span class="keywordflow">if</span> (external_signal_scheduled[i]) {
01075                 external_signal_scheduled[i]--;
01076                 external_signal_handler[i](i);
01077             }
01078         }
01079 
01080         <span class="comment">/*</span>
01081 <span class="comment">         * default to sleeping for a really long time. INT_MAX</span>
01082 <span class="comment">         * should be sufficient (eg we don't care if time_t is</span>
01083 <span class="comment">         * a long that's bigger than an int).</span>
01084 <span class="comment">         */</span>
01085         tvp = &amp;timeout;
01086         tvp-&gt;tv_sec = INT_MAX;
01087         tvp-&gt;tv_usec = 0;
01088 
01089         numfds = 0;
01090         FD_ZERO(&amp;readfds);
01091         FD_ZERO(&amp;writefds);
01092         FD_ZERO(&amp;exceptfds);
01093         block = 0;
01094         snmp_select_info(&amp;numfds, &amp;readfds, tvp, &amp;block);
01095         <span class="keywordflow">if</span> (block == 1) {
01096             tvp = NULL;         <span class="comment">/* block without timeout */</span>
01097         }
01098 
01099 <span class="preprocessor">#ifdef  USING_SMUX_MODULE</span>
01100         <span class="keywordflow">if</span> (smux_listen_sd &gt;= 0) {
01101             FD_SET(smux_listen_sd, &amp;readfds);
01102             numfds =
01103                 smux_listen_sd &gt;= numfds ? smux_listen_sd + 1 : numfds;
01104             <span class="keywordflow">for</span> (i = 0; i &lt; sdlen; i++) {
01105                 FD_SET(sdlist[i], &amp;readfds);
01106                 numfds = sdlist[i] &gt;= numfds ? sdlist[i] + 1 : numfds;
01107             }
01108         }
01109 <span class="preprocessor">#endif                          </span><span class="comment">/* USING_SMUX_MODULE */</span>
01110 
01111         netsnmp_external_event_info(&amp;numfds, &amp;readfds, &amp;writefds, &amp;exceptfds);
01112 
01113     reselect:
01114         DEBUGMSGTL((<span class="stringliteral">"snmpd/select"</span>, <span class=
"stringliteral">"select( numfds=%d, ..., tvp=%p)\n"</span>,
01115                     numfds, tvp));
01116         <span class="keywordflow">if</span>(tvp)
01117             DEBUGMSGTL((<span class="stringliteral">"timer"</span>, <span class=
"stringliteral">"tvp %d.%d\n"</span>, tvp-&gt;tv_sec, tvp-&gt;tv_usec));
01118         count = select(numfds, &amp;readfds, &amp;writefds, &amp;exceptfds, tvp);
01119         DEBUGMSGTL((<span class="stringliteral">"snmpd/select"</span>, <span class=
"stringliteral">"returned, count = %d\n"</span>, count));
01120 
01121         <span class="keywordflow">if</span> (count &gt; 0) {
01122 
01123 <span class="preprocessor">#ifdef USING_SMUX_MODULE</span>
01124             <span class="comment">/*</span>
01125 <span class="comment">             * handle the SMUX sd's </span>
01126 <span class="comment">             */</span>
01127             <span class="keywordflow">if</span> (smux_listen_sd &gt;= 0) {
01128                 <span class="keywordflow">for</span> (i = 0; i &lt; sdlen; i++) {
01129                     <span class="keywordflow">if</span> (FD_ISSET(sdlist[i], &amp;readfds)) {
01130                         <span class="keywordflow">if</span> (smux_process(sdlist[i]) &lt; 0) {
01131                             <span class="keywordflow">for</span> (; i &lt; (sdlen - 1); i++) {
01132                                 sdlist[i] = sdlist[i + 1];
01133                             }
01134                             sdlen--;
01135                         }
01136                     }
01137                 }
01138                 <span class="comment">/*</span>
01139 <span class="comment">                 * new connection </span>
01140 <span class="comment">                 */</span>
01141                 <span class="keywordflow">if</span> (FD_ISSET(smux_listen_sd, &amp;readfds)) {
01142                     <span class="keywordflow">if</span> ((sd = smux_accept(smux_listen_sd)) &gt;= 0) {
01143                         sdlist[sdlen++] = sd;
01144                     }
01145                 }
01146             }
01147 <span class="preprocessor">#endif                          </span><span class="comment">/* USING_SMUX_MODULE */</span>
01148             netsnmp_dispatch_external_events(&amp;count, &amp;readfds,
01149                                            &amp;writefds, &amp;exceptfds);
01150             <span class="comment">/* If there are still events leftover, process them */</span>
01151             <span class="keywordflow">if</span> (count &gt; 0) {
01152               snmp_read(&amp;readfds);
01153             }
01154         } <span class="keywordflow">else</span>
01155             <span class="keywordflow">switch</span> (count) {
01156             <span class="keywordflow">case</span> 0:
01157                 snmp_timeout();
01158                 <span class="keywordflow">break</span>;
01159             <span class="keywordflow">case</span> -1:
01160                 DEBUGMSGTL((<span class="stringliteral">"snmpd/select"</span>, <span class=
"stringliteral">"  errno = %d\n"</span>, errno));
01161                 <span class="keywordflow">if</span> (errno == EINTR) {
01162                     <span class="comment">/*</span>
01163 <span class="comment">                     * likely that we got a signal. Check our special signal</span>
01164 <span class="comment">                     * flags before retrying select.</span>
01165 <span class="comment">                     */</span>
01166                     <span class="keywordflow">if</span> (netsnmp_running &amp;&amp; !reconfig) {
01167                         <span class="keywordflow">goto</span> reselect;
01168                     }
01169                     <span class="keywordflow">continue</span>;
01170                 } <span class="keywordflow">else</span> {
01171                     snmp_log_perror(<span class="stringliteral">"select"</span>);
01172                 }
01173                 <span class="keywordflow">return</span> -1;
01174             <span class="keywordflow">default</span>:
01175                 <a class="code" href="group__snmp__logging.html#ga41">snmp_log</a>(LOG_ERR, <span class=
"stringliteral">"select returned %d\n"</span>, count);
01176                 <span class="keywordflow">return</span> -1;
01177             }                   <span class="comment">/* endif -- count&gt;0 */</span>
01178 
01179         <span class="comment">/*</span>
01180 <span class="comment">         * run requested alarms </span>
01181 <span class="comment">         */</span>
01182         run_alarms();
01183 
01184         netsnmp_check_outstanding_agent_requests();
01185 
01186     }                           <span class="comment">/* endwhile */</span>
01187 
01188     <a class="code" href="group__snmp__logging.html#ga41">snmp_log</a>(LOG_INFO, <span class=
"stringliteral">"Received TERM or STOP signal...  shutting down...\n"</span>);
01189     <span class="keywordflow">return</span> 0;
01190 
01191 }                               <span class="comment">/* end receive() */</span>
01192 
01193 
01194 
01195 <span class="comment">/*******************************************************************-o-******</span>
01196 <span class="comment"> * snmp_input</span>
01197 <span class="comment"> *</span>
01198 <span class="comment"> * Parameters:</span>
01199 <span class="comment"> *       op</span>
01200 <span class="comment"> *      *session</span>
01201 <span class="comment"> *       requid</span>
01202 <span class="comment"> *      *pdu</span>
01203 <span class="comment"> *      *magic</span>
01204 <span class="comment"> *      </span>
01205 <span class="comment"> * Returns:</span>
01206 <span class="comment"> *      1               On success      -OR-</span>
01207 <span class="comment"> *      Passes through  Return from alarmGetResponse() when </span>
01208 <span class="comment"> *                        USING_V2PARTY_ALARM_MODULE is defined.</span>
01209 <span class="comment"> *</span>
01210 <span class="comment"> * Call-back function to manage responses to traps (informs) and alarms.</span>
01211 <span class="comment"> * Not used by the agent to process other Response PDUs.</span>
01212 <span class="comment"> */</span>
01213 <span class="keywordtype">int</span>
01214 snmp_input(<span class="keywordtype">int</span> op,
01215            <a class="code" href="structsnmp__session.html">netsnmp_session</a> * session,
01216            <span class="keywordtype">int</span> reqid, <a class="code" href=
"structsnmp__pdu.html">netsnmp_pdu</a> *pdu, <span class="keywordtype">void</span> *magic)
01217 {
01218     <span class="keyword">struct </span>get_req_state *state = (<span class="keyword">struct </span>get_req_state *) magic;
01219 
01220     <span class="keywordflow">if</span> (op == NETSNMP_CALLBACK_OP_RECEIVED_MESSAGE) {
01221         <span class="keywordflow">if</span> (pdu-&gt;<a class="code" href=
"structsnmp__pdu.html#o1">command</a> == SNMP_MSG_GET) {
01222             <span class="keywordflow">if</span> (state-&gt;type == EVENT_GET_REQ) {
01223                 <span class="comment">/*</span>
01224 <span class="comment">                 * this is just the ack to our inform pdu </span>
01225 <span class="comment">                 */</span>
01226                 <span class="keywordflow">return</span> 1;
01227             }
01228         }
01229     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (op == NETSNMP_CALLBACK_OP_TIMED_OUT) {
01230         <span class="keywordflow">if</span> (state-&gt;type == ALARM_GET_REQ) {
01231             <span class="comment">/*</span>
01232 <span class="comment">             * Need a mechanism to replace obsolete SNMPv2p alarm </span>
01233 <span class="comment">             */</span>
01234         }
01235     }
01236     <span class="keywordflow">return</span> 1;
01237 
01238 }                               <span class="comment">/* end snmp_input() */</span>
01239 
01240 
01241 
01242 <span class="comment">/*</span>
01243 <span class="comment"> * Windows Service Related functions </span>
01244 <span class="comment"> */</span>
01245 <span class="preprocessor">#ifdef WIN32SERVICE</span>
01246 <span class="comment">/************************************************************</span>
01247 <span class="comment">* main function for Windows</span>
01248 <span class="comment">* Parse command line arguments for startup options,</span>
01249 <span class="comment">* to start as service or console mode application in windows.</span>
01250 <span class="comment">* Invokes appropriate startup functions depending on the </span>
01251 <span class="comment">* parameters passed</span>
01252 <span class="comment">*************************************************************/</span>
01253 <span class="keywordtype">int</span>
01254     __cdecl
01255 _tmain(<span class="keywordtype">int</span> argc, TCHAR * argv[])
01256 {
01257     <span class="comment">/*</span>
01258 <span class="comment">     * Define Service Name and Description, which appears in windows SCM </span>
01259 <span class="comment">     */</span>
01260     LPCTSTR         lpszServiceName = app_name_long;      <span class="comment">/* Service Registry Name */</span>
01261     LPCTSTR         lpszServiceDisplayName = _T(<span class="stringliteral">"Net-SNMP Agent"</span>);       <span class=
"comment">/* Display Name */</span>
01262     LPCTSTR         lpszServiceDescription =
01263 <span class="preprocessor">#ifdef IFDESCR</span>
01264         _T(<span class=
"stringliteral">"SNMPv2c / SNMPv3 command responder from Net-SNMP. Supports MIB objects for IP,ICMP,TCP,UDP, and network interface sub-layers."</span>);
01265 <span class="preprocessor">#else</span>
01266         _T(<span class="stringliteral">"SNMPv2c / SNMPv3 command responder from Net-SNMP"</span>);
01267 <span class="preprocessor">#endif</span>
01268     InputParams     InputOptions;
01269 
01270 
01271     <span class="keywordtype">int</span>             nRunType = RUN_AS_CONSOLE;
01272     <span class="keywordtype">int</span>             quiet = 0;
01273     
01274     nRunType = ParseCmdLineForServiceOption(argc, argv, &amp;quiet);
01275 
01276     <span class="keywordflow">switch</span> (nRunType) {
01277     <span class="keywordflow">case</span> REGISTER_SERVICE:
01278         <span class="comment">/*</span>
01279 <span class="comment">         * Register As service </span>
01280 <span class="comment">         */</span>
01281         InputOptions.Argc = argc;
01282         InputOptions.Argv = argv;
01283         exit (RegisterService(lpszServiceName,
01284                         lpszServiceDisplayName,
01285                         lpszServiceDescription, &amp;InputOptions, quiet));
01286         <span class="keywordflow">break</span>;
01287     <span class="keywordflow">case</span> UN_REGISTER_SERVICE:
01288         <span class="comment">/*</span>
01289 <span class="comment">         * Unregister service </span>
01290 <span class="comment">         */</span>
01291         exit (UnregisterService(lpszServiceName, quiet));
01292         <span class="keywordflow">break</span>;
01293     <span class="keywordflow">case</span> RUN_AS_SERVICE:
01294         <span class="comment">/*</span>
01295 <span class="comment">         * Run as service </span>
01296 <span class="comment">         */</span>
01297         <span class="comment">/*</span>
01298 <span class="comment">         * Register Stop Function </span>
01299 <span class="comment">         */</span>
01300         RegisterStopFunction(StopSnmpAgent);
01301         <span class="keywordflow">return</span> RunAsService(SnmpDaemonMain);
01302         <span class="keywordflow">break</span>;
01303     <span class="keywordflow">default</span>:
01304         <span class="comment">/*</span>
01305 <span class="comment">         * Run in console mode </span>
01306 <span class="comment">         */</span>
01307         <span class="keywordflow">return</span> SnmpDaemonMain(argc, argv);
01308         <span class="keywordflow">break</span>;
01309     }
01310 }
01311 
01312 <span class="comment">/*</span>
01313 <span class="comment"> * To stop Snmp Agent daemon</span>
01314 <span class="comment"> * This portion is still not working</span>
01315 <span class="comment"> */</span>
01316 <span class="keywordtype">void</span>
01317 StopSnmpAgent(<span class="keywordtype">void</span>)
01318 {
01319     <span class="comment">/*</span>
01320 <span class="comment">     * Shut Down Agent </span>
01321 <span class="comment">     */</span>
01322     SnmpdShutDown(1);
01323 
01324     <span class="comment">/*</span>
01325 <span class="comment">     * Wait till agent is completely stopped </span>
01326 <span class="comment">     */</span>
01327 
01328     <span class="keywordflow">while</span> (agent_status != AGENT_STOPPED) {
01329         Sleep(100);
01330     }
01331 }
01332 
01333 <span class="preprocessor">#endif </span><span class="comment">/*WIN32SERVICE*/</span>
</pre>
  </div>
  <hr size="1" />

  <address style="align: right;">
    <small>Generated on Fri Dec 30 13:47:49 2005 for net-snmp by&nbsp; <a href="http://www.doxygen.org/index.html"><img src=
    "doxygen.png" alt="doxygen" align="middle" border="0" /></a> 1.3.9.1</small>
  </address>
<!-- CONTENT END -->
<!--#include virtual="/page-bottom.html" -->

