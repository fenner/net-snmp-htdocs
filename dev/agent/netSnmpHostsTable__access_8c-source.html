<!--#set var="section" value="development" -->
<!--#include virtual="/page-top.html" -->
<!-- CONTENT START -->
  <!-- Generated by Doxygen 1.3.9.1 -->

  <div class="qindex">
    <a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="modules.html">Modules</a> | <a class=
    "qindex" href="annotated.html">Data&nbsp;Structures</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class=
    "qindex" href="functions.html">Data&nbsp;Fields</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a> | <a class=
    "qindex" href="examples.html">Examples</a>
  </div>

  <div class="nav">
    <a class="el" href="dir_000003.html">agent</a>&nbsp;/&nbsp;<a class="el" href=
    "dir_000007.html">mibgroup</a>&nbsp;/&nbsp;<a class="el" href="dir_000008.html">examples</a>
  </div>

  <h1>netSnmpHostsTable_access.c</h1>

  <div class="fragment">
    <pre class="fragment">
00001 
00002 <span class="comment">/*</span>
00003 <span class="comment"> * Note: this file originally auto-generated by mib2c using</span>
00004 <span class="comment"> *        : mib2c.access_functions.conf,v 1.3 2003/05/31 00:11:57 hardaker Exp $</span>
00005 <span class="comment"> */</span>
00006 
00007 <span class="preprocessor">#include &lt;net-snmp/net-snmp-config.h&gt;</span>
00008 <span class="preprocessor">#include &lt;net-snmp/net-snmp-includes.h&gt;</span>
00009 <span class="preprocessor">#include &lt;net-snmp/agent/net-snmp-agent-includes.h&gt;</span>
00010 <span class="preprocessor">#include "netSnmpHostsTable_access.h"</span>
00011 <span class="preprocessor">#include "netSnmpHostsTable_enums.h"</span>
00012 <span class="preprocessor">#include &lt;netinet/in.h&gt;</span>
00013 <span class="preprocessor">#include &lt;arpa/inet.h&gt;</span>
00014 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
00015 <span class="preprocessor">#include &lt;unistd.h&gt;</span>
00016 
00017 <span class="preprocessor">#define MAX_HOSTS_LINE 4096</span>
00018 
00019 <span class="comment">/* XXX: make .conf token */</span>
00020 <span class="preprocessor">#define HOSTS_FILE "/etc/hosts"</span>
00021 
00022 <span class="keyword">typedef</span> <span class="keyword">struct </span>my_loop_info_s {
00023    FILE *filep;
00024    in_addr_t theaddr;
00025    <span class="keywordtype">char</span> line[MAX_HOSTS_LINE];
00026    <span class="keywordtype">char</span> hostname[64];
00027    <span class="keywordtype">int</span> lineno;
00028    <span class="keywordtype">char</span> *current_ptr;
00029 } my_loop_info;
00030 
00031 <span class="keyword">typedef</span> <span class="keyword">struct </span>my_data_info_s {
00032    in_addr_t theaddr;
00033    in_addr_t theoldaddr;
00034    <span class="keywordtype">char</span> hostname[64];
00035    <span class="keywordtype">int</span> lineno;
00036 } my_data_info;   
00037 
00064 <a class="code" href="structvariable__list.html">netsnmp_variable_list</a> *
00065 netSnmpHostsTable_get_first_data_point(<span class="keywordtype">void</span> **my_loop_context,
00066                                        <span class="keywordtype">void</span> **my_data_context,
00067                                        <a class="code" href="structvariable__list.html">netsnmp_variable_list</a> *
00068                                        put_index_data,
00069                                        <a class="code" href=
"structnetsnmp__iterator__info__s.html">netsnmp_iterator_info</a> *mydata)
00070 {
00071     my_loop_info *loopctx;
00072 
00073     loopctx = <a class="code" href="group__util.html#ga39">SNMP_MALLOC_TYPEDEF</a>(my_loop_info);
00074 
00075     <span class="keywordflow">if</span> (!loopctx)
00076         <span class="keywordflow">return</span> NULL; <span class="comment">/*XXX log err */</span>
00077 
00078     loopctx-&gt;filep = fopen(<span class="stringliteral">"/etc/hosts"</span>,<span class="stringliteral">"r"</span>);
00079 
00080     <span class="keywordflow">if</span> (!loopctx-&gt;filep) {
00081         free(loopctx);
00082         <span class="keywordflow">return</span> NULL;
00083     }
00084 
00085     <span class="comment">/* at this point, we need to get the first name and address from</span>
00086 <span class="comment">       the file.  But since our get_next_data_point function does</span>
00087 <span class="comment">       this, we'll use it instead of duplicating code */</span>
00088     *my_loop_context = loopctx;
00089 
00090     <span class="keywordflow">return</span> netSnmpHostsTable_get_next_data_point(my_loop_context,
00091                                                  my_data_context,
00092                                                  put_index_data,
00093                                                  mydata);
00094 }
00095 
00103 <a class="code" href="structvariable__list.html">netsnmp_variable_list</a> *
00104 netSnmpHostsTable_get_next_data_point(<span class="keywordtype">void</span> **my_loop_context,
00105                                       <span class="keywordtype">void</span> **my_data_context,
00106                                       <a class="code" href="structvariable__list.html">netsnmp_variable_list</a> *
00107                                       put_index_data,
00108                                       <a class="code" href=
"structnetsnmp__iterator__info__s.html">netsnmp_iterator_info</a> *mydata)
00109 {
00110     my_loop_info *loopctx = *my_loop_context;
00111     <span class="keywordtype">char</span> tmpstring[64];
00112 
00113     <span class="keywordflow">if</span> (!loopctx)
00114         <span class="keywordflow">return</span> NULL;
00115 
00116     <span class="keywordflow">while</span>(loopctx-&gt;filep) {
00117         <span class="keywordflow">if</span> (!loopctx-&gt;current_ptr) {
00118             <span class="keywordflow">if</span> (!fgets(loopctx-&gt;line, <span class=
"keyword">sizeof</span>(loopctx-&gt;line), loopctx-&gt;filep)) {
00119                 <span class="comment">/* we're done */</span>
00120                 fclose(loopctx-&gt;filep);
00121                 loopctx-&gt;filep = NULL;
00122                 <span class="keywordflow">return</span> NULL;
00123             }
00124             loopctx-&gt;lineno++;
00125             loopctx-&gt;current_ptr = loopctx-&gt;line;
00126             loopctx-&gt;current_ptr = skip_white(loopctx-&gt;current_ptr);
00127 
00128             <span class=
"keywordflow">if</span> (loopctx-&gt;current_ptr == NULL || *loopctx-&gt;current_ptr == <span class="charliteral">'#'</span>) {
00129                 loopctx-&gt;current_ptr = NULL;
00130                 <span class="keywordflow">continue</span>;
00131             }
00132 
00133             loopctx-&gt;current_ptr =
00134                 copy_nword(loopctx-&gt;current_ptr, tmpstring, <span class="keyword">sizeof</span>(tmpstring));
00135             loopctx-&gt;theaddr = inet_addr(tmpstring);
00136 
00137             <span class="keywordflow">if</span> (!loopctx-&gt;current_ptr)
00138                 <span class="keywordflow">continue</span>;
00139         }
00140 
00141         loopctx-&gt;current_ptr =
00142             copy_nword(loopctx-&gt;current_ptr, loopctx-&gt;hostname, <span class=
"keyword">sizeof</span>(loopctx-&gt;hostname));
00143         
00144         <a class="code" href=
"group__snmp__client.html#ga25">snmp_set_var_value</a>(put_index_data, (u_char *) loopctx-&gt;hostname,
00145                            strlen(loopctx-&gt;hostname));
00146         <span class="keywordflow">return</span> put_index_data;
00147     }
00148     
00149     <span class="comment">/* we're out of data */</span>
00150     *my_loop_context = NULL;
00151     <span class="keywordflow">return</span> NULL;
00152 }
00153 
00154 <span class="keywordtype">void</span> *
00155 netSnmpHostsTable_context_convert_function(<span class="keywordtype">void</span> *loop_context,
00156                                            <a class="code" href=
"structnetsnmp__iterator__info__s.html">netsnmp_iterator_info</a> *iinfo)
00157 {
00158     my_loop_info *loopctx = loop_context;
00159     my_data_info *datactx = <a class="code" href="group__util.html#ga39">SNMP_MALLOC_TYPEDEF</a>(my_data_info);
00160     <span class="keywordflow">if</span> (!datactx)
00161         <span class="keywordflow">return</span> NULL;
00162     datactx-&gt;theoldaddr = datactx-&gt;theaddr = loopctx-&gt;theaddr;
00163     datactx-&gt;lineno = loopctx-&gt;lineno;
00164     strcpy(datactx-&gt;hostname, loopctx-&gt;hostname);
00165     <span class="keywordflow">return</span> datactx;
00166 }
00167 
00176 <span class="keywordtype">void</span>           *
00177 netSnmpHostsTable_create_data_context(<a class="code" href=
"structvariable__list.html">netsnmp_variable_list</a> * index_data)
00178 {
00179     my_data_info *datactx = <a class="code" href="group__util.html#ga39">SNMP_MALLOC_TYPEDEF</a>(my_data_info);
00180     <span class="keywordflow">if</span> (!datactx)
00181         <span class="keywordflow">return</span> NULL;
00182     strncpy(datactx-&gt;hostname, index_data-&gt;<a class="code" href="structvariable__list.html#o4">val</a>.string,
00183             strlen(index_data-&gt;<a class="code" href="structvariable__list.html#o4">val</a>.string));
00184     <span class="keywordflow">return</span> datactx;
00185 }
00186 
00187 <span class="keywordtype">void</span>
00188 netSnmpHostsTable_data_free(<span class="keywordtype">void</span> *data, <a class="code" href=
"structnetsnmp__iterator__info__s.html">netsnmp_iterator_info</a> *iinfo)
00189 {
00190     free(data);
00191 }
00192 
00193 <span class="keywordtype">void</span>
00194 netSnmpHostsTable_loop_free(<span class="keywordtype">void</span> *loopctx, <a class="code" href=
"structnetsnmp__iterator__info__s.html">netsnmp_iterator_info</a> *iinfo)
00195 {
00196     free(loopctx);
00197 }
00198 
00210 <span class="keywordtype">int</span>
00211 netSnmpHostsTable_commit_row(<span class="keywordtype">void</span> **my_data_context, <span class=
"keywordtype">int</span> new_or_del)
00212 {
00214     FILE *in, *out;
00215     <span class="keywordtype">char</span> line[MAX_HOSTS_LINE], line2[MAX_HOSTS_LINE];
00216     <span class="keywordtype">char</span> myaddr[64], *cp;
00217     my_data_info *datactx = *my_data_context;
00218     size_t line2_sz;
00219     <span class="keywordtype">int</span> foundit = 0;
00220 
00221     <span class="keywordflow">if</span> (datactx-&gt;theaddr == datactx-&gt;theoldaddr &amp;&amp; new_or_del != -1)
00222         <span class="keywordflow">return</span> SNMP_ERR_NOERROR; <span class="comment">/* no change in the value */</span>
00223 
00224     <span class="keywordflow">if</span> ((out = fopen(HOSTS_FILE <span class="stringliteral">".snmp"</span>, <span class=
"stringliteral">"w"</span>)) == NULL)
00225         <span class="keywordflow">return</span> SNMP_ERR_COMMITFAILED;
00226     
00227     <span class="keywordflow">if</span> ((in = fopen(HOSTS_FILE, <span class="stringliteral">"r"</span>)) == NULL)
00228         <span class="keywordflow">return</span> SNMP_ERR_COMMITFAILED;
00229 
00230     <span class="keywordflow">while</span>(fgets(line, <span class="keyword">sizeof</span>(line), in)) {
00231         copy_nword(line,myaddr,<span class="keyword">sizeof</span>(myaddr));
00232         <span class="keywordflow">if</span> (inet_addr(myaddr) == datactx-&gt;theaddr &amp;&amp; new_or_del != -1) {
00233             foundit = 1;
00234             <span class="comment">/* right line to append to */</span>
00235             line[strlen(line)-1] = <span class="charliteral">'\0'</span>; <span class=
"comment">/* nuke the new line */</span>
00236             fprintf(out, <span class="stringliteral">"%s %s\n"</span>, line, datactx-&gt;hostname);
00237         } <span class="keywordflow">else</span> <span class=
"keywordflow">if</span> (inet_addr(myaddr) == datactx-&gt;theoldaddr) {
00238             <span class="comment">/* find and remove the name from the current line */</span>
00239             <span class="keywordtype">int</span> count = 0;
00240             cp = copy_nword(line, line2, <span class="keyword">sizeof</span>(line2)); <span class=
"comment">/* pass the addr */</span>
00241             <span class="keywordflow">if</span> (strlen(line2) &gt; <span class="keyword">sizeof</span>(line2)-2) {
00242               errorit:
00243                 fclose(in);
00244                 fclose(out);
00245                 unlink(HOSTS_FILE <span class="stringliteral">".snmp"</span>);
00246                 <span class="keywordflow">return</span> SNMP_ERR_RESOURCEUNAVAILABLE;
00247             }
00248             line2_sz = strlen(line2);
00249             line2[line2_sz++] = <span class="charliteral">'\t'</span>;
00250             <span class="keywordflow">while</span>(cp) {
00251                 cp = copy_nword(cp, &amp;line2[line2_sz], <span class="keyword">sizeof</span>(line2)-line2_sz);
00252                 <span class="keywordflow">if</span> (strcmp(&amp;line2[line2_sz], datactx-&gt;hostname) == 0) {
00253                     <span class="comment">/* a match, so don't add it to line2 (which means</span>
00254 <span class="comment">                       don't update the write line2_sz index */</span>
00255                 } <span class="keywordflow">else</span> {
00256                     <span class="keywordflow">if</span> (strlen(line2) &gt; <span class="keyword">sizeof</span>(line2)-2) {
00257                         <span class="keywordflow">goto</span> errorit;
00258                     }
00259                     line2_sz = strlen(line2);
00260                     line2[line2_sz++] = <span class="charliteral">' '</span>;
00261                     count++;
00262                 }
00263             }
00264             <span class="keywordflow">if</span> (count) {
00265                 <span class="comment">/* at least one name was still present on the line, so</span>
00266 <span class="comment">                   save it to the new file */</span>
00267                 line2[line2_sz] = <span class="charliteral">'\0'</span>;
00268                 fprintf(out, <span class="stringliteral">"%s\n"</span>, line2);
00269             }
00270         } <span class="keywordflow">else</span> {
00271             fputs(line, out);
00272         }
00273     }
00274 
00275     <span class="keywordflow">if</span> (!foundit &amp;&amp; new_or_del != -1) {
00276         <span class="comment">/* couldn't add it to an existing line, so append a new one */</span>
00277         fprintf(out, <span class="stringliteral">"%d.%d.%d.%d\t%s\n"</span>,
00278                 (0x000000ff &amp; datactx-&gt;theaddr),
00279                 (0x0000ff00 &amp; datactx-&gt;theaddr) &gt;&gt; 8,
00280                 (0x00ff0000 &amp; datactx-&gt;theaddr) &gt;&gt; 16,
00281                 (0xff000000 &amp; datactx-&gt;theaddr) &gt;&gt; 24,
00282                 datactx-&gt;hostname);
00283     }
00284     fclose(out); <span class="comment">/* close out first to minimize race condition */</span>
00285     fclose(in);
00286     <span class="comment">/*</span>
00287 <span class="comment">     * race condition here - someone else could open the file after</span>
00288 <span class="comment">     *  we close it but before we can rename it.</span>
00289 <span class="comment">     */</span>
00290     <span class="keywordflow">if</span> (!rename(HOSTS_FILE <span class="stringliteral">".snmp"</span>, HOSTS_FILE))
00291         <span class="keywordflow">return</span> SNMP_ERR_COMMITFAILED;
00292         
00293     <span class="comment">/*</span>
00294 <span class="comment">     * return no errors.  And there shouldn't be any!!!  Ever!!!  You</span>
00295 <span class="comment">     * should have checked the values long before this. </span>
00296 <span class="comment">     */</span>
00297     <span class="keywordflow">return</span> SNMP_ERR_NOERROR;
00298 }
00299 
00300 
00301 <span class="comment">/*</span>
00302 <span class="comment"> * User-defined data access functions (per column) for data in table</span>
00303 <span class="comment"> * netSnmpHostsTable</span>
00304 <span class="comment"> */</span>
00305 
00306 
00307 <span class="keywordtype">long</span>           *
00308 get_netSnmpHostAddressType(<span class="keywordtype">void</span> *data_context, size_t * ret_len)
00309 {
00310     <span class="keyword">static</span> <span class="keywordtype">long</span> ret = NETSNMPHOSTADDRESSTYPE_IPV4;
00311     *ret_len = <span class="keyword">sizeof</span>(ret);
00312     <span class="keywordflow">return</span> &amp;ret;
00313 }
00314 
00315 <span class="keywordtype">int</span>
00316 set_netSnmpHostAddressType(<span class="keywordtype">void</span> *data_context, <span class=
"keywordtype">long</span> *val, size_t val_len)
00317 {
00318     <span class="keywordflow">return</span> SNMP_ERR_NOERROR; <span class="comment">/* always ipv4 */</span>
00319 }
00320 
00321 <span class="keywordtype">char</span>           *
00322 get_netSnmpHostAddress(<span class="keywordtype">void</span> *data_context, size_t * ret_len)
00323 {
00324     my_data_info *datainfo = data_context;
00325     *ret_len = <span class="keyword">sizeof</span>(in_addr_t);  <span class="comment">/* XXX: make sure it's 4 */</span>
00326     <span class="keywordflow">return</span> (<span class="keywordtype">char</span> *) &amp;datainfo-&gt;theaddr;
00327 }
00328 
00329 <span class="keywordtype">int</span>
00330 set_netSnmpHostAddress(<span class="keywordtype">void</span> *data_context, <span class=
"keywordtype">char</span> *val, size_t val_len)
00331 {
00332     my_data_info *datainfo = data_context;
00333     memcpy(&amp;datainfo-&gt;theaddr, val, val_len);
00334     <span class="keywordflow">return</span> SNMP_ERR_NOERROR;
00335 }
00336 
00337 <span class="keywordtype">long</span>           *
00338 get_netSnmpHostStorage(<span class="keywordtype">void</span> *data_context, size_t * ret_len)
00339 {
00340     <span class="keyword">static</span> <span class="keywordtype">long</span> ret = ST_NONVOLATILE;
00341     *ret_len = <span class="keyword">sizeof</span>(ret);
00342     <span class="keywordflow">return</span> &amp;ret;
00343 }
00344 
00345 <span class="keywordtype">int</span>
00346 set_netSnmpHostStorage(<span class="keywordtype">void</span> *data_context, <span class=
"keywordtype">long</span> *val, size_t val_len)
00347 {
00348     <span class="keywordflow">return</span> SNMP_ERR_NOERROR;
00349 }
00350 
00351 <span class="keywordtype">long</span>           *
00352 get_netSnmpHostRowStatus(<span class="keywordtype">void</span> *data_context, size_t * ret_len)
00353 {
00354     <span class="keyword">static</span> <span class="keywordtype">long</span> ret = RS_ACTIVE;
00355     *ret_len = <span class="keyword">sizeof</span>(ret);
00356     <span class="keywordflow">return</span> &amp;ret;
00357 }
00358 
00359 <span class="keywordtype">int</span>
00360 set_netSnmpHostRowStatus(<span class="keywordtype">void</span> *data_context, <span class=
"keywordtype">long</span> *val, size_t val_len)
00361 {
00362     <span class="comment">/* XXX */</span>
00363     <span class="keywordflow">return</span> SNMP_ERR_NOERROR;
00364 }
</pre>
  </div>
  <hr size="1" />

  <address style="align: right;">
    <small>Generated on Fri Dec 30 13:47:45 2005 for net-snmp by&nbsp; <a href="http://www.doxygen.org/index.html"><img src=
    "doxygen.png" alt="doxygen" align="middle" border="0" /></a> 1.3.9.1</small>
  </address>
<!-- CONTENT END -->
<!--#include virtual="/page-bottom.html" -->

