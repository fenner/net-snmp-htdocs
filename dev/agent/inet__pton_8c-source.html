<!--#set var="section" value="development" -->
<!--#include virtual="/page-top.html" -->
<!-- CONTENT START -->
  <!-- Generated by Doxygen 1.3.9.1 -->

  <div class="qindex">
    <a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="modules.html">Modules</a> | <a class=
    "qindex" href="annotated.html">Data&nbsp;Structures</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class=
    "qindex" href="functions.html">Data&nbsp;Fields</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a> | <a class=
    "qindex" href="examples.html">Examples</a>
  </div>

  <div class="nav">
    <a class="el" href="dir_000005.html">snmplib</a>
  </div>

  <h1>inet_pton.c</h1>

  <div class="fragment">
    <pre class="fragment">
00001 <span class="comment">/*      Id: inet_pton.c,v 1.5 2001/04/13 15:24:35 lukem Exp     */</span>
00002 <span class="comment">/*      $NetBSD: inet_pton.c,v 1.16 2000/02/07 18:51:02 itojun Exp $    */</span>
00003 
00004 <span class="comment">/* Copyright (c) 1996 by Internet Software Consortium.</span>
00005 <span class="comment"> *</span>
00006 <span class="comment"> * Permission to use, copy, modify, and distribute this software for any</span>
00007 <span class="comment"> * purpose with or without fee is hereby granted, provided that the above</span>
00008 <span class="comment"> * copyright notice and this permission notice appear in all copies.</span>
00009 <span class="comment"> *</span>
00010 <span class="comment"> * THE SOFTWARE IS PROVIDED "AS IS" AND INTERNET SOFTWARE CONSORTIUM DISCLAIMS</span>
00011 <span class="comment"> * ALL WARRANTIES WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES</span>
00012 <span class="comment"> * OF MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL INTERNET SOFTWARE</span>
00013 <span class="comment"> * CONSORTIUM BE LIABLE FOR ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL</span>
00014 <span class="comment"> * DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR</span>
00015 <span class="comment"> * PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS</span>
00016 <span class="comment"> * ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS</span>
00017 <span class="comment"> * SOFTWARE.</span>
00018 <span class="comment"> */</span>
00019 
00020 <span class="preprocessor">#include &lt;net-snmp/net-snmp-config.h&gt;</span>
00021 
00022 <span class="preprocessor">#ifndef HAVE_INET_PTON</span>
00023 
00024 <span class="preprocessor">#if HAVE_ARPA_NAMESER_H</span>
00025 <span class="preprocessor">#include &lt;arpa/nameser.h&gt;</span>
00026 <span class="preprocessor">#endif</span>
00027 
00028   <span class="comment">/*</span>
00029 <span class="comment">   * Net-SNMP Win32 additions</span>
00030 <span class="comment">   */</span>
00031 <span class="preprocessor">#if defined(HAVE_WINSOCK_H) || defined(cygwin)</span>
00032 <span class="preprocessor">#include &lt;winsock2.h&gt;</span>
00033 <span class="preprocessor">#include &lt;ws2tcpip.h&gt;</span>
00034 <span class="preprocessor">#include &lt;errno.h&gt;</span>
00035 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
00036 <span class="preprocessor">#endif</span>
00037 
00038 <span class="preprocessor">#ifndef EAFNOSUPPORT</span>
00039 <span class="preprocessor">#define EAFNOSUPPORT            WSAEAFNOSUPPORT</span>
00040 <span class="preprocessor">#endif</span>
00041 
00042 <span class="preprocessor">#ifndef IN6ADDRSZ</span>
00043 <span class="preprocessor">#define IN6ADDRSZ       16</span>
00044 <span class="preprocessor">#endif</span>
00045 
00046 <span class="preprocessor">#ifndef INT16SZ</span>
00047 <span class="preprocessor">#define INT16SZ         2</span>
00048 <span class="preprocessor">#endif</span>
00049   <span class="comment">/*</span>
00050 <span class="comment">   * End of Net-SNMP Win32 additions</span>
00051 <span class="comment">   */</span>
00052 
00053 <span class="preprocessor">#ifndef INADDRSZ</span>
00054 <span class="preprocessor">#define INADDRSZ        4</span>
00055 <span class="preprocessor">#endif</span>
00056 
00057 <span class="comment">/*</span>
00058 <span class="comment"> * WARNING: Don't even consider trying to compile this on a system where</span>
00059 <span class="comment"> * sizeof(int) &lt; 4.  sizeof(int) &gt; 4 is fine; all the world's not a VAX.</span>
00060 <span class="comment"> */</span>
00061 
00062 <span class="keyword">static</span> <span class="keywordtype">int</span>      inet_pton4(<span class=
"keyword">const</span> <span class="keywordtype">char</span> *src, u_char *dst, <span class="keywordtype">int</span> pton);
00063 <span class="preprocessor">#ifdef INET6</span>
00064 <span class="keyword">static</span> <span class="keywordtype">int</span>      inet_pton6(<span class=
"keyword">const</span> <span class="keywordtype">char</span> *src, u_char *dst);
00065 <span class="preprocessor">#endif</span>
00066 
00067 <span class="comment">/* int</span>
00068 <span class="comment"> * inet_pton(af, src, dst)</span>
00069 <span class="comment"> *      convert from presentation format (which usually means ASCII printable)</span>
00070 <span class="comment"> *      to network format (which is usually some kind of binary format).</span>
00071 <span class="comment"> * return:</span>
00072 <span class="comment"> *      1 if the address was valid for the specified address family</span>
00073 <span class="comment"> *      0 if the address wasn't valid (`dst' is untouched in this case)</span>
00074 <span class="comment"> *      -1 if some other error occurred (`dst' is untouched in this case, too)</span>
00075 <span class="comment"> * author:</span>
00076 <span class="comment"> *      Paul Vixie, 1996.</span>
00077 <span class="comment"> */</span>
00078 <span class="keywordtype">int</span>
00079 inet_pton(af, src, dst)
00080         int af;
00081         const <span class="keywordtype">char</span> *src;
00082         <span class="keywordtype">void</span> *dst;
00083 {
00084 
00085         <span class="keywordflow">switch</span> (af) {
00086         <span class="keywordflow">case</span> AF_INET:
00087                 <span class="keywordflow">return</span> (inet_pton4(src, dst, 1));
00088 <span class="preprocessor">#ifdef INET6</span>
00089         <span class="keywordflow">case</span> AF_INET6:
00090                 <span class="keywordflow">return</span> (inet_pton6(src, dst));
00091 <span class="preprocessor">#endif</span>
00092         <span class="keywordflow">default</span>:
00093                 errno = EAFNOSUPPORT;
00094                 <span class="keywordflow">return</span> (-1);
00095         }
00096         <span class="comment">/* NOTREACHED */</span>
00097 }
00098 
00099 <span class="comment">/* int</span>
00100 <span class="comment"> * inet_pton4(src, dst, pton)</span>
00101 <span class="comment"> *      when last arg is 0: inet_aton(). with hexadecimal, octal and shorthand.</span>
00102 <span class="comment"> *      when last arg is 1: inet_pton(). decimal dotted-quad only.</span>
00103 <span class="comment"> * return:</span>
00104 <span class="comment"> *      1 if `src' is a valid input, else 0.</span>
00105 <span class="comment"> * notice:</span>
00106 <span class="comment"> *      does not touch `dst' unless it's returning 1.</span>
00107 <span class="comment"> * author:</span>
00108 <span class="comment"> *      Paul Vixie, 1996.</span>
00109 <span class="comment"> */</span>
00110 <span class="keyword">static</span> <span class="keywordtype">int</span>
00111 inet_pton4(src, dst, pton)
00112         const <span class="keywordtype">char</span> *src;
00113         u_char *dst;
00114         <span class="keywordtype">int</span> pton;
00115 {
00116         u_int val;
00117         u_int digit;
00118         <span class="keywordtype">int</span> base, n;
00119         <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> c;
00120         u_int parts[4];
00121         <span class="keyword">register</span> u_int *pp = parts;
00122 
00123         c = *src;
00124         <span class="keywordflow">for</span> (;;) {
00125                 <span class="comment">/*</span>
00126 <span class="comment">                 * Collect number up to ``.''.</span>
00127 <span class="comment">                 * Values are specified as for C:</span>
00128 <span class="comment">                 * 0x=hex, 0=octal, isdigit=decimal.</span>
00129 <span class="comment">                 */</span>
00130                 <span class="keywordflow">if</span> (!isdigit(c))
00131                         <span class="keywordflow">return</span> (0);
00132                 val = 0; base = 10;
00133                 <span class="keywordflow">if</span> (c == <span class="charliteral">'0'</span>) {
00134                         c = *++src;
00135                         <span class="keywordflow">if</span> (c == <span class="charliteral">'x'</span> || c == <span class=
"charliteral">'X'</span>)
00136                                 base = 16, c = *++src;
00137                         <span class="keywordflow">else</span> <span class=
"keywordflow">if</span> (isdigit(c) &amp;&amp; c != <span class="charliteral">'9'</span>)
00138                                 base = 8;
00139                 }
00140                 <span class="comment">/* inet_pton() takes decimal only */</span>
00141                 <span class="keywordflow">if</span> (pton &amp;&amp; base != 10)
00142                         <span class="keywordflow">return</span> (0);
00143                 <span class="keywordflow">for</span> (;;) {
00144                         <span class="keywordflow">if</span> (isdigit(c)) {
00145                                 digit = c - <span class="charliteral">'0'</span>;
00146                                 <span class="keywordflow">if</span> ((int)digit &gt;= base)
00147                                         <span class="keywordflow">break</span>;
00148                                 val = (val * base) + digit;
00149                                 c = *++src;
00150                         } <span class="keywordflow">else</span> <span class=
"keywordflow">if</span> (base == 16 &amp;&amp; isxdigit(c)) {
00151                                 digit = c + 10 - (islower(c) ? <span class="charliteral">'a'</span> : <span class=
"charliteral">'A'</span>);
00152                                 <span class="keywordflow">if</span> (digit &gt;= 16)
00153                                         <span class="keywordflow">break</span>;
00154                                 val = (val &lt;&lt; 4) | digit;
00155                                 c = *++src;
00156                         } <span class="keywordflow">else</span>
00157                                 <span class="keywordflow">break</span>;
00158                 }
00159                 <span class="keywordflow">if</span> (c == <span class="charliteral">'.'</span>) {
00160                         <span class="comment">/*</span>
00161 <span class="comment">                         * Internet format:</span>
00162 <span class="comment">                         *      a.b.c.d</span>
00163 <span class="comment">                         *      a.b.c   (with c treated as 16 bits)</span>
00164 <span class="comment">                         *      a.b     (with b treated as 24 bits)</span>
00165 <span class="comment">                         *      a       (with a treated as 32 bits)</span>
00166 <span class="comment">                         */</span>
00167                         <span class="keywordflow">if</span> (pp &gt;= parts + 3)
00168                                 <span class="keywordflow">return</span> (0);
00169                         *pp++ = val;
00170                         c = *++src;
00171                 } <span class="keywordflow">else</span>
00172                         <span class="keywordflow">break</span>;
00173         }
00174         <span class="comment">/*</span>
00175 <span class="comment">         * Check for trailing characters.</span>
00176 <span class="comment">         */</span>
00177         <span class="keywordflow">if</span> (c != <span class="charliteral">'\0'</span> &amp;&amp; !isspace(c))
00178                 <span class="keywordflow">return</span> (0);
00179         <span class="comment">/*</span>
00180 <span class="comment">         * Concoct the address according to</span>
00181 <span class="comment">         * the number of parts specified.</span>
00182 <span class="comment">         */</span>
00183         n = pp - parts + 1;
00184         <span class="comment">/* inet_pton() takes dotted-quad only.  it does not take shorthand. */</span>
00185         <span class="keywordflow">if</span> (pton &amp;&amp; n != 4)
00186                 <span class="keywordflow">return</span> (0);
00187         <span class="keywordflow">switch</span> (n) {
00188 
00189         <span class="keywordflow">case</span> 0:
00190                 <span class="keywordflow">return</span> (0);             <span class=
"comment">/* initial nondigit */</span>
00191 
00192         <span class="keywordflow">case</span> 1:                         <span class="comment">/* a -- 32 bits */</span>
00193                 <span class="keywordflow">break</span>;
00194 
00195         <span class="keywordflow">case</span> 2:                         <span class=
"comment">/* a.b -- 8.24 bits */</span>
00196                 <span class="keywordflow">if</span> (parts[0] &gt; 0xff || val &gt; 0xffffff)
00197                         <span class="keywordflow">return</span> (0);
00198                 val |= parts[0] &lt;&lt; 24;
00199                 <span class="keywordflow">break</span>;
00200 
00201         <span class="keywordflow">case</span> 3:                         <span class=
"comment">/* a.b.c -- 8.8.16 bits */</span>
00202                 <span class="keywordflow">if</span> ((parts[0] | parts[1]) &gt; 0xff || val &gt; 0xffff)
00203                         <span class="keywordflow">return</span> (0);
00204                 val |= (parts[0] &lt;&lt; 24) | (parts[1] &lt;&lt; 16);
00205                 <span class="keywordflow">break</span>;
00206 
00207         <span class="keywordflow">case</span> 4:                         <span class=
"comment">/* a.b.c.d -- 8.8.8.8 bits */</span>
00208                 <span class="keywordflow">if</span> ((parts[0] | parts[1] | parts[2] | val) &gt; 0xff)
00209                         <span class="keywordflow">return</span> (0);
00210                 val |= (parts[0] &lt;&lt; 24) | (parts[1] &lt;&lt; 16) | (parts[2] &lt;&lt; 8);
00211                 <span class="keywordflow">break</span>;
00212         }
00213         <span class="keywordflow">if</span> (dst) {
00214                 val = htonl(val);
00215                 memcpy(dst, &amp;val, INADDRSZ);
00216         }
00217         <span class="keywordflow">return</span> (1);
00218 }
00219 
00220 <span class="preprocessor">#ifdef INET6</span>
00221 <span class="comment">/* int</span>
00222 <span class="comment"> * inet_pton6(src, dst)</span>
00223 <span class="comment"> *      convert presentation level address to network order binary form.</span>
00224 <span class="comment"> * return:</span>
00225 <span class="comment"> *      1 if `src' is a valid [RFC1884 2.2] address, else 0.</span>
00226 <span class="comment"> * notice:</span>
00227 <span class="comment"> *      (1) does not touch `dst' unless it's returning 1.</span>
00228 <span class="comment"> *      (2) :: in a full address is silently ignored.</span>
00229 <span class="comment"> * credit:</span>
00230 <span class="comment"> *      inspired by Mark Andrews.</span>
00231 <span class="comment"> * author:</span>
00232 <span class="comment"> *      Paul Vixie, 1996.</span>
00233 <span class="comment"> */</span>
00234 <span class="keyword">static</span> <span class="keywordtype">int</span>
00235 inet_pton6(src, dst)
00236         const <span class="keywordtype">char</span> *src;
00237         u_char *dst;
00238 {
00239         <span class="keyword">static</span> <span class="keyword">const</span> <span class=
"keywordtype">char</span> xdigits_l[] = <span class="stringliteral">"0123456789abcdef"</span>,
00240                           xdigits_u[] = <span class="stringliteral">"0123456789ABCDEF"</span>;
00241         u_char tmp[IN6ADDRSZ], *tp, *endp, *colonp;
00242         <span class="keyword">const</span> <span class="keywordtype">char</span> *xdigits, *curtok;
00243         <span class="keywordtype">int</span> ch, saw_xdigit;
00244         u_int val;
00245 
00246         memset((tp = tmp), <span class="charliteral">'\0'</span>, IN6ADDRSZ);
00247         endp = tp + IN6ADDRSZ;
00248         colonp = NULL;
00249         <span class="comment">/* Leading :: requires some special handling. */</span>
00250         <span class="keywordflow">if</span> (*src == <span class="charliteral">':'</span>)
00251                 <span class="keywordflow">if</span> (*++src != <span class="charliteral">':'</span>)
00252                         <span class="keywordflow">return</span> (0);
00253         curtok = src;
00254         saw_xdigit = 0;
00255         val = 0;
00256         <span class="keywordflow">while</span> ((ch = *src++) != <span class="charliteral">'\0'</span>) {
00257                 <span class="keyword">const</span> <span class="keywordtype">char</span> *pch;
00258 
00259                 <span class="keywordflow">if</span> ((pch = strchr((xdigits = xdigits_l), ch)) == NULL)
00260                         pch = strchr((xdigits = xdigits_u), ch);
00261                 <span class="keywordflow">if</span> (pch != NULL) {
00262                         val &lt;&lt;= 4;
00263                         val |= (pch - xdigits);
00264                         <span class="keywordflow">if</span> (val &gt; 0xffff)
00265                                 <span class="keywordflow">return</span> (0);
00266                         saw_xdigit = 1;
00267                         <span class="keywordflow">continue</span>;
00268                 }
00269                 <span class="keywordflow">if</span> (ch == <span class="charliteral">':'</span>) {
00270                         curtok = src;
00271                         <span class="keywordflow">if</span> (!saw_xdigit) {
00272                                 <span class="keywordflow">if</span> (colonp)
00273                                         <span class="keywordflow">return</span> (0);
00274                                 colonp = tp;
00275                                 <span class="keywordflow">continue</span>;
00276                         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (*src == <span class=
"charliteral">'\0'</span>)
00277                                 <span class="keywordflow">return</span> (0);
00278                         <span class="keywordflow">if</span> (tp + INT16SZ &gt; endp)
00279                                 <span class="keywordflow">return</span> (0);
00280                         *tp++ = (u_char) (val &gt;&gt; 8) &amp; 0xff;
00281                         *tp++ = (u_char) val &amp; 0xff;
00282                         saw_xdigit = 0;
00283                         val = 0;
00284                         <span class="keywordflow">continue</span>;
00285                 }
00286                 <span class="keywordflow">if</span> (ch == <span class=
"charliteral">'.'</span> &amp;&amp; ((tp + INADDRSZ) &lt;= endp) &amp;&amp;
00287                     inet_pton4(curtok, tp, 1) &gt; 0) {
00288                         tp += INADDRSZ;
00289                         saw_xdigit = 0;
00290                         <span class="keywordflow">break</span>;  <span class=
"comment">/* '\0' was seen by inet_pton4(). */</span>
00291                 }
00292                 <span class="keywordflow">return</span> (0);
00293         }
00294         <span class="keywordflow">if</span> (saw_xdigit) {
00295                 <span class="keywordflow">if</span> (tp + INT16SZ &gt; endp)
00296                         <span class="keywordflow">return</span> (0);
00297                 *tp++ = (u_char) (val &gt;&gt; 8) &amp; 0xff;
00298                 *tp++ = (u_char) val &amp; 0xff;
00299         }
00300         <span class="keywordflow">if</span> (colonp != NULL) {
00301                 <span class="comment">/*</span>
00302 <span class="comment">                 * Since some memmove()'s erroneously fail to handle</span>
00303 <span class="comment">                 * overlapping regions, we'll do the shift by hand.</span>
00304 <span class="comment">                 */</span>
00305                 <span class="keyword">const</span> <span class="keywordtype">int</span> n = tp - colonp;
00306                 <span class="keywordtype">int</span> i;
00307 
00308                 <span class="keywordflow">if</span> (tp == endp)
00309                         <span class="keywordflow">return</span> (0);
00310                 <span class="keywordflow">for</span> (i = 1; i &lt;= n; i++) {
00311                         endp[- i] = colonp[n - i];
00312                         colonp[n - i] = 0;
00313                 }
00314                 tp = endp;
00315         }
00316         <span class="keywordflow">if</span> (tp != endp)
00317                 <span class="keywordflow">return</span> (0);
00318         memcpy(dst, tmp, IN6ADDRSZ);
00319         <span class="keywordflow">return</span> (1);
00320 }
00321 <span class="preprocessor">#endif</span>
00322 
00323 <span class="preprocessor">#endif </span><span class="comment">/* HAVE_INET_PTON */</span>
</pre>
  </div>
  <hr size="1" />

  <address style="align: right;">
    <small><!--#include virtual="/sfbutton.html" --><br />
    Generated on Thu Nov 25 17:51:37 2004 for net-snmp by&nbsp; <a href="http://www.doxygen.org/index.html"><img src=
    "doxygen.png" alt="doxygen" align="middle" border="0" /></a> 1.3.9.1</small>
  </address>
<!-- CONTENT END -->
<!--#include virtual="/page-bottom.html" -->

