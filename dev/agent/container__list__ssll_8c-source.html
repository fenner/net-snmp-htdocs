<!--#set var="section" value="development" -->
<!--#include virtual="/page-top.html" -->
<!-- CONTENT START -->
  <!-- Generated by Doxygen 1.3.9.1 -->

  <div class="qindex">
    <a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="modules.html">Modules</a> | <a class=
    "qindex" href="annotated.html">Data&nbsp;Structures</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class=
    "qindex" href="functions.html">Data&nbsp;Fields</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a> | <a class=
    "qindex" href="examples.html">Examples</a>
  </div>

  <div class="nav">
    <a class="el" href="dir_000005.html">snmplib</a>
  </div>

  <h1>container_list_ssll.c</h1>

  <div class="fragment">
    <pre class="fragment">
00001 <span class="comment">/*</span>
00002 <span class="comment"> * container_list_sl.c</span>
00003 <span class="comment"> * $Id$</span>
00004 <span class="comment"> *</span>
00005 <span class="comment"> */</span>
00006 <span class="preprocessor">#include &lt;net-snmp/net-snmp-config.h&gt;</span>
00007 
00008 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
00009 <span class="preprocessor">#if HAVE_STDLIB_H</span>
00010 <span class="preprocessor">#include &lt;stdlib.h&gt;</span>
00011 <span class="preprocessor">#endif</span>
00012 <span class="preprocessor">#if HAVE_MALLOC_H</span>
00013 <span class="preprocessor">#include &lt;malloc.h&gt;</span>
00014 <span class="preprocessor">#endif</span>
00015 <span class="preprocessor">#include &lt;sys/types.h&gt;</span>
00016 <span class="preprocessor">#if HAVE_STRING_H</span>
00017 <span class="preprocessor">#include &lt;string.h&gt;</span>
00018 <span class="preprocessor">#else</span>
00019 <span class="preprocessor">#include &lt;strings.h&gt;</span>
00020 <span class="preprocessor">#endif</span>
00021 
00022 <span class="preprocessor">#include &lt;net-snmp/net-snmp-includes.h&gt;</span>
00023 <span class="preprocessor">#include &lt;net-snmp/types.h&gt;</span>
00024 <span class="preprocessor">#include &lt;net-snmp/library/snmp_api.h&gt;</span>
00025 <span class="preprocessor">#include &lt;net-snmp/library/container.h&gt;</span>
00026 <span class="preprocessor">#include &lt;net-snmp/library/tools.h&gt;</span>
00027 <span class="preprocessor">#include &lt;net-snmp/library/snmp_assert.h&gt;</span>
00028 
00029 <span class="preprocessor">#include &lt;net-snmp/library/container_list_ssll.h&gt;</span>
00030 
00031 <span class="keyword">typedef</span> <span class="keyword">struct </span>sl_node {
00032    <span class="keywordtype">void</span>           *data;
00033    <span class="keyword">struct </span>sl_node *next;
00034 } sl_node;
00035 
00036 <span class="keyword">typedef</span> <span class="keyword">struct </span>sl_container_s {
00037    netsnmp_container          c;
00038    
00039    size_t                     count;      <span class="comment">/* Index of the next free entry */</span>
00040    sl_node                   *head;       <span class="comment">/* head of list */</span>
00041 
00042    <span class="keywordtype">int</span>                        unsorted;   <span class=
"comment">/* unsorted list? */</span>
00043    <span class="keywordtype">int</span>                        fifo;       <span class="comment">/* lifo or fifo? */</span>
00044 
00045 } sl_container;
00046 
00047 
00048 <span class="keyword">static</span> <span class="keywordtype">void</span> *
00049 _get(netsnmp_container *c, <span class="keyword">const</span> <span class="keywordtype">void</span> *key, <span class=
"keywordtype">int</span> exact)
00050 {
00051     sl_container *sl = (sl_container*)c;
00052     sl_node  *curr = sl-&gt;head;
00053     <span class="keywordtype">int</span> rc = 0;
00054     
00055     <span class="comment">/*</span>
00056 <span class="comment">     * note: get-next on unsorted list is meaningless. we</span>
00057 <span class="comment">     * don't try to search whole array, looking for the next highest.</span>
00058 <span class="comment">     */</span>
00059     <span class="keywordflow">if</span>( (NULL != curr) &amp;&amp; (NULL != key)) {
00060         <span class="keywordflow">while</span> (curr) {
00061             rc = sl-&gt;c.compare(curr-&gt;data, key);
00062             <span class="keywordflow">if</span> (rc == 0)
00063                 <span class="keywordflow">break</span>;
00064             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (rc &gt; 0) {
00065                 <span class="keywordflow">if</span> (0 == sl-&gt;unsorted) {
00066                     <span class="comment">/*</span>
00067 <span class="comment">                     * if sorted, we can stop.</span>
00068 <span class="comment">                     */</span>
00069                     <span class="keywordflow">break</span>;
00070                 }
00071             }
00072             curr = curr-&gt;next;
00073         }
00074         
00075         <span class="keywordflow">if</span>((curr) &amp;&amp; (!exact) &amp;&amp; (rc == 0)) {
00076             curr = curr-&gt;next;
00077         }
00078     }
00079     
00080     <span class="keywordflow">return</span> curr ? curr-&gt;data : NULL;
00081 }
00082 
00083 <span class="comment">/**********************************************************************</span>
00084 <span class="comment"> *</span>
00085 <span class="comment"> *</span>
00086 <span class="comment"> *</span>
00087 <span class="comment"> **********************************************************************/</span>
00088 <span class="keyword">static</span> <span class="keywordtype">void</span>
00089 _ssll_free(netsnmp_container *c)
00090 {
00091     <span class="keywordflow">if</span>(c) {
00092         free(c);
00093     }
00094 }
00095 
00096 <span class="keyword">static</span> <span class="keywordtype">void</span> *
00097 _ssll_find(netsnmp_container *c, <span class="keyword">const</span> <span class="keywordtype">void</span> *data)
00098 {
00099     <span class="keywordflow">if</span>((NULL == c) || (NULL == data))
00100         <span class="keywordflow">return</span> NULL;
00101 
00102     <span class="keywordflow">return</span> _get(c, data, 1);
00103 }
00104 
00105 <span class="keyword">static</span> <span class="keywordtype">void</span> *
00106 _ssll_find_next(netsnmp_container *c, <span class="keyword">const</span> <span class="keywordtype">void</span> *data)
00107 {
00108     <span class="keywordflow">if</span>(NULL == c)
00109         <span class="keywordflow">return</span> NULL;
00110 
00111     <span class="keywordflow">return</span> _get(c, data, 0);
00112 }
00113 
00114 <span class="keyword">static</span> <span class="keywordtype">int</span>
00115 _ssll_insert(netsnmp_container *c, <span class="keyword">const</span> <span class="keywordtype">void</span> *data)
00116 {
00117     sl_container *sl = (sl_container*)c;
00118     sl_node  *new_node, *curr = sl-&gt;head;
00119     
00120     <span class="keywordflow">if</span>(NULL == c)
00121         <span class="keywordflow">return</span> -1;
00122     
00123     new_node = <a class="code" href="group__util.html#ga39">SNMP_MALLOC_TYPEDEF</a>(sl_node);
00124     <span class="keywordflow">if</span>(NULL == new_node)
00125         <span class="keywordflow">return</span> -1;
00126     new_node-&gt;data = (<span class="keywordtype">void</span> *)data;
00127     ++sl-&gt;count;
00128 
00129     <span class="comment">/*</span>
00130 <span class="comment">     * first node?</span>
00131 <span class="comment">     */</span>
00132     <span class="keywordflow">if</span>(NULL == sl-&gt;head) {
00133         sl-&gt;head = new_node;
00134         <span class="keywordflow">return</span> 0;
00135     }
00136 
00137     <span class="comment">/*</span>
00138 <span class="comment">     * sorted or unsorted insert?</span>
00139 <span class="comment">     */</span>
00140     <span class="keywordflow">if</span> (1 == sl-&gt;unsorted) {
00141         <span class="comment">/*</span>
00142 <span class="comment">         * unsorted: fifo, or lifo?</span>
00143 <span class="comment">         */</span>
00144         <span class="keywordflow">if</span> (1 == sl-&gt;fifo) {
00145             <span class="comment">/*</span>
00146 <span class="comment">             * fifo: insert at tail</span>
00147 <span class="comment">             */</span>
00148             <span class="keywordflow">while</span>(NULL != curr-&gt;next)
00149                 curr = curr-&gt;next;
00150             curr-&gt;next = new_node;
00151         }
00152         <span class="keywordflow">else</span> {
00153             <span class="comment">/*</span>
00154 <span class="comment">             * lifo: insert at head</span>
00155 <span class="comment">             */</span>
00156             new_node-&gt;next = sl-&gt;head;
00157             sl-&gt;head = new_node;
00158         }
00159     }
00160     <span class="keywordflow">else</span> {
00161         <span class="comment">/*</span>
00162 <span class="comment">         * sorted</span>
00163 <span class="comment">         */</span>
00164         sl_node *last = NULL;
00165         <span class="keywordflow">for</span>( ; curr; last = curr, curr = curr-&gt;next) {
00166             <span class="keywordflow">if</span>(sl-&gt;c.compare(curr-&gt;data, data) &gt; 0)
00167                 <span class="keywordflow">break</span>;
00168         }
00169         <span class="keywordflow">if</span>(NULL == last) {
00170             new_node-&gt;next = sl-&gt;head;
00171             sl-&gt;head = new_node;
00172         }
00173         <span class="keywordflow">else</span> {
00174             new_node-&gt;next = last-&gt;next;
00175             last-&gt;next = new_node;
00176         }
00177     }
00178     
00179     <span class="keywordflow">return</span> 0;
00180 }
00181 
00182 <span class="keyword">static</span> <span class="keywordtype">int</span>
00183 _ssll_remove(netsnmp_container *c, <span class="keyword">const</span> <span class="keywordtype">void</span> *data)
00184 {
00185     sl_container *sl = (sl_container*)c;
00186     sl_node  *curr = sl-&gt;head;
00187     
00188     <span class="keywordflow">if</span>((NULL == c) || (NULL == curr))
00189         <span class="keywordflow">return</span> -1;
00190     
00191     <span class="comment">/*</span>
00192 <span class="comment">     * special case for NULL data, act like stack</span>
00193 <span class="comment">     */</span>
00194     <span class="keywordflow">if</span> ((NULL == data) ||
00195         (sl-&gt;c.compare(sl-&gt;head-&gt;data, data) == 0)) {
00196         curr = sl-&gt;head;
00197         sl-&gt;head = sl-&gt;head-&gt;next;
00198     }
00199     <span class="keywordflow">else</span> {
00200         sl_node *last = sl-&gt;head;
00201         <span class="keywordtype">int</span> rc;
00202         <span class="keywordflow">for</span>(curr = sl-&gt;head-&gt;next ; curr; last = curr, curr = curr-&gt;next) {
00203             rc = sl-&gt;c.compare(curr-&gt;data, data);
00204             <span class="keywordflow">if</span> (rc == 0) {
00205                 last-&gt;next = curr-&gt;next;
00206                 <span class="keywordflow">break</span>;
00207             }
00208             <span class="keywordflow">else</span> <span class=
"keywordflow">if</span> ((rc &gt; 0) &amp;&amp; (0 == sl-&gt;unsorted)) {
00209                 <span class="comment">/*</span>
00210 <span class="comment">                 * if sorted and rc &gt; 0, didn't find entry</span>
00211 <span class="comment">                 */</span>
00212                 curr = NULL;
00213                 <span class="keywordflow">break</span>;
00214             }
00215         }
00216     }
00217 
00218     <span class="keywordflow">if</span>(NULL == curr)
00219         <span class="keywordflow">return</span> -2;
00220     
00221     <span class="comment">/*</span>
00222 <span class="comment">     * free our node structure, but not the data</span>
00223 <span class="comment">     */</span>
00224     free(curr);
00225     --sl-&gt;count;
00226     
00227     <span class="keywordflow">return</span> 0;
00228 }
00229 
00230 <span class="keyword">static</span> size_t
00231 _ssll_size(netsnmp_container *c)
00232 {
00233     sl_container *sl = (sl_container*)c;
00234     
00235     <span class="keywordflow">if</span>(NULL == c)
00236         <span class="keywordflow">return</span> 0;
00237 
00238     <span class="keywordflow">return</span> sl-&gt;count;
00239 }
00240 
00241 <span class="keyword">static</span> <span class="keywordtype">void</span>
00242 _ssll_for_each(netsnmp_container *c, netsnmp_container_obj_func *f,
00243              <span class="keywordtype">void</span> *context)
00244 {
00245     sl_container *sl = (sl_container*)c;
00246     sl_node  *curr;
00247     
00248     <span class="keywordflow">if</span>(NULL == c)
00249         <span class="keywordflow">return</span>;
00250     
00251     <span class="keywordflow">for</span>(curr = sl-&gt;head; curr; curr = curr-&gt;next)
00252         (*f) ((<span class="keywordtype">void</span> *)curr-&gt;data, context);
00253 }
00254 
00255 <span class="keyword">static</span> <span class="keywordtype">void</span>
00256 _ssll_clear(netsnmp_container *c, netsnmp_container_obj_func *f,
00257              <span class="keywordtype">void</span> *context)
00258 {
00259     sl_container *sl = (sl_container*)c;
00260     sl_node  *curr, *next;
00261     
00262     <span class="keywordflow">if</span>(NULL == c)
00263         <span class="keywordflow">return</span>;
00264     
00265     <span class="keywordflow">for</span>(curr = sl-&gt;head; curr; curr = next) {
00266 
00267         next = curr-&gt;next;
00268 
00269         <span class="keywordflow">if</span>( NULL != f ) {
00270             curr-&gt;next = NULL;
00271             (*f) ((<span class="keywordtype">void</span> *)curr-&gt;data, context);
00272         }
00273 
00274         <span class="comment">/*</span>
00275 <span class="comment">         * free our node structure, but not the data</span>
00276 <span class="comment">         */</span>
00277         free(curr);
00278     }
00279     sl-&gt;head = NULL;
00280     sl-&gt;count = 0;
00281 }
00282 
00283 <span class="comment">/**********************************************************************</span>
00284 <span class="comment"> *</span>
00285 <span class="comment"> *</span>
00286 <span class="comment"> *</span>
00287 <span class="comment"> **********************************************************************/</span>
00288 netsnmp_container *
00289 netsnmp_container_get_ssll(<span class="keywordtype">void</span>)
00290 {
00291     <span class="comment">/*</span>
00292 <span class="comment">     * allocate memory</span>
00293 <span class="comment">     */</span>
00294     sl_container *sl = <a class="code" href="group__util.html#ga39">SNMP_MALLOC_TYPEDEF</a>(sl_container);
00295     <span class="keywordflow">if</span> (NULL==sl) {
00296         <a class="code" href="group__snmp__logging.html#ga39">snmp_log</a>(LOG_ERR, <span class=
"stringliteral">"couldn't allocate memory\n"</span>);
00297         <span class="keywordflow">return</span> NULL;
00298     }
00299 
00300     sl-&gt;c.cfree = (netsnmp_container_rc*)_ssll_free;
00301         
00302     sl-&gt;c.get_size = _ssll_size;
00303     sl-&gt;c.init = NULL;
00304     sl-&gt;c.insert = _ssll_insert;
00305     sl-&gt;c.remove = _ssll_remove;
00306     sl-&gt;c.find = _ssll_find;
00307     sl-&gt;c.find_next = _ssll_find_next;
00308     sl-&gt;c.get_subset = NULL;
00309     sl-&gt;c.get_iterator = NULL;
00310     sl-&gt;c.for_each = _ssll_for_each;
00311     sl-&gt;c.clear = _ssll_clear;
00312 
00313        
00314     <span class="keywordflow">return</span> (netsnmp_container*)sl;
00315 }
00316 
00317 netsnmp_factory *
00318 netsnmp_container_get_ssll_factory(<span class="keywordtype">void</span>)
00319 {
00320     <span class="keyword">static</span> netsnmp_factory f = {<span class=
"stringliteral">"sorted_singly_linked_list"</span>,
00321                                 (netsnmp_factory_produce_f*)
00322                                 netsnmp_container_get_ssll };
00323     
00324     <span class="keywordflow">return</span> &amp;f;
00325 }
00326 
00327 
00328 netsnmp_container *
00329 netsnmp_container_get_usll(<span class="keywordtype">void</span>)
00330 {
00331     <span class="comment">/*</span>
00332 <span class="comment">     * allocate memory</span>
00333 <span class="comment">     */</span>
00334     sl_container *sl = (sl_container *)netsnmp_container_get_ssll();
00335     <span class="keywordflow">if</span> (NULL==sl)
00336         <span class="keywordflow">return</span> NULL; <span class="comment">/* msg already logged */</span>
00337 
00338     sl-&gt;unsorted = 1;
00339 
00340     <span class="keywordflow">return</span> (netsnmp_container*)sl;
00341 }
00342 
00343 netsnmp_container *
00344 netsnmp_container_get_singly_linked_list(<span class="keywordtype">int</span> fifo)
00345 {
00346     sl_container *sl = (sl_container *)netsnmp_container_get_usll();
00347     <span class="keywordflow">if</span> (NULL == sl)
00348         <span class="keywordflow">return</span> NULL; <span class="comment">/* error already logged */</span>
00349 
00350     sl-&gt;fifo = fifo;
00351 
00352     <span class="keywordflow">return</span> (netsnmp_container *)sl;
00353 }
00354 
00355 netsnmp_container *
00356 netsnmp_container_get_fifo(<span class="keywordtype">void</span>)
00357 {
00358     <span class="keywordflow">return</span> netsnmp_container_get_singly_linked_list(1);
00359 }
00360 
00361 netsnmp_factory *
00362 netsnmp_container_get_usll_factory(<span class="keywordtype">void</span>)
00363 {
00364     <span class="keyword">static</span> netsnmp_factory f = {<span class=
"stringliteral">"unsorted_singly_linked_list-lifo"</span>,
00365                                 (netsnmp_factory_produce_f*)
00366                                 netsnmp_container_get_usll };
00367     
00368     <span class="keywordflow">return</span> &amp;f;
00369 }
00370 
00371 netsnmp_factory *
00372 netsnmp_container_get_fifo_factory(<span class="keywordtype">void</span>)
00373 {
00374     <span class="keyword">static</span> netsnmp_factory f = {<span class=
"stringliteral">"unsorted_singly_linked_list-fifo"</span>,
00375                                 (netsnmp_factory_produce_f*)
00376                                 netsnmp_container_get_fifo };
00377     
00378     <span class="keywordflow">return</span> &amp;f;
00379 }
00380 
00381 <span class="keywordtype">void</span>
00382 netsnmp_container_ssll_init(<span class="keywordtype">void</span>)
00383 {
00384     netsnmp_container_register(<span class="stringliteral">"sorted_singly_linked_list"</span>,
00385                                netsnmp_container_get_ssll_factory());
00386     netsnmp_container_register(<span class="stringliteral">"unsorted_singly_linked_list"</span>,
00387                                netsnmp_container_get_usll_factory());
00388     netsnmp_container_register(<span class="stringliteral">"lifo"</span>,
00389                                netsnmp_container_get_usll_factory());
00390     netsnmp_container_register(<span class="stringliteral">"fifo"</span>,
00391                                netsnmp_container_get_fifo_factory());
00392 }
00393 
</pre>
  </div>
  <hr size="1" />

  <address style="align: right;">
    <small><!--#include virtual="/sfbutton.html" --><br />
    Generated on Thu Nov 25 17:51:37 2004 for net-snmp by&nbsp; <a href="http://www.doxygen.org/index.html"><img src=
    "doxygen.png" alt="doxygen" align="middle" border="0" /></a> 1.3.9.1</small>
  </address>
<!-- CONTENT END -->
<!--#include virtual="/page-bottom.html" -->

