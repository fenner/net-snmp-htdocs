<!--#set var="section" value="development" -->
<!--#include virtual="/page-top.html" -->
<!-- CONTENT START -->
  <!-- Generated by Doxygen 1.3.9.1 -->

  <div class="qindex">
    <a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="modules.html">Modules</a> | <a class=
    "qindex" href="annotated.html">Data&nbsp;Structures</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class=
    "qindex" href="functions.html">Data&nbsp;Fields</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a> | <a class=
    "qindex" href="examples.html">Examples</a>
  </div>

  <div class="nav">
    <a class="el" href="dir_000003.html">agent</a>&nbsp;/&nbsp;<a class="el" href="dir_000004.html">helpers</a>
  </div>

  <h1>table_dataset.c</h1>

  <div class="fragment">
    <pre class="fragment">
00001 <span class="preprocessor">#include &lt;net-snmp/net-snmp-config.h&gt;</span>
00002 
00003 <span class="preprocessor">#if HAVE_STRING_H</span>
00004 <span class="preprocessor">#include &lt;string.h&gt;</span>
00005 <span class="preprocessor">#else</span>
00006 <span class="preprocessor">#include &lt;strings.h&gt;</span>
00007 <span class="preprocessor">#endif</span>
00008 
00009 <span class="preprocessor">#include &lt;net-snmp/net-snmp-includes.h&gt;</span>
00010 <span class="preprocessor">#include &lt;net-snmp/agent/net-snmp-agent-includes.h&gt;</span>
00011 
00012 <span class="keyword">static</span> <a class="code" href=
"structnetsnmp__data__list__s.html">netsnmp_data_list</a> *auto_tables;
00013 
00014 <span class="keyword">typedef</span> <span class="keyword">struct </span>data_set_tables_s {
00015     netsnmp_table_data_set *table_set;
00016 } data_set_tables;
00017 
00018 <span class="keyword">typedef</span> <span class="keyword">struct </span>data_set_cache_s {
00019     <span class="keywordtype">void</span>           *data;
00020     size_t          data_len;
00021 } data_set_cache;
00022 
00023 <span class="preprocessor">#define STATE_ACTION   1</span>
00024 <span class="preprocessor">#define STATE_COMMIT   2</span>
00025 <span class="preprocessor">#define STATE_UNDO     3</span>
00026 <span class="preprocessor">#define STATE_FREE     4</span>
00027 
00028 <span class="keyword">typedef</span> <span class="keyword">struct </span>newrow_stash_s {
00029     netsnmp_table_row *newrow;
00030     <span class="keywordtype">int</span>             state;
00031     <span class="keywordtype">int</span>             created;
00032     <span class="keywordtype">int</span>             deleted;
00033 } newrow_stash;
00034 
00060 <span class="keywordtype">void</span>
00061 netsnmp_init_table_dataset(<span class="keywordtype">void</span>) {
00062 <span class="preprocessor">#ifndef DISABLE_MIB_LOADING</span>
00063     register_app_config_handler(<span class="stringliteral">"table"</span>,
00064                                 netsnmp_config_parse_table_set, NULL,
00065                                 <span class="stringliteral">"tableoid"</span>);
00066 <span class="preprocessor">#endif </span><span class="comment">/* DISABLE_MIB_LOADING */</span>
00067     register_app_config_handler(<span class="stringliteral">"add_row"</span>, netsnmp_config_parse_add_row,
00068                                 NULL, <span class="stringliteral">"table_name indexes... values..."</span>);
00069 }
00070 
00071 <span class="comment">/* ==================================</span>
00072 <span class="comment"> *</span>
00073 <span class="comment"> * Data Set API: Table maintenance</span>
00074 <span class="comment"> *</span>
00075 <span class="comment"> * ================================== */</span>
00076 
00078 netsnmp_table_data_set *
<a name="l00079" id="l00079"></a><a class="code" href="group__table__dataset.html#ga1">00079</a> <a class="code" href=
"group__table__dataset.html#ga1">netsnmp_create_table_data_set</a>(<span class="keyword">const</span> <span class=
"keywordtype">char</span> *table_name)
00080 {
00081     netsnmp_table_data_set *table_set =
00082         <a class="code" href="group__util.html#ga39">SNMP_MALLOC_TYPEDEF</a>(netsnmp_table_data_set);
00083     <span class="keywordflow">if</span> (!table_set)
00084         <span class="keywordflow">return</span> NULL;
00085     table_set-&gt;table = <a class="code" href="group__table__data.html#ga1">netsnmp_create_table_data</a>(table_name);
00086     <span class="keywordflow">return</span> table_set;
00087 }
00088 
00090 netsnmp_table_row *
<a name="l00091" id="l00091"></a><a class="code" href="group__table__dataset.html#ga2">00091</a> <a class="code" href=
"group__table__dataset.html#ga2">netsnmp_table_data_set_clone_row</a>(netsnmp_table_row *row)
00092 {
00093     netsnmp_table_data_set_storage *data, **newrowdata;
00094     netsnmp_table_row *newrow;
00095 
00096     <span class="keywordflow">if</span> (!row)
00097         <span class="keywordflow">return</span> NULL;
00098 
00099     newrow = <a class="code" href="group__table__data.html#ga3">netsnmp_table_data_clone_row</a>(row);
00100     <span class="keywordflow">if</span> (!newrow)
00101         <span class="keywordflow">return</span> NULL;
00102 
00103     data = (netsnmp_table_data_set_storage *) row-&gt;data;
00104 
00105     <span class="keywordflow">if</span> (data) {
00106         <span class="keywordflow">for</span> (newrowdata =
00107              (netsnmp_table_data_set_storage **) &amp;(newrow-&gt;data); data;
00108              newrowdata = &amp;((*newrowdata)-&gt;next), data = data-&gt;next) {
00109 
00110             <a class="code" href="group__util.html#ga5">memdup</a>((u_char **) newrowdata, (u_char *) data,
00111                    <span class="keyword">sizeof</span>(netsnmp_table_data_set_storage));
00112             <span class="keywordflow">if</span> (!*newrowdata) {
00113                 <a class="code" href="group__table__dataset.html#ga5">netsnmp_table_dataset_delete_row</a>(newrow);
00114                 <span class="keywordflow">return</span> NULL;
00115             }
00116 
00117             <span class="keywordflow">if</span> (data-&gt;data.voidp) {
00118                 <a class="code" href="group__util.html#ga5">memdup</a>((u_char **) &amp; ((*newrowdata)-&gt;data.voidp),
00119                        (u_char *) data-&gt;data.voidp, data-&gt;data_len);
00120                 <span class="keywordflow">if</span> (!(*newrowdata)-&gt;data.voidp) {
00121                     <a class="code" href="group__table__dataset.html#ga5">netsnmp_table_dataset_delete_row</a>(newrow);
00122                     <span class="keywordflow">return</span> NULL;
00123                 }
00124             }
00125         }
00126     }
00127     <span class="keywordflow">return</span> newrow;
00128 }
00129 
00133 NETSNMP_INLINE netsnmp_table_data_set_storage *
<a name="l00134" id="l00134"></a><a class="code" href="group__table__dataset.html#ga3">00134</a> <a class="code" href=
"group__table__dataset.html#ga3">netsnmp_table_dataset_delete_data</a>(netsnmp_table_data_set_storage *data)
00135 {
00136     netsnmp_table_data_set_storage *nextPtr = NULL;
00137     <span class="keywordflow">if</span> (data) {
00138         nextPtr = data-&gt;next;
00139         <a class="code" href="group__util.html#ga36">SNMP_FREE</a>(data-&gt;data.voidp);
00140     }
00141     <a class="code" href="group__util.html#ga36">SNMP_FREE</a>(data);
00142     <span class="keywordflow">return</span> nextPtr;
00143 }
00144 
00146 NETSNMP_INLINE <span class="keywordtype">void</span>
<a name="l00147" id="l00147"></a><a class="code" href="group__table__dataset.html#ga4">00147</a> <a class="code" href=
"group__table__dataset.html#ga4">netsnmp_table_dataset_delete_all_data</a>(netsnmp_table_data_set_storage *data)
00148 {
00149 
00150     <span class="keywordflow">while</span> (data) {
00151         data = <a class="code" href="group__table__dataset.html#ga3">netsnmp_table_dataset_delete_data</a>(data);
00152     }
00153 }
00154 
00156 NETSNMP_INLINE <span class="keywordtype">void</span>
<a name="l00157" id="l00157"></a><a class="code" href="group__table__dataset.html#ga5">00157</a> <a class="code" href=
"group__table__dataset.html#ga5">netsnmp_table_dataset_delete_row</a>(netsnmp_table_row *row)
00158 {
00159     netsnmp_table_data_set_storage *data;
00160 
00161     <span class="keywordflow">if</span> (!row)
00162         <span class="keywordflow">return</span>;
00163 
00164     data = <a class="code" href="group__table__data.html#ga4">netsnmp_table_data_delete_row</a>(row);
00165     <a class="code" href="group__table__dataset.html#ga4">netsnmp_table_dataset_delete_all_data</a>(data);
00166 }
00167 
00169 NETSNMP_INLINE <span class="keywordtype">void</span>
<a name="l00170" id="l00170"></a><a class="code" href="group__table__dataset.html#ga6">00170</a> <a class="code" href=
"group__table__dataset.html#ga6">netsnmp_table_dataset_add_row</a>(netsnmp_table_data_set *table,
00171                               netsnmp_table_row *row)
00172 {
00173     <span class="keywordflow">if</span> (!table)
00174         <span class="keywordflow">return</span>;
00175     <a class="code" href="group__table__data.html#ga5">netsnmp_table_data_add_row</a>(table-&gt;table, row);
00176 }
00177 
00179 NETSNMP_INLINE <span class="keywordtype">void</span>
<a name="l00180" id="l00180"></a><a class="code" href="group__table__dataset.html#ga7">00180</a> <a class="code" href=
"group__table__dataset.html#ga7">netsnmp_table_dataset_replace_row</a>(netsnmp_table_data_set *table,
00181                                   netsnmp_table_row *origrow,
00182                                   netsnmp_table_row *newrow)
00183 {
00184     <span class="keywordflow">if</span> (!table)
00185         <span class="keywordflow">return</span>;
00186     <a class="code" href=
"group__table__data.html#ga6">netsnmp_table_data_replace_row</a>(table-&gt;table, origrow, newrow);
00187 }
00188 
00190 NETSNMP_INLINE <span class="keywordtype">void</span>
<a name="l00191" id="l00191"></a><a class="code" href="group__table__dataset.html#ga8">00191</a> <a class="code" href=
"group__table__dataset.html#ga8">netsnmp_table_dataset_remove_row</a>(netsnmp_table_data_set *table,
00192                                  netsnmp_table_row *row)
00193 {
00194     <span class="keywordflow">if</span> (!table)
00195         <span class="keywordflow">return</span>;
00196 
00197     <a class="code" href="group__table__data.html#ga8">netsnmp_table_data_remove_and_delete_row</a>(table-&gt;table, row);
00198 }
00199 
00201 NETSNMP_INLINE <span class="keywordtype">void</span>
<a name="l00202" id="l00202"></a><a class="code" href="group__table__dataset.html#ga9">00202</a> <a class="code" href=
"group__table__dataset.html#ga9">netsnmp_table_dataset_remove_and_delete_row</a>(netsnmp_table_data_set *table,
00203                                             netsnmp_table_row *row)
00204 {
00205     netsnmp_table_data_set_storage *data;
00206 
00207     <span class="keywordflow">if</span> (!table)
00208         <span class="keywordflow">return</span>;
00209 
00210     data = (netsnmp_table_data_set_storage *)
00211         <a class="code" href=
"group__table__data.html#ga8">netsnmp_table_data_remove_and_delete_row</a>(table-&gt;table, row);
00212 
00213     <a class="code" href="group__table__dataset.html#ga4">netsnmp_table_dataset_delete_all_data</a>(data);
00214 }
00215 
00216 <span class="comment">/* ==================================</span>
00217 <span class="comment"> *</span>
00218 <span class="comment"> * Data Set API: Default row operations</span>
00219 <span class="comment"> *</span>
00220 <span class="comment"> * ================================== */</span>
00221 
00223 netsnmp_table_row *
00224 <a class="code" href="group__table__dataset.html#ga10">netsnmp_table_data_set_create_row_from_defaults</a>
<a name="l00225" id="l00225"></a><a class="code" href=
"group__table__dataset.html#ga10">00225</a>     (netsnmp_table_data_set_storage *defrow)
00226 {
00227     netsnmp_table_row *row;
00228     row = <a class="code" href="group__table__data.html#ga2">netsnmp_create_table_data_row</a>();
00229     <span class="keywordflow">if</span> (!row)
00230         <span class="keywordflow">return</span> NULL;
00231     <span class="keywordflow">for</span> (; defrow; defrow = defrow-&gt;next) {
00232         <a class="code" href=
"group__table__dataset.html#ga28">netsnmp_set_row_column</a>(row, defrow-&gt;column, defrow-&gt;type,
00233                                defrow-&gt;data.voidp, defrow-&gt;data_len);
00234         <span class="keywordflow">if</span> (defrow-&gt;writable)
00235             <a class="code" href=
"group__table__dataset.html#ga27">netsnmp_mark_row_column_writable</a>(row, defrow-&gt;column, 1);
00236 
00237     }
00238     <span class="keywordflow">return</span> row;
00239 }
00240 
00250 <span class="keywordtype">int</span>
<a name="l00251" id="l00251"></a><a class="code" href="group__table__dataset.html#ga11">00251</a> <a class="code" href=
"group__table__dataset.html#ga11">netsnmp_table_set_add_default_row</a>(netsnmp_table_data_set *table_set,
00252                                   <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> column,
00253                                   <span class="keywordtype">int</span> type, <span class="keywordtype">int</span> writable,
00254                                   <span class="keywordtype">void</span> *default_value,
00255                                   size_t default_value_len)
00256 {
00257     netsnmp_table_data_set_storage *new_col, *ptr, *pptr;
00258 
00259     <span class="keywordflow">if</span> (!table_set)
00260         <span class="keywordflow">return</span> SNMPERR_GENERR;
00261 
00262     <span class="comment">/*</span>
00263 <span class="comment">     * double check </span>
00264 <span class="comment">     */</span>
00265     new_col =
00266         <a class="code" href=
"group__table__dataset.html#ga26">netsnmp_table_data_set_find_column</a>(table_set-&gt;default_row, column);
00267     <span class="keywordflow">if</span> (new_col != NULL) {
00268         <span class="keywordflow">if</span> (new_col-&gt;type == type &amp;&amp; new_col-&gt;writable == writable)
00269             <span class="keywordflow">return</span> SNMPERR_SUCCESS;
00270         <span class="keywordflow">return</span> SNMPERR_GENERR;
00271     }
00272 
00273     new_col = <a class="code" href="group__util.html#ga39">SNMP_MALLOC_TYPEDEF</a>(netsnmp_table_data_set_storage);
00274     new_col-&gt;type = type;
00275     new_col-&gt;writable = writable;
00276     new_col-&gt;column = column;
00277     <span class="keywordflow">if</span> (default_value) {
00278         <a class="code" href="group__util.html#ga5">memdup</a>((u_char **) &amp; (new_col-&gt;data.voidp),
00279                (u_char *) default_value, default_value_len);
00280         new_col-&gt;data_len = default_value_len;
00281     }
00282     <span class="keywordflow">if</span> (table_set-&gt;default_row == NULL)
00283         table_set-&gt;default_row = new_col;
00284     <span class="keywordflow">else</span> {
00285         <span class="comment">/* sort in order just because (needed for add_row support) */</span>
00286         <span class="keywordflow">for</span> (ptr = table_set-&gt;default_row, pptr = NULL;
00287              ptr;
00288              pptr = ptr, ptr = ptr-&gt;next) {
00289             <span class="keywordflow">if</span> (ptr-&gt;column &gt; column) {
00290                 new_col-&gt;next = ptr;
00291                 <span class="keywordflow">if</span> (pptr)
00292                     pptr-&gt;next = new_col;
00293                 <span class="keywordflow">else</span>
00294                     table_set-&gt;default_row = new_col;
00295                 <span class="keywordflow">return</span> SNMPERR_SUCCESS;
00296             }
00297         }
00298         <span class="keywordflow">if</span> (pptr)
00299             pptr-&gt;next = new_col;
00300         <span class="keywordflow">else</span>
00301             <a class="code" href="group__snmp__logging.html#ga41">snmp_log</a>(LOG_ERR,<span class=
"stringliteral">"Shouldn't have gotten here: table_dataset/add_row"</span>);
00302     }
00303     <span class="keywordflow">return</span> SNMPERR_SUCCESS;
00304 }
00305 
00310 <span class="keywordtype">void</span>
00311 <span class="preprocessor">#if HAVE_STDARG_H</span>
00312 <a class="code" href=
"group__table__dataset.html#ga12">netsnmp_table_set_multi_add_default_row</a>(netsnmp_table_data_set *tset, ...)
00313 #<span class="keywordflow">else</span>
<a name="l00314" id="l00314"></a><a class="code" href="group__table__dataset.html#ga12">00314</a> <a class="code" href=
"group__table__dataset.html#ga12">netsnmp_table_set_multi_add_default_row</a>(va_dcl
00315     )
00316      va_dcl
00317 #endif
00318 {
00319     va_list         debugargs;
00320     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>    column;
00321     <span class="keywordtype">int</span>             type, writable;
00322     <span class="keywordtype">void</span>           *data;
00323     size_t          data_len;
00324 
00325 <span class="preprocessor">#if HAVE_STDARG_H</span>
00326     va_start(debugargs, tset);
00327 <span class="preprocessor">#else</span>
00328     netsnmp_table_data_set *tset;
00329 
00330     va_start(debugargs);
00331     tset = va_arg(debugargs, netsnmp_table_data_set *);
00332 <span class="preprocessor">#endif</span>
00333 
00334     <span class="keywordflow">while</span> ((column = va_arg(debugargs, <span class=
"keywordtype">unsigned</span> <span class="keywordtype">int</span>)) != 0) {
00335         type = va_arg(debugargs, <span class="keywordtype">int</span>);
00336         writable = va_arg(debugargs, <span class="keywordtype">int</span>);
00337         data = va_arg(debugargs, <span class="keywordtype">void</span> *);
00338         data_len = va_arg(debugargs, size_t);
00339         <a class="code" href=
"group__table__dataset.html#ga11">netsnmp_table_set_add_default_row</a>(tset, column, type, writable,
00340                                           data, data_len);
00341     }
00342 
00343     va_end(debugargs);
00344 }
00345 
00346 
00347 <span class="comment">/* ==================================</span>
00348 <span class="comment"> *</span>
00349 <span class="comment"> * Data Set API: MIB maintenance</span>
00350 <span class="comment"> *</span>
00351 <span class="comment"> * ================================== */</span>
00352 
00354 <a class="code" href="structnetsnmp__mib__handler__s.html">netsnmp_mib_handler</a> *
<a name="l00355" id="l00355"></a><a class="code" href="group__table__dataset.html#ga13">00355</a> <a class="code" href=
"group__table__dataset.html#ga13">netsnmp_get_table_data_set_handler</a>(netsnmp_table_data_set *data_set)
00356 {
00357     <a class="code" href="structnetsnmp__mib__handler__s.html">netsnmp_mib_handler</a> *ret = NULL;
00358 
00359     <span class="keywordflow">if</span> (!data_set) {
00360         <a class="code" href="group__snmp__logging.html#ga41">snmp_log</a>(LOG_INFO,
00361                  <span class="stringliteral">"netsnmp_get_table_data_set_handler(NULL) called\n"</span>);
00362         <span class="keywordflow">return</span> NULL;
00363     }
00364 
00365     ret =
00366         <a class="code" href="group__handler.html#ga7">netsnmp_create_handler</a>(TABLE_DATA_SET_NAME,
00367                                netsnmp_table_data_set_helper_handler);
00368     <span class="keywordflow">if</span> (ret) {
00369         ret-&gt;<a class="code" href="structnetsnmp__mib__handler__s.html#o2">flags</a> |= MIB_HANDLER_AUTO_NEXT;
00370         ret-&gt;<a class="code" href="structnetsnmp__mib__handler__s.html#o1">myvoid</a> = (<span class=
"keywordtype">void</span> *) data_set;
00371     }
00372     <span class="keywordflow">return</span> ret;
00373 }
00374 
00380 <span class="keywordtype">int</span>
<a name="l00381" id="l00381"></a><a class="code" href="group__table__dataset.html#ga14">00381</a> <a class="code" href=
"group__table__dataset.html#ga14">netsnmp_register_table_data_set</a>(<a class="code" href=
"structnetsnmp__handler__registration__s.html">netsnmp_handler_registration</a> *reginfo,
00382                                 netsnmp_table_data_set *data_set,
00383                                 <a class="code" href=
"structnetsnmp__table__registration__info__s.html">netsnmp_table_registration_info</a> *table_info)
00384 {
00385     <span class="keywordflow">if</span> (NULL == table_info) {
00386         <span class="comment">/*</span>
00387 <span class="comment">         * allocate the table if one wasn't allocated </span>
00388 <span class="comment">         */</span>
00389         table_info = <a class="code" href="group__util.html#ga39">SNMP_MALLOC_TYPEDEF</a>(<a class="code" href=
"structnetsnmp__table__registration__info__s.html">netsnmp_table_registration_info</a>);
00390     }
00391 
00392     <span class="keywordflow">if</span> (NULL == table_info-&gt;<a class="code" href=
"structnetsnmp__table__registration__info__s.html#o0">indexes</a> &amp;&amp; data_set-&gt;table-&gt;indexes_template) {
00393         <span class="comment">/*</span>
00394 <span class="comment">         * copy the indexes in </span>
00395 <span class="comment">         */</span>
00396         table_info-&gt;<a class="code" href="structnetsnmp__table__registration__info__s.html#o0">indexes</a> =
00397             snmp_clone_varbind(data_set-&gt;table-&gt;indexes_template);
00398     }
00399 
00400     <span class="keywordflow">if</span> ((!table_info-&gt;<a class="code" href=
"structnetsnmp__table__registration__info__s.html#o2">min_column</a> || !table_info-&gt;<a class="code" href=
"structnetsnmp__table__registration__info__s.html#o3">max_column</a>) &amp;&amp;
00401         (data_set-&gt;default_row)) {
00402         <span class="comment">/*</span>
00403 <span class="comment">         * determine min/max columns </span>
00404 <span class="comment">         */</span>
00405         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>    mincol = 0xffffffff, maxcol = 0;
00406         netsnmp_table_data_set_storage *row;
00407 
00408         <span class="keywordflow">for</span> (row = data_set-&gt;default_row; row; row = row-&gt;next) {
00409             mincol = <a class="code" href="group__util.html#ga46">SNMP_MIN</a>(mincol, row-&gt;column);
00410             maxcol = <a class="code" href="group__util.html#ga45">SNMP_MAX</a>(maxcol, row-&gt;column);
00411         }
00412         <span class="keywordflow">if</span> (!table_info-&gt;<a class="code" href=
"structnetsnmp__table__registration__info__s.html#o2">min_column</a>)
00413             table_info-&gt;<a class="code" href=
"structnetsnmp__table__registration__info__s.html#o2">min_column</a> = mincol;
00414         <span class="keywordflow">if</span> (!table_info-&gt;<a class="code" href=
"structnetsnmp__table__registration__info__s.html#o3">max_column</a>)
00415             table_info-&gt;<a class="code" href=
"structnetsnmp__table__registration__info__s.html#o3">max_column</a> = maxcol;
00416     }
00417 
00418     <a class="code" href="group__handler.html#ga14">netsnmp_inject_handler</a>(reginfo,
00419                            <a class="code" href=
"group__table__dataset.html#ga13">netsnmp_get_table_data_set_handler</a>(data_set));
00420     <span class="keywordflow">return</span> <a class="code" href=
"group__table__data.html#ga15">netsnmp_register_table_data</a>(reginfo, data_set-&gt;table,
00421                                        table_info);
00422 }
00423 
00424 newrow_stash   *
00425 netsnmp_table_data_set_create_newrowstash
00426     (netsnmp_table_data_set     *datatable,
00427      <a class="code" href="structnetsnmp__table__request__info__s.html">netsnmp_table_request_info</a> *table_info)
00428 {
00429     newrow_stash   *newrowstash = NULL;
00430     netsnmp_table_row *newrow   = NULL;
00431 
00432     newrowstash = <a class="code" href="group__util.html#ga39">SNMP_MALLOC_TYPEDEF</a>(newrow_stash);
00433     newrowstash-&gt;created = 1;
00434     newrow = <a class="code" href="group__table__dataset.html#ga10">netsnmp_table_data_set_create_row_from_defaults</a>
00435                         (datatable-&gt;default_row);
00436     newrow-&gt;<a class="code" href=
"structnetsnmp__table__registration__info__s.html#o0">indexes</a> = snmp_clone_varbind(table_info-&gt;indexes);
00437     newrowstash-&gt;newrow = newrow;
00438 
00439     <span class="keywordflow">return</span> newrowstash;
00440 }
00441 
00442 <span class="comment">/* implements the table data helper.  This is the routine that takes</span>
00443 <span class="comment"> *  care of all SNMP requests coming into the table. */</span>
00444 <span class="keywordtype">int</span>
00445 netsnmp_table_data_set_helper_handler(<a class="code" href=
"structnetsnmp__mib__handler__s.html">netsnmp_mib_handler</a> *handler,
00446                                       <a class="code" href=
"structnetsnmp__handler__registration__s.html">netsnmp_handler_registration</a>
00447                                       *reginfo,
00448                                       <a class="code" href=
"structnetsnmp__agent__request__info__s.html">netsnmp_agent_request_info</a> *reqinfo,
00449                                       <a class="code" href=
"structnetsnmp__request__info__s.html">netsnmp_request_info</a> *requests)
00450 {
00451     netsnmp_table_data_set_storage *data = NULL;
00452     newrow_stash   *newrowstash = NULL;
00453     netsnmp_table_row *row, *newrow = NULL;
00454     <a class="code" href="structnetsnmp__table__request__info__s.html">netsnmp_table_request_info</a> *table_info;
00455     <a class="code" href="structnetsnmp__request__info__s.html">netsnmp_request_info</a> *request;
00456     oid            *suffix;
00457     size_t          suffix_len;
00458     netsnmp_oid_stash_node **stashp = NULL;
00459 
00460     <span class="keywordflow">if</span> (!handler)
00461         <span class="keywordflow">return</span> SNMPERR_GENERR;
00462         
00463     DEBUGMSGTL((<span class="stringliteral">"netsnmp_table_data_set"</span>, <span class=
"stringliteral">"handler starting\n"</span>));
00464     <span class="keywordflow">for</span> (request = requests; request; request = request-&gt;<a class="code" href=
"structnetsnmp__request__info__s.html#o13">next</a>) {
00465         netsnmp_table_data_set *datatable =
00466             (netsnmp_table_data_set *) handler-&gt;<a class="code" href=
"structnetsnmp__mib__handler__s.html#o1">myvoid</a>;
00467         <span class="keywordflow">if</span> (request-&gt;<a class="code" href=
"structnetsnmp__request__info__s.html#o6">processed</a>)
00468             <span class="keywordflow">continue</span>;
00469 
00470         <span class="comment">/*</span>
00471 <span class="comment">         * extract our stored data and table info </span>
00472 <span class="comment">         */</span>
00473         row = <a class="code" href="group__table__data.html#ga19">netsnmp_extract_table_row</a>(request);
00474         table_info = <a class="code" href="group__table.html#ga2">netsnmp_extract_table_info</a>(request);
00475         suffix = requests-&gt;<a class="code" href="structnetsnmp__request__info__s.html#o0">requestvb</a>-&gt;<a class=
"code" href="structvariable__list.html#o1">name</a> + reginfo-&gt;<a class="code" href=
"structnetsnmp__handler__registration__s.html#o3">rootoid_len</a> + 2;
00476         suffix_len = requests-&gt;<a class="code" href=
"structnetsnmp__request__info__s.html#o0">requestvb</a>-&gt;<a class="code" href="structvariable__list.html#o2">name_length</a> -
00477             (reginfo-&gt;<a class="code" href="structnetsnmp__handler__registration__s.html#o3">rootoid_len</a> + 2);
00478 
00479         <span class="keywordflow">if</span> (MODE_IS_SET(reqinfo-&gt;<a class="code" href=
"structnetsnmp__agent__request__info__s.html#o0">mode</a>)) {
00480 
00481             <span class="keywordtype">char</span> buf[256]; <span class="comment">/* is this reasonable size?? */</span>
00482             <span class="keywordtype">int</span>  rc;
00483             size_t len;
00484 
00485             <span class="comment">/*</span>
00486 <span class="comment">             * use a cached copy of the row for modification </span>
00487 <span class="comment">             */</span>
00488 
00489             <span class="comment">/*</span>
00490 <span class="comment">             * cache location: may have been created already by other</span>
00491 <span class="comment">             * SET requests in the same master request. </span>
00492 <span class="comment">             */</span>
00493             rc = snprintf(buf, <span class="keyword">sizeof</span>(buf), <span class=
"stringliteral">"dataset_row_stash:%s:"</span>,
00494                           datatable-&gt;table-&gt;name);
00495             <span class="keywordflow">if</span> ((-1 == rc) || (rc &gt;= <span class="keyword">sizeof</span>(buf))) {
00496                 <a class="code" href="group__snmp__logging.html#ga41">snmp_log</a>(LOG_ERR,<span class=
"stringliteral">"%s handler name too long\n"</span>,
00497                          datatable-&gt;table-&gt;name);
00498                 <a class="code" href="group__snmp__agent.html#ga83">netsnmp_set_request_error</a>(reqinfo, request,
00499                                           SNMP_ERR_GENERR);
00500                 <span class="keywordflow">continue</span>;
00501             }
00502             len = <span class="keyword">sizeof</span>(buf) - rc;
00503             rc = snprint_objid(&amp;buf[rc], len, table_info-&gt;<a class="code" href=
"structnetsnmp__table__request__info__s.html#o3">index_oid</a>,
00504                                table_info-&gt;<a class="code" href=
"structnetsnmp__table__request__info__s.html#o4">index_oid_len</a>);
00505             <span class="keywordflow">if</span> (-1 == rc) {
00506                 <a class="code" href="group__snmp__logging.html#ga41">snmp_log</a>(LOG_ERR,<span class=
"stringliteral">"%s oid or name too long\n"</span>,
00507                          datatable-&gt;table-&gt;name);
00508                 <a class="code" href="group__snmp__agent.html#ga83">netsnmp_set_request_error</a>(reqinfo, request,
00509                                           SNMP_ERR_GENERR);
00510                 <span class="keywordflow">continue</span>;
00511             }
00512             stashp = (netsnmp_oid_stash_node **)
00513                 netsnmp_table_get_or_create_row_stash(reqinfo, buf);
00514 
00515             newrowstash
00516                 = <a class="code" href=
"group__oid__stash.html#ga5">netsnmp_oid_stash_get_data</a>(*stashp, suffix, suffix_len);
00517 
00518             <span class="keywordflow">if</span> (!newrowstash) {
00519                 <span class="keywordflow">if</span> (!row) {
00520                     <span class="keywordflow">if</span> (datatable-&gt;allow_creation) {
00521                         <span class="comment">/*</span>
00522 <span class="comment">                         * entirely new row.  Create the row from the template </span>
00523 <span class="comment">                         */</span>
00524                         newrowstash =
00525                              netsnmp_table_data_set_create_newrowstash(
00526                                                  datatable, table_info);
00527                         newrow = newrowstash-&gt;newrow;
00528                     } <span class="keywordflow">else</span> <span class=
"keywordflow">if</span> (datatable-&gt;rowstatus_column == 0) {
00529                         <span class="comment">/*</span>
00530 <span class="comment">                         * A RowStatus object may be used to control the</span>
00531 <span class="comment">                         *  creation of a new row.  But if this object</span>
00532 <span class="comment">                         *  isn't declared (and the table isn't marked as</span>
00533 <span class="comment">                         *  'auto-create'), then we can't create a new row.</span>
00534 <span class="comment">                         */</span>
00535                         <a class="code" href="group__snmp__agent.html#ga83">netsnmp_set_request_error</a>(reqinfo, request,
00536                                                   SNMP_ERR_NOCREATION);
00537                         <span class="keywordflow">continue</span>;
00538                     }
00539                 } <span class="keywordflow">else</span> {
00540                     <span class="comment">/*</span>
00541 <span class="comment">                     * existing row that needs to be modified </span>
00542 <span class="comment">                     */</span>
00543                     newrowstash = <a class="code" href="group__util.html#ga39">SNMP_MALLOC_TYPEDEF</a>(newrow_stash);
00544                     newrow = <a class="code" href=
"group__table__dataset.html#ga2">netsnmp_table_data_set_clone_row</a>(row);
00545                     newrowstash-&gt;newrow = newrow;
00546                 }
00547                 <a class="code" href=
"group__oid__stash.html#ga2">netsnmp_oid_stash_add_data</a>(stashp, suffix, suffix_len,
00548                                            newrowstash);
00549             } <span class="keywordflow">else</span> {
00550                 newrow = newrowstash-&gt;newrow;
00551             }
00552             <span class="comment">/*</span>
00553 <span class="comment">             * all future SET data modification operations use this</span>
00554 <span class="comment">             * temp pointer </span>
00555 <span class="comment">             */</span>
00556             <span class="keywordflow">if</span> (reqinfo-&gt;<a class="code" href=
"structnetsnmp__agent__request__info__s.html#o0">mode</a> == MODE_SET_RESERVE1 ||
00557                 reqinfo-&gt;<a class="code" href=
"structnetsnmp__agent__request__info__s.html#o0">mode</a> == MODE_SET_RESERVE2)
00558                 row = newrow;
00559         }
00560 
00561         <span class="keywordflow">if</span> (row)
00562             data = (netsnmp_table_data_set_storage *) row-&gt;<a class="code" href="structvariable__list.html#o8">data</a>;
00563 
00564         <span class="keywordflow">if</span> (!row || !table_info || !data) {
00565             <span class="keywordflow">if</span> (!MODE_IS_SET(reqinfo-&gt;<a class="code" href=
"structnetsnmp__agent__request__info__s.html#o0">mode</a>)) {
00566                 <a class="code" href="group__snmp__agent.html#ga83">netsnmp_set_request_error</a>(reqinfo, request,
00567                                           SNMP_NOSUCHINSTANCE);
00568                 <span class="keywordflow">continue</span>;
00569             }
00570         }
00571 
00572         data =
00573             <a class="code" href=
"group__table__dataset.html#ga26">netsnmp_table_data_set_find_column</a>(data, table_info-&gt;<a class="code" href=
"structnetsnmp__table__request__info__s.html#o0">colnum</a>);
00574 
00575         <span class="keywordflow">switch</span> (reqinfo-&gt;<a class="code" href=
"structnetsnmp__agent__request__info__s.html#o0">mode</a>) {
00576         <span class="keywordflow">case</span> MODE_GET:
00577         <span class="keywordflow">case</span> MODE_GETNEXT:
00578         <span class="keywordflow">case</span> MODE_GETBULK:     <span class="comment">/* XXXWWW */</span>
00579             <span class="keywordflow">if</span> (data &amp;&amp; data-&gt;data.voidp)
00580                 netsnmp_table_data_build_result(reginfo, reqinfo, request,
00581                                                 row,
00582                                                 table_info-&gt;<a class="code" href=
"structnetsnmp__table__request__info__s.html#o0">colnum</a>,
00583                                                 data-&gt;type,
00584                                                 data-&gt;data.voidp,
00585                                                 data-&gt;data_len);
00586             <span class="keywordflow">break</span>;
00587 
00588         <span class="keywordflow">case</span> MODE_SET_RESERVE1:
00589             <span class="keywordflow">if</span> (data) {
00590                 <span class="comment">/*</span>
00591 <span class="comment">                 * Can we modify the existing row?</span>
00592 <span class="comment">                 */</span>
00593                 <span class="keywordflow">if</span> (!data-&gt;writable) {
00594                     <a class="code" href="group__snmp__agent.html#ga83">netsnmp_set_request_error</a>(reqinfo, request,
00595                                               SNMP_ERR_NOTWRITABLE);
00596                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (request-&gt;<a class="code"
href="structnetsnmp__request__info__s.html#o0">requestvb</a>-&gt;<a class="code" href=
"structvariable__list.html#o3">type</a> != data-&gt;<a class="code" href="structvariable__list.html#o3">type</a>) {
00597                     <a class="code" href="group__snmp__agent.html#ga83">netsnmp_set_request_error</a>(reqinfo, request,
00598                                               SNMP_ERR_WRONGTYPE);
00599                 }
00600             } <span class="keywordflow">else</span> <span class=
"keywordflow">if</span> (datatable-&gt;rowstatus_column == table_info-&gt;<a class="code" href=
"structnetsnmp__table__request__info__s.html#o0">colnum</a>) {
00601                 <span class="comment">/*</span>
00602 <span class="comment">                 * Otherwise, this is where we create a new row using</span>
00603 <span class="comment">                 * the RowStatus object (essentially duplicating the</span>
00604 <span class="comment">                 * steps followed earlier in the 'allow_creation' case)</span>
00605 <span class="comment">                 */</span>
00606                 <span class="keywordflow">switch</span> (*(request-&gt;<a class="code" href=
"structnetsnmp__request__info__s.html#o0">requestvb</a>-&gt;<a class="code" href=
"structvariable__list.html#o4">val</a>.integer)) {
00607                 <span class="keywordflow">case</span> RS_CREATEANDGO:
00608                 <span class="keywordflow">case</span> RS_CREATEANDWAIT:
00609                     newrowstash =
00610                              netsnmp_table_data_set_create_newrowstash(
00611                                                  datatable, table_info);
00612                     newrow = newrowstash-&gt;newrow;
00613                     row    = newrow;
00614                     <a class="code" href=
"group__oid__stash.html#ga2">netsnmp_oid_stash_add_data</a>(stashp, suffix, suffix_len,
00615                                                newrowstash);
00616                 }
00617             }
00618             <span class="keywordflow">break</span>;
00619 
00620         <span class="keywordflow">case</span> MODE_SET_RESERVE2:
00621             <span class="comment">/*</span>
00622 <span class="comment">             * If the agent receives a SET request for an object in a non-existant</span>
00623 <span class="comment">             *  row, then the RESERVE1 pass will create the row automatically.</span>
00624 <span class="comment">             *</span>
00625 <span class="comment">             * But since the row doesn't exist at that point, the test for whether</span>
00626 <span class="comment">             *  the object is writable or not will be skipped.  So we need to check</span>
00627 <span class="comment">             *  for this possibility again here.</span>
00628 <span class="comment">             *</span>
00629 <span class="comment">             * Similarly, if row creation is under the control of the RowStatus</span>
00630 <span class="comment">             *  object (i.e. allow_creation == 0), but this particular request</span>
00631 <span class="comment">             *  doesn't include such an object, then the row won't have been created,</span>
00632 <span class="comment">             *  and the writable check will also have been skipped.  Again - check here.</span>
00633 <span class="comment">             */</span>
00634             <span class="keywordflow">if</span> (data &amp;&amp; data-&gt;writable == 0) {
00635                 <a class="code" href="group__snmp__agent.html#ga83">netsnmp_set_request_error</a>(reqinfo, request,
00636                                           SNMP_ERR_NOTWRITABLE);
00637                 <span class="keywordflow">continue</span>;
00638             }
00639             <span class="keywordflow">if</span> (datatable-&gt;rowstatus_column == table_info-&gt;<a class="code" href=
"structnetsnmp__table__request__info__s.html#o0">colnum</a>) {
00640                 <span class="keywordflow">switch</span> (*(request-&gt;<a class="code" href=
"structnetsnmp__request__info__s.html#o0">requestvb</a>-&gt;<a class="code" href=
"structvariable__list.html#o4">val</a>.integer)) {
00641                 <span class="keywordflow">case</span> RS_ACTIVE:
00642                 <span class="keywordflow">case</span> RS_NOTINSERVICE:
00643                     <span class="comment">/*</span>
00644 <span class="comment">                     * Can only operate on pre-existing rows.</span>
00645 <span class="comment">                     */</span>
00646                     <span class="keywordflow">if</span> (!newrowstash || newrowstash-&gt;created) {
00647                         <a class="code" href="group__snmp__agent.html#ga83">netsnmp_set_request_error</a>(reqinfo, request,
00648                                                   SNMP_ERR_INCONSISTENTVALUE);
00649                         <span class="keywordflow">continue</span>;
00650                     }
00651                     <span class="keywordflow">break</span>;
00652 
00653                 <span class="keywordflow">case</span> RS_CREATEANDGO:
00654                 <span class="keywordflow">case</span> RS_CREATEANDWAIT:
00655                     <span class="comment">/*</span>
00656 <span class="comment">                     * Can only operate on newly created rows.</span>
00657 <span class="comment">                     */</span>
00658                     <span class="keywordflow">if</span> (!(newrowstash &amp;&amp; newrowstash-&gt;created)) {
00659                         <a class="code" href="group__snmp__agent.html#ga83">netsnmp_set_request_error</a>(reqinfo, request,
00660                                                   SNMP_ERR_INCONSISTENTVALUE);
00661                         <span class="keywordflow">continue</span>;
00662                     }
00663                     <span class="keywordflow">break</span>;
00664 
00665                 <span class="keywordflow">case</span> RS_DESTROY:
00666                     <span class="comment">/*</span>
00667 <span class="comment">                     * Can operate on new or pre-existing rows.</span>
00668 <span class="comment">                     */</span>
00669                     <span class="keywordflow">break</span>;
00670 
00671                 <span class="keywordflow">case</span> RS_NOTREADY:
00672                 <span class="keywordflow">default</span>:
00673                     <span class="comment">/*</span>
00674 <span class="comment">                     * Not a valid value to Set </span>
00675 <span class="comment">                     */</span>
00676                     <a class="code" href="group__snmp__agent.html#ga83">netsnmp_set_request_error</a>(reqinfo, request,
00677                                               SNMP_ERR_WRONGVALUE);
00678                     <span class="keywordflow">continue</span>;
00679                 }
00680             }
00681             <span class="keywordflow">if</span> (!data ) {
00682                 <a class="code" href="group__snmp__agent.html#ga83">netsnmp_set_request_error</a>(reqinfo, request,
00683                                           SNMP_ERR_NOCREATION);
00684                 <span class="keywordflow">continue</span>;
00685             }
00686 
00687             <span class="comment">/*</span>
00688 <span class="comment">             * modify row and set new value </span>
00689 <span class="comment">             */</span>
00690             <a class="code" href="group__util.html#ga36">SNMP_FREE</a>(data-&gt;data.string);
00691             data-&gt;<a class="code" href="structvariable__list.html#o8">data</a>.string =
00692                 <a class="code" href="group__util.html#ga12">netsnmp_strdup_and_null</a>(request-&gt;<a class="code" href=
"structnetsnmp__request__info__s.html#o0">requestvb</a>-&gt;<a class="code" href="structvariable__list.html#o4">val</a>.string,
00693                                         request-&gt;<a class="code" href=
"structnetsnmp__request__info__s.html#o0">requestvb</a>-&gt;<a class="code" href="structvariable__list.html#o5">val_len</a>);
00694             <span class="keywordflow">if</span> (!data-&gt;data.string) {
00695                 <a class="code" href="group__snmp__agent.html#ga83">netsnmp_set_request_error</a>(reqinfo, requests,
00696                                           SNMP_ERR_RESOURCEUNAVAILABLE);
00697             }
00698             data-&gt;data_len = request-&gt;<a class="code" href=
"structnetsnmp__request__info__s.html#o0">requestvb</a>-&gt;<a class="code" href="structvariable__list.html#o5">val_len</a>;
00699 
00700             <span class="keywordflow">if</span> (datatable-&gt;rowstatus_column == table_info-&gt;<a class="code" href=
"structnetsnmp__table__request__info__s.html#o0">colnum</a>) {
00701                 <span class="keywordflow">switch</span> (*(request-&gt;<a class="code" href=
"structnetsnmp__request__info__s.html#o0">requestvb</a>-&gt;<a class="code" href=
"structvariable__list.html#o4">val</a>.integer)) {
00702                 <span class="keywordflow">case</span> RS_CREATEANDGO:
00703                     <span class="comment">/*</span>
00704 <span class="comment">                     * XXX: check legality </span>
00705 <span class="comment">                     */</span>
00706                     *(data-&gt;data.integer) = RS_ACTIVE;
00707                     <span class="keywordflow">break</span>;
00708 
00709                 <span class="keywordflow">case</span> RS_CREATEANDWAIT:
00710                     <span class="comment">/*</span>
00711 <span class="comment">                     * XXX: check legality </span>
00712 <span class="comment">                     */</span>
00713                     *(data-&gt;data.integer) = RS_NOTINSERVICE;
00714                     <span class="keywordflow">break</span>;
00715 
00716                 <span class="keywordflow">case</span> RS_DESTROY:
00717                     newrowstash-&gt;deleted = 1;
00718                     <span class="keywordflow">break</span>;
00719                 }
00720             }
00721             <span class="keywordflow">break</span>;
00722 
00723         <span class="keywordflow">case</span> MODE_SET_ACTION:
00724 
00725             <span class="comment">/*</span>
00726 <span class="comment">             * Install the new row into the stored table.</span>
00727 <span class="comment">             * Do this only *once* per row ....</span>
00728 <span class="comment">             */</span>
00729             <span class="keywordflow">if</span> (newrowstash-&gt;state != STATE_ACTION) {
00730                 newrowstash-&gt;state = STATE_ACTION;
00731                 <span class="keywordflow">if</span> (newrowstash-&gt;created) {
00732                     <a class="code" href=
"group__table__dataset.html#ga6">netsnmp_table_dataset_add_row</a>(datatable, newrow);
00733                 } <span class="keywordflow">else</span> {
00734                     <a class="code" href="group__table__dataset.html#ga7">netsnmp_table_dataset_replace_row</a>(datatable,
00735                                                       row, newrow);
00736                 }
00737             }
00738             <span class="comment">/*</span>
00739 <span class="comment">             * ... but every (relevant) varbind in the request will</span>
00740 <span class="comment">             * need to know about this new row, so update the</span>
00741 <span class="comment">             * per-request row information regardless</span>
00742 <span class="comment">             */</span>
00743             <span class="keywordflow">if</span> (newrowstash-&gt;created) {
00744                 <a class="code" href="group__handler.html#ga27">netsnmp_request_add_list_data</a>(request,
00745                         <a class="code" href="group__data__list.html#ga3">netsnmp_create_data_list</a>(TABLE_DATA_NAME,
00746                                                  newrow, NULL));
00747             }
00748             <span class="keywordflow">break</span>;
00749 
00750         <span class="keywordflow">case</span> MODE_SET_UNDO:
00751             <span class="comment">/*</span>
00752 <span class="comment">             * extract the new row, replace with the old or delete </span>
00753 <span class="comment">             */</span>
00754             <span class="keywordflow">if</span> (newrowstash-&gt;state != STATE_UNDO) {
00755                 newrowstash-&gt;state = STATE_UNDO;
00756                 <span class="keywordflow">if</span> (newrowstash-&gt;created) {
00757                     <a class="code" href=
"group__table__dataset.html#ga9">netsnmp_table_dataset_remove_and_delete_row</a>(datatable, newrow);
00758                 } <span class="keywordflow">else</span> {
00759                     <a class="code" href="group__table__dataset.html#ga7">netsnmp_table_dataset_replace_row</a>(datatable,
00760                                                       newrow, row);
00761                     <a class="code" href="group__table__dataset.html#ga5">netsnmp_table_dataset_delete_row</a>(newrow);
00762                 }
00763             }
00764             <span class="keywordflow">break</span>;
00765 
00766         <span class="keywordflow">case</span> MODE_SET_COMMIT:
00767             <span class="keywordflow">if</span> (newrowstash-&gt;state != STATE_COMMIT) {
00768                 newrowstash-&gt;state = STATE_COMMIT;
00769                 <span class="keywordflow">if</span> (!newrowstash-&gt;created) {
00770                     <a class="code" href="group__table__dataset.html#ga5">netsnmp_table_dataset_delete_row</a>(row);
00771                 }
00772                 <span class="keywordflow">if</span> (newrowstash-&gt;deleted) {
00773                     <a class="code" href=
"group__table__dataset.html#ga9">netsnmp_table_dataset_remove_and_delete_row</a>(datatable, newrow);
00774                 }
00775             }
00776             <span class="keywordflow">break</span>;
00777 
00778         <span class="keywordflow">case</span> MODE_SET_FREE:
00779             <span class="keywordflow">if</span> (newrowstash &amp;&amp; newrowstash-&gt;state != STATE_FREE) {
00780                 newrowstash-&gt;state = STATE_FREE;
00781                 <a class="code" href="group__table__dataset.html#ga5">netsnmp_table_dataset_delete_row</a>(newrow);
00782             }
00783             <span class="keywordflow">break</span>;
00784         }
00785     }
00786 
00787     <span class="comment">/* next handler called automatically - 'AUTO_NEXT' */</span>
00788     <span class="keywordflow">return</span> SNMP_ERR_NOERROR;
00789 }
00790 
00794 NETSNMP_INLINE netsnmp_table_data_set *
<a name="l00795" id="l00795"></a><a class="code" href="group__table__dataset.html#ga17">00795</a> <a class="code" href=
"group__table__dataset.html#ga17">netsnmp_extract_table_data_set</a>(<a class="code" href=
"structnetsnmp__request__info__s.html">netsnmp_request_info</a> *request)
00796 {
00797     <span class="keywordflow">return</span> (netsnmp_table_data_set *)
00798         <a class="code" href="group__handler.html#ga29">netsnmp_request_get_list_data</a>(request, TABLE_DATA_SET_NAME);
00799 }
00800 
00804 netsnmp_table_data_set_storage *
<a name="l00805" id="l00805"></a><a class="code" href="group__table__dataset.html#ga18">00805</a> <a class="code" href=
"group__table__dataset.html#ga18">netsnmp_extract_table_data_set_column</a>(<a class="code" href=
"structnetsnmp__request__info__s.html">netsnmp_request_info</a> *request,
00806                                      <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> column)
00807 {
00808     netsnmp_table_data_set_storage *data =
00809         <a class="code" href="group__table__data.html#ga20">netsnmp_extract_table_row_data</a>( request );
00810     <span class="keywordflow">if</span> (data) {
00811         data = <a class="code" href="group__table__dataset.html#ga26">netsnmp_table_data_set_find_column</a>(data, column);
00812     }
00813     <span class="keywordflow">return</span> data;
00814 }
00815 
00816 
00817 <span class="comment">/* ==================================</span>
00818 <span class="comment"> *</span>
00819 <span class="comment"> * Data Set API: Config-based operation</span>
00820 <span class="comment"> *</span>
00821 <span class="comment"> * ================================== */</span>
00822 
00831 <span class="keywordtype">void</span>
<a name="l00832" id="l00832"></a><a class="code" href="group__table__dataset.html#ga19">00832</a> <a class="code" href=
"group__table__dataset.html#ga19">netsnmp_register_auto_data_table</a>(netsnmp_table_data_set *table_set,
00833                                  <span class="keywordtype">char</span> *registration_name)
00834 {
00835     data_set_tables *tables;
00836     tables = <a class="code" href="group__util.html#ga39">SNMP_MALLOC_TYPEDEF</a>(data_set_tables);
00837     <span class="keywordflow">if</span> (!tables)
00838         <span class="keywordflow">return</span>;
00839     tables-&gt;table_set = table_set;
00840     <span class="keywordflow">if</span> (!registration_name) {
00841         registration_name = table_set-&gt;table-&gt;<a class="code" href="structvariable__list.html#o1">name</a>;
00842     }
00843     <a class="code" href="group__data__list.html#ga4">netsnmp_add_list_data</a>(&amp;auto_tables, <a class="code" href=
"group__data__list.html#ga3">netsnmp_create_data_list</a>(registration_name, tables, NULL));     <span class=
"comment">/* XXX */</span>
00844 }
00845 
00846 <span class="preprocessor">#ifndef DISABLE_MIB_LOADING</span>
00847 <span class="keyword">static</span> <span class="keywordtype">void</span>
00848 _table_set_add_indexes(netsnmp_table_data_set *table_set, <span class="keyword">struct</span> tree *tp)
00849 {
00850     oid             name[MAX_OID_LEN];
00851     size_t          name_length = MAX_OID_LEN;
00852     <span class="keyword">struct </span>index_list *index;
00853     <span class="keyword">struct </span>tree     *indexnode;
00854     u_char          type;
00855     
00856     <span class="comment">/*</span>
00857 <span class="comment">     * loop through indexes and add types </span>
00858 <span class="comment">     */</span>
00859     <span class="keywordflow">for</span> (index = tp-&gt;indexes; index; index = index-&gt;next) {
00860         <span class="keywordflow">if</span> (!<a class="code" href=
"group__mib__utilities.html#ga107">snmp_parse_oid</a>(index-&gt;ilabel, name, &amp;name_length) ||
00861             (NULL ==
00862              (indexnode = <a class="code" href="group__mib__utilities.html#ga84">get_tree</a>(name, name_length, <a class=
"code" href="group__mib__utilities.html#ga46">get_tree_head</a>())))) {
00863             config_pwarn(<span class="stringliteral">"can't instatiate table since "</span>
00864                          <span class="stringliteral">"I don't know anything about one index"</span>);
00865             <a class="code" href="group__snmp__logging.html#ga41">snmp_log</a>(LOG_WARNING, <span class=
"stringliteral">"  index %s not found in tree\n"</span>,
00866                      index-&gt;ilabel);
00867             <span class="keywordflow">return</span>;             <span class="comment">/* xxx mem leak */</span>
00868         }
00869             
00870         type = mib_to_asn_type(indexnode-&gt;type);
00871         <span class="keywordflow">if</span> (type == (u_char) - 1) {
00872             config_pwarn(<span class="stringliteral">"unknown index type"</span>);
00873             <span class="keywordflow">return</span>;             <span class="comment">/* xxx mem leak */</span>
00874         }
00875         <span class="comment">/*</span>
00876 <span class="comment">         * if implied, mark it as such. also mark fixed length</span>
00877 <span class="comment">         * octet strings as implied (ie no length prefix) as well.</span>
00878 <span class="comment">         * */</span>
00879         <span class="keywordflow">if</span> ((index-&gt;isimplied) ||
00880             ((TYPE_OCTETSTR == indexnode-&gt;type) &amp;&amp;  <span class="comment">/* octet str */</span>
00881              (NULL != indexnode-&gt;ranges) &amp;&amp;         <span class="comment">/* &amp; has range */</span>
00882              (NULL == indexnode-&gt;ranges-&gt;next) &amp;&amp;   <span class="comment">/*   but only one */</span>
00883              (indexnode-&gt;ranges-&gt;high ==            <span class="comment">/*   &amp; high==low */</span>
00884               indexnode-&gt;ranges-&gt;low)))
00885             type |= ASN_PRIVATE;
00886         
00887         DEBUGMSGTL((<span class="stringliteral">"table_set_add_table"</span>,
00888                     <span class="stringliteral">"adding default index of type %d\n"</span>, type));
00889         <a class="code" href="group__table__dataset.html#ga29">netsnmp_table_dataset_add_index</a>(table_set, type);
00890     }
00891 }
00893 <span class="keywordtype">void</span>
00894 netsnmp_config_parse_table_set(<span class="keyword">const</span> <span class=
"keywordtype">char</span> *token, <span class="keywordtype">char</span> *line)
00895 {
00896     oid             table_name[MAX_OID_LEN];
00897     size_t          table_name_length = MAX_OID_LEN;
00898     <span class="keyword">struct </span>tree    *tp;
00899     netsnmp_table_data_set *table_set;
00900     data_set_tables *tables;
00901     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>    mincol = 0xffffff, maxcol = 0;
00902     <span class="keywordtype">char</span>           *pos;
00903 
00904     <span class="comment">/*</span>
00905 <span class="comment">     * instatiate a fake table based on MIB information </span>
00906 <span class="comment">     */</span>
00907     DEBUGMSGTL((<span class="stringliteral">"9:table_set_add_table"</span>, <span class=
"stringliteral">"processing '%s'\n"</span>, line));
00908     <span class="keywordflow">if</span> (NULL != (pos = strchr(line,<span class="charliteral">' '</span>))) {
00909         config_pwarn(<span class="stringliteral">"ignoring extra tokens on line"</span>);
00910         <a class="code" href="group__snmp__logging.html#ga41">snmp_log</a>(LOG_WARNING,<span class=
"stringliteral">"  ignoring '%s'\n"</span>, pos);
00911         *pos = <span class="charliteral">'\0'</span>;
00912     }
00913 
00914     <span class="comment">/*</span>
00915 <span class="comment">     * check for duplicate table</span>
00916 <span class="comment">     */</span>
00917     tables = (data_set_tables *) <a class="code" href=
"group__data__list.html#ga7">netsnmp_get_list_data</a>(auto_tables, line);
00918     <span class="keywordflow">if</span> (NULL != tables) {
00919         config_pwarn(<span class="stringliteral">"duplicate table definition"</span>);
00920         <span class="keywordflow">return</span>;
00921     }
00922 
00923     <span class="comment">/*</span>
00924 <span class="comment">     * parse oid and find tree structure</span>
00925 <span class="comment">     */</span>
00926     <span class="keywordflow">if</span> (!<a class="code" href=
"group__mib__utilities.html#ga107">snmp_parse_oid</a>(line, table_name, &amp;table_name_length)) {
00927         config_pwarn
00928             (<span class="stringliteral">"can't instatiate table since I can't parse the table name"</span>);
00929         <span class="keywordflow">return</span>;
00930     }
00931     <span class="keywordflow">if</span>(NULL == (tp = <a class="code" href=
"group__mib__utilities.html#ga84">get_tree</a>(table_name, table_name_length,
00932                               <a class="code" href="group__mib__utilities.html#ga46">get_tree_head</a>()))) {
00933         config_pwarn(<span class="stringliteral">"can't instatiate table since "</span>
00934                      <span class="stringliteral">"I can't find mib information about it"</span>);
00935         <span class="keywordflow">return</span>;
00936     }
00937 
00938     <span class="keywordflow">if</span> (NULL == (tp = tp-&gt;child_list) || NULL == tp-&gt;child_list) {
00939         config_pwarn(<span class="stringliteral">"can't instatiate table since it doesn't appear to be "</span>
00940                      <span class="stringliteral">"a proper table (no children)"</span>);
00941         <span class="keywordflow">return</span>;
00942     }
00943 
00944     table_set = <a class="code" href="group__table__dataset.html#ga1">netsnmp_create_table_data_set</a>(line);
00945 
00946     <span class="comment">/*</span>
00947 <span class="comment">     * check for augments indexes</span>
00948 <span class="comment">     */</span>
00949     <span class="keywordflow">if</span> (NULL != tp-&gt;augments) {
00950         oid             name[MAX_OID_LEN];
00951         size_t          name_length = MAX_OID_LEN;
00952         <span class="keyword">struct </span>tree    *tp2;
00953     
00954         <span class="keywordflow">if</span> (!<a class="code" href=
"group__mib__utilities.html#ga107">snmp_parse_oid</a>(tp-&gt;augments, name, &amp;name_length)) {
00955             config_pwarn(<span class="stringliteral">"I can't parse the augment tabel name"</span>);
00956             <a class="code" href="group__snmp__logging.html#ga41">snmp_log</a>(LOG_WARNING, <span class=
"stringliteral">"  can't parse %s\n"</span>, tp-&gt;augments);
00957             <span class="keywordflow">return</span>;
00958         }
00959         <span class="keywordflow">if</span>(NULL == (tp2 = <a class="code" href=
"group__mib__utilities.html#ga84">get_tree</a>(name, name_length, <a class="code" href=
"group__mib__utilities.html#ga46">get_tree_head</a>()))) {
00960             config_pwarn(<span class="stringliteral">"can't instatiate table since "</span>
00961                          <span class="stringliteral">"I can't find mib information about augment table"</span>);
00962             <a class="code" href="group__snmp__logging.html#ga41">snmp_log</a>(LOG_WARNING, <span class=
"stringliteral">"  table %s not found in tree\n"</span>,
00963                      tp-&gt;augments);
00964             <span class="keywordflow">return</span>;
00965         }
00966         _table_set_add_indexes(table_set, tp2);
00967     }
00968 
00969     _table_set_add_indexes(table_set, tp);
00970     
00971     <span class="comment">/*</span>
00972 <span class="comment">     * loop through children and add each column info </span>
00973 <span class="comment">     */</span>
00974     <span class="keywordflow">for</span> (tp = tp-&gt;child_list; tp; tp = tp-&gt;next_peer) {
00975         <span class="keywordtype">int</span>             canwrite = 0;
00976         u_char          type;
00977         type = mib_to_asn_type(tp-&gt;type);
00978         <span class="keywordflow">if</span> (type == (u_char) - 1) {
00979             config_pwarn(<span class="stringliteral">"unknown column type"</span>);
00980             <span class="keywordflow">return</span>;             <span class="comment">/* xxx mem leak */</span>
00981         }
00982 
00983         DEBUGMSGTL((<span class="stringliteral">"table_set_add_table"</span>,
00984                     <span class="stringliteral">"adding column %s(%d) of type %d (access %d)\n"</span>,
00985                     tp-&gt;label, tp-&gt;subid, type, tp-&gt;access));
00986 
00987         <span class="keywordflow">switch</span> (tp-&gt;access) {
00988         <span class="keywordflow">case</span> MIB_ACCESS_CREATE:
00989             table_set-&gt;allow_creation = 1;
00990         <span class="keywordflow">case</span> MIB_ACCESS_READWRITE:
00991         <span class="keywordflow">case</span> MIB_ACCESS_WRITEONLY:
00992             canwrite = 1;
00993         <span class="keywordflow">case</span> MIB_ACCESS_READONLY:
00994             DEBUGMSGTL((<span class="stringliteral">"table_set_add_table"</span>,
00995                         <span class="stringliteral">"adding column %d of type %d\n"</span>, tp-&gt;subid, type));
00996             <a class="code" href=
"group__table__dataset.html#ga11">netsnmp_table_set_add_default_row</a>(table_set, tp-&gt;subid, type,
00997                                               canwrite, NULL, 0);
00998             mincol = <a class="code" href="group__util.html#ga46">SNMP_MIN</a>(mincol, tp-&gt;subid);
00999             maxcol = <a class="code" href="group__util.html#ga45">SNMP_MAX</a>(maxcol, tp-&gt;subid);
01000             <span class="keywordflow">break</span>;
01001 
01002         <span class="keywordflow">case</span> MIB_ACCESS_NOACCESS:
01003         <span class="keywordflow">case</span> MIB_ACCESS_NOTIFY:
01004             <span class="keywordflow">break</span>;
01005 
01006         <span class="keywordflow">default</span>:
01007             config_pwarn(<span class="stringliteral">"unknown column access type"</span>);
01008             <span class="keywordflow">break</span>;
01009         }
01010     }
01011 
01012     <span class="comment">/*</span>
01013 <span class="comment">     * register the table </span>
01014 <span class="comment">     */</span>
01015     <a class="code" href=
"group__table__dataset.html#ga14">netsnmp_register_table_data_set</a>(netsnmp_create_handler_registration
01016                                     (line, NULL, table_name,
01017                                      table_name_length,
01018                                      HANDLER_CAN_RWRITE), table_set, NULL);
01019 
01020     <a class="code" href="group__table__dataset.html#ga19">netsnmp_register_auto_data_table</a>(table_set, NULL);
01021 }
01022 <span class="preprocessor">#endif </span><span class="comment">/* DISABLE_MIB_LOADING */</span>
01023 
01025 <span class="keywordtype">void</span>
01026 netsnmp_config_parse_add_row(<span class="keyword">const</span> <span class="keywordtype">char</span> *token, <span class=
"keywordtype">char</span> *line)
01027 {
01028     <span class="keywordtype">char</span>            buf[SNMP_MAXBUF_MEDIUM];
01029     <span class="keywordtype">char</span>            tname[SNMP_MAXBUF_MEDIUM];
01030     size_t          buf_size;
01031     <span class="keywordtype">int</span>             rc;
01032 
01033     data_set_tables *tables;
01034     <a class="code" href="structvariable__list.html">netsnmp_variable_list</a> *vb;  <span class=
"comment">/* containing only types */</span>
01035     netsnmp_table_row *row;
01036     netsnmp_table_data_set_storage *dr;
01037 
01038     line = copy_nword(line, tname, SNMP_MAXBUF_MEDIUM);
01039 
01040     tables = (data_set_tables *) <a class="code" href=
"group__data__list.html#ga7">netsnmp_get_list_data</a>(auto_tables, tname);
01041     <span class="keywordflow">if</span> (!tables) {
01042         config_pwarn(<span class="stringliteral">"Unknown table trying to add a row"</span>);
01043         <span class="keywordflow">return</span>;
01044     }
01045 
01046     <span class="comment">/*</span>
01047 <span class="comment">     * do the indexes first </span>
01048 <span class="comment">     */</span>
01049     row = <a class="code" href="group__table__data.html#ga2">netsnmp_create_table_data_row</a>();
01050 
01051     <span class="keywordflow">for</span> (vb = tables-&gt;table_set-&gt;table-&gt;indexes_template; vb;
01052          vb = vb-&gt;<a class="code" href="structvariable__list.html#o0">next_variable</a>) {
01053         <span class="keywordflow">if</span> (!line) {
01054             config_pwarn(<span class="stringliteral">"missing an index value"</span>);
01055             <span class="keywordflow">return</span>;
01056         }
01057 
01058         DEBUGMSGTL((<span class="stringliteral">"table_set_add_row"</span>, <span class=
"stringliteral">"adding index of type %d\n"</span>,
01059                     vb-&gt;<a class="code" href="structvariable__list.html#o3">type</a>));
01060         buf_size = SNMP_MAXBUF_MEDIUM;
01061         line = read_config_read_memory(vb-&gt;<a class="code" href=
"structvariable__list.html#o3">type</a>, line, buf, &amp;buf_size);
01062         netsnmp_table_row_add_index(row, vb-&gt;<a class="code" href=
"structvariable__list.html#o3">type</a>, buf, buf_size);
01063     }
01064 
01065     <span class="comment">/*</span>
01066 <span class="comment">     * then do the data </span>
01067 <span class="comment">     */</span>
01068     <span class="keywordflow">for</span> (dr = tables-&gt;table_set-&gt;default_row; dr; dr = dr-&gt;next) {
01069         <span class="keywordflow">if</span> (!line) {
01070             config_pwarn(<span class="stringliteral">"missing a data value. "</span>
01071                          <span class="stringliteral">"All columns must be specified."</span>);
01072             <a class="code" href="group__snmp__logging.html#ga41">snmp_log</a>(LOG_WARNING,<span class=
"stringliteral">"  can't find value for column %d\n"</span>,
01073                      dr-&gt;column - 1);
01074             <span class="keywordflow">return</span>;
01075         }
01076 
01077         buf_size = SNMP_MAXBUF_MEDIUM;
01078         line = read_config_read_memory(dr-&gt;type, line, buf, &amp;buf_size);
01079         DEBUGMSGTL((<span class="stringliteral">"table_set_add_row"</span>,
01080                     <span class="stringliteral">"adding data at column %d of type %d\n"</span>, dr-&gt;column,
01081                     dr-&gt;type));
01082         <a class="code" href=
"group__table__dataset.html#ga28">netsnmp_set_row_column</a>(row, dr-&gt;column, dr-&gt;type, buf, buf_size);
01083         <span class="keywordflow">if</span> (dr-&gt;writable)
01084             <a class="code" href=
"group__table__dataset.html#ga27">netsnmp_mark_row_column_writable</a>(row, dr-&gt;column, 1);       <span class=
"comment">/* make writable */</span>
01085     }
01086     rc = <a class="code" href=
"group__table__data.html#ga5">netsnmp_table_data_add_row</a>(tables-&gt;table_set-&gt;table, row);
01087     <span class="keywordflow">if</span> (SNMPERR_SUCCESS != rc) {
01088         config_pwarn(<span class="stringliteral">"error adding table row"</span>);
01089     }
01090     <span class="keywordflow">if</span> (NULL != line) {
01091         config_pwarn(<span class="stringliteral">"extra data value. Too many columns specified."</span>);
01092         <a class="code" href="group__snmp__logging.html#ga41">snmp_log</a>(LOG_WARNING,<span class=
"stringliteral">"  extra data '%s'\n"</span>, line);
01093     }
01094 }
01095 
01096 
01097 <span class="comment">/* ==================================</span>
01098 <span class="comment"> *</span>
01099 <span class="comment"> * Data Set API: Row operations</span>
01100 <span class="comment"> *</span>
01101 <span class="comment"> * ================================== */</span>
01102 
01104 netsnmp_table_row *
<a name="l01105" id="l01105"></a><a class="code" href="group__table__dataset.html#ga23">01105</a> <a class="code" href=
"group__table__dataset.html#ga23">netsnmp_table_data_set_get_first_row</a>(netsnmp_table_data_set *table)
01106 {
01107     <span class="keywordflow">return</span> <a class="code" href=
"group__table__data.html#ga23">netsnmp_table_data_get_first_row</a>(table-&gt;table);
01108 }
01109 
01111 netsnmp_table_row *
<a name="l01112" id="l01112"></a><a class="code" href="group__table__dataset.html#ga24">01112</a> <a class="code" href=
"group__table__dataset.html#ga24">netsnmp_table_data_set_get_next_row</a>(netsnmp_table_data_set *table,
01113                                     netsnmp_table_row      *row)
01114 {
01115     <span class="keywordflow">return</span> <a class="code" href=
"group__table__data.html#ga24">netsnmp_table_data_get_next_row</a>(table-&gt;table, row);
01116 }
01117 
01118 <span class="keywordtype">int</span>
01119 netsnmp_table_set_num_rows(netsnmp_table_data_set *table)
01120 {
01121     <span class="keywordflow">if</span> (!table)
01122         <span class="keywordflow">return</span> 0;
01123     <span class="keywordflow">return</span> netsnmp_table_data_num_rows(table-&gt;table);
01124 }
01125 
01126 <span class="comment">/* ==================================</span>
01127 <span class="comment"> *</span>
01128 <span class="comment"> * Data Set API: Column operations</span>
01129 <span class="comment"> *</span>
01130 <span class="comment"> * ================================== */</span>
01131 
01135 netsnmp_table_data_set_storage *
<a name="l01136" id="l01136"></a><a class="code" href="group__table__dataset.html#ga26">01136</a> <a class="code" href=
"group__table__dataset.html#ga26">netsnmp_table_data_set_find_column</a>(netsnmp_table_data_set_storage *start,
01137                                    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> column)
01138 {
01139     <span class="keywordflow">while</span> (start &amp;&amp; start-&gt;column != column)
01140         start = start-&gt;next;
01141     <span class="keywordflow">return</span> start;
01142 }
01143 
01147 <span class="keywordtype">int</span>
<a name="l01148" id="l01148"></a><a class="code" href="group__table__dataset.html#ga27">01148</a> <a class="code" href=
"group__table__dataset.html#ga27">netsnmp_mark_row_column_writable</a>(netsnmp_table_row *row, <span class=
"keywordtype">int</span> column,
01149                                  <span class="keywordtype">int</span> writable)
01150 {
01151     netsnmp_table_data_set_storage *data;
01152 
01153     <span class="keywordflow">if</span> (!row)
01154         <span class="keywordflow">return</span> SNMPERR_GENERR;
01155 
01156     data = (netsnmp_table_data_set_storage *) row-&gt;<a class="code" href="structvariable__list.html#o8">data</a>;
01157     data = <a class="code" href="group__table__dataset.html#ga26">netsnmp_table_data_set_find_column</a>(data, column);
01158 
01159     <span class="keywordflow">if</span> (!data) {
01160         <span class="comment">/*</span>
01161 <span class="comment">         * create it </span>
01162 <span class="comment">         */</span>
01163         data = <a class="code" href="group__util.html#ga39">SNMP_MALLOC_TYPEDEF</a>(netsnmp_table_data_set_storage);
01164         <span class="keywordflow">if</span> (!data) {
01165             <a class="code" href="group__snmp__logging.html#ga41">snmp_log</a>(LOG_CRIT, <span class=
"stringliteral">"no memory in netsnmp_set_row_column"</span>);
01166             <span class="keywordflow">return</span> SNMPERR_MALLOC;
01167         }
01168         data-&gt;column = column;
01169         data-&gt;writable = writable;
01170         data-&gt;next = row-&gt;<a class="code" href="structvariable__list.html#o8">data</a>;
01171         row-&gt;<a class="code" href="structvariable__list.html#o8">data</a> = data;
01172     } <span class="keywordflow">else</span> {
01173         data-&gt;writable = writable;
01174     }
01175     <span class="keywordflow">return</span> SNMPERR_SUCCESS;
01176 }
01177 
01182 <span class="keywordtype">int</span>
<a name="l01183" id="l01183"></a><a class="code" href="group__table__dataset.html#ga28">01183</a> <a class="code" href=
"group__table__dataset.html#ga28">netsnmp_set_row_column</a>(netsnmp_table_row *row, <span class=
"keywordtype">unsigned</span> <span class="keywordtype">int</span> column,
01184                        <span class="keywordtype">int</span> type, <span class="keyword">const</span> <span class=
"keywordtype">char</span> *value, size_t value_len)
01185 {
01186     netsnmp_table_data_set_storage *data;
01187 
01188     <span class="keywordflow">if</span> (!row)
01189         <span class="keywordflow">return</span> SNMPERR_GENERR;
01190 
01191     data = (netsnmp_table_data_set_storage *) row-&gt;<a class="code" href="structvariable__list.html#o8">data</a>;
01192     data = <a class="code" href="group__table__dataset.html#ga26">netsnmp_table_data_set_find_column</a>(data, column);
01193 
01194     <span class="keywordflow">if</span> (!data) {
01195         <span class="comment">/*</span>
01196 <span class="comment">         * create it </span>
01197 <span class="comment">         */</span>
01198         data = <a class="code" href="group__util.html#ga39">SNMP_MALLOC_TYPEDEF</a>(netsnmp_table_data_set_storage);
01199         <span class="keywordflow">if</span> (!data) {
01200             <a class="code" href="group__snmp__logging.html#ga41">snmp_log</a>(LOG_CRIT, <span class=
"stringliteral">"no memory in netsnmp_set_row_column"</span>);
01201             <span class="keywordflow">return</span> SNMPERR_MALLOC;
01202         }
01203 
01204         data-&gt;column = column;
01205         data-&gt;<a class="code" href="structvariable__list.html#o3">type</a> = type;
01206         data-&gt;next = row-&gt;<a class="code" href="structvariable__list.html#o8">data</a>;
01207         row-&gt;<a class="code" href="structvariable__list.html#o8">data</a> = data;
01208     }
01209 
01210     <span class="keywordflow">if</span> (value) {
01211         <span class="keywordflow">if</span> (data-&gt;type != type)
01212             <span class="keywordflow">return</span> SNMPERR_GENERR;
01213 
01214         <a class="code" href="group__util.html#ga36">SNMP_FREE</a>(data-&gt;data.voidp);
01215         <span class="keywordflow">if</span> (value_len) {
01216             <span class="keywordflow">if</span> (<a class="code" href=
"group__util.html#ga5">memdup</a>(&amp;data-&gt;data.string, value, (value_len)) !=
01217                 SNMPERR_SUCCESS) {
01218                 <a class="code" href="group__snmp__logging.html#ga41">snmp_log</a>(LOG_CRIT, <span class=
"stringliteral">"no memory in netsnmp_set_row_column"</span>);
01219                 <span class="keywordflow">return</span> SNMPERR_MALLOC;
01220             }
01221         } <span class="keywordflow">else</span> {
01222             data-&gt;<a class="code" href="structvariable__list.html#o8">data</a>.string = malloc(1);
01223         }
01224         data-&gt;data_len = value_len;
01225     }
01226     <span class="keywordflow">return</span> SNMPERR_SUCCESS;
01227 }
01228 
01229 <span class="comment">/* ==================================</span>
01230 <span class="comment"> *</span>
01231 <span class="comment"> * Data Set API: Index operations</span>
01232 <span class="comment"> *</span>
01233 <span class="comment"> * ================================== */</span>
01234 
01236 NETSNMP_INLINE <span class="keywordtype">void</span>
<a name="l01237" id="l01237"></a><a class="code" href="group__table__dataset.html#ga29">01237</a> <a class="code" href=
"group__table__dataset.html#ga29">netsnmp_table_dataset_add_index</a>(netsnmp_table_data_set *table, u_char type)
01238 {
01239     <span class="keywordflow">if</span> (!table)
01240         <span class="keywordflow">return</span>;
01241     netsnmp_table_data_add_index(table-&gt;table, type);
01242 }
01243 
01246 <span class="keywordtype">void</span>
01247 <span class="preprocessor">#if HAVE_STDARG_H</span>
01248 <a class="code" href="group__table__dataset.html#ga30">netsnmp_table_set_add_indexes</a>(netsnmp_table_data_set *tset,
01249                               ...)
01250 #<span class="keywordflow">else</span>
<a name="l01251" id="l01251"></a><a class="code" href="group__table__dataset.html#ga30">01251</a> <a class="code" href=
"group__table__dataset.html#ga30">netsnmp_table_set_add_indexes</a>(va_alist)
01252      va_dcl
01253 #endif
01254 {
01255     va_list         debugargs;
01256     <span class="keywordtype">int</span>             type;
01257 
01258 <span class="preprocessor">#if HAVE_STDARG_H</span>
01259     va_start(debugargs, tset);
01260 <span class="preprocessor">#else</span>
01261     netsnmp_table_data_set *tset;
01262 
01263     va_start(debugargs);
01264     tset = va_arg(debugargs, netsnmp_table_data_set *);
01265 <span class="preprocessor">#endif</span>
01266 
01267     <span class="keywordflow">while</span> ((type = va_arg(debugargs, <span class="keywordtype">int</span>)) != 0) {
01268         <a class="code" href="group__table__dataset.html#ga29">netsnmp_table_dataset_add_index</a>(tset, (u_char)type);
01269     }
01270 
01271     va_end(debugargs);
01272 }
01273 
01274 <span class="comment">/*</span>
01275 <span class="comment"> * @} </span>
01276 <span class="comment"> */</span>
01277 
</pre>
  </div>
  <hr size="1" />

  <address style="align: right;">
    <small>Generated on Fri Dec 30 13:47:51 2005 for net-snmp by&nbsp; <a href="http://www.doxygen.org/index.html"><img src=
    "doxygen.png" alt="doxygen" align="middle" border="0" /></a> 1.3.9.1</small>
  </address>
<!-- CONTENT END -->
<!--#include virtual="/page-bottom.html" -->

