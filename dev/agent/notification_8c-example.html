<!--#set var="section" value="development" -->
<!--#include virtual="/page-top.html" -->
<!-- CONTENT START -->
  <div class="qindex">
    <a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="modules.html">Modules</a> | <a class=
    "qindex" href="annotated.html">Data&nbsp;Structures</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class=
    "qindex" href="functions.html">Data&nbsp;Fields</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a> | <a class=
    "qindex" href="examples.html">Examples</a>
  </div>

  <h1>notification.c</h1>This example shows how to send a notification from inside the agent. In this case we do something really
  boring to decide whether to send a notification or not: we simply sleep for 30 seconds and send it, then we sleep for 30 more
  and send it again. We do this through the snmp_alarm mechanisms (which are safe to use within the agent. Don't use the system
  alarm() call, it won't work properly). Normally, you would probably want to do something to test whether or not to send an
  alarm, based on the type of mib module you were creating.

  <p>When this module is compiled into the agent (run configure with --with-mib-modules="examples/notification") then it should
  send out traps, which when received by the snmptrapd demon will look roughly like:</p>

  <p>2002-05-08 08:57:05 localhost.localdomain [udp:127.0.0.1:32865]: sysUpTimeInstance = Timeticks: (3803) 0:00:38.03
  snmpTrapOID.0 = OID: netSnmpExampleNotification</p>

  <div class="fragment">
    <pre class="fragment">
<span class="comment">/*</span>
<span class="comment"> * start be including the appropriate header files </span>
<span class="comment"> */</span>
<span class="preprocessor">#include &lt;net-snmp/net-snmp-config.h&gt;</span>
<span class="preprocessor">#include &lt;net-snmp/net-snmp-includes.h&gt;</span>
<span class="preprocessor">#include &lt;net-snmp/agent/net-snmp-agent-includes.h&gt;</span>

<span class="comment">/*</span>
<span class="comment"> * contains prototypes </span>
<span class="comment"> */</span>
<span class="preprocessor">#include "notification.h"</span>

<span class="comment">/*</span>
<span class="comment"> * our initialization routine</span>
<span class="comment"> * (to get called, the function name must match init_FILENAME() </span>
<span class="comment"> */</span>
<span class="keywordtype">void</span>
init_notification(<span class="keywordtype">void</span>)
{
    DEBUGMSGTL((<span class="stringliteral">"example_notification"</span>,
                <span class="stringliteral">"initializing (setting callback alarm)\n"</span>));
    <a name="a28" id="a28"></a><a class="code" href="group__snmp__alarm.html#ga14">snmp_alarm_register</a>(30,     <span class=
"comment">/* seconds */</span>
                        SA_REPEAT,      <span class="comment">/* repeat (every 30 seconds). */</span>
                        send_example_notification,      <span class="comment">/* our callback */</span>
                        NULL    <span class="comment">/* no callback data needed */</span>
        );
}

<span class="keywordtype">void</span>
send_example_notification(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> clientreg, <span class=
"keywordtype">void</span> *clientarg)
{
    <span class="comment">/*</span>
<span class="comment">     * define the OID for the notification we're going to send</span>
<span class="comment">     * NET-SNMP-EXAMPLES-MIB::netSnmpExampleHeartbeatNotification </span>
<span class="comment">     */</span>
    oid             notification_oid[] =
        { 1, 3, 6, 1, 4, 1, 8072, 2, 3, 0, 1 };
    size_t          notification_oid_len = OID_LENGTH(notification_oid);

    <span class="comment">/*</span>
<span class="comment">     * In the notification, we have to assign our notification OID to</span>
<span class="comment">     * the snmpTrapOID.0 object. Here is it's definition. </span>
<span class="comment">     */</span>
    oid             objid_snmptrap[] = { 1, 3, 6, 1, 6, 3, 1, 1, 4, 1, 0 };
    size_t          objid_snmptrap_len = OID_LENGTH(objid_snmptrap);

    <span class="comment">/*</span>
<span class="comment">     * define the OIDs for the varbinds we're going to include</span>
<span class="comment">     *  with the notification -</span>
<span class="comment">     * NET-SNMP-EXAMPLES-MIB::netSnmpExampleHeartbeatRate  and</span>
<span class="comment">     * NET-SNMP-EXAMPLES-MIB::netSnmpExampleHeartbeatName </span>
<span class="comment">     */</span>
    oid      hbeat_rate_oid[]   = { 1, 3, 6, 1, 4, 1, 8072, 2, 3, 2, 1, 0 };
    size_t   hbeat_rate_oid_len = OID_LENGTH(hbeat_rate_oid);
    oid      hbeat_name_oid[]   = { 1, 3, 6, 1, 4, 1, 8072, 2, 3, 2, 2, 0 };
    size_t   hbeat_name_oid_len = OID_LENGTH(hbeat_name_oid);

    <span class="comment">/*</span>
<span class="comment">     * here is where we store the variables to be sent in the trap </span>
<span class="comment">     */</span>
    <a name="_a29" id="_a29"></a><a class="code" href=
"structvariable__list.html">netsnmp_variable_list</a> *notification_vars = NULL;
    <span class="keywordtype">char</span> *heartbeat_name = <span class="stringliteral">"A girl named Maria"</span>;
<span class="preprocessor">#ifdef  RANDOM_HEARTBEAT</span>
    <span class="keywordtype">int</span>  heartbeat_rate = rand() % 60;
<span class="preprocessor">#else</span>
    <span class="keywordtype">int</span>  heartbeat_rate = 30;
<span class="preprocessor">#endif</span>

    DEBUGMSGTL((<span class="stringliteral">"example_notification"</span>, <span class=
"stringliteral">"defining the trap\n"</span>));

    <span class="comment">/*</span>
<span class="comment">     * add in the trap definition object </span>
<span class="comment">     */</span>
    snmp_varlist_add_variable(&amp;notification_vars,
                              <span class="comment">/*</span>
<span class="comment">                               * the snmpTrapOID.0 variable </span>
<span class="comment">                               */</span>
                              objid_snmptrap, objid_snmptrap_len,
                              <span class="comment">/*</span>
<span class="comment">                               * value type is an OID </span>
<span class="comment">                               */</span>
                              ASN_OBJECT_ID,
                              <span class="comment">/*</span>
<span class="comment">                               * value contents is our notification OID </span>
<span class="comment">                               */</span>
                              (u_char *) notification_oid,
                              <span class="comment">/*</span>
<span class="comment">                               * size in bytes = oid length * sizeof(oid) </span>
<span class="comment">                               */</span>
                              notification_oid_len * <span class="keyword">sizeof</span>(oid));

    <span class="comment">/*</span>
<span class="comment">     * add in the additional objects defined as part of the trap</span>
<span class="comment">     */</span>

    snmp_varlist_add_variable(&amp;notification_vars,
                               hbeat_rate_oid, hbeat_rate_oid_len,
                               ASN_INTEGER,
                              (u_char *)&amp;heartbeat_rate,
                                  <span class="keyword">sizeof</span>(heartbeat_rate));

    <span class="comment">/*</span>
<span class="comment">     * if we want to insert additional objects, we do it here </span>
<span class="comment">     */</span>
    <span class="keywordflow">if</span> (heartbeat_rate &lt; 30 ) {
        snmp_varlist_add_variable(&amp;notification_vars,
                               hbeat_name_oid, hbeat_name_oid_len,
                               ASN_OCTET_STR,
                               heartbeat_name, strlen(heartbeat_name));
    }

    <span class="comment">/*</span>
<span class="comment">     * send the trap out.  This will send it to all registered</span>
<span class="comment">     * receivers (see the "SETTING UP TRAP AND/OR INFORM DESTINATIONS"</span>
<span class="comment">     * section of the snmpd.conf manual page. </span>
<span class="comment">     */</span>
    DEBUGMSGTL((<span class="stringliteral">"example_notification"</span>, <span class=
"stringliteral">"sending the trap\n"</span>));
    <a name="a30" id="a30"></a><a class="code" href="group__agent__trap.html#ga44">send_v2trap</a>(notification_vars);

    <span class="comment">/*</span>
<span class="comment">     * free the created notification variable list </span>
<span class="comment">     */</span>
    DEBUGMSGTL((<span class="stringliteral">"example_notification"</span>, <span class="stringliteral">"cleaning up\n"</span>));
    snmp_free_varbind(notification_vars);
}
</pre>
  </div>
  <hr size="1" />

  <address style="align: right;">
    <small><!--#include virtual="/sfbutton.html" --><br />
    Generated on Thu Oct 28 21:46:55 2004 for net-snmp by&nbsp; <a href="http://www.doxygen.org/index.html"><img src=
    "doxygen.png" alt="doxygen" align="middle" border="0" /></a> 1.3.9.1</small>
<!-- CONTENT END -->
<!--#include virtual="/page-bottom.html" -->

