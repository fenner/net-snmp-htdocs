<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>net-snmp: data_set.c</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.7.4 -->
<div id="top">
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">net-snmp&#160;<span id="projectnumber">5.7</span></div>
  </td>
 </tr>
 </tbody>
</table>
</div>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li><a href="examples.html"><span>Examples</span></a></li>
    </ul>
  </div>
</div>
<div class="header">
  <div class="headertitle">
<div class="title">data_set.c</div>  </div>
</div>
<div class="contents">
<p>This example creates a table full of information and stores all that information within the agent's memory. The "table_dataset" helper routines take care of handling all aspects of SNMP requests as they come in (yay!).</p>
<p>The exmaple we are instrumenting is an otherwise-useless table containing the names of IETF working group chairs. Obviously, this data isn't all that useful from a network management point of view but this example only demonstrates how to use and store data. For more useful examples (but more complex), check out the apps/notification_log.c file which implements parts of the NOTIFICATION-LOG-MIB for logging incoming SNMP notifications.</p>
<p>Much of this code could be automatically generated by running mib2c as follows:</p>
<ul>
<li>mib2c -c mib2c.create-dataset.conf netSnmpIETFWGTable</li>
</ul>
<p>The table is defined roughly as follows:</p>
<pre>
    % snmptranslate -m NET-SNMP-EXAMPLES-MIB -Tp -IR netSnmpIETFWGTable
    |+--netSnmpIETFWGTable(1)
    |   |
    |   +--netSnmpIETFWGEntry(1)
    |      |  Index: nsIETFWGName
    |      |
    |      +-- ---- String    nsIETFWGName(1)
    |      |        Size: 1..32
    |      +-- CR-- String    nsIETFWGChair1(2)
    |      +-- CR-- String    nsIETFWGChair2(3)
  </pre><p>If this module is compiled into an agent, you should be able to issue snmp commands that look something like (valid authentication information not shown in these commands):</p>
<pre>
      % snmpwalk localhost netSnmpIETFWGTable
      nsIETFWGChair1."snmpv3" = "Russ Mundy"
      nsIETFWGChair2."snmpv3" = "David Harrington"</pre><pre>      % snmpset localhost nsIETFWGChair1."sming" = "David Durham"
      nsIETFWGChair1."sming" = "David Durham"</pre><pre>      % snmpwalk localhost netSnmpIETFWGTable
      nsIETFWGChair1."sming" = "David Durham"
      nsIETFWGChair1."snmpv3" = "Russ Mundy"
      nsIETFWGChair2."snmpv3" = "David Harrington"</pre><pre>      In your snmpd.conf file, put the following line:
      add_row netSnmpIETFWGTable eos "Glenn Waters" "Dale Francisco"</pre><pre>      % snmpwalk localhost netSnmpIETFWGTable
      nsIETFWGChair1."eos" = "Glenn Waters"
      nsIETFWGChair1."snmpv3" = "Russ Mundy"
      nsIETFWGChair2."eos" = "Dale Francisco"
      nsIETFWGChair2."snmpv3" = "David Harrington"
  </pre><div class="fragment"><pre class="fragment">
<span class="comment">/*</span>
<span class="comment"> * start be including the appropriate header files </span>
<span class="comment"> */</span>
<span class="preprocessor">#include &lt;net-snmp/net-snmp-config.h&gt;</span>
<span class="preprocessor">#include &lt;net-snmp/net-snmp-includes.h&gt;</span>
<span class="preprocessor">#include &lt;net-snmp/net-snmp-features.h&gt;</span>
<span class="preprocessor">#include &lt;net-snmp/agent/net-snmp-agent-includes.h&gt;</span>

netsnmp_feature_require(table_set_multi_add_default_row)
netsnmp_feature_require(unregister_auto_data_table)
netsnmp_feature_require(delete_table_data_set)
netsnmp_feature_require(table_dataset)
netsnmp_feature_require(table_set_multi_add_default_row)
netsnmp_feature_require(table_dataset_unregister_auto_data_table)

static <a name="_a0"></a><a class="code" href="structnetsnmp__table__data__set__s.html">netsnmp_table_data_set</a> *table_set;

<span class="comment">/*</span>
<span class="comment"> * our initialization routine, automatically called by the agent </span>
<span class="comment"> */</span>
<span class="comment">/*</span>
<span class="comment"> * (to get called, the function name must match init_FILENAME() </span>
<span class="comment"> */</span>
<span class="keywordtype">void</span>
init_data_set(<span class="keywordtype">void</span>)
{
    <a name="_a1"></a><a class="code" href="structnetsnmp__table__row__s.html">netsnmp_table_row</a> *row;

    <span class="comment">/*</span>
<span class="comment">     * the OID we want to register our integer at.  This should be the</span>
<span class="comment">     * * OID node for the entire table.  In our case this is the</span>
<span class="comment">     * * netSnmpIETFWGTable oid definition </span>
<span class="comment">     */</span>
    oid             my_registration_oid[] =
        { 1, 3, 6, 1, 4, 1, 8072, 2, 2, 1 };

    <span class="comment">/*</span>
<span class="comment">     * a debugging statement.  Run the agent with -Dexample_data_set to see</span>
<span class="comment">     * * the output of this debugging statement. </span>
<span class="comment">     */</span>
    DEBUGMSGTL((<span class="stringliteral">&quot;example_data_set&quot;</span>,
                <span class="stringliteral">&quot;Initalizing example dataset table\n&quot;</span>));

    <span class="comment">/*</span>
<span class="comment">     * It&#39;s going to be the &quot;working group chairs&quot; table, since I&#39;m</span>
<span class="comment">     * * sitting at an IETF convention while I&#39;m writing this.</span>
<span class="comment">     * *</span>
<span class="comment">     * *  column 1 = index = string = WG name</span>
<span class="comment">     * *  column 2 = string = chair #1</span>
<span class="comment">     * *  column 3 = string = chair #2  (most WGs have 2 chairs now)</span>
<span class="comment">     */</span>

    table_set = <a name="a2"></a><a class="code" href="group__table__dataset.html#gab523c6783716afd206f0512f93ef6503" title="Create a netsnmp_table_data_set structure given a table_data definition.">netsnmp_create_table_data_set</a>(<span class="stringliteral">&quot;netSnmpIETFWGTable&quot;</span>);

    <span class="comment">/*</span>
<span class="comment">     * allow the creation of new rows via SNMP SETs </span>
<span class="comment">     */</span>
    table_set-&gt;allow_creation = 1;

    <span class="comment">/*</span>
<span class="comment">     * set up what a row &quot;should&quot; look like, starting with the index </span>
<span class="comment">     */</span>
    <a name="a3"></a><a class="code" href="group__table__dataset.html#gac5453f15d00c7d58881ba43109ca7709" title="adds an index to the table.">netsnmp_table_dataset_add_index</a>(table_set, ASN_OCTET_STR);

    <span class="comment">/*</span>
<span class="comment">     * define what the columns should look like.  both are octet strings here </span>
<span class="comment">     */</span>
    <a name="a4"></a><a class="code" href="group__table__dataset.html#ga26ffb5722ae066cfbcfe1f0f37bc072e" title="adds multiple data column definitions to each row.">netsnmp_table_set_multi_add_default_row</a>(table_set,
                                            <span class="comment">/*</span>
<span class="comment">                                             * column 2 = OCTET STRING,</span>
<span class="comment">                                             * writable = 1,</span>
<span class="comment">                                             * default value = NULL,</span>
<span class="comment">                                             * default value len = 0 </span>
<span class="comment">                                             */</span>
                                            2, ASN_OCTET_STR, 1, NULL, 0,
                                            <span class="comment">/*</span>
<span class="comment">                                             * similar </span>
<span class="comment">                                             */</span>
                                            3, ASN_OCTET_STR, 1, NULL, 0,
                                            0 <span class="comment">/* done */</span> );

    <span class="comment">/*</span>
<span class="comment">     * register the table </span>
<span class="comment">     */</span>
    <span class="comment">/*</span>
<span class="comment">     * if we wanted to handle specific data in a specific way, or note</span>
<span class="comment">     * * when requests came in we could change the NULL below to a valid</span>
<span class="comment">     * * handler method in which we could over ride the default</span>
<span class="comment">     * * behaviour of the table_dataset helper </span>
<span class="comment">     */</span>
    <a name="a5"></a><a class="code" href="group__table__dataset.html#gac3daf62b5ff07dd03bc5b993e93ab103" title="register a given data_set at a given oid (specified in the netsnmp_handler_registration pointer)...">netsnmp_register_table_data_set</a>(<a name="a6"></a><a class="code" href="group__handler.html#ga537fac61fff7e112e121e5f629eded65" title="Creates a handler registration structure with a new MIB handler.">netsnmp_create_handler_registration</a>
                                    (<span class="stringliteral">&quot;netSnmpIETFWGTable&quot;</span>, NULL,
                                     my_registration_oid,
                                     OID_LENGTH(my_registration_oid),
                                     HANDLER_CAN_RWRITE), table_set, NULL);


    <span class="comment">/*</span>
<span class="comment">     * create the a row for the table, and add the data </span>
<span class="comment">     */</span>
    row = <a name="a7"></a><a class="code" href="group__table__data.html#gafdadce2dee8bc75b2b0dfd8e634e46a3" title="creates and returns a pointer to table data set">netsnmp_create_table_data_row</a>();
    <span class="comment">/*</span>
<span class="comment">     * set the index to the IETF WG name &quot;snmpv3&quot; </span>
<span class="comment">     */</span>
    netsnmp_table_row_add_index(row, ASN_OCTET_STR, <span class="stringliteral">&quot;snmpv3&quot;</span>,
                                strlen(<span class="stringliteral">&quot;snmpv3&quot;</span>));


    <span class="comment">/*</span>
<span class="comment">     * set column 2 to be the WG chair name &quot;Russ Mundy&quot; </span>
<span class="comment">     */</span>
    <a name="a8"></a><a class="code" href="group__table__dataset.html#ga5ffe522361cb81dbcf12458caf8f5532" title="Sets a given column in a row with data given a type, value, and length.">netsnmp_set_row_column</a>(row, 2, ASN_OCTET_STR,
                           <span class="stringliteral">&quot;Russ Mundy&quot;</span>, strlen(<span class="stringliteral">&quot;Russ Mundy&quot;</span>));
    <a name="a9"></a><a class="code" href="group__table__dataset.html#ga5dce210cd4d59eb8b01478ee5d0dc348" title="marks a given column in a row as writable or not.">netsnmp_mark_row_column_writable</a>(row, 2, 1);        <span class="comment">/* make writable via SETs */</span>

    <span class="comment">/*</span>
<span class="comment">     * set column 3 to be the WG chair name &quot;David Harrington&quot; </span>
<span class="comment">     */</span>
    <a class="code" href="group__table__dataset.html#ga5ffe522361cb81dbcf12458caf8f5532" title="Sets a given column in a row with data given a type, value, and length.">netsnmp_set_row_column</a>(row, 3, ASN_OCTET_STR, <span class="stringliteral">&quot;David Harrington&quot;</span>,
                           strlen(<span class="stringliteral">&quot;David Harrington&quot;</span>));
    <a class="code" href="group__table__dataset.html#ga5dce210cd4d59eb8b01478ee5d0dc348" title="marks a given column in a row as writable or not.">netsnmp_mark_row_column_writable</a>(row, 3, 1);        <span class="comment">/* make writable via SETs */</span>

    <span class="comment">/*</span>
<span class="comment">     * add the row to the table </span>
<span class="comment">     */</span>
    <a name="a10"></a><a class="code" href="group__table__dataset.html#gacaa808db27144a4f967024bd7c9b6b25" title="adds a new row to a dataset table">netsnmp_table_dataset_add_row</a>(table_set, row);

<span class="preprocessor">#ifdef ADD_MORE_DATA</span>
<span class="preprocessor"></span>    <span class="comment">/*</span>
<span class="comment">     * add the data, for the second row </span>
<span class="comment">     */</span>
    row = <a class="code" href="group__table__data.html#gafdadce2dee8bc75b2b0dfd8e634e46a3" title="creates and returns a pointer to table data set">netsnmp_create_table_data_row</a>();
    netsnmp_table_row_add_index(row, ASN_OCTET_STR, <span class="stringliteral">&quot;snmpconf&quot;</span>,
                                strlen(<span class="stringliteral">&quot;snmpconf&quot;</span>));
    <a class="code" href="group__table__dataset.html#ga5ffe522361cb81dbcf12458caf8f5532" title="Sets a given column in a row with data given a type, value, and length.">netsnmp_set_row_column</a>(row, 2, ASN_OCTET_STR, <span class="stringliteral">&quot;David Partain&quot;</span>,
                           strlen(<span class="stringliteral">&quot;David Partain&quot;</span>));
    <a class="code" href="group__table__dataset.html#ga5dce210cd4d59eb8b01478ee5d0dc348" title="marks a given column in a row as writable or not.">netsnmp_mark_row_column_writable</a>(row, 2, 1);        <span class="comment">/* make writable */</span>
    <a class="code" href="group__table__dataset.html#ga5ffe522361cb81dbcf12458caf8f5532" title="Sets a given column in a row with data given a type, value, and length.">netsnmp_set_row_column</a>(row, 3, ASN_OCTET_STR, <span class="stringliteral">&quot;Jon Saperia&quot;</span>,
                           strlen(<span class="stringliteral">&quot;Jon Saperia&quot;</span>));
    <a class="code" href="group__table__dataset.html#ga5dce210cd4d59eb8b01478ee5d0dc348" title="marks a given column in a row as writable or not.">netsnmp_mark_row_column_writable</a>(row, 3, 1);        <span class="comment">/* make writable */</span>
    <a class="code" href="group__table__dataset.html#gacaa808db27144a4f967024bd7c9b6b25" title="adds a new row to a dataset table">netsnmp_table_dataset_add_row</a>(table_set, row);
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>
    <span class="comment">/*</span>
<span class="comment">     * Finally, this actually allows the &quot;add_row&quot; token it the</span>
<span class="comment">     * * snmpd.conf file to add rows to this table.</span>
<span class="comment">     * * Example snmpd.conf line:</span>
<span class="comment">     * *   add_row netSnmpIETFWGTable eos &quot;Glenn Waters&quot; &quot;Dale Francisco&quot;</span>
<span class="comment">     */</span>
    <a name="a11"></a><a class="code" href="group__table__dataset.html#ga0abcc64b2de9687425d8402c0b3377da" title="registers a table_dataset so that the &quot;add_row&quot; snmpd.conf token can be used to add data to this tabl...">netsnmp_register_auto_data_table</a>(table_set, NULL);

    DEBUGMSGTL((<span class="stringliteral">&quot;example_data_set&quot;</span>, <span class="stringliteral">&quot;Done initializing.\n&quot;</span>));
}

<span class="keywordtype">void</span>
shutdown_data_set(<span class="keywordtype">void</span>)
{
    <a name="a12"></a><a class="code" href="group__table__dataset.html#ga60564327df70421eb180c60381a13578" title="Undo the effect of netsnmp_register_auto_data_table().">netsnmp_unregister_auto_data_table</a>(table_set, NULL);
    netsnmp_delete_table_data_set(table_set);
    table_set = NULL;
}
</pre></div> </div>
</div>
<hr class="footer"/><address class="footer"><small>Generated on Thu Jul 14 2011 for net-snmp by&#160;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.4 </small></address>
</body>
</html>
