<!--#set var="section" value="development" -->
<!--#include virtual="/page-top.html" -->
<!-- CONTENT START -->
  <!-- Generated by Doxygen 1.3.9.1 -->

  <div class="qindex">
    <a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="modules.html">Modules</a> | <a class=
    "qindex" href="annotated.html">Data&nbsp;Structures</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class=
    "qindex" href="functions.html">Data&nbsp;Fields</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a> | <a class=
    "qindex" href="examples.html">Examples</a>
  </div>

  <div class="nav">
    <a class="el" href="dir_000005.html">snmplib</a>
  </div>

  <h1>snmp_secmod.c</h1>

  <div class="fragment">
    <pre class="fragment">
00001 <span class="comment">/*</span>
00002 <span class="comment"> * security service wrapper to support pluggable security models </span>
00003 <span class="comment"> */</span>
00004 
00005 <span class="preprocessor">#include &lt;net-snmp/net-snmp-config.h&gt;</span>
00006 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
00007 <span class="preprocessor">#include &lt;ctype.h&gt;</span>
00008 <span class="preprocessor">#if HAVE_STDLIB_H</span>
00009 <span class="preprocessor">#include &lt;stdlib.h&gt;</span>
00010 <span class="preprocessor">#endif</span>
00011 <span class="preprocessor">#if HAVE_STRING_H</span>
00012 <span class="preprocessor">#include &lt;string.h&gt;</span>
00013 <span class="preprocessor">#else</span>
00014 <span class="preprocessor">#include &lt;strings.h&gt;</span>
00015 <span class="preprocessor">#endif</span>
00016 <span class="preprocessor">#if HAVE_UNISTD_H</span>
00017 <span class="preprocessor">#include &lt;unistd.h&gt;</span>
00018 <span class="preprocessor">#endif</span>
00019 
00020 <span class="preprocessor">#if HAVE_DMALLOC_H</span>
00021 <span class="preprocessor">#include &lt;dmalloc.h&gt;</span>
00022 <span class="preprocessor">#endif</span>
00023 
00024 <span class="preprocessor">#include &lt;net-snmp/types.h&gt;</span>
00025 <span class="preprocessor">#include &lt;net-snmp/output_api.h&gt;</span>
00026 <span class="preprocessor">#include &lt;net-snmp/config_api.h&gt;</span>
00027 <span class="preprocessor">#include &lt;net-snmp/utilities.h&gt;</span>
00028 
00029 <span class="preprocessor">#include &lt;net-snmp/library/snmp_api.h&gt;</span>
00030 <span class="preprocessor">#include &lt;net-snmp/library/snmp_enum.h&gt;</span>
00031 <span class="preprocessor">#include &lt;net-snmp/library/callback.h&gt;</span>
00032 <span class="preprocessor">#include &lt;net-snmp/library/snmp_secmod.h&gt;</span>
00033 <span class="preprocessor">#include &lt;net-snmp/library/snmpusm.h&gt;</span>
00034 
00035 <span class="keyword">static</span> <span class="keyword">struct </span>snmp_secmod_list *registered_services = NULL;
00036 
00037 <span class="keyword">static</span> SNMPCallback set_default_secmod;
00038 
00039 <span class="keywordtype">void</span>
00040 init_secmod(<span class="keywordtype">void</span>)
00041 {
00042     <a class="code" href="group__callback.html#ga3">snmp_register_callback</a>(SNMP_CALLBACK_LIBRARY,
00043                            SNMP_CALLBACK_SESSION_INIT, set_default_secmod,
00044                            NULL);
00045 
00046     netsnmp_ds_register_config(ASN_OCTET_STR, <span class="stringliteral">"snmp"</span>, <span class=
"stringliteral">"defSecurityModel"</span>,
00047                                NETSNMP_DS_LIBRARY_ID, NETSNMP_DS_LIB_SECMODEL);
00048     <span class="comment">/*</span>
00049 <span class="comment">     * this file is generated by configure for all the stuff we're using </span>
00050 <span class="comment">     */</span>
00051 <span class="preprocessor">#include "snmpsm_init.h"</span>
00052 }
00053 
00054 
00055 <span class="keywordtype">int</span>
00056 register_sec_mod(<span class="keywordtype">int</span> secmod, <span class="keyword">const</span> <span class=
"keywordtype">char</span> *modname,
00057                  <span class="keyword">struct</span> snmp_secmod_def *newdef)
00058 {
00059     <span class="keywordtype">int</span>             result;
00060     <span class="keyword">struct </span>snmp_secmod_list *sptr;
00061     <span class="keywordtype">char</span>           *othername;
00062 
00063     <span class="keywordflow">for</span> (sptr = registered_services; sptr; sptr = sptr-&gt;next) {
00064         <span class="keywordflow">if</span> (sptr-&gt;securityModel == secmod) {
00065             <span class="keywordflow">return</span> SNMPERR_GENERR;
00066         }
00067     }
00068     sptr = <a class="code" href="group__util.html#ga38">SNMP_MALLOC_STRUCT</a>(snmp_secmod_list);
00069     <span class="keywordflow">if</span> (sptr == NULL)
00070         <span class="keywordflow">return</span> SNMPERR_MALLOC;
00071     sptr-&gt;secDef = newdef;
00072     sptr-&gt;securityModel = secmod;
00073     sptr-&gt;next = registered_services;
00074     registered_services = sptr;
00075     <span class="keywordflow">if</span> ((result =
00076          se_add_pair_to_slist(<span class="stringliteral">"snmp_secmods"</span>, strdup(modname), secmod))
00077         != SE_OK) {
00078         <span class="keywordflow">switch</span> (result) {
00079         <span class="keywordflow">case</span> SE_NOMEM:
00080             <a class="code" href="group__snmp__logging.html#ga39">snmp_log</a>(LOG_CRIT, <span class=
"stringliteral">"snmp_secmod: no memory\n"</span>);
00081             <span class="keywordflow">break</span>;
00082 
00083         <span class="keywordflow">case</span> SE_ALREADY_THERE:
00084             othername = se_find_label_in_slist(<span class="stringliteral">"snmp_secmods"</span>, secmod);
00085             <span class="keywordflow">if</span> (strcmp(othername, modname) != 0) {
00086                 <a class="code" href="group__snmp__logging.html#ga39">snmp_log</a>(LOG_ERR,
00087                          <span class=
"stringliteral">"snmp_secmod: two security modules %s and %s registered with the same security number\n"</span>,
00088                          secmod, othername);
00089             }
00090             <span class="keywordflow">break</span>;
00091 
00092         <span class="keywordflow">default</span>:
00093             <a class="code" href="group__snmp__logging.html#ga39">snmp_log</a>(LOG_ERR,
00094                      <span class=
"stringliteral">"snmp_secmod: unknown error trying to register a new security module\n"</span>);
00095             <span class="keywordflow">break</span>;
00096         }
00097         <span class="keywordflow">return</span> SNMPERR_GENERR;
00098     }
00099     <span class="keywordflow">return</span> SNMPERR_SUCCESS;
00100 }
00101 
00102 <span class="keywordtype">int</span>
00103 unregister_sec_mod(<span class="keywordtype">int</span> secmod)
00104 {
00105     <span class="keyword">struct </span>snmp_secmod_list *sptr, *lptr;
00106 
00107     <span class="keywordflow">for</span> (sptr = registered_services, lptr = NULL; sptr;
00108          lptr = sptr, sptr = sptr-&gt;next) {
00109         <span class="keywordflow">if</span> (sptr-&gt;securityModel == secmod) {
00110             lptr-&gt;next = sptr-&gt;next;
00111             <a class="code" href="group__util.html#ga36">SNMP_FREE</a>(sptr-&gt;secDef);
00112             <a class="code" href="group__util.html#ga36">SNMP_FREE</a>(sptr);
00113             <span class="keywordflow">return</span> SNMPERR_SUCCESS;
00114         }
00115     }
00116     <span class="comment">/*</span>
00117 <span class="comment">     * not registered </span>
00118 <span class="comment">     */</span>
00119     <span class="keywordflow">return</span> SNMPERR_GENERR;
00120 }
00121 
00122 <span class="keywordtype">void</span>            
00123 clear_sec_mod(<span class="keywordtype">void</span>)
00124 {
00125     <span class="keyword">struct </span>snmp_secmod_list *tmp = registered_services, *next = NULL;
00126 
00127     <span class="keywordflow">while</span> (tmp != NULL) {
00128         next = tmp-&gt;next;
00129         <a class="code" href="group__util.html#ga36">SNMP_FREE</a>(tmp-&gt;secDef);
00130         <a class="code" href="group__util.html#ga36">SNMP_FREE</a>(tmp);
00131         tmp = next;
00132     }
00133     registered_services = NULL;
00134 }
00135 
00136 
00137 <span class="keyword">struct </span>snmp_secmod_def *
00138 find_sec_mod(<span class="keywordtype">int</span> secmod)
00139 {
00140     <span class="keyword">struct </span>snmp_secmod_list *sptr;
00141 
00142     <span class="keywordflow">for</span> (sptr = registered_services; sptr; sptr = sptr-&gt;next) {
00143         <span class="keywordflow">if</span> (sptr-&gt;securityModel == secmod) {
00144             <span class="keywordflow">return</span> sptr-&gt;secDef;
00145         }
00146     }
00147     <span class="comment">/*</span>
00148 <span class="comment">     * not registered </span>
00149 <span class="comment">     */</span>
00150     <span class="keywordflow">return</span> NULL;
00151 }
00152 
00153 <span class="keyword">static</span> <span class="keywordtype">int</span>
00154 set_default_secmod(<span class="keywordtype">int</span> major, <span class="keywordtype">int</span> minor, <span class=
"keywordtype">void</span> *serverarg, <span class="keywordtype">void</span> *clientarg)
00155 {
00156     <a class="code" href="structsnmp__session.html">netsnmp_session</a> *sess = (<a class="code" href=
"structsnmp__session.html">netsnmp_session</a> *) serverarg;
00157     <span class="keywordtype">char</span>           *cptr;
00158     <span class="keywordtype">int</span>             model;
00159 
00160     <span class="keywordflow">if</span> (!sess)
00161         <span class="keywordflow">return</span> SNMPERR_GENERR;
00162     <span class="keywordflow">if</span> (sess-&gt;<a class="code" href=
"structsnmp__session.html#o43">securityModel</a> == SNMP_DEFAULT_SECMODEL) {
00163         <span class="keywordflow">if</span> ((cptr = netsnmp_ds_get_string(NETSNMP_DS_LIBRARY_ID, 
00164                                           NETSNMP_DS_LIB_SECMODEL)) != NULL) {
00165             <span class="keywordflow">if</span> ((model = se_find_value_in_slist(<span class=
"stringliteral">"snmp_secmods"</span>, cptr))
00166                 != SE_DNE) {
00167                 sess-&gt;<a class="code" href="structsnmp__session.html#o43">securityModel</a> = model;
00168             } <span class="keywordflow">else</span> {
00169                 <a class="code" href="group__snmp__logging.html#ga39">snmp_log</a>(LOG_ERR,
00170                          <span class="stringliteral">"unknown security model name: %s.  Forcing USM instead.\n"</span>,
00171                          cptr);
00172                 sess-&gt;<a class="code" href="structsnmp__session.html#o43">securityModel</a> = USM_SEC_MODEL_NUMBER;
00173                 <span class="keywordflow">return</span> SNMPERR_GENERR;
00174             }
00175         } <span class="keywordflow">else</span> {
00176             sess-&gt;<a class="code" href="structsnmp__session.html#o43">securityModel</a> = USM_SEC_MODEL_NUMBER;
00177         }
00178     }
00179     <span class="keywordflow">return</span> SNMPERR_SUCCESS;
00180 }
</pre>
  </div>
  <hr size="1" />

  <address style="align: right;">
    <small><!--#include virtual="/sfbutton.html" --><br />
    Generated on Thu Nov 25 17:51:41 2004 for net-snmp by&nbsp; <a href="http://www.doxygen.org/index.html"><img src=
    "doxygen.png" alt="doxygen" align="middle" border="0" /></a> 1.3.9.1</small>
  </address>
<!-- CONTENT END -->
<!--#include virtual="/page-bottom.html" -->

